# 知识库文件上传测试指南

## 测试目的
验证知识库文件上传功能修复后的完整性和多租户隔离。

## 前置条件
1. 系统已启动（后端 + Windows 登录管理器）
2. 至少有两个测试用户账号
3. 准备测试文件（.txt, .md, .pdf, .doc, .docx）

## 测试步骤

### 1. 基础上传测试（用户1）
```bash
# 登录用户1（例如：lzc2005）
1. 打开 Windows 登录管理器
2. 登录账号：lzc2005
3. 进入"知识库"页面
4. 点击"创建知识库"
5. 输入名称："装修"，描述："装修相关知识"
6. 点击"确定"创建
7. 进入知识库详情页
8. 点击"上传文档"
9. 选择测试文件（建议多选）：
   - test1.txt
   - test2.md
   - test3.pdf
10. 点击"上传"
```

**预期结果**:
- ✅ 上传成功，显示成功消息
- ✅ 文档列表显示所有上传的文件
- ✅ 文件信息正确（文件名、大小、类型、时间）
- ✅ 可以查看文档内容
- ✅ 可以搜索文档
- ✅ 可以删除文档

### 2. 多租户隔离测试（用户2）
```bash
# 登录用户2（例如：testuser）
1. 登出用户1
2. 登录账号：testuser
3. 进入"知识库"页面
4. 创建同名知识库："装修"
5. 上传不同的文件
```

**预期结果**:
- ✅ 可以创建同名知识库（不冲突）
- ✅ 只能看到自己的知识库
- ✅ 只能看到自己上传的文档
- ✅ 无法访问其他用户的知识库

### 3. 文件格式测试
测试各种支持的文件格式：

| 格式 | 测试文件 | 预期结果 |
|------|---------|---------|
| .txt | test.txt | ✅ 上传成功 |
| .md | test.md | ✅ 上传成功 |
| .pdf | test.pdf | ✅ 上传成功 |
| .doc | test.doc | ✅ 上传成功 |
| .docx | test.docx | ✅ 上传成功 |
| .jpg | test.jpg | ❌ 拒绝上传 |
| .exe | test.exe | ❌ 拒绝上传 |

### 4. 文件大小限制测试
```bash
# 测试大文件
1. 准备一个 11MB 的文件
2. 尝试上传
```

**预期结果**:
- ❌ 提示"文件大小不能超过10MB"

### 5. 批量上传测试
```bash
# 测试多文件上传
1. 选择 5-10 个文件
2. 一次性上传
```

**预期结果**:
- ✅ 所有文件都成功上传
- ✅ 显示上传进度
- ✅ 显示成功/失败统计

### 6. 错误处理测试
```bash
# 测试网络错误
1. 断开网络连接
2. 尝试上传文件
```

**预期结果**:
- ❌ 显示友好的错误消息
- ✅ 不会崩溃

## 验证数据库
```sql
-- 检查知识库隔离
SELECT id, name, user_id, document_count 
FROM knowledge_bases 
ORDER BY user_id, id;

-- 检查文档隔离
SELECT d.id, d.filename, d.knowledge_base_id, kb.user_id
FROM knowledge_base_documents d
JOIN knowledge_bases kb ON d.knowledge_base_id = kb.id
ORDER BY kb.user_id, d.id;

-- 验证唯一约束
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'knowledge_bases'
  AND constraint_type = 'UNIQUE';
```

## 常见问题排查

### 问题1: "An object could not be cloned"
**原因**: 旧版本代码，File 对象未序列化
**解决**: 确保使用最新代码（已修复）

### 问题2: "知识库不存在或无权访问"
**原因**: 多租户隔离，尝试访问其他用户的知识库
**解决**: 正常行为，确保使用正确的用户账号

### 问题3: 上传后看不到文档
**原因**: 可能是前端缓存或刷新问题
**解决**: 刷新页面或重新进入知识库详情

### 问题4: 文件内容乱码
**原因**: 文件编码问题
**解决**: 确保文本文件使用 UTF-8 编码

## 测试完成检查清单
- [ ] 单文件上传成功
- [ ] 多文件批量上传成功
- [ ] 文件格式验证正确
- [ ] 文件大小限制生效
- [ ] 文档列表显示正确
- [ ] 文档内容查看正常
- [ ] 文档搜索功能正常
- [ ] 文档删除功能正常
- [ ] 多租户隔离验证通过
- [ ] 错误处理友好

## 测试报告模板
```
测试日期: ____________________
测试人员: ____________________
系统版本: ____________________

测试结果:
- 基础上传: [ ] 通过 [ ] 失败
- 多租户隔离: [ ] 通过 [ ] 失败
- 文件格式: [ ] 通过 [ ] 失败
- 文件大小: [ ] 通过 [ ] 失败
- 批量上传: [ ] 通过 [ ] 失败
- 错误处理: [ ] 通过 [ ] 失败

问题记录:
1. ___________________________________
2. ___________________________________
3. ___________________________________

总体评价: [ ] 优秀 [ ] 良好 [ ] 需改进
```
