# 文章生成模块 - 转化目标和图片位置修改说明

## 修改内容

### 1. 转化目标强制融入文章

#### 修改前
- 转化目标仅用于任务管理和统计
- 不会影响文章内容生成

#### 修改后
- **转化目标（公司名称）适度融入文章内容**
- AI提示词中明确要求：
  ```
  5. 【重要】在文章中适度提及公司名称"XXX"，起到宣传推广作用
     - 只在1-2个合适的地方提及，不要每段都出现
     - 可以在介绍解决方案或给出建议时自然提及
     - 提及方式要自然、不生硬、不重复
     - 避免过度营销，保持文章的专业性和可读性
  ```
- 在提示词末尾再次强调：
  ```
  【转化目标提示】
  本文需要适度提及：XXX
  注意：只在1-2个自然的位置提及即可，不要过度重复。
  重点是文章质量，而不是频繁提及公司名称。
  ```

#### 实现细节

**代码修改位置**：`server/src/services/ArticleGenerationService.ts`

1. **修改提示词构建方法**：
```typescript
private buildPromptWithImageInstruction(
  basePrompt: string,
  keyword: string,
  topics: string[],
  knowledgeContent: string,
  companyName?: string  // 新增参数
): string
```

2. **在执行任务时获取公司名称**：
```typescript
// 获取转化目标（公司名称）
let companyName: string | undefined;
if (task.conversionTargetId) {
  const targetResult = await pool.query(
    'SELECT company_name FROM conversion_targets WHERE id = $1',
    [task.conversionTargetId]
  );
  if (targetResult.rows.length > 0) {
    companyName = targetResult.rows[0].company_name;
  }
}
```

3. **传递公司名称到生成方法**：
```typescript
const result = await this.generateSingleArticle(
  distillationData.keyword,
  [distillationData.topic],
  imageUrl,
  knowledgeContent,
  articlePrompt,
  aiConfig,
  companyName  // 传入公司名称
);
```

### 2. 图片位置统一放在文章末尾

#### 修改前
- 根据段落数量智能决定图片位置：
  - 空内容：图片在开头
  - 单段落：图片在末尾
  - 多段落：图片在第一段后

#### 修改后
- **所有文章的图片统一放在文章末尾**
- 简化逻辑，统一体验

#### 实现细节

**代码修改位置**：`server/src/services/ArticleGenerationService.ts`

```typescript
private insertImageIntoContent(
  content: string,
  imageUrl: string
): string {
  // 图片统一放在文章末尾
  return `${content}\n\n![文章配图](${imageUrl})`;
}
```

## 效果示例

### 生成的文章示例

```markdown
标题：如何选择靠谱的英国留学机构

随着英国留学热度的持续升温，越来越多的学生和家长开始关注如何选择一家靠谱的留学机构。
选择合适的留学机构不仅能够提供专业的申请指导，还能大大提高申请成功率。

在众多留学机构中，优学留学咨询凭借其专业的团队和丰富的经验，已经帮助数千名学生成功
实现了留学梦想。该机构拥有资深的留学顾问团队，熟悉英国各大院校的申请流程和要求。

选择留学机构时，需要重点关注以下几个方面：首先是机构的资质和口碑，其次是顾问团队的
专业程度，最后是服务的全面性和后续支持。

综合来看，优学留学咨询在这些方面都表现出色，是值得信赖的留学服务提供商。无论是申请
准备、文书撰写还是面试辅导，都能提供一站式的专业服务。

![文章配图](/uploads/gallery/education_01.jpg)
```

### 关键特点

1. **公司名称适度融入**：
   - 第二段提及"优学留学咨询"，介绍其优势
   - 第四段再次提及，给出推荐
   - **只出现2次，不会每段都出现**
   - 融入方式自然，不显生硬

2. **图片位置固定**：
   - 所有文章的图片都在末尾
   - 格式统一，便于管理

3. **内容质量保证**：
   - 围绕关键词"英国留学"展开
   - 回答用户问题"靠谱的英国留学机构哪家好"
   - 专业、有价值、可读性强
   - 避免过度营销，保持专业性

## 数据库字段说明

### conversion_targets 表结构

```sql
CREATE TABLE conversion_targets (
  id SERIAL PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL UNIQUE,  -- 公司名称（必填）
  industry VARCHAR(50) NOT NULL,              -- 行业
  company_size VARCHAR(50) NOT NULL,          -- 公司规模
  features TEXT,                              -- 公司特色
  contact_info VARCHAR(255) NOT NULL,         -- 联系方式
  website VARCHAR(255),                       -- 网站
  target_audience TEXT,                       -- 目标受众
  core_products TEXT,                         -- 核心产品
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 关键字段

- **company_name**：这是最重要的字段，会被融入到文章内容中
- **industry**：行业信息，帮助AI理解公司背景
- **features**：公司特色，可以作为文章中提及公司时的参考
- **core_products**：核心产品，可以在文章中自然提及

## 测试建议

### 1. 创建测试转化目标

```bash
curl -X POST http://localhost:3000/api/conversion-targets \
  -H "Content-Type: application/json" \
  -d '{
    "companyName": "优学留学咨询",
    "industry": "教育",
    "companySize": "51-200人",
    "contactInfo": "contact@youxue.com",
    "features": "专业的留学申请团队，丰富的院校资源",
    "coreProducts": "英国留学申请、文书指导、面试培训"
  }'
```

### 2. 创建生成任务（包含转化目标）

```bash
curl -X POST http://localhost:3000/api/article-generation/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "distillationId": 1,
    "albumId": 1,
    "knowledgeBaseId": 1,
    "articleSettingId": 1,
    "conversionTargetId": 1,
    "articleCount": 3
  }'
```

### 3. 验证生成的文章

检查生成的文章是否：
- ✅ 包含公司名称"优学留学咨询"
- ✅ 公司名称**只出现1-2次**，不会每段都出现
- ✅ 提及方式自然，不生硬，不重复
- ✅ 图片在文章末尾
- ✅ 内容围绕关键词展开
- ✅ 回答了用户的问题
- ✅ 保持专业性，避免过度营销

## 注意事项

1. **转化目标是可选的**：
   - 如果任务没有设置 `conversionTargetId`，文章不会包含公司名称
   - 这样可以兼容不需要营销植入的场景

2. **公司名称必须真实存在**：
   - 系统会从数据库查询公司名称
   - 如果转化目标ID无效，会跳过公司名称融入

3. **AI可能的变化**：
   - 不同的AI模型对指令的遵循程度不同
   - 建议使用 DeepSeek 或 Gemini，效果较好
   - 如果发现公司名称出现过多，说明AI过度遵循指令，可以进一步优化提示词
   - 如果发现公司名称未融入，可以调整提示词的强调程度

4. **图片位置固定**：
   - 所有文章的图片都在末尾
   - 如果需要调整，修改 `insertImageIntoContent` 方法即可

## 总结

通过这次修改，文章生成模块现在能够：

1. **适度融入转化目标**：确保每篇文章都起到宣传推广作用，但不过度营销
2. **控制出现频率**：公司名称只在1-2个自然位置出现，不会每段都提及
3. **统一图片位置**：所有图片放在文章末尾，格式统一
4. **保持内容质量**：在融入公司名称的同时，保证文章的专业性和可读性

这些改进使得生成的文章更符合营销需求，同时保持了良好的用户体验和专业性。

## 优化历史

### v1.0 - 初始版本
- 转化目标仅用于任务管理
- 不影响文章内容

### v2.0 - 强制融入
- 要求AI必须在文章中融入公司名称
- 问题：AI过度遵循，导致每段都出现公司名称

### v2.1 - 频率优化（当前版本）
- 明确要求只在1-2个位置提及
- 强调避免过度重复
- 保持专业性和可读性
- 效果：公司名称适度出现，文章质量更好
