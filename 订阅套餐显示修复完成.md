# 订阅套餐显示修复完成

## 问题描述

用户管理页面的"订阅套餐"列显示所有用户都是"无订阅"，但实际上每个用户都有订阅套餐（免费版或付费版）。

## 问题原因

在 `UserService.getUsers()` 方法中，SQL查询使用了以下逻辑：

```sql
LEFT JOIN user_subscriptions us ON us.user_id = u.id AND us.status = 'active'
LEFT JOIN subscription_plans p ON p.id = us.plan_id
GROUP BY u.id
```

**核心问题**：
1. 当一个用户有多个 `active` 状态的订阅时（如用户 lzc2005 有6个active订阅）
2. `GROUP BY u.id` 会将这些记录合并
3. 使用 `MAX(p.plan_name)` 只能选择一个套餐名
4. 但由于JOIN的特性，导致某些用户的订阅信息丢失

## 解决方案

使用 **LATERAL 子查询**获取每个用户最新的有效订阅：

```sql
LEFT JOIN LATERAL (
  SELECT p.plan_name
  FROM user_subscriptions us
  JOIN subscription_plans p ON p.id = us.plan_id
  WHERE us.user_id = u.id 
    AND us.status = 'active'
    AND (us.end_date IS NULL OR us.end_date > NOW())
  ORDER BY us.created_at DESC
  LIMIT 1
) latest_sub ON true
```

**优势**：
- 为每个用户独立查询最新的有效订阅
- 避免了多个订阅导致的GROUP BY问题
- 自动过滤已过期的订阅
- 按创建时间排序，获取最新的订阅

## 修改文件

- `server/src/services/UserService.ts` - 修改 `getUsers()` 方法的SQL查询

## 测试结果

### 修复前
- 查询返回：15条记录
- 所有用户显示："无订阅"
- 问题：用户有订阅但不显示

### 修复后
- 查询返回：15条记录
- 套餐分布：
  - 免费版：12个用户
  - 专业版：3个用户
- ✅ 所有用户都正确显示订阅套餐

## 验证步骤

1. 运行诊断脚本：
```bash
npx ts-node server/src/scripts/diagnose-subscription-display.ts
```

2. 运行测试脚本：
```bash
npx ts-node server/src/scripts/test-user-list-fix.ts
```

3. 重新构建服务器：
```bash
cd server && npm run build
```

4. 重启服务器后，访问用户管理页面查看订阅套餐列

## 相关问题

这个修复同时解决了以下问题：
- 用户有多个active订阅时的显示问题
- 过期订阅仍然显示的问题
- GROUP BY导致的数据丢失问题

## 注意事项

- LATERAL JOIN 是 PostgreSQL 9.3+ 的特性
- 查询会为每个用户选择最新创建的有效订阅
- 如果用户没有有效订阅，会显示"无订阅"

## 完成时间

2026-01-05

## 状态

✅ 已完成并测试通过
