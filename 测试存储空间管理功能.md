# 存储空间管理功能 - 测试指南

## 🎯 测试目标

验证存储空间管理功能的前端集成是否正常工作，包括：
- 存储使用情况显示
- 存储明细图表
- 实时更新
- 警报通知

---

## 🚀 快速开始

### 1. 启动服务

```bash
# 终端 1 - 启动后端
cd server
npm run dev

# 终端 2 - 启动前端
cd client
npm run dev
```

### 2. 访问个人中心

1. 打开浏览器访问 `http://localhost:5173`
2. 登录系统
3. 点击右上角用户名 → "个人中心"
4. 点击"存储空间"标签页

---

## ✅ 测试清单

### 测试 1: 查看存储使用情况

**步骤**:
1. 进入个人中心 → 存储空间标签页
2. 观察存储使用卡片

**预期结果**:
- ✅ 显示总存储使用量（如：2.5 MB / 20 MB）
- ✅ 显示使用百分比进度条
- ✅ 显示剩余空间
- ✅ 显示三种资源类型的明细：
  - 图片存储
  - 文档存储
  - 文章存储
- ✅ 每种类型显示大小和数量

**截图位置**: 存储使用卡片应该在页面顶部

---

### 测试 2: 查看存储明细图表

**步骤**:
1. 在存储空间标签页向下滚动
2. 观察饼图

**预期结果**:
- ✅ 显示 ECharts 饼图
- ✅ 三个扇区分别代表图片、文档、文章
- ✅ 每个扇区显示百分比
- ✅ 鼠标悬停显示详细信息（大小、数量）
- ✅ 图表响应式，适配不同屏幕

---

### 测试 3: 上传文件测试存储更新

**步骤**:
1. 保持个人中心页面打开
2. 进入"企业图库"页面
3. 上传一张图片（建议 1-2 MB）
4. 返回个人中心 → 存储空间

**预期结果**:
- ✅ 存储使用量自动增加（无需刷新页面）
- ✅ 进度条自动更新
- ✅ 图片存储数量 +1
- ✅ 饼图自动更新比例

**实时性**: 应该在 1-2 秒内看到更新

---

### 测试 4: 删除文件测试存储减少

**步骤**:
1. 在企业图库中删除一张图片
2. 观察个人中心存储空间标签页

**预期结果**:
- ✅ 存储使用量自动减少
- ✅ 进度条自动更新
- ✅ 图片存储数量 -1
- ✅ 饼图自动更新

---

### 测试 5: 配额警报测试

**步骤**:
1. 上传多个文件，使存储使用超过 80%
2. 观察页面右上角通知

**预期结果**:
- ✅ 80% 时显示蓝色 info 通知："存储空间使用已达 80%"
- ✅ 95% 时显示橙色 warning 通知："存储空间使用已达 95%"
- ✅ 100% 时显示红色 error 通知："存储空间已用完"
- ✅ 存储卡片显示警告图标
- ✅ 显示"立即升级"按钮

---

### 测试 6: 配额限制测试

**步骤**:
1. 尝试上传一个超过剩余空间的大文件
2. 观察错误提示

**预期结果**:
- ✅ 上传被拒绝
- ✅ 显示错误消息："存储空间不足"
- ✅ 文件未保存到服务器
- ✅ 存储使用量未增加

---

### 测试 7: 升级套餐测试

**步骤**:
1. 在存储卡片点击"立即升级"按钮
2. 观察页面跳转

**预期结果**:
- ✅ 自动切换到"订阅管理"标签页
- ✅ 打开套餐选择对话框
- ✅ 显示可升级的套餐（专业版 1GB、企业版无限）

---

### 测试 8: 管理员配额修改（需要管理员账号）

**步骤**:
1. 使用管理员账号登录
2. 进入管理后台 → 存储管理
3. 修改某个用户的配额
4. 切换到该用户账号
5. 查看个人中心存储空间

**预期结果**:
- ✅ 用户收到"存储配额已更新"通知
- ✅ 配额自动更新（无需刷新）
- ✅ 进度条重新计算百分比

---

### 测试 9: 多标签页同步测试

**步骤**:
1. 打开两个浏览器标签页，都登录同一账号
2. 标签页 A：打开个人中心 → 存储空间
3. 标签页 B：上传一张图片
4. 观察标签页 A

**预期结果**:
- ✅ 标签页 A 自动更新存储使用（通过 WebSocket）
- ✅ 无需手动刷新
- ✅ 两个标签页数据一致

---

### 测试 10: 页面刷新测试

**步骤**:
1. 在存储空间标签页按 F5 刷新
2. 观察加载过程

**预期结果**:
- ✅ 显示加载状态（loading）
- ✅ 数据正确加载
- ✅ 图表正确渲染
- ✅ 无控制台错误

---

## 🐛 常见问题排查

### 问题 1: 看不到存储空间标签页

**检查**:
- ✅ 确认已登录
- ✅ 检查浏览器控制台是否有错误
- ✅ 确认 `DatabaseOutlined` 图标已导入

**解决**:
```typescript
// 确认导入
import { DatabaseOutlined } from '@ant-design/icons';
```

---

### 问题 2: 数据不显示或显示"无法加载存储数据"

**检查**:
1. 打开浏览器开发者工具 → Network 标签
2. 查看 `/api/storage/usage` 请求
3. 检查响应状态码

**可能原因**:
- ❌ 后端服务未启动
- ❌ 数据库迁移未执行
- ❌ 用户存储记录未初始化

**解决**:
```bash
# 检查后端服务
curl http://localhost:3000/api/storage/usage \
  -H "Authorization: Bearer YOUR_TOKEN"

# 执行数据库迁移
cd server
npm run db:migrate

# 检查数据库
psql -d your_database -c "SELECT * FROM user_storage_usage WHERE user_id = 1;"
```

---

### 问题 3: 上传后存储不更新

**检查**:
1. 浏览器控制台 → Console 标签
2. 查看是否有 WebSocket 消息
3. 检查 `[UserCenter] 存储更新:` 日志

**可能原因**:
- ❌ WebSocket 连接失败
- ❌ 后端未发送通知
- ❌ Redis 未运行

**解决**:
```bash
# 检查 Redis
redis-cli ping
# 应该返回 PONG

# 检查 WebSocket 连接
# 在浏览器控制台执行
console.log(getUserWebSocketService().isConnected());
```

---

### 问题 4: 图表不显示

**检查**:
- ✅ 确认 ECharts 已安装
- ✅ 检查控制台是否有 ECharts 错误
- ✅ 确认数据格式正确

**解决**:
```bash
# 重新安装 ECharts
cd client
npm install echarts echarts-for-react
```

---

### 问题 5: 警报通知不显示

**检查**:
1. 确认存储使用已超过 80%
2. 检查数据库 `quota_alerts` 表
3. 查看浏览器控制台 WebSocket 消息

**调试**:
```sql
-- 查看警报记录
SELECT * FROM quota_alerts 
WHERE user_id = 1 
  AND alert_type = 'storage_bytes'
ORDER BY created_at DESC;
```

---

## 📊 测试数据准备

### 创建测试用户

```bash
# 注册新用户（默认 20MB 配额）
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
  }'
```

### 手动调整配额（用于测试警报）

```sql
-- 设置为 10MB，便于快速达到警报阈值
UPDATE user_storage_usage 
SET storage_quota_bytes = 10485760 
WHERE user_id = 1;
```

### 模拟存储使用

```bash
# 上传多个测试图片
for i in {1..5}; do
  curl -X POST http://localhost:3000/api/gallery/upload \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -F "image=@test_image_${i}.jpg"
done
```

---

## 🎨 UI 验证清单

### 存储使用卡片
- [ ] 标题显示"存储使用情况"
- [ ] 进度条颜色正确（绿色 < 70%，橙色 70-90%，红色 > 90%）
- [ ] 百分比显示正确
- [ ] 剩余空间显示正确
- [ ] 三种资源类型都显示
- [ ] 数量和大小格式正确（KB/MB/GB）
- [ ] 升级按钮在接近限制时显示

### 存储明细图表
- [ ] 饼图正确渲染
- [ ] 颜色区分清晰（图片/文档/文章）
- [ ] 图例显示正确
- [ ] 鼠标悬停显示详细信息
- [ ] 响应式布局正常

### 通知消息
- [ ] 警告通知（蓝色，info）
- [ ] 严重通知（橙色，warning）
- [ ] 耗尽通知（红色，error）
- [ ] 配额更新通知（绿色，success）

---

## 📈 性能测试

### 加载性能
- [ ] 首次加载时间 < 1 秒
- [ ] 切换标签页响应 < 200ms
- [ ] 图表渲染时间 < 500ms

### 实时更新性能
- [ ] WebSocket 消息延迟 < 1 秒
- [ ] UI 更新响应 < 500ms
- [ ] 无明显卡顿

---

## ✅ 测试完成标准

- [x] 所有 10 个测试用例通过
- [x] 无控制台错误
- [x] UI 显示正常
- [x] 实时更新工作
- [x] 警报通知正常
- [x] 多标签页同步正常

---

## 📝 测试报告模板

```markdown
## 存储空间管理功能测试报告

**测试日期**: 2026-01-04
**测试人员**: [你的名字]
**测试环境**: 
- 浏览器: Chrome 120
- 操作系统: macOS
- 后端版本: v1.0.0

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 存储使用显示 | ✅ | 正常 |
| 存储明细图表 | ✅ | 正常 |
| 上传实时更新 | ✅ | 正常 |
| 删除实时更新 | ✅ | 正常 |
| 配额警报 | ✅ | 正常 |
| 配额限制 | ✅ | 正常 |
| 升级套餐 | ✅ | 正常 |
| 管理员功能 | ✅ | 正常 |
| 多标签页同步 | ✅ | 正常 |
| 页面刷新 | ✅ | 正常 |

### 发现的问题

1. [问题描述]
   - 严重程度: 高/中/低
   - 复现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

### 总体评价

功能完整性: ⭐⭐⭐⭐⭐
用户体验: ⭐⭐⭐⭐⭐
性能表现: ⭐⭐⭐⭐⭐

### 建议

- [改进建议 1]
- [改进建议 2]
```

---

**创建时间**: 2026-01-04  
**适用版本**: v1.0.0  
**预计测试时间**: 30-45 分钟
