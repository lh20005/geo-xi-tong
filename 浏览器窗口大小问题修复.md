# æµè§ˆå™¨çª—å£å¤§å°é—®é¢˜ä¿®å¤

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šPuppeteerè°ƒç”¨çš„æµè§ˆå™¨å’Œæ‰‹åŠ¨ä½¿ç”¨çš„Chromeæ˜¾ç¤ºå†…å®¹ä¸ä¸€æ ·ï¼Œç‰¹åˆ«æ˜¯ï¼š
- æ— æ³•æ»šåŠ¨åˆ°é¡µé¢æœ€åº•éƒ¨
- çœ‹ä¸åˆ°å‘å¸ƒæŒ‰é’®
- é¡µé¢æ˜¾ç¤ºä¸å®Œæ•´

## ğŸ¯ æ ¹æœ¬åŸå› 

Puppeteerå¯åŠ¨çš„æµè§ˆå™¨çª—å£é»˜è®¤æ¯”è¾ƒå°ï¼Œè™½ç„¶è®¾ç½®äº†viewportï¼ˆè§†å£ï¼‰å¤§å°ä¸º1920x1080ï¼Œä½†**æµè§ˆå™¨çª—å£æœ¬èº«**å¯èƒ½æ›´å°ï¼Œå¯¼è‡´ï¼š

1. **çª—å£å¤§å° â‰  è§†å£å¤§å°**
   - viewportåªæ˜¯é¡µé¢æ¸²æŸ“åŒºåŸŸ
   - æµè§ˆå™¨çª—å£åŒ…æ‹¬åœ°å€æ ã€å·¥å…·æ ç­‰
   - å¦‚æœçª—å£å°ï¼Œå³ä½¿viewportå¤§ä¹Ÿæ— æ³•æ­£å¸¸æ˜¾ç¤º

2. **æ»šåŠ¨é—®é¢˜**
   - å°çª—å£å¯¼è‡´æ»šåŠ¨è¡Œä¸ºå¼‚å¸¸
   - `document.body.scrollHeight`å¯èƒ½ä¸å‡†ç¡®
   - æŸäº›å…ƒç´ å¯èƒ½è¢«éšè—æˆ–ä¸å¯è§

3. **å…ƒç´ å®šä½é—®é¢˜**
   - æŒ‰é’®å¯èƒ½åœ¨è§†å£å¤–
   - `scrollIntoView()`å¯èƒ½ä¸ç”Ÿæ•ˆ
   - ç‚¹å‡»äº‹ä»¶å¯èƒ½å¤±è´¥

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å¢åŠ æµè§ˆå™¨å¯åŠ¨å‚æ•°

åœ¨`BrowserAutomationService.ts`ä¸­æ·»åŠ ï¼š

```typescript
args: [
  '--no-sandbox',
  '--disable-setuid-sandbox',
  '--disable-dev-shm-usage',
  '--disable-accelerated-2d-canvas',
  '--disable-gpu',
  '--window-size=1920,1080',  // âœ… æ–°å¢ï¼šè®¾ç½®çª—å£å¤§å°
  '--start-maximized'          // âœ… æ–°å¢ï¼šå¯åŠ¨æ—¶æœ€å¤§åŒ–
]
```

**å…³é”®å‚æ•°è¯´æ˜**ï¼š
- `--window-size=1920,1080`ï¼šè®¾ç½®æµè§ˆå™¨çª—å£å¤§å°ï¼ˆä¸æ˜¯viewportï¼‰
- `--start-maximized`ï¼šå¯åŠ¨æ—¶æœ€å¤§åŒ–çª—å£ï¼Œç¡®ä¿æœ€å¤§æ˜¾ç¤ºåŒºåŸŸ

### 2. æ”¹è¿›æ»šåŠ¨ç­–ç•¥

ä½¿ç”¨å¤šç§æ»šåŠ¨æ–¹å¼ï¼Œç¡®ä¿åˆ°è¾¾åº•éƒ¨ï¼š

```typescript
// æ–¹å¼1ï¼šæ»šåŠ¨åˆ°document.bodyåº•éƒ¨
await page.evaluate(() => {
  window.scrollTo(0, document.body.scrollHeight);
});

// æ–¹å¼2ï¼šæ»šåŠ¨åˆ°document.documentElementåº•éƒ¨
await page.evaluate(() => {
  window.scrollTo(0, document.documentElement.scrollHeight);
});

// æ–¹å¼3ï¼šä½¿ç”¨scrollByå¤šæ¬¡æ»šåŠ¨
await page.evaluate(() => {
  for (let i = 0; i < 5; i++) {
    window.scrollBy(0, 500);
  }
});
```

### 3. æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®

åœ¨ç‚¹å‡»æŒ‰é’®å‰ï¼Œå…ˆæ»šåŠ¨åˆ°æŒ‰é’®ä½ç½®ï¼š

```typescript
await page.evaluate((selector) => {
  const element = document.querySelector(selector);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}, buttonSelector);
```

**å‚æ•°è¯´æ˜**ï¼š
- `behavior: 'smooth'`ï¼šå¹³æ»‘æ»šåŠ¨
- `block: 'center'`ï¼šå…ƒç´ å±…ä¸­æ˜¾ç¤ºï¼ˆç¡®ä¿å®Œå…¨å¯è§ï¼‰

### 4. å¤šé‡æŸ¥æ‰¾ç­–ç•¥

å¦‚æœç²¾ç¡®é€‰æ‹©å™¨å¤±è´¥ï¼Œä½¿ç”¨fallbackæ–¹æ¡ˆï¼š

```typescript
// 1. ç²¾ç¡®é€‰æ‹©å™¨
const button = await page.$(exactSelector);

// 2. ç®€åŒ–é€‰æ‹©å™¨
if (!button) {
  const fallbackSelectors = [
    'button.publish-btn-last',
    'button.publish-btn',
    '.publish-footer button.byte-btn-primary'
  ];
  // é€ä¸ªå°è¯•
}

// 3. æ–‡æœ¬æŸ¥æ‰¾
if (!button) {
  await page.evaluate(() => {
    const buttons = Array.from(document.querySelectorAll('button'));
    for (const btn of buttons) {
      if (btn.textContent.includes('é¢„è§ˆ') && btn.textContent.includes('å‘å¸ƒ')) {
        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        btn.click();
        return true;
      }
    }
  });
}
```

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥æµè§ˆå™¨çª—å£å¤§å°

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
console.log('çª—å£å¤§å°:', window.outerWidth, 'x', window.outerHeight);
console.log('è§†å£å¤§å°:', window.innerWidth, 'x', window.innerHeight);
console.log('é¡µé¢é«˜åº¦:', document.body.scrollHeight);
```

### 2. æ£€æŸ¥æ»šåŠ¨ä½ç½®

```javascript
console.log('å½“å‰æ»šåŠ¨ä½ç½®:', window.scrollY);
console.log('æœ€å¤§æ»šåŠ¨é«˜åº¦:', document.documentElement.scrollHeight - window.innerHeight);
```

### 3. æ£€æŸ¥å…ƒç´ å¯è§æ€§

```javascript
const button = document.querySelector('button.publish-btn');
const rect = button.getBoundingClientRect();
console.log('æŒ‰é’®ä½ç½®:', rect);
console.log('æ˜¯å¦åœ¨è§†å£å†…:', rect.top >= 0 && rect.bottom <= window.innerHeight);
```

## ğŸ“Š å¯¹æ¯”

### ä¿®å¤å‰
- çª—å£å¤§å°ï¼šé»˜è®¤ï¼ˆçº¦800x600ï¼‰
- è§†å£å¤§å°ï¼š1920x1080
- é—®é¢˜ï¼šçª—å£å°ï¼Œæ»šåŠ¨å¼‚å¸¸ï¼ŒæŒ‰é’®ä¸å¯è§

### ä¿®å¤å
- çª—å£å¤§å°ï¼š1920x1080ï¼ˆæœ€å¤§åŒ–ï¼‰
- è§†å£å¤§å°ï¼š1920x1080
- ç»“æœï¼šçª—å£å¤§ï¼Œæ»šåŠ¨æ­£å¸¸ï¼ŒæŒ‰é’®å¯è§

## ğŸ¯ å…¶ä»–å»ºè®®

### 1. ä½¿ç”¨éheadlessæ¨¡å¼è°ƒè¯•

```typescript
headless: false  // å¯ä»¥çœ‹åˆ°æµè§ˆå™¨çª—å£
```

### 2. å¢åŠ ç­‰å¾…æ—¶é—´

```typescript
await new Promise(resolve => setTimeout(resolve, 2000));
```

### 3. æˆªå›¾è°ƒè¯•

```typescript
await page.screenshot({ 
  path: 'debug-scroll.png', 
  fullPage: true 
});
```

### 4. æ‰“å°é¡µé¢ä¿¡æ¯

```typescript
const info = await page.evaluate(() => ({
  windowSize: { width: window.outerWidth, height: window.outerHeight },
  viewportSize: { width: window.innerWidth, height: window.innerHeight },
  scrollPosition: window.scrollY,
  pageHeight: document.body.scrollHeight
}));
console.log('é¡µé¢ä¿¡æ¯:', info);
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `server/src/services/BrowserAutomationService.ts` - æµè§ˆå™¨å¯åŠ¨é…ç½®
- `server/src/services/adapters/ToutiaoAdapter.ts` - æ»šåŠ¨å’Œç‚¹å‡»é€»è¾‘

## âœ… ä¿®å¤çŠ¶æ€

- [x] å¢åŠ æµè§ˆå™¨çª—å£å¤§å°å‚æ•°
- [x] å¢åŠ æœ€å¤§åŒ–å¯åŠ¨å‚æ•°
- [x] æ”¹è¿›å¤šç§æ»šåŠ¨æ–¹å¼
- [x] æ·»åŠ scrollIntoView()
- [x] å¢åŠ fallbackæŸ¥æ‰¾ç­–ç•¥
- [x] å¢åŠ ç­‰å¾…æ—¶é—´

## ğŸš€ æµ‹è¯•

é‡å¯æœåŠ¡å™¨åæµ‹è¯•ï¼š
```bash
cd server && npm run dev
```

æµè§ˆå™¨åº”è¯¥ä¼šä»¥æœ€å¤§åŒ–çª—å£å¯åŠ¨ï¼Œèƒ½å¤Ÿæ­£å¸¸æ»šåŠ¨åˆ°åº•éƒ¨å¹¶çœ‹åˆ°æ‰€æœ‰æŒ‰é’®ã€‚
