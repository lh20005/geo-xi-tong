# 发布任务故障排查指南

## 问题描述

点击"创建发布任务"后：
- ❌ 任务没有被记录到"发布任务"列表中
- ❌ 没有打开浏览器自动发布的动作

## 排查步骤

### 步骤1：运行诊断脚本

```bash
./diagnose-publishing-issue.sh
```

这个脚本会检查：
- ✅ 数据库连接
- ✅ 数据库表是否存在
- ✅ 平台配置是否正确
- ✅ 是否有绑定的账号
- ✅ 现有的发布任务
- ✅ 错误日志

### 步骤2：测试API

```bash
./test-create-task-api.sh
```

这个脚本会：
- ✅ 检查服务器状态
- ✅ 获取平台配置
- ✅ 获取账号列表
- ✅ 获取文章列表
- ✅ 创建测试任务
- ✅ 查询任务状态

### 步骤3：检查服务器日志

查看服务器终端输出，寻找：

**成功的日志：**
```
✅ 任务 #1 已创建并开始自动执行
[任务 #1] 开始执行发布任务
启动浏览器
```

**错误的日志：**
```
❌ 创建发布任务失败: ...
❌ 任务 #1 自动执行失败: ...
```

### 步骤4：检查浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查找红色错误信息

**常见错误：**
```
POST http://localhost:3001/api/publishing/tasks 400 (Bad Request)
POST http://localhost:3001/api/publishing/tasks 500 (Internal Server Error)
```

### 步骤5：检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 点击"创建发布任务"
4. 查找 `publishing/tasks` 请求
5. 点击查看请求详情

**检查项：**
- Request URL: `http://localhost:3001/api/publishing/tasks`
- Request Method: `POST`
- Status Code: 应该是 `200 OK`
- Request Payload: 包含 `article_id`, `account_id`, `platform_id`
- Response: 包含 `success: true` 和任务数据

## 常见问题和解决方案

### 问题1：数据库表不存在

**症状：**
```
relation "publishing_tasks" does not exist
```

**解决方案：**
```bash
./run-publishing-migration.sh
```

### 问题2：没有绑定账号

**症状：**
- 前端显示"暂无可用平台"
- 或者选择平台后没有账号可选

**解决方案：**
1. 进入"平台登录"页面
2. 选择平台
3. 点击"浏览器登录"
4. 完成登录流程

### 问题3：参数验证失败

**症状：**
```
400 Bad Request
缺少必需参数
```

**检查：**
- `article_id` 是否有效
- `account_id` 是否有效
- `platform_id` 是否正确

**解决方案：**
```bash
# 运行测试脚本查看详细信息
./test-create-task-api.sh
```

### 问题4：服务器未运行

**症状：**
```
Failed to fetch
Network Error
```

**解决方案：**
```bash
# 启动服务器
cd server
npm run dev
```

### 问题5：端口冲突

**症状：**
```
Error: listen EADDRINUSE: address already in use :::3001
```

**解决方案：**
```bash
# 查找占用端口的进程
lsof -i :3001

# 杀死进程
kill -9 <PID>

# 或者修改端口
# 编辑 server/src/index.ts，修改端口号
```

### 问题6：数据库连接失败

**症状：**
```
❌ 数据库连接错误
```

**解决方案：**
1. 检查 `.env` 文件中的 `DATABASE_URL`
2. 确保数据库服务正在运行
3. 测试数据库连接：
```bash
source .env
psql "$DATABASE_URL" -c "SELECT 1;"
```

### 问题7：任务创建成功但没有执行

**症状：**
- 任务出现在列表中
- 状态一直是 "pending"
- 没有打开浏览器

**可能原因：**
1. `PublishingExecutor` 没有被正确调用
2. Puppeteer 安装不完整
3. Chrome/Chromium 未安装

**解决方案：**

**检查 Puppeteer：**
```bash
cd server
npm list puppeteer
```

**重新安装 Puppeteer：**
```bash
cd server
npm install puppeteer
```

**手动执行任务：**
```bash
# 获取任务ID
curl http://localhost:3001/api/publishing/tasks | jq '.data[0].id'

# 手动执行
curl -X POST http://localhost:3001/api/publishing/tasks/1/execute
```

### 问题8：浏览器启动失败

**症状：**
```
❌ 浏览器启动失败
Failed to launch the browser process
```

**解决方案：**

**macOS：**
```bash
# 安装 Chrome
brew install --cask google-chrome
```

**Linux：**
```bash
# Ubuntu/Debian
sudo apt-get install chromium-browser

# CentOS/RHEL
sudo yum install chromium
```

**设置环境变量：**
```bash
# 在 .env 文件中添加
PUPPETEER_EXECUTABLE_PATH=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome
```

## 调试技巧

### 1. 启用详细日志

在 `server/src/services/PublishingExecutor.ts` 中添加更多日志：

```typescript
console.log('[DEBUG] 开始执行任务', taskId);
console.log('[DEBUG] 任务详情', task);
console.log('[DEBUG] 账号信息', account);
```

### 2. 测试单个组件

**测试数据库连接：**
```bash
source .env
psql "$DATABASE_URL" -c "SELECT * FROM publishing_tasks LIMIT 1;"
```

**测试API：**
```bash
curl http://localhost:3001/api/publishing/tasks
```

**测试浏览器启动：**
```javascript
// 在 server 目录创建 test-browser.js
const puppeteer = require('puppeteer');

(async () => {
  console.log('启动浏览器...');
  const browser = await puppeteer.launch({ headless: false });
  console.log('✅ 浏览器启动成功');
  
  const page = await browser.newPage();
  await page.goto('https://www.baidu.com');
  console.log('✅ 页面加载成功');
  
  await browser.close();
  console.log('✅ 浏览器关闭成功');
})();
```

```bash
node test-browser.js
```

### 3. 检查数据库数据

```sql
-- 查看所有任务
SELECT * FROM publishing_tasks ORDER BY id DESC;

-- 查看任务日志
SELECT * FROM publishing_logs WHERE task_id = 1 ORDER BY created_at;

-- 查看账号
SELECT id, platform_id, account_name, status FROM platform_accounts;

-- 查看平台配置
SELECT platform_id, platform_name, is_enabled FROM platforms_config;
```

## 完整的检查清单

- [ ] 数据库迁移已运行
- [ ] 数据库表存在（4个表）
- [ ] 平台配置已插入（12个平台）
- [ ] 至少绑定了一个平台账号
- [ ] 服务器正在运行（端口3001）
- [ ] 前端正在运行（端口3000）
- [ ] 浏览器控制台没有错误
- [ ] 网络请求返回200状态码
- [ ] Puppeteer 已正确安装
- [ ] Chrome/Chromium 已安装

## 获取帮助

如果以上步骤都无法解决问题，请提供以下信息：

1. **诊断脚本输出：**
```bash
./diagnose-publishing-issue.sh > diagnosis.txt 2>&1
```

2. **测试脚本输出：**
```bash
./test-create-task-api.sh > test-result.txt 2>&1
```

3. **服务器日志：**
```bash
# 复制服务器终端的最后50行输出
```

4. **浏览器控制台错误：**
```
# 截图或复制错误信息
```

5. **网络请求详情：**
```
# F12 -> Network -> publishing/tasks -> 右键 -> Copy as cURL
```

---

**大多数问题都可以通过运行迁移脚本解决：**
```bash
./run-publishing-migration.sh
```
