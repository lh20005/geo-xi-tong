# 用户订阅管理功能 - 实施指南

## 📋 功能概述

在用户管理页面新增订阅管理功能，管理员可以全面管理用户的订阅套餐，包括：
- ✅ 查看订阅详情和配额使用情况
- ✅ 升级套餐
- ✅ 延期订阅
- ✅ 调整配额（临时/永久）
- ✅ 重置配额使用量
- ✅ 暂停/恢复订阅
- ✅ 取消订阅
- ✅ 赠送套餐
- ✅ 查看调整历史

## 🎯 设计理念

基于业界最佳实践设计，参考：
- **清晰的信息层级**：重要信息优先展示
- **简化的操作流程**：减少点击次数
- **透明的价格和配额**：所有信息一目了然
- **实时反馈**：操作后立即更新
- **完整的审计日志**：所有操作可追溯

## 📁 文件结构

### 后端文件
```
server/src/
├── db/
│   ├── migrations/
│   │   └── 027_add_subscription_management.sql  # 数据库迁移
│   └── run-migration-027.ts                      # 迁移执行脚本
├── services/
│   └── UserSubscriptionManagementService.ts      # 业务逻辑服务
└── routes/
    └── admin/
        └── userSubscriptions.ts                  # API 路由
```

### 前端文件
```
client/src/
├── api/
│   └── userSubscriptions.ts                      # API 客户端
├── components/
│   └── UserSubscription/
│       ├── SubscriptionDetailDrawer.tsx          # 主抽屉组件
│       ├── UpgradePlanModal.tsx                  # 升级套餐
│       ├── ExtendSubscriptionModal.tsx           # 延期订阅
│       ├── AdjustQuotaModal.tsx                  # 配额调整
│       ├── ControlSubscriptionModal.tsx          # 订阅控制
│       ├── GiftSubscriptionModal.tsx             # 赠送套餐
│       └── AdjustmentHistoryTable.tsx            # 历史记录
└── pages/
    └── UserManagementPage.tsx                    # 用户管理页面（已更新）
```

## 🚀 实施步骤

### Step 1: 执行数据库迁移

```bash
cd server
npx ts-node src/db/run-migration-027.ts
```

验证迁移成功：
```sql
-- 检查表是否创建
SELECT table_name FROM information_schema.tables 
WHERE table_name = 'subscription_adjustments';

-- 检查函数是否创建
SELECT proname FROM pg_proc WHERE proname = 'get_user_subscription_detail';

-- 检查视图是否创建
SELECT table_name FROM information_schema.views 
WHERE table_name = 'v_subscription_adjustment_history';
```

### Step 2: 重启后端服务

```bash
# 开发环境
npm run server:dev

# 或生产环境
npm run server:build
npm run server:start
```

验证路由注册：
```bash
# 测试 API 是否可访问（需要管理员 token）
curl -X GET http://localhost:3000/api/admin/user-subscriptions/1 \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### Step 3: 重启前端服务

```bash
cd client
npm run dev
```

### Step 4: 功能测试

1. **登录管理员账号**
2. **进入用户管理页面**
3. **点击任意用户的"订阅管理"按钮**
4. **测试各项功能**：
   - 查看订阅详情
   - 升级套餐
   - 延期订阅
   - 调整配额
   - 暂停/恢复
   - 赠送套餐
   - 查看历史记录

## 📊 数据库设计

### 新增表：subscription_adjustments

记录所有订阅调整操作：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL | 主键 |
| user_id | INTEGER | 用户ID |
| subscription_id | INTEGER | 订阅ID |
| adjustment_type | VARCHAR(50) | 调整类型 |
| old_plan_id | INTEGER | 旧套餐ID |
| new_plan_id | INTEGER | 新套餐ID |
| old_end_date | TIMESTAMP | 旧到期日期 |
| new_end_date | TIMESTAMP | 新到期日期 |
| days_added | INTEGER | 延长天数 |
| quota_adjustments | JSONB | 配额调整详情 |
| reason | TEXT | 调整原因 |
| admin_id | INTEGER | 操作管理员ID |
| admin_note | TEXT | 管理员备注 |
| ip_address | VARCHAR(45) | 操作IP |
| user_agent | TEXT | 浏览器信息 |
| created_at | TIMESTAMP | 创建时间 |

### 扩展表：user_subscriptions

新增字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| paused_at | TIMESTAMP | 暂停时间 |
| pause_reason | TEXT | 暂停原因 |
| custom_quotas | JSONB | 自定义配额 |
| is_gift | BOOLEAN | 是否赠送 |
| gift_reason | TEXT | 赠送原因 |

## 🔌 API 接口

### 1. 获取用户订阅详情
```
GET /api/admin/user-subscriptions/:userId
```

### 2. 升级套餐
```
POST /api/admin/user-subscriptions/:userId/upgrade
Body: { newPlanId, reason }
```

### 3. 延期订阅
```
POST /api/admin/user-subscriptions/:userId/extend
Body: { daysToAdd, reason }
```

### 4. 调整配额
```
POST /api/admin/user-subscriptions/:userId/adjust-quota
Body: { featureCode, newValue, isPermanent, reason }
```

### 5. 重置配额
```
POST /api/admin/user-subscriptions/:userId/reset-quota
Body: { featureCode, reason }
```

### 6. 暂停订阅
```
POST /api/admin/user-subscriptions/:userId/pause
Body: { reason }
```

### 7. 恢复订阅
```
POST /api/admin/user-subscriptions/:userId/resume
Body: { reason }
```

### 8. 取消订阅
```
POST /api/admin/user-subscriptions/:userId/cancel
Body: { immediate, reason }
```

### 9. 赠送套餐
```
POST /api/admin/user-subscriptions/:userId/gift
Body: { planId, durationDays, reason }
```

### 10. 获取调整历史
```
GET /api/admin/user-subscriptions/:userId/history?page=1&pageSize=20
```

## 🎨 UI 设计特点

### 1. 订阅概览卡片
- 套餐信息一目了然
- 配额使用进度条可视化
- 状态标签清晰醒目
- 快捷操作按钮集中

### 2. 操作模态框
- 表单验证完善
- 实时预览效果
- 操作说明清晰
- 确认提示友好

### 3. 历史记录表格
- 时间倒序排列
- 操作类型标签化
- 详情信息完整
- 支持分页查询

## 🔒 权限与安全

### 权限控制
- 所有接口需要管理员权限
- 使用 `authenticate` + `requireAdmin` 中间件

### 审计日志
- 记录操作人、时间、IP、浏览器
- 记录操作前后的状态变化
- 支持历史记录查询

### 数据验证
- 前端表单验证
- 后端参数验证
- 数据库约束检查

## 📝 业务逻辑说明

### 升级套餐
1. 获取当前订阅和剩余天数
2. 更新为新套餐
3. 保留剩余时间并累加新套餐时长
4. 清空自定义配额（使用新套餐默认配额）
5. 记录调整历史
6. 发送 WebSocket 通知

### 延期订阅
1. 在当前到期日期基础上增加天数
2. 不影响套餐配置
3. 记录调整历史
4. 发送 WebSocket 通知

### 配额调整
- **临时调整**：写入 custom_quotas，仅当前订阅周期有效
- **永久调整**：同样写入 custom_quotas，但标记为永久
- **重置配额**：清空 user_usage 表对应记录

### 暂停/恢复
- 暂停：设置 paused_at 时间戳
- 恢复：清空 paused_at 时间戳
- 暂停期间用户无法使用功能

### 取消订阅
- **立即取消**：将 end_date 设为当前时间
- **到期后取消**：标记状态为 cancelled，到期自动失效

### 赠送套餐
- 创建新的订阅记录
- 标记为赠送（is_gift = true）
- 立即生效

## 🧪 测试清单

### 功能测试
- [ ] 查看订阅详情
- [ ] 升级套餐成功
- [ ] 延期订阅成功
- [ ] 临时调整配额
- [ ] 永久调整配额
- [ ] 重置配额使用量
- [ ] 暂停订阅
- [ ] 恢复订阅
- [ ] 立即取消订阅
- [ ] 到期后取消订阅
- [ ] 赠送套餐
- [ ] 查看调整历史

### 边界测试
- [ ] 无订阅用户的处理
- [ ] 已过期订阅的处理
- [ ] 配额值边界（-1, 0, 最大值）
- [ ] 延期天数边界（1-3650）
- [ ] 并发操作处理

### 权限测试
- [ ] 非管理员无法访问
- [ ] 管理员可以访问所有功能
- [ ] 操作日志正确记录

## 📈 性能优化

### 数据库优化
- 所有外键字段已建立索引
- 使用数据库函数减少查询次数
- 使用视图简化复杂查询

### 前端优化
- 懒加载模态框组件
- 使用 WebSocket 实时更新
- 表格分页加载

## 🐛 常见问题

### Q1: 迁移执行失败
**A:** 检查数据库连接，确保 PostgreSQL 版本 >= 12

### Q2: 订阅详情加载失败
**A:** 检查用户是否有活跃订阅，检查 API 权限

### Q3: 配额调整不生效
**A:** 检查 custom_quotas 字段是否正确更新，检查配额检查函数

### Q4: WebSocket 通知未收到
**A:** 检查 WebSocket 连接状态，检查用户ID是否正确

## 📚 相关文档

- [商品管理系统实施指南](./docs/02-功能说明/商品管理系统实施指南.md)
- [配额系统修复总结](./配额系统修复总结_最终版.md)
- [用户隔离安全修复](./用户隔离安全修复总结.md)

## ✅ 完成标志

功能开发完成的标志：
1. ✅ 数据库迁移成功执行
2. ✅ 所有 API 接口正常工作
3. ✅ 前端界面正常显示
4. ✅ 所有功能测试通过
5. ✅ 审计日志正确记录
6. ✅ WebSocket 通知正常

---

**开发完成时间**: 2026-01-05
**开发者**: Kiro AI Assistant
**版本**: v1.0.0
