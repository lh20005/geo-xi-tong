# 配额时效性修复 - 执行检查清单

## 📋 执行前检查

- [ ] 已备份数据库
- [ ] 已在测试环境验证
- [ ] 已通知用户配额规则变更
- [ ] 已准备回滚方案
- [ ] 已停止相关定时任务

## 🔧 执行步骤

### 步骤 1: 数据库迁移
- [ ] 执行迁移脚本
  ```bash
  cd server
  npx ts-node src/db/run-migration-030.ts
  ```
- [ ] 检查迁移输出，确认无错误
- [ ] 验证函数已更新
  ```sql
  \df record_feature_usage
  \df check_feature_quota
  \df get_user_storage_quota
  ```

### 步骤 2: 数据验证
- [ ] 检查是否还有永久配额
  ```sql
  SELECT COUNT(*) FROM user_usage WHERE period_end > '2099-01-01';
  ```
  预期结果: 0

- [ ] 检查配额是否绑定到订阅
  ```sql
  SELECT uu.user_id, uu.feature_code, uu.period_end, us.end_date
  FROM user_usage uu
  JOIN user_subscriptions us ON us.user_id = uu.user_id
  WHERE us.status = 'active' AND uu.period_end > us.end_date;
  ```
  预期结果: 0 行

- [ ] 检查过期订阅状态
  ```sql
  SELECT COUNT(*) FROM user_subscriptions 
  WHERE status = 'active' AND end_date <= CURRENT_TIMESTAMP;
  ```
  预期结果: 0

### 步骤 3: 功能测试
- [ ] 运行测试脚本
  ```bash
  npx ts-node src/scripts/test-quota-expiration-fix.ts
  ```
- [ ] 所有测试通过
- [ ] 无错误或警告

### 步骤 4: 服务重启
- [ ] 停止当前服务
- [ ] 清除 TypeScript 编译缓存
  ```bash
  rm -rf dist/
  ```
- [ ] 重新编译
  ```bash
  npm run build
  ```
- [ ] 启动服务
  ```bash
  npm run server:dev
  ```
- [ ] 检查启动日志
  - [ ] "✅ 订阅到期检查服务已启动"
  - [ ] 无错误信息

### 步骤 5: 运行时验证
- [ ] 检查定时任务是否运行
  - [ ] 订阅到期检查服务已启动
  - [ ] 每小时执行一次
  
- [ ] 测试配额检查
  - [ ] 有效订阅用户可以使用配额
  - [ ] 过期订阅用户无法使用配额
  - [ ] 配额检查返回正确的错误信息

- [ ] 测试订阅续费
  - [ ] 续费后配额重置
  - [ ] 使用量清零
  - [ ] 新配额立即生效

## 🔍 验证场景

### 场景 1: 有效订阅用户
- [ ] 可以正常使用所有配额
- [ ] 配额统计正确
- [ ] 到期时间显示正确

### 场景 2: 过期订阅用户
- [ ] 无法使用任何配额
- [ ] 收到到期通知
- [ ] 配额显示为 0

### 场景 3: 订阅续费
- [ ] 续费成功
- [ ] 配额重置
- [ ] 可以正常使用

### 场景 4: 套餐升级
- [ ] 升级成功
- [ ] 配额立即更新
- [ ] 使用量重置

## 📊 监控指标

### 关键指标
- [ ] 永久配额数量 = 0
- [ ] 过期但未处理的订阅 = 0
- [ ] 配额绑定错误 = 0
- [ ] 定时任务运行正常

### 日志监控
- [ ] 无配额检查错误
- [ ] 无订阅到期处理错误
- [ ] 无 WebSocket 通知失败

## ⚠️ 回滚条件

如果出现以下情况，立即回滚：

- [ ] 大量用户无法使用配额
- [ ] 配额检查频繁失败
- [ ] 订阅到期处理出错
- [ ] 数据不一致

## 🔄 回滚步骤

1. [ ] 停止服务
2. [ ] 恢复数据库备份
3. [ ] 回滚代码
   ```bash
   git revert <commit-hash>
   ```
4. [ ] 重启服务
5. [ ] 验证功能正常

## 📝 执行记录

### 执行信息
- 执行人: _______________
- 执行时间: _______________
- 环境: [ ] 测试 [ ] 生产
- 数据库备份: _______________

### 执行结果
- [ ] 成功
- [ ] 失败（原因: _______________）
- [ ] 已回滚

### 问题记录
1. _______________
2. _______________
3. _______________

### 后续行动
- [ ] 更新文档
- [ ] 通知用户
- [ ] 监控一周
- [ ] 清理旧数据

## 📞 联系方式

如遇紧急问题：
- 技术负责人: _______________
- 数据库管理员: _______________
- 运维团队: _______________

---

**检查清单版本**: 1.0  
**最后更新**: 2026-01-05  
**适用版本**: Migration 030
