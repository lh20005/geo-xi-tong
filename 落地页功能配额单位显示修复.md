# 落地页功能配额单位显示修复

## 修复时间
2026-01-04

## 问题描述

8080落地页在显示套餐功能配额时，只显示数值，没有显示单位。

**问题示例**：
- 显示：每月生成文章数 **30**
- 期望：每月生成文章数 **30篇**

## 问题原因

1. **类型定义缺失**：`Plan` 接口的 `features` 中缺少 `feature_unit` 字段
2. **函数参数缺失**：`getFeatureDisplayValue` 函数只接收 `value` 参数，没有接收 `unit` 参数
3. **调用时未传递单位**：调用函数时只传递了 `feature.feature_value`，没有传递 `feature.feature_unit`

## 修复方案

### 1. 更新类型定义

**文件**：`landing/src/pages/HomePage.tsx`

```typescript
// 修改前
interface Plan {
  id: number;
  plan_name: string;
  plan_code: string;
  price: string | number;
  billing_cycle: string;
  features: {
    feature_code: string;
    feature_name: string;
    feature_value: number;
  }[];
  description?: string;
}

// 修改后
interface Plan {
  id: number;
  plan_name: string;
  plan_code: string;
  price: string | number;
  billing_cycle: string;
  features: {
    feature_code: string;
    feature_name: string;
    feature_value: number;
    feature_unit: string;  // 添加单位字段
  }[];
  description?: string;
}
```

### 2. 更新辅助函数

```typescript
// 修改前
const getFeatureDisplayValue = (value: number): string => {
  return value === -1 ? '不限' : value.toString();
};

// 修改后
const getFeatureDisplayValue = (value: number, unit: string): string => {
  return value === -1 ? '不限' : `${value}${unit}`;
};
```

**改进说明**：
- 添加 `unit` 参数
- 返回值包含单位：`${value}${unit}`
- 无限制时仍然显示"不限"

### 3. 更新函数调用

```typescript
// 修改前
<span className="text-xs leading-relaxed">
  {feature.feature_name} <span className="font-bold">{getFeatureDisplayValue(feature.feature_value)}</span>
</span>

// 修改后
<span className="text-xs leading-relaxed">
  {feature.feature_name} <span className="font-bold">{getFeatureDisplayValue(feature.feature_value, feature.feature_unit)}</span>
</span>
```

## 显示效果对比

### 修改前
```
每月生成文章数 30
每月发布文章数 60
可管理平台账号数 1
关键词蒸馏数 50
```

### 修改后
```
每月生成文章数 30篇
每月发布文章数 60篇
可管理平台账号数 1个
关键词蒸馏数 50个
```

## 测试验证

### 1. 启动落地页服务

```bash
cd landing
npm run dev
```

### 2. 访问落地页

打开浏览器访问：`http://localhost:8080`

### 3. 查看定价区域

滚动到"灵活的使用方案"区域，或直接访问：
```
http://localhost:8080#pricing
```

### 4. 验证功能配额显示

检查每个套餐卡片的功能列表：

**免费版**：
- ✅ 每月生成文章数 **30篇**
- ✅ 每月发布文章数 **30篇**
- ✅ 可管理平台账号数 **1个**
- ✅ 关键词蒸馏数 **50个**

**专业版**：
- ✅ 每月生成文章数 **3000篇**
- ✅ 每月发布文章数 **6000篇**
- ✅ 可管理平台账号数 **3个**
- ✅ 关键词蒸馏数 **500个**

**企业版**：
- ✅ 每月生成文章数 **不限**
- ✅ 每月发布文章数 **不限**
- ✅ 可管理平台账号数 **10个**
- ✅ 关键词蒸馏数 **不限**

### 5. 测试不同套餐

如果有多个套餐，验证所有套餐的功能配额都正确显示单位。

## 数据库验证

确认数据库中的功能配额包含单位信息：

```sql
SELECT 
  sp.plan_name,
  pf.feature_name,
  pf.feature_value,
  pf.feature_unit
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
WHERE sp.is_active = TRUE
ORDER BY sp.display_order, pf.feature_code;
```

**预期结果**：
```
 plan_name |  feature_name  | feature_value | feature_unit 
-----------+----------------+---------------+--------------
 免费      | 每月生成文章数 |            30 | 篇
 免费      | 每月发布文章数 |            30 | 篇
 免费      | 可管理平台账号数 |             1 | 个
 免费      | 关键词蒸馏数   |            50 | 个
 专业版    | 每月生成文章数 |          3000 | 篇
 专业版    | 每月发布文章数 |          6000 | 篇
 ...
```

## API 验证

检查 API 返回的数据是否包含 `feature_unit` 字段：

```bash
curl http://localhost:3000/api/subscription/plans | jq
```

**预期响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "plan_name": "免费",
      "plan_code": "free",
      "price": "0.00",
      "billing_cycle": "monthly",
      "features": [
        {
          "feature_code": "articles_per_month",
          "feature_name": "每月生成文章数",
          "feature_value": 30,
          "feature_unit": "篇"
        },
        {
          "feature_code": "publish_per_month",
          "feature_name": "每月发布文章数",
          "feature_value": 30,
          "feature_unit": "篇"
        }
      ]
    }
  ]
}
```

## 相关文件

- `landing/src/pages/HomePage.tsx` - 落地页首页（定价区域）

## 注意事项

### 1. 单位一致性
确保数据库中所有功能配额都有正确的单位：
- 文章数：**篇**
- 账号数：**个**
- 关键词数：**个**

### 2. 无限制显示
当 `feature_value = -1` 时，显示"不限"，不显示单位。

### 3. 响应式显示
在不同屏幕尺寸下，单位都应该正确显示：
- 桌面端（4列）：✅
- 平板端（2-3列）：✅
- 移动端（1列）：✅

### 4. 浏览器兼容性
- ✅ Chrome
- ✅ Firefox
- ✅ Safari
- ✅ Edge
- ✅ 移动端浏览器

## 常见问题

### Q1: 单位没有显示？
**A**: 
1. 清除浏览器缓存（Ctrl+Shift+R）
2. 确认落地页服务已重启
3. 检查 API 返回的数据是否包含 `feature_unit`

### Q2: 显示为 "undefined"？
**A**: 
1. 检查数据库中是否有 `feature_unit` 字段
2. 检查 API 查询是否包含 `feature_unit`
3. 检查类型定义是否正确

### Q3: 部分套餐有单位，部分没有？
**A**: 
1. 检查数据库中所有功能配额是否都有单位
2. 运行 SQL 更新缺失的单位：
```sql
UPDATE plan_features 
SET feature_unit = '篇' 
WHERE feature_code IN ('articles_per_month', 'publish_per_month') 
AND (feature_unit IS NULL OR feature_unit = '');

UPDATE plan_features 
SET feature_unit = '个' 
WHERE feature_code IN ('platform_accounts', 'keyword_distillation') 
AND (feature_unit IS NULL OR feature_unit = '');
```

## 验收标准

- ✅ 所有功能配额都显示单位
- ✅ 单位紧跟在数值后面（无空格）
- ✅ 无限制时显示"不限"（不显示单位）
- ✅ 不同套餐的单位都正确
- ✅ 响应式布局下单位正常显示
- ✅ 无 TypeScript 错误
- ✅ 无控制台错误

## 后续优化建议

### 1. 单位国际化
如果需要支持多语言，可以将单位也纳入国际化：
```typescript
const getUnitText = (unit: string, locale: string) => {
  const units = {
    'zh-CN': { '篇': '篇', '个': '个' },
    'en-US': { '篇': ' articles', '个': ' items' }
  };
  return units[locale]?.[unit] || unit;
};
```

### 2. 单位格式化
对于大数值，可以添加千分位分隔符：
```typescript
const formatValue = (value: number): string => {
  if (value === -1) return '不限';
  return value.toLocaleString('zh-CN');
};
```

### 3. 单位缩写
对于移动端，可以考虑使用缩写：
```typescript
const getShortUnit = (unit: string, isMobile: boolean) => {
  if (!isMobile) return unit;
  const shortUnits = { '篇': '篇', '个': '个' };
  return shortUnits[unit] || unit;
};
```

## 总结

本次修复解决了落地页套餐功能配额不显示单位的问题。通过更新类型定义、修改辅助函数和更新函数调用，现在所有功能配额都会正确显示单位（如"30篇"、"1个"），提升了用户体验和信息的完整性。

**修复已完成，落地页现在正确显示功能配额单位！**
