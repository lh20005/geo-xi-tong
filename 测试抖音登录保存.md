# 测试抖音登录保存

## 快速测试步骤

### 1. 删除旧的抖音账号（如果有）

```bash
# 查看现有抖音账号
curl "http://localhost:3000/api/publishing/accounts/platform/douyin"

# 如果有账号，删除它（替换ID）
curl -X DELETE "http://localhost:3000/api/publishing/accounts/10"
```

### 2. 重启服务器

```bash
cd server
npm start
```

### 3. 测试登录

1. 打开前端：http://localhost:5173
2. 进入"平台登录"页面
3. 点击"抖音"卡片
4. 在弹出的浏览器中完成登录（扫码或密码）
5. **等待页面自动跳转**（重要！）
6. 浏览器会自动关闭
7. 回到前端页面，点击"刷新"按钮
8. 向下滚动查看"账号管理"表格

### 4. 验证结果

**应该看到**：
- 账号管理表格中有一条新记录
- 平台：抖音号
- 账号名称：抖音号_[时间戳]
- 状态：正常 ✅

**如果没看到**：
1. 检查后端日志，看是否有错误
2. 检查浏览器控制台（F12），看是否有错误
3. 运行验证命令（见下方）

## 验证命令

### 检查数据库

```bash
psql postgresql://lzc@localhost:5432/geo_system -c "SELECT id, platform_id, account_name, created_at FROM platform_accounts WHERE platform_id = 'douyin' ORDER BY created_at DESC LIMIT 1;"
```

### 检查API

```bash
# 获取所有账号
curl "http://localhost:3000/api/publishing/accounts" | python3 -m json.tool

# 获取抖音账号
curl "http://localhost:3000/api/publishing/accounts/platform/douyin" | python3 -m json.tool
```

### 检查Cookie（替换ID）

```bash
curl "http://localhost:3000/api/publishing/accounts/[ID]?includeCredentials=true" | python3 -c "
import sys, json
data = json.load(sys.stdin)
cookies = data['data']['credentials']['cookies']
print(f'Cookie数量: {len(cookies)}')
print('\n关键Cookie:')
for c in cookies:
    if 'sessionid' in c['name'] or 'sid_guard' in c['name']:
        print(f'  ✅ {c[\"name\"]}')
"
```

## 预期的后端日志

```
[浏览器登录] 开始登录流程
[浏览器登录] 平台: 抖音号 (douyin)
[浏览器登录] 登录URL: https://creator.douyin.com/
[浏览器登录] 浏览器启动成功
[浏览器登录] 页面加载完成，当前URL: https://creator.douyin.com/
[浏览器登录] 等待用户完成登录...
[等待登录] douyin 平台 - 初始URL: https://creator.douyin.com/
[等待登录] douyin 登录成功，当前URL: https://creator.douyin.com/creator-micro/home
[浏览器登录] 检测到登录成功，正在获取Cookie...
[浏览器登录] 成功获取 39 个Cookie
[浏览器登录] 正在保存账号信息: 抖音号_1234567890
[浏览器登录] 账号保存成功 ID: 11
```

## 关键点

### ✅ 必须等待页面跳转

登录后，抖音会自动跳转到创作者中心首页：
- 从：`https://creator.douyin.com/`
- 到：`https://creator.douyin.com/creator-micro/home`

**只有URL变化后，系统才会保存Cookie！**

### ✅ 不要手动关闭浏览器

系统检测到登录成功后会自动关闭浏览器，不要提前手动关闭。

### ✅ 刷新前端页面

浏览器关闭后，回到前端页面点击"刷新"按钮，或按F5刷新。

## 常见问题

### Q1: 浏览器一直不关闭

**原因**：可能没有完成登录，或者页面没有跳转

**解决**：
1. 确保完成了登录（扫码或输入密码）
2. 等待页面自动跳转到创作者中心
3. 如果5分钟后还没关闭，说明检测失败，查看后端日志

### Q2: 前端没有显示账号

**原因**：可能是页面没有刷新

**解决**：
1. 点击页面右上角的"刷新"按钮
2. 或按F5刷新浏览器
3. 或重新进入"平台登录"页面

### Q3: 如何确认Cookie是否有效

**方法**：创建一个发布任务，选择抖音平台和该账号，尝试发布一篇文章。如果能成功登录并发布，说明Cookie有效。

## 与头条号对比

| 项目 | 头条号 | 抖音 |
|------|--------|------|
| 登录URL | https://mp.toutiao.com/auth/page/login/ | https://creator.douyin.com/ |
| 登录后URL | https://mp.toutiao.com/profile_v4/... | https://creator.douyin.com/creator-micro/home |
| 检测方式 | URL变化 | URL变化（统一） |
| Cookie数量 | ~15个 | ~39个 |
| 工作状态 | ✅ 正常 | ✅ 已修复 |

现在抖音和头条号使用完全相同的检测逻辑，应该都能正常工作！

---

**创建时间**：2025-12-17
**状态**：✅ 已优化，等待测试
