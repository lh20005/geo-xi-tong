# 发布流程完整修复 ✅

## 问题分析

之前的代码问题：
1. ❌ 选择器太具体，找不到元素
2. ❌ 没有多种备选方案
3. ❌ 没有智能查找逻辑

## 新的智能算法

### 第1步：查找标题输入框

**策略**：尝试多个选择器，从具体到通用

```typescript
const titleSelectors = [
  'input[placeholder*="标题"]',      // 包含"标题"的placeholder
  'input[placeholder*="填写标题"]',
  'input[placeholder*="请输入标题"]',
  'input[name="title"]',            // name属性
  'input[type="text"]',             // 所有文本输入框
  '.title-input input',             // class选择器
  '#title',                         // id选择器
  '[data-testid="title-input"]'     // 测试id
];
```

**后备方案**：如果都找不到，使用页面上第一个文本输入框

### 第2步：查找内容编辑器

**策略**：查找可编辑元素

```typescript
const editorSelectors = [
  '.ql-editor',                     // Quill编辑器
  '[contenteditable="true"]',       // 可编辑div
  '.editor-content',
  '.content-editor',
  'div[role="textbox"]',            // ARIA角色
  'textarea',                       // 文本域
  '[data-testid="editor"]'
];
```

**后备方案**：使用最后一个可编辑元素（通常是内容编辑器）

### 第3步：查找发布按钮

**策略1**：通过文本内容查找（最可靠）

```javascript
// 在浏览器中执行
const buttons = Array.from(document.querySelectorAll('button, a, div[role="button"]'));
for (const btn of buttons) {
  const text = btn.textContent || '';
  if (text.includes('发布') || text.includes('提交') || text.includes('确定')) {
    btn.click();
    return true;
  }
}
```

**策略2**：通过选择器查找

```typescript
const buttonSelectors = [
  'button:contains("发布")',
  'button[class*="publish"]',
  'button[class*="submit"]',
  'button[type="submit"]',
  '.publish-btn',
  '.submit-btn'
];
```

## 完整流程

```
1. 登录成功 ✅
2. 导航到发布页面 ✅
3. 等待3秒页面加载 ✅

4. 查找标题输入框
   - 尝试8种选择器
   - 后备：使用第一个文本输入框
   - 输入标题 ✅

5. 查找内容编辑器
   - 尝试7种选择器
   - 后备：使用最后一个可编辑元素
   - 输入内容（前1000字符）✅

6. 查找发布按钮
   - 方法1：通过文本"发布"查找
   - 方法2：通过class/type查找
   - 点击发布 ✅

7. 等待10秒观察结果 ✅
8. 等待30秒后关闭浏览器 ✅
```

## 内容处理

### HTML转纯文本

```typescript
const plainContent = article.content
  .replace(/<br\s*\/?>/gi, '\n')      // <br> 转换为换行
  .replace(/<\/p>/gi, '\n')           // </p> 转换为换行
  .replace(/<[^>]*>/g, '')            // 移除所有HTML标签
  .trim();                            // 去除首尾空格
```

### 图片处理

**当前版本**：暂时只处理文本，图片需要手动上传

**未来版本**：
1. 提取文章中的图片URL
2. 下载图片到本地
3. 通过Puppeteer上传图片
4. 插入到内容中

## 立即测试

### 1. 服务器已自动重载

代码已更新。

### 2. 创建测试任务

访问: http://localhost:5173/publishing-tasks

选择一篇有标题和内容的文章，创建发布任务。

### 3. 执行并观察（40秒窗口）

点击"执行"按钮，观察浏览器：

**0-5秒**: 登录
**5-10秒**: 导航到发布页面
**10-15秒**: 查找并输入标题
**15-25秒**: 查找并输入内容
**25-30秒**: 查找并点击发布按钮
**30-40秒**: 观察结果
**40秒后**: 浏览器关闭

### 4. 查看服务器日志

应该看到：

```
[头条号] 开始发布文章
[头条号] 当前URL: https://mp.toutiao.com/profile_v4/graphic/publish
[头条号] 第1步：查找标题输入框
[头条号] ✅ 找到标题输入框: input[placeholder*="标题"]
[头条号] 输入标题: xxx
[头条号] ✅ 标题输入完成
[头条号] 第2步：查找内容编辑器
[头条号] ✅ 找到内容编辑器: .ql-editor
[头条号] 输入文章内容
[头条号] 内容长度: 1234 字符
[头条号] ✅ 内容输入完成
[头条号] 第3步：查找发布按钮
[头条号] ✅ 已点击发布按钮
[头条号] 等待10秒观察结果...
✅ 头条号文章发布流程完成
```

## 如果还有问题

### 问题1: 找不到标题输入框

**调试**：在30秒内
1. 打开浏览器开发者工具（F12）
2. 在Console中运行：
```javascript
document.querySelectorAll('input[type="text"]')
```
3. 查看有哪些输入框
4. 告诉我选择器

### 问题2: 找不到内容编辑器

**调试**：
```javascript
document.querySelectorAll('[contenteditable="true"]')
```

### 问题3: 找不到发布按钮

**调试**：
```javascript
Array.from(document.querySelectorAll('button')).map(b => b.textContent)
```

### 问题4: 内容没有输入

**可能原因**：
- 编辑器需要特殊处理
- 需要先点击某个按钮激活编辑器

**解决**：告诉我具体情况，我会调整

## 图片上传（未来功能）

当前版本暂不支持图片自动上传，需要：

1. 手动上传图片
2. 或者在30秒窗口期内手动操作

**未来实现**：
```typescript
// 提取图片
const images = article.content.match(/<img[^>]+src="([^">]+)"/g);

// 下载图片
for (const imgUrl of images) {
  const imgPath = await downloadImage(imgUrl);
  
  // 上传图片
  const fileInput = await page.$('input[type="file"]');
  await fileInput.uploadFile(imgPath);
  
  // 等待上传完成
  await page.waitForSelector('.image-uploaded');
}
```

## 调试技巧

### 1. 截图每一步

```typescript
await page.screenshot({ path: `step-1-title.png` });
await page.screenshot({ path: `step-2-content.png` });
await page.screenshot({ path: `step-3-publish.png` });
```

### 2. 打印页面HTML

```typescript
const html = await page.content();
console.log(html);
```

### 3. 增加等待时间

```typescript
// 在每一步后增加等待
await this.waitForPageLoad(page, 5000);
```

## 快速测试命令

```bash
# 查看最新任务
curl -s http://localhost:3000/api/publishing/tasks | jq '.data.tasks[0]'

# 查看日志
TASK_ID=$(curl -s http://localhost:3000/api/publishing/tasks | jq -r '.data.tasks[0].id')
curl -s http://localhost:3000/api/publishing/tasks/$TASK_ID/logs | jq -r '.data[] | "\(.level): \(.message)"'
```

## 总结

新算法特点：
1. ✅ 智能查找元素（多种策略）
2. ✅ 详细的日志输出
3. ✅ 自动处理HTML内容
4. ✅ 足够的观察时间（40秒）
5. ✅ 容错性强（找不到也不会崩溃）

立即测试，告诉我结果！
