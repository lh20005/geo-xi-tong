# 平台账号隔离问题诊断和修复指南

## 问题描述

lzc2005 用户在 Windows 端登录的抖音账号，在 Web 端的 testuser 用户中也能看到。

## 可能的原因

### 1. Token 共享问题（最可能）
- Windows 端和 Web 端使用了相同的 JWT token
- 两个客户端共享了 localStorage 或 storage
- Token 被手动复制粘贴导致混淆

### 2. 数据库归属错误
- 账号创建时使用了错误的 user_id
- 数据库中的 user_id 字段被错误修改

### 3. 后端代码问题
- 某些 API 没有正确实现多租户隔离
- 中间件没有正确设置或使用 userId

## 诊断步骤

### 步骤 1: 检查 Token

在 Windows 端（lzc2005）：
1. 打开开发者工具（F12）
2. 在 Console 中运行：
```javascript
localStorage.getItem('auth_token')
```
3. 复制输出的 token

在 Web 端（testuser）：
1. 打开开发者工具（F12）
2. 在 Console 中运行：
```javascript
localStorage.getItem('auth_token')
```
3. 复制输出的 token

运行诊断工具：
```bash
node diagnose-account-isolation.js
```

按提示粘贴两个 token，工具会分析它们是否相同。

### 步骤 2: 检查数据库

运行 SQL 查询：
```bash
# 方法 1: 使用 psql
psql -d geo_system -f fix-account-isolation.sql

# 方法 2: 使用 Node.js 脚本
node server/check-user-accounts.js
```

查看输出，确认：
- lzc2005 和 testuser 的用户 ID 是否不同
- 每个平台账号的 user_id 是否正确
- 是否有重复的账号

### 步骤 3: 检查 API 请求

在 Windows 端：
1. 打开开发者工具 Network 标签
2. 刷新页面或执行一个操作
3. 查看请求头中的 Authorization 字段
4. 记录 token 的前 20 个字符

在 Web 端重复相同操作，对比 token 是否相同。

## 修复方案

### 方案 1: Token 共享问题（推荐先尝试）

**在 Windows 端：**
1. 完全退出登录
2. 清除所有缓存：
```javascript
// 在开发者工具 Console 中运行
localStorage.clear();
if (window.electron) {
  await window.electron.storage.clearTokens();
}
```
3. 重新登录 lzc2005 账号

**在 Web 端：**
1. 完全退出登录
2. 清除浏览器缓存和 localStorage
3. 重新登录 testuser 账号

### 方案 2: 数据库归属错误

如果确认是数据库问题，需要手动修复：

1. 首先确认用户 ID：
```sql
SELECT id, username FROM users WHERE username IN ('lzc2005', 'testuser');
```

2. 查看问题账号：
```sql
SELECT id, platform_id, account_name, real_username, user_id 
FROM platform_accounts 
WHERE user_id IN (
  SELECT id FROM users WHERE username IN ('lzc2005', 'testuser')
);
```

3. 修复归属（示例）：
```sql
-- 假设 lzc2005 的 ID 是 1，testuser 的 ID 是 2
-- 将抖音账号移动到 lzc2005 下
UPDATE platform_accounts 
SET user_id = 1
WHERE id = <账号ID> AND platform_id = 'douyin';
```

### 方案 3: 删除重复账号

如果同一个抖音账号被两个用户都保存了：

```sql
-- 删除 testuser 下的重复账号
DELETE FROM platform_accounts 
WHERE id = <账号ID>;
```

## 预防措施

### 1. 确保客户端隔离

**Windows 端：**
- 使用独立的 Electron storage
- 不要手动复制 token

**Web 端：**
- 使用浏览器的 localStorage
- 不同用户使用不同的浏览器 profile 或无痕模式

### 2. 代码层面

已经实现的保护措施：
- ✅ 所有 API 都使用 `authenticate` 中间件
- ✅ 所有 API 都使用 `setTenantContext` 中间件
- ✅ 所有数据库查询都包含 `user_id` 过滤
- ✅ AccountService 的所有方法都需要 `userId` 参数

### 3. 测试验证

创建测试脚本验证隔离：
```bash
# 测试 lzc2005 的账号
curl -H "Authorization: Bearer <lzc2005_token>" \
  http://localhost:3000/api/publishing/accounts

# 测试 testuser 的账号
curl -H "Authorization: Bearer <testuser_token>" \
  http://localhost:3000/api/publishing/accounts
```

两个请求应该返回完全不同的账号列表。

## 快速检查清单

- [ ] 两个用户的 JWT token 是否不同？
- [ ] 数据库中两个用户的 ID 是否不同？
- [ ] 平台账号的 user_id 是否正确？
- [ ] Windows 端和 Web 端是否使用了独立的 storage？
- [ ] 是否有重复的账号记录？

## 需要帮助？

如果以上步骤无法解决问题，请提供：
1. 两个用户的 token（解码后的 payload）
2. 数据库查询结果
3. 浏览器开发者工具的 Network 截图
4. 服务器日志中的相关错误信息
