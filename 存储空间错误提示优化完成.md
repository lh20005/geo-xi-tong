# 存储空间错误提示优化完成

## 问题描述

当用户上传图片或文档时，如果存储空间不足，系统只显示"上传失败"，没有明确提示用户存储空间不足，也没有引导用户升级套餐。

## 解决方案

### 1. 后端修改

修改了三个路由文件，返回更友好的错误消息：

#### `server/src/routes/gallery.ts` - 图片上传
```typescript
return res.status(403).json({ 
  error: '存储空间不足，无法上传图片。请升级套餐以获取更多存储空间。',
  reason: quotaCheck.reason,
  currentUsage: quotaCheck.currentUsageBytes,
  quota: quotaCheck.quotaBytes,
  available: quotaCheck.availableBytes,
  needUpgrade: true
});
```

#### `server/src/routes/knowledgeBase.ts` - 文档上传
```typescript
return res.status(403).json({ 
  error: '存储空间不足，无法上传文档。请升级套餐以获取更多存储空间。',
  reason: quotaCheck.reason,
  currentUsage: quotaCheck.currentUsageBytes,
  quota: quotaCheck.quotaBytes,
  available: quotaCheck.availableBytes,
  needUpgrade: true
});
```

#### `server/src/routes/article.ts` - 文章生成
```typescript
return res.status(403).json({ 
  error: '存储空间不足，无法生成文章。请升级套餐以获取更多存储空间。',
  reason: quotaCheck.reason,
  currentUsage: quotaCheck.currentUsageBytes,
  quota: quotaCheck.quotaBytes,
  available: quotaCheck.availableBytes,
  needUpgrade: true
});
```

### 2. 前端修改（主应用）

#### 修复 API 客户端拦截器 (`client/src/api/client.ts`)

**问题**：原来的拦截器创建了新的 Error 对象，丢失了原始的 `response` 属性。

**修复**：
```typescript
// 保留原始错误对象，但添加友好的消息
const enhancedError = error as any;
enhancedError.message = message;

// 返回原始错误对象（保留 response 属性）
return Promise.reject(enhancedError);
```

#### 更新页面错误处理

**`client/src/pages/AlbumDetailPage.tsx`** 和 **`client/src/pages/KnowledgeBaseDetailPage.tsx`**：

1. 在上传前检查配额，使用 try-catch 捕获 403 错误
2. 显示友好的模态框提示
3. 提供"前往个人中心"按钮，点击后跳转到 `/user-center`

```typescript
try {
  const quotaCheck = await apiClient.post('/storage/check-quota', {
    fileSizeBytes: totalSize,
    resourceType: 'image'
  });
  // ... 检查结果
} catch (quotaError: any) {
  if (quotaError.response?.status === 403) {
    const errorData = quotaError.response.data;
    setLoading(false);
    modal.error({
      title: '存储空间不足',
      content: (
        <div>
          <p>存储空间不足，无法上传图片。</p>
          <p style={{ marginTop: 8, color: '#666', fontSize: 12 }}>
            {errorData.message || '请升级套餐以获取更多存储空间'}
          </p>
        </div>
      ),
      okText: '前往个人中心',
      onOk: () => navigate('/user-center')
    });
    return;
  }
  throw quotaError;
}
```

### 3. Windows 端修改

#### 修复 API 客户端拦截器 (`windows-login-manager/src/api/client.ts`)

与主应用相同的修复，保留原始错误对象。

#### 更新页面错误处理 (`windows-login-manager/src/pages/AlbumDetailPage.tsx`)

添加了与主应用相同的配额检查和错误处理逻辑。

## 用户体验改进

### 修复前
- 错误提示：❌ "上传图片失败"
- 用户不知道为什么失败
- 没有解决方案指引

### 修复后
- 错误提示：✅ 模态框显示
  - 标题："存储空间不足"
  - 内容："存储空间不足，无法上传图片。"
  - 详细信息："当前已使用 XX MB / XX MB，可用 XX MB，本次上传需要 XX MB"
  - 按钮："前往个人中心"（点击跳转到套餐购买页面）

## 测试步骤

1. 使用一个存储空间已满的测试账号
2. 尝试上传图片或文档
3. 应该看到友好的存储空间不足提示
4. 点击"前往个人中心"按钮，应该跳转到个人中心页面

## 影响范围

- ✅ 主应用 - 图片上传
- ✅ 主应用 - 文档上传
- ✅ 主应用 - 文章生成
- ✅ Windows 端 - 图片上传
- ⚠️ Windows 端 - 文档上传（使用 IPC bridge，需要单独处理）

## 注意事项

1. 后端已重新编译（`npm run build`）
2. 前端需要强制刷新浏览器（Ctrl+Shift+R 或 Cmd+Shift+R）
3. Windows 端需要重新构建应用

## 相关文件

### 后端
- `server/src/routes/gallery.ts`
- `server/src/routes/knowledgeBase.ts`
- `server/src/routes/article.ts`

### 主应用前端
- `client/src/api/client.ts`
- `client/src/pages/AlbumDetailPage.tsx`
- `client/src/pages/KnowledgeBaseDetailPage.tsx`

### Windows 端
- `windows-login-manager/src/api/client.ts`
- `windows-login-manager/src/pages/AlbumDetailPage.tsx`
