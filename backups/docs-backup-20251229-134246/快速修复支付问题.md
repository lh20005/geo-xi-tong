# 快速修复支付问题

## 问题诊断

错误信息：`GET http://localhost:3000/api/orders/xxx/status net::ERR_CONNECTION_REFUSED`

**根本原因：后端服务器未运行**

## 立即解决方案

### 步骤1：重启后端服务

```bash
# 在项目根目录执行
cd server
npm run dev
```

### 步骤2：等待服务启动（约5-10秒）

查看终端输出，应该看到：
```
✅ 加密服务初始化成功
✅ Landing 静态文件服务已启用
🚀 服务器运行在 http://localhost:3000
```

### 步骤3：验证服务状态

打开新终端，执行：
```bash
curl http://localhost:3000/api/health
```

应该返回：
```json
{"status":"ok","message":"GEO优化系统运行正常"}
```

### 步骤4：通过 ngrok 访问测试

1. **访问地址**：https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
2. **登录账号**
3. **选择套餐购买**
4. **微信扫码支付**
5. **支付完成后页面自动跳转**

## 为什么会出现这个问题？

1. 我修改了 `server/src/index.ts` 添加了 `fs` 模块导入
2. TypeScript 编译可能出现问题导致服务停止
3. 需要手动重启服务

## 如果重启后还是有问题

### 检查1：端口占用

```bash
lsof -i :3000
```

如果有其他进程占用，先杀掉：
```bash
kill -9 <PID>
```

### 检查2：查看错误日志

在运行 `npm run dev` 的终端中查看错误信息

### 检查3：确认 ngrok 运行

```bash
curl -s http://localhost:4040/api/tunnels | python3 -m json.tool
```

## 完整测试流程

```bash
# 1. 启动后端（在 server 目录）
cd server
npm run dev

# 2. 在另一个终端，验证服务
curl http://localhost:3000/api/health

# 3. 验证 ngrok
curl https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/health

# 4. 在浏览器访问
open https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
```

## 支付流程说明

根据微信官方文档，Native 支付流程：

1. ✅ 用户点击购买 → 前端请求后端创建订单
2. ✅ 后端调用微信 API → 返回 code_url
3. ✅ 前端生成二维码 → 用户扫码支付
4. ⚠️ **支付完成后** → 前端轮询订单状态（这里出错了）
5. ✅ 订单状态变为 paid → 页面跳转

**问题就在第4步**：前端轮询时无法连接后端

## 注意事项

- 后端必须保持运行状态
- ngrok 必须保持运行状态
- 前端通过 ngrok 地址访问时，会自动使用 ngrok 地址访问后端 API
- 微信支付回调地址已配置为 ngrok 地址
