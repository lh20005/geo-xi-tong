# 文章发布状态管理功能 - 使用指南

## 功能概述

本功能实现了完整的文章发布状态管理，包括：

1. **自动状态更新**：文章发布成功后自动标记为"已发布"
2. **发布记录追踪**：记录每篇文章在各个平台的发布情况
3. **智能列表过滤**：发布任务页面自动隐藏已发布文章
4. **多平台支持**：同一文章可发布到多个平台，每次发布都有独立记录

## 安装步骤

### 1. 执行数据库迁移

```bash
cd server
npm run migrate:publishing-records
```

或者手动执行：

```bash
cd server
npx ts-node src/db/migrate-publishing-records.ts
```

### 2. 重启服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
npm run dev
```

### 3. 验证安装

```bash
# 在项目根目录执行测试脚本
chmod +x test-publishing-status-management.sh
./test-publishing-status-management.sh
```

## 使用流程

### 场景1：创建并执行发布任务

1. **访问发布任务页面**
   - URL: `http://localhost:5173/publishing-tasks`
   - 页面只显示未发布的文章（`is_published = false`）

2. **选择文章和平台**
   - 在"选择文章"区域勾选要发布的文章
   - 在"选择发布平台"区域选择目标平台
   - （可选）设置定时发布时间

3. **创建发布任务**
   - 点击"创建发布任务"按钮
   - 系统自动创建任务并开始执行

4. **任务执行**
   - 系统自动打开浏览器执行发布
   - 可以在任务列表中查看执行状态
   - 点击"日志"按钮查看详细执行日志

5. **发布成功后**
   - 文章自动从"选择文章"列表中消失
   - 文章状态变为"已发布"
   - 创建发布记录

### 场景2：查看发布记录

1. **访问发布记录页面**
   - URL: `http://localhost:5173/publishing-records`

2. **查看统计数据**
   - 总发布次数
   - 今日发布数
   - 本周发布数
   - 本月发布数

3. **筛选和查询**
   - 按平台筛选：选择特定平台查看该平台的发布记录
   - 分页浏览：支持每页10/20/50/100条记录

4. **查看详情**
   - 点击"查看"按钮查看文章详情
   - 显示发布平台、账号、时间等信息
   - 可以复制文章内容

### 场景3：文章管理

1. **访问文章管理页面**
   - URL: `http://localhost:5173/articles`

2. **查看发布状态**
   - 已发布文章显示绿色"已发布"标签
   - 显示发布时间
   - 未发布文章显示灰色"草稿"标签

3. **筛选文章**
   - 发布状态筛选：全部/已发布/未发布
   - 关键词筛选
   - 内容搜索

## 数据结构

### publishing_records 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL | 主键 |
| article_id | INTEGER | 文章ID |
| task_id | INTEGER | 任务ID |
| platform_id | VARCHAR(50) | 平台ID |
| account_id | INTEGER | 账号ID |
| account_name | VARCHAR(100) | 账号名称 |
| platform_article_id | VARCHAR(255) | 平台返回的文章ID（可选） |
| platform_url | VARCHAR(500) | 平台文章链接（可选） |
| published_at | TIMESTAMP | 发布时间 |
| created_at | TIMESTAMP | 记录创建时间 |

### articles 表新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| is_published | BOOLEAN | 是否已发布 |
| published_at | TIMESTAMP | 首次发布时间 |

## API 接口

### 发布记录相关

#### 1. 获取发布记录列表
```
GET /api/publishing/records
参数：
  - page: 页码（默认1）
  - pageSize: 每页数量（默认20）
  - platform_id: 平台ID（可选）
  - article_id: 文章ID（可选）
  - account_id: 账号ID（可选）
```

#### 2. 获取发布记录详情
```
GET /api/publishing/records/:id
```

#### 3. 获取文章的所有发布记录
```
GET /api/publishing/articles/:articleId/records
```

#### 4. 获取发布统计数据
```
GET /api/publishing/stats
返回：
  - total: 总发布次数
  - today: 今日发布数
  - week: 本周发布数
  - month: 本月发布数
  - byPlatform: 各平台发布统计
```

### 文章相关

#### 获取文章列表（支持发布状态筛选）
```
GET /api/articles
参数：
  - publishStatus: 发布状态（all/published/unpublished）
  - page: 页码
  - pageSize: 每页数量
  - keyword: 关键词筛选
```

## 工作原理

### 发布流程

```
1. 用户创建发布任务
   ↓
2. PublishingExecutor 执行任务
   ↓
3. 浏览器自动化发布文章
   ↓
4. 发布成功
   ↓
5. 在事务中执行：
   a. 创建 publishing_records 记录
   b. 更新 articles.is_published = true
   c. 更新 articles.published_at = CURRENT_TIMESTAMP
   d. 更新 publishing_tasks.status = 'success'
   ↓
6. 前端自动刷新
   ↓
7. 用户界面更新：
   - 发布任务页面：文章消失
   - 发布记录页面：显示新记录
   - 文章管理页面：状态变为"已发布"
```

### 数据一致性保证

1. **事务处理**：使用数据库事务确保状态更新的原子性
2. **错误回滚**：发布记录创建失败时自动回滚文章状态更新
3. **幂等性**：重复发布不会重复更新 `published_at`（使用 COALESCE）

### 多平台发布处理

- 同一篇文章可以发布到多个平台
- 每次发布都会创建独立的发布记录
- 文章的 `is_published` 状态只在首次发布时设置
- `published_at` 记录首次发布时间，不会被后续发布覆盖

## 常见问题

### Q1: 文章发布成功但状态没有更新？

**解决方案：**
1. 检查数据库迁移是否执行成功
2. 查看服务器日志是否有错误
3. 检查 `publishing_records` 表是否有记录
4. 手动刷新前端页面

### Q2: 发布任务页面还显示已发布的文章？

**解决方案：**
1. 检查文章的 `is_published` 字段值
2. 刷新页面
3. 检查前端筛选条件是否正确

### Q3: 如何重新发布已发布的文章？

**解决方案：**
- 已发布的文章不会出现在发布任务页面的选择列表中
- 如需重新发布，可以：
  1. 在文章管理页面手动将状态改为"草稿"
  2. 或者直接在数据库中修改 `is_published` 字段

### Q4: 发布记录可以删除吗？

**解决方案：**
- 当前版本不支持删除发布记录
- 如需删除，可以直接在数据库中操作
- 删除发布记录不会影响文章的发布状态

## 测试建议

### 功能测试

1. **基础发布流程**
   - 创建文章 → 发布 → 验证状态更新

2. **多平台发布**
   - 同一文章发布到多个平台 → 验证每个平台都有独立记录

3. **列表过滤**
   - 验证发布任务页面只显示未发布文章
   - 验证发布记录页面显示所有发布记录

4. **统计数据**
   - 验证统计数据准确性
   - 验证按平台统计正确

### 性能测试

1. **大量数据**
   - 创建1000+篇文章
   - 测试列表加载速度
   - 测试分页性能

2. **并发发布**
   - 同时创建多个发布任务
   - 验证数据一致性

## 后续优化建议

1. **发布记录增强**
   - 记录平台返回的文章ID和链接
   - 支持查看平台文章

2. **批量操作**
   - 批量重新发布
   - 批量删除发布记录

3. **统计报表**
   - 发布趋势图表
   - 平台发布对比
   - 发布成功率统计

4. **通知功能**
   - 发布成功/失败通知
   - 邮件/消息推送

5. **发布历史**
   - 查看文章的完整发布历史
   - 发布版本对比
