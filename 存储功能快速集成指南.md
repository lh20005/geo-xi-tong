# å­˜å‚¨ç©ºé—´ç®¡ç† - å¿«é€Ÿé›†æˆæŒ‡å—

## ğŸ¯ ç›®æ ‡

å®Œæˆå‰ç«¯å­˜å‚¨å¯è§†åŒ–é›†æˆï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒæŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µã€‚

## â±ï¸ é¢„è®¡æ—¶é—´ï¼š30-45 åˆ†é’Ÿ

---

## æ­¥éª¤ 1ï¼šæ›´æ–°ç”¨æˆ·ä¸­å¿ƒé¡µé¢ï¼ˆ15åˆ†é’Ÿï¼‰

### æ–‡ä»¶ï¼š`client/src/pages/UserCenterPage.tsx`

#### 1.1 å·²å®Œæˆçš„å¯¼å…¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
```typescript
import { StorageUsageCard } from '../components/Storage/StorageUsageCard';
import { StorageBreakdownChart } from '../components/Storage/StorageBreakdownChart';
import { getStorageUsage, getStorageBreakdown, StorageUsage as StorageUsageType, StorageBreakdown as StorageBreakdownType } from '../api/storage';
```

#### 1.2 æ·»åŠ çŠ¶æ€ï¼ˆåœ¨ç°æœ‰çŠ¶æ€åæ·»åŠ ï¼‰
æ‰¾åˆ°è¿™ä¸€è¡Œï¼š
```typescript
const [invitationCodeCopied, setInvitationCodeCopied] = useState(false);
```

åœ¨å…¶åæ·»åŠ ï¼š
```typescript
// å­˜å‚¨ç›¸å…³çŠ¶æ€
const [storageUsage, setStorageUsage] = useState<StorageUsageType | null>(null);
const [storageBreakdown, setStorageBreakdown] = useState<StorageBreakdownType | null>(null);
const [storageLoading, setStorageLoading] = useState(false);
```

#### 1.3 æ·»åŠ åŠ è½½å‡½æ•°ï¼ˆåœ¨å…¶ä»– fetch å‡½æ•°åæ·»åŠ ï¼‰
æ‰¾åˆ° `fetchInvitationStats` å‡½æ•°ï¼Œåœ¨å…¶åæ·»åŠ ï¼š
```typescript
const fetchStorageData = async () => {
  setStorageLoading(true);
  try {
    const [usage, breakdown] = await Promise.all([
      getStorageUsage(),
      getStorageBreakdown()
    ]);
    setStorageUsage(usage);
    setStorageBreakdown(breakdown);
  } catch (error) {
    console.error('[UserCenter] åŠ è½½å­˜å‚¨æ•°æ®å¤±è´¥:', error);
    message.error('åŠ è½½å­˜å‚¨æ•°æ®å¤±è´¥');
  } finally {
    setStorageLoading(false);
  }
};
```

#### 1.4 åœ¨ useEffect ä¸­è°ƒç”¨ï¼ˆä¿®æ”¹ç°æœ‰çš„ loadAllDataï¼‰
æ‰¾åˆ°è¿™æ®µä»£ç ï¼š
```typescript
await Promise.all([
  fetchSubscription(),
  fetchUsageStats(),
  fetchOrders(),
  fetchPlans(),
  fetchUserProfile(),
  fetchInvitationStats()
]);
```

ä¿®æ”¹ä¸ºï¼š
```typescript
await Promise.all([
  fetchSubscription(),
  fetchUsageStats(),
  fetchOrders(),
  fetchPlans(),
  fetchUserProfile(),
  fetchInvitationStats(),
  fetchStorageData()  // æ·»åŠ è¿™ä¸€è¡Œ
]);
```

#### 1.5 æ·»åŠ å­˜å‚¨æ ‡ç­¾é¡µï¼ˆåœ¨æœ€åä¸€ä¸ª TabPane åæ·»åŠ ï¼‰
æ‰¾åˆ° `key="invitation"` çš„ TabPaneï¼Œåœ¨å…¶é—­åˆæ ‡ç­¾ `</TabPane>` åæ·»åŠ ï¼š

```typescript
{/* å­˜å‚¨ç©ºé—´æ ‡ç­¾é¡µ */}
<TabPane
  tab={
    <span>
      <DatabaseOutlined />
      å­˜å‚¨ç©ºé—´
    </span>
  }
  key="storage"
>
  {storageLoading ? (
    <Card loading={true} />
  ) : storageUsage && storageBreakdown ? (
    <Row gutter={[16, 16]}>
      <Col span={24}>
        <StorageUsageCard 
          usage={storageUsage} 
          onUpgrade={() => {
            setActiveTab('subscription');
            setUpgradeModalVisible(true);
          }}
        />
      </Col>
      <Col span={24}>
        <StorageBreakdownChart breakdown={storageBreakdown} />
      </Col>
    </Row>
  ) : (
    <Card>
      <div className="text-center text-gray-400 py-8">
        æ— æ³•åŠ è½½å­˜å‚¨æ•°æ®
      </div>
    </Card>
  )}
</TabPane>
```

---

## æ­¥éª¤ 2ï¼šæ·»åŠ  WebSocket å®æ—¶æ›´æ–°ï¼ˆ10åˆ†é’Ÿï¼‰

### åœ¨ UserCenterPage.tsx ä¸­æ·»åŠ 

æ‰¾åˆ°ç°æœ‰çš„ WebSocket ç›¸å…³ä»£ç ï¼ˆé€šå¸¸åœ¨ useEffect ä¸­ï¼‰ï¼Œæ·»åŠ å­˜å‚¨äº‹ä»¶ç›‘å¬ï¼š

```typescript
useEffect(() => {
  const ws = getUserWebSocketService();
  
  // å­˜å‚¨æ›´æ–°äº‹ä»¶
  const handleStorageUpdate = (data: any) => {
    console.log('[UserCenter] å­˜å‚¨æ›´æ–°:', data);
    if (data.usage) {
      setStorageUsage(data.usage);
    }
    if (data.breakdown) {
      setStorageBreakdown(data.breakdown);
    }
  };
  
  // å­˜å‚¨è­¦æŠ¥äº‹ä»¶
  const handleStorageAlert = (data: any) => {
    console.log('[UserCenter] å­˜å‚¨è­¦æŠ¥:', data);
    if (data.message) {
      if (data.alert.alertType === 'depleted') {
        message.error(data.message, 10);
      } else if (data.alert.alertType === 'critical') {
        message.warning(data.message, 8);
      } else {
        message.info(data.message, 5);
      }
    }
  };
  
  // é…é¢å˜æ›´äº‹ä»¶
  const handleQuotaChange = (data: any) => {
    console.log('[UserCenter] é…é¢å˜æ›´:', data);
    message.success('å­˜å‚¨é…é¢å·²æ›´æ–°');
    fetchStorageData(); // é‡æ–°åŠ è½½
  };
  
  ws.on('storage_updated', handleStorageUpdate);
  ws.on('storage_alert', handleStorageAlert);
  ws.on('storage_quota_changed', handleQuotaChange);
  
  return () => {
    ws.off('storage_updated', handleStorageUpdate);
    ws.off('storage_alert', handleStorageAlert);
    ws.off('storage_quota_changed', handleQuotaChange);
  };
}, []);
```

---

## æ­¥éª¤ 3ï¼šæµ‹è¯•åŠŸèƒ½ï¼ˆ10åˆ†é’Ÿï¼‰

### 3.1 å¯åŠ¨æœåŠ¡
```bash
# ç»ˆç«¯ 1 - åç«¯
cd server
npm run dev

# ç»ˆç«¯ 2 - å‰ç«¯
cd client
npm run dev
```

### 3.2 æµ‹è¯•æ­¥éª¤

1. **æŸ¥çœ‹å­˜å‚¨æ ‡ç­¾é¡µ**
   - ç™»å½•ç³»ç»Ÿ
   - è¿›å…¥ä¸ªäººä¸­å¿ƒ
   - ç‚¹å‡»"å­˜å‚¨ç©ºé—´"æ ‡ç­¾
   - åº”è¯¥çœ‹åˆ°å­˜å‚¨ä½¿ç”¨å¡ç‰‡å’Œé¥¼å›¾

2. **æµ‹è¯•ä¸Šä¼ **
   - ä¸Šä¼ ä¸€å¼ å›¾ç‰‡
   - è§‚å¯Ÿå­˜å‚¨ä½¿ç”¨æ˜¯å¦å®æ—¶æ›´æ–°
   - æ£€æŸ¥è¿›åº¦æ¡æ˜¯å¦å˜åŒ–

3. **æµ‹è¯•åˆ é™¤**
   - åˆ é™¤ä¸€å¼ å›¾ç‰‡
   - è§‚å¯Ÿå­˜å‚¨ä½¿ç”¨æ˜¯å¦å‡å°‘

4. **æµ‹è¯•é…é¢é™åˆ¶**
   - å¦‚æœæ˜¯æµ‹è¯•è´¦å·ï¼Œå¯ä»¥å°è¯•ä¸Šä¼ è¶…è¿‡é…é¢çš„æ–‡ä»¶
   - åº”è¯¥çœ‹åˆ°é”™è¯¯æç¤º

5. **æµ‹è¯•è­¦æŠ¥**
   - å½“å­˜å‚¨ä½¿ç”¨è¶…è¿‡ 80% æ—¶ï¼Œåº”è¯¥çœ‹åˆ°è­¦å‘Šæç¤º
   - å½“è¶…è¿‡ 95% æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ä¸¥é‡è­¦å‘Š

---

## æ­¥éª¤ 4ï¼šå¯é€‰ - ä¸Šä¼ ç»„ä»¶é…é¢æ£€æŸ¥ï¼ˆ15åˆ†é’Ÿï¼‰

### 4.1 å›¾ç‰‡ä¸Šä¼ ç»„ä»¶

æ‰¾åˆ°å›¾ç‰‡ä¸Šä¼ çš„åœ°æ–¹ï¼ˆé€šå¸¸åœ¨ Gallery ç›¸å…³é¡µé¢ï¼‰ï¼Œæ·»åŠ ï¼š

```typescript
import { checkQuota } from '../api/storage';

// åœ¨ä¸Šä¼ å‰æ£€æŸ¥
const beforeUpload = async (file: File) => {
  try {
    const result = await checkQuota(file.size, 'image');
    if (!result.allowed) {
      message.error(result.reason || 'å­˜å‚¨ç©ºé—´ä¸è¶³');
      return false;
    }
    return true;
  } catch (error) {
    console.error('æ£€æŸ¥é…é¢å¤±è´¥:', error);
    return true; // å¤±è´¥æ—¶å…è®¸ä¸Šä¼ ï¼Œç”±åç«¯å†æ¬¡æ£€æŸ¥
  }
};

// åœ¨ Upload ç»„ä»¶ä¸­ä½¿ç”¨
<Upload beforeUpload={beforeUpload} ...>
```

### 4.2 æ–‡æ¡£ä¸Šä¼ ç»„ä»¶

ç±»ä¼¼åœ°ï¼Œåœ¨çŸ¥è¯†åº“æ–‡æ¡£ä¸Šä¼ å¤„æ·»åŠ ï¼š

```typescript
const beforeUpload = async (file: File) => {
  try {
    const result = await checkQuota(file.size, 'document');
    if (!result.allowed) {
      message.error(result.reason || 'å­˜å‚¨ç©ºé—´ä¸è¶³');
      return false;
    }
    return true;
  } catch (error) {
    console.error('æ£€æŸ¥é…é¢å¤±è´¥:', error);
    return true;
  }
};
```

---

## ğŸ‰ å®Œæˆï¼

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œå­˜å‚¨ç©ºé—´ç®¡ç†åŠŸèƒ½å°±å®Œå…¨é›†æˆäº†ï¼

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: çœ‹ä¸åˆ°å­˜å‚¨æ ‡ç­¾é¡µ
**A:** æ£€æŸ¥å¯¼å…¥æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿ `DatabaseOutlined` å·²å¯¼å…¥ã€‚

### Q2: æ•°æ®ä¸æ˜¾ç¤º
**A:** 
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. æ£€æŸ¥ Network æ ‡ç­¾ï¼ŒAPI è¯·æ±‚æ˜¯å¦æˆåŠŸ
3. ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
4. ç¡®è®¤æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ

### Q3: WebSocket ä¸å·¥ä½œ
**A:**
1. æ£€æŸ¥ WebSocket è¿æ¥æ˜¯å¦å»ºç«‹
2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„ WebSocket æ¶ˆæ¯
3. ç¡®è®¤åç«¯ WebSocket æœåŠ¡æ­£å¸¸

### Q4: ä¸Šä¼ åå­˜å‚¨ä¸æ›´æ–°
**A:**
1. æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ `recordStorageUsage` è¢«è°ƒç”¨
2. æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
3. å°è¯•åˆ·æ–°é¡µé¢

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **åç«¯æœåŠ¡**ï¼š`server/src/services/StorageService.ts`
- **API è·¯ç”±**ï¼š`server/src/routes/storage.ts`
- **å‰ç«¯ API**ï¼š`client/src/api/storage.ts`
- **å­˜å‚¨å¡ç‰‡**ï¼š`client/src/components/Storage/StorageUsageCard.tsx`
- **å­˜å‚¨å›¾è¡¨**ï¼š`client/src/components/Storage/StorageBreakdownChart.tsx`
- **ç”¨æˆ·ä¸­å¿ƒ**ï¼š`client/src/pages/UserCenterPage.tsx`

---

## ğŸ”— ä¸‹ä¸€æ­¥

å®Œæˆé›†æˆåï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. æ·»åŠ å­˜å‚¨å†å²è¶‹åŠ¿å›¾
2. å®ç° CSV å¯¼å‡ºåŠŸèƒ½
3. æ·»åŠ å­˜å‚¨æ¸…ç†å»ºè®®
4. å®ç°è´­ä¹°é¢å¤–å­˜å‚¨åŠŸèƒ½

---

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-04  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š30-45 åˆ†é’Ÿ  
**éš¾åº¦**ï¼šâ­â­â˜†â˜†â˜†ï¼ˆç®€å•ï¼‰
