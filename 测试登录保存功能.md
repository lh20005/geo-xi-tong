# 测试登录保存功能

## 🔍 问题诊断

你登录头条号成功，但表格中没有显示。让我们一步步诊断。

## 📋 测试步骤

### 步骤1：重启后端服务（重要！）

```bash
cd server

# 按 Ctrl+C 停止当前服务

# 重新启动（会加载新的日志代码）
npm run dev
```

**确认看到**：
```
✅ 加密服务初始化成功
🚀 服务器运行在 http://localhost:3000
```

### 步骤2：准备监控

1. **后端终端**：保持可见，准备查看日志
2. **浏览器**：打开开发者工具（F12）-> Console标签

### 步骤3：再次测试登录

1. 刷新浏览器页面
2. 点击【头条号】卡片
3. 在Chrome中登录
4. **仔细观察后端终端的日志**

### 步骤4：查看后端日志

登录成功后，后端应该显示：

```
[浏览器登录] 启动浏览器，准备打开 头条号 登录页面...
[浏览器登录] 找到Chrome: /Applications/Google Chrome.app/Contents/MacOS/Google Chrome
[浏览器登录] 正在打开登录页面: https://mp.toutiao.com/auth/page/login/
[浏览器登录] 已打开 头条号 登录页面，等待用户登录...
[等待登录] 使用 toutiao 特定的等待条件
[等待登录] 检测到URL变化，当前URL: https://mp.toutiao.com/profile/...
[浏览器登录] 检测到登录成功，正在获取Cookie...
[浏览器登录] 成功获取 15 个Cookie  ← 应该大于0
[提取用户信息] toutiao: xxx
[浏览器登录] 正在保存账号信息: toutiao_1734345678
[浏览器登录] Cookie数量: 15
[浏览器登录] 凭证数据: {...}
[浏览器登录] 平台 toutiao 现有账号数: 0
[浏览器登录] 创建新账号，平台: toutiao, 账号名: toutiao_1734345678
[浏览器登录] 账号创建成功 ID: 1  ← 关键！应该看到这行
[浏览器登录] 账号保存成功 ID: 1, 平台: toutiao, 名称: toutiao_1734345678
```

**关键点**：
- Cookie数量应该 > 0
- 应该看到"账号创建成功"
- 应该看到"账号保存成功"

### 步骤5：查看浏览器控制台

应该显示：

```
[前端] 点击平台卡片: 头条号 toutiao
[前端] 调用 loginWithBrowser API...
[前端] API返回结果: {success: true, message: "登录成功", account: {...}}
```

**关键点**：
- `success` 应该是 `true`
- `account` 应该有数据

### 步骤6：检查数据库

```bash
psql -d geo_system -c "SELECT id, platform_id, account_name, status, created_at FROM platform_accounts ORDER BY created_at DESC LIMIT 5;"
```

应该能看到新增的记录。

### 步骤7：刷新页面

如果数据库中有记录，但页面没显示，手动刷新浏览器（Cmd+R）。

## 🐛 可能的问题

### 问题1：Cookie数量为0

**日志显示**：
```
[浏览器登录] 成功获取 0 个Cookie
```

**原因**：登录检测太早，Cookie还没设置

**解决方案**：
修改 `server/src/services/AccountService.ts` 中头条号的等待条件，增加等待时间：

```typescript
'toutiao': async () => {
  await page.waitForFunction(
    `window.location.href.includes('content') || window.location.href.includes('profile')`,
    { timeout: 300000 }
  );
  // 额外等待5秒确保Cookie设置
  await new Promise(resolve => setTimeout(resolve, 5000));
}
```

### 问题2：没有看到"账号创建成功"

**原因**：保存到数据库时出错

**检查**：
查看后端日志中是否有错误信息，特别是：
```
[浏览器登录] 保存账号失败: ...
```

### 问题3：前端返回success: false

**检查**：
查看浏览器控制台中的错误信息。

### 问题4：数据库中有记录，但页面不显示

**原因**：前端没有刷新

**解决方案**：
1. 手动刷新页面
2. 或检查 `loadData()` 是否被正确调用

## 📊 完整诊断清单

请按顺序检查：

- [ ] 后端服务已重启（加载新日志代码）
- [ ] 点击卡片后Chrome打开
- [ ] 在Chrome中成功登录
- [ ] Chrome自动关闭
- [ ] 后端日志显示"成功获取 X 个Cookie"（X > 0）
- [ ] 后端日志显示"账号创建成功"
- [ ] 后端日志显示"账号保存成功"
- [ ] 浏览器控制台显示 `success: true`
- [ ] 数据库中有新记录
- [ ] 页面表格显示新账号

## 🔧 如果仍然失败

请提供以下信息：

1. **后端完整日志**（从点击卡片到登录完成）
2. **浏览器控制台输出**
3. **数据库查询结果**
4. **是否看到任何错误信息**

## 💡 临时解决方案

如果头条号一直有问题，可以先测试其他平台：

1. **知乎**（最简单）
2. **简书**
3. **CSDN**

这些平台的登录流程更简单，更容易成功。
