# 占位符功能实现总结

## 功能概述

实现了**占位符变量系统**，允许用户在文章设置的提示词中使用占位符，完全自定义文章生成逻辑，无需修改程序代码。

## 核心优势

### ✅ 完全自定义
- 用户可以完全控制如何使用关键词、话题、公司名称、知识库
- 不再受限于程序预设的逻辑

### ✅ 无需改代码
- 调整文章生成策略只需修改文章设置
- 不需要修改服务器代码
- 不需要重启服务

### ✅ 灵活组合
- 5个占位符可以任意组合
- 可以多次使用同一个占位符
- 可以选择性使用某些占位符

### ✅ 向后兼容
- 不使用占位符的文章设置仍然正常工作
- 系统自动检测是否使用了占位符
- 平滑过渡，不影响现有功能

## 支持的占位符

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `{keyword}` | 核心关键词 | 英国留学 |
| `{topics}` | 话题列表（带编号，多行） | 1. 靠谱的英国留学机构哪家好<br>2. 专业的英国留学服务商哪家专业 |
| `{topicsList}` | 话题列表（纯文本，逗号分隔） | 靠谱的英国留学机构哪家好、专业的英国留学服务商哪家专业 |
| `{companyName}` | 转化目标公司名称 | 优学留学咨询 |
| `{knowledgeBase}` | 知识库内容 | [企业知识库的完整内容] |

## 实现原理

### 1. 占位符检测

```typescript
// 检查用户提示词是否包含占位符
const hasPlaceholders = /\{(keyword|topics|topicsList|companyName|knowledgeBase)\}/.test(basePrompt);
```

### 2. 占位符替换

```typescript
private replacePromptVariables(
  prompt: string,
  keyword: string,
  topics: string[],
  knowledgeContent: string,
  companyName?: string
): string {
  // 格式化话题列表
  const topicsFormatted = topics.map((t, i) => `${i + 1}. ${t}`).join('\n');
  const topicsListText = topics.join('、');
  
  // 替换所有占位符
  return prompt
    .replace(/\{keyword\}/g, keyword)
    .replace(/\{topics\}/g, topicsFormatted)
    .replace(/\{topicsList\}/g, topicsListText)
    .replace(/\{companyName\}/g, companyName || '')
    .replace(/\{knowledgeBase\}/g, knowledgeContent || '');
}
```

### 3. 智能选择逻辑

```typescript
if (hasPlaceholders) {
  // 用户使用了占位符，直接替换
  return this.replacePromptVariables(basePrompt, keyword, topics, knowledgeContent, companyName);
} else {
  // 向后兼容：使用旧的拼接逻辑
  return this.buildLegacyPrompt(...);
}
```

## 使用示例

### 示例1：简洁模板

```
关键词：{keyword}
问题：{topics}
公司：{companyName}

请写一篇1500字的专业文章，适度提及公司名称1-2次。

格式：
标题：[标题]
[正文]
```

### 示例2：详细模板

```
你是一个专业的{keyword}领域专家。

【用户关心的问题】
{topics}

【写作要求】
1. 围绕关键词"{keyword}"展开
2. 回答用户问题
3. 适度提及{companyName}（1-2次）
4. 参考知识库内容：
{knowledgeBase}
5. 字数1500-2500字

【输出格式】
标题：[文章标题]

[文章正文内容]
```

## 解决的问题

### 问题1：转化目标出现频率过高

**之前**：程序硬编码要求AI融入公司名称，导致每段都出现

**现在**：用户可以自己控制：
```
适度提及{companyName}，只在1-2个自然位置出现，不要每段都提及
```

### 问题2：无法灵活调整生成策略

**之前**：调整文章生成逻辑需要修改代码

**现在**：只需修改文章设置中的提示词

### 问题3：不同场景需要不同策略

**之前**：所有文章使用相同的生成逻辑

**现在**：可以创建多个文章设置，每个使用不同的策略：
- 文章设置A：重营销（多次提及公司）
- 文章设置B：重专业（不提及公司）
- 文章设置C：平衡型（适度提及）

## 修改的文件

### 1. server/src/services/articleGenerationService.ts

**新增方法**：
- `replacePromptVariables()` - 替换占位符
- 修改 `buildPromptWithImageInstruction()` - 支持占位符检测和替换

**关键代码**：
```typescript
// 检测占位符
const hasPlaceholders = /\{(keyword|topics|topicsList|companyName|knowledgeBase)\}/.test(basePrompt);

if (hasPlaceholders) {
  // 使用占位符逻辑
  return this.replacePromptVariables(...);
} else {
  // 使用旧逻辑（向后兼容）
  return this.buildLegacyPrompt(...);
}
```

### 2. 文档文件

**新建**：
- `文章设置占位符使用指南.md` - 详细使用指南
- `占位符快速示例.md` - 快速上手示例
- `占位符功能实现总结.md` - 本文档

**更新**：
- `文章生成模块逻辑说明.md` - 添加占位符说明

## 测试建议

### 1. 创建测试文章设置

```
【测试模板】

关键词：{keyword}
话题：{topics}
公司：{companyName}

请生成一篇测试文章。
```

### 2. 创建生成任务

- 选择一个蒸馏结果
- 选择图库、知识库
- 选择转化目标
- 选择刚创建的测试文章设置
- 生成1篇文章

### 3. 检查结果

查看生成的文章：
- ✅ 占位符是否被正确替换
- ✅ 关键词是否出现
- ✅ 话题是否被回答
- ✅ 公司名称是否适度出现
- ✅ 知识库内容是否被引用

### 4. 优化提示词

根据生成效果，调整文章设置中的提示词。

## 最佳实践

### 1. 明确指令

```
你是一个专业的{keyword}领域专家。

请根据以下问题撰写文章：
{topics}

要求：
- 围绕"{keyword}"展开
- 适度提及{companyName}（1-2次）
- 字数1500-2500字
```

### 2. 控制频率

```
在文章中适度提及{companyName}，只在1-2个自然位置出现，不要每段都提及
```

### 3. 指定格式

```
严格按照以下格式输出：

标题：[文章标题]

[文章正文内容]
```

## 未来扩展

### 可能的新占位符

- `{industry}` - 行业信息
- `{targetAudience}` - 目标受众
- `{coreProducts}` - 核心产品
- `{contactInfo}` - 联系方式
- `{articleCount}` - 文章数量
- `{currentDate}` - 当前日期

### 可能的新功能

- 条件占位符：`{if companyName}...{endif}`
- 循环占位符：`{foreach topics}...{endforeach}`
- 自定义变量：用户可以定义自己的变量

## 总结

通过实现占位符变量系统，我们：

1. ✅ **提高了灵活性**：用户可以完全自定义文章生成逻辑
2. ✅ **降低了维护成本**：不需要修改代码就能调整策略
3. ✅ **保持了兼容性**：不影响现有功能
4. ✅ **解决了实际问题**：转化目标频率可控、生成策略可调

这是一个重要的功能升级，让系统更加灵活和易用！
