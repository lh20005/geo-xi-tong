# 配额同步修复完成

## 问题描述

在用户管理模块中修改用户配额后，个人中心的配额显示没有变化。

## 问题根因

`SubscriptionService.getUserUsageStats()` 方法只从 `plan_features` 表获取默认配额值，完全忽略了 `user_subscriptions.custom_quotas` 字段中存储的自定义配额。

### 问题代码

```typescript
// 旧代码 - 只使用默认配额
for (const feature of plan.features) {
  let used: number;
  let limit = feature.feature_value; // ❌ 只使用默认值
  // ...
}
```

### 数据流分析

1. **用户管理调整配额** → 更新 `user_subscriptions.custom_quotas` ✅
2. **个人中心获取配额** → 调用 `GET /api/subscription/usage-stats` ✅
3. **后端返回配额** → `getUserUsageStats()` 只读取默认值 ❌
4. **前端显示配额** → 显示错误的默认值 ❌

## 修复方案

### 1. 修改 `SubscriptionService.getUserUsageStats()`

在获取配额限制时，优先使用自定义配额，如果没有则使用默认配额。

```typescript
// 新代码 - 优先使用自定义配额
async getUserUsageStats(userId: number): Promise<UsageStats[]> {
  const subscription = await this.getUserActiveSubscription(userId);
  if (!subscription || !subscription.plan) {
    return [];
  }

  const plan = await this.getPlanConfig(subscription.plan.plan_code);
  if (!plan) {
    return [];
  }

  // 获取用户的自定义配额（如果有）
  const customQuotasResult = await pool.query(
    'SELECT custom_quotas FROM user_subscriptions WHERE id = $1',
    [subscription.id]
  );
  const customQuotas = customQuotasResult.rows[0]?.custom_quotas || {};

  const stats: UsageStats[] = [];

  for (const feature of plan.features) {
    let used: number;
    // ✅ 优先使用自定义配额，如果没有则使用套餐默认配额
    let limit = customQuotas[feature.feature_code] !== undefined 
      ? customQuotas[feature.feature_code] 
      : feature.feature_value;
    
    // ... 其余逻辑保持不变
  }

  return stats;
}
```

## 修复验证

### 测试场景

用户 `lzc2005` 的配额调整：
- 套餐：专业版
- 默认配额：每月生成文章数 = 1 篇
- 自定义配额：每月生成文章数 = 3 篇

### 测试结果

```
✅ 找到测试用户: lzc2005 (ID: 1)
   套餐: 专业版
   自定义配额: {"articles_per_month": 3}

每月生成文章数 (articles_per_month):
  配额限制: 3 篇          ✅ 正确显示自定义配额
  已使用: 2 篇
  剩余: 1 篇
  使用率: 66.67%
  ✅ 使用自定义配额: 3
  ✅ 配额显示正确！

✅ 所有自定义配额都正确显示！
✅ 修复成功：用户管理中的配额调整已正确反映到个人中心
```

## 影响范围

### 修复的功能

1. **个人中心 - 使用统计** ✅
   - 路径：`/user-center` → 订阅管理标签
   - API：`GET /api/subscription/usage-stats`
   - 组件：`client/src/pages/UserCenterPage.tsx`
   - 组件：`windows-login-manager/src/pages/UserCenterPage.tsx`

2. **WebSocket 实时更新** ✅
   - 事件：`quota_updated`
   - 自动刷新个人中心的配额显示

### 相关模块

1. **用户管理 - 配额调整** ✅
   - 路径：`/user-management` → 订阅详情抽屉 → 调整配额
   - API：`POST /api/admin/user-subscriptions/:userId/adjust-quota`
   - 服务：`UserSubscriptionManagementService.adjustQuota()`

2. **配额检查系统** ✅
   - 所有功能的配额检查仍然正常工作
   - 数据库函数 `check_user_quota()` 已正确考虑 `custom_quotas`

## 配额系统架构

### 数据存储

```sql
-- 套餐默认配额
plan_features (
  plan_id,
  feature_code,
  feature_value  -- 默认配额
)

-- 用户自定义配额
user_subscriptions (
  user_id,
  plan_id,
  custom_quotas  -- JSONB，存储自定义配额 {"feature_code": value}
)

-- 使用量记录
user_usage (
  user_id,
  feature_code,
  usage_count
)
```

### 配额优先级

1. **自定义配额** (最高优先级)
   - 来源：`user_subscriptions.custom_quotas[feature_code]`
   - 场景：管理员手动调整

2. **套餐默认配额** (默认)
   - 来源：`plan_features.feature_value`
   - 场景：用户订阅套餐时的标准配额

### 配额调整流程

```
管理员操作
    ↓
POST /api/admin/user-subscriptions/:userId/adjust-quota
    ↓
UserSubscriptionManagementService.adjustQuota()
    ↓
UPDATE user_subscriptions SET custom_quotas = {...}
    ↓
WebSocket 通知: quota_adjusted
    ↓
前端自动刷新
    ↓
GET /api/subscription/usage-stats
    ↓
SubscriptionService.getUserUsageStats()
    ↓
读取 custom_quotas (优先) 或 feature_value (默认)
    ↓
返回正确的配额限制
```

## 测试清单

- [x] 诊断问题根因
- [x] 修改 `getUserUsageStats()` 方法
- [x] 测试自定义配额显示
- [x] 测试默认配额显示
- [x] 验证 WebSocket 实时更新
- [x] 验证主前端个人中心
- [x] 验证 Windows 应用个人中心
- [x] 验证配额调整历史记录

## 相关文件

### 修改的文件

- `server/src/services/SubscriptionService.ts` - 修复配额获取逻辑

### 新增的文件

- `server/src/scripts/diagnose-quota-sync-issue.ts` - 诊断脚本
- `server/src/scripts/test-quota-sync-fix.ts` - 测试脚本
- `配额同步修复完成.md` - 本文档

### 相关文件（无需修改）

- `server/src/services/UserSubscriptionManagementService.ts` - 配额调整逻辑正确
- `server/src/routes/admin/userSubscriptions.ts` - API 路由正确
- `client/src/pages/UserCenterPage.tsx` - 前端显示逻辑正确
- `windows-login-manager/src/pages/UserCenterPage.tsx` - Windows 应用显示逻辑正确

## 部署说明

### 1. 无需数据库迁移

此修复只涉及代码逻辑，不需要修改数据库结构。

### 2. 重启服务

```bash
# 重启后端服务
npm run server:dev

# 或生产环境
pm2 restart geo-server
```

### 3. 清除缓存（可选）

```bash
# 如果使用了 Redis 缓存套餐配置
redis-cli FLUSHDB
```

### 4. 验证修复

```bash
# 运行测试脚本
cd server
npx ts-node src/scripts/test-quota-sync-fix.ts
```

## 后续建议

### 1. 添加单元测试

```typescript
describe('SubscriptionService.getUserUsageStats', () => {
  it('should use custom quota when available', async () => {
    // 测试自定义配额优先级
  });

  it('should fallback to default quota when custom quota not set', async () => {
    // 测试默认配额回退
  });
});
```

### 2. 添加配额变更日志

在 `subscription_adjustments` 表中已经记录了所有配额调整历史，可以在个人中心添加"配额变更历史"功能。

### 3. 配额预警通知

当配额使用率超过 90% 时，除了在个人中心显示警告，还可以发送邮件或站内通知。

## 总结

✅ **问题已完全解决**

- 用户管理中的配额调整现在能正确反映到个人中心
- 自定义配额优先于默认配额显示
- WebSocket 实时更新正常工作
- 所有相关功能测试通过

**修复时间**: 2026-01-05  
**影响用户**: 所有使用自定义配额的用户  
**风险等级**: 低（只修改显示逻辑，不影响配额检查）
