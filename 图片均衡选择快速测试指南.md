# 图片均衡选择功能 - 快速测试指南

## 功能说明

在生成文章时，系统会从用户选择的相册中**均衡调用**图片，避免同一张图片被反复使用。

## 已完成的工作

✅ 数据库迁移已完成  
✅ images表已添加usage_count字段  
✅ image_usage表已创建  
✅ 相关索引已创建  
✅ ImageSelectionService服务已实现  
✅ ArticleGenerationService已更新  

## 测试步骤

### 1. 验证数据库迁移

```bash
cd server
npm run test-image-selection
```

预期输出：
- ✅ images表已有usage_count字段
- ✅ image_usage表已存在
- 显示相册和图片统计信息

### 2. 启动服务

```bash
# 在项目根目录
npm run dev
```

### 3. 创建测试任务

1. 打开浏览器访问 http://localhost:5173
2. 进入"生成文章"页面
3. 创建一个新任务：
   - 选择一个蒸馏结果
   - 选择一个包含多张图片的相册（如"英国留学"相册，有6张图片）
   - 选择知识库和文章设置
   - 设置生成数量：建议生成6-10篇文章
4. 点击"生成文章"按钮

### 4. 观察图片使用情况

#### 方法1：使用测试脚本

```bash
cd server
npm run test-image-selection
```

查看"图片使用统计"表格，观察：
- 每张图片的 `usage_count` 是否均衡
- 使用次数最少的图片是否被优先选择

#### 方法2：直接查询数据库

```sql
-- 查看图片使用统计
SELECT 
  i.id,
  i.filename,
  i.usage_count,
  (SELECT COUNT(*) FROM image_usage WHERE image_id = i.id) as usage_records
FROM images i
WHERE i.album_id = 3  -- 替换为你的相册ID
ORDER BY i.usage_count ASC;

-- 查看图片使用分布
SELECT 
  a.name as album_name,
  COUNT(i.id) as total_images,
  SUM(COALESCE(i.usage_count, 0)) as total_usage,
  ROUND(AVG(COALESCE(i.usage_count, 0)), 2) as avg_usage,
  MIN(COALESCE(i.usage_count, 0)) as min_usage,
  MAX(COALESCE(i.usage_count, 0)) as max_usage
FROM albums a
LEFT JOIN images i ON a.id = i.album_id
WHERE a.id = 3  -- 替换为你的相册ID
GROUP BY a.id, a.name;
```

### 5. 验证均衡性

#### 预期结果

假设相册有6张图片，生成6篇文章后：

```
图片ID  | 使用次数
--------|----------
12      | 1
13      | 1
14      | 1
15      | 1
16      | 1
17      | 1
```

如果生成12篇文章：

```
图片ID  | 使用次数
--------|----------
12      | 2
13      | 2
14      | 2
15      | 2
16      | 2
17      | 2
```

#### 验证标准

✅ 每张图片的使用次数应该大致相同（差异不超过1）  
✅ 不会出现某张图片使用次数远高于其他图片的情况  
✅ 使用次数最少的图片会被优先选择  

### 6. 查看文章中的图片

1. 进入"文章列表"页面
2. 查看生成的文章
3. 观察每篇文章使用的图片是否不同
4. 验证图片是否均衡分布

## 测试场景

### 场景1：单次生成多篇文章

- 创建任务，生成10篇文章
- 观察图片使用是否均衡

### 场景2：多次生成文章

- 第一次生成5篇文章
- 第二次生成5篇文章
- 观察两次生成是否继续保持均衡

### 场景3：图库为空

- 选择一个空相册
- 验证系统是否使用默认占位图片
- 确认不会报错

## 监控命令

### 实时监控图片使用

```bash
# 每5秒刷新一次图片使用统计
watch -n 5 "cd server && npm run test-image-selection"
```

### 查看最近使用的图片

```sql
SELECT 
  i.filename,
  i.usage_count,
  iu.used_at,
  a.title as article_title
FROM image_usage iu
JOIN images i ON iu.image_id = i.id
JOIN articles a ON iu.article_id = a.id
ORDER BY iu.used_at DESC
LIMIT 10;
```

## 故障排查

### 问题1：图片使用不均衡

检查：
1. 迁移是否成功运行
2. usage_count字段是否存在
3. 索引是否创建

解决：
```bash
cd server
npm run db:migrate:image-usage
```

### 问题2：所有文章使用同一张图片

检查：
1. 是否使用了旧的 `selectRandomImage()` 方法
2. 代码是否正确调用 `selectBalancedImage()`

解决：
- 重启服务
- 检查代码更新是否生效

### 问题3：usage_count没有更新

检查：
1. 事务是否正确提交
2. imageId是否正确传递

解决：
- 查看服务器日志
- 检查 `saveArticleWithTopicTracking()` 方法

## 性能测试

### 测试大量图片

1. 创建一个包含100张图片的相册
2. 生成100篇文章
3. 观察：
   - 查询性能
   - 使用分布均衡性
   - 内存使用情况

### 预期性能

- 图片选择查询：< 10ms
- 使用记录更新：< 5ms
- 不影响文章生成速度

## 总结

通过以上测试，你应该能够验证：

✅ 图片均衡选择功能正常工作  
✅ 每张图片的使用次数大致相同  
✅ 不会出现某张图片被反复使用的情况  
✅ 系统性能良好  

如有问题，请查看服务器日志或联系开发团队。
