# 图片自动上传功能实现 ✅

## 问题描述

文章中的图片在复制到发布平台时变成了链接，而不是实际的图片。

## 解决方案

实现完整的图片处理流程：
1. 从文章HTML中提取图片URL
2. 下载图片到本地临时目录
3. 通过平台的文件上传功能上传图片
4. 清理临时文件

## 实现架构

### 1. ImageUploadService（图片上传服务）

**位置**: `server/src/services/ImageUploadService.ts`

**核心功能**:

```typescript
class ImageUploadService {
  // 从HTML提取图片URL
  extractImageUrls(htmlContent: string): string[]
  
  // 下载图片到本地
  downloadImage(imageUrl: string): Promise<string | null>
  
  // 批量下载
  downloadImages(imageUrls: string[]): Promise<Map<string, string>>
  
  // 上传到平台
  uploadImageToPlatform(page: Page, imagePath: string): Promise<string | null>
  
  // 清理临时文件
  cleanupTempFiles(filePaths: string[]): void
}
```

### 2. 集成到适配器

**修改**: `server/src/services/adapters/ToutiaoAdapter.ts`

**流程**:

```
1. 点击内容编辑器
2. 提取文章中的图片URL
3. 下载所有图片到本地
4. 逐个上传图片：
   - 查找上传按钮
   - 点击上传按钮
   - 选择本地图片文件
   - 等待上传完成
5. 输入纯文本内容（已移除图片标签）
6. 清理临时文件
```

## 详细流程

### 第1步：提取图片URL

```typescript
const imageUrls = imageUploadService.extractImageUrls(article.content);
// 从 <img src="..."> 标签中提取URL
```

**支持的格式**:
- 绝对URL: `https://example.com/image.jpg`
- 相对URL: `/uploads/image.jpg`
- 本地上传: `/uploads/gallery/image.jpg`

### 第2步：下载图片

```typescript
const imageMap = await imageUploadService.downloadImages(imageUrls);
// 返回: Map<原始URL, 本地路径>
```

**下载逻辑**:
- 相对路径自动转换为完整URL
- 支持超时控制（10秒）
- 自动识别图片格式（jpg/png/gif/webp）
- 保存到 `server/temp/images/` 目录

### 第3步：上传到平台

```typescript
// 查找上传按钮
const uploadButtonSelectors = [
  'button[class*="image"]',
  'button[class*="picture"]',
  'button[class*="upload"]',
  '[data-testid="image-upload"]',
  '.image-upload-btn'
];

// 点击上传按钮
await uploadButton.click();

// 选择文件
const fileInput = await page.$('input[type="file"]');
await fileInput.uploadFile(localPath);

// 等待上传完成
await page.waitForTimeout(3000);
```

### 第4步：输入文本内容

```typescript
// 移除图片标签，只保留文本
let plainContent = article.content
  .replace(/<img[^>]*>/gi, '')      // 移除图片
  .replace(/<br\s*\/?>/gi, '\n')    // 换行
  .replace(/<\/p>/gi, '\n\n')       // 段落
  .replace(/<[^>]*>/g, '')          // 其他标签
  .trim();

// 输入文本
await page.keyboard.type(plainContent, { delay: 5 });
```

### 第5步：清理临时文件

```typescript
imageUploadService.cleanupTempFiles(downloadedImages);
```

## 使用示例

### 文章内容示例

```html
<p>这是一篇文章</p>
<img src="/uploads/gallery/image1.jpg" alt="图片1">
<p>这是第二段</p>
<img src="https://example.com/image2.png" alt="图片2">
<p>结束</p>
```

### 处理结果

**提取的图片**:
- `/uploads/gallery/image1.jpg`
- `https://example.com/image2.png`

**下载到**:
- `server/temp/images/1734345678_abc123.jpg`
- `server/temp/images/1734345679_def456.png`

**上传到平台**:
- 图片1 → 平台存储
- 图片2 → 平台存储

**输入的文本**:
```
这是一篇文章

这是第二段

结束
```

## 配置说明

### 临时目录

**位置**: `server/temp/images/`

**自动创建**: 服务启动时自动创建

**清理策略**: 
- 每次上传完成后立即清理
- 可手动调用 `cleanupAllTempFiles()` 清理所有

### 超时设置

```typescript
// 下载超时
timeout: 10000  // 10秒

// 上传等待
await page.waitForTimeout(3000);  // 3秒
```

### 支持的图片格式

- JPG/JPEG
- PNG
- GIF
- WebP

## 测试步骤

### 1. 准备测试文章

创建一篇包含图片的文章：

```sql
UPDATE articles 
SET content = '<p>测试文章</p><img src="/uploads/test.jpg"><p>结束</p>'
WHERE id = 1;
```

### 2. 执行发布任务

1. 访问 http://localhost:5173/publishing-tasks
2. 选择包含图片的文章
3. 创建发布任务
4. 点击"执行"

### 3. 观察过程（40秒）

**0-10秒**: 登录和导航
**10-15秒**: 输入标题
**15-20秒**: 下载图片
**20-30秒**: 上传图片到平台
**30-35秒**: 输入文本内容
**35-40秒**: 点击发布

### 4. 查看日志

```bash
TASK_ID=$(curl -s http://localhost:3000/api/publishing/tasks | jq -r '.data.tasks[0].id')
curl -s http://localhost:3000/api/publishing/tasks/$TASK_ID/logs | jq -r '.data[] | "\(.level): \(.message)"'
```

应该看到：

```
[头条号] 检查文章中的图片...
[图片处理] 提取到 2 张图片
[头条号] 发现 2 张图片，开始下载...
[图片下载] 开始下载: /uploads/test.jpg
[图片下载] ✅ 保存到: /path/to/temp/images/xxx.jpg
[头条号] 上传图片: /uploads/test.jpg
[头条号] 找到上传按钮: button[class*="image"]
[头条号] ✅ 图片已上传
[头条号] 内容长度: 123 字符
[头条号] ✅ 内容输入完成
[清理] 删除临时文件: xxx.jpg
```

## 故障排查

### 问题1: 图片下载失败

**错误**: `[图片下载] ❌ 失败`

**原因**:
- 图片URL无效
- 网络超时
- 文件不存在

**解决**:
1. 检查图片URL是否正确
2. 确保图片文件存在
3. 增加超时时间

### 问题2: 找不到上传按钮

**错误**: `[头条号] ⚠️ 未找到图片上传按钮`

**原因**: 平台的上传按钮选择器不匹配

**解决**:
1. 在浏览器中手动查找上传按钮
2. 查看按钮的class或id
3. 添加到 `uploadButtonSelectors` 数组

### 问题3: 上传后图片未显示

**原因**: 上传等待时间不够

**解决**: 增加等待时间
```typescript
await this.waitForPageLoad(page, 5000); // 改为5秒
```

### 问题4: 临时文件未清理

**手动清理**:
```bash
rm -rf server/temp/images/*
```

**或在代码中**:
```typescript
imageUploadService.cleanupAllTempFiles();
```

## 优化建议

### 1. 并行下载图片

```typescript
const downloadPromises = imageUrls.map(url => 
  imageUploadService.downloadImage(url)
);
const localPaths = await Promise.all(downloadPromises);
```

### 2. 图片压缩

```typescript
import sharp from 'sharp';

await sharp(localPath)
  .resize(1200, 1200, { fit: 'inside' })
  .jpeg({ quality: 80 })
  .toFile(compressedPath);
```

### 3. 缓存已上传图片

```typescript
const uploadedImages = new Map<string, string>();
// URL -> 平台图片ID
```

### 4. 支持更多图片来源

- Base64编码的图片
- 外部CDN图片
- 需要认证的图片

## 平台特定处理

### 头条号

- 上传按钮: `button[class*="image"]`
- 文件输入: `input[type="file"]`
- 等待时间: 3秒

### CSDN

- 上传按钮: `.image-upload-btn`
- 文件输入: `input[accept="image/*"]`
- 等待时间: 5秒

### 掘金

- 上传按钮: `[data-testid="image-upload"]`
- 文件输入: `input[type="file"]`
- 等待时间: 4秒

## 相关文件

- ✅ `server/src/services/ImageUploadService.ts` - 图片上传服务（新增）
- ✅ `server/src/services/adapters/ToutiaoAdapter.ts` - 头条号适配器（已修改）
- ✅ `server/temp/images/` - 临时图片目录（自动创建）

## 总结

图片处理功能已完整实现：

1. ✅ 自动提取图片URL
2. ✅ 自动下载到本地
3. ✅ 自动上传到平台
4. ✅ 自动清理临时文件
5. ✅ 支持多种图片格式
6. ✅ 支持相对和绝对路径
7. ✅ 详细的日志输出
8. ✅ 完善的错误处理

现在文章中的图片会正确上传到发布平台，而不是显示为链接！
