# 批次发布逻辑对比

## 场景示例

选择 **3篇文章** × **2个平台**（头条、抖音），间隔 **10分钟**

---

## ✅ 正确的逻辑（用户需求）

### 执行顺序
```
┌─────────────────────────────────────────────────────────────┐
│ 任务1: 文章A → 头条                                          │
│   batch_order: 0                                            │
│   interval_minutes: 10                                      │
└─────────────────────────────────────────────────────────────┘
                    ⏱️ 等待 10 分钟
┌─────────────────────────────────────────────────────────────┐
│ 任务2: 文章A → 抖音                                          │
│   batch_order: 1                                            │
│   interval_minutes: 10                                      │
└─────────────────────────────────────────────────────────────┘
                    ⏱️ 等待 10 分钟
┌─────────────────────────────────────────────────────────────┐
│ 任务3: 文章B → 头条                                          │
│   batch_order: 2                                            │
│   interval_minutes: 10                                      │
└─────────────────────────────────────────────────────────────┘
                    ⏱️ 等待 10 分钟
┌─────────────────────────────────────────────────────────────┐
│ 任务4: 文章B → 抖音                                          │
│   batch_order: 3                                            │
│   interval_minutes: 10                                      │
└─────────────────────────────────────────────────────────────┘
                    ⏱️ 等待 10 分钟
┌─────────────────────────────────────────────────────────────┐
│ 任务5: 文章C → 头条                                          │
│   batch_order: 4                                            │
│   interval_minutes: 10                                      │
└─────────────────────────────────────────────────────────────┘
                    ⏱️ 等待 10 分钟
┌─────────────────────────────────────────────────────────────┐
│ 任务6: 文章C → 抖音                                          │
│   batch_order: 5                                            │
│   interval_minutes: 0  ← 最后一个任务，不需要等待           │
└─────────────────────────────────────────────────────────────┘
```

### 特点
- ✅ 每个任务之间都等待 10 分钟
- ✅ 最后一个任务不需要等待
- ✅ 总等待次数：5次（任务数 - 1）
- ✅ **总耗时：(6-1) × 10 = 50 分钟**
- ✅ 符合用户预期

---

## 时间计算公式

```
总耗时 = (总任务数 - 1) × 间隔时间
总任务数 = 文章数 × 平台数
```

### 示例计算

| 场景 | 总任务数 | 等待次数 | 总耗时 |
|------|---------|---------|--------|
| 2篇文章 × 2平台，间隔5分钟 | 4 | 3 | (4-1)×5 = **15分钟** |
| 3篇文章 × 2平台，间隔10分钟 | 6 | 5 | (6-1)×10 = **50分钟** |
| 3篇文章 × 3平台，间隔10分钟 | 9 | 8 | (9-1)×10 = **80分钟** |
| 5篇文章 × 3平台，间隔10分钟 | 15 | 14 | (15-1)×10 = **140分钟** |
| 10篇文章 × 4平台，间隔15分钟 | 40 | 39 | (40-1)×15 = **585分钟** |

---

## 核心代码逻辑

### interval_minutes 设置规则

```typescript
for (let i = 0; i < articleIds.length; i++) {
  const articleId = articleIds[i];
  
  for (let j = 0; j < accountIds.length; j++) {
    const accountId = accountIds[j];
    
    // 判断是否是最后一个任务
    const isLastTask = (i === articleIds.length - 1) && (j === accountIds.length - 1);
    
    // 除了最后一个任务，其他任务都设置间隔
    const intervalMinutes = isLastTask ? 0 : publishInterval;
    
    createTask({
      batch_order: batchOrder++,
      interval_minutes: intervalMinutes
    });
  }
}
```

### 真值表

| 任务 | 文章 | 平台 | isLastTask | intervalMinutes |
|------|------|------|-----------|-----------------|
| 1 | 文章A | 头条 | false | 10 (等待) |
| 2 | 文章A | 抖音 | false | 10 (等待) |
| 3 | 文章B | 头条 | false | 10 (等待) |
| 4 | 文章B | 抖音 | false | 10 (等待) |
| 5 | 文章C | 头条 | false | 10 (等待) |
| 6 | 文章C | 抖音 | true | 0 (立即) |

---

## 详细执行流程

### 3篇文章 × 3个平台，间隔10分钟

```
任务1: 文章1 → 平台A (interval=10)
  ↓ 等待 10 分钟
任务2: 文章1 → 平台B (interval=10)
  ↓ 等待 10 分钟
任务3: 文章1 → 平台C (interval=10)
  ↓ 等待 10 分钟
任务4: 文章2 → 平台A (interval=10)
  ↓ 等待 10 分钟
任务5: 文章2 → 平台B (interval=10)
  ↓ 等待 10 分钟
任务6: 文章2 → 平台C (interval=10)
  ↓ 等待 10 分钟
任务7: 文章3 → 平台A (interval=10)
  ↓ 等待 10 分钟
任务8: 文章3 → 平台B (interval=10)
  ↓ 等待 10 分钟
任务9: 文章3 → 平台C (interval=0)  ← 最后一个任务
```

**总耗时：** (9-1) × 10 = **80 分钟**

---

## 用户体验

### 确认对话框

```
将为 3 篇文章创建 9 个发布任务
发布间隔：10 分钟
预计完成时间：约 1小时20分钟

⚠️ 发布逻辑：每个任务完成后，等待 10 分钟，再发布下一个任务
例如：文章1-平台A → 等待 → 文章1-平台B → 等待 → 文章1-平台C → 等待 → 文章2-平台A → ...
```

---

## 总结

这个逻辑确保：
- ✅ 每个任务之间都有固定间隔
- ✅ 最后一个任务不需要等待
- ✅ 总耗时 = (总任务数 - 1) × 间隔时间
- ✅ 简单、直观、易于理解
- ✅ 符合用户的预期行为

