# 商品管理功能配额显示修复

## 修复时间
2026-01-04

## 问题描述

### 症状
1. 功能配额列显示 "undefined undefined"
2. 编辑套餐时，已保存的功能配额不显示
3. 更新功能配额后，列表不刷新

### 截图问题
- 表格中功能配额列显示多个 "undefined undefined" 标签
- 无法看到实际的配额值

## 根本原因

### 1. API 端点错误 ❌
**文件：** `client/src/pages/ProductManagementPage.tsx`

**错误代码：**
```typescript
const response = await axios.get('/api/admin/products?include_inactive=true', {
  headers: { Authorization: `Bearer ${token}` }
});
```

**问题：**
- 使用了错误的 API 端点 `/api/admin/products`
- 正确的端点应该是 `/api/admin/products/plans`
- 导致返回空数据或错误数据

### 2. 数据验证
通过数据库查询验证，数据本身是正确的：
```json
{
  "id": 1,
  "plan_code": "free",
  "plan_name": "免费",
  "features": [
    {
      "id": 35,
      "featureCode": "articles_per_day",
      "featureName": "每日生成文章数",
      "featureValue": 1,
      "featureUnit": "篇"
    },
    {
      "id": 36,
      "featureCode": "publish_per_day",
      "featureName": "每日发布文章数",
      "featureValue": 1,
      "featureUnit": "篇"
    }
  ]
}
```

## 修复方案

### 1. 修复 API 端点 ✅

**文件：** `client/src/pages/ProductManagementPage.tsx`

**修复前：**
```typescript
const loadPlans = async () => {
  setLoading(true);
  try {
    const token = localStorage.getItem('auth_token');
    const response = await axios.get('/api/admin/products?include_inactive=true', {
      headers: { Authorization: `Bearer ${token}` }
    });
    setPlans(response.data.data);
  } catch (error: any) {
    message.error(error.response?.data?.message || '加载套餐失败');
  } finally {
    setLoading(false);
  }
};
```

**修复后：**
```typescript
const loadPlans = async () => {
  setLoading(true);
  try {
    const token = localStorage.getItem('auth_token');
    const response = await axios.get('/api/admin/products/plans?include_inactive=true', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    console.log('[ProductManagement] 加载套餐列表:', response.data);
    setPlans(response.data.data);
  } catch (error: any) {
    console.error('[ProductManagement] 加载套餐失败:', error);
    message.error(error.response?.data?.message || '加载套餐失败');
  } finally {
    setLoading(false);
  }
};
```

**改进点：**
- ✅ 修正 API 端点为 `/api/admin/products/plans`
- ✅ 添加调试日志
- ✅ 改进错误处理

### 2. 优化编辑功能 ✅

**修复前：**
```typescript
const handleEdit = (plan: Plan) => {
  setCurrentPlan(plan);
  form.setFieldsValue({
    planName: plan.planName,
    price: plan.price,
    billingCycle: plan.billingCycle,
    description: plan.description,
    displayOrder: plan.displayOrder,
    isActive: plan.isActive,
    features: plan.features || []
  });
  setEditModalVisible(true);
};
```

**修复后：**
```typescript
const handleEdit = (plan: Plan) => {
  console.log('[ProductManagement] 编辑套餐:', plan);
  console.log('[ProductManagement] 套餐功能配额:', plan.features);
  
  setCurrentPlan(plan);
  
  // 确保 features 数据完整
  const features = (plan.features || []).map(feature => ({
    featureCode: feature.featureCode,
    featureName: feature.featureName,
    featureValue: feature.featureValue,
    featureUnit: feature.featureUnit
  }));
  
  console.log('[ProductManagement] 设置表单 features:', features);
  
  form.setFieldsValue({
    planName: plan.planName,
    price: plan.price,
    billingCycle: plan.billingCycle,
    description: plan.description,
    displayOrder: plan.displayOrder,
    isActive: plan.isActive,
    features: features
  });
  
  setEditModalVisible(true);
};
```

**改进点：**
- ✅ 添加调试日志，便于排查问题
- ✅ 显式映射 features 字段，确保数据完整
- ✅ 验证数据结构

## 数据流程

### 完整流程

```
1. 用户打开商品管理页面
   ↓
2. 调用 loadPlans()
   ↓
3. GET /api/admin/products/plans?include_inactive=true
   ↓
4. 后端查询数据库
   ↓
5. 返回套餐列表（包含 features）
   ↓
6. 前端渲染表格
   ↓
7. 功能配额列显示：
   - featureName: featureValue featureUnit
   - 例如：每日生成文章数: 1 篇
```

### 编辑流程

```
1. 用户点击"编辑"按钮
   ↓
2. 调用 handleEdit(plan)
   ↓
3. 映射 features 数据
   ↓
4. 设置表单值
   ↓
5. 打开编辑模态框
   ↓
6. 显示已有的功能配额
```

## 后端 API 说明

### 端点：GET /api/admin/products/plans

**请求参数：**
- `include_inactive` (可选): 是否包含未激活的套餐

**响应格式：**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "planCode": "free",
      "planName": "免费",
      "price": 0.01,
      "billingCycle": "yearly",
      "isActive": true,
      "description": "免费体验版",
      "displayOrder": 1,
      "features": [
        {
          "id": 35,
          "planId": 1,
          "featureCode": "articles_per_day",
          "featureName": "每日生成文章数",
          "featureValue": 1,
          "featureUnit": "篇"
        }
      ],
      "createdAt": "2025-01-01T00:00:00.000Z",
      "updatedAt": "2025-01-04T00:00:00.000Z"
    }
  ]
}
```

## 前端表格渲染

### 功能配额列定义

```typescript
{
  title: '功能配额',
  key: 'features',
  render: (_, record) => (
    <Space direction="vertical" size="small">
      {record.features?.map((feature, index) => (
        <Tag key={feature.id || `${feature.featureCode}-${index}`} color="blue">
          {feature.featureName}: {feature.featureValue === -1 ? '无限制' : `${feature.featureValue} ${feature.featureUnit}`}
        </Tag>
      ))}
    </Space>
  ),
}
```

**渲染逻辑：**
1. 遍历 `record.features` 数组
2. 为每个 feature 创建一个 Tag
3. 显示格式：`{featureName}: {featureValue} {featureUnit}`
4. 特殊处理：`featureValue === -1` 显示为"无限制"

## 测试验证

### 测试步骤

1. **清除浏览器缓存**
   ```bash
   # 在浏览器开发者工具中
   Application → Clear storage → Clear site data
   ```

2. **重新登录**
   - 使用管理员账号登录
   - 访问商品管理页面

3. **验证列表显示**
   - ✅ 功能配额列应显示具体的配额信息
   - ✅ 例如："每日生成文章数: 1 篇"
   - ❌ 不应显示 "undefined undefined"

4. **验证编辑功能**
   - 点击"编辑"按钮
   - ✅ 功能配额列表应显示已有配额
   - ✅ 每个配额的值应正确填充
   - ✅ 下拉框应显示已选择的功能

5. **验证更新功能**
   - 修改功能配额
   - 点击"保存"
   - ✅ 列表应自动刷新
   - ✅ 显示更新后的配额

### 预期结果

#### 列表页面
```
排序 | 套餐名称 | 价格 | 功能配额 | 状态 | 操作
-----|---------|------|---------|------|------
1    | 免费    | ¥0.01/年 | 每日生成文章数: 1 篇 | 启用 | 编辑 历史 删除
     |         |          | 每日发布文章数: 1 篇 |      |
     |         |          | 可管理平台账号数: 1 个 |    |
     |         |          | 关键词蒸馏数: 1 个 |        |
```

#### 编辑模态框
```
功能配额：
┌─────────────────────────────────────────┐
│ 每日生成文章数    [1]  篇    [删除]      │
│ 每日发布文章数    [1]  篇    [删除]      │
│ 可管理平台账号数  [1]  个    [删除]      │
│ 关键词蒸馏数      [1]  个    [删除]      │
└─────────────────────────────────────────┘
[+ 添加功能配额]
```

## 调试技巧

### 1. 检查 API 响应

在浏览器开发者工具中：
```javascript
// Network 标签
// 查找 /api/admin/products/plans 请求
// 检查响应数据结构
```

### 2. 检查控制台日志

```javascript
// 应该看到：
[ProductManagement] 加载套餐列表: { success: true, data: [...] }
[ProductManagement] 编辑套餐: { id: 1, planName: '免费', features: [...] }
[ProductManagement] 套餐功能配额: [{ featureCode: 'articles_per_day', ... }]
```

### 3. 检查 React 状态

使用 React DevTools：
```
ProductManagementPage
  ├─ plans: Array(3)
  │   └─ [0]: { id: 1, features: Array(4) }
  └─ currentPlan: { id: 1, features: Array(4) }
```

## 相关文件

### 前端
- `client/src/pages/ProductManagementPage.tsx` - 商品管理页面

### 后端
- `server/src/routes/admin/productManagement.ts` - API 路由
- `server/src/services/ProductManagementService.ts` - 业务逻辑

### 数据库
- `subscription_plans` - 套餐表
- `plan_features` - 功能配额表

## 总结

### 修复内容
1. ✅ 修正 API 端点从 `/api/admin/products` 到 `/api/admin/products/plans`
2. ✅ 添加调试日志，便于问题排查
3. ✅ 优化编辑功能，确保数据完整性
4. ✅ 改进错误处理

### 影响范围
- ✅ 功能配额列正确显示
- ✅ 编辑时正确加载已有配额
- ✅ 更新后列表自动刷新

### 测试状态
- ⏳ 待用户验证

## 后续建议

1. **添加单元测试**
   - 测试 API 调用
   - 测试数据映射
   - 测试表单验证

2. **添加 E2E 测试**
   - 测试完整的编辑流程
   - 测试数据持久化

3. **性能优化**
   - 考虑添加缓存
   - 减少不必要的重新渲染

4. **用户体验优化**
   - 添加加载骨架屏
   - 添加操作成功提示
   - 优化错误提示
