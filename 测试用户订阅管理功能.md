# 测试用户订阅管理功能

## 🚀 快速开始

### 1. 执行数据库迁移

```bash
cd server
npx ts-node src/db/run-migration-027.ts
```

预期输出：
```
开始执行迁移 027: 用户订阅管理功能...
✅ 迁移 027 执行成功
   - subscription_adjustments 表已创建
   - user_subscriptions 表已扩展
   - get_user_subscription_detail 函数已创建
   - v_subscription_adjustment_history 视图已创建
```

### 2. 验证数据库结构

```sql
-- 检查表
\dt subscription_adjustments

-- 检查函数
\df get_user_subscription_detail

-- 检查视图
\dv v_subscription_adjustment_history

-- 检查 user_subscriptions 新增字段
\d user_subscriptions
```

### 3. 重启服务

```bash
# 终端 1: 启动后端
cd server
npm run dev

# 终端 2: 启动前端
cd client
npm run dev
```

## 🧪 功能测试

### 测试前准备

1. 确保有管理员账号
2. 确保有测试用户（testuser）
3. 确保测试用户有活跃订阅

### 测试步骤

#### 1. 查看订阅详情

1. 登录管理员账号
2. 进入"用户管理"页面
3. 找到测试用户，点击"订阅管理"按钮
4. 验证显示内容：
   - ✅ 套餐名称、价格、剩余天数
   - ✅ 配额使用进度条
   - ✅ 开始/到期日期
   - ✅ 快捷操作按钮

#### 2. 升级套餐

1. 点击"升级套餐"按钮
2. 选择更高级的套餐（如：专业版 → 企业版）
3. 输入升级原因："测试升级功能"
4. 点击"确认升级"
5. 验证结果：
   - ✅ 提示"套餐升级成功"
   - ✅ 套餐信息已更新
   - ✅ 配额已更新为新套餐配额
   - ✅ 到期日期已延长

#### 3. 延期订阅

1. 点击"延期订阅"按钮
2. 输入延长天数：30
3. 查看新到期日期预览
4. 输入延期原因："测试延期功能"
5. 点击"确认延期"
6. 验证结果：
   - ✅ 提示"订阅延期成功"
   - ✅ 到期日期增加了30天
   - ✅ 剩余天数增加了30天

#### 4. 调整配额

**测试临时调整：**
1. 点击"调整配额"按钮
2. 选择功能："每月文章生成数"
3. 输入新配额值：200
4. 关闭"永久生效"开关
5. 输入调整原因："测试临时调整"
6. 点击"确认"
7. 验证结果：
   - ✅ 提示"配额调整成功"
   - ✅ 配额显示为200
   - ✅ custom_quotas 字段已更新

**测试永久调整：**
1. 重复上述步骤，但开启"永久生效"
2. 验证 is_permanent 标记正确

**测试重置配额：**
1. 选择操作类型："重置使用量"
2. 选择功能："每月文章生成数"
3. 输入重置原因："测试重置功能"
4. 点击"确认"
5. 验证结果：
   - ✅ 提示"配额重置成功"
   - ✅ 当前使用量变为0
   - ✅ 进度条重置

#### 5. 暂停订阅

1. 点击"暂停订阅"按钮
2. 输入暂停原因："测试暂停功能"
3. 点击"确认暂停"
4. 验证结果：
   - ✅ 提示"订阅已暂停"
   - ✅ 状态标签显示"已暂停"
   - ✅ 显示暂停原因警告框
   - ✅ "暂停订阅"按钮变为"恢复订阅"

#### 6. 恢复订阅

1. 点击"恢复订阅"按钮
2. 输入恢复原因："测试恢复功能"
3. 点击"确认恢复"
4. 验证结果：
   - ✅ 提示"订阅已恢复"
   - ✅ 状态标签显示"活跃"
   - ✅ 暂停警告框消失
   - ✅ "恢复订阅"按钮变为"暂停订阅"

#### 7. 赠送套餐

1. 点击"赠送套餐"按钮
2. 选择套餐："专业版"
3. 输入赠送时长：60天
4. 查看赠送预览
5. 输入赠送原因："测试赠送功能"
6. 点击"确认赠送"
7. 验证结果：
   - ✅ 提示"套餐赠送成功"
   - ✅ 创建了新的订阅记录
   - ✅ 标记为赠送（is_gift = true）

#### 8. 取消订阅

**测试到期后取消：**
1. 点击"取消订阅"按钮
2. 关闭"立即取消"开关
3. 输入取消原因："测试到期后取消"
4. 点击"确认取消"
5. 验证结果：
   - ✅ 提示"订阅已取消"
   - ✅ 状态变为"已取消"
   - ✅ 到期日期未改变

**测试立即取消：**
1. 重复上述步骤，但开启"立即取消"
2. 验证结果：
   - ✅ 到期日期变为当前时间
   - ✅ 用户立即失去权益

#### 9. 查看调整历史

1. 切换到"调整历史"标签
2. 验证显示内容：
   - ✅ 所有操作按时间倒序排列
   - ✅ 操作类型标签正确
   - ✅ 操作详情完整
   - ✅ 操作原因显示
   - ✅ 操作人显示
3. 测试分页功能

## 🔍 数据库验证

### 检查 subscription_adjustments 表

```sql
SELECT 
  id,
  user_id,
  adjustment_type,
  reason,
  admin_id,
  created_at
FROM subscription_adjustments
WHERE user_id = (SELECT id FROM users WHERE username = 'testuser')
ORDER BY created_at DESC
LIMIT 10;
```

预期结果：所有测试操作都有记录

### 检查 user_subscriptions 表

```sql
SELECT 
  id,
  user_id,
  plan_id,
  status,
  start_date,
  end_date,
  paused_at,
  custom_quotas,
  is_gift
FROM user_subscriptions
WHERE user_id = (SELECT id FROM users WHERE username = 'testuser')
ORDER BY created_at DESC;
```

预期结果：字段值正确更新

### 使用视图查询历史

```sql
SELECT * FROM v_subscription_adjustment_history
WHERE user_id = (SELECT id FROM users WHERE username = 'testuser')
ORDER BY created_at DESC
LIMIT 10;
```

预期结果：历史记录格式化显示

## 🔌 API 测试

### 获取订阅详情

```bash
curl -X GET "http://localhost:3000/api/admin/user-subscriptions/1" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  | jq
```

预期响应：
```json
{
  "success": true,
  "data": {
    "subscription_id": 1,
    "plan_name": "专业版",
    "price": 99.00,
    "days_remaining": 30,
    "features": [...]
  }
}
```

### 升级套餐

```bash
curl -X POST "http://localhost:3000/api/admin/user-subscriptions/1/upgrade" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "newPlanId": 3,
    "reason": "API测试升级"
  }' | jq
```

### 延期订阅

```bash
curl -X POST "http://localhost:3000/api/admin/user-subscriptions/1/extend" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "daysToAdd": 30,
    "reason": "API测试延期"
  }' | jq
```

## ⚠️ 边界测试

### 1. 无订阅用户

测试用户：创建一个没有订阅的新用户
预期结果：显示"该用户没有活跃的订阅"

### 2. 已过期订阅

测试：将订阅的 end_date 设为过去时间
预期结果：正确识别为已过期

### 3. 配额边界值

- 测试 -1（无限制）
- 测试 0（禁用）
- 测试最大值（999999）

### 4. 延期天数边界

- 测试 1 天（最小值）
- 测试 3650 天（最大值）
- 测试 0 天（应拒绝）
- 测试 3651 天（应拒绝）

### 5. 并发操作

同时打开两个浏览器窗口，对同一用户进行操作
预期结果：数据库事务保证数据一致性

## 📊 性能测试

### 1. 查询性能

```sql
EXPLAIN ANALYZE
SELECT * FROM get_user_subscription_detail(1);
```

预期：查询时间 < 50ms

### 2. 历史记录分页

测试加载 1000 条历史记录的分页性能
预期：每页加载时间 < 100ms

## ✅ 测试检查清单

### 功能完整性
- [ ] 所有按钮可点击
- [ ] 所有模态框可打开/关闭
- [ ] 所有表单可提交
- [ ] 所有操作有成功提示
- [ ] 所有错误有错误提示

### 数据准确性
- [ ] 订阅信息显示正确
- [ ] 配额计算正确
- [ ] 日期计算正确
- [ ] 历史记录完整

### 用户体验
- [ ] 加载状态显示
- [ ] 操作反馈及时
- [ ] 错误提示友好
- [ ] 界面响应流畅

### 安全性
- [ ] 权限检查有效
- [ ] 操作日志完整
- [ ] 数据验证严格
- [ ] SQL 注入防护

## 🐛 已知问题

暂无

## 📝 测试报告模板

```
测试日期：2026-01-05
测试人员：[姓名]
测试环境：开发环境

功能测试结果：
✅ 查看订阅详情 - 通过
✅ 升级套餐 - 通过
✅ 延期订阅 - 通过
✅ 调整配额 - 通过
✅ 暂停/恢复 - 通过
✅ 取消订阅 - 通过
✅ 赠送套餐 - 通过
✅ 查看历史 - 通过

边界测试结果：
✅ 无订阅用户 - 通过
✅ 配额边界值 - 通过
✅ 延期天数边界 - 通过

性能测试结果：
✅ 查询性能 - 通过（平均 35ms）
✅ 分页性能 - 通过（平均 80ms）

总体评价：
所有功能正常，可以上线。
```

---

**测试完成标志**: 所有测试项通过 ✅
