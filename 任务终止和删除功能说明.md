# 任务终止和删除功能说明

## 问题诊断

### 发现的问题

运行 `npm run check-stuck-tasks` 发现任务42已经卡住超过5分钟：

```
任务 42: 已经 6 分钟没有更新
  - 状态: running
  - 请求数量: 7
  - 已生成: 0
```

### 可能的原因

1. **图片选择错误** - 新增的图片均衡选择功能可能在某些情况下出错
2. **AI服务超时** - AI生成文章时可能超时
3. **数据库连接问题** - 事务可能未正确提交或回滚
4. **异常未捕获** - executeTask中的某个步骤抛出异常但未被正确处理

## 已实现的功能

### 1. 诊断工具

#### check-stuck-tasks
检查卡住的任务（超过5分钟没有更新）

```bash
cd server
npm run check-stuck-tasks
```

#### fix-stuck-tasks
自动修复卡住的任务（标记为失败）

```bash
cd server
npm run fix-stuck-tasks
```

### 2. 后端API

#### 终止任务
```
POST /api/article-generation/tasks/:id/cancel
```

- 终止正在运行或待处理的任务
- 将任务状态设置为 'failed'
- 错误信息：'任务已被用户终止'

#### 删除任务（增强版）
```
DELETE /api/article-generation/tasks/:id
```

- 支持删除任何状态的任务
- 如果任务正在运行，会先终止再删除
- 级联删除关联的文章

### 3. 前端功能

#### 操作按钮

**终止按钮**
- 显示条件：任务状态为 'running' 或 'pending'
- 图标：ExclamationCircleOutlined
- 颜色：红色（danger）
- 功能：终止任务执行

**删除按钮**
- 显示条件：所有任务
- 图标：DeleteOutlined
- 颜色：红色（danger）
- 功能：删除任务（运行中的任务会先终止）

#### 批量操作

**批量删除**
- 支持删除运行中的任务
- 会提示有多少个任务正在运行
- 确认后批量终止并删除

**删除所有任务**
- 保留原有逻辑（不删除运行中的任务）

## 使用方法

### 场景1：终止单个卡住的任务

1. 进入"生成文章"页面
2. 找到卡住的任务（状态为"运行中"但长时间无进度）
3. 点击"终止"按钮
4. 确认终止

### 场景2：删除单个任务

1. 进入"生成文章"页面
2. 找到要删除的任务
3. 点击"删除"按钮
4. 确认删除
5. 如果任务正在运行，会先终止再删除

### 场景3：批量删除任务

1. 进入"生成文章"页面
2. 勾选要删除的任务
3. 点击"批量删除"按钮
4. 系统会提示有多少个任务正在运行
5. 确认后批量删除

### 场景4：使用命令行修复

```bash
# 1. 检查卡住的任务
cd server
npm run check-stuck-tasks

# 2. 自动修复卡住的任务
npm run fix-stuck-tasks

# 3. 重启服务
npm run dev
```

## 技术实现

### 后端实现

```typescript
// 终止任务
articleGenerationRouter.post('/tasks/:id/cancel', async (req, res) => {
  const taskId = parseInt(req.params.id);
  const task = await service.getTaskDetail(taskId);
  
  if (task.status !== 'running' && task.status !== 'pending') {
    return res.status(400).json({ error: '任务状态不允许终止' });
  }
  
  await service.updateTaskStatus(taskId, 'failed', task.generatedCount, '任务已被用户终止');
  res.json({ success: true, message: '任务已终止' });
});

// 删除任务（增强版）
articleGenerationRouter.delete('/tasks/:id', async (req, res) => {
  const taskId = parseInt(req.params.id);
  const task = await service.getTaskDetail(taskId);
  
  // 如果任务正在运行，先终止
  if (task.status === 'running') {
    await service.updateTaskStatus(taskId, 'failed', task.generatedCount, '任务已被用户终止');
  }
  
  // 删除任务
  await pool.query('DELETE FROM generation_tasks WHERE id = $1', [taskId]);
  res.json({ success: true, message: '任务已删除' });
});
```

### 前端实现

```typescript
// 终止任务
const handleCancelTask = async (taskId: number) => {
  try {
    setDeleting(true);
    await axios.post(`/api/article-generation/tasks/${taskId}/cancel`);
    message.success('任务已终止');
    loadTasks();
  } catch (error: any) {
    message.error(error.response?.data?.error || '终止任务失败');
  } finally {
    setDeleting(false);
  }
};

// 删除任务
const handleDeleteTask = async (taskId: number, taskStatus: string) => {
  try {
    setDeleting(true);
    await deleteTask(taskId);
    message.success('任务已删除');
    loadTasks();
  } catch (error: any) {
    message.error(error.response?.data?.error || '删除任务失败');
  } finally {
    setDeleting(false);
  }
};
```

## 预防措施

### 1. 添加超时检测

建议在executeTask中添加超时检测：

```typescript
async executeTask(taskId: number): Promise<void> {
  const timeout = setTimeout(() => {
    console.error(`[任务 ${taskId}] 执行超时`);
    this.updateTaskStatus(taskId, 'failed', undefined, '任务执行超时');
  }, 10 * 60 * 1000); // 10分钟超时

  try {
    // 执行任务...
  } finally {
    clearTimeout(timeout);
  }
}
```

### 2. 定期清理卡住的任务

可以添加一个定时任务：

```typescript
// 每5分钟检查一次卡住的任务
setInterval(async () => {
  await pool.query(`
    UPDATE generation_tasks
    SET status = 'failed',
        error_message = '任务超时（超过10分钟没有响应）'
    WHERE status = 'running'
      AND updated_at < NOW() - INTERVAL '10 minutes'
  `);
}, 5 * 60 * 1000);
```

### 3. 改进错误处理

在图片选择时添加更好的错误处理：

```typescript
try {
  const imageData = await this.selectBalancedImage(task.albumId);
  // ...
} catch (error) {
  console.error(`[任务 ${taskId}] 图片选择失败:`, error);
  // 使用默认图片继续执行
  imageUrl = '/uploads/gallery/placeholder.png';
}
```

## 测试验证

### 1. 测试终止功能

```bash
# 1. 创建一个任务
# 2. 在任务运行时点击"终止"按钮
# 3. 验证任务状态变为"失败"
# 4. 验证错误信息为"任务已被用户终止"
```

### 2. 测试删除功能

```bash
# 1. 创建多个任务（包括运行中的）
# 2. 尝试删除运行中的任务
# 3. 验证任务被终止并删除
# 4. 验证关联的文章也被删除
```

### 3. 测试批量删除

```bash
# 1. 选择多个任务（包括运行中的）
# 2. 点击"批量删除"
# 3. 验证提示信息正确
# 4. 确认后验证所有任务被删除
```

## 总结

✅ 已修复卡住的任务  
✅ 添加了终止任务功能  
✅ 增强了删除任务功能  
✅ 提供了诊断和修复工具  
✅ 更新了前端UI  

现在用户可以：
- 终止正在运行的任务
- 删除任何状态的任务（包括运行中的）
- 使用命令行工具诊断和修复问题
- 批量操作任务

建议：
- 定期运行 `npm run check-stuck-tasks` 检查系统状态
- 如果发现任务经常卡住，需要进一步调查根本原因
- 考虑添加任务超时机制和自动清理功能
