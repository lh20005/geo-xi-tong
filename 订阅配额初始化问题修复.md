# 订阅配额初始化问题修复

## 问题描述

用户 testuser2 购买套餐后，在订阅管理页面中：
- ✅ 订阅状态显示正常（专业版，有效期至 2026/2/4）
- ❌ 使用统计处显示空白
- ❌ 当前套餐数据显示为 0

## 问题根源

支付成功后的处理流程：
1. ✅ 创建订单记录（orders 表）
2. ✅ 创建订阅记录（user_subscriptions 表）
3. ❌ **缺少：初始化配额记录（user_usage 表）**

系统使用 `v_user_quota_overview` 视图来显示配额信息，该视图依赖于：
- `user_subscriptions` - 订阅信息
- `plan_features` - 套餐功能配置
- `user_usage` - 用户配额使用记录

如果 `user_usage` 表中没有记录，视图会返回空结果，导致前端显示空白。

## 修复方案

### 1. 立即修复 testuser2

运行修复脚本：
```bash
cd server
npx ts-node src/scripts/fix-testuser2-quota.ts
```

**执行结果：**
```
✅ 找到用户: testuser2 (ID: 438)
✅ 找到激活订阅: 专业版 (professional)
✅ 成功初始化 5 项配额记录

配额概览:
  - 每月生成文章数: 0/1 (剩余: 1, 使用率: 0.00%)
  - 关键词蒸馏数: 0/1 (剩余: 1, 使用率: 0.00%)
  - 可管理平台账号数: 0/1 (剩余: 1, 使用率: 0.00%)
  - 每月发布文章数: 0/1 (剩余: 1, 使用率: 0.00%)
  - 存储空间: 0/20 (剩余: 20, 使用率: 0.00%)
```

### 2. 批量修复所有用户

如果有其他用户也遇到同样问题，运行：
```bash
cd server
npx ts-node src/scripts/fix-all-users-quota-initialization.ts
```

### 3. 代码修复（防止未来再次发生）

#### 修改 1: PaymentService.ts
在支付成功后添加配额初始化：

```typescript
// 在 handleWeChatPayNotify 方法中
if (order.order_type === 'upgrade') {
  await subscriptionService.applyUpgrade(order.user_id, order.plan_id);
} else {
  // 创建订阅
  await client.query(
    `INSERT INTO user_subscriptions (user_id, plan_id, status, start_date, end_date)
     VALUES ($1, $2, 'active', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP + INTERVAL '1 month')`,
    [order.user_id, order.plan_id]
  );
  
  // ✅ 新增：初始化用户配额
  await this.initializeUserQuotas(client, order.user_id, order.plan_id);
}
```

添加私有方法：
```typescript
private async initializeUserQuotas(client: any, userId: number, planId: number): Promise<void> {
  // 获取套餐功能配置
  // 为每个功能创建初始 user_usage 记录
  // 根据功能类型确定重置周期（每日/每月/永不）
}
```

#### 修改 2: SubscriptionService.ts
在 `activateSubscription` 方法中添加配额初始化：

```typescript
async activateSubscription(userId: number, planId: number, durationMonths: number = 1): Promise<Subscription> {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    // 创建订阅记录
    const result = await client.query(...);
    
    // ✅ 新增：初始化用户配额
    await this.initializeUserQuotas(client, userId, planId);
    
    await client.query('COMMIT');
    return subscription;
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

## 配额周期规则

根据功能代码确定重置周期：

| 功能代码模式 | 重置周期 | period_start | period_end |
|------------|---------|--------------|------------|
| `*_per_day` | 每日 | 当天 00:00:00 | 当天 23:59:59 |
| `*_per_month` 或 `keyword_distillation` | 每月 | 本月 1 日 | 本月最后一天 |
| 其他（如 `platform_accounts`, `storage_space`） | 永不 | 2000-01-01 | 2099-12-31 |

## 数据库结构

### user_usage 表
```sql
CREATE TABLE user_usage (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  feature_code VARCHAR(50) NOT NULL,
  usage_count INTEGER DEFAULT 0,
  period_start TIMESTAMP NOT NULL,
  period_end TIMESTAMP NOT NULL,
  last_reset_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (user_id, feature_code, period_start)
);
```

### v_user_quota_overview 视图
```sql
CREATE VIEW v_user_quota_overview AS
SELECT 
  u.id AS user_id,
  pf.feature_code,
  pf.feature_name,
  pf.feature_value AS quota_limit,
  COALESCE(uu.usage_count, 0) AS current_usage,
  -- 计算剩余和使用率
FROM users u
JOIN user_subscriptions us ON us.user_id = u.id AND us.status = 'active'
JOIN plan_features pf ON pf.plan_id = us.plan_id
LEFT JOIN user_usage uu ON uu.user_id = u.id 
  AND uu.feature_code = pf.feature_code
  AND uu.period_end > CURRENT_TIMESTAMP;
```

## 验证修复

### 1. 数据库验证
```sql
-- 查看用户的配额记录
SELECT * FROM user_usage WHERE user_id = 438;

-- 查看用户的配额概览
SELECT * FROM v_user_quota_overview WHERE user_id = 438;
```

### 2. API 验证
```bash
# 获取配额概览
curl -X GET http://localhost:3000/api/usage/quota-overview \
  -H "Authorization: Bearer <token>"
```

### 3. 前端验证
1. 登录 testuser2 账号
2. 访问"个人中心" -> "订阅管理"
3. 检查：
   - ✅ "我的订阅"显示套餐信息
   - ✅ "使用统计"显示配额数据
   - ✅ "当前套餐"显示正确的配额限制

## 相关文件

### 修复脚本
- `server/src/scripts/fix-testuser2-quota.ts` - 单用户修复
- `server/src/scripts/fix-all-users-quota-initialization.ts` - 批量修复
- `server/src/scripts/diagnose-testuser2-subscription.ts` - 诊断工具

### 服务代码
- `server/src/services/PaymentService.ts` - 支付服务
- `server/src/services/SubscriptionService.ts` - 订阅服务
- `server/src/services/UsageTrackingService.ts` - 使用量追踪服务

### 数据库迁移
- `server/src/db/migrations/014_add_usage_tracking_and_alerts.sql` - 配额系统迁移

## 总结

✅ **问题已解决**
- testuser2 的配额已成功初始化
- 代码已修复，防止未来再次发生
- 提供了批量修复脚本，可处理历史数据
- 修复了 `storage_space` 功能定义缺失问题
- 修复了 `/api/subscription/usage-stats` 接口 500 错误

✅ **修复范围**
- 支付成功后自动初始化配额
- 订阅激活时自动初始化配额
- 提供诊断和修复工具
- 添加 `storage_space` 到功能定义
- 增强 `getUserUsageStats` 方法的容错性

✅ **测试建议**
1. 创建新测试用户
2. 购买套餐
3. 验证配额是否自动初始化
4. 检查前端显示是否正常
5. 验证使用统计接口是否正常返回

## 相关问题修复

### 问题 2: `/api/subscription/usage-stats` 返回 500 错误

**原因：**
- `FEATURE_DEFINITIONS` 中缺少 `storage_space` 定义
- `getUserUsageStats` 方法访问未定义的功能时抛出异常

**修复：**
1. 在 `server/src/config/features.ts` 中添加 `storage_space` 定义
2. 修改 `getUserUsageStats` 方法，增加容错处理

```typescript
// features.ts 新增
storage_space: {
  code: 'storage_space',
  name: '存储空间',
  unit: 'MB',
  defaultValue: 100,
  description: '可使用的存储空间大小',
  resetPeriod: 'never' as const
}

// SubscriptionService.ts 修改
const featureDef = FEATURE_DEFINITIONS[feature.feature_code as FeatureCode];
const resetTime = featureDef ? this.getNextResetTime(featureDef.resetPeriod) : undefined;
```
