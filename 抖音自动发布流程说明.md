# 抖音自动发布流程说明

## 完整发布流程

### 第一步：点击高清发布按钮

**选择器**：`#douyin-creator-master-side-upload`

**操作**：
1. 等待按钮出现
2. 鼠标悬停在按钮上（触发下拉菜单）
3. 等待1秒让下拉菜单完全显示

**注意**：这是一个带下拉菜单的按钮，必须先悬停才能看到下拉选项。

---

### 第二步：点击"发布图文"按钮

**选择器**：`#pixel-emoji-container`

**操作**：
1. 等待下拉菜单中的"发布图文"按钮可见
2. 点击该按钮
3. 等待2秒让页面跳转

**注意**：必须确保鼠标焦点在高清发布按钮上，否则下拉菜单会消失。

---

### 第三步：上传图片

**选择器**：
- 上传按钮：`#root > div > div > div.semi-tabs.semi-tabs-top > div > div.semi-tabs-pane-active.semi-tabs-pane > div > div > div.container-drag-VAfIfu > div > div.container-drag-upload-tL99XD > button`
- 文件输入：`input[type="file"]`

**操作**：
1. 等待上传按钮出现
2. 查找文件上传input元素
3. 使用 `uploadFile()` 方法上传所有图片
4. 等待5秒让图片上传完成

**图片处理**：
- 从Markdown内容中提取图片路径
- 支持相对路径和绝对路径
- 一次性上传所有图片

---

### 第四步：填写标题

**选择器**：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div > div:nth-child(1) > div > div > input`

**操作**：
1. 等待标题输入框出现
2. 点击输入框获取焦点
3. 输入文章标题（延迟50ms/字符）

**标题来源**：
- 优先使用 `config.title`
- 否则使用 `article.title`

---

### 第五步：填写描述（正文）

**选择器**：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div > div.editor-kit-editor-container.old > div > div > div`

**操作**：
1. 等待描述编辑器出现
2. 点击编辑器获取焦点
3. 输入纯文字内容（延迟30ms/字符）

**内容处理**：
- 移除Markdown图片语法 `![]()`
- 移除标题行（如果重复）
- 只保留纯文字内容

---

### 第六步：添加话题

**选择器**：
- 添加话题按钮：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div.editor-kit-root-container > div.toolbar > div:nth-child(1) > div > div > div:nth-child(1)`
- 推荐话题：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div.mention-suggest-mount-dom > div > div > div > div:nth-child(1) > div > span.tag-hash-view-name-DwMEe8`

**操作**：
1. 点击"添加话题"按钮
2. 输入关键词（使用文章标题）
3. 等待推荐话题出现
4. 点击第一个推荐话题

**关键词来源**：
- 使用文章标题作为关键词
- 系统会根据关键词推荐相关话题

**错误处理**：
- 如果添加话题失败，记录警告但继续流程

---

### 第七步：添加自主声明

**选择器**：
- 添加声明按钮：`#DCPF > div > div.content-right-ik9gts > div:nth-child(2) > section > section > section > section.mainPanelWrapper-OdIq41.unfold-zlkUeB > div > section.contentWrapper-oV33s2.userDeclarationWrapper-CZ7LJO > div > p.contentTitle-VxOS7t.addUserDeclaration-dq21tU`
- AI生成选项：`body > div:nth-child(26) > div > div.semi-sidesheet-inner.semi-sidesheet-inner-wrap > div > div.semi-sidesheet-body > section > div > div.radioEl-QlABcQ.checked-ayLe8U > label`
- 确定按钮：`body > div:nth-child(26) > div > div.semi-sidesheet-inner.semi-sidesheet-inner-wrap > div > div.semi-sidesheet-body > footer > button.semi-button.semi-button-primary.btn-I78nOi`

**操作**：
1. 点击"添加自主声明"按钮
2. 等待侧边栏弹出
3. 点击"内容由AI生成"选项
4. 点击"确定"按钮

**错误处理**：
- 如果添加声明失败，记录警告但继续流程

---

### 第八步：点击发布按钮

**选择器**：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(5) > div > div > div > div > div > button.button-dhlUZE.primary-cECiOJ.fixed-J9O8Yw`

**操作**：
1. 等待发布按钮出现
2. 点击发布按钮
3. 等待3秒让发布完成

---

## 完整流程图

```
开始
  ↓
1. 悬停"高清发布"按钮 (#douyin-creator-master-side-upload)
  ↓
2. 点击"发布图文" (#pixel-emoji-container)
  ↓
3. 上传图片 (input[type="file"])
  ↓
4. 填写标题 (input)
  ↓
5. 填写描述 (div编辑器)
  ↓
6. 添加话题
   - 点击"添加话题"按钮
   - 输入关键词
   - 选择推荐话题
  ↓
7. 添加自主声明
   - 点击"添加自主声明"
   - 选择"内容由AI生成"
   - 点击"确定"
  ↓
8. 点击"发布"按钮
  ↓
完成
```

---

## 关键技术点

### 1. 下拉菜单处理

```typescript
// 悬停触发下拉菜单
await page.hover(hdPublishButton);
await new Promise(resolve => setTimeout(resolve, 1000));

// 点击下拉菜单项
await page.click(publishImageTextButton);
```

**注意**：必须保持鼠标焦点在按钮上，否则下拉菜单会消失。

### 2. 图片上传

```typescript
// 一次性上传多张图片
const fileInput = await page.$('input[type="file"]');
await fileInput.uploadFile(...imagePaths);
```

**优点**：
- 一次性上传所有图片，效率高
- 不需要多次点击上传按钮

### 3. 内容清理

```typescript
// 移除Markdown图片语法
const textOnly = cleanContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '').trim();

// 移除重复的标题行
if (firstLine.includes(article.title)) {
  cleanContent = contentLines.slice(1).join('\n').trim();
}
```

### 4. 错误处理

```typescript
try {
  // 添加话题
  await page.click(addTopicButton);
  // ...
} catch (error: any) {
  console.log('[抖音号] ⚠️ 添加话题失败:', error.message);
  // 继续流程，不中断
}
```

**策略**：
- 核心步骤（标题、描述、发布）失败则中断
- 可选步骤（话题、声明）失败则记录警告但继续

---

## 测试步骤

### 1. 准备测试数据

确保有：
- 文章标题
- 文章正文
- 至少1张图片

### 2. 创建发布任务

1. 进入"发布任务"页面
2. 点击"创建发布任务"
3. 选择抖音平台
4. 选择已保存的抖音账号
5. 选择要发布的文章
6. 点击"创建任务"

### 3. 执行发布

1. 在任务列表中找到新创建的任务
2. 点击"执行"按钮
3. 观察浏览器自动操作
4. 查看后端日志

### 4. 验证结果

1. 检查后端日志是否显示"✅ 抖音号文章发布成功"
2. 在抖音创作者中心查看是否有新发布的内容
3. 检查标题、描述、图片、话题是否正确

---

## 预期日志输出

```
[抖音号] 开始发布流程
[抖音号] 第1步：点击高清发布按钮
[抖音号] ✅ 高清发布按钮已悬停，下拉菜单应该显示
[抖音号] 点击发布图文按钮
[抖音号] ✅ 已点击发布图文按钮
[抖音号] 第2步：点击上传图文按钮
[抖音号] 找到图片: image1.jpg
[抖音号] 找到图片: image2.jpg
[抖音号] 共有 2 张图片需要上传
[抖音号] 开始上传图片...
[抖音号] ✅ 已上传 2 张图片
[抖音号] 第3步：填写标题
[抖音号] ✅ 标题已填写: 测试文章标题
[抖音号] 第4步：填写描述
[抖音号] 纯文字长度: 500 个字符
[抖音号] ✅ 描述已填写
[抖音号] 第5步：添加话题
[抖音号] ✅ 话题已添加
[抖音号] 第6步：添加自主声明
[抖音号] ✅ 自主声明已添加
[抖音号] 第7步：点击发布按钮
[抖音号] ✅ 已点击发布按钮，等待发布完成...
✅ 抖音号文章发布成功
```

---

## 常见问题

### Q1: 下拉菜单没有显示

**原因**：鼠标悬停时间不够

**解决**：增加悬停后的等待时间
```typescript
await page.hover(hdPublishButton);
await new Promise(resolve => setTimeout(resolve, 2000)); // 增加到2秒
```

### Q2: 图片上传失败

**原因**：
- 图片路径不正确
- 图片文件不存在
- 文件格式不支持

**解决**：
- 检查图片路径是否正确
- 确保图片文件存在
- 使用支持的格式（JPG、PNG）

### Q3: 话题添加失败

**原因**：
- 关键词太短或太长
- 没有推荐话题

**解决**：
- 使用合适长度的关键词（5-20字）
- 如果失败，流程会继续（不影响发布）

### Q4: 选择器失效

**原因**：抖音页面更新，选择器变化

**解决**：
1. 打开抖音创作者中心
2. 使用浏览器开发者工具（F12）
3. 检查元素，获取新的选择器
4. 更新代码中的选择器

---

## 维护建议

### 1. 定期检查选择器

抖音可能会更新页面结构，导致选择器失效。建议：
- 每月检查一次
- 发现失败时立即检查
- 使用更稳定的选择器（ID > Class > 复杂路径）

### 2. 增加日志

在关键步骤增加详细日志，便于调试：
```typescript
console.log('[抖音号] 当前URL:', page.url());
console.log('[抖音号] 页面标题:', await page.title());
```

### 3. 截图调试

发布失败时自动截图：
```typescript
await page.screenshot({ path: 'douyin-error.png' });
```

---

## 修改的文件

- ✅ `server/src/services/adapters/DouyinAdapter.ts` - 完整重写发布流程

---

**创建时间**：2025-12-17
**状态**：✅ 已实现，等待测试
