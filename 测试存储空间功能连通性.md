# 测试存储空间功能连通性

## 问题描述

1. 在商品模块的功能配额列表里，存储空间选项不在列表里，导致无法选择，也无法实现在商品卡的展示
2. 需要系统检查存储空间这个选项是否像其他选项一样，是好用的，连通的
3. 单位需要改为 MB

## 修复内容

### 1. 数据库迁移 - 单位改为 MB

创建了迁移文件 `020_update_storage_unit_to_mb.sql`，将存储空间的单位从 `bytes` 改为 `MB`：

- 100MB (104857600 bytes) → 100 MB
- 1GB (1073741824 bytes) → 1024 MB
- 无限 (-1) → -1 MB

### 2. 前端商品管理页面

在 `client/src/pages/ProductManagementPage.tsx` 中添加了存储空间选项：

```typescript
const featureOptions = [
  { code: 'articles_per_month', name: '每月生成文章数', unit: '篇' },
  { code: 'publish_per_month', name: '每月发布文章数', unit: '篇' },
  { code: 'platform_accounts', name: '可管理平台账号数', unit: '个' },
  { code: 'keyword_distillation', name: '关键词蒸馏数', unit: '个' },
  { code: 'storage_space', name: '存储空间', unit: 'MB' }  // ✅ 新增
];
```

### 3. 连通性测试脚本

创建了 `server/src/scripts/test-storage-feature-connectivity.ts`，测试以下内容：

1. ✅ 数据库表结构检查
2. ✅ 套餐存储空间配置检查
3. ✅ 用户存储配额查询
4. ✅ StorageQuotaService 测试
5. ✅ 存储空间单位转换测试

## 执行步骤

### 步骤 1: 执行数据库迁移

```bash
cd server
npx ts-node src/db/run-migration-020.ts
```

这将：
- 更新所有套餐的存储空间单位从 bytes 改为 MB
- 更新存储空间的值（100MB, 1024MB, -1）
- 显示更新后的配置

### 步骤 2: 运行连通性测试

```bash
cd server
npx ts-node src/scripts/test-storage-feature-connectivity.ts
```

这将测试：
- 数据库表是否正确创建
- 套餐中的存储空间配置是否正确
- 用户存储配额查询是否正常
- StorageQuotaService 是否工作正常
- 单位转换是否正确

### 步骤 3: 重启服务

```bash
# 重启后端
npm run server:dev

# 重启前端
npm run client:dev
```

### 步骤 4: 验证功能

1. **商品管理页面**：
   - 访问 `/admin/products`
   - 编辑任意套餐
   - 在功能配额下拉列表中应该能看到"存储空间"选项
   - 选择后单位应该显示为 "MB"

2. **落地页展示**：
   - 访问落地页 `http://localhost:8080`
   - 查看套餐卡片
   - 应该能看到存储空间配额显示（如：存储空间 100MB）

3. **用户中心**：
   - 登录系统
   - 访问个人中心
   - 查看存储空间使用情况
   - 单位应该显示为 MB

## 预期结果

### 商品管理页面
- ✅ 功能配额列表中有"存储空间"选项
- ✅ 单位显示为 "MB"
- ✅ 可以正常添加、编辑、删除存储空间配额

### 落地页
- ✅ 套餐卡片中显示存储空间配额
- ✅ 格式：存储空间 100MB / 存储空间 1024MB / 存储空间 不限

### 用户中心
- ✅ 显示当前存储使用情况
- ✅ 单位为 MB
- ✅ 显示配额限制

### API 接口
- ✅ `/api/admin/products/plans` 返回的 features 中包含 storage_space
- ✅ feature_unit 为 "MB"
- ✅ feature_value 为 MB 数值（100, 1024, -1）

## 验证清单

- [ ] 数据库迁移成功执行
- [ ] 连通性测试全部通过
- [ ] 商品管理页面可以选择存储空间
- [ ] 落地页正确显示存储空间配额
- [ ] 用户中心正确显示存储使用情况
- [ ] 单位统一为 MB

## 注意事项

1. **数据一致性**：迁移会自动转换现有数据，无需手动修改
2. **缓存清理**：迁移后建议清理 Redis 缓存
3. **前端刷新**：修改后需要刷新浏览器缓存
4. **向后兼容**：StorageQuotaService 内部仍使用字节计算，只是显示时转换为 MB

## 技术细节

### 数据库层
- `plan_features` 表中 `feature_code = 'storage_space'`
- `feature_unit` 从 `bytes` 改为 `MB`
- `feature_value` 从字节数改为 MB 数

### 服务层
- `StorageQuotaService` 内部使用字节计算
- 对外接口返回 MB 值
- 自动处理单位转换

### 前端层
- 商品管理：下拉选项包含存储空间
- 落地页：显示存储空间配额
- 用户中心：显示存储使用情况（MB）

## 问题排查

如果遇到问题：

1. **存储空间选项不显示**：
   - 检查前端代码是否已更新
   - 清除浏览器缓存
   - 检查 featureOptions 数组

2. **单位显示不正确**：
   - 检查数据库迁移是否成功
   - 查询 plan_features 表确认 feature_unit
   - 检查 API 返回数据

3. **配额计算错误**：
   - 运行连通性测试脚本
   - 检查 StorageQuotaService
   - 查看服务器日志

## 相关文件

- `server/src/db/migrations/020_update_storage_unit_to_mb.sql` - 数据库迁移
- `server/src/db/run-migration-020.ts` - 迁移执行脚本
- `client/src/pages/ProductManagementPage.tsx` - 商品管理页面
- `server/src/scripts/test-storage-feature-connectivity.ts` - 连通性测试
- `server/src/services/StorageQuotaService.ts` - 存储配额服务
