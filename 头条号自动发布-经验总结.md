# å¤´æ¡å·è‡ªåŠ¨å‘å¸ƒ - ç»éªŒæ€»ç»“

## ğŸ¯ æœ€ç»ˆæˆåŠŸæ–¹æ¡ˆ

**DOMç›´æ¥æ“ä½œæ³•**ï¼šç»•è¿‡å‰ªè´´æ¿ï¼Œç›´æ¥è®¾ç½®ç¼–è¾‘å™¨çš„`innerHTML`

```typescript
// 1. æ„å»ºHTMLï¼ˆåŒ…å«base64å›¾ç‰‡ï¼‰
const htmlContent = '<p>æ–‡å­—</p><img src="data:image/png;base64,..."/>';

// 2. ç›´æ¥è®¾ç½®åˆ°ç¼–è¾‘å™¨
const editor = document.querySelector('.ProseMirror');
editor.innerHTML = htmlContent;

// 3. è§¦å‘äº‹ä»¶
editor.dispatchEvent(new Event('input', { bubbles: true }));
```

## âŒ å¤±è´¥çš„æ–¹æ¡ˆï¼ˆæŒ‰å°è¯•é¡ºåºï¼‰

### æ–¹æ¡ˆ1ï¼šç›´æ¥æ’å…¥å¤–éƒ¨URLå›¾ç‰‡
```typescript
// âŒ å¤±è´¥
const html = '<img src="http://localhost:3000/uploads/image.png">';
editor.innerHTML = html;
```
**å¤±è´¥åŸå› **ï¼šå¤´æ¡å·æ— æ³•è®¿é—®æœ¬åœ°URL

---

### æ–¹æ¡ˆ2ï¼šClipboard API + PNGå›¾ç‰‡
```typescript
// âŒ å¤±è´¥
const blob = new Blob([imageData], { type: 'image/png' });
const clipboardItem = new ClipboardItem({ 'image/png': blob });
await navigator.clipboard.write([clipboardItem]);
await page.keyboard.press('Meta+V');
```
**å¤±è´¥åŸå› **ï¼š
- æ˜¾ç¤º`[IMAGE_PLACEHOLDER]`
- å¤´æ¡å·ç¼–è¾‘å™¨ä¸æ¥å—å•ç‹¬çš„å›¾ç‰‡ç²˜è´´
- éœ€è¦å›¾æ–‡æ··æ’æ ¼å¼

---

### æ–¹æ¡ˆ3ï¼šClipboard API + HTMLæ ¼å¼
```typescript
// âŒ å¤±è´¥
const htmlBlob = new Blob([html], { type: 'text/html' });
const clipboardItem = new ClipboardItem({ 'text/html': htmlBlob });
await navigator.clipboard.write([clipboardItem]);
await page.keyboard.press('Meta+V');
```
**å¤±è´¥åŸå› **ï¼š
- å‰ªè´´æ¿å†™å…¥æˆåŠŸ
- ç²˜è´´å‘½ä»¤å‘é€æˆåŠŸ
- ä½†å†…å®¹å°±æ˜¯ä¸ç²˜è´´
- å¯èƒ½æ˜¯å¤´æ¡å·çš„ProseMirrorç¼–è¾‘å™¨ä¸æ¥å—ç¨‹åºåŒ–ç²˜è´´

---

### æ–¹æ¡ˆ4ï¼šDOMç›´æ¥æ“ä½œ
```typescript
// âœ… æˆåŠŸï¼
const editor = document.querySelector('.ProseMirror');
editor.innerHTML = htmlContent;
editor.dispatchEvent(new Event('input', { bubbles: true }));
```
**æˆåŠŸåŸå› **ï¼š
- ç»•è¿‡æ‰€æœ‰ä¸­é—´ç¯èŠ‚
- ç›´æ¥æ“ä½œç½‘é¡µåº•å±‚ç»“æ„
- ä¸ä¾èµ–å‰ªè´´æ¿å’Œç²˜è´´äº‹ä»¶

## ğŸ”§ å…³é”®æŠ€æœ¯é—®é¢˜ä¸è§£å†³

### é—®é¢˜1ï¼šæµè§ˆå™¨æ— æ³•æ»šåŠ¨

**ç°è±¡**ï¼š
- Puppeteerå¯åŠ¨çš„æµè§ˆå™¨æ— æ³•æ»šåŠ¨
- è¿ä¸»é¡µéƒ½åªèƒ½çœ‹åˆ°ç¬¬ä¸€å±
- æ‰€æœ‰æ»šåŠ¨æ–¹æ³•éƒ½å¤±è´¥

**æ ¹æœ¬åŸå› **ï¼š
```typescript
// âŒ é”™è¯¯é…ç½®
defaultViewport: {
  width: 1920,
  height: 1080
}
```
- `viewport`é™åˆ¶äº†é¡µé¢æ¸²æŸ“å¤§å°
- å³ä½¿çª—å£å¾ˆå¤§ï¼Œé¡µé¢ä¹Ÿåªæ¸²æŸ“viewportå¤§å°
- è¶…å‡ºéƒ¨åˆ†ä¸æ¸²æŸ“ï¼Œå¯¼è‡´æ— æ³•æ»šåŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// âœ… æ­£ç¡®é…ç½®
defaultViewport: null  // ä¸è®¾ç½®viewportï¼Œä½¿ç”¨æµè§ˆå™¨é»˜è®¤
```

**æ•™è®­**ï¼š
- Puppeteerçš„viewport â‰  çª—å£å¤§å°
- viewportæ˜¯è™šæ‹Ÿå±å¹•ï¼Œä¼šé™åˆ¶é¡µé¢æ¸²æŸ“
- è®¾ä¸º`null`è®©æµè§ˆå™¨è‡ªç„¶å·¥ä½œ

---

### é—®é¢˜2ï¼šDOMå…ƒç´ å¼•ç”¨å¤±æ•ˆ

**ç°è±¡**ï¼š
```
âŒ Node is detached from document
```

**åŸå› **ï¼š
```typescript
// 1. ä¿å­˜ç¼–è¾‘å™¨å¼•ç”¨
const contentEditor = await page.$('.ProseMirror');

// 2. è¾“å…¥æ–‡æœ¬åï¼ŒDOMé‡æ–°æ¸²æŸ“
await page.keyboard.type(text);

// 3. å†æ¬¡ä½¿ç”¨å¼•ç”¨ - å¤±è´¥ï¼
await contentEditor.click(); // âŒ å…ƒç´ å·²å¤±æ•ˆ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// æ¯æ¬¡æ“ä½œå‰é‡æ–°æŸ¥æ‰¾
const freshEditor = await page.$('.ProseMirror');
await freshEditor.click(); // âœ… ä½¿ç”¨æ–°å¼•ç”¨
```

**æ•™è®­**ï¼š
- DOMå…ƒç´ å¼•ç”¨ä¸æ˜¯æ°¸ä¹…çš„
- é¡µé¢æ›´æ–°åå¼•ç”¨ä¼šå¤±æ•ˆ
- æ¯æ¬¡æ“ä½œå‰é‡æ–°æŸ¥æ‰¾å…ƒç´ 

---

### é—®é¢˜3ï¼šå›¾ç‰‡æ ¼å¼ä¸å¤§å°

**å‘ç°**ï¼š
- æ–‡ç« å›¾ç‰‡ï¼š4036.71 KB PNGæ ¼å¼
- è½¬base64åï¼š5.5MBæ–‡æœ¬
- å‰ªè´´æ¿å¯èƒ½æœ‰å¤§å°é™åˆ¶

**è§£å†³**ï¼š
- DOMæ–¹æ¡ˆä¸å—å¤§å°é™åˆ¶
- ç›´æ¥è®¾ç½®innerHTMLå¯ä»¥å¤„ç†å¤§å›¾ç‰‡
- base64åµŒå…¥HTMLæ˜¯å¯è¡Œçš„

**æ•™è®­**ï¼š
- æ£€æŸ¥å›¾ç‰‡çœŸå®æ ¼å¼ï¼ˆæ–‡ä»¶ç­¾åï¼‰
- base64ä¼šå¢åŠ 30%ä½“ç§¯
- DOMæ“ä½œæ¯”å‰ªè´´æ¿æ›´å¯é 

---

### é—®é¢˜4ï¼šå‰ªè´´æ¿æƒé™

**ç°è±¡**ï¼š
- æµè§ˆå™¨å¼¹å‡ºæƒé™å¯¹è¯æ¡†
- å†…å®¹å¤ªå¤§æ—¶éœ€è¦ç”¨æˆ·ç¡®è®¤

**å°è¯•çš„è§£å†³**ï¼š
```typescript
// è®¾ç½®CDPæƒé™
await client.send('Browser.setPermission', {
  permission: { name: 'clipboard-write' },
  setting: 'granted'
});

// è‡ªåŠ¨ç‚¹å‡»"å…è®¸"æŒ‰é’®
const allowButton = await page.$('button:contains("å…è®¸")');
await allowButton.click();
```

**ç»“æœ**ï¼š
- æƒé™è®¾ç½®æˆåŠŸ
- ä½†ç²˜è´´è¿˜æ˜¯ä¸å·¥ä½œ
- æœ€ç»ˆæ”¾å¼ƒå‰ªè´´æ¿æ–¹æ¡ˆ

**æ•™è®­**ï¼š
- å‰ªè´´æ¿APIæœ‰å¾ˆå¤šé™åˆ¶
- ä¸åŒç½‘ç«™å¯¹ç²˜è´´çš„å¤„ç†ä¸åŒ
- DOMæ“ä½œæ›´å¯é 

## ğŸ“‹ å®Œæ•´å·¥ä½œæµç¨‹

### æœ€ç»ˆæˆåŠŸçš„æµç¨‹

```
1. è¯»å–æ–‡ç« ï¼ˆMarkdownæ ¼å¼ï¼‰
   â†“
2. æå–å›¾ç‰‡è·¯å¾„
   â†“
3. è¯»å–å›¾ç‰‡æ–‡ä»¶ â†’ è½¬base64
   â†“
4. æ„å»ºHTMLï¼š
   <p>æ–‡å­—</p>
   <img src="data:image/png;base64,...">
   <p>æ›´å¤šæ–‡å­—</p>
   â†“
5. ç‚¹å‡»ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
   â†“
6. ç›´æ¥è®¾ç½® editor.innerHTML = html
   â†“
7. è§¦å‘ input å’Œ change äº‹ä»¶
   â†“
8. ç­‰å¾…5ç§’è®©å›¾ç‰‡åŠ è½½
   â†“
9. ç»§ç»­åç»­æ­¥éª¤ï¼ˆå°é¢ã€å‘å¸ƒç­‰ï¼‰
```

### å…³é”®ä»£ç 

```typescript
// æ„å»ºHTML
let htmlContent = cleanContent;
for (const match of imageMatches) {
  const imageBuffer = fs.readFileSync(imagePath);
  const base64Image = imageBuffer.toString('base64');
  const imgTag = `<img src="data:image/png;base64,${base64Image}">`;
  htmlContent = htmlContent.replace(match[0], imgTag);
}

// è½¬æ¢æ®µè½
htmlContent = htmlContent
  .split('\n')
  .filter(line => line.trim())
  .map(line => `<p>${line}</p>`)
  .join('');

// ç›´æ¥æ’å…¥
await page.evaluate((html) => {
  const editor = document.querySelector('.ProseMirror');
  editor.innerHTML = html;
  editor.dispatchEvent(new Event('input', { bubbles: true }));
}, htmlContent);
```

## ğŸ“ æ ¸å¿ƒç»éªŒæ•™è®­

### 1. ä¼˜å…ˆä½¿ç”¨DOMæ“ä½œ

**åŸåˆ™**ï¼šèƒ½ç”¨DOMå°±ä¸ç”¨å‰ªè´´æ¿

**åŸå› **ï¼š
- DOMæ“ä½œç›´æ¥ã€å¯é 
- ä¸å—æµè§ˆå™¨å®‰å…¨é™åˆ¶
- ä¸å—å†…å®¹å¤§å°é™åˆ¶
- ä¸éœ€è¦ç”¨æˆ·äº¤äº’

### 2. ç†è§£Puppeteerçš„é™åˆ¶

**å…³é”®é…ç½®**ï¼š
```typescript
{
  headless: false,           // æ˜¾ç¤ºæµè§ˆå™¨
  defaultViewport: null,     // ä¸é™åˆ¶viewport
  ignoreDefaultArgs: ['--enable-automation'],  // éšè—è‡ªåŠ¨åŒ–æ ‡å¿—
  args: [
    '--start-maximized',     // æœ€å¤§åŒ–çª—å£
    '--disable-blink-features=AutomationControlled'
  ]
}
```

### 3. DOMå…ƒç´ å¼•ç”¨ç®¡ç†

**è§„åˆ™**ï¼š
- ä¸è¦é•¿æœŸä¿å­˜å…ƒç´ å¼•ç”¨
- æ¯æ¬¡æ“ä½œå‰é‡æ–°æŸ¥æ‰¾
- ä½¿ç”¨`page.$()`è€Œä¸æ˜¯ä¿å­˜å˜é‡

### 4. å›¾ç‰‡å¤„ç†ç­–ç•¥

**æ–¹æ¡ˆ**ï¼š
- æ£€æµ‹çœŸå®æ ¼å¼ï¼ˆæ–‡ä»¶ç­¾åï¼‰
- ç»Ÿä¸€è½¬æ¢ä¸ºPNG
- ä½¿ç”¨base64åµŒå…¥HTML
- ä¸ä¾èµ–å¤–éƒ¨URL

### 5. è°ƒè¯•æ–¹æ³•

**æœ‰æ•ˆçš„è°ƒè¯•æ‰‹æ®µ**ï¼š
- âœ… æˆªå›¾ï¼š`page.screenshot()`
- âœ… Consoleæ—¥å¿—ï¼š`console.log()`åœ¨`page.evaluate()`ä¸­
- âœ… è¯¦ç»†æ—¥å¿—ï¼šæ¯æ­¥éƒ½è¾“å‡ºçŠ¶æ€
- âœ… ç­‰å¾…æ—¶é—´ï¼šç»™è¶³å¤Ÿæ—¶é—´è§‚å¯Ÿ

**æ— æ•ˆçš„è°ƒè¯•æ‰‹æ®µ**ï¼š
- âŒ çŒœæµ‹é€‰æ‹©å™¨
- âŒ å¤æ‚çš„æ»šåŠ¨é€»è¾‘
- âŒ è¿‡åº¦ä¾èµ–å‰ªè´´æ¿

## ğŸš€ é€‚ç”¨äºå…¶ä»–å¹³å°

### é€šç”¨æ–¹æ¡ˆæ¨¡æ¿

```typescript
// 1. æ„å»ºHTMLï¼ˆåŒ…å«base64å›¾ç‰‡ï¼‰
const htmlContent = buildHTMLWithImages(article.content);

// 2. æŸ¥æ‰¾ç¼–è¾‘å™¨ï¼ˆæ ¹æ®å¹³å°è°ƒæ•´é€‰æ‹©å™¨ï¼‰
const editor = await page.$('.editor-class');

// 3. ç‚¹å‡»è·å¾—ç„¦ç‚¹
await editor.click();
await new Promise(resolve => setTimeout(resolve, 500));

// 4. ç›´æ¥è®¾ç½®å†…å®¹
await page.evaluate((html) => {
  const editor = document.querySelector('.editor-class');
  editor.innerHTML = html;
  editor.dispatchEvent(new Event('input', { bubbles: true }));
  editor.dispatchEvent(new Event('change', { bubbles: true }));
}, htmlContent);

// 5. ç­‰å¾…åŠ è½½
await new Promise(resolve => setTimeout(resolve, 5000));
```

### éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†

æ¯ä¸ªå¹³å°éœ€è¦ç¡®å®šï¼š
1. **ç¼–è¾‘å™¨é€‰æ‹©å™¨**ï¼š`.ProseMirror` / `.ql-editor` / `[contenteditable]`
2. **äº‹ä»¶ç±»å‹**ï¼š`input` / `change` / è‡ªå®šä¹‰äº‹ä»¶
3. **ç­‰å¾…æ—¶é—´**ï¼šæ ¹æ®å›¾ç‰‡å¤§å°è°ƒæ•´

## ğŸ“Š æ€§èƒ½æ•°æ®

- **å›¾ç‰‡å¤§å°**ï¼š4036.71 KB
- **base64å**ï¼š5.5 MB
- **HTMLæ€»é•¿åº¦**ï¼š5,512,537 å­—ç¬¦
- **æ’å…¥æ—¶é—´**ï¼š< 1ç§’
- **å›¾ç‰‡åŠ è½½æ—¶é—´**ï¼šçº¦3-5ç§’
- **æ€»è€—æ—¶**ï¼šçº¦10ç§’

## âœ… æœ€ç»ˆæ£€æŸ¥æ¸…å•

å‘å¸ƒåˆ°æ–°å¹³å°æ—¶æ£€æŸ¥ï¼š
- [ ] æµè§ˆå™¨é…ç½®ï¼ˆviewport = nullï¼‰
- [ ] ç¼–è¾‘å™¨é€‰æ‹©å™¨æ­£ç¡®
- [ ] å›¾ç‰‡è½¬base64
- [ ] HTMLæ ¼å¼æ­£ç¡®
- [ ] äº‹ä»¶è§¦å‘
- [ ] ç­‰å¾…æ—¶é—´å……è¶³
- [ ] é”™è¯¯å¤„ç†å®Œå–„

## ğŸ¯ æ€»ç»“

**æˆåŠŸçš„å…³é”®**ï¼š
1. æ”¾å¼ƒå¤æ‚æ–¹æ¡ˆï¼Œä½¿ç”¨æœ€ç›´æ¥çš„DOMæ“ä½œ
2. ç†è§£æµè§ˆå™¨å’ŒPuppeteerçš„é™åˆ¶
3. æ¯æ­¥éƒ½éªŒè¯å’Œè°ƒè¯•
4. ç»™è¶³å¤Ÿçš„ç­‰å¾…æ—¶é—´

**æ ¸å¿ƒåŸåˆ™**ï¼š
- ç®€å• > å¤æ‚
- ç›´æ¥ > é—´æ¥
- DOM > å‰ªè´´æ¿
- éªŒè¯ > å‡è®¾
