# 抖音自动发布全流程说明

## 概述
本文档详细说明抖音平台的自动发布流程，包含7个关键步骤。

## 重要提示
- **登录方式**：抖音平台必须使用Cookie登录，不支持账号密码登录
- **登录验证**：登录成功后会检查"高清发布"按钮是否存在
- **Cookie获取**：请先在"平台登录"页面完成抖音登录，系统会自动保存Cookie

## 完整流程

### 步骤1：悬停在"高清发布"按钮上5秒，点击"发布图文"

**目的**：打开发布图文的入口

**操作**：
1. 登录后，在抖音创作者中心首页
2. 找到"高清发布"按钮：`#douyin-creator-master-side-upload-wrap > button`
3. **关键**：模拟鼠标悬停在该按钮上，保持5秒
4. 等待二级菜单完全弹出
5. 点击二级菜单中的"发布图文"按钮：`body > div.douyin-creator-pc-portal`
6. 如果主选择器失败，会尝试查找包含"图文"文字的元素

**注意事项**：
- 必须保持鼠标悬停5秒，让二级菜单有充分时间弹出
- 点击"发布图文"时，必须确保鼠标或焦点仍在"高清发布"按钮上
- 如果鼠标移开，二级菜单会消失

---

### 步骤2：点击上传图文按钮，上传文章图片

**目的**：上传文章配图

**操作**：
1. 页面跳转到上传页面后
2. 点击"上传图文"按钮：`#root > div > div > div.semi-tabs.semi-tabs-top > div > div.semi-tabs-pane-active.semi-tabs-pane > div > div > div.container-drag-VAfIfu > div > div.container-drag-upload-tL99XD > button`
3. 通过文件选择对话框上传文章的所有图片

**注意事项**：
- 从文章内容中提取所有图片路径
- 一次性上传所有图片
- 等待图片上传完成（约8秒）

---

### 步骤3：填写作品标题

**目的**：添加文章标题

**操作**：
1. 找到标题输入框：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div > div:nth-child(1) > div > div > input`
2. 点击输入框，让光标进入
3. 输入文章标题

**注意事项**：
- 确保光标在输入框内
- 使用延迟输入（delay: 50ms）模拟真实用户

---

### 步骤4：填写作品描述（正文）

**目的**：添加文章正文内容

**操作**：
1. 找到描述编辑器：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div > div.editor-kit-editor-container.old > div > div > div`
2. 点击编辑器，让光标进入
3. 输入文章正文（纯文字，不包含图片标记）

**注意事项**：
- 从content中移除标题（如果存在）
- 移除Markdown图片标记，只保留纯文字
- 使用延迟输入（delay: 30ms）

---

### 步骤5：添加话题

**目的**：为文章添加相关话题标签

**操作**：
1. 点击"添加话题"按钮：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div.editor-kit-root-container > div.toolbar > div:nth-child(1) > div > div > div:nth-child(1)`
2. 在弹出的输入框中输入关键词（使用文章标题）
3. 等待推荐话题出现
4. 点击推荐的第一个话题：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(1) > div:nth-child(2) > div.container-gbfSJm > div.content-obt4oA.new-layout-sLYOT6 > div.content-child-V0CB7w.content-limit-width-zybqBW > div > div > div > div.mention-suggest-mount-dom > div > div > div > div:nth-child(1) > div > span.tag-hash-view-name-DwMEe8`

**注意事项**：
- 使用文章标题作为关键词
- 等待推荐话题完全加载（2秒）
- 如果失败，继续执行后续步骤

---

### 步骤6：添加自主声明（内容由AI生成）

**目的**：声明内容由AI生成

**操作**：
1. 点击"添加自主声明"按钮：`#DCPF > div > div.content-right-ik9gts > div:nth-child(2) > section > section > section > section.mainPanelWrapper-OdIq41.unfold-zlkUeB > div > section.contentWrapper-oV33s2.userDeclarationWrapper-CZ7LJO > div > p.contentTitle-VxOS7t.addUserDeclaration-dq21tU`
2. 等待侧边栏弹出
3. 点击"内容由AI生成"选项：`body > div:nth-child(26) > div > div.semi-sidesheet-inner.semi-sidesheet-inner-wrap > div > div.semi-sidesheet-body > section > div > div.radioEl-QlABcQ.checked-ayLe8U > label`
4. 点击"确定"按钮：`body > div:nth-child(26) > div > div.semi-sidesheet-inner.semi-sidesheet-inner-wrap > div > div.semi-sidesheet-body > footer > button.semi-button.semi-button-primary.btn-I78nOi`

**注意事项**：
- 等待侧边栏完全弹出（2秒）
- 确保选项被选中
- 如果失败，继续执行后续步骤

---

### 步骤7：点击发布按钮

**目的**：完成发布

**操作**：
1. 找到发布按钮：`#DCPF > div > div.content-left-F3wKrk > div > div:nth-child(5) > div > div > div > div > div > button.button-dhlUZE.primary-cECiOJ.fixed-J9O8Yw`
2. 点击发布按钮
3. 等待发布完成（5秒）

**注意事项**：
- 确保所有必填项都已填写
- 等待发布完成

---

## 关键技术要点

### 1. 鼠标悬停机制
- 使用 `page.hover()` 模拟鼠标悬停
- 必须保持5秒，让二级菜单完全显示
- 点击二级菜单项时，焦点必须保持在父按钮上

### 2. 等待时机
- 页面加载：5秒
- 鼠标悬停：5秒
- 图片上传：8秒
- 其他操作：1-3秒

### 3. 选择器策略
- 使用精确的CSS选择器
- 所有选择器都经过实际测试验证
- 如果主选择器失败，继续执行（非关键步骤）

### 4. 内容处理
- 自动移除content中的标题（避免重复）
- 提取纯文字内容（移除图片标记）
- 提取图片路径并上传

### 5. 错误处理
- 步骤5和步骤6失败不影响整体流程
- 详细的日志输出，便于调试
- 每个步骤都有超时保护

---

## 测试建议

1. **测试环境**：使用真实的抖音创作者账号
2. **测试内容**：准备包含标题、正文、图片的完整文章
3. **观察要点**：
   - 二级菜单是否正常弹出
   - 图片是否成功上传
   - 标题和正文是否正确填写
   - 话题是否成功添加
   - 自主声明是否成功设置

4. **调试方法**：
   - 查看控制台日志
   - 检查截图文件
   - 观察浏览器窗口（如果可见）

---

## 更新日期
2024-12-17

## 实现文件
`server/src/services/adapters/DouyinAdapter.ts`
