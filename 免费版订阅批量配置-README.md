# 免费版订阅批量配置 - 快速指南

## 🎯 目标

为现有没有订阅的用户统一配置免费版套餐并配置配额。

## 🚀 快速开始

### 一键执行（推荐）

```bash
./配置免费版订阅.sh
```

这个脚本会自动完成：
1. ✅ 检查免费版套餐配置
2. ✅ 为所有无订阅用户配置免费版
3. ✅ 验证配置结果

## 📋 详细步骤

### 步骤 1: 检查免费版套餐配置

```bash
cd server
npx ts-node src/scripts/check-free-plan-quotas.ts
```

**预期输出：**
- 免费版套餐信息（ID、名称、价格）
- 所有功能配额配置

### 步骤 2: 执行批量配置

```bash
npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

**处理内容：**
- 查找所有无订阅用户
- 为每个用户创建免费版订阅（1年有效期）
- 初始化功能配额
- 初始化存储空间

### 步骤 3: 验证配置结果

```bash
npx ts-node src/scripts/verify-free-subscription-setup.ts
```

**验证内容：**
- 套餐配置是否正确
- 用户订阅统计
- 配额初始化情况
- 存储空间配置
- 抽样检查用户详情

## 🔍 测试单个用户

```bash
cd server
npx ts-node src/scripts/test-single-user-free-setup.ts <username>
```

例如：
```bash
npx ts-node src/scripts/test-single-user-free-setup.ts testuser
```

## 📊 免费版配额说明

| 功能 | 配额 | 重置周期 |
|------|------|----------|
| 关键词蒸馏 | 10次 | 每月 |
| 文章生成 | 30篇 | 每月 |
| 文章发布 | 30次 | 每月 |
| 平台账号数 | 3个 | 永久 |
| 企业图库 | 10MB | 永久 |
| 企业知识库 | 10MB | 永久 |
| 存储空间 | 10MB | 永久 |

## ✅ 验证清单

配置完成后，请验证：

- [ ] 所有用户都有活跃订阅
- [ ] 订阅套餐为"体验版"（免费版）
- [ ] 有效期为1年
- [ ] 所有功能配额已初始化
- [ ] 存储空间已配置
- [ ] 用户可以正常登录
- [ ] 用户可以查看订阅信息
- [ ] 用户可以使用各项功能

## 🛠️ 相关脚本

| 脚本 | 用途 |
|------|------|
| `check-free-plan-quotas.ts` | 检查免费版套餐配置 |
| `reset-users-to-free-subscription.ts` | 批量配置免费版订阅 |
| `verify-free-subscription-setup.ts` | 验证配置结果 |
| `test-single-user-free-setup.ts` | 测试单个用户配置 |
| `test-free-subscription.ts` | 测试免费版订阅功能 |

## 📖 相关文档

- [免费版订阅批量配置指南](./免费版订阅批量配置指南.md) - 详细说明
- [免费版订阅功能实现总结](./免费版订阅功能实现总结.md) - 功能实现
- [免费版配额动态查询说明](./免费版配额动态查询说明.md) - 配额查询
- [快速开始-免费版订阅](./快速开始-免费版订阅.md) - 快速入门

## ⚠️ 注意事项

### 安全性
- ✅ 只处理没有活跃订阅的用户
- ✅ 不会影响已有订阅的用户
- ✅ 使用事务确保数据一致性
- ✅ 失败自动回滚

### 幂等性
- ✅ 可以重复执行
- ✅ 已有订阅的用户会被跳过
- ✅ 不会创建重复记录

### 数据完整性
- ✅ 清除旧配额记录
- ✅ 初始化所有必需的配额
- ✅ 创建存储空间记录
- ✅ 配额从零开始计算

## 🐛 故障排除

### 问题：脚本执行失败

**解决方案：**
1. 检查数据库连接是否正常
2. 确认免费版套餐已配置
3. 查看错误日志了解具体原因

### 问题：部分用户处理失败

**解决方案：**
1. 查看日志找出失败的用户
2. 使用测试脚本检查该用户状态
3. 手动修复或重新运行脚本

### 问题：用户仍然无法使用功能

**解决方案：**
1. 使用测试脚本检查用户配置
2. 确认订阅状态为 active
3. 确认配额已正确初始化
4. 检查存储空间是否配置

## 💡 最佳实践

1. **执行前备份数据库**
   ```bash
   pg_dump -U postgres -d geo_optimization > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **先在测试环境验证**
   - 在测试环境执行脚本
   - 验证所有功能正常
   - 再在生产环境执行

3. **执行后验证**
   - 运行验证脚本
   - 抽样测试几个用户
   - 监控系统日志

4. **定期检查**
   - 定期运行验证脚本
   - 确保新用户自动获得免费版
   - 监控配额使用情况

## 📞 技术支持

如有问题，请查看：
- 执行日志
- 数据库日志
- 应用程序日志

或联系技术支持团队。
