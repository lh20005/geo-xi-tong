# å•†å“ç®¡ç†æ¨¡å—æƒé™æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2026-01-04

## æ£€æŸ¥èŒƒå›´
å•†å“ç®¡ç†æ¨¡å—ï¼ˆProduct Managementï¼‰çš„ç”¨æˆ·éš”ç¦»å’Œæƒé™æ§åˆ¶

## æ£€æŸ¥ç»“æœï¼šâœ… é€šè¿‡

å•†å“ç®¡ç†æ¨¡å—å·²æ­£ç¡®å®æ–½ç®¡ç†å‘˜æƒé™æ§åˆ¶ï¼Œæ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ã€‚

---

## è¯¦ç»†æ£€æŸ¥é¡¹

### 1. åç«¯ API æƒé™æ§åˆ¶ âœ…

**æ–‡ä»¶ï¼š** `server/src/routes/admin/productManagement.ts`

**æƒé™ä¸­é—´ä»¶ï¼š**
```typescript
// æ‰€æœ‰è·¯ç”±éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
router.use(authenticate);
router.use(requireAdmin);
```

**æ£€æŸ¥ç»“æœï¼š**
- âœ… ä½¿ç”¨ `authenticate` ä¸­é—´ä»¶éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… ä½¿ç”¨ `requireAdmin` ä¸­é—´ä»¶ç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯è®¿é—®
- âœ… æ‰€æœ‰è·¯ç”±ï¼ˆGETã€POSTã€PUTã€DELETEï¼‰éƒ½å—ä¿æŠ¤

**API ç«¯ç‚¹ï¼š**
- `GET /api/admin/products/plans` - è·å–æ‰€æœ‰å¥—é¤
- `GET /api/admin/products/plans/:id` - è·å–å•ä¸ªå¥—é¤
- `POST /api/admin/products/plans` - åˆ›å»ºå¥—é¤
- `PUT /api/admin/products/plans/:id` - æ›´æ–°å¥—é¤
- `DELETE /api/admin/products/plans/:id` - åˆ é™¤å¥—é¤
- `GET /api/admin/products/history` - è·å–é…ç½®å†å²

**æƒé™éªŒè¯æµç¨‹ï¼š**
1. è¯·æ±‚åˆ°è¾¾ â†’ `authenticate` éªŒè¯ JWT token
2. Token æœ‰æ•ˆ â†’ `requireAdmin` æ£€æŸ¥ç”¨æˆ·è§’è‰²
3. è§’è‰²ä¸º admin â†’ å…è®¸è®¿é—®
4. è§’è‰²é admin â†’ è¿”å› 403 Forbidden

---

### 2. è·¯ç”±æ³¨å†Œ âœ…

**æ–‡ä»¶ï¼š** `server/src/routes/index.ts`

```typescript
import productManagementRouter from './admin/productManagement';

apiRouter.use('/admin/products', productManagementRouter);
```

**æ£€æŸ¥ç»“æœï¼š**
- âœ… è·¯ç”±è·¯å¾„åŒ…å« `/admin/` å‰ç¼€ï¼Œæ˜ç¡®æ ‡è¯†ä¸ºç®¡ç†å‘˜åŠŸèƒ½
- âœ… æ­£ç¡®æ³¨å†Œåˆ°ä¸»è·¯ç”±

---

### 3. å‰ç«¯è·¯ç”±ä¿æŠ¤ âœ…

**æ–‡ä»¶ï¼š** `client/src/App.tsx`

```typescript
<Route path="/products" element={<AdminRoute><ProductManagementPage /></AdminRoute>} />
```

**æ£€æŸ¥ç»“æœï¼š**
- âœ… ä½¿ç”¨ `<AdminRoute>` ç»„ä»¶åŒ…è£¹
- âœ… éç®¡ç†å‘˜ç”¨æˆ·è®¿é—®æ—¶ä¼šè¢«é‡å®šå‘
- âœ… ä¸å…¶ä»–ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆå®‰å…¨ç®¡ç†ã€ç³»ç»Ÿé…ç½®ï¼‰ä¿æŒä¸€è‡´

---

### 4. ä¾§è¾¹æ èœå•æ§åˆ¶ âœ…

**æ–‡ä»¶ï¼š** `client/src/components/Layout/Sidebar.tsx`

```typescript
// å•†å“ç®¡ç† - ä»…ç®¡ç†å‘˜å¯è§
...(userIsAdmin ? [{
  key: '/products',
  icon: <ShoppingOutlined />,
  label: 'å•†å“ç®¡ç†',
}] : []),
```

**æ£€æŸ¥ç»“æœï¼š**
- âœ… ä½¿ç”¨ `isAdmin()` å‡½æ•°æ£€æŸ¥ç”¨æˆ·è§’è‰²
- âœ… åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°"å•†å“ç®¡ç†"èœå•é¡¹
- âœ… æ™®é€šç”¨æˆ·æ— æ³•é€šè¿‡èœå•è®¿é—®

---

### 5. æœåŠ¡å±‚æ•°æ®éš”ç¦» âœ…

**æ–‡ä»¶ï¼š** `server/src/services/ProductManagementService.ts`

**æ£€æŸ¥ç»“æœï¼š**
- âœ… æ‰€æœ‰æ“ä½œéƒ½è®°å½•æ“ä½œäººï¼ˆadminIdï¼‰
- âœ… é…ç½®å˜æ›´å†å²è®°å½•æ“ä½œäººä¿¡æ¯
- âœ… ä¸å­˜åœ¨ç”¨æˆ·æ•°æ®æ··æ·†é£é™©ï¼ˆå¥—é¤é…ç½®æ˜¯å…¨å±€çš„ï¼Œä¸å±äºç‰¹å®šç”¨æˆ·ï¼‰

**å˜æ›´å†å²è®°å½•ï¼š**
```typescript
await this.recordConfigChange(
  client,
  planId,
  adminId,  // è®°å½•æ“ä½œçš„ç®¡ç†å‘˜ID
  changeType,
  oldValue,
  newValue
);
```

---

## å®‰å…¨ç‰¹æ€§æ€»ç»“

### âœ… å¤šå±‚é˜²æŠ¤

1. **å‰ç«¯å±‚**
   - èœå•é¡¹éšè—ï¼ˆéç®¡ç†å‘˜çœ‹ä¸åˆ°ï¼‰
   - è·¯ç”±ä¿æŠ¤ï¼ˆAdminRoute ç»„ä»¶ï¼‰
   - UI è®¿é—®æ§åˆ¶

2. **åç«¯å±‚**
   - JWT è®¤è¯ï¼ˆauthenticate ä¸­é—´ä»¶ï¼‰
   - è§’è‰²éªŒè¯ï¼ˆrequireAdmin ä¸­é—´ä»¶ï¼‰
   - API ç«¯ç‚¹ä¿æŠ¤

3. **å®¡è®¡å±‚**
   - æ“ä½œæ—¥å¿—è®°å½•
   - å˜æ›´å†å²è¿½è¸ª
   - æ“ä½œäººä¿¡æ¯è®°å½•

### âœ… æƒé™æ£€æŸ¥æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
    â†“
å‰ç«¯è·¯ç”±æ£€æŸ¥ (AdminRoute)
    â†“ (éç®¡ç†å‘˜è¢«æ‹’ç»)
åç«¯è®¤è¯ (authenticate)
    â†“ (æ— æ•ˆ token è¢«æ‹’ç»)
è§’è‰²éªŒè¯ (requireAdmin)
    â†“ (éç®¡ç†å‘˜è¢«æ‹’ç»)
ä¸šåŠ¡é€»è¾‘å¤„ç†
    â†“
è®°å½•æ“ä½œæ—¥å¿—
    â†“
è¿”å›ç»“æœ
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šç®¡ç†å‘˜è®¿é—® âœ…

**æ­¥éª¤ï¼š**
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
2. è®¿é—® `/products` é¡µé¢
3. å°è¯•ç¼–è¾‘å¥—é¤

**é¢„æœŸç»“æœï¼š**
- âœ… å¯ä»¥çœ‹åˆ°"å•†å“ç®¡ç†"èœå•
- âœ… å¯ä»¥è®¿é—®å•†å“ç®¡ç†é¡µé¢
- âœ… å¯ä»¥æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤å¥—é¤
- âœ… å¯ä»¥æŸ¥çœ‹é…ç½®å†å²

### æµ‹è¯•åœºæ™¯ 2ï¼šæ™®é€šç”¨æˆ·è®¿é—® âœ…

**æ­¥éª¤ï¼š**
1. ä½¿ç”¨æ™®é€šç”¨æˆ·è´¦å·ç™»å½•
2. æŸ¥çœ‹ä¾§è¾¹æ èœå•
3. å°è¯•ç›´æ¥è®¿é—® `/products` URL
4. å°è¯•ç›´æ¥è°ƒç”¨ API

**é¢„æœŸç»“æœï¼š**
- âœ… çœ‹ä¸åˆ°"å•†å“ç®¡ç†"èœå•é¡¹
- âœ… è®¿é—® `/products` è¢«é‡å®šå‘åˆ°é¦–é¡µ
- âœ… API è°ƒç”¨è¿”å› 403 Forbidden
- âœ… æ— æ³•è·å–ä»»ä½•å¥—é¤é…ç½®æ•°æ®

### æµ‹è¯•åœºæ™¯ 3ï¼šæœªç™»å½•ç”¨æˆ·è®¿é—® âœ…

**æ­¥éª¤ï¼š**
1. æ¸…é™¤æ‰€æœ‰ token
2. å°è¯•è®¿é—® `/products`
3. å°è¯•è°ƒç”¨ API

**é¢„æœŸç»“æœï¼š**
- âœ… è¢«é‡å®šå‘åˆ°ç™»å½•é¡µ
- âœ… API è°ƒç”¨è¿”å› 401 Unauthorized

---

## å¯¹æ¯”å…¶ä»–ç®¡ç†å‘˜åŠŸèƒ½

### ä¸€è‡´æ€§æ£€æŸ¥ âœ…

| åŠŸèƒ½æ¨¡å— | å‰ç«¯ä¿æŠ¤ | åç«¯ä¿æŠ¤ | èœå•æ§åˆ¶ | çŠ¶æ€ |
|---------|---------|---------|---------|------|
| ç³»ç»Ÿé…ç½® | AdminRoute | requireAdmin | isAdmin | âœ… |
| å®‰å…¨ç®¡ç† | AdminRoute | requireAdmin | isAdmin | âœ… |
| å•†å“ç®¡ç† | AdminRoute | requireAdmin | isAdmin | âœ… |
| è®¢å•ç®¡ç† | AdminRoute | requireAdmin | isAdmin | âœ… |

**ç»“è®ºï¼š** å•†å“ç®¡ç†æ¨¡å—çš„æƒé™æ§åˆ¶ä¸å…¶ä»–ç®¡ç†å‘˜åŠŸèƒ½ä¿æŒä¸€è‡´ã€‚

---

## æ½œåœ¨é£é™©è¯„ä¼°

### ğŸ”’ æ— é«˜é£é™©é—®é¢˜

### âš ï¸ å»ºè®®æ”¹è¿›ï¼ˆå¯é€‰ï¼‰

1. **API å“åº”ä¼˜åŒ–**
   - å½“å‰ï¼š403 Forbiddenï¼ˆæš´éœ²ç«¯ç‚¹å­˜åœ¨ï¼‰
   - å»ºè®®ï¼š404 Not Foundï¼ˆéšè—ç«¯ç‚¹å­˜åœ¨ï¼‰
   - ä¼˜å…ˆçº§ï¼šä½

2. **å‰ç«¯é”™è¯¯æç¤º**
   - å½“å‰ï¼šé™é»˜é‡å®šå‘
   - å»ºè®®ï¼šæ˜¾ç¤º"æƒé™ä¸è¶³"æç¤º
   - ä¼˜å…ˆçº§ï¼šä½

3. **å®¡è®¡æ—¥å¿—å¢å¼º**
   - å½“å‰ï¼šè®°å½•æ“ä½œäººå’Œå˜æ›´å†…å®¹
   - å»ºè®®ï¼šè®°å½• IP åœ°å€å’Œ User-Agent
   - ä¼˜å…ˆçº§ï¼šä¸­

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯
- `server/src/routes/admin/productManagement.ts` - è·¯ç”±å®šä¹‰
- `server/src/services/ProductManagementService.ts` - ä¸šåŠ¡é€»è¾‘
- `server/src/middleware/adminAuth.ts` - æƒé™ä¸­é—´ä»¶
- `server/src/routes/index.ts` - è·¯ç”±æ³¨å†Œ

### å‰ç«¯
- `client/src/pages/ProductManagementPage.tsx` - é¡µé¢ç»„ä»¶
- `client/src/App.tsx` - è·¯ç”±é…ç½®
- `client/src/components/Layout/Sidebar.tsx` - èœå•æ§åˆ¶
- `client/src/components/AdminRoute.tsx` - æƒé™è·¯ç”±ç»„ä»¶

### æ•°æ®åº“
- `subscription_plans` - å¥—é¤è¡¨
- `plan_features` - åŠŸèƒ½é…é¢è¡¨
- `product_config_history` - é…ç½®å˜æ›´å†å²è¡¨

---

## ç»“è®º

âœ… **å•†å“ç®¡ç†æ¨¡å—çš„ç”¨æˆ·éš”ç¦»å’Œæƒé™æ§åˆ¶å·²æ­£ç¡®å®æ–½**

- æ‰€æœ‰ API ç«¯ç‚¹éƒ½å—åˆ°ç®¡ç†å‘˜æƒé™ä¿æŠ¤
- å‰ç«¯è·¯ç”±å’Œèœå•æ­£ç¡®é™åˆ¶è®¿é—®
- æ™®é€šç”¨æˆ·æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼è®¿é—®å•†å“ç®¡ç†åŠŸèƒ½
- æƒé™æ§åˆ¶ä¸å…¶ä»–ç®¡ç†å‘˜åŠŸèƒ½ä¿æŒä¸€è‡´
- æ“ä½œæ—¥å¿—å®Œæ•´è®°å½•ï¼Œä¾¿äºå®¡è®¡

**æ— éœ€é¢å¤–ä¿®å¤ï¼Œç³»ç»Ÿå®‰å…¨ã€‚**

---

## é™„å½•ï¼šæƒé™éªŒè¯ä»£ç 

### adminAuth.ts ä¸­é—´ä»¶

```typescript
// éªŒè¯ç®¡ç†å‘˜æƒé™
export const requireAdmin = (req: Request, res: Response, next: NextFunction) => {
  const user = (req as any).user;
  
  if (!user || user.role !== 'admin') {
    return res.status(403).json({
      success: false,
      message: 'éœ€è¦ç®¡ç†å‘˜æƒé™'
    });
  }
  
  next();
};
```

### AdminRoute.tsx ç»„ä»¶

```typescript
export const AdminRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const currentUser = getCurrentUser();
  
  if (!currentUser || currentUser.role !== 'admin') {
    return <Navigate to="/" replace />;
  }
  
  return <>{children}</>;
};
```

### isAdmin() å·¥å…·å‡½æ•°

```typescript
export const isAdmin = (): boolean => {
  const user = getCurrentUser();
  return user?.role === 'admin';
};
```
