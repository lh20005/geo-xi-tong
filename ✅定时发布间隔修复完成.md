# ✅ 定时发布间隔修复完成

## 问题描述

Windows端批量定时发布功能没有按照设定的时间间隔发布文章。

### 问题表现

用户设置间隔2分钟发布：
- 任务1：15:30:04 完成
- 任务2：15:32:10 完成（应该在 15:32:04 开始，15:34:xx 完成）

**实际间隔只有2分钟，但任务2应该在任务1完成后等待2分钟再开始执行。**

## 根本原因

TaskScheduler每10秒调用一次 `checkAndExecuteBatches()`，原来的SQL查询逻辑是：

```sql
SELECT DISTINCT batch_id 
FROM publishing_tasks 
WHERE batch_id IS NOT NULL 
AND status = 'pending'
AND batch_order = (
  SELECT MIN(batch_order) 
  FROM publishing_tasks t2 
  WHERE t2.batch_id = publishing_tasks.batch_id 
  AND t2.status = 'pending'
)
```

这个查询会找到**当前batch_order最小的pending任务**。

### 问题场景

1. 批次开始执行，任务1（batch_order=0）开始
2. 任务1完成（15:30:04）
3. BatchExecutor开始等待2分钟
4. **在等待期间（比如15:30:14），TaskScheduler再次检查**
5. 发现任务2（batch_order=1）是pending状态，且是最小的batch_order
6. **TaskScheduler可能触发任务2的执行，绕过了BatchExecutor的等待逻辑**

虽然有 `executingBatches` 的保护，但SQL查询本身就有问题。

## 修复方案

修改 `checkAndExecuteBatches()` 的逻辑：

### 1. 只查找batch_order=0的任务

```typescript
// 只查找batch_order=0的任务，确保批次还没开始执行
const result = await pool.query(`
  SELECT DISTINCT batch_id 
  FROM publishing_tasks 
  WHERE batch_id IS NOT NULL 
  AND status = 'pending'
  AND batch_order = 0
`);
```

**原理：** 只有第一个任务（batch_order=0）是pending时，才启动批次。一旦批次开始执行，第一个任务就不再是pending状态，后续的TaskScheduler检查就不会再触发这个批次。

### 2. 额外检查executingBatches

```typescript
for (const batchId of batchIds) {
  // 跳过正在执行的批次
  if (this.executingBatches.has(batchId)) {
    console.log(`⏭️  批次 ${batchId} 正在执行中，跳过`);
    continue;
  }
  
  // 异步执行批次
  this.executeBatch(batchId).catch(error => {
    console.error(`批次 ${batchId} 执行失败:`, error);
  });
}
```

**双重保护：** 即使SQL查询有问题，executingBatches也能防止重复执行。

## 修改的文件

- `server/src/services/BatchExecutor.ts`

## 测试验证

修复后，批次发布的正确流程：

1. **任务1开始执行**（15:30:00）
2. **任务1完成**（15:30:04）
3. **等待2分钟**（15:30:04 - 15:32:04）
4. **任务2开始执行**（15:32:04）
5. **任务2完成**（15:34:xx）

### 验证命令

```bash
# 查看批次任务的执行时间
node check-batch-intervals.js

# 创建测试批次（2篇文章，2个平台，间隔3分钟）
# 在Windows端操作：
# 1. 选择2篇文章
# 2. 选择2个平台
# 3. 设置间隔3分钟
# 4. 创建发布任务

# 观察日志
tail -f server.log | grep -E "批次|等待|间隔"
```

## 预期效果

- ✅ 第一个任务立即执行
- ✅ 后续任务在前一个任务**完成后**等待指定间隔
- ✅ 间隔时间准确（误差在几秒内）
- ✅ 不会出现任务提前执行的情况

## 注意事项

1. **间隔时间从任务完成时开始计算**，不是从任务开始时计算
2. **TaskScheduler每10秒检查一次**，但不会干扰正在执行的批次
3. **批次执行是串行的**，一次只执行一个任务
4. **等待期间可以停止批次**，系统会立即响应

## 相关文件

- `server/src/services/BatchExecutor.ts` - 批次执行器（已修复）
- `server/src/services/TaskScheduler.ts` - 任务调度器
- `server/src/services/PublishingExecutor.ts` - 发布执行器
- `windows-login-manager/src/pages/PublishingTasksPage.tsx` - Windows端发布任务页面

---

**修复时间：** 2024-12-30
**修复状态：** ✅ 已完成并重启服务器
