# 商品管理系统 - 更新套餐功能修复（最终版）

## 修复时间
2026-01-04

## 问题描述

### 1. 后端 500 错误
- **现象**：PUT `/api/admin/products/plans/:id` 返回 500 Internal Server Error
- **影响**：无法更新套餐信息

### 2. React Key 警告
- **现象**：控制台出现 "Each child in a list should have a unique key prop" 警告
- **位置**：功能配额列表渲染

### 3. TypeScript 类型错误
- **现象**：Timeline 组件的 loading 属性类型错误
- **影响**：编译警告

## 根本原因分析

经过深入调试发现，主要问题是：

1. **数据库字段名不匹配**：
   - 数据库使用 snake_case（如 `plan_code`, `plan_name`）
   - TypeScript 接口使用 camelCase（如 `planCode`, `planName`）
   - SQL 查询没有使用别名转换字段名

2. **不存在的字段**：
   - 代码中引用了 `duration_days` 字段
   - 但数据库表中没有这个字段

3. **表单数据不完整**：
   - 功能配额的 `featureName` 和 `featureUnit` 没有自动填充

## 修复内容

### 1. 后端修复 (server/src/services/ProductManagementService.ts)

#### 修复 1：SQL 查询字段名转换

**getAllPlans 方法：**
```typescript
// 修复前：使用 sp.*，返回 snake_case 字段
SELECT sp.*, json_agg(...) as features

// 修复后：使用别名转换为 camelCase
SELECT 
  sp.id,
  sp.plan_code as "planCode",
  sp.plan_name as "planName",
  sp.price,
  sp.billing_cycle as "billingCycle",
  sp.is_active as "isActive",
  sp.description,
  sp.display_order as "displayOrder",
  sp.created_at as "createdAt",
  sp.updated_at as "updatedAt",
  json_agg(...) as features
```

**getPlanById 方法：** 同样的修复

**updatePlan 方法中的查询：** 同样的修复

#### 修复 2：移除不存在的字段

**移除 `duration_days` 字段的所有引用：**
- TypeScript 接口中移除 `durationDays`
- SQL 查询中移除 `duration_days`
- INSERT 语句中移除该字段
- UPDATE 逻辑中移除该字段的处理

#### 修复 3：事务隔离

**原代码：**
```typescript
const oldPlan = await this.getPlanById(planId);
```

**问题：** `getPlanById()` 使用 `pool.query`，不在事务中

**修复后：**
```typescript
const oldPlanResult = await client.query(`SELECT ...`, [planId]);
const oldPlan = oldPlanResult.rows[0];
```

**改进：** 使用 `client.query` 保持在同一事务中

### 2. 前端修复 (client/src/pages/ProductManagementPage.tsx)

#### 修复 1：功能配额自动填充

**原代码：**
```typescript
<Select placeholder="选择功能">
  {featureOptions.map(opt => (
    <Select.Option key={opt.code} value={opt.code}>
      {opt.name}
    </Select.Option>
  ))}
</Select>
```

**问题：** 选择功能代码后，`featureName` 和 `featureUnit` 没有自动填充

**修复后：**
```typescript
<Select 
  placeholder="选择功能"
  onChange={(value) => {
    const option = featureOptions.find(opt => opt.code === value);
    if (option) {
      const features = form.getFieldValue('features');
      features[name] = {
        ...features[name],
        featureCode: value,
        featureName: option.name,
        featureUnit: option.unit
      };
      form.setFieldsValue({ features });
    }
  }}
>
```

**改进：** 
- 添加 `onChange` 处理器
- 自动填充 `featureName` 和 `featureUnit`
- 添加隐藏字段存储这些值

#### 修复 2：React Key 警告

**原代码：**
```typescript
{record.features?.map(feature => (
  <Tag key={feature.featureCode} color="blue">
```

**修复后：**
```typescript
{record.features?.map((feature, index) => (
  <Tag key={feature.id || `${feature.featureCode}-${index}`} color="blue">
```

#### 修复 3：Timeline loading 属性

**原代码：**
```typescript
<Timeline loading={historyLoading} items={...} />
```

**修复后：**
```typescript
<Spin spinning={historyLoading}>
  <Timeline items={...} />
</Spin>
```

#### 修复 4：添加调试日志

```typescript
console.log('[ProductManagement] 准备保存的数据:', values);
console.log('[ProductManagement] 保存成功:', response.data);
console.error('[ProductManagement] 错误详情:', error.response?.data);
```

## 测试验证

### 后端测试
```bash
npx tsx server/src/scripts/test-update-plan.ts
```

**结果：**
```
✅ 找到套餐: {
  id: 1,
  planCode: 'free',        # ✅ camelCase
  planName: '测试套餐名称',  # ✅ camelCase
  price: '99.00',
  features: [...]
}

✅ 更新成功!
```

### 前端测试
1. 打开商品管理页面
2. 点击"编辑"按钮
3. 修改套餐信息
4. 点击"保存"
5. 验证：
   - ✅ 无 500 错误
   - ✅ 无 React key 警告
   - ✅ 无 TypeScript 错误
   - ✅ 数据成功更新

## 数据库表结构

```sql
Table "public.subscription_plans"
    Column     |            Type             
---------------+-----------------------------
 id            | integer                     
 plan_code     | character varying(50)       
 plan_name     | character varying(100)      
 price         | numeric(10,2)               
 billing_cycle | character varying(20)       
 is_active     | boolean                     
 display_order | integer                     
 description   | text                        
 created_at    | timestamp without time zone 
 updated_at    | timestamp without time zone
```

**注意：** 没有 `duration_days` 字段！

## 技术要点

### 1. PostgreSQL 字段名转换
```sql
-- 使用 AS "camelCase" 转换字段名
SELECT 
  plan_code as "planCode",
  plan_name as "planName"
FROM subscription_plans
```

**重要：** 双引号保留大小写

### 2. 事务中的查询
```typescript
// ❌ 错误：使用 pool，不在事务中
const plan = await this.getPlanById(planId);

// ✅ 正确：使用 client，在事务中
const result = await client.query('SELECT ...', [planId]);
```

### 3. Ant Design Form.List
```typescript
// 动态更新表单字段值
const features = form.getFieldValue('features');
features[index] = { ...features[index], newField: value };
form.setFieldsValue({ features });
```

### 4. React Key 最佳实践
```typescript
// ✅ 优先使用数据库 ID
key={item.id}

// ✅ 如果没有 ID，使用组合 key
key={item.id || `${item.code}-${index}`}

// ❌ 避免仅使用索引
key={index}
```

## 相关文件

### 后端
- `server/src/services/ProductManagementService.ts` - 套餐管理服务（主要修复）
- `server/src/routes/admin/productManagement.ts` - 管理员路由
- `server/src/scripts/test-update-plan.ts` - 测试脚本

### 前端
- `client/src/pages/ProductManagementPage.tsx` - 商品管理页面（主要修复）

## 总结

本次修复解决了商品管理系统更新套餐功能的核心问题：

1. ✅ **数据库字段名转换**：SQL 查询使用别名将 snake_case 转换为 camelCase
2. ✅ **移除不存在的字段**：删除 `duration_days` 的所有引用
3. ✅ **事务隔离**：在 updatePlan 中使用 client.query 保持事务一致性
4. ✅ **表单数据完整性**：自动填充 featureName 和 featureUnit
5. ✅ **React 警告修复**：正确使用 key 属性和 Spin 组件
6. ✅ **调试日志**：添加详细的日志便于排查问题

所有修复已完成并通过测试，系统现在可以正常更新套餐信息。
