# 🧪 测试支付流程指南

## 📋 测试前准备

### 1. 确认服务运行

```bash
# 检查所有服务状态
npm run status

# 应该看到：
# ✅ 后端 (3000)
# ✅ 前端 (5173)
# ✅ 营销页 (8080)
# ✅ ngrok 隧道
```

### 2. 确认 ngrok 配置

```bash
# 查看 ngrok 状态
curl http://localhost:4040/api/tunnels

# 或访问 Web 界面
open http://localhost:4040
```

### 3. 确认环境变量

```bash
# 检查 server/.env
cat server/.env | grep WECHAT_PAY_NOTIFY_URL
# 应该显示：WECHAT_PAY_NOTIFY_URL=https://xxx.ngrok-free.dev/api/payment/wechat/notify

cat server/.env | grep ALLOWED_ORIGINS
# 应该包含 ngrok 地址
```

---

## 🎯 测试步骤

### 步骤 1：访问营销页

```bash
# 在浏览器中打开
http://localhost:8080
```

### 步骤 2：登录账号

1. 点击右上角"登录"按钮
2. 输入用户名和密码
3. 登录成功后会显示用户名

### 步骤 3：选择套餐

1. 滚动到"价格方案"部分
2. 选择任意套餐（建议选专业版 ¥99）
3. 点击"点击购买"按钮

### 步骤 4：查看支付弹窗

**应该看到：**
- ✅ 标题："微信扫码支付"
- ✅ 倒计时：10:00 开始倒数
- ✅ 订单信息：套餐名称、金额
- ✅ 二维码：240x240 大小
- ✅ 扫描动画：二维码上有扫描线
- ✅ 支付步骤：1-2-3 步骤说明
- ✅ 提示信息："正在检测支付状态"

### 步骤 5：打开开发者工具

```
按 F12 或右键 -> 检查
切换到 Console 标签
```

**应该看到：**
```
查询订单状态失败: ... (正常，因为还没支付)
```

### 步骤 6：查看 Network 请求

```
切换到 Network 标签
筛选：XHR
```

**应该看到：**
- `POST /api/orders` - 创建订单（1次）
- `GET /api/orders/{orderNo}/status` - 查询状态（每2秒一次）

### 步骤 7：使用微信扫码支付

1. 打开微信
2. 点击右上角 "+"
3. 选择"扫一扫"
4. 扫描二维码
5. 确认金额
6. 输入密码完成支付

### 步骤 8：观察支付成功

**前端应该：**
1. 停止轮询
2. 显示成功页面：
   - ✅ 绿色对勾图标（带弹跳动画）
   - ✅ "支付成功！"
   - ✅ "您的 专业版 已开通"
   - ✅ 订单号
   - ✅ "正在为您跳转到系统..."
   - ✅ "立即进入系统"按钮
3. 1.5秒后自动跳转到主系统

**后端日志应该显示：**
```
[微信支付] 收到支付回调
✅ 订单状态更新成功: paid
✅ 订阅服务已开通
```

### 步骤 9：验证服务开通

1. 跳转到主系统后
2. 查看用户信息
3. 确认订阅状态已更新

---

## 🧪 测试场景

### 场景 1：正常支付流程 ✅

**操作：**
1. 选择套餐
2. 扫码支付
3. 完成支付

**预期结果：**
- ✅ 2-5秒内检测到支付成功
- ✅ 显示成功页面
- ✅ 自动跳转到系统
- ✅ 订阅服务已开通

### 场景 2：支付超时 ⏱️

**操作：**
1. 选择套餐
2. 不支付，等待 10 分钟

**预期结果：**
- ✅ 倒计时从 10:00 到 0:00
- ✅ 显示"支付超时"页面
- ✅ 停止轮询
- ✅ 提供"重新支付"按钮

### 场景 3：关闭弹窗 ❌

**操作：**
1. 选择套餐
2. 点击右上角关闭按钮

**预期结果：**
- ✅ 弹窗关闭
- ✅ 定时器被清除
- ✅ 状态重置

### 场景 4：重新支付 🔄

**操作：**
1. 支付超时后
2. 点击"重新支付"按钮

**预期结果：**
- ✅ 创建新订单
- ✅ 生成新二维码
- ✅ 倒计时重置为 10:00
- ✅ 开始新的轮询

### 场景 5：网络中断 🌐

**操作：**
1. 选择套餐
2. 断开网络
3. 等待几秒
4. 恢复网络

**预期结果：**
- ✅ 轮询继续
- ✅ 能检测到支付状态
- ✅ Console 显示错误但不影响功能

---

## 🔍 监控要点

### 1. 前端 Console

**正常日志：**
```
查询订单状态失败: ... (支付前)
```

**支付成功后：**
```
(无错误日志)
```

### 2. Network 请求

**创建订单：**
```
POST /api/orders
Status: 200
Response: {
  success: true,
  data: {
    order_no: "ORD_xxx",
    qr_code_url: "weixin://..."
  }
}
```

**查询状态（支付前）：**
```
GET /api/orders/{orderNo}/status
Status: 200
Response: {
  success: true,
  data: {
    status: "pending"
  }
}
```

**查询状态（支付后）：**
```
GET /api/orders/{orderNo}/status
Status: 200
Response: {
  success: true,
  data: {
    status: "paid"
  }
}
```

### 3. ngrok Web 界面

访问：http://localhost:4040

**应该看到：**
- 微信支付回调请求
- POST /api/payment/wechat/notify
- Status: 200
- Response: SUCCESS

### 4. 后端日志

**创建订单：**
```
创建订单: ORD_xxx
生成支付二维码成功
```

**微信回调：**
```
[微信支付] 收到支付回调
订单号: ORD_xxx
交易状态: SUCCESS
✅ 订单状态更新成功: paid
✅ 订阅服务已开通
```

---

## 🐛 常见问题排查

### 问题 1：二维码不显示

**检查：**
```bash
# 1. 查看 Console 错误
# 2. 检查 Network 请求
# 3. 确认订单创建成功
```

**可能原因：**
- 后端服务未启动
- 微信支付配置错误
- Token 过期

### 问题 2：支付后没反应

**检查：**
```bash
# 1. 查看 ngrok 是否收到回调
open http://localhost:4040

# 2. 查看后端日志
# 3. 检查轮询是否正常
```

**可能原因：**
- ngrok 未运行
- 回调 URL 配置错误
- 轮询被阻止

### 问题 3：无法跳转到系统

**检查：**
```bash
# 1. 查看 Console 错误
# 2. 检查 localStorage
localStorage.getItem('auth_token')
localStorage.getItem('refresh_token')

# 3. 检查 config.clientUrl
```

**可能原因：**
- Token 过期
- clientUrl 配置错误
- 浏览器阻止跳转

### 问题 4：倒计时不准确

**检查：**
```bash
# 1. 查看 Console
# 2. 检查定时器是否被清除
```

**可能原因：**
- 浏览器标签页被挂起
- 定时器冲突

---

## 📊 性能指标

### 轮询频率

**前 30 秒：**
- 间隔：2 秒
- 次数：15 次

**30 秒后：**
- 间隔：5 秒
- 次数：114 次（9.5 分钟）

**总计：**
- 10 分钟内：129 次查询

### 响应时间

**理想情况：**
- 支付完成 → 检测到：2-5 秒
- 显示成功页面 → 跳转：1.5 秒
- 总时长：20-30 秒

**正常情况：**
- 支付完成 → 检测到：5-10 秒
- 总时长：30-60 秒

---

## ✅ 测试清单

### 功能测试
- [ ] 创建订单成功
- [ ] 二维码正常显示
- [ ] 倒计时正常运行
- [ ] 扫描动画正常
- [ ] 支付步骤显示正确
- [ ] 轮询正常工作
- [ ] 支付成功检测
- [ ] 成功页面显示
- [ ] 自动跳转工作
- [ ] 手动跳转按钮可用

### 异常测试
- [ ] 支付超时处理
- [ ] 支付失败处理
- [ ] 关闭弹窗清理
- [ ] 重新支付功能
- [ ] 网络中断恢复
- [ ] Token 过期处理

### 性能测试
- [ ] 轮询间隔正确
- [ ] 定时器正常清理
- [ ] 内存无泄漏
- [ ] 动画流畅

### 兼容性测试
- [ ] Chrome 浏览器
- [ ] Safari 浏览器
- [ ] Firefox 浏览器
- [ ] 移动端浏览器

---

## 🎉 测试完成

如果所有测试都通过，恭喜！你的支付流程已经完美运行！🚀

**下一步：**
1. 部署到生产环境
2. 配置真实域名
3. 更新微信支付回调地址
4. 进行真实支付测试

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 `微信支付完整流程说明.md`
2. 查看 `NGROK_本地测试指南.md`
3. 检查后端日志
4. 查看 ngrok Web 界面
5. 联系技术支持
