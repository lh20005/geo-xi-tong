# ç”¨æˆ·éš”ç¦»ä¿®å¤éƒ¨ç½²æ£€æŸ¥æ¸…å•

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥

### ä»£ç å®¡æŸ¥
- [x] å®¡è®¡é…é¢ç®¡ç†æ¨¡å—
- [x] å®¡è®¡å•†å“ç®¡ç†æ¨¡å—
- [x] å®¡è®¡å­˜å‚¨ç®¡ç†æ¨¡å—
- [x] è¯†åˆ«å®‰å…¨æ¼æ´
- [x] ç¼–å†™ä¿®å¤ä»£ç 
- [x] ä»£ç æ— è¯­æ³•é”™è¯¯

### æµ‹è¯•éªŒè¯
- [ ] è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•è·¨ç”¨æˆ·æ“ä½œè¢«é˜»æ­¢
- [ ] æ‰‹åŠ¨æµ‹è¯•æ­£å¸¸æ“ä½œä»ç„¶æœ‰æ•ˆ
- [ ] éªŒè¯é”™è¯¯æ¶ˆæ¯æ­£ç¡®è¿”å›

### æ–‡æ¡£å®Œæ•´æ€§
- [x] å®‰å…¨å®¡è®¡æŠ¥å‘Šå·²åˆ›å»º
- [x] ä¿®å¤å®ŒæˆæŠ¥å‘Šå·²åˆ›å»º
- [x] æµ‹è¯•æŒ‡å—å·²åˆ›å»º
- [x] éƒ¨ç½²æ£€æŸ¥æ¸…å•å·²åˆ›å»º

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å¤‡ä»½å½“å‰ç³»ç»Ÿ
```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump -U postgres geo_optimization > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½ä»£ç 
git tag pre-user-isolation-fix-$(date +%Y%m%d)
git push origin --tags
```
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] ä»£ç æ ‡ç­¾åˆ›å»ºå®Œæˆ

### 2. æ‹‰å–æœ€æ–°ä»£ç 
```bash
cd /path/to/geo-optimization-system
git pull origin main
```
- [ ] ä»£ç æ‹‰å–æˆåŠŸ
- [ ] ç¡®è®¤åŒ…å«æœ€æ–°ä¿®å¤

### 3. å®‰è£…ä¾èµ–
```bash
cd server
npm install
```
- [ ] ä¾èµ–å®‰è£…æˆåŠŸ
- [ ] æ— é”™è¯¯æˆ–è­¦å‘Š

### 4. è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œç”¨æˆ·éš”ç¦»æµ‹è¯•
npx ts-node src/scripts/test-user-isolation-fix.ts
```
- [ ] æµ‹è¯• 1 é€šè¿‡ï¼šç”¨æˆ·å¯ä»¥æ ‡è®°è‡ªå·±çš„é¢„è­¦
- [ ] æµ‹è¯• 2 é€šè¿‡ï¼šç”¨æˆ·ä¸èƒ½æ ‡è®°å…¶ä»–ç”¨æˆ·çš„é¢„è­¦
- [ ] æµ‹è¯• 3 é€šè¿‡ï¼šæ‰¹é‡æ ‡è®°æ—¶éªŒè¯æƒé™
- [ ] æµ‹è¯• 4 é€šè¿‡ï¼šå‘åå…¼å®¹æ€§

### 5. æ„å»ºé¡¹ç›®
```bash
npm run build
```
- [ ] æ„å»ºæˆåŠŸ
- [ ] æ—  TypeScript é”™è¯¯

### 6. åœæ­¢æœåŠ¡
```bash
# å¦‚æœä½¿ç”¨ PM2
pm2 stop geo-server

# æˆ–è€…ä½¿ç”¨ systemd
sudo systemctl stop geo-server
```
- [ ] æœåŠ¡å·²åœæ­¢
- [ ] ç¡®è®¤æ— æ´»åŠ¨è¿æ¥

### 7. éƒ¨ç½²æ–°ä»£ç 
```bash
# å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°ç”Ÿäº§ç›®å½•
cp -r dist/* /path/to/production/

# æˆ–è€…ç›´æ¥åœ¨ç”Ÿäº§ç›®å½•æ„å»º
cd /path/to/production/server
npm run build
```
- [ ] æ–‡ä»¶å¤åˆ¶æˆåŠŸ
- [ ] æƒé™è®¾ç½®æ­£ç¡®

### 8. å¯åŠ¨æœåŠ¡
```bash
# å¦‚æœä½¿ç”¨ PM2
pm2 start geo-server
pm2 save

# æˆ–è€…ä½¿ç”¨ systemd
sudo systemctl start geo-server
```
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] æ— å¯åŠ¨é”™è¯¯

### 9. éªŒè¯æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
# æˆ–
sudo systemctl status geo-server

# æ£€æŸ¥æ—¥å¿—
pm2 logs geo-server --lines 50
# æˆ–
sudo journalctl -u geo-server -n 50
```
- [ ] æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] æ— é”™è¯¯æ—¥å¿—
- [ ] API å“åº”æ­£å¸¸

---

## âœ… éƒ¨ç½²åéªŒè¯

### åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯• 1: ç”¨æˆ·æ ‡è®°è‡ªå·±çš„é¢„è­¦
```bash
# 1. ç™»å½•ç”¨æˆ·1
curl -X POST http://your-domain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user1@example.com","password":"password"}'

# 2. è·å–é¢„è­¦åˆ—è¡¨
curl -X GET http://your-domain.com/api/usage/alerts/unsent \
  -H "Authorization: Bearer [TOKEN]"

# 3. æ ‡è®°é¢„è­¦
curl -X PUT http://your-domain.com/api/usage/alerts/[ALERT_ID]/mark-sent \
  -H "Authorization: Bearer [TOKEN]"
```
- [ ] è¿”å› 200 çŠ¶æ€ç 
- [ ] è¿”å›æˆåŠŸæ¶ˆæ¯
- [ ] é¢„è­¦çŠ¶æ€å·²æ›´æ–°

#### æµ‹è¯• 2: ç”¨æˆ·å°è¯•æ ‡è®°å…¶ä»–ç”¨æˆ·çš„é¢„è­¦
```bash
# 1. ä½¿ç”¨ç”¨æˆ·1çš„ token
# 2. å°è¯•æ ‡è®°ç”¨æˆ·2çš„é¢„è­¦ID
curl -X PUT http://your-domain.com/api/usage/alerts/[OTHER_USER_ALERT_ID]/mark-sent \
  -H "Authorization: Bearer [USER1_TOKEN]"
```
- [ ] è¿”å› 403 çŠ¶æ€ç 
- [ ] è¿”å› "æ— æƒæ“ä½œæ­¤é¢„è­¦" é”™è¯¯æ¶ˆæ¯
- [ ] é¢„è­¦çŠ¶æ€æœªæ”¹å˜

#### æµ‹è¯• 3: ç®¡ç†å‘˜ä¿®æ”¹å­˜å‚¨é…é¢
```bash
# 1. ç™»å½•ç®¡ç†å‘˜
curl -X POST http://your-domain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"admin_password"}'

# 2. ä¿®æ”¹ç”¨æˆ·é…é¢
curl -X PUT http://your-domain.com/api/admin/storage/quota/[USER_ID] \
  -H "Authorization: Bearer [ADMIN_TOKEN]" \
  -H "Content-Type: application/json" \
  -d '{"quotaBytes":10737418240,"reason":"æµ‹è¯•é…é¢ä¿®æ”¹"}'
```
- [ ] è¿”å› 200 çŠ¶æ€ç 
- [ ] é…é¢æ›´æ–°æˆåŠŸ
- [ ] æ“ä½œæ—¥å¿—å·²è®°å½•ï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰

### æ€§èƒ½æµ‹è¯•
```bash
# æ£€æŸ¥å“åº”æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s \
  http://your-domain.com/api/usage/quota-overview \
  -H "Authorization: Bearer [TOKEN]"
```
- [ ] å“åº”æ—¶é—´ < 500ms
- [ ] æ— æ€§èƒ½é€€åŒ–

### æ—¥å¿—æ£€æŸ¥
```bash
# æ£€æŸ¥é”™è¯¯æ—¥å¿—
grep -i "error" /path/to/logs/app.log | tail -20

# æ£€æŸ¥ç”¨æˆ·éš”ç¦»ç›¸å…³æ—¥å¿—
grep -i "æ— æƒæ“ä½œ" /path/to/logs/app.log | tail -10
```
- [ ] æ— å¼‚å¸¸é”™è¯¯
- [ ] æƒé™éªŒè¯æ—¥å¿—æ­£å¸¸

---

## ğŸ” ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- [ ] API å“åº”æ—¶é—´æ­£å¸¸
- [ ] é”™è¯¯ç‡æœªå¢åŠ 
- [ ] æ•°æ®åº“è¿æ¥æ± æ­£å¸¸
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸
- [ ] CPU ä½¿ç”¨æ­£å¸¸

### å®‰å…¨æŒ‡æ ‡
- [ ] æ— è·¨ç”¨æˆ·æ“ä½œæˆåŠŸçš„æ—¥å¿—
- [ ] 403 é”™è¯¯æ­£ç¡®è¿”å›
- [ ] æ‰€æœ‰ç”¨æˆ·æ•°æ®æŸ¥è¯¢éƒ½åŒ…å« user_id è¿‡æ»¤

---

## ğŸš¨ å›æ»šè®¡åˆ’

å¦‚æœéƒ¨ç½²åå‘ç°é—®é¢˜ï¼Œæ‰§è¡Œä»¥ä¸‹å›æ»šæ­¥éª¤ï¼š

### 1. åœæ­¢æœåŠ¡
```bash
pm2 stop geo-server
```

### 2. æ¢å¤ä»£ç 
```bash
git checkout pre-user-isolation-fix-[DATE]
cd server
npm install
npm run build
```

### 3. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
psql -U postgres geo_optimization < backup_[TIMESTAMP].sql
```

### 4. é‡å¯æœåŠ¡
```bash
pm2 start geo-server
```

### 5. éªŒè¯å›æ»š
```bash
pm2 status
pm2 logs geo-server
```

---

## ğŸ“ é—®é¢˜å¤„ç†

### å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: æµ‹è¯•å¤±è´¥
**ç—‡çŠ¶**: è‡ªåŠ¨åŒ–æµ‹è¯•ä¸é€šè¿‡  
**æ’æŸ¥**:
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. æ£€æŸ¥æµ‹è¯•ç”¨æˆ·æ˜¯å¦å­˜åœ¨
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

#### é—®é¢˜ 2: æœåŠ¡å¯åŠ¨å¤±è´¥
**ç—‡çŠ¶**: PM2 æ˜¾ç¤ºæœåŠ¡ errored  
**æ’æŸ¥**:
1. æŸ¥çœ‹ PM2 æ—¥å¿—: `pm2 logs geo-server`
2. æ£€æŸ¥ç«¯å£å ç”¨: `lsof -i :3000`
3. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

#### é—®é¢˜ 3: API è¿”å› 500 é”™è¯¯
**ç—‡çŠ¶**: æ‰€æœ‰è¯·æ±‚è¿”å› 500  
**æ’æŸ¥**:
1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. éªŒè¯ç¯å¢ƒå˜é‡

### ç´§æ€¥è”ç³»
- **å¼€å‘å›¢é˜Ÿ**: dev@example.com
- **è¿ç»´å›¢é˜Ÿ**: ops@example.com
- **å®‰å…¨å›¢é˜Ÿ**: security@example.com

---

## ğŸ“ éƒ¨ç½²è®°å½•

### éƒ¨ç½²ä¿¡æ¯
- **éƒ¨ç½²æ—¥æœŸ**: _______________
- **éƒ¨ç½²äººå‘˜**: _______________
- **éƒ¨ç½²ç¯å¢ƒ**: [ ] å¼€å‘ [ ] æµ‹è¯• [ ] ç”Ÿäº§
- **ç‰ˆæœ¬å·**: _______________

### æ£€æŸ¥ç­¾å
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡ - ç­¾å: _______________
- [ ] æµ‹è¯•éªŒè¯é€šè¿‡ - ç­¾å: _______________
- [ ] éƒ¨ç½²æ‰§è¡Œå®Œæˆ - ç­¾å: _______________
- [ ] éªŒè¯æµ‹è¯•é€šè¿‡ - ç­¾å: _______________

### å¤‡æ³¨
```
è®°å½•ä»»ä½•ç‰¹æ®Šæƒ…å†µã€é—®é¢˜æˆ–æ³¨æ„äº‹é¡¹ï¼š




```

---

## âœ¨ éƒ¨ç½²å®Œæˆ

æ­å–œï¼ç”¨æˆ·éš”ç¦»å®‰å…¨ä¿®å¤å·²æˆåŠŸéƒ¨ç½²ã€‚

**ä¸‹ä¸€æ­¥**:
1. æŒç»­ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. å®šæœŸæ£€æŸ¥å®‰å…¨æ—¥å¿—
4. è®¡åˆ’ä¸‹ä¸€æ¬¡å®‰å…¨å®¡è®¡

**ç›¸å…³æ–‡æ¡£**:
- å®‰å…¨å®¡è®¡æŠ¥å‘Š: `USER_ISOLATION_SECURITY_AUDIT.md`
- ä¿®å¤å®ŒæˆæŠ¥å‘Š: `USER_ISOLATION_FIX_COMPLETE.md`
- æµ‹è¯•æŒ‡å—: `QUICK_TEST_USER_ISOLATION.md`
- ä¸­æ–‡æ€»ç»“: `ç”¨æˆ·éš”ç¦»å®‰å…¨ä¿®å¤æ€»ç»“.md`
