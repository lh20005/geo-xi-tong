# 功能配额从每日改为每月

## 修改时间
2026-01-04

## 修改目标
将系统中所有"每日"配额改为"每月"配额，包括：
- 每日生成文章数 → 每月生成文章数
- 每日发布文章数 → 每月发布文章数

## 修改原因
1. **更符合实际使用场景**：用户通常按月规划内容营销
2. **减少配额重置频率**：从每天重置改为每月重置
3. **提升用户体验**：每月配额更灵活，用户可以自由分配使用时间

## 修改内容

### 1. 前端修改

#### 1.1 商品管理页面
**文件**：`client/src/pages/ProductManagementPage.tsx`

```typescript
// 修改前
const featureOptions = [
  { code: 'articles_per_day', name: '每日生成文章数', unit: '篇' },
  { code: 'publish_per_day', name: '每日发布文章数', unit: '篇' },
  ...
];

// 修改后
const featureOptions = [
  { code: 'articles_per_month', name: '每月生成文章数', unit: '篇' },
  { code: 'publish_per_month', name: '每月发布文章数', unit: '篇' },
  ...
];
```

### 2. 后端修改

#### 2.1 功能配置
**文件**：`server/src/config/features.ts`

```typescript
// 修改前
export const FEATURE_DEFINITIONS = {
  articles_per_day: {
    code: 'articles_per_day',
    name: '每日生成文章数',
    unit: '篇',
    defaultValue: 10,
    resetPeriod: 'daily' as const
  },
  publish_per_day: {
    code: 'publish_per_day',
    name: '每日发布文章数',
    unit: '篇',
    defaultValue: 20,
    resetPeriod: 'daily' as const
  },
  ...
};

// 修改后
export const FEATURE_DEFINITIONS = {
  articles_per_month: {
    code: 'articles_per_month',
    name: '每月生成文章数',
    unit: '篇',
    defaultValue: 100,
    resetPeriod: 'monthly' as const
  },
  publish_per_month: {
    code: 'publish_per_month',
    name: '每月发布文章数',
    unit: '篇',
    defaultValue: 200,
    resetPeriod: 'monthly' as const
  },
  ...
};
```

#### 2.2 定时任务
**文件**：`server/src/services/SchedulerService.ts`

```typescript
// 修改前
private scheduleDailyQuotaResetTask() {
  const task = cron.schedule('0 0 * * *', async () => {  // 每天00:00
    // 重置每日配额
    await pool.query(`
      DELETE FROM user_usage 
      WHERE feature_code IN ('articles_per_day', 'publish_per_day')
    `);
  });
}

// 修改后
private scheduleMonthlyQuotaResetTask() {
  const task = cron.schedule('0 0 1 * *', async () => {  // 每月1号00:00
    // 重置每月配额
    await pool.query(`
      DELETE FROM user_usage 
      WHERE feature_code IN ('articles_per_month', 'publish_per_month')
    `);
  });
}
```

#### 2.3 使用追踪服务
**文件**：`server/src/services/UsageTrackingService.ts`

更新 SQL 查询中的 CASE 语句，将 `articles_per_day` 改为 `articles_per_month`，`publish_per_day` 改为 `publish_per_month`。

#### 2.4 配额预警服务
**文件**：`server/src/services/QuotaAlertService.ts`

更新 SQL 查询中的 CASE 语句，将功能代码和名称改为每月版本。

### 3. 数据库迁移

#### 3.1 迁移文件
**文件**：`server/src/db/migrations/016_change_daily_to_monthly_quotas.sql`

```sql
-- 1. 更新 plan_features 表中的功能代码和名称
UPDATE plan_features 
SET 
  feature_code = 'articles_per_month',
  feature_name = '每月生成文章数',
  feature_value = feature_value * 30  -- 每日 * 30 = 每月
WHERE feature_code = 'articles_per_day';

UPDATE plan_features 
SET 
  feature_code = 'publish_per_month',
  feature_name = '每月发布文章数',
  feature_value = feature_value * 30  -- 每日 * 30 = 每月
WHERE feature_code = 'publish_per_day';

-- 2. 更新 user_usage 表中的功能代码
UPDATE user_usage 
SET feature_code = 'articles_per_month'
WHERE feature_code = 'articles_per_day';

UPDATE user_usage 
SET feature_code = 'publish_per_month'
WHERE feature_code = 'publish_per_day';

-- 3. 更新 quota_alerts 表中的功能代码
UPDATE quota_alerts 
SET feature_code = 'articles_per_month'
WHERE feature_code = 'articles_per_day';

UPDATE quota_alerts 
SET feature_code = 'publish_per_month'
WHERE feature_code = 'publish_per_day';
```

#### 3.2 执行迁移
```bash
cd server
npx ts-node src/db/run-migration-016.ts
```

**执行结果**：
```
✅ 迁移 016 执行成功！
已将每日配额改为每月配额

更新后的功能配额:
  - 每月生成文章数 (articles_per_month): 4个套餐
  - 每月发布文章数 (publish_per_month): 4个套餐
```

#### 3.3 修复配额值
由于原来无限制的配额（-1）乘以30变成了-30，需要修复：

```sql
-- 修复无限制配额
UPDATE plan_features 
SET feature_value = -1 
WHERE feature_value < 0 
AND feature_code IN ('articles_per_month', 'publish_per_month');

-- 修复免费版配额（从1改为30）
UPDATE plan_features 
SET feature_value = 30
WHERE feature_code IN ('articles_per_month', 'publish_per_month')
AND plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free');
```

## 配额对比

### 修改前（每日配额）
| 套餐 | 每日生成 | 每日发布 |
|------|---------|---------|
| 免费版 | 1篇 | 1篇 |
| 专业版 | 100篇 | 200篇 |
| 企业版 | 不限 | 不限 |
| 加量包 | 5篇 | 5篇 |

### 修改后（每月配额）
| 套餐 | 每月生成 | 每月发布 |
|------|---------|---------|
| 免费版 | 30篇 | 30篇 |
| 专业版 | 3000篇 | 6000篇 |
| 企业版 | 不限 | 不限 |
| 加量包 | 150篇 | 150篇 |

**换算说明**：每日配额 × 30 = 每月配额

## 定时任务变更

### 修改前
- **任务名称**：每日配额重置任务
- **执行时间**：每天 00:00
- **Cron 表达式**：`0 0 * * *`
- **重置内容**：articles_per_day, publish_per_day

### 修改后
- **任务名称**：每月配额重置任务
- **执行时间**：每月1号 00:00
- **Cron 表达式**：`0 0 1 * *`
- **重置内容**：articles_per_month, publish_per_month

## 影响范围

### 1. 数据库表
- ✅ `plan_features` - 功能配额定义
- ✅ `user_usage` - 用户使用记录
- ✅ `quota_alerts` - 配额预警记录

### 2. 后端服务
- ✅ `SchedulerService` - 定时任务服务
- ✅ `UsageTrackingService` - 使用追踪服务
- ✅ `QuotaAlertService` - 配额预警服务
- ✅ `features.ts` - 功能配置

### 3. 前端页面
- ✅ `ProductManagementPage` - 商品管理页面
- ✅ `UserCenterPage` - 用户中心页面（显示配额）
- ✅ 落地页 - 套餐展示（自动更新）

## 测试验证

### 1. 数据库验证
```sql
-- 查看所有套餐的每月配额
SELECT 
  sp.plan_name, 
  pf.feature_name, 
  pf.feature_value, 
  pf.feature_unit 
FROM plan_features pf 
JOIN subscription_plans sp ON sp.id = pf.plan_id 
WHERE pf.feature_code IN ('articles_per_month', 'publish_per_month') 
ORDER BY sp.display_order, pf.feature_code;
```

**预期结果**：
- 所有功能代码都是 `articles_per_month` 和 `publish_per_month`
- 所有功能名称都是"每月生成文章数"和"每月发布文章数"
- 配额值合理（免费版30，专业版3000/6000，企业版-1）

### 2. 商品管理页面测试
1. 登录管理员账号
2. 进入"商品管理"页面
3. 点击"编辑"任意套餐
4. 查看功能配额下拉选项
5. 验证：
   - ✅ 选项显示"每月生成文章数"
   - ✅ 选项显示"每月发布文章数"
   - ✅ 没有"每日"相关选项

### 3. 用户中心测试
1. 登录普通用户账号
2. 查看"我的套餐"区域
3. 验证：
   - ✅ 显示"每月生成文章数"
   - ✅ 显示"每月发布文章数"
   - ✅ 显示正确的配额值

### 4. 落地页测试
1. 访问 `http://localhost:8080`
2. 滚动到"灵活的使用方案"区域
3. 验证：
   - ✅ 功能列表显示"每月生成文章数"
   - ✅ 功能列表显示"每月发布文章数"
   - ✅ 配额值正确

### 5. 定时任务测试
```bash
# 查看定时任务日志
tail -f server/logs/app.log | grep "配额重置"
```

**预期输出**：
```
✅ 每月配额重置任务已安排（每月1号00:00执行）
```

## 相关文件清单

### 前端文件
- ✅ `client/src/pages/ProductManagementPage.tsx`
- ✅ `client/src/pages/UserCenterPage.tsx`

### 后端文件
- ✅ `server/src/config/features.ts`
- ✅ `server/src/services/SchedulerService.ts`
- ✅ `server/src/services/UsageTrackingService.ts`
- ✅ `server/src/services/QuotaAlertService.ts`

### 数据库文件
- ✅ `server/src/db/migrations/016_change_daily_to_monthly_quotas.sql`
- ✅ `server/src/db/run-migration-016.ts`

### 文档文件
- ✅ `功能配额从每日改为每月.md` - 本文档

## 注意事项

### 1. 现有用户影响
- 所有用户的配额自动转换为每月配额
- 配额值按 30 倍增加（每日 × 30 = 每月）
- 无需用户手动操作

### 2. 配额重置时间
- **修改前**：每天 00:00 重置
- **修改后**：每月1号 00:00 重置
- 用户有更长的时间使用配额

### 3. 配额计算
- 每月配额在月初重置
- 用户可以在整个月内自由分配使用
- 未使用的配额不会累积到下个月

### 4. 兼容性
- 旧的 `articles_per_day` 和 `publish_per_day` 代码已全部更新
- 数据库中的旧数据已全部迁移
- 不影响其他功能（平台账号数、关键词蒸馏数）

## 后续工作

### 短期
1. ✅ 监控定时任务执行情况
2. ✅ 收集用户反馈
3. ✅ 观察配额使用模式

### 长期
1. 考虑添加配额使用统计图表
2. 考虑添加配额使用提醒功能
3. 考虑提供配额购买/升级建议

## 总结

本次修改将系统中所有"每日"配额改为"每月"配额，涉及前端、后端和数据库三个层面。通过数据库迁移，所有现有数据都已自动转换，用户无需任何操作。新的每月配额制度更符合实际使用场景，提升了用户体验。

### 核心变更
- ✅ 功能代码：`articles_per_day` → `articles_per_month`
- ✅ 功能代码：`publish_per_day` → `publish_per_month`
- ✅ 配额值：每日 × 30 = 每月
- ✅ 重置周期：每天 → 每月1号
- ✅ 所有相关代码和数据已更新

**修改已完成，系统可以正常使用！**
