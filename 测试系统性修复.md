# 测试系统性修复

## 修复内容总结

已修复所有文件上传和删除路由的事务问题：
- ✅ `server/src/routes/gallery.ts` - 图库上传和删除
- ✅ `server/src/routes/knowledgeBase.ts` - 知识库上传和删除
- ✅ `server/src/routes/article.ts` - 文章保存

## 测试步骤

### 1. 修复历史数据

首先修复所有现有用户的数据不一致问题：

```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

预期输出：
```
=== 修复所有用户存储同步问题 ===
找到 X 个有文件的用户
🔧 修复用户: xxx (ID: xxx)
   图片: ...
   文档: ...
✅ 成功修复: X 个用户
```

### 2. 验证 testuser2

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

预期结果：
- ✅ 存储空间充足
- ✅ 已使用量与实际文件一致
- ✅ 没有数据不一致警告

### 3. 测试新上传（关键测试）

#### 3.1 测试图库上传

1. 登录为 testuser2
2. 进入"企业图库"
3. 创建或选择一个相册
4. 上传一张图片（约 500KB）
5. 检查是否成功

**验证点**：
```bash
# 运行诊断
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 图片数量增加 1
- 总使用量增加约 500KB
- 没有数据不一致

#### 3.2 测试知识库上传

1. 进入"企业知识库"
2. 创建或选择一个知识库
3. 上传一个文档（约 100KB）
4. 检查是否成功

**验证点**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 文档数量增加 1
- 总使用量增加约 100KB
- 没有数据不一致

#### 3.3 测试文章生成

1. 进入"内容生成"
2. 生成一篇文章
3. 检查是否成功保存

**验证点**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 文章存储使用量增加
- 总使用量相应增加

### 4. 测试删除操作

#### 4.1 删除图片

1. 在图库中删除一张图片
2. 确认删除成功

**验证点**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 图片数量减少 1
- 总使用量减少相应大小
- 没有数据不一致

#### 4.2 删除文档

1. 在知识库中删除一个文档
2. 确认删除成功

**验证点**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 文档数量减少 1
- 总使用量减少相应大小
- 没有数据不一致

### 5. 测试事务回滚（高级测试）

这个测试需要模拟失败场景，确保事务正确回滚。

#### 5.1 模拟数据库错误

临时修改代码，在事务中抛出错误：

```typescript
// 在 gallery.ts 的事务中添加
await client.query('BEGIN');
// ... 插入图片
throw new Error('测试事务回滚'); // 添加这行
await client.query('COMMIT');
```

上传图片，应该：
- ❌ 上传失败
- ✅ 数据库没有记录
- ✅ 存储使用量没有变化
- ✅ 文件被清理

**验证**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

数据应该没有任何变化。

### 6. 测试并发上传

同时上传多个文件，确保事务隔离：

1. 在图库中选择多个图片（5-10张）
2. 同时上传
3. 等待全部完成

**验证点**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

应该看到：
- 所有图片都成功上传
- 总使用量 = 所有图片大小之和
- 没有数据不一致

### 7. 测试配额限制

#### 7.1 接近配额

上传文件直到接近配额（如 90%）：

**验证点**：
- ✅ 可以上传
- ✅ 显示警告（接近配额）
- ✅ 存储使用量正确更新

#### 7.2 超出配额

尝试上传一个会超出配额的大文件：

**预期行为**：
- ❌ 上传被拒绝
- 显示错误消息："存储空间不足"
- 显示当前使用量和可用空间
- 数据库没有任何变化

**验证**：
```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

使用量应该没有变化。

### 8. 压力测试

#### 8.1 快速连续上传

快速连续上传 20 个小文件（每个 10KB）：

```bash
# 可以使用脚本自动化
for i in {1..20}; do
  # 上传文件
  sleep 0.1
done
```

**验证点**：
- ✅ 所有文件都成功上传
- ✅ 总使用量 = 20 × 10KB = 200KB
- ✅ 没有数据不一致
- ✅ 没有重复记录

#### 8.2 快速连续删除

快速连续删除刚上传的 20 个文件：

**验证点**：
- ✅ 所有文件都成功删除
- ✅ 总使用量恢复到之前的值
- ✅ 没有数据不一致

### 9. 运行自动化测试

```bash
cd server
npm test -- storage-e2e.test.ts
```

所有测试应该通过：
- ✅ 基本存储操作
- ✅ 配额检查
- ✅ 并发操作
- ✅ 事务回滚
- ✅ 用户隔离

## 成功标准

### 功能正确性

- ✅ 上传文件后，存储使用量立即更新
- ✅ 删除文件后，存储使用量立即减少
- ✅ 配额检查正确工作
- ✅ 超出配额时正确拒绝

### 数据一致性

- ✅ 存储使用量始终等于实际文件大小
- ✅ 没有孤立文件（文件存在但没有记录）
- ✅ 没有幽灵记录（记录存在但文件不存在）
- ✅ 事务失败时正确回滚

### 性能

- ✅ 上传响应时间 < 2秒（小文件）
- ✅ 删除响应时间 < 1秒
- ✅ 并发上传不会导致死锁
- ✅ 缓存正确工作

### 错误处理

- ✅ 事务失败时正确回滚
- ✅ 文件清理正确执行
- ✅ 错误消息清晰明确
- ✅ 不会留下脏数据

## 监控检查点

### 日志检查

查看后端日志，确保没有错误：

```bash
# 查看最近的日志
tail -f server/logs/app.log | grep -E "(Storage|Gallery|Knowledge)"
```

应该看到：
- `[StorageService]` 正常操作日志
- `[StorageQuotaService]` 配额检查日志
- 没有错误或警告

### 数据库检查

```sql
-- 检查是否有数据不一致
SELECT 
  u.username,
  usu.total_storage_bytes as recorded,
  (
    SELECT COALESCE(SUM(i.size), 0)
    FROM images i
    JOIN albums a ON i.album_id = a.id
    WHERE a.user_id = u.id
  ) +
  (
    SELECT COALESCE(SUM(kd.file_size), 0)
    FROM knowledge_documents kd
    JOIN knowledge_bases kb ON kd.knowledge_base_id = kb.id
    WHERE kb.user_id = u.id
  ) as actual,
  usu.total_storage_bytes - (
    SELECT COALESCE(SUM(i.size), 0)
    FROM images i
    JOIN albums a ON i.album_id = a.id
    WHERE a.user_id = u.id
  ) - (
    SELECT COALESCE(SUM(kd.file_size), 0)
    FROM knowledge_documents kd
    JOIN knowledge_bases kb ON kd.knowledge_base_id = kb.id
    WHERE kb.user_id = u.id
  ) as difference
FROM users u
JOIN user_storage_usage usu ON u.id = usu.user_id
WHERE usu.total_storage_bytes > 0
HAVING ABS(difference) > 1024; -- 差异超过 1KB
```

应该返回 0 行（没有不一致）。

### Redis 检查

```bash
redis-cli
> KEYS storage:user:*
> GET storage:user:438
```

确保缓存数据正确。

## 回归测试

在修复后，确保其他功能没有受影响：

1. ✅ 用户登录和认证
2. ✅ 订阅和支付
3. ✅ 内容生成
4. ✅ 平台发布
5. ✅ 仪表盘显示

## 故障排查

### 如果测试失败

1. **检查事务是否正确提交**
   ```bash
   # 查看数据库日志
   tail -f /usr/local/var/postgres/server.log
   ```

2. **检查文件是否被清理**
   ```bash
   ls -la server/uploads/gallery/
   ls -la server/uploads/knowledge/
   ```

3. **检查存储事务记录**
   ```sql
   SELECT * FROM storage_transactions 
   WHERE user_id = 438 
   ORDER BY created_at DESC 
   LIMIT 10;
   ```

4. **重新运行修复脚本**
   ```bash
   cd server
   npx ts-node src/scripts/fix-all-users-storage-sync.ts
   ```

### 如果仍有问题

1. 检查数据库函数是否存在：
   ```sql
   \df record_storage_usage
   ```

2. 检查表结构：
   ```sql
   \d user_storage_usage
   \d storage_transactions
   ```

3. 查看详细错误日志：
   ```bash
   cd server
   npm run server:dev
   # 然后执行操作，观察控制台输出
   ```

## 部署前检查清单

- [ ] 所有测试通过
- [ ] 历史数据已修复
- [ ] 没有数据不一致
- [ ] 日志没有错误
- [ ] 性能符合预期
- [ ] 文档已更新
- [ ] 团队已通知

## 部署后验证

1. 立即运行诊断脚本
2. 监控错误日志 24 小时
3. 检查用户反馈
4. 一周后运行对账脚本

## 总结

这是一个**彻底的系统性修复**，通过：
1. 修复代码架构问题（添加事务保护）
2. 修复历史数据（对账脚本）
3. 建立监控机制（诊断工具）
4. 完善测试覆盖（自动化测试）

确保了系统的长期稳定性和数据一致性。
