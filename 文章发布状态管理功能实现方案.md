# 文章发布状态管理功能实现方案

## 功能需求

1. **发布任务页面**：已发布的文章自动从"选择文章"列表中去除
2. **发布记录页面**：自动显示已发布的文章
3. **文章管理页面**：已发布文章的状态从"草稿"改为"已发布"
4. **发布成功后**：自动更新文章的发布状态

## 技术方案

### 1. 数据库层面

#### 1.1 文章表已有字段
- `is_published` (BOOLEAN): 发布状态标记
- `published_at` (TIMESTAMP): 发布时间

#### 1.2 需要添加的表：发布记录表
创建一个新表来记录文章在各个平台的发布情况：

```sql
CREATE TABLE IF NOT EXISTS publishing_records (
  id SERIAL PRIMARY KEY,
  article_id INTEGER NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
  task_id INTEGER NOT NULL REFERENCES publishing_tasks(id) ON DELETE CASCADE,
  platform_id VARCHAR(50) NOT NULL,
  account_id INTEGER NOT NULL REFERENCES platform_accounts(id) ON DELETE CASCADE,
  platform_article_id VARCHAR(255),  -- 平台返回的文章ID
  platform_url VARCHAR(500),          -- 平台文章链接
  published_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_publishing_records_article ON publishing_records(article_id);
CREATE INDEX IF NOT EXISTS idx_publishing_records_task ON publishing_records(task_id);
CREATE INDEX IF NOT EXISTS idx_publishing_records_platform ON publishing_records(platform_id);
```

### 2. 后端实现

#### 2.1 数据库迁移文件
创建 `server/src/db/migrations/007_add_publishing_records.sql`

#### 2.2 更新 PublishingExecutor
在发布成功后：
1. 创建发布记录
2. 更新文章的 `is_published` 和 `published_at` 字段

#### 2.3 新增 API 接口

**发布记录相关：**
- `GET /api/publishing/records` - 获取发布记录列表
- `GET /api/publishing/records/:id` - 获取发布记录详情
- `GET /api/articles/:id/publishing-records` - 获取某篇文章的所有发布记录

**文章状态更新：**
- 在 `PublishingExecutor.executeTask()` 成功后自动更新

### 3. 前端实现

#### 3.1 发布任务页面 (PublishingTasksPage.tsx)
- 修改文章列表查询：只显示 `is_published = false` 的文章
- 已经实现：`publishStatus: 'unpublished'` 筛选

#### 3.2 发布记录页面 (PublishingRecordsPage.tsx)
- 修改为显示发布记录表的数据
- 显示文章在各个平台的发布情况
- 支持按平台、时间筛选

#### 3.3 文章管理页面 (ArticleListPage.tsx)
- 已经实现：显示 `is_published` 状态
- 已经实现：显示 `published_at` 时间

### 4. 实现流程

```
用户创建发布任务
    ↓
PublishingExecutor 执行任务
    ↓
发布成功
    ↓
1. 更新 publishing_tasks.status = 'success'
2. 创建 publishing_records 记录
3. 更新 articles.is_published = true
4. 更新 articles.published_at = CURRENT_TIMESTAMP
    ↓
前端自动刷新
    ↓
- 发布任务页面：文章从列表中消失
- 发布记录页面：显示新的发布记录
- 文章管理页面：状态变为"已发布"
```

## 实现细节

### 数据一致性保证
- 使用数据库事务确保状态更新的原子性
- 发布记录创建失败时回滚文章状态更新

### 多平台发布处理
- 同一篇文章可以发布到多个平台
- 只要有一个平台发布成功，文章状态就标记为"已发布"
- 发布记录表记录每个平台的发布情况

### 重新发布处理
- 已发布的文章可以重新发布到其他平台
- 不改变原有的发布状态
- 在发布记录表中新增记录

## 优势

1. **数据完整性**：通过发布记录表完整记录每次发布的详细信息
2. **可追溯性**：可以查看文章在哪些平台发布过
3. **灵活性**：支持同一文章多平台发布
4. **用户体验**：自动过滤已发布文章，避免重复发布
