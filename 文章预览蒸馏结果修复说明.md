# 文章预览蒸馏结果修复说明

## 问题描述

在发布任务页面点击预览文章时，预览模态框中的"蒸馏结果"字段显示为空。

## 问题原因

服务端 API `GET /articles/:id` 在获取文章详情时，只查询了 `articles` 表的字段，没有关联查询 `topics` 表来获取蒸馏结果（`topic_question`）。

### 修复前的查询

```sql
SELECT 
  id, title, keyword, distillation_id, topic_id, task_id, requirements,
  content, image_url, provider, is_published, published_at, created_at, updated_at
FROM articles 
WHERE id = $1
```

这个查询只返回了 `topic_id`，但没有返回对应的 `topic_question`（蒸馏结果）。

## 解决方案

修改服务端 API，使用 LEFT JOIN 关联查询相关表，获取完整的文章信息。

### 修复后的查询

```sql
SELECT 
  a.id,
  a.title,
  a.keyword,
  a.distillation_id,
  d.keyword as distillation_keyword,
  a.topic_id,
  t.question as topic_question,          -- 蒸馏结果
  a.task_id,
  gt.conversion_target_id,
  ct.company_name as conversion_target_name,
  a.requirements,
  a.content,
  a.image_url,
  a.provider,
  a.is_published,
  a.published_at,
  a.created_at,
  a.updated_at
FROM articles a
LEFT JOIN distillations d ON a.distillation_id = d.id
LEFT JOIN topics t ON a.topic_id = t.id                    -- 关联话题表
LEFT JOIN generation_tasks gt ON a.task_id = gt.id
LEFT JOIN conversion_targets ct ON gt.conversion_target_id = ct.id
WHERE a.id = $1
```

### 返回的数据结构

```typescript
{
  id: number;
  title?: string;
  keyword: string;
  distillationId?: number;
  distillationKeyword?: string;
  topicId?: number;
  topicQuestion?: string;              // 蒸馏结果（话题问题）
  taskId?: number;
  conversionTargetId?: number;
  conversionTargetName?: string;
  requirements?: string;
  content: string;
  imageUrl?: string;
  provider: string;
  isPublished: boolean;
  publishedAt?: string;
  createdAt: string;
  updatedAt: string;
}
```

## 修改的文件

- `server/src/routes/article.ts` - 文章详情 API

## 数据库表关系

```
articles (文章表)
├── distillation_id → distillations.id (蒸馏配置)
├── topic_id → topics.id (话题/蒸馏结果)
├── task_id → generation_tasks.id (生成任务)
└── conversion_target_id (通过 generation_tasks) → conversion_targets.id (转化目标)
```

## 测试验证

修复后，预览文章时应该能够正确显示：

1. **关键词**：文章的关键词
2. **蒸馏结果**：对应的话题问题（topic_question）
3. **创建时间**：文章创建时间
4. **发布状态**：已发布/未发布

## 注意事项

1. 使用 LEFT JOIN 确保即使文章没有关联的 topic_id，也能正常返回文章数据
2. 返回的字段名使用驼峰命名（camelCase），与前端保持一致
3. 该修复同时也完善了文章详情 API，使其返回更完整的关联信息

## 相关功能

该修复同时改善了以下功能：
- 文章预览功能
- 文章详情查看
- 文章编辑页面的数据加载

## 数据一致性

修复后，文章详情 API (`GET /articles/:id`) 返回的数据结构与文章列表 API (`GET /articles`) 保持一致，都包含完整的关联信息。
