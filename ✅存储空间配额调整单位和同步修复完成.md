# ✅ 存储空间配额调整单位和同步修复完成

## 修复概述

修复了用户管理中调整存储空间配额的两个问题：
1. **单位显示问题**：配额调整界面没有显示 MB 单位
2. **同步问题**：调整配额后，用户个人中心没有实时更新

## 修复详情

### 问题 1: 配额调整界面缺少单位显示

**现象**：
- 在用户管理 > 订阅详情 > 调整配额中
- 选择"存储空间"功能时
- 输入框和显示值都没有单位标识
- 用户不清楚应该输入什么单位的值

**修复内容**：

#### 文件：`client/src/components/UserSubscription/AdjustQuotaModal.tsx`

1. **输入框添加单位后缀**
```typescript
<InputNumber
  style={{ width: '100%' }}
  min={-1}
  placeholder="请输入新配额值（MB）"
  addonAfter={selectedFeature?.feature_code === 'storage_space' ? 'MB' : undefined}
/>
```

2. **标签显示单位说明**
```typescript
label={
  selectedFeature?.feature_code === 'storage_space' 
    ? '新配额值 (MB)' 
    : '新配额值'
}
```

3. **提示文本说明单位**
```typescript
extra={
  selectedFeature?.feature_code === 'storage_space'
    ? '-1 表示无限制，单位为 MB（1024 MB = 1 GB）'
    : '-1 表示无限制'
}
```

4. **下拉选项格式化显示**
```typescript
// 自动转换 MB/GB 显示
const formatValue = (value: number, featureCode: string) => {
  if (value === -1) return '无限制';
  if (featureCode === 'storage_space') {
    return value >= 1024 
      ? `${(value / 1024).toFixed(1)} GB` 
      : `${value} MB`;
  }
  return value.toString();
};
```

5. **当前配额信息格式化**
```typescript
<p>
  配额限制：
  {selectedFeature.feature_value === -1 
    ? '无限制' 
    : selectedFeature.feature_code === 'storage_space'
      ? (selectedFeature.feature_value >= 1024 
          ? `${(selectedFeature.feature_value / 1024).toFixed(1)} GB` 
          : `${selectedFeature.feature_value} MB`)
      : selectedFeature.feature_value}
</p>
```

### 问题 2: 配额调整后个人中心不同步

**现象**：
- 管理员调整用户的存储空间配额后
- 用户在个人中心的"存储空间"标签页
- 配额值不会自动更新
- 需要手动刷新页面才能看到新配额

**原因分析**：
- 后端调整配额时只发送了通用的 `quota:adjusted` 事件
- 个人中心监听的是 `storage_quota_changed` 事件
- 两个事件不匹配，导致无法触发更新

**修复内容**：

#### 文件：`server/src/services/UserSubscriptionManagementService.ts`

在 `adjustQuota` 方法中，当调整存储空间配额时，额外发送存储专用事件：

```typescript
await client.query('COMMIT');

// 发送 WebSocket 通知
getWsService().sendToUser(userId, 'quota:adjusted', {
  featureCode,
  oldValue,
  newValue,
});

// 如果是存储空间配额调整，额外发送存储配额变更通知
if (featureCode === 'storage_space') {
  getWsService().sendToUser(userId, 'storage_quota_changed', {
    userId,
    newQuotaMB: newValue,
    oldQuotaMB: oldValue,
  });
}
```

**工作流程**：
```
管理员调整配额
    ↓
UserSubscriptionManagementService.adjustQuota()
    ↓
更新数据库 (custom_quotas)
    ↓
发送两个 WebSocket 事件：
  1. quota:adjusted (通用事件)
  2. storage_quota_changed (存储专用事件)
    ↓
用户个人中心监听 storage_quota_changed
    ↓
调用 fetchStorageData() 刷新存储数据
    ↓
UI 自动更新（无需刷新页面）
```

## 修改的文件

1. `client/src/components/UserSubscription/AdjustQuotaModal.tsx` - 配额调整模态框
2. `server/src/services/UserSubscriptionManagementService.ts` - 配额调整服务

## 测试验证

### 自动化测试

运行测试脚本：
```bash
./快速测试配额调整.sh
```

测试内容：
- ✅ 查找测试用户和管理员
- ✅ 检查用户订阅状态
- ✅ 获取当前存储使用情况
- ✅ 调整存储空间配额
- ✅ 验证配额已更新
- ✅ 检查调整历史记录
- ✅ 验证 API 返回正确配额

### 手动测试

#### 测试 1: 单位显示

1. 登录管理员账号
2. 进入"用户管理"页面
3. 点击任意用户的"订阅详情"
4. 点击"调整配额"按钮
5. 在功能下拉框中选择"存储空间"

**验证点**：
- ✅ 下拉选项显示：`存储空间 (当前: 100 MB, 已用: 10 MB)`
- ✅ 大于 1024 MB 自动显示为 GB：`(当前: 1.5 GB, 已用: 500 MB)`
- ✅ 输入框标签显示：`新配额值 (MB)`
- ✅ 输入框右侧显示 "MB" 后缀
- ✅ 提示文本：`-1 表示无限制，单位为 MB（1024 MB = 1 GB）`
- ✅ 当前配额信息卡片中，配额和使用量都显示单位

#### 测试 2: 实时同步

**准备**：
```bash
# 启动后端
cd server && npm run dev

# 启动前端
cd client && npm run dev
```

**步骤**：

1. **打开两个浏览器窗口**：
   - 窗口A：管理员账号 → 用户管理
   - 窗口B：普通用户（testuser）→ 个人中心 → 存储空间标签页

2. **记录初始状态**：
   - 在窗口B中查看当前存储配额（例如：100 MB）

3. **调整配额**：
   - 在窗口A中，找到 testuser
   - 点击"订阅详情" → "调整配额"
   - 选择"存储空间"
   - 输入新配额值：`200`
   - 输入调整原因：`测试配额同步`
   - 点击"确认"

4. **验证同步**（窗口B，无需刷新）：
   - ✅ 弹出提示：`存储配额已更新`
   - ✅ 存储配额自动更新为 200 MB
   - ✅ 进度条和百分比自动更新
   - ✅ 可用空间自动更新
   - ✅ 使用率重新计算

**控制台验证**：

在窗口B打开浏览器控制台（F12），应该看到：
```javascript
[UserCenter] 配额变更: {
  userId: 123,
  newQuotaMB: 200,
  oldQuotaMB: 100
}
```

## 单位转换规则

### 显示规则

| 值（MB） | 显示格式 |
|---------|---------|
| 0 | 0 MB |
| 100 | 100 MB |
| 512 | 512 MB |
| 1024 | 1.0 GB |
| 1536 | 1.5 GB |
| 2048 | 2.0 GB |
| -1 | 无限制 |

### 转换逻辑

```typescript
// 格式化显示
if (value === -1) return '无限制';
if (value >= 1024) {
  const gb = value / 1024;
  return `${gb.toFixed(gb >= 10 ? 0 : 1)} GB`;
}
return `${value} MB`;
```

## WebSocket 事件

### 发送的事件

1. **quota:adjusted** (通用配额调整事件)
```typescript
{
  featureCode: 'storage_space',
  oldValue: 100,
  newValue: 200
}
```

2. **storage_quota_changed** (存储专用事件)
```typescript
{
  userId: 123,
  newQuotaMB: 200,
  oldQuotaMB: 100
}
```

### 监听的事件

个人中心 (`UserCenterPage.tsx`) 监听：
```typescript
wsService.on('storage_quota_changed', handleStorageQuotaChange);

const handleStorageQuotaChange = (data: any) => {
  console.log('[UserCenter] 配额变更:', data);
  message.success('存储配额已更新');
  fetchStorageData(); // 重新加载存储数据
};
```

## 相关功能

### 已有的存储空间功能

1. **存储使用追踪** - 实时追踪用户的存储使用情况
2. **存储配额检查** - 上传前检查是否超出配额
3. **存储警报** - 达到阈值时发送警报
4. **存储购买** - 用户可以购买额外存储空间
5. **存储统计** - 按类型（图片/文档/文章）统计使用情况

### 配额来源

用户的有效存储配额 = 套餐配额 + 自定义配额 + 购买的配额

```sql
-- 套餐配额（来自 plan_features）
SELECT feature_value FROM plan_features 
WHERE plan_id = ? AND feature_code = 'storage_space'

-- 自定义配额（来自 user_subscriptions.custom_quotas）
SELECT custom_quotas->>'storage_space' FROM user_subscriptions
WHERE user_id = ? AND status = 'active'

-- 购买的配额（来自 storage_purchases）
SELECT SUM(storage_mb) FROM storage_purchases
WHERE user_id = ? AND status = 'active'
```

## 注意事项

### 1. 单位一致性

- **数据库存储**：统一使用 MB 为单位
- **API 传输**：统一使用 MB 为单位
- **前端显示**：根据大小自动转换 MB/GB

### 2. WebSocket 连接

- 个人中心会自动连接 WebSocket
- 如果连接失败，会降级为轮询模式
- 断线会自动重连

### 3. 配额调整类型

- **临时调整**：仅对当前订阅周期有效
- **永久调整**：会持续到订阅结束

### 4. 配额优先级

```
自定义配额 > 套餐配额
```

如果设置了自定义配额，会覆盖套餐的默认配额。

## 常见问题

### Q1: 调整配额后，个人中心没有更新？

**排查步骤**：
1. 检查 WebSocket 连接状态（浏览器控制台）
2. 确认用户在"存储空间"标签页
3. 检查后端日志，确认事件已发送
4. 尝试手动刷新页面

### Q2: 输入 1024 显示为 1024 MB 而不是 1 GB？

**说明**：这是正常的。输入框显示原始值（MB），只有在显示配额信息时才会自动转换为 GB。

### Q3: 如何测试 WebSocket 断线重连？

**步骤**：
1. 打开个人中心
2. 停止后端服务
3. 调整配额（会失败）
4. 重启后端服务
5. WebSocket 会自动重连
6. 再次调整配额，应该能正常同步

## 后续优化建议

1. **批量调整配额**：支持一次调整多个用户的配额
2. **配额模板**：预设常用的配额组合
3. **配额历史图表**：可视化展示配额变更历史
4. **配额预警**：当用户接近配额上限时，提前通知管理员
5. **配额审批流程**：大额配额调整需要审批

## 相关文档

- [存储空间管理功能完成总结.md](./存储空间管理功能完成总结.md)
- [用户订阅管理功能开发完成.md](./用户订阅管理功能开发完成.md)
- [测试存储空间配额调整和同步.md](./测试存储空间配额调整和同步.md)
- [存储API使用示例.md](./存储API使用示例.md)

## 总结

✅ **问题 1 已解决**：配额调整界面现在清晰显示 MB 单位，用户不会混淆
✅ **问题 2 已解决**：配额调整后，用户个人中心实时同步更新，无需刷新页面

两个问题都已完全修复，功能正常工作。用户体验得到显著提升。
