# 配额系统修复执行计划

## 审计结果总结

**审计时间**: 2026-01-04  
**总检查项**: 23  
**通过**: 16 ✅  
**失败**: 6 ❌  
**警告**: 1 ⚠️

## 发现的问题

### 🔴 严重问题（必须修复）

1. **文章生成 - 缺少配额记录**
   - 位置: `server/src/routes/articleGeneration.ts`
   - 问题: 有配额检查，但没有记录使用量
   - 影响: 用户生成文章后，配额不会减少
   - 优先级: P0

2. **关键词蒸馏 - 缺少配额检查和记录**
   - 位置: `server/src/routes/distillation.ts`
   - 问题: 既没有配额检查，也没有记录使用量
   - 影响: 用户可以无限蒸馏，配额不会减少
   - 优先级: P0

3. **平台账号 - 缺少配额检查和记录**
   - 位置: `server/src/routes/platformAccounts.ts`
   - 问题: 既没有配额检查，也没有记录使用量
   - 影响: 用户可以添加无限账号
   - 优先级: P0

### 🟡 中等问题

4. **发布任务路由不存在**
   - 需要确认实际的发布路由文件名
   - 可能是 `publishingTasks.ts` 或其他名称

## 修复计划

### 阶段 1: 修复文章生成配额记录（15分钟）

**文件**: `server/src/routes/articleGeneration.ts`

**当前状态**:
- ✅ 有配额检查
- ❌ 没有配额记录

**需要添加**:
```typescript
// 在文章生成成功后
await usageTrackingService.recordUsage(
  userId,
  'articles_per_month',
  'article',
  articleId,
  validatedData.articleCount  // 生成的文章数量
);
```

**添加位置**: 
- 在任务创建成功后
- 在返回响应前

### 阶段 2: 修复关键词蒸馏配额（20分钟）

**文件**: `server/src/routes/distillation.ts`

**需要添加**:

1. **配额检查**（在蒸馏前）:
```typescript
const quota = await usageTrackingService.checkQuota(userId, 'keyword_distillation');

if (!quota.hasQuota || quota.remaining < 1) {
  return res.status(403).json({ 
    error: '关键词蒸馏配额不足',
    message: `您本月的蒸馏配额不足。剩余 ${quota.remaining} 次`,
    quota: {
      remaining: quota.remaining,
      total: quota.quotaLimit
    }
  });
}
```

2. **配额记录**（在蒸馏成功后）:
```typescript
await usageTrackingService.recordUsage(
  userId,
  'keyword_distillation',
  'distillation',
  distillationId,
  1
);
```

### 阶段 3: 修复平台账号配额（20分钟）

**文件**: `server/src/routes/platformAccounts.ts`

**需要添加**:

1. **配额检查**（在添加账号前）:
```typescript
const quota = await usageTrackingService.checkQuota(userId, 'platform_accounts');

if (!quota.hasQuota || quota.remaining < 1) {
  return res.status(403).json({ 
    error: '平台账号配额不足',
    message: `您的平台账号数量已达上限。当前 ${quota.currentUsage}/${quota.quotaLimit}`,
    quota: {
      current: quota.currentUsage,
      total: quota.quotaLimit
    }
  });
}
```

2. **配额记录**（在添加成功后）:
```typescript
await usageTrackingService.recordUsage(
  userId,
  'platform_accounts',
  'platform_account',
  accountId,
  1
);
```

3. **删除账号时减少配额**:
```typescript
// 在删除账号成功后
await usageTrackingService.recordUsage(
  userId,
  'platform_accounts',
  'platform_account',
  accountId,
  -1  // 负数表示减少
);
```

### 阶段 4: 查找并修复发布路由（15分钟）

1. 查找实际的发布路由文件
2. 检查是否有配额检查和记录
3. 如果缺失，按照相同模式添加

### 阶段 5: 验证存储配额（10分钟）

虽然审计显示存储配额通过，但需要实际测试：

1. 测试图片上传
2. 测试文档上传
3. 验证配额正确扣减
4. 验证配额不足时正确拒绝

## 实施步骤

### Step 1: 备份当前代码
```bash
git add .
git commit -m "备份：配额系统修复前"
```

### Step 2: 修复文章生成配额记录
```bash
# 编辑 server/src/routes/articleGeneration.ts
# 添加 recordUsage 调用
```

### Step 3: 修复关键词蒸馏配额
```bash
# 编辑 server/src/routes/distillation.ts
# 添加 checkQuota 和 recordUsage 调用
```

### Step 4: 修复平台账号配额
```bash
# 编辑 server/src/routes/platformAccounts.ts
# 添加 checkQuota 和 recordUsage 调用
```

### Step 5: 查找并修复发布路由
```bash
# 查找发布相关路由
find server/src/routes -name "*publish*"
# 修复发现的文件
```

### Step 6: 运行测试
```bash
# 重启服务器
npm run server:dev

# 运行审计脚本验证
npx ts-node src/scripts/audit-quota-system.ts

# 手动测试每个功能
```

### Step 7: 提交修复
```bash
git add .
git commit -m "修复：配额系统检查和记录缺失问题"
```

## 验证清单

修复完成后，验证以下场景：

### 文章生成
- [ ] 生成文章前检查配额
- [ ] 配额不足时拒绝生成
- [ ] 生成成功后配额减少
- [ ] 配额显示正确

### 关键词蒸馏
- [ ] 蒸馏前检查配额
- [ ] 配额不足时拒绝蒸馏
- [ ] 蒸馏成功后配额减少
- [ ] 配额显示正确

### 平台账号
- [ ] 添加账号前检查配额
- [ ] 配额不足时拒绝添加
- [ ] 添加成功后配额减少
- [ ] 删除账号后配额增加
- [ ] 配额显示正确

### 发布任务
- [ ] 发布前检查配额
- [ ] 配额不足时拒绝发布
- [ ] 发布成功后配额减少
- [ ] 配额显示正确

### 存储空间
- [ ] 上传前检查存储配额
- [ ] 存储不足时拒绝上传
- [ ] 上传成功后存储使用量增加
- [ ] 删除文件后存储使用量减少
- [ ] 存储显示正确

## 预期结果

修复后：
- ✅ 所有功能都有配额检查
- ✅ 所有功能都记录使用量
- ✅ 配额显示与实际使用一致
- ✅ 配额不足时正确拒绝操作
- ✅ 用户无法绕过配额限制

## 时间估算

- 阶段 1: 15分钟
- 阶段 2: 20分钟
- 阶段 3: 20分钟
- 阶段 4: 15分钟
- 阶段 5: 10分钟
- 测试验证: 20分钟

**总计**: 约 1.5 小时

## 下一步

立即开始阶段 1：修复文章生成配额记录。
