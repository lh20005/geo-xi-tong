# 🔍 企鹅号发布问题诊断指南

## 问题描述
点击发布任务按钮后，没有按照设定的自动发布执行，现在什么都没做。

## 已完成的修复
1. ✅ 企鹅号适配器已基于录制脚本重新制作
2. ✅ Cookie登录逻辑已修复（先设置Cookie再导航）
3. ✅ 人性化时间间隔已添加
4. ✅ 适配器已在注册表中注册

## 需要诊断的问题

### 可能原因1: 前端未发送请求
**症状**: 点击按钮后没有任何反应

**诊断方法**:
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 点击发布任务按钮
4. 查看是否有 `POST /api/publishing/tasks` 请求

**如果没有请求**:
- 检查浏览器控制台是否有JavaScript错误
- 检查按钮的onClick事件是否正确绑定
- 检查是否有其他错误阻止了请求发送

### 可能原因2: 请求发送但失败
**症状**: Network标签中看到请求，但返回错误

**诊断方法**:
1. 查看请求的响应状态码
2. 查看响应内容中的错误信息

**常见错误**:
- 401: 未登录或token过期
- 403: 无权限
- 404: 文章或账号不存在
- 400: 参数错误

### 可能原因3: 任务创建成功但未执行
**症状**: 请求返回成功，但没有看到浏览器打开

**诊断方法**:
```bash
# 查看服务器日志
tail -100 server.log | grep -E "企鹅号|qie|任务.*#"
```

**查找关键日志**:
- `✅ 任务 #X 已创建并开始自动执行`
- `🚀 [任务 #X] 开始执行`
- `[企鹅号] 开始发布流程`

**如果没有这些日志**:
- 任务可能被创建为定时任务或批次任务
- 检查任务的 `scheduled_at` 和 `batch_id` 字段

### 可能原因4: 任务执行但适配器失败
**症状**: 看到任务开始执行的日志，但很快失败

**诊断方法**:
查看日志中的错误信息：
- `❌ 企鹅号登录失败`
- `❌ 企鹅号文章发布失败`
- `找不到元素`
- `超时`

## 诊断步骤（按顺序执行）

### 步骤1: 检查前端请求
```javascript
// 在浏览器控制台执行
// 1. 打开Network标签
// 2. 点击发布按钮
// 3. 查看是否有请求
```

### 步骤2: 检查任务是否创建
```javascript
// 在浏览器控制台执行
fetch('/api/publishing/tasks?page=1&pageSize=10', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(d => {
  console.log('最近的任务:', d.data.tasks);
  // 查找企鹅号任务
  const qieTasks = d.data.tasks.filter(t => t.platform_id === 'qie');
  console.log('企鹅号任务:', qieTasks);
})
```

### 步骤3: 检查服务器日志
```bash
# 查看最近的日志
tail -100 server.log

# 实时监控日志
tail -f server.log | grep -E "企鹅号|qie|任务"
```

### 步骤4: 测试账号Cookie
```javascript
// 在浏览器控制台执行
// 替换 ACCOUNT_ID 为实际的账号ID
fetch('/api/accounts/ACCOUNT_ID/test-login', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(d => console.log('测试登录结果:', d))
```

### 步骤5: 手动触发任务执行
```javascript
// 如果任务已创建但未执行
// 替换 TASK_ID 为实际的任务ID
fetch('/api/publishing/tasks/TASK_ID/execute', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(d => console.log('执行结果:', d))
```

## 快速测试方案

### 方案1: 最小化测试
1. 创建一个最简单的测试文章
   - 标题：测试企鹅号发布
   - 内容：这是一篇测试文章，只有文字，没有图片。
2. 使用"测试登录"确认账号Cookie有效
3. 创建发布任务
4. 观察浏览器是否打开

### 方案2: 手动发布测试
1. 使用"测试登录"打开企鹅号
2. 手动创建一篇文章
3. 确认账号可以正常发布
4. 然后再测试自动发布

## 需要提供的信息

为了帮助诊断，请提供：

1. **浏览器控制台截图**
   - Network标签（显示发布请求）
   - Console标签（显示任何错误）

2. **服务器日志**
   ```bash
   tail -100 server.log > qie-publish-log.txt
   ```

3. **任务信息**
   - 文章ID
   - 账号ID
   - 任务ID（如果已创建）

4. **操作步骤**
   - 是单个发布还是批量发布？
   - 是立即发布还是定时发布？
   - 点击按钮后有什么提示？

## 临时解决方案

如果自动发布暂时无法工作：

1. **使用测试登录**
   - 点击"测试登录"按钮
   - 浏览器会打开已登录的企鹅号
   - 手动复制粘贴内容发布

2. **检查其他平台**
   - 测试头条号等其他平台是否正常
   - 如果其他平台正常，说明是企鹅号特定问题

## 相关文件
- 适配器: `server/src/services/adapters/QieAdapter.ts`
- 执行器: `server/src/services/PublishingExecutor.ts`
- 路由: `server/src/routes/publishingTasks.ts`
- 注册表: `server/src/services/adapters/AdapterRegistry.ts`

## 下一步

请按照上述步骤进行诊断，并提供：
1. 浏览器Network标签的截图
2. 服务器日志的内容
3. 任务是否创建成功
4. 如果创建成功，任务的状态是什么

有了这些信息，我们就能准确定位问题所在。
