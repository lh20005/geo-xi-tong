# 蒸馏结果智能选择问题修复指南

## 问题描述

1. **重复使用问题**：在生成文章模块中，选择蒸馏历史后，系统反复使用其中一条蒸馏结果，而不能平均使用其他结果
2. **计数不同步问题**：生成文章后，不能将本次使用的蒸馏结果做计数记录，计数结果无法和"蒸馏结果"模块中"被引用次数"列同步更新

## 修复内容

### 1. 增强日志记录

在以下关键位置添加了详细的日志：

- **任务创建时**：记录选择的所有蒸馏结果ID和关键词
- **任务执行时**：记录每篇文章使用的蒸馏结果ID、关键词和索引
- **文章保存时**：记录事务的每个步骤和usage_count的变化
- **批量加载时**：记录加载的蒸馏结果详情

### 2. 事务日志增强

在`saveArticleWithUsageTracking`方法中添加了：

- 更新前的usage_count查询
- 每个步骤的详细日志
- 更新后的usage_count验证
- 事务提交/回滚的明确记录

### 3. 验证和修复工具

创建了三个实用脚本：

#### a. 验证脚本 (`verify-usage-count.ts`)

检查所有蒸馏结果的usage_count是否与实际使用记录一致。

```bash
cd server
npm run verify-usage-count
```

输出示例：
```
ID  关键词          usage_count  实际使用  差异  状态
─────────────────────────────────────────────────────
1   关键词1         5           5        0    ✓ 一致
2   关键词2         3           5        -2   ✗ 不一致
3   关键词3         0           0        0    ✓ 一致
```

#### b. 修复脚本 (`fix-usage-count.ts`)

重新计算所有蒸馏结果的usage_count，使其等于实际使用记录数量。

```bash
cd server
npm run fix-usage-count
```

#### c. 测试脚本 (`test-smart-selection.ts`)

测试智能选择功能是否正常工作。

```bash
cd server
npm run test-smart-selection
```

## 诊断步骤

### 步骤1：检查当前状态

运行验证脚本查看数据一致性：

```bash
cd server
npm run verify-usage-count
```

### 步骤2：查看服务器日志

启动服务器并创建一个新任务，观察日志输出：

```bash
cd server
npm run dev
```

关键日志标记：
- `[智能选择]` - 蒸馏结果选择过程
- `[批量加载]` - 蒸馏结果数据加载
- `[任务 X] [文章 Y]` - 每篇文章的生成过程
- `[保存文章]` - 文章保存和usage_count更新

### 步骤3：创建测试任务

在前端创建一个生成3-5篇文章的任务，观察：

1. 日志中是否显示选择了多个不同的蒸馏结果ID
2. 每篇文章是否使用了不同的蒸馏结果
3. usage_count是否在每篇文章保存后正确更新

### 步骤4：验证结果

任务完成后，运行测试脚本：

```bash
cd server
npm run test-smart-selection
```

检查：
- 使用的蒸馏结果数量是否等于生成的文章数量
- 每个蒸馏结果是否只被使用了一次
- usage_count是否与实际使用记录一致

## 常见问题排查

### 问题1：所有文章使用同一个蒸馏结果

**症状**：日志显示选择了多个蒸馏结果，但所有文章都使用同一个

**可能原因**：
- `selected_distillation_ids`未正确保存到数据库
- 任务执行时未正确读取`selected_distillation_ids`
- 批量加载失败，导致使用旧逻辑

**排查方法**：
1. 检查数据库中的`selected_distillation_ids`字段
   ```sql
   SELECT id, selected_distillation_ids FROM generation_tasks ORDER BY id DESC LIMIT 1;
   ```
2. 查看日志中的`[任务 X] 读取到预选的蒸馏结果IDs`
3. 查看日志中的`[任务 X] [文章 Y] 从selected_distillation_ids[Y]获取蒸馏结果ID`

### 问题2：usage_count不更新

**症状**：文章生成成功，但usage_count保持不变

**可能原因**：
- 事务提交失败
- `incrementUsageCount`方法未执行
- 数据库连接问题

**排查方法**：
1. 查看日志中的`[保存文章]`相关信息
2. 检查是否有`事务回滚`的日志
3. 运行验证脚本检查数据一致性

### 问题3：usage_count与实际使用不一致

**症状**：验证脚本显示usage_count与实际使用记录数量不同

**解决方法**：
1. 运行修复脚本：
   ```bash
   cd server
   npm run fix-usage-count
   ```
2. 再次运行验证脚本确认修复成功

## 预期行为

### 正确的日志输出示例

```
[智能选择] 开始选择 3 个蒸馏结果...
[智能选择] 可用蒸馏结果数量: 10
[智能选择] 成功选择 3 个蒸馏结果: [1, 5, 3]

[任务 123] 开始执行
[任务 123] 读取到预选的蒸馏结果IDs: [1, 5, 3]
[任务 123] 批量加载蒸馏结果数据...
[任务 123] 成功加载 3 个蒸馏结果的数据
[任务 123] 蒸馏结果 ID=1, 关键词="关键词1", 话题数=5
[任务 123] 蒸馏结果 ID=5, 关键词="关键词5", 话题数=4
[任务 123] 蒸馏结果 ID=3, 关键词="关键词3", 话题数=6

[任务 123] ========== 开始生成第 1/3 篇文章 ==========
[任务 123] [文章 1] 从selected_distillation_ids[0]获取蒸馏结果ID: 1
[任务 123] [文章 1] 使用蒸馏结果: ID=1, 关键词="关键词1", 话题数=5
[任务 123] [文章 1] 文章生成成功，标题: 文章标题1
[保存文章] 蒸馏结果ID 1 当前usage_count: 2
[保存文章] 事务开始
[保存文章] 文章已插入，ID: 456
[保存文章] 使用记录已创建: distillation_id=1, task_id=123, article_id=456
[保存文章] usage_count已更新（+1）
[保存文章] 事务提交成功
[保存文章] 蒸馏结果ID 1 更新后usage_count: 3 (增加了 1)

[任务 123] ========== 开始生成第 2/3 篇文章 ==========
[任务 123] [文章 2] 从selected_distillation_ids[1]获取蒸馏结果ID: 5
[任务 123] [文章 2] 使用蒸馏结果: ID=5, 关键词="关键词5", 话题数=4
...
```

### 正确的数据库状态

1. **generation_tasks表**：
   ```sql
   id | selected_distillation_ids | requested_count | generated_count
   123| [1, 5, 3]                 | 3               | 3
   ```

2. **articles表**：
   ```sql
   id  | task_id | distillation_id | keyword
   456 | 123     | 1               | 关键词1
   457 | 123     | 5               | 关键词5
   458 | 123     | 3               | 关键词3
   ```

3. **distillation_usage表**：
   ```sql
   distillation_id | task_id | article_id
   1               | 123     | 456
   5               | 123     | 457
   3               | 123     | 458
   ```

4. **distillations表**：
   ```sql
   id | keyword  | usage_count
   1  | 关键词1  | 3
   5  | 关键词5  | 1
   3  | 关键词3  | 1
   ```

## 测试清单

- [ ] 运行验证脚本，确认当前数据一致性
- [ ] 如有不一致，运行修复脚本
- [ ] 创建新任务（3-5篇文章）
- [ ] 观察服务器日志，确认选择了多个不同的蒸馏结果
- [ ] 观察每篇文章的生成日志，确认使用了不同的蒸馏结果
- [ ] 观察保存日志，确认usage_count正确更新
- [ ] 任务完成后，运行测试脚本验证结果
- [ ] 在前端"蒸馏结果"模块查看"被引用次数"是否正确
- [ ] 再次运行验证脚本，确认数据一致性

## 联系支持

如果按照本指南操作后问题仍未解决，请提供：

1. 服务器日志（包含任务创建和执行的完整日志）
2. 验证脚本的输出
3. 测试脚本的输出
4. 数据库中相关表的数据快照

## 更新日志

- 2024-01-XX: 初始版本，添加日志增强和验证工具
