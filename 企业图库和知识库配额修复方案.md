# 企业图库和知识库配额修复方案

## 诊断结果

### 问题1: 用户没有配额记录 ❌
- **表现**: `user_usage` 表中没有 `gallery_albums` 和 `knowledge_bases` 的记录
- **原因**: 订阅系统初始化时没有包含这两个功能
- **影响**: 用户无法使用这些功能（提示配额不足）

### 问题2: 没有使用记录 ❌
- **表现**: `usage_records` 表中没有相关记录
- **原因**: `gallery.ts` 和 `knowledgeBase.ts` 没有调用 `usageTrackingService.recordUsage`
- **影响**: 即使有配额，创建后配额不会减少，可以无限创建

### 实际使用情况
- lzc2005: 1个相册(9张图片), 1个知识库(1个文档)
- testuser: 1个相册(1张图片), 1个知识库(1个文档)
- testuser2: 2个相册(5张图片), 0个知识库

## 修复计划

### 步骤1: 添加功能配额检查和记录到路由
- ✅ 修改 `server/src/routes/gallery.ts`
  - 创建相册时：检查配额 + 记录使用
  - 删除相册时：减少配额
- ✅ 修改 `server/src/routes/knowledgeBase.ts`
  - 创建知识库时：检查配额 + 记录使用
  - 删除知识库时：减少配额

### 步骤2: 创建数据库迁移
- ✅ 创建迁移 024：初始化所有用户的图库和知识库配额
- ✅ 同步现有数据到配额记录

### 步骤3: 测试验证
- ✅ 测试创建相册/知识库时配额检查
- ✅ 测试配额记录是否正确
- ✅ 测试删除时配额恢复
- ✅ 测试配额用尽时的拒绝

## 执行顺序

1. 修改路由文件（添加配额检查和记录）
2. 创建并运行数据库迁移（初始化配额）
3. 运行测试脚本验证
4. 生成完成报告
