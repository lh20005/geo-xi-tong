# 图片格式诊断

## 🔍 问题分析

图片粘贴显示 `[IMAGE_PLACEHOLDER]`，可能的原因：

### 1. 图片格式问题
- 文件扩展名可能与实际格式不符
- 例如：文件名是 `.jpg` 但实际是 `.webp`

### 2. 文件签名检测

不同图片格式的文件头（前4字节）：

| 格式 | 文件签名（十六进制） | MIME类型 |
|------|---------------------|----------|
| PNG  | 89 50 4E 47         | image/png |
| JPEG | FF D8 FF            | image/jpeg |
| GIF  | 47 49 46 38         | image/gif |
| WebP | 52 49 46 46         | image/webp |

## 🔧 已添加的诊断功能

代码现在会输出：
```
[头条号] 📷 图片信息:
[头条号]    文件路径: /path/to/image.jpg
[头条号]    文件扩展名: .jpg
[头条号]    文件签名: ffd8ff...
[头条号]    真实格式: JPEG
[头条号]    MIME类型: image/jpeg
[头条号]    文件大小: 123.45 KB
```

## 🧪 测试步骤

1. 运行发布任务
2. 查看服务器日志中的图片信息
3. 确认：
   - 文件是否存在
   - 真实格式是什么
   - 文件大小是否正常

## 📊 可能的结果

### 情况1：格式不匹配
```
文件扩展名: .jpg
真实格式: WebP
```
**说明**：文件实际是WebP格式，但扩展名错误

### 情况2：不支持的格式
```
真实格式: WebP
```
**说明**：头条号可能不支持WebP格式

### 情况3：文件损坏
```
文件签名: 00000000
```
**说明**：文件可能损坏

### 情况4：格式正常
```
文件扩展名: .jpg
真实格式: JPEG
文件大小: 123.45 KB
```
**说明**：格式正常，问题在其他地方

## 🔧 解决方案

### 如果是WebP格式
- ✅ 代码已支持WebP
- ✅ 会自动转换为PNG

### 如果是GIF格式
- ✅ 代码已支持GIF
- ✅ 会自动转换为PNG

### 如果是其他格式
- 需要手动转换为JPEG或PNG

## 📝 Canvas转换流程

1. 读取任意格式的图片
2. 加载到Image对象
3. 绘制到Canvas
4. 转换为PNG格式（质量1.0）
5. 如果PNG失败，尝试JPEG（质量0.95）
6. 写入剪贴板

## ⚠️ 注意事项

### 1. 图片尺寸
- 太大的图片可能导致Canvas失败
- 建议 < 4096x4096

### 2. 图片质量
- PNG质量设为1.0（最高）
- JPEG质量设为0.95（接近无损）

### 3. 剪贴板验证
代码会验证剪贴板内容：
```
剪贴板验证: 1 个项目
剪贴板类型: ["image/png"]
```

如果看到这个，说明图片已成功写入剪贴板。

## 🎯 下一步

根据日志输出判断：

1. **如果图片格式正常，但粘贴失败**
   - 问题可能在粘贴事件触发
   - 需要调整粘贴方式

2. **如果图片格式异常**
   - 需要转换图片格式
   - 或者使用上传功能而不是粘贴

3. **如果剪贴板验证失败**
   - 权限问题
   - 浏览器不支持Clipboard API

请运行测试并分享日志输出！
