# 清除浏览器缓存指南

## 问题说明

前端代码已更新并重新构建，但浏览器可能缓存了旧的 JavaScript 文件，导致仍然使用 `localhost:3000` 而不是 ngrok 地址。

## 解决方案

### 方法 1: 硬刷新（推荐）⭐

**Chrome / Edge / Firefox (Mac):**
```
Cmd + Shift + R
```

**Chrome / Edge / Firefox (Windows/Linux):**
```
Ctrl + Shift + R
```

或者：
```
Ctrl + F5
```

### 方法 2: 清除缓存并硬刷新

**Chrome / Edge:**
1. 打开开发者工具 (F12)
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

**Firefox:**
1. 打开开发者工具 (F12)
2. 右键点击刷新按钮
3. 选择"清除缓存"

### 方法 3: 无痕模式测试

**Chrome / Edge:**
```
Cmd + Shift + N (Mac)
Ctrl + Shift + N (Windows/Linux)
```

**Firefox:**
```
Cmd + Shift + P (Mac)
Ctrl + Shift + P (Windows/Linux)
```

然后访问：
```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
```

### 方法 4: 手动清除缓存

**Chrome / Edge:**
1. 设置 → 隐私和安全 → 清除浏览数据
2. 选择"缓存的图片和文件"
3. 时间范围选择"全部时间"
4. 点击"清除数据"

**Firefox:**
1. 设置 → 隐私与安全 → Cookie 和网站数据
2. 点击"清除数据"
3. 勾选"缓存的 Web 内容"
4. 点击"清除"

## 验证是否生效

### 1. 访问测试页面

```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/test.html
```

这个页面会显示：
- 当前环境信息
- 环境检测结果
- API URL 配置
- 可以测试 API 连接

### 2. 检查控制台

打开浏览器控制台 (F12)，应该看到：

```javascript
[Landing Config] 环境: {
  hostname: "granolithic-pseudoprosperous-rebeca.ngrok-free.dev",
  isNgrok: true,
  apiUrl: "https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api"
}
```

**如果看到 `localhost:3000`，说明缓存没有清除干净。**

### 3. 检查网络请求

1. 打开开发者工具 (F12)
2. 切换到 Network 标签
3. 刷新页面
4. 查看 JavaScript 文件的请求
5. 确认文件名是否包含新的哈希值

**旧文件：** `index-CAjlob_i.js`  
**新文件：** 应该有不同的哈希值

## 完整测试流程

### 1. 清除缓存
使用上面的任意方法清除浏览器缓存

### 2. 访问测试页面
```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/test.html
```

### 3. 点击"测试 API 连接"
应该显示：
```
✅ API 连接成功！
```

### 4. 点击"测试创建订单"
应该显示：
```
✅ 订单创建成功！
```

### 5. 访问主页面
```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
```

### 6. 登录并测试支付
- 用户名：`lzc2005`
- 密码：`Woshixiaogou2005`
- 点击购买按钮
- 查看控制台，确认 API 请求使用的是 ngrok 地址

## 如果还是不行

### 检查 1: 确认 Landing 已重新构建

```bash
cd landing
npm run build
```

查看输出，确认构建成功。

### 检查 2: 确认后端服务器已重启

```bash
# 停止旧进程
pkill -f "tsx.*src/index.ts"

# 启动新进程
cd server
npm run dev
```

### 检查 3: 确认静态文件已更新

```bash
ls -la landing/dist/assets/
```

查看文件的修改时间，确认是最新的。

### 检查 4: 使用 curl 测试

```bash
curl -I https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/
```

查看响应头，确认服务器正在提供静态文件。

## 常见问题

### Q1: 为什么会缓存？

浏览器会缓存静态文件（HTML、CSS、JS）以提高加载速度。但在开发过程中，这可能导致看到旧版本的代码。

### Q2: 硬刷新和普通刷新有什么区别？

- **普通刷新 (F5):** 可能使用缓存
- **硬刷新 (Cmd+Shift+R):** 强制从服务器重新下载所有资源

### Q3: 为什么无痕模式有效？

无痕模式不使用缓存，每次都从服务器重新下载资源。

### Q4: 生产环境如何避免缓存问题？

Vite 构建时会自动为文件添加哈希值（如 `index-CAjlob_i.js`），当文件内容改变时，哈希值也会改变，浏览器会自动下载新文件。

但如果 HTML 文件被缓存，可能仍然引用旧的 JS 文件。解决方案：
1. 设置 HTML 文件不缓存
2. 使用 Service Worker
3. 添加版本号参数

## 成功标志

清除缓存成功后，你应该看到：

1. ✅ 控制台显示正确的 ngrok API URL
2. ✅ Network 标签显示请求发送到 ngrok 地址
3. ✅ 创建订单成功
4. ✅ 查询订单状态成功（不再显示 ERR_CONNECTION_REFUSED）

---

**创建时间：** 2024年12月29日  
**问题：** 浏览器缓存导致使用旧代码  
**解决方案：** 清除缓存并硬刷新
