# 头条号正文图片插入优化说明

## 📋 优化内容

根据用户要求，优化了步骤3（填写正文内容）中的图片插入逻辑。

## 🎯 核心改进

### 旧方案问题
- 先插入所有文字，再逐个粘贴图片到末尾
- 图片位置不正确
- 不符合真实操作流程

### 新方案（优化后）
**完全模拟真实操作流程**：按位置逐步插入文字和图片

## 📝 详细流程

### 步骤1：解析内容
```typescript
// 将内容按图片分割，识别文字和图片的位置关系
const parts: Array<{ type: 'text' | 'image', content: string }> = [];

// 示例：
// parts = [
//   { type: 'text', content: '这是第一段文字...' },
//   { type: 'image', content: '/path/to/image1.jpg' },
//   { type: 'text', content: '这是第二段文字...' },
//   { type: 'image', content: '/path/to/image2.jpg' },
//   { type: 'text', content: '这是第三段文字...' }
// ]
```

### 步骤2：按顺序插入

#### 插入文字段落
```typescript
// 1. 点击编辑器确保焦点
await contentEditor.click();
await new Promise(resolve => setTimeout(resolve, 500));

// 2. 逐字输入文字（模拟真实输入）
await page.keyboard.type(textContent, { delay: 50 });

// 3. 按回车换行
await page.keyboard.press('Enter');

// 4. 等待1秒
await new Promise(resolve => setTimeout(resolve, 1000));
```

#### 插入图片（关键步骤）
```typescript
// 1. 暂停文字输入

// 2. 点击上传图片按钮
const uploadButtonSelector = '#root > div > div.left-column > div > div.publish-editor > div.syl-editor-toolbar.visible.inline > div > div.syl-toolbar-tool.image.static > div > button > svg';
await uploadButton.click();

// 3. 等待对话框打开（3秒）
await new Promise(resolve => setTimeout(resolve, 3000));

// 4. 在弹出的对话框中选择本地文件
const fileInputSelector = 'body > div:nth-child(46) > ... > input[type=file]';
await fileInput.uploadFile(imagePath);

// 5. 等待上传完成（15秒，考虑网络慢）
await new Promise(resolve => setTimeout(resolve, 15000));

// 6. 点击确定按钮关闭对话框
const confirmButtonSelector = 'body > div:nth-child(46) > ... > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square > span';
await confirmButton.click();

// 7. 等待对话框关闭（3秒）
await new Promise(resolve => setTimeout(resolve, 3000));

// 8. 光标自动回到正文图片后

// 9. 继续输入剩余文字
```

## 🔑 关键选择器

### 1. 正文编辑器
```css
#root > div > div.left-column > div > div.publish-editor > div.syl-editor-wrap > div > div.ProseMirror > p
```

### 2. 上传图片按钮
```css
#root > div > div.left-column > div > div.publish-editor > div.syl-editor-toolbar.visible.inline > div > div.syl-toolbar-tool.image.static > div > button > svg
```

### 3. 文件上传输入框
```css
body > div:nth-child(46) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.btn-upload-scand.is-empty > div > button:nth-child(1) > div > input[type=file]
```

### 4. 确定按钮（关闭对话框）
```css
body > div:nth-child(46) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.footer > div.confirm-btns > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square > span
```

## ⏱️ 时间预估

### 单张图片插入时间
- 点击上传按钮：1秒
- 等待对话框打开：3秒
- 选择文件：1秒
- 等待上传完成：15秒
- 点击确定按钮：1秒
- 等待对话框关闭：3秒
- **总计：约24秒/张**

### 完整正文插入时间
假设文章有3段文字和2张图片：
- 文字1：5秒
- 图片1：24秒
- 文字2：5秒
- 图片2：24秒
- 文字3：5秒
- **总计：约63秒**

## 🎯 优势

### 1. 完全模拟真实操作
- 按顺序输入文字和图片
- 遇到图片位置时暂停文字输入
- 上传图片后继续输入剩余文字

### 2. 图片位置准确
- 图片插入在正确的位置
- 不是全部堆在末尾

### 3. 稳定可靠
- 每步都有充足的等待时间
- 点击确定按钮确保对话框关闭
- 光标自动回到正确位置

### 4. 容错性强
- 多个备用选择器
- 详细的日志输出
- 失败时有提示

## 📊 实现示例

### 输入内容
```markdown
这是第一段文字，介绍文章主题。

![图片1](image1.jpg)

这是第二段文字，详细说明。

![图片2](image2.jpg)

这是第三段文字，总结全文。
```

### 执行流程
```
1. 输入："这是第一段文字，介绍文章主题。"
2. 按Enter换行
3. 暂停文字输入
4. 点击上传按钮
5. 选择 image1.jpg
6. 等待15秒上传
7. 点击确定关闭对话框
8. 光标回到图片后
9. 输入："这是第二段文字，详细说明。"
10. 按Enter换行
11. 暂停文字输入
12. 点击上传按钮
13. 选择 image2.jpg
14. 等待15秒上传
15. 点击确定关闭对话框
16. 光标回到图片后
17. 输入："这是第三段文字，总结全文。"
18. 完成
```

## ✅ 测试要点

- [ ] 文字按顺序正确输入
- [ ] 图片在正确位置插入
- [ ] 每张图片上传后对话框正确关闭
- [ ] 光标回到图片后继续输入
- [ ] 最终内容顺序正确：文字-图片-文字-图片-文字

## 🔧 调试技巧

### 1. 查看日志
每步都有详细日志输出：
```
[头条号] 📝 插入文字段落 1/5 (50 字符)
[头条号] ✅ 文字段落已插入
[头条号] 📷 插入图片 2/5: image1.jpg
[头条号] 🔍 查找上传图片按钮...
[头条号] ✅ 找到上传图片按钮，正在点击...
[头条号] ⏳ 等待上传对话框打开（3秒）...
[头条号] 🔍 查找文件上传输入框...
[头条号] ✅ 找到文件输入框: input[type=file]
[头条号] ⏳ 正在上传图片...
[头条号] ✅ 图片已提交上传
[头条号] ⏳ 等待图片上传完成（15秒）...
[头条号] ✅ 上传等待完成
[头条号] 🔍 查找确定按钮关闭对话框...
[头条号] ✅ 找到确定按钮，正在点击...
[头条号] ✅ 已点击确定按钮
[头条号] ⏳ 等待对话框关闭（3秒）...
[头条号] ✅ 对话框已关闭，光标应回到正文图片后
```

### 2. 常见问题

**Q: 图片没有插入到正确位置？**
A: 检查内容解析是否正确，查看日志中的"内容解析完成"部分。

**Q: 对话框没有关闭？**
A: 检查确定按钮选择器是否正确，查看日志中的"查找确定按钮"部分。

**Q: 光标位置不对？**
A: 确保对话框完全关闭后再继续，可以增加等待时间。

**Q: 上传失败？**
A: 检查图片路径是否正确，网络是否正常，可以增加上传等待时间。

## 🎉 总结

本次优化完全按照真实操作流程实现：
1. ✅ 按位置逐步插入文字和图片
2. ✅ 遇到图片时暂停文字输入
3. ✅ 点击上传按钮上传图片
4. ✅ 点击确定按钮关闭对话框
5. ✅ 光标回到图片后继续输入
6. ✅ 每步都有充足的等待时间
7. ✅ 详细的日志输出便于调试

这样可以确保图片在正确的位置，完全模拟真实的手动操作流程！
