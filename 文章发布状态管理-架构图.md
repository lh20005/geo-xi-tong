# 文章发布状态管理 - 系统架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端层 (React)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │  发布任务页面     │  │  发布记录页面     │  │  文章管理页面 │ │
│  │                  │  │                  │  │              │ │
│  │ - 选择文章        │  │ - 发布记录列表    │  │ - 文章列表   │ │
│  │ - 选择平台        │  │ - 统计数据        │  │ - 状态筛选   │ │
│  │ - 创建任务        │  │ - 平台筛选        │  │ - 发布状态   │ │
│  │ - 任务列表        │  │ - 详情查看        │  │              │ │
│  └──────────────────┘  └──────────────────┘  └──────────────┘ │
│           │                     │                     │         │
└───────────┼─────────────────────┼─────────────────────┼─────────┘
            │                     │                     │
            └─────────────────────┴─────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 层 (Express.js)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    路由层 (Routes)                        │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  /api/publishing/tasks          发布任务管理              │  │
│  │  /api/publishing/records        发布记录管理 ⭐          │  │
│  │  /api/publishing/stats          发布统计数据 ⭐          │  │
│  │  /api/articles                  文章管理                  │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                  │                              │
│                                  ▼                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   服务层 (Services)                       │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  PublishingService          发布任务服务                  │  │
│  │  PublishingExecutor         发布执行器 ⭐                │  │
│  │  BrowserAutomationService   浏览器自动化                  │  │
│  │  AccountService             账号管理                      │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                  │                              │
└──────────────────────────────────┼──────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    数据库层 (PostgreSQL)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │  articles        │  │ publishing_tasks │  │ platform_    │ │
│  │                  │  │                  │  │ accounts     │ │
│  │ - id             │  │ - id             │  │              │ │
│  │ - title          │  │ - article_id     │  │ - id         │ │
│  │ - content        │  │ - account_id     │  │ - platform_id│ │
│  │ - is_published ⭐│  │ - platform_id    │  │ - credentials│ │
│  │ - published_at ⭐│  │ - status         │  │              │ │
│  └──────────────────┘  └──────────────────┘  └──────────────┘ │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  publishing_records ⭐ (新增)                             │  │
│  │                                                           │  │
│  │  - id                    主键                             │  │
│  │  - article_id            文章ID                           │  │
│  │  - task_id               任务ID                           │  │
│  │  - platform_id           平台ID                           │  │
│  │  - account_id            账号ID                           │  │
│  │  - account_name          账号名称                         │  │
│  │  - platform_article_id   平台文章ID（预留）               │  │
│  │  - platform_url          平台文章链接（预留）             │  │
│  │  - published_at          发布时间                         │  │
│  │  - created_at            创建时间                         │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

⭐ 表示本次新增或修改的部分
```

## 数据流图

### 发布流程

```
┌─────────────┐
│   用户操作   │
│             │
│ 1. 选择文章  │
│ 2. 选择平台  │
│ 3. 创建任务  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              POST /api/publishing/tasks                 │
│                                                         │
│  创建发布任务                                            │
│  - article_id                                           │
│  - platform_id                                          │
│  - account_id                                           │
│  - scheduled_time (可选)                                │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│           PublishingExecutor.executeTask()              │
│                                                         │
│  1. 获取任务详情                                         │
│  2. 获取账号凭证                                         │
│  3. 获取文章内容                                         │
│  4. 启动浏览器                                           │
│  5. 执行登录                                             │
│  6. 导航到发布页面                                       │
│  7. 执行发布                                             │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              发布成功 ✅                                 │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  PublishingExecutor.createPublishingRecord() ⭐         │
│                                                         │
│  BEGIN TRANSACTION                                      │
│  ├─ INSERT INTO publishing_records                     │
│  │  (article_id, task_id, platform_id, ...)           │
│  │                                                     │
│  ├─ UPDATE articles                                    │
│  │  SET is_published = true,                          │
│  │      published_at = COALESCE(published_at, NOW())  │
│  │  WHERE id = article_id                             │
│  │                                                     │
│  └─ UPDATE publishing_tasks                            │
│     SET status = 'success'                             │
│     WHERE id = task_id                                 │
│  COMMIT                                                 │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│              前端自动刷新                                │
│                                                         │
│  1. 发布任务页面：文章从列表中消失                        │
│  2. 发布记录页面：显示新的发布记录                        │
│  3. 文章管理页面：状态变为"已发布"                        │
└─────────────────────────────────────────────────────────┘
```

### 查询流程

#### 发布任务页面 - 获取未发布文章

```
┌─────────────────────────────────────────────────────────┐
│  GET /api/articles?publishStatus=unpublished            │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  SELECT * FROM articles                                 │
│  WHERE is_published = false                             │
│  ORDER BY created_at DESC                               │
│  LIMIT 10 OFFSET 0                                      │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  返回未发布的文章列表                                     │
└─────────────────────────────────────────────────────────┘
```

#### 发布记录页面 - 获取发布记录

```
┌─────────────────────────────────────────────────────────┐
│  GET /api/publishing/records?platform_id=toutiao        │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  SELECT                                                 │
│    pr.*,                                                │
│    a.title as article_title,                           │
│    a.keyword as article_keyword,                       │
│    pc.platform_name,                                   │
│    pt.status as task_status                            │
│  FROM publishing_records pr                            │
│  LEFT JOIN articles a ON pr.article_id = a.id         │
│  LEFT JOIN platforms_config pc                         │
│    ON pr.platform_id = pc.platform_id                  │
│  LEFT JOIN publishing_tasks pt                         │
│    ON pr.task_id = pt.id                               │
│  WHERE pr.platform_id = 'toutiao'                      │
│  ORDER BY pr.published_at DESC                         │
│  LIMIT 20 OFFSET 0                                      │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  返回发布记录列表（含关联数据）                           │
└─────────────────────────────────────────────────────────┘
```

#### 发布统计 - 获取统计数据

```
┌─────────────────────────────────────────────────────────┐
│  GET /api/publishing/stats                              │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  并行执行多个查询：                                       │
│                                                         │
│  1. SELECT COUNT(*) FROM publishing_records             │
│     → 总发布次数                                         │
│                                                         │
│  2. SELECT COUNT(*) FROM publishing_records             │
│     WHERE DATE(published_at) = CURRENT_DATE             │
│     → 今日发布数                                         │
│                                                         │
│  3. SELECT COUNT(*) FROM publishing_records             │
│     WHERE published_at >= DATE_TRUNC('week', NOW())     │
│     → 本周发布数                                         │
│                                                         │
│  4. SELECT COUNT(*) FROM publishing_records             │
│     WHERE published_at >= DATE_TRUNC('month', NOW())    │
│     → 本月发布数                                         │
│                                                         │
│  5. SELECT platform_id, COUNT(*)                        │
│     FROM publishing_records                             │
│     GROUP BY platform_id                                │
│     → 按平台统计                                         │
└──────┬──────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│  返回统计数据                                            │
│  {                                                      │
│    total: 150,                                          │
│    today: 5,                                            │
│    week: 23,                                            │
│    month: 87,                                           │
│    byPlatform: [...]                                    │
│  }                                                      │
└─────────────────────────────────────────────────────────┘
```

## 状态转换图

### 文章发布状态

```
┌─────────────────┐
│   创建文章       │
│                 │
│ is_published:   │
│   false         │
│ published_at:   │
│   null          │
└────────┬────────┘
         │
         │ 用户创建发布任务
         │
         ▼
┌─────────────────┐
│   发布中         │
│                 │
│ task.status:    │
│   running       │
└────────┬────────┘
         │
         │ 发布成功
         │
         ▼
┌─────────────────┐
│   已发布 ✅      │
│                 │
│ is_published:   │
│   true          │
│ published_at:   │
│   2024-12-17    │
└─────────────────┘
         │
         │ 可以重新发布到其他平台
         │ （状态不变，新增发布记录）
         │
         ▼
┌─────────────────┐
│   多平台发布     │
│                 │
│ publishing_     │
│ records:        │
│   - 平台A       │
│   - 平台B       │
│   - 平台C       │
└─────────────────┘
```

### 发布任务状态

```
┌─────────────┐
│   pending   │  等待执行
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   running   │  执行中
└──────┬──────┘
       │
       ├─────────────┐
       │             │
       ▼             ▼
┌─────────────┐  ┌─────────────┐
│   success   │  │   failed    │
│             │  │             │
│ 创建发布记录 │  │ 记录错误信息 │
│ 更新文章状态 │  │ 可以重试     │
└─────────────┘  └─────────────┘
```

## 数据库关系图

```
┌──────────────────────┐
│      articles        │
│──────────────────────│
│ id (PK)              │◄──────┐
│ title                │       │
│ content              │       │
│ is_published ⭐      │       │
│ published_at ⭐      │       │
└──────────────────────┘       │
                               │
                               │ article_id (FK)
                               │
┌──────────────────────┐       │
│ publishing_records ⭐│       │
│──────────────────────│       │
│ id (PK)              │       │
│ article_id (FK)      │───────┘
│ task_id (FK)         │───────┐
│ platform_id (FK)     │───┐   │
│ account_id (FK)      │─┐ │   │
│ published_at         │ │ │   │
└──────────────────────┘ │ │   │
                         │ │   │
                         │ │   │ task_id (FK)
                         │ │   │
                         │ │   ▼
                         │ │ ┌──────────────────────┐
                         │ │ │  publishing_tasks    │
                         │ │ │──────────────────────│
                         │ │ │ id (PK)              │
                         │ │ │ article_id (FK)      │
                         │ │ │ account_id (FK)      │
                         │ │ │ platform_id          │
                         │ │ │ status               │
                         │ │ └──────────────────────┘
                         │ │
                         │ │ platform_id (FK)
                         │ │
                         │ ▼
                         │ ┌──────────────────────┐
                         │ │  platforms_config    │
                         │ │──────────────────────│
                         │ │ id (PK)              │
                         │ │ platform_id (UK)     │
                         │ │ platform_name        │
                         │ │ is_enabled           │
                         │ └──────────────────────┘
                         │
                         │ account_id (FK)
                         │
                         ▼
┌──────────────────────┐
│  platform_accounts   │
│──────────────────────│
│ id (PK)              │
│ platform_id          │
│ account_name         │
│ credentials          │
│ status               │
└──────────────────────┘
```

## 组件交互图

```
┌────────────────────────────────────────────────────────────────┐
│                        前端组件                                 │
└────────────────────────────────────────────────────────────────┘

┌──────────────────┐      ┌──────────────────┐      ┌──────────────┐
│ PublishingTasks  │      │ PublishingRecords│      │ ArticleList  │
│     Page         │      │      Page        │      │    Page      │
└────────┬─────────┘      └────────┬─────────┘      └──────┬───────┘
         │                         │                       │
         │ getArticles()           │ getPublishingRecords()│ getArticles()
         │ (unpublished)           │                       │ (all/published)
         │                         │                       │
         ▼                         ▼                       ▼
┌────────────────────────────────────────────────────────────────┐
│                      API Client Layer                          │
│                   (client/src/api/)                            │
└────────────────────────────────────────────────────────────────┘
         │                         │                       │
         │                         │                       │
         ▼                         ▼                       ▼
┌────────────────────────────────────────────────────────────────┐
│                      Backend Routes                            │
│                   (server/src/routes/)                         │
└────────────────────────────────────────────────────────────────┘
         │                         │                       │
         │                         │                       │
         ▼                         ▼                       ▼
┌────────────────────────────────────────────────────────────────┐
│                      Services Layer                            │
│                   (server/src/services/)                       │
└────────────────────────────────────────────────────────────────┘
         │                         │                       │
         │                         │                       │
         ▼                         ▼                       ▼
┌────────────────────────────────────────────────────────────────┐
│                      Database Layer                            │
│                      (PostgreSQL)                              │
└────────────────────────────────────────────────────────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                        生产环境                              │
└─────────────────────────────────────────────────────────────┘

┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   Nginx      │      │   Node.js    │      │  PostgreSQL  │
│   (反向代理)  │─────▶│   (Express)  │─────▶│  (数据库)    │
│   Port: 80   │      │   Port: 3001 │      │  Port: 5432  │
└──────────────┘      └──────────────┘      └──────────────┘
       │                      │
       │                      │
       ▼                      ▼
┌──────────────┐      ┌──────────────┐
│   React      │      │  Puppeteer   │
│   (静态文件)  │      │  (浏览器自动化)│
│              │      │              │
└──────────────┘      └──────────────┘
```

---

**说明：**
- ⭐ 标记表示本次新增或修改的部分
- 箭头表示数据流向
- FK = Foreign Key (外键)
- PK = Primary Key (主键)
- UK = Unique Key (唯一键)
