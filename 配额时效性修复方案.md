# 配额时效性修复方案

## 问题诊断

### 核心问题
当前系统中存在多个配额项目被错误地设置为"永久"（never reset），包括：
1. **平台账号数** (platform_accounts)
2. **存储空间** (storage_space)
3. **相册数** (gallery_albums)
4. **知识库数** (knowledge_bases)

这些配额应该按照商品管理中的月付/年付周期计时，到期后停止使用，而不是永久有效。

### 问题位置

#### 1. SQL 迁移文件中的错误定义
- `server/src/db/migrations/014_add_usage_tracking_and_alerts.sql` - 第216行
- `server/src/db/migrations/021_fix_quota_period.sql` - 第27行
- `server/src/db/migrations/022_fix_quota_system.sql` - 第30行
- `server/src/db/migrations/025_update_quota_functions_for_gallery_knowledge.sql` - 第28、33行

#### 2. SubscriptionService.ts 中的逻辑错误
- `getPeriodDates()` 方法对 'never' 类型配额使用固定远期日期
- `initializeUserQuotas()` 方法对非每日/每月配额使用永久周期

#### 3. 配额检查函数的错误
- `check_user_quota()` 函数没有检查订阅到期时间
- `record_feature_usage()` 函数对某些配额使用永久周期

## 修复方案

### 原则
所有配额都应该：
1. **与订阅周期绑定**：配额的有效期 = 订阅的有效期
2. **到期即停止**：订阅到期后，所有配额都不可用
3. **续费后重置**：续费或升级后，配额使用量重置
4. **不存在永久配额**：移除所有 'never' 类型的配额周期

### 实施步骤

#### 步骤1：修改配额周期定义
将所有配额改为与订阅周期绑定：
- 平台账号数：订阅周期内有效
- 存储空间：订阅周期内有效
- 相册数：订阅周期内有效
- 知识库数：订阅周期内有效
- 文章生成：每月重置
- 发布次数：每月重置
- 关键词蒸馏：每月重置

#### 步骤2：更新数据库函数
修改以下函数：
1. `record_feature_usage()` - 移除 'never' 类型，改为使用订阅周期
2. `check_user_quota()` - 添加订阅到期检查
3. `check_feature_quota()` - 添加订阅到期检查
4. `get_user_storage_quota()` - 添加订阅到期检查

#### 步骤3：更新 TypeScript 服务
修改 `SubscriptionService.ts`：
1. 移除 `getPeriodDates()` 中的 'never' 类型处理
2. 所有配额检查都要验证订阅是否有效
3. 订阅到期后，所有配额都返回 0 或不可用

#### 步骤4：添加订阅到期处理
创建定时任务：
1. 每天检查到期订阅
2. 将到期用户的配额使用量清零
3. 禁用到期用户的所有功能访问

## 影响范围

### 需要修改的文件
1. 数据库迁移文件（创建新的修复迁移）
2. `server/src/services/SubscriptionService.ts`
3. `server/src/services/UserSubscriptionManagementService.ts`
4. `server/src/services/StorageQuotaService.ts`
5. 所有使用配额检查的路由和服务

### 需要测试的场景
1. 订阅到期后，所有配额都不可用
2. 续费后，配额恢复并重置使用量
3. 升级套餐后，配额立即生效
4. 管理员调整配额后，仍受订阅周期限制
5. 免费版用户的配额处理

## 风险评估

### 高风险
- 现有用户可能依赖"永久"配额
- 需要数据迁移和清理

### 中风险
- 可能影响正在使用的功能
- 需要通知用户配额规则变更

### 低风险
- 代码逻辑清晰，修改范围明确
- 可以通过测试充分验证

## 实施建议

1. **先在测试环境验证**
2. **准备回滚方案**
3. **通知用户配额规则变更**
4. **分阶段实施**：
   - 第一阶段：修复新用户
   - 第二阶段：迁移现有用户
   - 第三阶段：清理历史数据

## 下一步行动

1. 创建新的数据库迁移文件
2. 修改 SubscriptionService.ts
3. 更新所有配额检查函数
4. 添加订阅到期处理逻辑
5. 编写测试脚本验证修复
6. 更新文档说明配额规则
