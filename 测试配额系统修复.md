# 测试配额系统修复

## 快速测试指南

### 前提条件
- 使用 lzc2005 用户登录
- 确保有足够的配额

### 测试 1: 关键词蒸馏 ✅

1. **查看当前配额**
   - 进入个人中心
   - 查看"关键词蒸馏"配额

2. **执行蒸馏**
   - 进入关键词蒸馏页面
   - 输入关键词（如"AI写作"）
   - 点击蒸馏

3. **验证配额减少**
   - 返回个人中心
   - 确认配额减少 1

4. **测试配额不足**
   - 如果配额为 0，尝试蒸馏
   - 应该看到"配额不足"错误

### 测试 2: 文章生成 ✅

1. **查看当前配额**
   - 进入个人中心
   - 查看"每月生成文章数"配额

2. **生成文章**
   - 进入文章生成页面
   - 选择蒸馏结果、图库、知识库
   - 生成 1 篇文章

3. **验证配额减少**
   - 返回个人中心
   - 确认配额减少 1

4. **测试配额不足**
   - 如果配额为 0，尝试生成
   - 应该看到"配额不足"错误

### 测试 3: 平台账号 ✅

1. **查看当前配额**
   - 进入个人中心
   - 查看"平台账号数"配额

2. **添加账号**
   - 进入平台账号管理
   - 添加一个新账号

3. **验证配额减少**
   - 返回个人中心
   - 确认配额减少 1

4. **删除账号**
   - 删除刚添加的账号
   - 返回个人中心
   - 确认配额增加 1

5. **测试配额不足**
   - 如果配额为 0，尝试添加
   - 应该看到"配额不足"错误

### 测试 4: 发布任务 ✅

1. **查看当前配额**
   - 进入个人中心
   - 查看"每月发布文章数"配额

2. **发布文章**
   - 选择一篇文章
   - 选择平台账号
   - 点击发布

3. **验证配额减少**
   - 返回个人中心
   - 确认配额减少 1

4. **测试配额不足**
   - 如果配额为 0，尝试发布
   - 应该看到"配额不足"错误

### 测试 5: 存储空间 ✅

1. **查看当前存储**
   - 进入个人中心
   - 查看"存储空间"使用情况

2. **上传图片**
   - 进入图库管理
   - 上传一张图片

3. **验证存储增加**
   - 返回个人中心
   - 确认存储使用量增加

4. **测试存储不足**
   - 如果存储满了，尝试上传
   - 应该看到"存储空间不足"错误

## 预期结果

所有测试都应该通过：
- ✅ 配额检查正常工作
- ✅ 配额记录正确扣减
- ✅ 配额显示准确
- ✅ 配额不足时正确拒绝
- ✅ 删除操作正确增加配额（平台账号）

## 如果测试失败

1. 检查服务器日志
2. 运行审计脚本: `npx ts-node src/scripts/audit-quota-system.ts`
3. 检查用户配额: `npx ts-node src/scripts/diagnose-article-quota.ts lzc2005`
4. 查看修复文档: `✅配额系统全面修复完成.md`

## 快速诊断命令

```bash
# 审计配额系统
cd server
npx ts-node src/scripts/audit-quota-system.ts

# 诊断特定用户
npx ts-node src/scripts/diagnose-article-quota.ts lzc2005

# 查看审计报告
cat ../配额系统审计报告.json
```

## 成功标准

- 所有 5 个测试都通过
- 配额显示准确
- 配额扣减正确
- 配额不足时正确拒绝
- 用户体验流畅
