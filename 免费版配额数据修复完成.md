# 免费版配额数据修复完成

## 问题描述

文档中错误地写了免费版配额为：
- ❌ 每月生成文章数：300 篇
- ❌ 每月发布文章数：600 篇
- ❌ 关键词蒸馏数：50 个
- ❌ 存储空间：100 MB

实际数据库中的配额为：
- ✅ 每月生成文章数：1 篇
- ✅ 每月发布文章数：1 篇
- ✅ 关键词蒸馏数：1 个
- ✅ 存储空间：10 MB

## 修复内容

### 1. 更新文档中的配额信息

已修复以下文档：
- ✅ `免费版订阅自动开通功能.md`
- ✅ `快速开始-免费版订阅.md`
- ✅ `免费版订阅功能实现总结.md`

### 2. 优化代码实现

**改进存储空间初始化逻辑**：

修改前（有误导性的注释）：
```typescript
// 获取存储空间配额（免费版默认 100MB）
let storageQuotaBytes = 104857600; // 默认 100MB
```

修改后（清晰的动态查询）：
```typescript
// 从数据库获取存储空间配额（而不是硬编码）
const storageFeatureResult = await client.query(
  `SELECT feature_value FROM plan_features 
   WHERE plan_id = $1 AND feature_code = 'storage_space'`,
  [planId]
);

let storageQuotaBytes: number;

if (storageFeatureResult.rows.length > 0) {
  // 配额单位是 MB，需要转换为字节
  const storageMB = storageFeatureResult.rows[0].feature_value;
  storageQuotaBytes = storageMB * 1024 * 1024;
  console.log(`从数据库读取存储配额: ${storageMB} MB (${storageQuotaBytes} bytes)`);
} else {
  // 如果没有配置，使用默认值 10MB
  storageQuotaBytes = 10 * 1024 * 1024;
  console.log(`⚠️ 未找到存储配额配置，使用默认值: 10 MB`);
}
```

### 3. 创建配额查询工具

新增脚本 `server/src/scripts/check-free-plan-quotas.ts`，用于快速查看当前免费版配额：

```bash
cd server
npx ts-node src/scripts/check-free-plan-quotas.ts
```

## ✅ 确认：系统使用动态查询

系统在为新用户开通免费版时，**完全从数据库动态读取配额**，不使用硬编码值：

1. **查询套餐**：从 `subscription_plans` 表查询免费版套餐
2. **读取配额**：从 `plan_features` 表读取该套餐的所有功能配额
3. **初始化配额**：遍历所有功能，为用户创建配额记录
4. **初始化存储**：从配额配置中读取存储空间大小

详细说明见：`免费版配额动态查询说明.md`

## 当前免费版配额（已验证）

| 功能 | 配额 | 单位 | 周期 |
|------|------|------|------|
| 每月生成文章数 | 1 | 篇 | 每月重置 |
| 每月发布文章数 | 1 | 篇 | 每月重置 |
| 平台账号数 | 1 | 个 | 永久 |
| 关键词蒸馏数 | 1 | 个 | 每月重置 |
| 存储空间 | 10 | MB | 永久 |

## 配额数据位置

配额存储在数据库表 `plan_features` 中：

```sql
SELECT 
  pf.feature_code,
  pf.feature_name,
  pf.feature_value,
  pf.feature_unit
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
WHERE sp.plan_code = 'free'
ORDER BY pf.id;
```

## 如何修改配额

### 方法 1: 直接修改数据库

```sql
-- 修改每月生成文章数
UPDATE plan_features 
SET feature_value = 5
WHERE plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free')
  AND feature_code = 'articles_per_month';

-- 修改存储空间（单位：MB）
UPDATE plan_features 
SET feature_value = 50
WHERE plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free')
  AND feature_code = 'storage_space';
```

### 方法 2: 使用商品管理界面

在系统的商品管理页面修改免费版套餐配额。

### 生效范围

- ✅ **新注册用户**：立即使用新配额
- ❌ **现有用户**：不受影响（需要手动调整）

## 验证修复

```bash
# 1. 查看当前配额
cd server
npx ts-node src/scripts/check-free-plan-quotas.ts

# 2. 注册新用户测试
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"Test123456!"}'

# 3. 查看新用户配额
# 登录后查看个人中心的配额信息
```

## 相关文档

- `免费版订阅自动开通功能.md` - 功能详细说明
- `免费版配额动态查询说明.md` - 配额查询机制说明
- `快速开始-免费版订阅.md` - 快速使用指南
- `免费版订阅功能实现总结.md` - 实现总结

## 修复文件清单

### 修改的文件
- `server/src/services/FreeSubscriptionService.ts` - 优化存储空间初始化逻辑
- `免费版订阅自动开通功能.md` - 更新配额信息
- `快速开始-免费版订阅.md` - 更新配额信息
- `免费版订阅功能实现总结.md` - 更新配额信息

### 新增的文件
- `server/src/scripts/check-free-plan-quotas.ts` - 配额查询工具
- `免费版配额动态查询说明.md` - 配额机制说明文档
- `免费版配额数据修复完成.md` - 本文档

## 总结

✅ 文档中的配额信息已全部更正  
✅ 代码逻辑已优化，更清晰地展示动态查询  
✅ 新增工具脚本，方便查看当前配额  
✅ 新增详细文档，说明配额查询机制  
✅ 系统完全使用数据库动态配额，无硬编码  

---

**修复日期**：2026-01-05  
**问题来源**：文档编写时使用了错误的示例数据  
**影响范围**：仅文档，代码逻辑正确  
**修复状态**：✅ 已完成
