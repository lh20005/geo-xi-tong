# ✅ 搜狐号登录修复完成

## 修复内容

### 1. 平台登录 Partition 修复
**问题**: 所有平台使用持久化 partition，导致加载之前的用户信息
**修复**: 改为临时 partition `login-${platformId}-${timestamp}`

### 2. 测试登录功能修复
**问题**: 
- API 不返回 `home_url` 字段
- API 不返回解密的 `credentials`

**修复**:
- 更新 `server/src/routes/platforms.ts`，返回 `home_url`
- 更新数据库，设置搜狐号 `home_url = 'https://mp.sohu.com/mpfe/v4/contentManagement/first/page'`
- 修改 `apiClient.getAccount()` 支持 `includeCredentials` 参数
- 修改 `test-account-login` 使用带凭证的 API

### 3. 搜狐号登录逻辑修复
**问题**: 登录检测逻辑不正确，没有等待跳转到成功页面

**正确的登录流程**:
1. 用户在登录页面 `https://mp.sohu.com/mpfe/v4/login` 输入账号密码
2. 可能需要输入验证码
3. 登录成功后跳转到 `https://mp.sohu.com/mpfe/v4/contentManagement/first/page`
4. **只有到达成功页面后**，才检测 `.user-name` 元素并保存用户信息

**修复后的逻辑**:
```typescript
// 1. 先检查 URL 是否到达成功页面
const currentUrl = await webViewManager.executeJavaScript('window.location.href');
if (!currentUrl.includes('mp.sohu.com/mpfe/v4/contentManagement/first/page')) {
  return; // 继续等待
}

// 2. 到达成功页面后，检测 .user-name 元素
const userNameEl = document.querySelector('.user-name');
if (userNameEl && userNameEl.textContent) {
  // 登录成功，保存用户信息
}
```

## 修改的文件

1. **windows-login-manager/electron/login/souhu-login-manager.ts**
   - 添加 URL 检查逻辑
   - 只在成功页面检测用户名元素

2. **windows-login-manager/electron/ipc/handler.ts**
   - 修改 `test-account-login` 使用带凭证的 API

3. **windows-login-manager/electron/api/client.ts**
   - `getAccount()` 方法支持 `includeCredentials` 参数

4. **server/src/routes/platforms.ts**
   - 返回 `home_url` 字段

5. **数据库**
   - 更新搜狐号的 `home_url`

## 测试步骤

### 平台登录测试
1. 点击"平台登录" -> 选择"搜狐号"
2. 应该打开全新的登录页面（不加载之前的用户信息）
3. 输入账号密码
4. 如果需要，输入验证码
5. 等待跳转到 `contentManagement/first/page`
6. 自动检测用户名并保存

### 测试登录测试
1. 点击已保存账号的"测试登录"
2. 应该打开 `https://mp.sohu.com/mpfe/v4/contentManagement/first/page`
3. 应该显示已登录状态（加载了保存的 cookies）

## 技术说明

**为什么要检查 URL？**
- 搜狐号登录过程中可能需要输入验证码
- 如果在登录页面就检测 `.user-name`，可能会误判
- 只有到达成功页面，才能确认登录完成

**GEO 应用的实现**
GEO 应用的 `sh.js` 只检测元素，不检查 URL，是因为它使用了不同的机制（preload 脚本注入），在页面加载时就开始检测。我们的实现需要更严格的 URL 检查。

---

**修复时间**: 2024-12-31
**状态**: ✅ 完成
