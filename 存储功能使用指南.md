# å­˜å‚¨åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### ç”¨æˆ·ç«¯ä½¿ç”¨

#### 1. æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
è®¿é—® **ä¸ªäººä¸­å¿ƒ â†’ å­˜å‚¨ç©ºé—´** æ ‡ç­¾é¡µï¼Œå¯ä»¥çœ‹åˆ°ï¼š
- å½“å‰ä½¿ç”¨é‡å’Œé…é¢
- å¯ç”¨ç©ºé—´
- ä½¿ç”¨ç™¾åˆ†æ¯”
- èµ„æºç±»å‹æ˜ç»†ï¼ˆå›¾ç‰‡/æ–‡æ¡£/æ–‡ç« ï¼‰
- é¥¼å›¾å¯è§†åŒ–

#### 2. ä¸Šä¼ æ–‡ä»¶
ä¸Šä¼ å›¾ç‰‡æˆ–æ–‡æ¡£æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥é…é¢æ˜¯å¦å……è¶³
- éªŒè¯æ–‡ä»¶å¤§å°
- è®°å½•å­˜å‚¨ä½¿ç”¨
- å®æ—¶æ›´æ–°æ˜¾ç¤º

å¦‚æœé…é¢ä¸è¶³ï¼Œä¼šæç¤ºå‡çº§å¥—é¤ã€‚

#### 3. è´­ä¹°é¢å¤–å­˜å‚¨
åœ¨å­˜å‚¨ç©ºé—´æ ‡ç­¾é¡µï¼Œç‚¹å‡»"è´­ä¹°å­˜å‚¨"æŒ‰é’®ï¼š
- é€‰æ‹©å­˜å‚¨äº§å“ï¼ˆ10GB/50GB/100GB/500GBï¼‰
- åˆ›å»ºè®¢å•å¹¶æ”¯ä»˜
- æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨æ¿€æ´»
- å­˜å‚¨ç©ºé—´ç«‹å³å¯ç”¨

---

## ğŸ”§ ç®¡ç†å‘˜åŠŸèƒ½

### æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·å­˜å‚¨
```bash
GET /api/admin/storage/users
```

è¿”å›æ‰€æœ‰ç”¨æˆ·çš„å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬ï¼š
- ä½¿ç”¨é‡å’Œé…é¢
- ä½¿ç”¨ç™¾åˆ†æ¯”
- èµ„æºè®¡æ•°
- è­¦æŠ¥çŠ¶æ€

### ä¿®æ”¹ç”¨æˆ·é…é¢
```bash
PUT /api/admin/storage/quota/:userId
Content-Type: application/json

{
  "newQuotaBytes": 104857600  // 100MB
}
```

### æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
```bash
GET /api/admin/storage/stats
```

è¿”å›ï¼š
- æ€»ç”¨æˆ·æ•°
- æ€»å­˜å‚¨ä½¿ç”¨é‡
- å¹³å‡æ¯ç”¨æˆ·ä½¿ç”¨é‡
- é…é¢è€—å°½ç”¨æˆ·æ•°
- æ¥è¿‘é™åˆ¶ç”¨æˆ·æ•°

### è§¦å‘å­˜å‚¨å¯¹è´¦
```bash
POST /api/admin/storage/reconcile/:userId
```

æ¯”è¾ƒæ•°æ®åº“è®°å½•ä¸å®é™…æ–‡ä»¶ç³»ç»Ÿï¼Œæ£€æµ‹å·®å¼‚ã€‚

---

## ğŸ“Š API ä½¿ç”¨ç¤ºä¾‹

### æ£€æŸ¥ä¸Šä¼ é…é¢
```typescript
import { apiClient } from '../api/client';

// è®¡ç®—æ–‡ä»¶æ€»å¤§å°
const totalSize = files.reduce((sum, file) => sum + file.size, 0);

// æ£€æŸ¥é…é¢
const response = await apiClient.post('/storage/check-quota', {
  sizeBytes: totalSize,
  resourceType: 'image' // æˆ– 'document', 'article'
});

if (response.data.allowed) {
  // å…è®¸ä¸Šä¼ 
  console.log('å‰©ä½™ç©ºé—´:', response.data.remainingBytes);
} else {
  // é…é¢ä¸è¶³
  console.error(response.data.reason);
}
```

### è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µ
```typescript
import { getStorageUsage } from '../api/storage';

const usage = await getStorageUsage();
console.log('æ€»ä½¿ç”¨é‡:', usage.totalStorageBytes);
console.log('é…é¢:', usage.storageQuotaBytes);
console.log('å¯ç”¨ç©ºé—´:', usage.availableBytes);
console.log('ä½¿ç”¨ç™¾åˆ†æ¯”:', usage.usagePercentage);
```

### è·å–å­˜å‚¨æ˜ç»†
```typescript
import { getStorageBreakdown } from '../api/storage';

const breakdown = await getStorageBreakdown();
console.log('å›¾ç‰‡:', breakdown.images.sizeBytes, 'å­—èŠ‚');
console.log('æ–‡æ¡£:', breakdown.documents.sizeBytes, 'å­—èŠ‚');
console.log('æ–‡ç« :', breakdown.articles.sizeBytes, 'å­—èŠ‚');
```

### è·å–å¢é•¿ç‡
```typescript
const response = await apiClient.get('/storage/growth-rate', {
  params: { period: 'weekly' } // 'daily', 'weekly', 'monthly'
});

console.log('å¢é•¿ç‡:', response.data.growthRate, '%');
console.log('å¢é•¿å­—èŠ‚:', response.data.growthBytes);
console.log('å¢é•¿æœ€å¿«ç±»å‹:', response.data.fastestGrowingType);
```

### å¯¼å‡ºå­˜å‚¨å†å²
```typescript
// ä¸‹è½½ CSV æ–‡ä»¶
window.location.href = `/api/storage/export?startDate=2026-01-01&endDate=2026-01-31`;
```

---

## ğŸ”” è­¦æŠ¥ç³»ç»Ÿ

### è­¦æŠ¥ç±»å‹
1. **è­¦å‘Š** (80% ä½¿ç”¨ç‡)
   - é»„è‰²æç¤º
   - å»ºè®®æ¸…ç†æˆ–å‡çº§

2. **ä¸¥é‡** (95% ä½¿ç”¨ç‡)
   - æ©™è‰²è­¦å‘Š
   - å¼ºçƒˆå»ºè®®å‡çº§

3. **è€—å°½** (100% ä½¿ç”¨ç‡)
   - çº¢è‰²é”™è¯¯
   - æ— æ³•ä¸Šä¼ æ–°æ–‡ä»¶

### è­¦æŠ¥é€šçŸ¥
- å®æ—¶ WebSocket æ¨é€
- é¡µé¢å†…æç¤ºæ¶ˆæ¯
- ç”¨æˆ·ä¸­å¿ƒæ˜¾ç¤ºè­¦æŠ¥å¡ç‰‡

---

## ğŸ’¾ å­˜å‚¨äº§å“

### å¯è´­ä¹°äº§å“
| äº§å“ | å®¹é‡ | ä»·æ ¼ | æœ‰æ•ˆæœŸ |
|------|------|------|--------|
| åŸºç¡€åŒ… | 10GB | Â¥29 | 1å¹´ |
| æ ‡å‡†åŒ… | 50GB | Â¥99 | 1å¹´ |
| ä¸“ä¸šåŒ… | 100GB | Â¥169 | 1å¹´ |
| ä¼ä¸šåŒ… | 500GB | Â¥699 | 1å¹´ |

### è´­ä¹°æµç¨‹
1. é€‰æ‹©äº§å“
2. åˆ›å»ºè®¢å•
3. å®Œæˆæ”¯ä»˜
4. è‡ªåŠ¨æ¿€æ´»
5. å­˜å‚¨ç«‹å³å¯ç”¨

### è¿‡æœŸå¤„ç†
- è´­ä¹°çš„å­˜å‚¨æœ‰æ•ˆæœŸä¸º 1 å¹´
- åˆ°æœŸå‰ä¼šæ”¶åˆ°é€šçŸ¥
- åˆ°æœŸåè‡ªåŠ¨ä»é…é¢ä¸­ç§»é™¤
- å¯ä»¥ç»­è´¹æˆ–è´­ä¹°æ–°äº§å“

---

## ğŸ› ï¸ ç»´æŠ¤ä»»åŠ¡

### æ¯æ—¥å¿«ç…§
```bash
# æ‰‹åŠ¨è¿è¡Œ
npx ts-node src/scripts/create-daily-snapshots.ts

# æˆ–é€šè¿‡ cron è‡ªåŠ¨è¿è¡Œ
0 0 * * * cd /path/to/project && node dist/scripts/create-daily-snapshots.js
```

### æ£€æŸ¥è¿‡æœŸè´­ä¹°
```bash
# æ‰‹åŠ¨è¿è¡Œ
psql $DATABASE_URL -c "SELECT expire_storage_purchases();"

# æˆ–é€šè¿‡ cron è‡ªåŠ¨è¿è¡Œ
0 * * * * psql $DATABASE_URL -c "SELECT expire_storage_purchases();"
```

### ç”¨æˆ·è¿ç§»
```bash
# ä¸ºç°æœ‰ç”¨æˆ·åˆå§‹åŒ–å­˜å‚¨è®°å½•
npx ts-node src/scripts/migrate-existing-users-storage.ts
```

---

## ğŸ“ˆ ç›‘æ§å’Œåˆ†æ

### æŸ¥çœ‹ä½¿ç”¨å†å²
```bash
GET /api/storage/history?startDate=2026-01-01&endDate=2026-01-31
```

### æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—
```bash
GET /api/storage/transactions?page=1&pageSize=20
```

### æŸ¥çœ‹å¾…å¤„ç†è­¦æŠ¥
```bash
GET /api/storage/alerts
```

---

## ğŸ” æƒé™è¯´æ˜

### ç”¨æˆ·æƒé™
- æŸ¥çœ‹è‡ªå·±çš„å­˜å‚¨ä½¿ç”¨
- ä¸Šä¼ æ–‡ä»¶ï¼ˆå—é…é¢é™åˆ¶ï¼‰
- è´­ä¹°å­˜å‚¨äº§å“
- æŸ¥çœ‹è‡ªå·±çš„å†å²å’Œäº‹åŠ¡

### ç®¡ç†å‘˜æƒé™
- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·å­˜å‚¨
- ä¿®æ”¹ä»»ä½•ç”¨æˆ·é…é¢
- æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
- è§¦å‘å­˜å‚¨å¯¹è´¦
- æ— æ–‡ä»¶å¤§å°é™åˆ¶
- æ— é…é¢é™åˆ¶

---

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•å¢åŠ å­˜å‚¨ç©ºé—´ï¼Ÿ
A: æœ‰ä¸¤ç§æ–¹å¼ï¼š
1. å‡çº§è®¢é˜…å¥—é¤ï¼ˆæ°¸ä¹…å¢åŠ ï¼‰
2. è´­ä¹°é¢å¤–å­˜å‚¨ï¼ˆæœ‰æ•ˆæœŸ 1 å¹´ï¼‰

### Q: åˆ é™¤æ–‡ä»¶åå­˜å‚¨ä¼šç«‹å³é‡Šæ”¾å—ï¼Ÿ
A: æ˜¯çš„ï¼Œåˆ é™¤æ–‡ä»¶åå­˜å‚¨ä½¿ç”¨é‡ä¼šç«‹å³æ›´æ–°ã€‚

### Q: ç®¡ç†å‘˜æœ‰å­˜å‚¨é™åˆ¶å—ï¼Ÿ
A: æ²¡æœ‰ï¼Œç®¡ç†å‘˜è´¦æˆ·å­˜å‚¨é…é¢ä¸ºæ— é™åˆ¶ (-1)ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨è¶‹åŠ¿ï¼Ÿ
A: è®¿é—®ä¸ªäººä¸­å¿ƒ â†’ å­˜å‚¨ç©ºé—´ï¼Œæˆ–ä½¿ç”¨å¢é•¿ç‡ APIã€‚

### Q: è´­ä¹°çš„å­˜å‚¨å¯ä»¥å åŠ å—ï¼Ÿ
A: å¯ä»¥ï¼Œå¤šæ¬¡è´­ä¹°ä¼šç´¯åŠ åˆ°æ€»é…é¢ä¸­ã€‚

### Q: å­˜å‚¨è¿‡æœŸåæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ
A: ä¸ä¼šï¼Œåªæ˜¯æ— æ³•ä¸Šä¼ æ–°æ–‡ä»¶ã€‚ç°æœ‰æ–‡ä»¶ä¿æŒä¸å˜ã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯æ”¯æŒé‚®ç®±: support@example.com
- å¼€å‘æ–‡æ¡£: `/docs/02-åŠŸèƒ½è¯´æ˜/`
- API æ–‡æ¡£: `å­˜å‚¨APIä½¿ç”¨ç¤ºä¾‹.md`
