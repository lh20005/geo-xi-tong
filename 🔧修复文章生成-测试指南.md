# 🔧 修复文章生成 - 测试指南

## 问题已修复

✅ 已将所有AI配置从用户级迁移到系统级
✅ 普通用户现在无需配置API密钥即可使用

## 立即测试步骤

### 1. 确认系统级API配置存在

**管理员操作**：

1. 登录管理员账号
2. 访问：**系统配置 → 系统API配置**
3. 检查是否有激活的配置：
   - ✅ 如果有：跳到步骤2
   - ❌ 如果没有：点击"新增配置"，配置一个AI提供商

**配置示例**：
```
提供商: DeepSeek
API密钥: sk-your-api-key-here
状态: 激活
```

### 2. 测试文章生成

**普通用户操作**：

1. 登录普通用户账号（或管理员账号）
2. 访问：**文章生成**页面
3. 点击"新建任务"
4. 填写表单：
   - 选择蒸馏历史
   - 选择转化目标
   - 选择企业图库
   - 选择企业知识库
   - 选择文章设置
   - 输入文章数量（如：1）
5. 点击"生成文章"

**预期结果**：
- ✅ 任务创建成功
- ✅ 状态显示"执行中"
- ✅ 几秒后状态变为"已完成"
- ✅ 生成的文章数量正确

### 3. 检查错误（如果仍然失败）

打开浏览器开发者工具（F12），查看：

#### Console 标签
查看是否有错误信息

#### Network 标签
1. 找到失败的请求：`POST /api/article-generation/tasks`
2. 点击查看详情
3. 查看 Response 标签中的错误信息

**常见错误及解决方案**：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| "系统未配置AI服务" | 没有系统级配置 | 管理员配置系统API |
| "令牌无效或已过期" | 登录过期 | 重新登录 |
| "蒸馏记录不存在" | 选择的数据无效 | 检查选择的资源 |
| "没有可用的话题" | 蒸馏结果没有话题 | 选择其他蒸馏结果 |

## 验证系统级配置生效

### 方法1：查看后端日志

在服务器终端中查看日志，应该看到：
```
[任务 X] 加载AI配置...
[任务 X] 使用AI提供商: deepseek
```

### 方法2：API测试

使用curl测试配置端点：
```bash
curl -X GET http://localhost:5173/api/config/active \
  -H "Authorization: Bearer YOUR_TOKEN"
```

应该返回：
```json
{
  "provider": "deepseek",
  "configured": true,
  "canEdit": true
}
```

## 数据库检查（可选）

如果需要直接检查数据库：

```sql
-- 检查系统级配置
SELECT id, provider, is_active, priority, created_at 
FROM system_api_configs 
ORDER BY is_active DESC, priority DESC;

-- 检查是否还有旧的用户级配置
SELECT id, user_id, provider, is_active 
FROM api_configs 
LIMIT 5;
```

## 回滚方案（如果需要）

如果新方案有问题，可以临时回滚：

1. 恢复旧代码（使用git）
2. 或者在 `system_api_configs` 表中添加配置

## 成功标志

✅ 普通用户可以创建文章生成任务
✅ 不需要配置API密钥
✅ 文章正常生成
✅ 所有AI功能正常工作

## 需要帮助？

如果遇到问题：
1. 检查后端日志
2. 检查浏览器控制台
3. 确认系统级API配置已激活
4. 确认API密钥有效且有余额

## 相关文档

- `✅AI配置迁移到系统级-完成.md` - 技术实现详情
- `SYSTEM_API_CONFIG_IMPLEMENTATION.md` - 系统级配置方案
- `AI_KEY_MANAGEMENT_SOLUTION.md` - AI密钥管理方案
