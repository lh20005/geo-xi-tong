// 更新知识库（验证所有权）
knowledgeBaseRouter.patch('/:id', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const kbId = parseInt(req.params.id);
    if (isNaN(kbId) || kbId <= 0) {
      return res.status(400).json({ error: '无效的知识库ID' });
    }
    
    const validatedData = updateKnowledgeBaseSchema.parse(req.body);
    
    // 检查知识库是否存在且属于当前用户
    const checkResult = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
      [kbId, userId]
    );
    if (checkResult.rows.length === 0) {
      return res.status(404).json({ error: '知识库不存在或无权访问' });
    }
    
    // 构建更新语句
    const updates: string[] = [];
    const values: any[] = [];
    let paramIndex = 1;
    
    if (validatedData.name !== undefined) {
      updates.push(`name = $${paramIndex++}`);
      values.push(validatedData.name);
    }
    
    if (validatedData.description !== undefined) {
      updates.push(`description = $${paramIndex++}`);
      values.push(validatedData.description);
    }
    
    updates.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(kbId);
    values.push(userId);
    
    const result = await pool.query(
      `UPDATE knowledge_bases 
       SET ${updates.join(', ')} 
       WHERE id = $${paramIndex} AND user_id = $${paramIndex + 1}
       RETURNING id, name, description, updated_at`,
      values
    );
    
    res.json(result.rows[0]);
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ error: '数据验证失败', details: error.errors });
    }
    console.error('更新知识库错误:', error);
    res.status(500).json({ error: '更新知识库失败', details: error.message });
  }
});
