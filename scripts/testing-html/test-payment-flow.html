<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æ”¯ä»˜æµç¨‹æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .steps {
            list-style: none;
            counter-reset: step-counter;
        }
        
        .steps li {
            counter-increment: step-counter;
            margin-bottom: 15px;
            padding-left: 40px;
            position: relative;
            color: #555;
        }
        
        .steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¾®ä¿¡æ”¯ä»˜æµç¨‹æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•æ”¯ä»˜è®¢å•åˆ›å»ºå’ŒçŠ¶æ€æŸ¥è¯¢åŠŸèƒ½</p>
        
        <!-- é…ç½®æ£€æŸ¥ -->
        <div class="section">
            <h2>1ï¸âƒ£ é…ç½®æ£€æŸ¥</h2>
            <button class="btn" onclick="checkConfig()">æ£€æŸ¥å¾®ä¿¡æ”¯ä»˜é…ç½®</button>
            <div id="configResult"></div>
        </div>
        
        <!-- åˆ›å»ºè®¢å• -->
        <div class="section">
            <h2>2ï¸âƒ£ åˆ›å»ºæµ‹è¯•è®¢å•</h2>
            <div class="form-group">
                <label>API åœ°å€</label>
                <input type="text" id="apiUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
            </div>
            <div class="form-group">
                <label>è®¤è¯ Token</label>
                <input type="text" id="authToken" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                <small style="color: #999; font-size: 12px;">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–ï¼Œæˆ–ç™»å½•åä» localStorage å¤åˆ¶</small>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©å¥—é¤</label>
                <select id="planId">
                    <option value="1">ä½“éªŒç‰ˆ - Â¥0</option>
                    <option value="2">ä¸“ä¸šç‰ˆ - Â¥99</option>
                    <option value="3">ä¼ä¸šç‰ˆ - Â¥299</option>
                </select>
            </div>
            <button class="btn" onclick="createOrder()">åˆ›å»ºè®¢å•</button>
            <div id="orderResult"></div>
        </div>
        
        <!-- æŸ¥è¯¢è®¢å• -->
        <div class="section">
            <h2>3ï¸âƒ£ æŸ¥è¯¢è®¢å•çŠ¶æ€</h2>
            <div class="form-group">
                <label>è®¢å•å·</label>
                <input type="text" id="orderNo" placeholder="ORD1234567890123456">
            </div>
            <button class="btn" onclick="queryOrder()">æŸ¥è¯¢è®¢å•</button>
            <div id="queryResult"></div>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <ol class="steps">
                <li>å…ˆè¿è¡Œé…ç½®æ£€æŸ¥è„šæœ¬ï¼š<code>./test-wechat-pay-config.sh</code></li>
                <li>ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨ï¼š<code>npm run dev</code></li>
                <li>ç™»å½•ç³»ç»Ÿè·å–è®¤è¯ Token</li>
                <li>åœ¨æ­¤é¡µé¢åˆ›å»ºæµ‹è¯•è®¢å•</li>
                <li>æŸ¥çœ‹è¿”å›çš„äºŒç»´ç é“¾æ¥</li>
                <li>ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜ï¼ˆæˆ–æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼‰</li>
            </ol>
        </div>
    </div>
    
    <script>
        // æ£€æŸ¥é…ç½®
        async function checkConfig() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æ£€æŸ¥é…ç½®...</div>';
            
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const response = await fetch(`${apiUrl}/api/health`);
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸<br>
                            <small>è¯·æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤å¾®ä¿¡æ”¯ä»˜æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸<br>
                            çŠ¶æ€ç : ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨<br>
                        é”™è¯¯: ${error.message}<br>
                        <small>è¯·ç¡®è®¤æœåŠ¡å™¨å·²å¯åŠ¨å¹¶ä¸”åœ°å€æ­£ç¡®</small>
                    </div>
                `;
            }
        }
        
        // åˆ›å»ºè®¢å•
        async function createOrder() {
            const resultDiv = document.getElementById('orderResult');
            const apiUrl = document.getElementById('apiUrl').value;
            const authToken = document.getElementById('authToken').value;
            const planId = document.getElementById('planId').value;
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥è®¤è¯ Token</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨åˆ›å»ºè®¢å•...</div>';
            
            try {
                const response = await fetch(`${apiUrl}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken.startsWith('Bearer ') ? authToken : `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ plan_id: parseInt(planId) })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const order = data.data;
                    document.getElementById('orderNo').value = order.order_no;
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼
                            <div class="code">
è®¢å•å·: ${order.order_no}
å¥—é¤åç§°: ${order.plan_name}
æ”¯ä»˜é‡‘é¢: Â¥${order.amount}
äºŒç»´ç é“¾æ¥: ${order.qr_code_url || 'æœªç”Ÿæˆ'}
                            </div>
                            ${order.qr_code_url ? `
                                <div class="qr-placeholder">
                                    æ‰«ææ­¤äºŒç»´ç æ”¯ä»˜<br>
                                    <small>(å®é™…åº”æ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡)</small>
                                </div>
                                <small>æç¤ºï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºçœŸå®çš„æ”¯ä»˜äºŒç»´ç </small>
                            ` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ åˆ›å»ºè®¢å•å¤±è´¥<br>
                            é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}<br>
                            <div class="code">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ è¯·æ±‚å¤±è´¥<br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }
        
        // æŸ¥è¯¢è®¢å•
        async function queryOrder() {
            const resultDiv = document.getElementById('queryResult');
            const apiUrl = document.getElementById('apiUrl').value;
            const authToken = document.getElementById('authToken').value;
            const orderNo = document.getElementById('orderNo').value;
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥è®¤è¯ Token</div>';
                return;
            }
            
            if (!orderNo) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥è®¢å•å·</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æŸ¥è¯¢è®¢å•...</div>';
            
            try {
                const response = await fetch(`${apiUrl}/api/orders/${orderNo}`, {
                    headers: {
                        'Authorization': authToken.startsWith('Bearer ') ? authToken : `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const order = data.data;
                    const statusClass = order.status === 'paid' ? 'paid' : order.status === 'failed' ? 'failed' : 'pending';
                    const statusText = {
                        'pending': 'å¾…æ”¯ä»˜',
                        'paid': 'å·²æ”¯ä»˜',
                        'failed': 'æ”¯ä»˜å¤±è´¥',
                        'closed': 'å·²å…³é—­'
                    }[order.status] || order.status;
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… è®¢å•æŸ¥è¯¢æˆåŠŸ
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <div class="code">
è®¢å•å·: ${order.order_no}
è®¢å•çŠ¶æ€: ${statusText}
æ”¯ä»˜é‡‘é¢: Â¥${order.amount}
åˆ›å»ºæ—¶é—´: ${new Date(order.created_at).toLocaleString('zh-CN')}
${order.paid_at ? `æ”¯ä»˜æ—¶é—´: ${new Date(order.paid_at).toLocaleString('zh-CN')}` : ''}
${order.transaction_id ? `äº¤æ˜“å·: ${order.transaction_id}` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ æŸ¥è¯¢è®¢å•å¤±è´¥<br>
                            é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ è¯·æ±‚å¤±è´¥<br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
        window.onload = function() {
            // å°è¯•ä» localStorage è·å– token
            const token = localStorage.getItem('auth_token');
            if (token) {
                document.getElementById('authToken').value = token;
            }
        };
    </script>
</body>
</html>
