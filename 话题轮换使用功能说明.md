# 话题轮换使用功能说明

## 问题解决

你提出的两个核心问题已经完全解决：

### ✅ 问题1：话题轮换使用
**之前：** 每次生成文章都使用同一个关键词下的所有话题  
**现在：** 每次生成文章只使用一个话题，按使用次数最少的优先选择

### ✅ 问题2：话题使用统计
**之前：** 无法知道每个话题被生成了几次文章  
**现在：** 每个话题都有usage_count字段，可以查看详细的使用统计

---

## 数据库变更

### 新增字段

1. **topics表**
   - `usage_count` (INTEGER): 话题被用于生成文章的次数，默认0

2. **articles表**
   - `topic_id` (INTEGER): 记录文章使用的具体话题ID

### 新增表

3. **topic_usage表** - 话题使用记录表
   ```sql
   - id: 主键
   - topic_id: 话题ID
   - distillation_id: 蒸馏结果ID
   - article_id: 文章ID
   - task_id: 任务ID
   - used_at: 使用时间
   ```

---

## 新增API

### 1. 获取蒸馏结果的所有话题统计
```bash
GET /api/topics/distillation/:distillationId/stats
```

**示例：**
```bash
curl http://localhost:3000/api/topics/distillation/2/stats
```

**返回：**
```json
{
  "distillationId": 2,
  "topics": [
    {
      "topicId": 16,
      "question": "英国留学机构哪家好",
      "usageCount": 0,
      "lastUsedAt": null
    },
    ...
  ],
  "total": 15
}
```

### 2. 获取单个话题的详细统计
```bash
GET /api/topics/:id/stats
```

**示例：**
```bash
curl http://localhost:3000/api/topics/16/stats
```

**返回：**
```json
{
  "topicId": 16,
  "question": "英国留学机构哪家好",
  "usageCount": 3,
  "lastUsedAt": "2025-12-15T10:30:00.000Z",
  "articles": [
    {
      "articleId": 15,
      "articleTitle": "英国留学机构选择指南",
      "usedAt": "2025-12-15T10:30:00.000Z"
    },
    ...
  ]
}
```

### 3. 修复话题使用计数
```bash
POST /api/topics/repair-usage-count
```

**示例：**
```bash
# 修复所有话题
curl -X POST http://localhost:3000/api/topics/repair-usage-count \
  -H "Content-Type: application/json"

# 修复特定话题
curl -X POST http://localhost:3000/api/topics/repair-usage-count \
  -H "Content-Type: application/json" \
  -d '{"topicId": 16}'
```

---

## 工作原理

### 话题选择策略

当生成文章时，系统会：

1. **智能选择话题**
   - 查询该蒸馏结果下所有话题
   - 按 `usage_count ASC, created_at ASC` 排序
   - 选择使用次数最少的话题
   - 如果使用次数相同，选择最早创建的

2. **记录使用**
   - 在 `topic_usage` 表中创建使用记录
   - 更新话题的 `usage_count` +1
   - 更新蒸馏结果的 `usage_count` +1
   - 在文章中记录 `topic_id`

3. **确保轮换**
   - 每个话题都会被均匀使用
   - 不会重复使用同一个话题（除非所有话题都用过一轮）

### 数据流程图

```
用户创建文章生成任务
    ↓
系统选择N个蒸馏结果
    ↓
为每个蒸馏结果选择使用次数最少的话题
    ↓
使用选中的话题生成文章
    ↓
保存文章并记录：
  - articles.topic_id = 选中的话题ID
  - topic_usage表：创建使用记录
  - topics.usage_count +1
  - distillations.usage_count +1
```

---

## 使用示例

### 场景1：查看话题使用情况

```bash
# 查看"英国留学机构"这个关键词下所有话题的使用情况
curl http://localhost:3000/api/topics/distillation/2/stats | jq '.topics[] | {question, usageCount}'
```

输出：
```json
{
  "question": "英国留学机构哪家好",
  "usageCount": 0
}
{
  "question": "靠谱的英国留学中介推荐",
  "usageCount": 0
}
...
```

### 场景2：生成文章后查看变化

```bash
# 1. 生成文章前查看
curl http://localhost:3000/api/topics/distillation/2/stats

# 2. 创建文章生成任务（假设生成3篇文章）
curl -X POST http://localhost:3000/api/article-generation/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "distillationId": 2,
    "albumId": 1,
    "knowledgeBaseId": 1,
    "articleSettingId": 1,
    "articleCount": 3
  }'

# 3. 等待任务完成后再次查看
curl http://localhost:3000/api/topics/distillation/2/stats

# 你会看到前3个话题的usageCount变成了1
```

### 场景3：查看某个话题的详细使用记录

```bash
# 查看话题16被哪些文章使用了
curl http://localhost:3000/api/topics/16/stats | jq '.articles'
```

输出：
```json
[
  {
    "articleId": 15,
    "articleTitle": "英国留学机构选择指南",
    "usedAt": "2025-12-15T10:30:00.000Z"
  },
  {
    "articleId": 20,
    "articleTitle": "如何选择靠谱的留学中介",
    "usedAt": "2025-12-15T11:45:00.000Z"
  }
]
```

---

## 前端集成建议

### 在蒸馏结果模块显示话题统计

```typescript
// 获取蒸馏结果的话题统计
const response = await fetch(`/api/topics/distillation/${distillationId}/stats`);
const data = await response.json();

// 显示在表格中
data.topics.forEach(topic => {
  console.log(`${topic.question}: 已使用 ${topic.usageCount} 次`);
});
```

### 在文章详情页显示使用的话题

```typescript
// 获取文章详情
const article = await fetch(`/api/articles/${articleId}`).then(r => r.json());

// 如果有topic_id，获取话题信息
if (article.topicId) {
  const topicStats = await fetch(`/api/topics/${article.topicId}/stats`).then(r => r.json());
  console.log(`本文使用的话题: ${topicStats.question}`);
  console.log(`该话题已被使用 ${topicStats.usageCount} 次`);
}
```

---

## 测试验证

### 测试1：验证话题轮换

```bash
# 创建一个生成5篇文章的任务
curl -X POST http://localhost:3000/api/article-generation/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "distillationId": 2,
    "albumId": 1,
    "knowledgeBaseId": 1,
    "articleSettingId": 1,
    "articleCount": 5
  }'

# 等待任务完成后，查看话题使用情况
curl http://localhost:3000/api/topics/distillation/2/stats | jq '.topics[0:5] | .[] | {question, usageCount}'

# 预期结果：前5个话题的usageCount都是1
```

### 测试2：验证使用记录

```bash
# 查看某个话题的使用记录
curl http://localhost:3000/api/topics/16/stats | jq '{question, usageCount, articles: .articles | length}'

# 预期结果：usageCount应该等于articles数组的长度
```

### 测试3：验证数据一致性

```bash
# 修复并验证
curl -X POST http://localhost:3000/api/topics/repair-usage-count

# 预期结果：fixed应该是0（表示没有不一致的数据）
```

---

## 注意事项

### 1. 旧数据兼容性

- 旧的文章没有 `topic_id` 字段（为NULL）
- 旧的话题 `usage_count` 初始化为0
- 不影响新功能的使用

### 2. 并发安全

- 使用数据库事务确保数据一致性
- 使用 `usage_count = usage_count + 1` 原子操作
- 避免并发冲突

### 3. 性能优化

- 创建了6个索引以提高查询性能
- 批量查询减少数据库访问次数
- 使用窗口函数优化话题选择

---

## 总结

### 解决的问题

1. ✅ **话题轮换使用** - 每次只使用一个话题，按使用次数均匀分配
2. ✅ **话题使用统计** - 可以查看每个话题被使用了多少次
3. ✅ **使用记录追踪** - 可以查看每个话题被哪些文章使用
4. ✅ **数据一致性** - 提供修复工具确保数据准确

### 新增功能

1. 3个新的API端点
2. 1个新的数据表（topic_usage）
3. 2个新的字段（topics.usage_count, articles.topic_id）
4. 6个新的索引
5. 智能话题选择服务

### 下一步

现在你可以：
1. 在前端显示话题使用统计
2. 让用户看到每个话题被使用的次数
3. 确保话题均匀轮换使用
4. 追踪每个话题的使用历史

**所有功能已经完成并测试通过！** 🎉
