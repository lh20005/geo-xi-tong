# 文章配图插入逻辑说明

## 概述

本项目中的文章配图插入是一个多阶段的过程，涉及文章生成、内容处理和平台发布三个主要环节。

## 一、图片插入位置的约定

### 1. AI生成阶段（第一次约定）

**位置：** `server/src/services/aiService.ts` - `formatArticle()` 方法

**约定内容：**
```typescript
// 在智能排版时，AI会被要求在第一段之后插入 [IMAGE_PLACEHOLDER] 标记
const prompt = `你是一个专业的新闻编辑。请将以下文章内容按照通用新闻稿格式重新排版。

要求：
1. 保持原文的核心信息和观点
2. 优化段落结构，使其更符合新闻稿标准
3. 第一段应该是导语，概括全文要点
4. 在第一段之后插入标记 [IMAGE_PLACEHOLDER]  // ← 这里约定了位置
5. 段落之间要有清晰的逻辑关系
...
`;
```

**说明：** AI被明确要求在第一段（导语）之后插入 `[IMAGE_PLACEHOLDER]` 占位符。

---

### 2. 文章生成服务阶段（第二次约定）

**位置：** `server/src/services/articleGenerationService.ts`

#### 2.1 AI提示词构建

**方法：** `buildPromptWithImageInstruction()`

```typescript
private buildPromptWithImageInstruction(...): string {
  let prompt = '【重要输出要求】\n';
  prompt += '1. 直接输出文章内容，不要包含任何思考过程\n';
  prompt += '2. 使用纯文本格式，不要使用Markdown符号（如#、*、-等）\n';
  // ← 这里再次约定：在第一段或第二段之后插入占位符
  prompt += '3. 在文章的适当位置（建议在第一段或第二段之后）插入 [IMAGE_PLACEHOLDER] 标记，用于后续插入配图\n';
  prompt += '4. 按照"标题：[标题内容]"格式开始，然后是正文\n';
  prompt += '5. 文章内容要自然流畅，段落之间用空行分隔\n\n';
  ...
}
```

#### 2.2 图片标记插入逻辑

**方法：** `insertImageIntoContent()`

```typescript
private insertImageIntoContent(content: string, imageUrl: string): string {
  // 情况1：如果AI已经插入了 [IMAGE_PLACEHOLDER]，直接替换
  const placeholderRegex = /\[IMAGE_PLACEHOLDER\]/i;
  if (placeholderRegex.test(content)) {
    return content.replace(
      placeholderRegex,
      `![文章配图](${imageUrl})`  // ← 替换为Markdown格式
    );
  }

  // 情况2：如果没有占位符，智能插入
  const paragraphs = content.split('\n\n').filter(p => p.trim());
  
  if (paragraphs.length === 0) {
    // 空内容，图片放在开头
    return `![文章配图](${imageUrl})\n\n${content}`;
  } else if (paragraphs.length === 1) {
    // 只有一段，图片放在末尾
    return `${content}\n\n![文章配图](${imageUrl})`;
  } else {
    // 多段，图片放在第一段后  ← 这里是关键约定
    const insertIndex = 1; // 在第一段后插入（索引1的位置）
    paragraphs.splice(
      insertIndex,
      0,
      `![文章配图](${imageUrl})`
    );
    return paragraphs.join('\n\n');
  }
}
```

**插入规则总结：**
1. **优先级1**：如果内容中有 `[IMAGE_PLACEHOLDER]`，在该位置插入
2. **优先级2**：如果没有占位符：
   - 0段：图片放开头
   - 1段：图片放末尾
   - 多段：**图片放在第一段之后**（这是默认位置）

---

### 3. 智能排版阶段（第三次约定）

**位置：** `server/src/routes/article.ts` - 智能排版API

```typescript
articleRouter.post('/:id/smart-format', async (req, res) => {
  ...
  const formattedText = await aiService.formatArticle(plainText, hasImage);
  const paragraphs = formattedText.split('\n').filter(p => p.trim().length > 0);
  let formattedHtml = '';

  for (let i = 0; i < paragraphs.length; i++) {
    const paragraph = paragraphs[i].trim();
    
    // 如果遇到占位符，替换为实际图片
    if (paragraph === '[IMAGE_PLACEHOLDER]' && imageUrl) {
      formattedHtml += `<img src="${imageUrl}" alt="article image" style="max-width: 100%; height: auto; margin: 20px 0;" />`;
    } else {
      formattedHtml += `<p>${paragraph}</p>`;
    }

    // 如果第一段后没有占位符，自动插入图片
    if (i === 0 && hasImage && !formattedText.includes('[IMAGE_PLACEHOLDER]')) {
      formattedHtml += `<img src="${imageUrl}" alt="article image" style="max-width: 100%; height: auto; margin: 20px 0;" />`;
    }
  }
  ...
});
```

**说明：** 在智能排版时，如果第一段后没有占位符，会自动在第一段后插入图片。

---

## 二、平台发布时的图片处理

### 头条号发布（特殊处理）

**位置：** `server/src/services/adapters/ToutiaoAdapter.ts`

**处理流程：**

```typescript
// 步骤1：提取所有文字（移除图片标记）
const textOnly = cleanContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '').trim();

// 步骤2：提取所有图片路径
const imagePaths: string[] = [];
const imageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
while ((match = imageRegex.exec(cleanContent)) !== null) {
  const imageUrl = match[2];
  imagePaths.push(imageUrl);
}

// 步骤3：先插入所有文字到正文
await page.keyboard.type(textOnly, { delay: 30 });

// 步骤4：上传所有图片（通过UI操作）
for (let i = 0; i < imagePaths.length; i++) {
  // 点击上传按钮
  // 选择文件
  // 等待上传完成
}
```

**说明：** 头条号发布时，会先输入所有文字，然后通过UI操作上传图片。图片的最终位置由头条号编辑器决定。

---

## 三、图片位置的完整流程

```
1. 文章生成
   ↓
   AI生成内容时，在第一段或第二段后插入 [IMAGE_PLACEHOLDER]
   ↓
2. 内容处理
   ↓
   insertImageIntoContent() 将占位符替换为 ![文章配图](url)
   ↓
3. 存储到数据库
   ↓
   content字段包含 Markdown 格式的图片标记
   ↓
4. 预览显示
   ↓
   前端处理：移除 [IMAGE_PLACEHOLDER] 和 ![...](...)
   单独显示图片在顶部
   ↓
5. 平台发布
   ↓
   提取图片URL，按平台要求上传和插入
```

---

## 四、关键配置位置总结

| 阶段 | 文件位置 | 方法/函数 | 约定内容 |
|------|---------|----------|---------|
| AI生成 | `server/src/services/aiService.ts` | `formatArticle()` | 第一段后插入占位符 |
| 文章生成 | `server/src/services/articleGenerationService.ts` | `buildPromptWithImageInstruction()` | 第一或第二段后插入占位符 |
| 图片插入 | `server/src/services/articleGenerationService.ts` | `insertImageIntoContent()` | **默认：第一段后插入** |
| 智能排版 | `server/src/routes/article.ts` | `POST /:id/smart-format` | 第一段后插入图片 |
| 平台发布 | `server/src/services/adapters/ToutiaoAdapter.ts` | `publish()` | 先文字后图片 |

---

## 五、修改图片插入位置

如果要修改图片的默认插入位置，需要修改以下位置：

### 1. 修改默认插入位置（推荐）

**文件：** `server/src/services/articleGenerationService.ts`

**方法：** `insertImageIntoContent()`

```typescript
// 当前：在第一段后插入（insertIndex = 1）
const insertIndex = 1;

// 修改为第二段后插入
const insertIndex = 2;

// 修改为第三段后插入
const insertIndex = 3;
```

### 2. 修改AI提示词

**文件：** `server/src/services/aiService.ts` 和 `articleGenerationService.ts`

修改提示词中的描述：
```typescript
// 当前
'4. 在第一段之后插入标记 [IMAGE_PLACEHOLDER]'

// 修改为
'4. 在第二段之后插入标记 [IMAGE_PLACEHOLDER]'
```

---

## 六、注意事项

1. **占位符优先级最高**：如果AI生成的内容中已经包含 `[IMAGE_PLACEHOLDER]`，会优先使用该位置

2. **Markdown格式**：图片最终以 `![文章配图](url)` 的Markdown格式存储在数据库中

3. **预览显示**：前端预览时会移除这些标记，单独显示图片

4. **平台发布**：不同平台有不同的图片处理方式，头条号是先文字后图片

5. **智能插入**：如果没有占位符，系统会根据段落数量智能决定插入位置

---

## 七、相关文件清单

```
server/src/
├── services/
│   ├── aiService.ts                      # AI服务，formatArticle()
│   ├── articleGenerationService.ts       # 文章生成，insertImageIntoContent()
│   └── adapters/
│       └── ToutiaoAdapter.ts            # 头条号发布适配器
└── routes/
    └── article.ts                        # 文章API，智能排版

client/src/
└── pages/
    └── PublishingTasksPage.tsx          # 预览页面，processArticleContent()
```
