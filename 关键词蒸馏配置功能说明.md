# 关键词蒸馏配置功能说明

## 功能概述

本次更新将系统配置模块中的"转化目标配置"更名为"关键词蒸馏配置"，并实现了完整的关键词蒸馏配置功能。用户可以通过该模块自定义关键词蒸馏的提示词和生成话题数量，从而控制关键词蒸馏的结果。

## 主要变更

### 1. 数据库变更

#### 新增表：`distillation_config`
```sql
CREATE TABLE distillation_config (
  id SERIAL PRIMARY KEY,
  prompt TEXT NOT NULL,                    -- 蒸馏提示词模板
  topic_count INTEGER NOT NULL DEFAULT 12, -- 生成话题数量（5-30）
  is_active BOOLEAN DEFAULT true,          -- 是否激活
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `prompt`: 发送给AI的提示词模板，必须包含 `{keyword}` 和 `{count}` 占位符
- `topic_count`: 每次蒸馏生成的话题数量，范围：5-30
- `is_active`: 标记当前激活的配置（系统只使用激活的配置）

**默认配置：**
- 提示词：原有的蒸馏算法提示词
- 话题数量：12个

### 2. 后端API变更

#### 新增API接口

**获取关键词蒸馏配置**
```
GET /api/config/distillation
```

响应示例：
```json
{
  "id": 1,
  "prompt": "你是一个专业的搜索行为分析专家...",
  "topicCount": 12,
  "configured": true,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

**保存关键词蒸馏配置**
```
POST /api/config/distillation
Content-Type: application/json

{
  "prompt": "你的自定义提示词，必须包含 {keyword} 和 {count}",
  "topicCount": 15
}
```

响应示例：
```json
{
  "success": true,
  "config": {
    "id": 2,
    "prompt": "...",
    "topicCount": 15,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  },
  "message": "关键词蒸馏配置保存成功"
}
```

**参数验证：**
- `prompt` 必须包含 `{keyword}` 占位符
- `prompt` 必须包含 `{count}` 占位符
- `topicCount` 必须在 5-30 之间

#### 修改的API接口

**关键词蒸馏接口**
```
POST /api/distillation
```

现在会自动读取并使用 `distillation_config` 表中的配置：
1. 读取激活的配置（`is_active = true`）
2. 使用配置的 `prompt` 和 `topic_count`
3. 替换提示词中的占位符：
   - `{keyword}` → 用户输入的关键词
   - `{count}` → 配置的话题数量

### 3. 前端页面变更

#### 系统配置页面 (`/config`)

**Tab标签更新：**
- "转化目标配置" → "关键词蒸馏配置"

**新增配置表单：**

1. **关键词蒸馏提示词**
   - 类型：多行文本框（12行）
   - 必填项
   - 验证规则：
     - 必须包含 `{keyword}` 占位符
     - 必须包含 `{count}` 占位符
   - 提示信息：显示占位符说明

2. **生成话题数量**
   - 类型：数字输入框
   - 必填项
   - 范围：5-30
   - 默认值：12
   - 建议：10-15个

3. **操作按钮**
   - 保存配置：提交表单
   - 重置：恢复到当前保存的配置

4. **配置说明卡片**
   - 解释各配置项的作用
   - 提供使用建议

### 4. 服务层变更

#### AIService.distillKeyword() 方法

**新增参数：**
```typescript
async distillKeyword(
  keyword: string,           // 关键词
  promptTemplate?: string,   // 可选：自定义提示词模板
  topicCount?: number        // 可选：生成话题数量
): Promise<string[]>
```

**工作流程：**
1. 使用传入的 `promptTemplate` 或默认模板
2. 使用传入的 `topicCount` 或默认值 12
3. 替换模板中的占位符：
   - `{keyword}` → 实际关键词
   - `{count}` → 话题数量
4. 调用AI生成话题
5. 解析并返回话题列表

## 使用指南

### 配置关键词蒸馏

1. 访问系统配置页面：`http://localhost:5173/config`
2. 切换到"关键词蒸馏配置"标签
3. 编辑提示词（确保包含 `{keyword}` 和 `{count}` 占位符）
4. 设置生成话题数量（5-30之间）
5. 点击"保存配置"

### 执行关键词蒸馏

配置保存后，所有新的关键词蒸馏任务都会自动使用新配置：

1. 访问关键词蒸馏页面
2. 输入关键词
3. 点击"开始蒸馏"
4. 系统会使用配置的提示词和数量生成话题

### 提示词编写建议

**必须包含的占位符：**
- `{keyword}` - 关键词占位符
- `{count}` - 数量占位符

**推荐结构：**
```
你是一个专业的[角色定位]。请根据关键词"{keyword}"，生成{count}个[目标内容]。

要求：
1. [要求1]
2. [要求2]
3. [要求3]

示例（关键词：[示例关键词]）：
- [示例1]
- [示例2]
- [示例3]

请直接返回[输出格式说明]。
```

**注意事项：**
- 提示词要清晰明确
- 可以包含示例帮助AI理解
- 说明输出格式要求
- 避免过于复杂的指令

## 测试方法

### 1. 使用测试脚本

```bash
# 启动服务器
npm run dev

# 在另一个终端运行测试
./test-distillation-config.sh
```

### 2. 手动测试

**测试配置保存：**
```bash
curl -X POST http://localhost:3000/api/config/distillation \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "测试提示词 {keyword} 和 {count}",
    "topicCount": 15
  }'
```

**测试配置读取：**
```bash
curl http://localhost:3000/api/config/distillation
```

**测试蒸馏功能：**
```bash
curl -X POST http://localhost:3000/api/distillation \
  -H "Content-Type: application/json" \
  -d '{"keyword": "测试关键词"}'
```

### 3. 前端测试

1. 访问 `http://localhost:5173/config`
2. 切换到"关键词蒸馏配置"标签
3. 修改配置并保存
4. 访问关键词蒸馏页面测试蒸馏功能
5. 验证生成的话题数量是否符合配置

## 数据库迁移

迁移文件已创建：`server/src/db/migrations/add_distillation_config.sql`

**执行迁移：**
```bash
cd server
npm run db:migrate
```

**验证迁移：**
```bash
psql postgresql://lzc@localhost:5432/geo_system \
  -c "SELECT * FROM distillation_config;"
```

## 技术细节

### 配置优先级

1. 系统首先查找 `is_active = true` 的配置
2. 如果没有激活配置，使用代码中的默认值
3. 每次保存新配置时，会自动停用旧配置

### 占位符替换

```typescript
const prompt = template
  .replace(/\{keyword\}/g, keyword)      // 全局替换关键词
  .replace(/\{count\}/g, count.toString()); // 全局替换数量
```

### 数据验证

**后端验证：**
- 提示词非空
- 包含必需的占位符
- 话题数量在有效范围内

**前端验证：**
- 实时验证占位符
- 数字范围限制
- 必填项检查

## 兼容性说明

- 向后兼容：如果没有配置，系统使用原有的默认算法
- 现有蒸馏记录不受影响
- API接口保持兼容

## 文件清单

### 新增文件
- `server/src/db/migrations/add_distillation_config.sql` - 数据库迁移文件
- `test-distillation-config.sh` - 功能测试脚本
- `关键词蒸馏配置功能说明.md` - 本文档

### 修改文件
- `server/src/db/schema.sql` - 添加配置表定义
- `server/src/routes/config.ts` - 添加配置API
- `server/src/services/aiService.ts` - 修改蒸馏方法
- `server/src/routes/distillation.ts` - 使用配置执行蒸馏
- `client/src/pages/ConfigPage.tsx` - 添加配置界面

## 常见问题

**Q: 修改配置后，旧的蒸馏记录会受影响吗？**
A: 不会。配置只影响新的蒸馏任务，已有的蒸馏记录保持不变。

**Q: 可以保存多个配置吗？**
A: 可以保存多个配置，但系统只使用标记为激活（`is_active = true`）的配置。

**Q: 如果忘记添加占位符会怎样？**
A: 前端和后端都会进行验证，如果缺少必需的占位符，会提示错误并拒绝保存。

**Q: 话题数量可以超过30个吗？**
A: 不可以。系统限制在5-30之间，这是为了平衡生成质量和处理时间。

**Q: 如何恢复默认配置？**
A: 在配置页面，将提示词和数量改回默认值，然后保存即可。

## 后续优化建议

1. **配置模板库**：提供多个预设模板供用户选择
2. **配置历史**：记录配置变更历史，支持回滚
3. **A/B测试**：支持多个配置并行测试效果
4. **配置导入导出**：支持配置的备份和分享
5. **实时预览**：在保存前预览提示词效果

## 总结

本次更新实现了完整的关键词蒸馏配置功能，用户可以通过简单的界面操作自定义蒸馏算法，无需修改代码。系统会自动使用最新的配置执行蒸馏任务，大大提高了系统的灵活性和可定制性。
