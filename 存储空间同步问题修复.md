# 存储空间同步问题修复

## 问题描述

用户 testuser2 购买套餐后，创建图库和知识库时可以创建，但再次添加图片和文件时提示"存储空间不足"，实际上还有充足的空间。

## 问题原因

通过诊断发现，问题的根本原因是**存储使用量记录与实际文件不一致**：

1. 用户实际有 1 张图片，大小 438407 bytes (约 428 KB)
2. 但 `user_storage_usage` 表中记录的使用量是 0 bytes
3. 用户配额是 10485760 bytes (10 MB)，实际有足够空间

### 技术细节

当用户首次上传文件时，系统应该：
1. 保存文件到磁盘
2. 在数据库中创建文件记录（`images` 或 `knowledge_documents` 表）
3. 调用 `storageService.recordStorageUsage()` 更新存储使用量
4. 创建存储事务记录（`storage_transactions` 表）

但在某些情况下（如早期版本的代码、事务失败等），步骤 3 和 4 可能被跳过，导致：
- 文件实际存在
- 数据库有文件记录
- 但存储使用量没有更新

当用户再次上传时，系统检查配额时读取到错误的使用量（0 bytes），但由于某些原因判断为"空间不足"。

## 诊断过程

### 1. 创建诊断脚本

```bash
npx ts-node server/src/scripts/quick-diagnose-testuser2.ts
```

诊断结果显示：
- 原始数据库记录：`total_storage_bytes: 0`
- 实际文件统计：1 个图片，438407 bytes
- 数据不一致差异：438407 bytes

### 2. 根本原因分析

检查代码发现：
- `gallery.ts` 和 `knowledgeBase.ts` 路由已正确集成存储配额检查
- `StorageQuotaService.checkQuota()` 逻辑正确
- 问题在于历史数据：早期上传的文件没有记录存储使用量

## 解决方案

### 修复 testuser2

运行专门的修复脚本：

```bash
cd server
npx ts-node src/scripts/fix-testuser2-storage-sync.ts
```

修复内容：
1. 扫描用户的所有图片和文档
2. 计算实际使用量
3. 更新 `user_storage_usage` 表
4. 创建缺失的存储事务记录

### 修复所有用户

为防止其他用户也有类似问题，运行通用修复脚本：

```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

## 验证修复

运行诊断脚本验证：

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

修复后的结果：
```
✅ 存储空间充足
   已使用: 438407 bytes (4.18%)
   配额: 10485760 bytes
   可用: 10047353 bytes
```

## 预防措施

### 1. 代码层面

确保所有文件上传路由都正确调用存储服务：

```typescript
// 上传文件后
await storageService.recordStorageUsage(
  userId,
  'image', // 或 'document'
  fileId,
  fileSize,
  metadata
);
```

### 2. 数据库约束

`user_storage_usage` 表的 `total_storage_bytes` 是生成列（generated column），自动计算：

```sql
total_storage_bytes BIGINT GENERATED ALWAYS AS 
  (image_storage_bytes + document_storage_bytes + article_storage_bytes) STORED
```

这确保了总使用量始终等于各类型之和。

### 3. 定期对账

建议定期运行存储对账脚本，检查数据一致性：

```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

## 相关文件

- `server/src/services/StorageService.ts` - 存储服务
- `server/src/services/StorageQuotaService.ts` - 配额检查服务
- `server/src/routes/gallery.ts` - 图库上传路由
- `server/src/routes/knowledgeBase.ts` - 知识库上传路由
- `server/src/scripts/quick-diagnose-testuser2.ts` - 诊断脚本
- `server/src/scripts/fix-testuser2-storage-sync.ts` - 单用户修复脚本
- `server/src/scripts/fix-all-users-storage-sync.ts` - 全用户修复脚本

## 总结

问题已完全解决。testuser2 现在可以正常上传图片和文档，系统会正确跟踪存储使用量。通过运行通用修复脚本，确保了所有用户的存储数据都是一致的。
