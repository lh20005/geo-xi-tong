# âœ… è´¦å·éš”ç¦»é—®é¢˜ - å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜ç¡®è®¤

ç»è¿‡å®Œæ•´è¯Šæ–­ï¼Œç¡®è®¤ï¼š

### âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸
```
ç”¨æˆ· lzc2005 (ID: 1):
  - æŠ–éŸ³è´¦å· "Aiæ¥äº†" (ID: 94)
  - å¤´æ¡è´¦å· "ç»†å“èŒ¶é¦™éŸµ" (ID: 92)

ç”¨æˆ· testuser (ID: 437):
  - æŠ–éŸ³è´¦å· "Aiæ¥äº†" (ID: 93)
  - å¤´æ¡è´¦å· "ç»†å“èŒ¶é¦™éŸµ" (ID: 90)
```

### âœ… ä»£ç å®ç°æ­£ç¡®
- æ‰€æœ‰è·¯ç”±éƒ½æœ‰å¤šç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶
- æ‰€æœ‰ Service éƒ½æŒ‰ userId è¿‡æ»¤
- æ•°æ®åº“æŸ¥è¯¢éƒ½åŒ…å« WHERE user_id = $1

### âš ï¸ æ ¹æœ¬åŸå› 
**Token å…±äº«** - Windows ç«¯å’Œ Web ç«¯å¾ˆå¯èƒ½ä½¿ç”¨äº†ç›¸åŒçš„ JWT token

---

## ğŸš€ è‡ªåŠ¨åŒ–ä¿®å¤æ–¹æ¡ˆ

ç”±äºæ— æ³•ç›´æ¥åœ¨æµè§ˆå™¨/Electron ä¸­æ‰§è¡Œä»£ç ï¼Œæˆ‘å·²ç»å‡†å¤‡å¥½äº†æ‰€æœ‰éœ€è¦çš„è„šæœ¬å’ŒæŒ‡ä»¤ã€‚

### æ–¹æ¡ˆ A: å¤åˆ¶ç²˜è´´æ‰§è¡Œï¼ˆæœ€ç®€å•ï¼‰

#### æ­¥éª¤ 1: Windows ç«¯æ¸…é™¤ç¼“å­˜

**æ‰“å¼€ Windows ç™»å½•ç®¡ç†å™¨ â†’ æŒ‰ F12 â†’ Console æ ‡ç­¾ â†’ å¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç ï¼š**

```javascript
console.log('ğŸ”„ å¼€å§‹æ¸…é™¤ Windows ç«¯ç¼“å­˜...');
localStorage.clear();
console.log('âœ… localStorage å·²æ¸…é™¤');
if (window.electron) {
  window.electron.storage.clearTokens().then(() => {
    console.log('âœ… Electron storage å·²æ¸…é™¤');
    console.log('ğŸ”„ 3ç§’åè‡ªåŠ¨åˆ·æ–°...');
    setTimeout(() => location.reload(), 3000);
  });
} else {
  console.log('ğŸ”„ 3ç§’åè‡ªåŠ¨åˆ·æ–°...');
  setTimeout(() => location.reload(), 3000);
}
```

#### æ­¥éª¤ 2: Web ç«¯æ¸…é™¤ç¼“å­˜

**æ‰“å¼€ Web ç«¯ â†’ æŒ‰ F12 â†’ Console æ ‡ç­¾ â†’ å¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç ï¼š**

```javascript
console.log('ğŸ”„ å¼€å§‹æ¸…é™¤ Web ç«¯ç¼“å­˜...');
localStorage.clear();
sessionStorage.clear();
document.cookie.split(';').forEach(c => {
  document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
});
console.log('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤');
console.log('ğŸ”„ 3ç§’åè‡ªåŠ¨åˆ·æ–°...');
setTimeout(() => location.reload(), 3000);
```

#### æ­¥éª¤ 3: é‡æ–°ç™»å½•

1. **Windows ç«¯** - ç™»å½• lzc2005
2. **Web ç«¯** - ç™»å½• testuser

#### æ­¥éª¤ 4: éªŒè¯ä¿®å¤

**åœ¨ä¸¤ä¸ªå®¢æˆ·ç«¯çš„ Console ä¸­åˆ†åˆ«è¿è¡Œï¼š**

```javascript
const token = localStorage.getItem('auth_token');
const decoded = JSON.parse(atob(token.split('.')[1]));
console.log('âœ… å½“å‰ç”¨æˆ·:', decoded.username, '(ID:', decoded.userId + ')');
```

**é¢„æœŸç»“æœï¼š**
- Windows ç«¯æ˜¾ç¤ºï¼š`âœ… å½“å‰ç”¨æˆ·: lzc2005 (ID: 1)`
- Web ç«¯æ˜¾ç¤ºï¼š`âœ… å½“å‰ç”¨æˆ·: testuser (ID: 437)`

---

### æ–¹æ¡ˆ B: æ•°æ®åº“ç›´æ¥ä¿®å¤ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

å¦‚æœæ–¹æ¡ˆ A æ— æ•ˆï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„è´¦å·å½’å±ã€‚

**âš ï¸ è­¦å‘Šï¼šä»…åœ¨ç¡®è®¤è´¦å·å½’å±é”™è¯¯æ—¶ä½¿ç”¨ï¼**

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
psql -d geo_system -c "
SELECT pa.id, pa.platform_id, pa.account_name, pa.user_id, u.username
FROM platform_accounts pa
JOIN users u ON pa.user_id = u.id
WHERE u.username IN ('lzc2005', 'testuser')
ORDER BY pa.user_id, pa.created_at DESC;
"

# å¦‚æœéœ€è¦ç§»åŠ¨è´¦å·ï¼ˆç¤ºä¾‹ï¼‰
# å°†è´¦å· 93 ä» testuser ç§»åŠ¨åˆ° lzc2005
# psql -d geo_system -c "UPDATE platform_accounts SET user_id = 1 WHERE id = 93;"

# æˆ–åˆ é™¤é‡å¤è´¦å·
# psql -d geo_system -c "DELETE FROM platform_accounts WHERE id = 93;"
```

---

## ğŸ“Š éªŒè¯æ¸…å•

æ‰§è¡Œä¿®å¤åï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Windows ç«¯å’Œ Web ç«¯çš„ token ä¸åŒ
- [ ] Windows ç«¯æ˜¾ç¤º userId = 1 (lzc2005)
- [ ] Web ç«¯æ˜¾ç¤º userId = 437 (testuser)
- [ ] Windows ç«¯åªæ˜¾ç¤º 2 ä¸ªè´¦å·ï¼ˆæŠ–éŸ³ã€å¤´æ¡ï¼‰
- [ ] Web ç«¯åªæ˜¾ç¤º 2 ä¸ªè´¦å·ï¼ˆæŠ–éŸ³ã€å¤´æ¡ï¼‰
- [ ] ä¸¤ä¸ªå®¢æˆ·ç«¯æ˜¾ç¤ºçš„è´¦å· ID ä¸åŒ
- [ ] åˆ›å»ºæ–°è´¦å·æ—¶æ­£ç¡®éš”ç¦»

---

## ğŸ” å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### è¯Šæ–­æ­¥éª¤

1. **æ£€æŸ¥ token æ˜¯å¦çœŸçš„ä¸åŒ**
```javascript
// åœ¨ä¸¤ä¸ªå®¢æˆ·ç«¯åˆ†åˆ«è¿è¡Œ
const token = localStorage.getItem('auth_token');
console.log('Token å‰ 30 å­—ç¬¦:', token.substring(0, 30));
```

2. **æ£€æŸ¥ API è¿”å›çš„æ•°æ®**
```javascript
// åœ¨ä¸¤ä¸ªå®¢æˆ·ç«¯åˆ†åˆ«è¿è¡Œ
fetch('/api/publishing/accounts', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
  }
})
.then(r => r.json())
.then(data => {
  console.log('API è¿”å›çš„è´¦å·æ•°é‡:', data.length);
  console.log('è´¦å·åˆ—è¡¨:', data);
});
```

3. **æ£€æŸ¥å‰ç«¯æ˜¯å¦æœ‰ç¼“å­˜**
```javascript
// æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜
localStorage.clear();
sessionStorage.clear();
indexedDB.databases().then(dbs => {
  dbs.forEach(db => indexedDB.deleteDatabase(db.name));
});
caches.keys().then(names => {
  names.forEach(name => caches.delete(name));
});
console.log('âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤');
location.reload();
```

---

## ğŸ’¡ é•¿æœŸè§£å†³æ–¹æ¡ˆ

### 1. å¢å¼º JWT Token

ä¿®æ”¹ `server/src/services/AuthService.ts`ï¼š

```typescript
// ç”Ÿæˆ token æ—¶æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡
function generateToken(user: User, clientType: string) {
  return jwt.sign(
    {
      sub: user.id.toString(),
      userId: user.id,
      username: user.username,
      tenant_id: user.id,
      client_type: clientType,  // 'web' æˆ– 'electron'
      device_id: generateDeviceId(),
      aud: 'geo-content-platform',
      iss: 'geo-auth-service'
    },
    JWT_SECRET,
    { expiresIn: '1h' }
  );
}
```

### 2. ä½¿ç”¨ç‹¬ç«‹å­˜å‚¨

**Windows ç«¯ï¼š**
```typescript
// ä½¿ç”¨ Electron Store
import Store from 'electron-store';
const store = new Store({ encryptionKey: 'secret' });
store.set('auth_token', token);
```

**Web ç«¯ï¼š**
```typescript
// ä½¿ç”¨ sessionStorageï¼ˆæ›´å®‰å…¨ï¼‰
sessionStorage.setItem('auth_token', token);
```

### 3. æ·»åŠ è®¾å¤‡ç»‘å®š

```typescript
// ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
function generateDeviceFingerprint() {
  const data = [
    navigator.userAgent,
    navigator.platform,
    navigator.language,
    screen.width + 'x' + screen.height
  ].join('-');
  return crypto.createHash('sha256').update(data).digest('hex');
}

// Token ä¸­åŒ…å«è®¾å¤‡æŒ‡çº¹
const payload = {
  userId: user.id,
  device_fingerprint: generateDeviceFingerprint()
};
```

---

## ğŸ“ æ‰§è¡Œè®°å½•

è¯·åœ¨æ‰§è¡Œåå¡«å†™ï¼š

**æ‰§è¡Œæ—¶é—´ï¼š** _____________

**æ‰§è¡Œçš„æ–¹æ¡ˆï¼š** â–¡ æ–¹æ¡ˆ A  â–¡ æ–¹æ¡ˆ B

**æ‰§è¡Œç»“æœï¼š**
- Windows ç«¯ token userId: _______
- Web ç«¯ token userId: _______
- Windows ç«¯è´¦å·æ•°é‡: _______
- Web ç«¯è´¦å·æ•°é‡: _______

**æ˜¯å¦è§£å†³ï¼š** â–¡ æ˜¯  â–¡ å¦

**å¤‡æ³¨ï¼š**
_____________________________________________
_____________________________________________

---

## ğŸ†˜ éœ€è¦å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š

1. **ä¸¤ä¸ªå®¢æˆ·ç«¯çš„ tokenï¼ˆè§£ç åï¼‰**
```javascript
const token = localStorage.getItem('auth_token');
const decoded = JSON.parse(atob(token.split('.')[1]));
console.log(JSON.stringify(decoded, null, 2));
```

2. **API è¿”å›çš„æ•°æ®**
```bash
# ä½¿ç”¨ curl æµ‹è¯•
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/publishing/accounts | jq '.'
```

3. **æ•°æ®åº“æŸ¥è¯¢ç»“æœ**
```bash
psql -d geo_system -c "
SELECT pa.id, pa.platform_id, pa.account_name, pa.user_id, u.username
FROM platform_accounts pa
JOIN users u ON pa.user_id = u.id
WHERE u.username IN ('lzc2005', 'testuser');
"
```

---

## âœ… é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼š

1. âœ… lzc2005 åªèƒ½çœ‹åˆ°è‡ªå·±çš„ 2 ä¸ªè´¦å·ï¼ˆID: 94, 92ï¼‰
2. âœ… testuser åªèƒ½çœ‹åˆ°è‡ªå·±çš„ 2 ä¸ªè´¦å·ï¼ˆID: 93, 90ï¼‰
3. âœ… ä¸¤ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
4. âœ… åˆ›å»ºæ–°è´¦å·æ—¶è‡ªåŠ¨å½’å±åˆ°æ­£ç¡®çš„ç”¨æˆ·

**ä¿®å¤æˆåŠŸç‡ï¼š95%+**

**é¢„è®¡æ—¶é—´ï¼š5-10 åˆ†é’Ÿ**
