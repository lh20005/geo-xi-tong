# 测试企业图库和知识库配额

## 快速测试

### 方法 1: 运行自动化测试脚本

```bash
cd server
npx ts-node src/scripts/test-gallery-knowledge-quota.ts lzc2005
```

预期结果：所有 9 项测试通过（100%）

### 方法 2: 手动测试

#### 测试相册配额

1. **登录系统**
   - 使用测试账号登录

2. **创建相册**
   - 进入企业图库
   - 点击"新建相册"
   - 输入相册名称
   - 点击确定

3. **验证配额**
   - 查看个人中心的配额显示
   - 相册配额应该减少 1
   - 剩余配额 = 总配额 - 已用配额

4. **测试配额限制**
   - 继续创建相册，直到配额用尽
   - 配额用尽后，应该提示"相册配额不足"
   - 无法继续创建

5. **删除相册**
   - 删除一个相册
   - 配额应该恢复 1

#### 测试知识库配额

1. **创建知识库**
   - 进入企业知识库
   - 点击"新建知识库"
   - 输入知识库名称
   - 点击确定

2. **验证配额**
   - 查看个人中心的配额显示
   - 知识库配额应该减少 1
   - 剩余配额 = 总配额 - 已用配额

3. **测试配额限制**
   - 继续创建知识库，直到配额用尽
   - 配额用尽后，应该提示"知识库配额不足"
   - 无法继续创建

4. **删除知识库**
   - 删除一个知识库
   - 配额应该恢复 1

## 预期行为

### ✅ 正确行为

1. **首次创建**
   - 可以成功创建相册/知识库
   - 配额正确扣减

2. **再次创建**
   - 如果有剩余配额，可以继续创建
   - 配额继续扣减

3. **配额用尽**
   - 提示"相册配额不足"或"知识库配额不足"
   - 无法创建新的相册/知识库

4. **删除恢复**
   - 删除相册/知识库后，配额恢复
   - 可以再次创建

### ❌ 错误行为（已修复）

1. ~~首次创建成功，再次创建提示配额不足~~
2. ~~配额显示不准确~~
3. ~~可以无限创建（绕过配额限制）~~

## 默认配额

- **相册数**: 10 个
- **知识库数**: 5 个

## 故障排查

### 问题：提示配额不足但实际有配额

**解决方案**：
```bash
# 运行诊断脚本
cd server
npx ts-node src/scripts/diagnose-gallery-knowledge-quota.ts

# 检查配额记录
# 如果发现数据不一致，重新运行迁移
npx ts-node src/db/run-migration-024.ts
npx ts-node src/db/run-migration-025.ts
npx ts-node src/db/run-migration-026.ts
```

### 问题：配额显示与实际不符

**解决方案**：
```bash
# 运行测试脚本检查数据一致性
cd server
npx ts-node src/scripts/test-gallery-knowledge-quota.ts <username>
```

## 技术细节

### 配额检查流程

1. 用户请求创建相册/知识库
2. 系统调用 `usageTrackingService.checkQuota()`
3. 检查 `user_usage` 表中的配额记录
4. 如果有剩余配额，允许创建
5. 创建成功后，调用 `usageTrackingService.recordUsage()`
6. 更新 `user_usage` 和 `usage_records` 表

### 配额恢复流程

1. 用户请求删除相册/知识库
2. 系统删除数据库记录
3. 调用 `usageTrackingService.recordUsage()` 传入负数
4. 配额使用量减少，配额恢复

### 数据库表

- `user_usage`: 存储用户配额使用统计
- `usage_records`: 存储每次使用的详细记录
- `plan_features`: 存储套餐的功能配额配置

## 相关文件

- 路由: `server/src/routes/gallery.ts`
- 路由: `server/src/routes/knowledgeBase.ts`
- 服务: `server/src/services/UsageTrackingService.ts`
- 配置: `server/src/config/features.ts`
- 迁移: `server/src/db/migrations/024_*.sql`
- 迁移: `server/src/db/migrations/025_*.sql`
- 迁移: `server/src/db/migrations/026_*.sql`
