# 头条号自动发布流程优化完成

## 📋 优化概述

根据用户提供的完整11步发布流程，对头条号自动发布代码进行了全面优化。

## ✅ 完整的11步发布流程

### 步骤1：点击"发布文章"菜单
- **选择器**: `#masterRoot > div > div.pgc-content > section > aside > div > div > div > div.byte-menu-inline.base_creation_tab > div.byte-menu-inline-content > div:nth-child(1) > span > a`
- **等待时间**: 5秒（菜单加载） + 5秒（页面跳转）
- **说明**: 如果不在发布页面，点击左侧菜单进入发布页面

### 步骤2：填写标题
- **选择器**: `#root > div > div.left-column > div > div.publish-editor > div.publish-editor-title-wrapper > div > div > div.title-wrapper > div > div > div > textarea`
- **等待时间**: 8秒（页面加载） + 3秒（输入稳定）
- **关键操作**:
  1. 点击标题输入框（textarea元素）
  2. 等待800ms让光标进入
  3. 三次点击选中所有文本
  4. 按Backspace清空
  5. 逐字输入标题（delay: 80ms）
  6. 验证输入结果

### 步骤3：填写正文内容（含图片）
- **正文编辑器选择器**: `#root > div > div.left-column > div > div.publish-editor > div.syl-editor-wrap > div > div.ProseMirror > p`
- **等待时间**: 2秒（光标进入） + 5秒（内容稳定）
- **新方案：按位置逐步插入文字和图片**
  
  **详细流程**：
  1. 解析内容，识别文字段落和图片的位置关系
  2. 按顺序逐个插入：
     
     **插入文字段落**：
     - 点击编辑器确保焦点
     - 使用keyboard.type逐字输入（delay: 50ms）
     - 按Enter换行
     - 等待1秒
     
     **插入图片**（遇到图片位置时）：
     - 暂停文字输入
     - 点击上传图片按钮
     - 在弹出对话框中选择本地文件
     - 等待15秒上传完成
     - **点击确定按钮关闭对话框**
     - 光标自动回到正文图片后
     - 继续输入剩余文字
  
  **关键选择器**：
  - 上传图片按钮: `#root > div > div.left-column > div > div.publish-editor > div.syl-editor-toolbar.visible.inline > div > div.syl-toolbar-tool.image.static > div > button > svg`
  - 文件输入框: `body > div:nth-child(46) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.btn-upload-scand.is-empty > div > button:nth-child(1) > div > input[type=file]`
  - 确定按钮: `body > div:nth-child(46) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.footer > div.confirm-btns > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square > span`

### 步骤4：选择封面类型（单图）
- **选择器**: `#root > div > div.left-column > div > div.form-wrap > div.form-container > div:nth-child(1) > div > div.edit-input > div > div.byte-radio-group.byte-radio-size-default.byte-radio-mode-outline.pgc-radio.article-cover-radio-group > label:nth-child(1) > span > span`
- **等待时间**: 5秒（加载） + 3秒（生效）

### 步骤5：点击上传封面
- **选择器**: `#root > div > div.left-column > div > div.form-wrap > div.form-container > div:nth-child(1) > div > div.edit-input > div > div.article-cover-images-wrap > div.article-cover-images > div > div > div > div`
- **等待时间**: 5秒（加载） + 5秒（对话框打开）

### 步骤6：选择本地文件上传
- **选择器**: `body > div:nth-child(42) > ... > input[type=file]`
- **等待时间**: 8秒（输入框出现） + 15秒（上传完成）
- **说明**: 上传文章中的第一张图片作为封面

### 步骤7：点击确定按钮
- **选择器**: `body > div:nth-child(42) > ... > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square > span`
- **等待时间**: 5秒（按钮出现） + 3秒（对话框关闭）

### 步骤8-9：点击必需选项
- **选项1选择器**: `#root > div > div.left-column > div > div.form-wrap > div.form-container > div.source-wrap > div > div.edit-input > div > div > span > label:nth-child(3) > span > div`
- **选项2选择器**: `#root > div > div.left-column > div > div.form-wrap > div.form-container > div.source-wrap > div > div.edit-input > div > div > span > span:nth-child(4) > label > span > div`
- **等待时间**: 每个选项 5秒（加载） + 3秒（生效）

### 步骤10：点击"预览并发布"按钮
- **精确选择器**: `#root > div > div.left-column > div > div.publish-footer.inline-editor > div > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square.publish-btn.publish-btn-last > span`
- **备用方案**: 通过文本查找包含"预览"和"发布"的按钮
- **等待时间**: 3秒（滚动到按钮） + 5秒（确认对话框出现）
- **关键操作**:
  1. 使用scrollIntoView滚动到按钮位置
  2. 等待2秒确保滚动完成
  3. 点击按钮

### 步骤11：点击"确认发布"按钮
- **查找方式**: 通过文本查找"确认发布"、"发布"或"确定"按钮
- **等待时间**: 3秒（对话框加载） + 8秒（发布处理） + 10秒（观察结果）

## 🎯 关键优化点

### 1. 增加等待时间
- **页面加载**: 从5秒增加到8秒
- **图片上传**: 保持15秒（考虑网络慢的情况）
- **对话框打开**: 从3秒增加到5秒
- **选项生效**: 从2秒增加到3秒
- **滚动完成**: 从1.5秒增加到2秒

### 2. 使用精确选择器
- 所有步骤都使用用户提供的完整CSS选择器
- 每个选择器都有备用方案（简化选择器或文本查找）

### 3. 改进图片插入逻辑（重要）
**旧方案**: 先插入所有文本，再逐个粘贴图片到末尾

**新方案**: 按位置逐步插入文字和图片（完全模拟真实操作）
- 解析内容，识别文字段落和图片的位置关系
- 按顺序插入：文字 → 图片 → 文字 → 图片...
- 遇到图片位置时：
  1. **暂停文字输入**
  2. 点击上传图片按钮
  3. 在弹出对话框中选择本地文件
  4. 等待15秒上传完成
  5. **点击确定按钮关闭对话框**
  6. 光标自动回到正文图片后
  7. 继续输入剩余文字
- 每张图片通过点击上传按钮上传，而不是粘贴

### 4. 增强错误处理
- 每个步骤都有详细的日志输出
- 每个等待都有明确的时间说明
- 失败时保存截图用于调试

### 5. 模拟真实操作
- 标题输入：点击 → 选中 → 清空 → 逐字输入
- 正文输入：点击 → 逐字输入（delay: 50ms）
- 图片上传：点击按钮 → 选择文件 → 等待上传
- 按钮点击：滚动到视图 → 等待 → 点击

## 📊 时间预估

| 步骤 | 操作 | 预计时间 |
|------|------|---------|
| 1 | 点击菜单 | 10秒 |
| 2 | 填写标题 | 11秒 |
| 3 | 填写正文（含图片） | 根据内容长度和图片数量，每张图片约20秒 |
| 4 | 选择单图 | 8秒 |
| 5 | 点击上传封面 | 10秒 |
| 6 | 上传封面文件 | 23秒 |
| 7 | 确认上传 | 8秒 |
| 8-9 | 点击选项 | 16秒 |
| 10 | 点击预览并发布 | 8秒 |
| 11 | 确认发布 | 21秒 |

**总计**: 约115秒 + 正文内容时间（每张图片约20秒）

例如：
- 无图片文章：约120秒（2分钟）
- 3张图片文章：约180秒（3分钟）
- 5张图片文章：约220秒（3.5分钟）

## 🔧 技术细节

### 标题输入框
- **元素类型**: `<textarea>`（不是input）
- **验证方式**: 读取`value`属性
- **备用方案**: 直接设置value + 触发input/change事件

### 正文编辑器
- **编辑器类型**: ProseMirror
- **元素类型**: `<div class="ProseMirror" contenteditable="true">`
- **插入方式**: keyboard.type（模拟真实输入）
- **插入顺序**: 按内容位置逐步插入文字和图片

### 图片上传（正文中的图片）
- **方式**: 文件上传（不是剪贴板粘贴）
- **完整流程**: 
  1. 输入图片前的文字
  2. 点击上传图片按钮
  3. 弹出对话框
  4. 选择本地文件
  5. 等待15秒上传完成
  6. **点击确定按钮关闭对话框**
  7. 光标回到图片后
  8. 继续输入剩余文字
- **等待时间**: 15秒上传 + 3秒关闭对话框

### 发布按钮
- **查找方式**: 
  1. 优先使用精确选择器
  2. 备用：通过文本查找
- **滚动方式**: scrollIntoView({ behavior: 'auto', block: 'center' })
- **等待时间**: 2秒确保滚动完成

## 📝 使用说明

### 1. 文件位置
```
server/src/services/adapters/ToutiaoAdapter.ts
```

### 2. 测试方法
```bash
# 启动服务器
npm run dev

# 在前端创建发布任务，选择头条号平台
# 观察控制台日志，查看每步执行情况
```

### 3. 调试技巧
- 查看控制台日志，每步都有详细输出
- 如果失败，查看截图文件：
  - `toutiao-publish-page.png`：发布页面初始状态
  - `toutiao-button-not-found.png`：找不到按钮时的状态

### 4. 常见问题

**Q: 标题没有输入成功？**
A: 检查是否点击了标题框，光标是否进入。查看日志中的"已执行点击命令"。

**Q: 图片没有上传？**
A: 检查图片路径是否正确，是否存在。查看日志中的"图片路径转换"。

**Q: 找不到发布按钮？**
A: 查看截图文件，确认按钮是否在页面上。可能需要调整滚动逻辑。

**Q: 网络慢导致超时？**
A: 可以增加等待时间，特别是图片上传的15秒等待。

## ✅ 测试清单

- [ ] 标题正确输入（不包含正文内容）
- [ ] 正文正确输入（不包含标题）
- [ ] 图片按位置正确插入
- [ ] 封面图片正确上传
- [ ] 所有选项正确勾选
- [ ] 发布按钮成功点击
- [ ] 确认对话框成功点击
- [ ] 文章成功发布

## 🎉 总结

本次优化完全按照用户提供的11步流程实现，每步都有：
1. ✅ 精确的CSS选择器
2. ✅ 充足的等待时间
3. ✅ 详细的日志输出
4. ✅ 完善的错误处理
5. ✅ 备用方案

特别优化了图片插入逻辑，改为按位置逐步插入，更符合真实操作流程。
