# 微信支付配置获取详细指南（小白版）

## 📋 配置信息清单

你需要获取以下 6 个配置：

1. **MCHID**（商户号）- 10位数字
2. **APPID**（应用ID）- wx开头的18位字符
3. **SERIAL_NO**（证书序列号）- 40位字符
4. **PRIVATE_KEY**（API私钥）- 证书文件内容
5. **APIV3_KEY**（APIv3密钥）- 32位字符串
6. **NOTIFY_URL**（回调地址）- 你的服务器地址

---

## 🚀 第一步：注册微信支付商户

### 前提条件
- 已有微信公众号或小程序（需认证）
- 营业执照、法人身份证等资料

### 申请步骤

1. **登录微信公众平台**
   ```
   网址：https://mp.weixin.qq.com
   使用管理员微信扫码登录
   ```

2. **开通微信支付**
   ```
   左侧菜单：广告与服务 → 微信支付 → 点击"开通"
   ```

3. **填写资料**
   - 选择商户类型（企业/个体工商户）
   - 上传营业执照
   - 填写企业信息
   - 填写法人信息
   - 填写结算账户

4. **等待审核**（1-5个工作日）

---

## 📝 第二步：获取商户号（MCHID）

### 获取位置

**方法一：商户平台**
```
1. 访问：https://pay.weixin.qq.com
2. 管理员微信扫码登录
3. 右上角显示商户号（10位数字）
```

**方法二：开通邮件**
```
查看微信支付发送的开通邮件
邮件中会标注商户号
```

### 示例
```
WECHAT_PAY_MCHID=1234567890
```

---

## 🔐 第三步：获取应用ID（APPID）

⚠️ **重要说明：Native 支付（网站扫码支付）也需要 APPID！**

即使你是网站支付，不是小程序，也必须有一个 APPID。你有两个选择：

### 方案一：使用微信公众号（推荐）

**1. 申请服务号**
```
1. 访问：https://mp.weixin.qq.com
2. 注册类型：服务号（企业）
3. 提交认证（需要300元认证费）
4. 等待审核通过
```

**2. 获取 APPID**
```
1. 登录公众号后台：https://mp.weixin.qq.com
2. 左侧菜单：设置与开发 → 基本配置
3. 找到"开发者ID(AppID)"
4. 格式：wx1234567890abcdef（wx开头，18位）
```

**3. 关联商户号**
```
1. 登录微信支付商户平台：https://pay.weixin.qq.com
2. 顶部菜单：产品中心 → AppID账号管理
3. 点击"关联AppID"
4. 输入你的公众号 APPID
5. 管理员微信扫码确认
```

### 方案二：使用微信开放平台（网站应用）

**1. 注册开放平台**
```
1. 访问：https://open.weixin.qq.com
2. 注册开发者账号
3. 提交认证（需要300元认证费）
```

**2. 创建网站应用**
```
1. 管理中心 → 网站应用 → 创建网站应用
2. 填写网站名称、简介
3. 填写网站域名（必须已备案）
4. 上传网站截图
5. 提交审核
6. 审核通过后获得 APPID
```

**3. 关联商户号**
```
1. 登录微信支付商户平台：https://pay.weixin.qq.com
2. 产品中心 → AppID账号管理
3. 关联你的网站应用 APPID
```

### 小程序获取（如果你有小程序）

```
1. 登录：https://mp.weixin.qq.com
2. 左侧菜单：开发 → 开发管理 → 开发设置
3. 找到"AppID(小程序ID)"
```

### 配置示例
```
WECHAT_PAY_APPID=wx1234567890abcdef
```

### 常见问题

**Q: 我只是网站支付，为什么需要公众号或开放平台？**
A: 微信支付要求所有支付方式都必须关联一个 APPID，这是微信的身份识别机制。

**Q: 公众号和开放平台有什么区别？**
A: 
- 公众号：适合有微信运营需求的企业，可以发文章、做客服
- 开放平台：纯粹用于网站登录和支付，不需要运营

**Q: 认证费可以退吗？**
A: 不可以，认证费是支付给第三方认证机构的，不可退

---

## 🔑 第四步：获取API证书

### 4.1 下载证书工具

```
1. 访问：https://kf.qq.com/faq/161222NneAJf161222U7fARv.html
2. 根据系统下载：
   - Windows版本
   - Mac版本
3. 安装并打开工具
```

### 4.2 申请证书

**在商户平台操作：**
```
1. 登录：https://pay.weixin.qq.com
2. 顶部菜单：账户中心 → API安全 → API证书
3. 点击"申请证书"
```

**使用证书工具：**
```
1. 打开证书工具
2. 输入商户号
3. 输入商户名称
4. 点击"生成证书请求串"
5. 复制生成的请求串
```

**提交申请：**
```
1. 回到商户平台
2. 粘贴请求串
3. 点击"下一步"
4. 管理员微信扫码确认
5. 点击"下载证书"
```

### 4.3 解压证书

下载的压缩包包含：
- `apiclient_cert.pem`（证书）
- `apiclient_key.pem`（私钥）⭐ 重要
- `apiclient_cert.p12`（旧版证书）

### 4.4 获取证书序列号（SERIAL_NO）

**方法一：商户平台查看**
```
在"API安全 → API证书"页面
找到证书，查看"证书序列号"
40位十六进制字符
```

**方法二：命令查看**
```bash
openssl x509 -in apiclient_cert.pem -noout -serial
```

### 4.5 获取私钥内容（PRIVATE_KEY）

```
1. 用文本编辑器打开 apiclient_key.pem
   - Windows：记事本
   - Mac：文本编辑

2. 复制完整内容（包括开头结尾标记）：
```

```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
（很多行内容）
...xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
-----END PRIVATE KEY-----
```

⚠️ **注意：**
- 必须包含 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`
- 保持原有换行格式
- 不要删除任何字符

### 配置示例
```env
WECHAT_PAY_SERIAL_NO=1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T

WECHAT_PAY_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
-----END PRIVATE KEY-----"
```

---

## 🔐 第五步：设置APIv3密钥

### 什么是APIv3密钥？
- 32位字符串
- 用于加密通信
- 需要你自己设置

### 设置步骤

```
1. 登录：https://pay.weixin.qq.com
2. 顶部菜单：账户中心 → API安全 → APIv3密钥
3. 点击"设置密钥"或"修改密钥"
4. 输入32位字符串
5. 管理员微信扫码确认
```

### 生成随机密钥

**在线生成：**
```
访问：https://suijimimashengcheng.51240.com
选择32位长度
包含大小写字母和数字
```

**命令生成（Mac/Linux）：**
```bash
openssl rand -base64 32 | cut -c1-32
```

**示例密钥：**
```
Abc123Def456Ghi789Jkl012Mno345
```

⚠️ **重要：设置后请立即保存，页面不会再显示**

### 配置示例
```env
WECHAT_PAY_APIV3_KEY=Abc123Def456Ghi789Jkl012Mno345
```

---

## 🌐 第六步：配置回调地址

### 什么是回调地址？
用户支付成功后，微信向这个地址发送通知

### 格式要求
- 必须是 `https://` 开头
- 必须是公网可访问
- 路径：`/api/payment/wechat/notify`

### 示例
```
https://yourdomain.com/api/payment/wechat/notify
```

### 测试环境方案
如果还没有域名，可以使用内网穿透：
- ngrok：https://ngrok.com
- 花生壳：https://hsk.oray.com

### 配置示例
```env
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payment/wechat/notify
```

---

## 📄 第七步：填写配置文件

### 找到配置文件
```
项目根目录的 .env 文件
如果没有，复制 .env.example 并重命名
```

### 完整配置示例

```env
# 微信支付配置
WECHAT_PAY_APPID=wx1234567890abcdef
WECHAT_PAY_MCHID=1234567890
WECHAT_PAY_SERIAL_NO=1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T
WECHAT_PAY_APIV3_KEY=Abc123Def456Ghi789Jkl012Mno345
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payment/wechat/notify

# 私钥（保持格式）
WECHAT_PAY_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
（私钥内容）
-----END PRIVATE KEY-----"
```

### 配置注意事项

⚠️ **重要：**
1. 私钥用双引号包裹
2. 私钥包含开头结尾标记
3. 私钥保留换行
4. 不要加分号或逗号
5. 不要泄露配置

---

## ✅ 第八步：验证配置

### 检查清单

- [ ] APPID 以 wx 开头，18位
- [ ] MCHID 是 10位数字
- [ ] SERIAL_NO 是 40位字符
- [ ] APIV3_KEY 是 32位字符
- [ ] PRIVATE_KEY 包含完整标记
- [ ] NOTIFY_URL 是 https 开头

### 测试配置

```bash
bash test-wechat-pay-config.sh
```

成功显示：
```
✅ 微信支付配置验证成功
```

---

## 🆘 常见问题

### Q1: 找不到商户号？
```
登录 https://pay.weixin.qq.com
右上角显示商户号
```

### Q2: 证书工具下载不了？
```
- 换浏览器
- 关闭防火墙
- 访问腾讯客服
```

### Q3: 私钥文件打不开？
```
Windows：右键 → 记事本
Mac：右键 → 文本编辑
```

### Q4: APIv3密钥忘记了？
```
可以重新设置，不影响其他配置
```

### Q5: 必须用HTTPS吗？
```
是的，微信支付强制要求
测试可用内网穿透工具
```

---

## 📞 获取帮助

**微信支付官方文档：**
https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml

**微信支付客服：**
- 商户平台右上角 → 帮助中心
- 电话：95017

**项目文档：**
- `WECHAT_PAY_SETUP_GUIDE.md`
- `README_WECHAT_PAY.md`

---

## 🔒 安全提醒

⚠️ **务必注意：**

1. **不要泄露**
   - 不要上传 .env 到 GitHub
   - 不要公开分享配置
   - 不要截图密钥

2. **定期更换**
   - 每3-6个月更换APIv3密钥
   - 怀疑泄露立即更换

3. **备份证书**
   - 保存在安全位置
   - 多处备份

---

## 🎉 完成

配置完成后：
1. 重启服务器
2. 测试支付功能
3. 查看支付日志

祝使用愉快！🚀
