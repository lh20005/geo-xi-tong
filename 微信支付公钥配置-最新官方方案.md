# 微信支付公钥配置 - 最新官方方案

> **官方文档：** https://pay.weixin.qq.com/doc/v3/partner/4012925323

## ⚠️ 重要说明

**微信支付已推出新的公钥模式，不再需要平台证书！**

- ❌ **旧方案（已废弃）：** 平台证书模式 - 需要下载和管理平台证书
- ✅ **新方案（推荐）：** 微信支付公钥模式 - 只需下载一次公钥

---

## 📋 什么是微信支付公钥？

微信支付公钥用于：
1. **验签** - 验证微信支付的应答和回调是否真实
2. **加密** - 加密敏感信息（如姓名）上传给微信支付

---

## 🔑 如何获取微信支付公钥

### 步骤 1: 登录商户平台

1. 超级管理员或安全联系人登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心** → **API安全**

### 步骤 2: 申请公钥

1. 点击 **"申请公钥"** 按钮
2. 下载微信支付公钥文件（`pub_key.pem`）
3. **重要：记录公钥ID** - 在下载页面会显示公钥ID

### 步骤 3: 保存公钥

```bash
# 创建目录
mkdir -p ~/.wechat-pay

# 保存公钥文件
cp ~/Downloads/pub_key.pem ~/.wechat-pay/wechat_pay_public_key.pem
```

---

## 🛠️ 配置说明

### 环境变量配置 (server/.env)

```env
# 微信支付配置
WECHAT_PAY_APP_ID=你的AppID
WECHAT_PAY_MCH_ID=你的商户号
WECHAT_PAY_API_V3_KEY=你的APIv3密钥（32字符）
WECHAT_PAY_SERIAL_NO=你的商户证书序列号
WECHAT_PAY_PRIVATE_KEY_PATH=/Users/你的用户名/.wechat-pay/apiclient_key.pem
WECHAT_PAY_NOTIFY_URL=https://你的域名/api/payment/wechat/notify

# 可选：如果知道公钥ID，可以配置
# WECHAT_PAY_PUBLIC_KEY_ID=PUB_KEY_ID_xxxxx
```

### 代码配置

```typescript
// server/src/services/PaymentService.ts
this.wechatpay = new Wechatpay({
  mchid: mchId,
  serial: serialNo,
  privateKey: privateKey,
  // 不需要传入 certs 参数
  // SDK 会自动处理验签
});
```

---

## ✅ 验证配置

### 1. 检查文件

```bash
# 检查私钥文件
ls -la ~/.wechat-pay/apiclient_key.pem

# 检查公钥文件（可选）
ls -la ~/.wechat-pay/wechat_pay_public_key.pem
```

### 2. 测试服务启动

```bash
cd server
npm run dev
```

应该看到：
```
✅ 微信支付初始化成功（简化配置模式）
```

### 3. 测试创建订单

访问系统并尝试创建订单，检查是否能正常生成二维码。

---

## 🔄 新旧方案对比

| 特性 | 旧方案（平台证书） | 新方案（微信支付公钥） |
|------|------------------|---------------------|
| 证书管理 | 需要定期下载更新 | 一次下载，长期有效 |
| 配置复杂度 | 复杂 | 简单 |
| SDK 支持 | 需要手动配置 certs | SDK 自动处理 |
| 推荐程度 | ❌ 已废弃 | ✅ 官方推荐 |

---

## 📝 常见问题

### Q1: 还需要下载平台证书吗？

**不需要！** 使用微信支付公钥模式后，不再需要平台证书。

### Q2: 公钥ID是什么？

公钥ID是微信支付公钥的唯一标识，格式类似：`PUB_KEY_ID_xxxxx`

在商户平台下载公钥时会显示，用于标识具体使用哪个公钥。

### Q3: 如果不知道公钥ID怎么办？

不用担心！SDK 可以不传入公钥ID，会自动处理验签。

### Q4: 旧的平台证书代码需要删除吗？

建议删除或注释掉所有关于平台证书的代码，避免混淆。

---

## 🚫 不要做的事情

1. ❌ 不要尝试下载平台证书
2. ❌ 不要配置 `certs` 参数（除非你明确知道公钥ID）
3. ❌ 不要使用 `download-platform-cert.ts` 脚本
4. ❌ 不要参考旧的平台证书文档

---

## ✅ 推荐做法

1. ✅ 从商户平台下载微信支付公钥
2. ✅ 保存公钥文件到 `~/.wechat-pay/`
3. ✅ 使用简化的 SDK 配置（不传入 certs）
4. ✅ 让 SDK 自动处理验签

---

## 📚 参考资料

- [微信支付公钥产品简介](https://pay.weixin.qq.com/doc/v3/partner/4012925323)
- [如何使用微信支付公钥验签](https://pay.weixin.qq.com/doc/v3/merchant/4012925324)
- [如何从平台证书切换到微信支付公钥](https://pay.weixin.qq.com/doc/v3/merchant/4012925325)

---

## 🎯 总结

**微信支付公钥模式是官方推荐的最新方案：**

- 更简单 - 不需要管理证书
- 更安全 - 公钥长期有效
- 更方便 - SDK 自动处理

**请忘记平台证书，拥抱微信支付公钥！** 🚀
