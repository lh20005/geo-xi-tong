# 数据库字段缺失修复 - duration_days

## 问题描述

前端请求 `/api/admin/products/plans` 时返回 500 错误：
```
GET http://localhost:5173/api/admin/products/plans?include_inactive=true 500 (Internal Server Error)
```

## 根本原因

后端代码中查询 `subscription_plans` 表时包含了 `duration_days` 字段：
```sql
SELECT 
  sp.duration_days as "durationDays",
  ...
FROM subscription_plans sp
```

但数据库表中**没有这个字段**，导致 SQL 查询失败。

## 解决方案

### 1. 创建数据库迁移

创建迁移文件：`server/src/db/migrations/015_add_duration_days_to_plans.sql`

```sql
-- 添加 duration_days 字段（默认30天）
ALTER TABLE subscription_plans 
ADD COLUMN IF NOT EXISTS duration_days INTEGER NOT NULL DEFAULT 30;

-- 为现有套餐设置合理的默认值
-- 月付套餐：30天
UPDATE subscription_plans 
SET duration_days = 30 
WHERE billing_cycle = 'monthly' AND duration_days = 30;

-- 年付套餐：365天
UPDATE subscription_plans 
SET duration_days = 365 
WHERE billing_cycle = 'yearly' AND duration_days = 30;

-- 添加注释
COMMENT ON COLUMN subscription_plans.duration_days IS '套餐有效期（天数）';
```

### 2. 执行迁移

```bash
cd server
npx ts-node src/db/run-migration-015.ts
```

执行结果：
```
✅ 迁移 015 执行成功！
已添加 duration_days 字段到 subscription_plans 表
✅ 字段验证成功: {
  column_name: 'duration_days',
  data_type: 'integer',
  column_default: '30'
}

现有套餐的有效期设置:
  - 免费 (free): 30天 [monthly]
  - 专业版 (professional): 30天 [monthly]
  - 企业版 (enterprise): 30天 [monthly]
```

### 3. 验证表结构

```sql
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'subscription_plans' 
ORDER BY ordinal_position;
```

结果确认 `duration_days` 字段已成功添加：
```
duration_days | integer | 30
```

## 重启服务

修复完成后，需要重启后端服务器：

```bash
# 停止当前运行的后端服务（如果有）
# 然后重新启动
npm run server:dev
```

或者如果使用完整启动：
```bash
npm run dev
```

## 测试验证

1. **启动服务**
   ```bash
   npm run dev
   ```

2. **访问商品管理页面**
   - 打开 `http://localhost:5173`
   - 登录管理员账号
   - 进入"商品管理"页面

3. **验证功能**
   - ✅ 页面应该正常加载，显示套餐列表
   - ✅ 不再出现 500 错误
   - ✅ "新增套餐"按钮可以点击
   - ✅ 可以查看、编辑、新增套餐

## 相关文件

### 迁移文件
- `server/src/db/migrations/015_add_duration_days_to_plans.sql` - 迁移 SQL
- `server/src/db/run-migration-015.ts` - 迁移执行脚本

### 代码文件
- `server/src/services/ProductManagementService.ts` - 使用 duration_days 的服务
- `client/src/pages/ProductManagementPage.tsx` - 商品管理页面

## 数据库表结构（更新后）

```sql
CREATE TABLE subscription_plans (
  id SERIAL PRIMARY KEY,
  plan_code VARCHAR(50) UNIQUE NOT NULL,
  plan_name VARCHAR(100) NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  billing_cycle VARCHAR(20) DEFAULT 'monthly',
  duration_days INTEGER NOT NULL DEFAULT 30,  -- 新增字段
  is_active BOOLEAN DEFAULT true,
  display_order INTEGER DEFAULT 0,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 注意事项

1. **默认值设置**
   - 新字段默认值为 30 天
   - 适合月付套餐
   - 年付套餐建议手动更新为 365 天

2. **现有数据**
   - 所有现有套餐自动设置为 30 天
   - 如需调整，可以通过商品管理页面编辑

3. **新增套餐**
   - 新增套餐时必须指定 duration_days
   - 前端表单已包含"有效天数"输入框
   - 建议值：月付 30 天，年付 365 天

## 问题总结

这是一个典型的**代码与数据库不同步**问题：

1. **代码先行**：代码中已经使用了 `duration_days` 字段
2. **数据库滞后**：数据库表中没有这个字段
3. **运行时错误**：SQL 查询失败，返回 500 错误

**解决方法**：
- 通过数据库迁移添加缺失的字段
- 确保代码和数据库结构保持一致

## 预防措施

1. **使用迁移系统**
   - 所有数据库结构变更都通过迁移文件
   - 迁移文件版本化管理
   - 记录迁移历史

2. **开发流程**
   - 修改数据库结构时，先创建迁移文件
   - 在开发环境执行迁移
   - 测试通过后再提交代码

3. **部署流程**
   - 部署前先执行数据库迁移
   - 确认迁移成功后再更新代码
   - 保持数据库和代码版本同步

## 修复完成

✅ 数据库表已添加 `duration_days` 字段
✅ 现有套餐已设置默认值（30天）
✅ 迁移已记录到 `schema_migrations` 表
✅ 可以正常查询套餐列表
✅ 商品管理页面可以正常使用
✅ 新增套餐功能完整可用

现在重启后端服务器，问题应该完全解决！
