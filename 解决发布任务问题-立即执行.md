# 解决发布任务问题 - 立即执行

## 🔴 问题

点击"创建发布任务"后：
- ❌ 任务没有被记录到"发布任务"列表中
- ❌ 没有打开浏览器自动发布的动作

## ✅ 一键修复

```bash
./quick-fix-publishing.sh
```

这个脚本会自动：
1. ✅ 检查环境配置
2. ✅ 运行数据库迁移
3. ✅ 检查平台配置
4. ✅ 检查 Puppeteer 安装
5. ✅ 测试服务器状态

## 📋 手动排查（如果一键修复失败）

### 步骤1：诊断问题

```bash
./diagnose-publishing-issue.sh
```

查看输出，找到问题所在。

### 步骤2：测试API

```bash
./test-create-task-api.sh
```

这会创建一个测试任务并显示详细信息。

### 步骤3：查看详细指南

```bash
cat 发布任务故障排查指南.md
```

## 🎯 最可能的原因

### 原因1：数据库表不存在（90%）

**症状：**
- 创建任务时返回 400 或 500 错误
- 服务器日志显示 "relation does not exist"

**解决：**
```bash
./run-publishing-migration.sh
```

### 原因2：没有绑定账号（5%）

**症状：**
- 前端显示"暂无可用平台"
- 或者无法选择账号

**解决：**
1. 进入"平台登录"页面
2. 选择平台并点击"浏览器登录"
3. 完成登录流程

### 原因3：Puppeteer 未安装（3%）

**症状：**
- 任务创建成功但不执行
- 服务器日志显示 "Cannot find module 'puppeteer'"

**解决：**
```bash
cd server
npm install puppeteer
```

### 原因4：服务器未运行（2%）

**症状：**
- 前端显示网络错误
- 无法连接到服务器

**解决：**
```bash
cd server
npm run dev
```

## 🔍 验证修复

### 1. 检查数据库

```bash
source .env
psql "$DATABASE_URL" -c "SELECT COUNT(*) FROM publishing_tasks;"
```

应该看到任务数量。

### 2. 检查服务器日志

启动服务器后，应该看到：
```
✅ 数据库连接成功
Server running on port 3001
```

### 3. 测试创建任务

1. 打开应用
2. 进入"文章管理"页面
3. 点击"发布到平台"
4. 选择平台和账号
5. 点击"创建发布任务"

**成功的标志：**
- ✅ 前端显示"成功创建 1 个发布任务"
- ✅ 服务器日志显示"✅ 任务 #X 已创建并开始自动执行"
- ✅ 浏览器自动打开（如果是立即发布）
- ✅ "发布记录"页面显示新任务

## 📞 仍然有问题？

### 收集诊断信息

```bash
# 1. 运行诊断
./diagnose-publishing-issue.sh > diagnosis.txt 2>&1

# 2. 测试API
./test-create-task-api.sh > test-result.txt 2>&1

# 3. 查看服务器日志
# 复制服务器终端的输出

# 4. 查看浏览器控制台
# F12 -> Console -> 复制错误信息
```

### 常用命令

```bash
# 查看数据库表
source .env
psql "$DATABASE_URL" -c "\dt"

# 查看任务
psql "$DATABASE_URL" -c "SELECT * FROM publishing_tasks ORDER BY id DESC LIMIT 5;"

# 查看日志
psql "$DATABASE_URL" -c "SELECT * FROM publishing_logs ORDER BY id DESC LIMIT 10;"

# 测试服务器
curl http://localhost:3001/api/health

# 测试API
curl http://localhost:3001/api/publishing/tasks
```

## 🎉 成功标志

修复成功后，你应该能够：

1. ✅ 在"平台登录"页面看到已绑定的账号
2. ✅ 在"文章管理"页面点击"发布到平台"
3. ✅ 选择平台和账号
4. ✅ 创建发布任务
5. ✅ 在"发布记录"页面看到任务
6. ✅ 浏览器自动打开并登录平台
7. ✅ 文章自动发布

---

**大多数问题都可以通过运行一键修复脚本解决：**
```bash
./quick-fix-publishing.sh
```

**如果还有问题，请查看详细指南：**
```bash
cat 发布任务故障排查指南.md
```
