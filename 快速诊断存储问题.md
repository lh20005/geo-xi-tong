# 快速诊断存储上传问题

## 问题现象

- 图片和文档无法上传
- 提示"额度不足"
- 前端显示"存储空间剩余 0 / 20"（明显错误）

## 快速诊断命令

### 1. 检查存储配额（已完成）

```bash
cd server
npx ts-node src/scripts/diagnose-storage-quota.ts lzc2005
```

**结果**: 存储空间充足（剩余 1004.86 MB）

### 2. 检查功能配额（已完成）

```bash
cd server
npx ts-node src/scripts/test-gallery-knowledge-quota.ts lzc2005
```

**结果**: 功能配额正常（相册 9/10，知识库 4/5）

### 3. 检查前端 API 调用

在浏览器控制台运行：

```javascript
// 检查存储使用情况 API
fetch('/api/storage/usage', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(data => console.log('存储使用情况:', data))
.catch(err => console.error('错误:', err));

// 检查用户配额 API
fetch('/api/usage-tracking/quota', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
})
.then(r => r.json())
.then(data => console.log('功能配额:', data))
.catch(err => console.error('错误:', err));
```

### 4. 尝试上传并查看错误

在浏览器控制台：
1. 打开 Network 标签
2. 尝试上传图片
3. 查看失败的请求
4. 点击请求查看 Response

## 可能的问题和解决方案

### 问题 1: 前端显示错误

**症状**: 显示"0 / 20"而不是"19.14 / 1024 MB"

**原因**: 前端可能在显示功能配额（个数）而不是存储配额（MB）

**解决**: 检查前端代码，确保显示的是 `storage_quota` 而不是其他配额

### 问题 2: API 返回错误数据

**症状**: API 返回的配额数据不正确

**解决**: 
```bash
# 同步存储数据
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

### 问题 3: 缓存问题

**症状**: 数据库正确但前端显示错误

**解决**:
1. 清除浏览器缓存
2. 重新登录
3. 重启服务器

### 问题 4: 权限问题

**症状**: 403 Forbidden 错误

**解决**: 检查用户是否有上传权限

## 需要的信息

请提供以下信息以便进一步诊断：

1. **浏览器控制台的错误信息**
   - 打开 F12 开发者工具
   - 切换到 Console 标签
   - 尝试上传
   - 截图或复制错误信息

2. **Network 请求详情**
   - 打开 F12 开发者工具
   - 切换到 Network 标签
   - 尝试上传
   - 找到失败的请求
   - 查看 Response 内容

3. **前端显示的具体文字**
   - "存储空间剩余 0 / 20" 这个显示在哪个页面？
   - 截图会更好

## 临时解决方案

如果需要立即使用，可以：

### 方案 1: 增加配额

```sql
-- 连接数据库
psql -d your_database

-- 增加存储配额到 10 GB
UPDATE user_storage_usage 
SET storage_quota_bytes = 10737418240 
WHERE user_id = (SELECT id FROM users WHERE username = 'lzc2005');
```

### 方案 2: 重置存储记录

```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

### 方案 3: 重启服务

```bash
# 停止服务
# 重新启动
npm run dev
```

## 联系支持

如果以上方法都无法解决，请提供：
1. 浏览器控制台截图
2. Network 请求详情
3. 服务器日志（如果可以访问）

---

**创建时间**: 2026-01-04  
**状态**: 等待用户反馈
