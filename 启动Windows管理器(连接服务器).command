#!/bin/bash

# Windowsç™»å½•ç®¡ç†å™¨ - è¿žæŽ¥è¿œç¨‹æœåŠ¡å™¨ç‰ˆ
# ç”¨äºŽæœ¬åœ°è°ƒè¯•ï¼Œè¿žæŽ¥åˆ°ç”Ÿäº§æœåŠ¡å™¨ jzgeo.cc

cd "$(dirname "$0")"
echo -ne "\033]0;Windowsç®¡ç†å™¨(æœåŠ¡å™¨)\007"

clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ–¥ï¸  Windowsç™»å½•ç®¡ç†å™¨ - è¿žæŽ¥æœåŠ¡å™¨æ¨¡å¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. ç³»ç»Ÿæ£€æŸ¥
echo "ðŸ” [1/3] ç³»ç»ŸçŽ¯å¢ƒæ£€æŸ¥..."
if ! command -v node &> /dev/null; then
    echo "âŒ æœªæ‰¾åˆ° Node.jsï¼Œè¯·å…ˆå®‰è£…: https://nodejs.org/"
    read -p "æŒ‰å›žè½¦é”®é€€å‡º..." && exit 1
fi

echo "   âœ… Node.js: $(node -v)"
echo "   âœ… npm: $(npm -v)"
echo ""

# 2. æ£€æŸ¥ä¾èµ–
echo "ðŸ“¦ [2/3] æ£€æŸ¥ä¾èµ–åŒ…..."
cd windows-login-manager
if [ ! -d "node_modules" ]; then
    echo "   ðŸ”„ å®‰è£…ä¾èµ–åŒ…..."
    npm install
fi
echo "   âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
echo ""

# 3. é…ç½®çŽ¯å¢ƒå˜é‡ï¼ˆè¿žæŽ¥æœåŠ¡å™¨ï¼‰
echo "âš™ï¸  [3/3] é…ç½®æœåŠ¡å™¨è¿žæŽ¥..."

# å¤‡ä»½åŽŸæœ‰ .envï¼ˆå¦‚æžœå­˜åœ¨ä¸”ä¸æ˜¯æœåŠ¡å™¨é…ç½®ï¼‰
if [ -f ".env" ] && ! grep -q "jzgeo.cc" .env; then
    cp .env .env.local.backup
    echo "   ðŸ“‹ å·²å¤‡ä»½æœ¬åœ°é…ç½®åˆ° .env.local.backup"
fi

# å†™å…¥æœåŠ¡å™¨é…ç½®
cat > .env << 'EOF'
# åŽç«¯APIåŸºç¡€åœ°å€ï¼ˆä¸åŒ…å« /apiï¼‰- è¿žæŽ¥åˆ°ç”Ÿäº§æœåŠ¡å™¨
VITE_API_BASE_URL=https://www.jzgeo.cc

# WebSocketåŸºç¡€åœ°å€ï¼ˆåŒ…å« /ws è·¯å¾„ï¼‰
VITE_WS_BASE_URL=wss://www.jzgeo.cc/ws

# Landingé¡µé¢åœ°å€
VITE_LANDING_URL=https://www.jzgeo.cc

# åº”ç”¨çŽ¯å¢ƒ
NODE_ENV=development

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=debug
EOF

echo "   âœ… å·²é…ç½®è¿žæŽ¥åˆ°: https://www.jzgeo.cc"
echo ""

# 4. å¯åŠ¨åº”ç”¨
echo "ðŸš€ å¯åŠ¨ Windows ç™»å½•ç®¡ç†å™¨..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“‹ è¿žæŽ¥ä¿¡æ¯:"
echo "   â€¢ åŽç«¯API:    https://www.jzgeo.cc/api"
echo "   â€¢ WebSocket:  wss://www.jzgeo.cc/ws"
echo "   â€¢ æœ¬åœ°ç«¯å£:   http://localhost:5174"
echo ""
echo "âš ï¸  æ“ä½œæç¤º:"
echo "   â€¢ ä¿æŒæ­¤çª—å£æ‰“å¼€ä»¥æŸ¥çœ‹æ—¥å¿—"
echo "   â€¢ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡"
echo "   â€¢ å…³é—­çª—å£å°†åœæ­¢æœåŠ¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# å¯åŠ¨ Electron å¼€å‘æ¨¡å¼ï¼ˆé€šè¿‡çŽ¯å¢ƒå˜é‡ä¼ é€’æœåŠ¡å™¨åœ°å€ï¼‰
API_BASE_URL=https://www.jzgeo.cc npm run electron:dev

# æœåŠ¡åœæ­¢åŽçš„æ¸…ç†
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ›‘ Windows ç™»å½•ç®¡ç†å™¨å·²åœæ­¢"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
read -p "æŒ‰å›žè½¦é”®é€€å‡º..."
