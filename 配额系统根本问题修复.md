# 配额系统根本问题修复

## 问题现象

用户反馈即使有配额，也无法生成文章和上传图片，提示"配额不足"。

## 根本原因分析

### 1. **record_feature_usage 函数过时**

在迁移 016 中，功能代码从 `articles_per_day` 改为 `articles_per_month`，但 `record_feature_usage` 函数中的 CASE 语句没有更新：

```sql
-- ❌ 旧代码（迁移 014）
CASE p_feature_code
  WHEN 'articles_per_day', 'publish_per_day' THEN  -- 不匹配新的功能代码
    v_reset_period := 'daily';
    v_period_start := DATE_TRUNC('day', CURRENT_TIMESTAMP);
    v_period_end := v_period_start + INTERVAL '1 day';  -- 设置为明天
```

由于不匹配，走到 ELSE 分支，导致：
- `period_end` 设置为 `2099-12-31`（永久）
- 但实际应该是月底

### 2. **user_usage 表周期错误**

诊断发现 `period_end` 是明天而不是月底：
```
period_start: Thu Jan 01 2026 00:00:00
period_end: Mon Jan 05 2026 00:00:00  ❌ 应该是 Sun Feb 01 2026
```

### 3. **usage_count 字段问题**

诊断显示 `current_usage: undefined`，说明 `usage_count` 字段可能为 NULL。

## 修复方案

### 迁移 022: 系统性修复

创建了 `022_fix_quota_system.sql` 迁移，包含：

#### 1. 更新 record_feature_usage 函数

```sql
CASE p_feature_code
  -- ✅ 支持月度配额
  WHEN 'articles_per_month', 'publish_per_month', 'keyword_distillation' THEN
    v_reset_period := 'monthly';
    v_period_start := DATE_TRUNC('month', CURRENT_TIMESTAMP);
    v_period_end := v_period_start + INTERVAL '1 month';  -- 月底
  -- 永久配额（如平台账号数）
  ELSE
    v_reset_period := 'never';
    v_period_start := '2000-01-01'::TIMESTAMP;
    v_period_end := '2099-12-31'::TIMESTAMP;
END CASE;
```

#### 2. 修正所有用户的配额周期

```sql
UPDATE user_usage
SET 
  period_start = DATE_TRUNC('month', CURRENT_DATE),
  period_end = DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month',
  last_reset_at = DATE_TRUNC('month', CURRENT_DATE)
WHERE feature_code IN ('articles_per_month', 'publish_per_month', 'keyword_distillation');
```

#### 3. 重新计算本月使用量

从 `usage_records` 表重新计算每个用户的实际使用量，更新到 `user_usage` 表。

#### 4. 初始化缺失的配额记录

为所有有订阅但没有 `user_usage` 记录的用户初始化配额。

## 验证结果

修复前：
```
has_quota: false
quota_limit: 1
current_usage: 3
remaining: 0
period_end: Mon Jan 05 2026  ❌
```

修复后：
```
has_quota: true
quota_limit: 100
current_usage: 0
remaining: 100
period_end: Sun Feb 01 2026  ✅
```

## 影响范围

- ✅ 文章生成配额检查
- ✅ 发布配额检查
- ✅ 关键词蒸馏配额检查
- ✅ 所有现有用户的配额记录
- ✅ 新用户订阅后的配额初始化

## 执行步骤

```bash
cd server
npx ts-node src/db/run-migration-022.ts
```

## 后续建议

1. **添加单元测试**：测试 `record_feature_usage` 函数在不同功能代码下的行为
2. **监控配额使用**：添加日志记录配额检查和使用情况
3. **定期检查**：每月初检查配额周期是否正确重置
4. **文档更新**：更新配额系统文档，说明月度配额机制

## 相关文件

- `server/src/db/migrations/022_fix_quota_system.sql` - 修复迁移
- `server/src/db/run-migration-022.ts` - 迁移执行脚本
- `server/src/scripts/diagnose-article-quota.ts` - 诊断脚本
- `server/src/services/UsageTrackingService.ts` - 使用量追踪服务

## 总结

这是一个**系统性问题**，不是个别用户的数据问题。根本原因是功能代码重命名后，数据库函数没有同步更新。通过迁移 022，我们：

1. 修复了数据库函数逻辑
2. 修正了所有用户的历史数据
3. 确保了未来的配额记录正确性

现在所有用户都可以正常使用文章生成和图片上传功能。
