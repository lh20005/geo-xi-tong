# 商品模块诊断步骤

## 问题现象
商品页面显示"获取套餐失败"

## 快速诊断

### 1. 打开浏览器开发者工具
按 F12 或右键 → 检查

### 2. 切换到 Console 标签

### 3. 访问商品管理页面
在应用中导航到商品管理页面

### 4. 查看日志输出

应该看到类似以下的日志：

```
[ProductManagement] 开始获取套餐列表
[API Client] 获取到的 tokens: 存在/不存在
[API Client] 已添加 Authorization header (如果 token 存在)
[API Client] 请求配置: { url: '/admin/products', method: 'get', hasAuth: true/false }
```

## 可能的问题和解决方案

### 问题 1: Token 不存在
**日志显示**: `[API Client] 获取到的 tokens: 不存在`

**原因**: 未登录或 token 已清除

**解决方案**:
1. 重新登录系统
2. 确保登录成功（有成功提示）
3. 再次访问商品管理页面

### 问题 2: 没有 Authorization header
**日志显示**: `hasAuth: false`

**原因**: Token 获取失败或格式不正确

**解决方案**:
1. 在 Console 中执行：
   ```javascript
   window.electron.storage.getTokens().then(console.log)
   ```
2. 检查返回的对象是否包含 `authToken` 和 `refreshToken`
3. 如果没有，重新登录

### 问题 3: 401 未授权
**日志显示**: `status: 401`

**原因**: Token 过期或无效

**解决方案**:
1. 系统会自动尝试刷新 token
2. 如果刷新失败，会提示重新登录
3. 重新登录后再试

### 问题 4: 403 权限不足
**日志显示**: `status: 403`

**原因**: 当前用户不是管理员

**解决方案**:
1. 使用管理员账号登录
2. 当前系统管理员账号：`lzc2005`

### 问题 5: 500 服务器错误
**日志显示**: `status: 500`

**原因**: 后端服务器错误

**解决方案**:
1. 检查后端服务是否运行：
   ```bash
   lsof -i :3000
   ```
2. 查看后端日志
3. 检查数据库连接

## 手动测试 API

在浏览器 Console 中执行：

```javascript
// 1. 检查 token
window.electron.storage.getTokens().then(tokens => {
  console.log('Tokens:', tokens);
  
  // 2. 测试 API
  if (tokens?.authToken) {
    fetch('http://localhost:3000/api/admin/products', {
      headers: {
        'Authorization': `Bearer ${tokens.authToken}`,
        'Content-Type': 'application/json'
      }
    })
    .then(r => r.json())
    .then(data => console.log('API Response:', data))
    .catch(err => console.error('API Error:', err));
  } else {
    console.error('No token found');
  }
});
```

## 预期结果

如果一切正常，应该看到：

```
[ProductManagement] 开始获取套餐列表
[API Client] 获取到的 tokens: 存在
[API Client] 已添加 Authorization header
[API Client] 请求配置: { url: '/admin/products', method: 'get', hasAuth: true }
[ProductManagement] API 响应: { success: true, data: [...] }
[ProductManagement] 成功获取套餐: 3
```

页面应该显示 3 个套餐：
- 体验版 (¥0.00)
- 专业版 (¥99.00)
- 企业版 (¥299.00)

## 数据库验证

确认数据库中有数据：

```bash
psql postgresql://lzc@localhost:5432/geo_system -c "SELECT id, plan_name, price FROM subscription_plans ORDER BY display_order;"
```

应该返回 3 行数据。

## 需要帮助

如果问题仍未解决，请提供：
1. 浏览器 Console 的完整日志
2. Network 标签中 `/api/admin/products` 请求的详情
3. 后端服务器的日志输出

---

**创建时间**: 2025-12-28  
**版本**: 1.0
