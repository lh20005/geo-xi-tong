# 抖音发布问题排查

## 问题现象

登录抖音后，执行发布任务，但没有任何操作。

## 可能的原因

### 1. 页面URL不正确

**检查**：
- 登录后应该在：`https://creator.douyin.com/creator-micro/home`
- 如果在其他页面，适配器找不到"高清发布"按钮

**解决**：
- 已修改 `getPublishUrl()` 返回首页URL
- 重启服务器生效

### 2. 选择器失效

**检查**：
1. 打开 https://creator.douyin.com/creator-micro/home
2. 按 F12 打开开发者工具
3. 在 Console 中运行：
   ```javascript
   document.querySelector('#douyin-creator-master-side-upload')
   ```
4. 如果返回 `null`，说明选择器失效

**解决**：
- 使用开发者工具找到正确的选择器
- 更新代码中的选择器

### 3. 页面加载太慢

**检查**：
- 查看日志是否有"等待超时"错误
- 查看截图 `douyin-home-page.png` 是否显示完整页面

**解决**：
- 增加等待时间（已改为15秒）
- 增加页面加载等待（已加5秒）

### 4. 浏览器窗口问题

**检查**：
- 浏览器是否正常打开
- 窗口是否最大化
- 是否有弹窗遮挡

**解决**：
- 确保浏览器配置正确
- 手动最大化窗口

## 调试步骤

### 步骤1：运行调试脚本

```bash
./test-douyin-publish-debug.sh
```

这会检查：
- 服务器是否运行
- 抖音账号是否存在
- 测试文章是否存在
- 最近的日志

### 步骤2：查看实时日志

```bash
tail -f server/logs/app.log | grep 抖音
```

**预期日志**：
```
[抖音号] 🚀 开始抖音号发布流程（7步）
[抖音号] 文章ID: 123
[抖音号] 当前URL: https://creator.douyin.com/creator-micro/home
[抖音号] ⏳ 等待页面完全加载（5秒）...
[抖音号] ✅ 页面加载完成
[抖音号] 📸 已保存页面截图
[抖音号] 📝 步骤1/7：点击高清发布按钮
[抖音号] ⏳ 等待高清发布按钮出现（15秒）...
```

**如果卡在某一步**：
- 说明那一步有问题
- 查看截图文件
- 检查选择器

### 步骤3：查看截图

```bash
open douyin-home-page.png
```

**检查**：
- 页面是否完整加载
- 是否在正确的URL
- 是否有"高清发布"按钮
- 是否有弹窗或遮挡

### 步骤4：手动测试选择器

1. 打开抖音创作者中心：https://creator.douyin.com/creator-micro/home
2. 按 F12 打开开发者工具
3. 切换到 Console 标签
4. 运行以下命令：

```javascript
// 测试高清发布按钮
const btn = document.querySelector('#douyin-creator-master-side-upload');
console.log('高清发布按钮:', btn);

// 如果找不到，尝试查找所有按钮
const allButtons = document.querySelectorAll('button');
console.log('所有按钮数量:', allButtons.length);
allButtons.forEach((btn, i) => {
  if (btn.textContent.includes('发布') || btn.textContent.includes('高清')) {
    console.log(`按钮 ${i}:`, btn.textContent, btn.id, btn.className);
  }
});
```

### 步骤5：测试悬停效果

```javascript
// 测试悬停
const btn = document.querySelector('#douyin-creator-master-side-upload');
if (btn) {
  btn.dispatchEvent(new MouseEvent('mouseenter', { bubbles: true }));
  console.log('已触发悬停事件');
  
  // 2秒后检查下拉菜单
  setTimeout(() => {
    const menu = document.querySelector('#pixel-emoji-container');
    console.log('下拉菜单:', menu);
  }, 2000);
}
```

## 常见问题

### Q1: 日志显示"等待高清发布按钮出现"后就卡住了

**原因**：选择器找不到按钮

**解决**：
1. 查看截图，确认页面状态
2. 手动测试选择器
3. 更新选择器

### Q2: 日志显示"等待超时"

**原因**：页面加载太慢或选择器错误

**解决**：
1. 增加超时时间
2. 检查网络连接
3. 检查选择器

### Q3: 浏览器打开但没有任何操作

**原因**：可能在错误的页面

**解决**：
1. 检查当前URL
2. 确保在 `creator-micro/home` 页面
3. 手动刷新页面

### Q4: 找到按钮但点击无效

**原因**：按钮可能被遮挡或需要特殊操作

**解决**：
1. 检查是否有弹窗
2. 尝试滚动到按钮位置
3. 使用 JavaScript 直接点击

## 临时解决方案

如果自动发布一直失败，可以：

1. **半自动发布**：
   - 系统自动登录
   - 手动点击"高清发布"
   - 手动填写内容
   - 手动点击发布

2. **使用其他平台**：
   - 先测试头条号（已验证可用）
   - 等抖音问题解决后再用

## 下一步

1. 运行调试脚本
2. 查看实时日志
3. 检查截图
4. 手动测试选择器
5. 反馈结果

---

**创建时间**：2025-12-17
**状态**：等待调试结果
