# 测试存储空间修复

## 快速验证

### 1. 验证 testuser2

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

预期结果：
- ✅ 存储空间充足
- 已使用量与实际文件大小一致
- 可以正常上传文件

### 2. 测试上传功能

#### 测试图库上传

1. 登录为 testuser2
2. 进入"企业图库"
3. 选择一个相册或创建新相册
4. 点击"上传图片"
5. 选择一张小图片（< 1MB）
6. 确认上传成功

#### 测试知识库上传

1. 进入"企业知识库"
2. 选择一个知识库或创建新知识库
3. 点击"上传文档"
4. 选择一个小文档（< 1MB）
5. 确认上传成功

### 3. 验证存储使用量更新

上传文件后，检查存储使用量是否正确更新：

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

预期：
- 总使用量应该增加
- 可用空间应该减少
- 使用率应该上升

## 完整测试流程

### 步骤 1：查看当前状态

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

记录当前的：
- 总使用量
- 图片数量和大小
- 文档数量和大小

### 步骤 2：上传测试文件

通过前端界面上传：
- 1 张图片（约 500KB）
- 1 个文档（约 100KB）

### 步骤 3：验证更新

再次运行诊断：

```bash
cd server
npx ts-node src/scripts/quick-diagnose-testuser2.ts
```

确认：
- 图片数量 +1
- 文档数量 +1
- 总使用量增加约 600KB
- 没有数据不一致警告

### 步骤 4：测试配额限制

尝试上传一个超大文件（> 10MB），应该被拒绝并显示：
- "存储空间不足"错误消息
- 显示当前使用量和可用空间

## 预期行为

### 正常上传

- ✅ 文件成功保存
- ✅ 数据库记录创建
- ✅ 存储使用量更新
- ✅ 存储事务记录创建
- ✅ 前端显示更新

### 配额不足

- ❌ 上传被拒绝
- 显示清晰的错误消息
- 提示当前使用量和可用空间
- 建议购买额外存储

### 文件删除

- ✅ 文件从磁盘删除
- ✅ 数据库记录删除
- ✅ 存储使用量减少
- ✅ 存储事务记录创建（remove 操作）

## 故障排查

### 如果上传仍然失败

1. 检查后端日志：
```bash
# 查看最近的日志
tail -f server/logs/app.log
```

2. 检查数据库连接：
```bash
psql postgresql://lzc@localhost:5432/geo_system -c "SELECT * FROM user_storage_usage WHERE user_id = 438"
```

3. 清除 Redis 缓存：
```bash
redis-cli
> DEL storage:user:438
> exit
```

4. 重新运行修复脚本：
```bash
cd server
npx ts-node src/scripts/fix-testuser2-storage-sync.ts
```

### 如果数据不一致

运行对账脚本：
```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

## 监控建议

### 定期检查

建议每周运行一次对账脚本：

```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

### 日志监控

关注以下日志：
- `[StorageService]` - 存储操作
- `[StorageQuotaService]` - 配额检查
- `存储空间不足` - 配额超限

### 数据库查询

检查存储使用情况：

```sql
-- 查看所有用户的存储使用
SELECT 
  u.username,
  usu.total_storage_bytes,
  usu.storage_quota_bytes,
  usu.purchased_storage_bytes,
  ROUND((usu.total_storage_bytes::NUMERIC / NULLIF(usu.storage_quota_bytes + usu.purchased_storage_bytes, 0)) * 100, 2) as usage_percentage
FROM users u
JOIN user_storage_usage usu ON u.id = usu.user_id
WHERE usu.total_storage_bytes > 0
ORDER BY usage_percentage DESC;

-- 查看接近配额的用户
SELECT 
  u.username,
  usu.total_storage_bytes,
  usu.storage_quota_bytes + usu.purchased_storage_bytes as effective_quota,
  ROUND((usu.total_storage_bytes::NUMERIC / NULLIF(usu.storage_quota_bytes + usu.purchased_storage_bytes, 0)) * 100, 2) as usage_percentage
FROM users u
JOIN user_storage_usage usu ON u.id = usu.user_id
WHERE (usu.total_storage_bytes::NUMERIC / NULLIF(usu.storage_quota_bytes + usu.purchased_storage_bytes, 0)) > 0.8
ORDER BY usage_percentage DESC;
```

## 成功标准

修复成功的标志：
- ✅ testuser2 可以正常上传文件
- ✅ 存储使用量实时更新
- ✅ 配额检查正确工作
- ✅ 没有数据不一致警告
- ✅ 所有用户的存储数据都已同步
