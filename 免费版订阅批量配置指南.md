# 免费版订阅批量配置指南

## 概述

为现有没有订阅的用户统一配置免费版套餐并配置配额。

## 执行步骤

### 方式一：使用一键脚本（推荐）

```bash
./配置免费版订阅.sh
```

这个脚本会自动：
1. 检查免费版套餐配置是否正确
2. 为所有无订阅用户批量配置免费版
3. 显示处理结果统计

### 方式二：手动执行

#### 1. 检查免费版套餐配置

```bash
cd server
npx ts-node src/scripts/check-free-plan-quotas.ts
```

确认输出显示免费版套餐的配额配置正确。

#### 2. 执行批量配置

```bash
npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

## 处理逻辑

脚本会自动：

### 1. 识别目标用户
- 查找所有没有活跃订阅的用户
- 排除已有订阅的用户

### 2. 为每个用户配置

#### 创建订阅记录
- 套餐：免费版
- 状态：active（活跃）
- 有效期：1年
- 标记为赠送：是
- 赠送原因：系统批量赠送免费版

#### 初始化功能配额
根据免费版套餐配置，初始化以下配额：

| 功能 | 配额 | 重置周期 |
|------|------|----------|
| 关键词蒸馏 | 10次 | 每月 |
| 文章生成 | 30篇 | 每月 |
| 文章发布 | 30次 | 每月 |
| 平台账号数 | 3个 | 永久 |
| 企业图库 | 10MB | 永久 |
| 企业知识库 | 10MB | 永久 |
| 存储空间 | 10MB | 永久 |

#### 初始化存储空间
- 创建存储使用记录
- 设置存储配额（从套餐配置读取）
- 初始使用量为0

### 3. 清理旧数据
- 清除用户的旧配额记录
- 确保配额从零开始计算

## 输出示例

```
========================================
为现有无订阅用户重置免费版配额
========================================

[FreeSubscription] 开始为现有无订阅用户重置免费版配额...
[FreeSubscription] 找到免费版套餐: 体验版 (ID: 1)
[FreeSubscription] 找到 5 个无订阅用户

[FreeSubscription] 处理用户: testuser1 (ID: 2)
[FreeSubscription] 初始化用户 2 的配额...
[FreeSubscription] ✅ 成功初始化 7 项配额记录
[FreeSubscription] 初始化用户 2 的存储空间...
[FreeSubscription] 从数据库读取存储配额: 10 MB (10485760 bytes)
[FreeSubscription] ✅ 创建存储记录，配额 10485760 bytes (10 MB)
[FreeSubscription] ✅ 用户 testuser1 处理成功 (订阅ID: 123)

...

[FreeSubscription] ✅ 批量处理完成: 总计 5, 成功 5, 失败 0

========================================
批量重置完成
========================================
总用户数: 5
成功: 5
失败: 0
========================================

✅ 所有用户处理成功
```

## 验证配置结果

### 1. 检查订阅状态

```bash
cd server
npx ts-node src/scripts/test-free-subscription.ts
```

### 2. 登录系统验证

1. 使用任一用户账号登录
2. 进入个人中心
3. 查看订阅信息：
   - 应显示"体验版"套餐
   - 状态为"活跃"
   - 有效期为1年
4. 查看配额使用情况：
   - 所有配额应显示正确的限额
   - 已使用量为0

### 3. 测试功能使用

测试用户是否可以正常使用：
- 关键词蒸馏
- 文章生成
- 文章发布
- 图片上传
- 文档上传

## 注意事项

### 安全性
- ✅ 只处理没有活跃订阅的用户
- ✅ 不会影响已有订阅的用户
- ✅ 使用事务确保数据一致性
- ✅ 失败自动回滚

### 幂等性
- ✅ 可以重复执行
- ✅ 已有订阅的用户会被跳过
- ✅ 不会创建重复记录

### 数据完整性
- ✅ 清除旧配额记录
- ✅ 初始化所有必需的配额
- ✅ 创建存储空间记录
- ✅ 配额从零开始计算

## 常见问题

### Q: 如果用户之前有过期的订阅怎么办？
A: 脚本只查找没有"活跃"订阅的用户，过期订阅不影响。会为这些用户创建新的免费版订阅。

### Q: 免费版的有效期是多久？
A: 默认1年。可以在代码中修改 `endDate.setFullYear(endDate.getFullYear() + 1)` 来调整。

### Q: 如果某个用户处理失败怎么办？
A: 脚本会继续处理其他用户，最后显示成功和失败的统计。可以查看日志了解失败原因，然后单独处理。

### Q: 配额是从哪里读取的？
A: 从数据库的 `plan_features` 表读取，确保与套餐配置保持一致。

### Q: 可以修改免费版的配额吗？
A: 可以。修改 `plan_features` 表中免费版套餐的配置，然后重新运行脚本即可。

## 相关文档

- [免费版订阅功能实现总结](./免费版订阅功能实现总结.md)
- [免费版配额动态查询说明](./免费版配额动态查询说明.md)
- [快速开始-免费版订阅](./快速开始-免费版订阅.md)

## 技术实现

### 核心服务
- `FreeSubscriptionService`: 免费版订阅服务
- `SubscriptionService`: 订阅管理服务
- `StorageQuotaService`: 存储配额服务

### 数据库表
- `subscription_plans`: 套餐定义
- `plan_features`: 套餐功能配额
- `user_subscriptions`: 用户订阅记录
- `user_usage`: 用户配额使用记录
- `user_storage_usage`: 用户存储使用记录

### 关键函数
- `resetExistingUsersToFree()`: 批量重置用户为免费版
- `initializeFreeQuotas()`: 初始化功能配额
- `initializeStorage()`: 初始化存储空间

## 执行时机

建议在以下情况执行：

1. **系统初始化**：首次部署后，为所有用户配置免费版
2. **定期维护**：定期检查并为新注册但未订阅的用户配置
3. **数据修复**：发现有用户没有订阅时，批量修复
4. **套餐调整**：修改免费版配额后，重新初始化用户配额

## 监控建议

执行后建议监控：
- 用户登录是否正常
- 配额查询是否正确
- 功能使用是否受限
- 存储空间是否可用
