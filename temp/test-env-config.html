<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯å¢ƒé…ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 0; }
        .info { margin: 10px 0; }
        .label { font-weight: bold; color: #555; }
        .value { color: #007bff; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç¯å¢ƒé…ç½®æµ‹è¯•</h1>
    
    <div class="card">
        <h2>å½“å‰ç¯å¢ƒä¿¡æ¯</h2>
        <div class="info">
            <span class="label">ä¸»æœºå:</span>
            <span class="value" id="hostname"></span>
        </div>
        <div class="info">
            <span class="label">åè®®:</span>
            <span class="value" id="protocol"></span>
        </div>
        <div class="info">
            <span class="label">ç«¯å£:</span>
            <span class="value" id="port"></span>
        </div>
        <div class="info">
            <span class="label">å®Œæ•´URL:</span>
            <span class="value" id="fullUrl"></span>
        </div>
    </div>

    <div class="card">
        <h2>ç¯å¢ƒæ£€æµ‹ç»“æœ</h2>
        <div class="info">
            <span class="label">æ˜¯å¦ ngrok:</span>
            <span class="value" id="isNgrok"></span>
        </div>
        <div class="info">
            <span class="label">æ˜¯å¦æœ¬åœ°å¼€å‘:</span>
            <span class="value" id="isLocalDev"></span>
        </div>
        <div class="info">
            <span class="label">API URL:</span>
            <span class="value" id="apiUrl"></span>
        </div>
    </div>

    <div class="card">
        <h2>API è¿æ¥æµ‹è¯•</h2>
        <button onclick="testApiConnection()">æµ‹è¯• API è¿æ¥</button>
        <button onclick="testCreateOrder()">æµ‹è¯•åˆ›å»ºè®¢å•</button>
        <div id="result"></div>
    </div>

    <script>
        // ç¯å¢ƒæ£€æµ‹
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const port = window.location.port;
        const isNgrok = hostname.includes('ngrok');
        const isLocalDev = hostname === 'localhost' || hostname === '127.0.0.1';
        
        // è®¡ç®— API URL
        let apiUrl;
        if (isNgrok) {
            apiUrl = `${protocol}//${hostname}/api`;
        } else if (isLocalDev) {
            apiUrl = 'http://localhost:3000/api';
        } else {
            apiUrl = `${protocol}//${hostname}/api`;
        }

        // æ˜¾ç¤ºä¿¡æ¯
        document.getElementById('hostname').textContent = hostname;
        document.getElementById('protocol').textContent = protocol;
        document.getElementById('port').textContent = port || 'é»˜è®¤';
        document.getElementById('fullUrl').textContent = window.location.href;
        document.getElementById('isNgrok').textContent = isNgrok ? 'âœ… æ˜¯' : 'âŒ å¦';
        document.getElementById('isLocalDev').textContent = isLocalDev ? 'âœ… æ˜¯' : 'âŒ å¦';
        document.getElementById('apiUrl').textContent = apiUrl;

        // æµ‹è¯• API è¿æ¥
        async function testApiConnection() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>â³ æ­£åœ¨æµ‹è¯•è¿æ¥...</p>';

            try {
                const response = await fetch(`${apiUrl}/health`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <p class="success">âœ… API è¿æ¥æˆåŠŸï¼</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">âŒ API è¿æ¥å¤±è´¥</p>
                    <pre>${error.message}</pre>
                    <p>å°è¯•çš„ URL: ${apiUrl}/health</p>
                `;
            }
        }

        // æµ‹è¯•åˆ›å»ºè®¢å•
        async function testCreateOrder() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>â³ æ­£åœ¨æµ‹è¯•åˆ›å»ºè®¢å•...</p>';

            // å…ˆç™»å½•
            try {
                const loginResponse = await fetch(`${apiUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'lzc2005',
                        password: 'Woshixiaogou2005'
                    })
                });

                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    throw new Error('ç™»å½•å¤±è´¥');
                }

                const token = loginData.data.token;

                // åˆ›å»ºè®¢å•
                const orderResponse = await fetch(`${apiUrl}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plan_id: 2,
                        order_type: 'purchase'
                    })
                });

                const orderData = await orderResponse.json();

                if (orderData.success) {
                    resultDiv.innerHTML = `
                        <p class="success">âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼</p>
                        <pre>${JSON.stringify(orderData, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="error">âŒ è®¢å•åˆ›å»ºå¤±è´¥</p>
                        <pre>${JSON.stringify(orderData, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">âŒ æµ‹è¯•å¤±è´¥</p>
                    <pre>${error.message}</pre>
                    <p>API URL: ${apiUrl}</p>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            console.log('ç¯å¢ƒé…ç½®:', {
                hostname,
                protocol,
                port,
                isNgrok,
                isLocalDev,
                apiUrl
            });
        };
    </script>
</body>
</html>
