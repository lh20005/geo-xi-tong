# 测试每月配额功能

## 快速测试步骤

### 1. 重启后端服务

修改完成后，需要重启后端服务以加载新的配置：

```bash
# 停止当前运行的后端服务（如果有）
# 然后重新启动
npm run server:dev
```

或者完整启动：
```bash
npm run dev
```

### 2. 验证数据库迁移

```bash
cd server
psql postgresql://lzc@localhost:5432/geo_system << 'EOF'
-- 查看所有套餐的每月配额
SELECT 
  sp.plan_name, 
  pf.feature_name, 
  pf.feature_value, 
  pf.feature_unit 
FROM plan_features pf 
JOIN subscription_plans sp ON sp.id = pf.plan_id 
WHERE pf.feature_code IN ('articles_per_month', 'publish_per_month') 
ORDER BY sp.display_order, pf.feature_code;
EOF
```

**预期结果**：
```
 plan_name |  feature_name  | feature_value | feature_unit 
-----------+----------------+---------------+--------------
 免费      | 每月生成文章数 |            30 | 篇
 免费      | 每月发布文章数 |            30 | 篇
 专业版    | 每月生成文章数 |          3000 | 篇
 专业版    | 每月发布文章数 |          6000 | 篇
 企业版    | 每月生成文章数 |            -1 | 篇
 企业版    | 每月发布文章数 |            -1 | 篇
```

### 3. 测试商品管理页面

1. **登录管理员账号**
   - 访问 `http://localhost:5173`
   - 使用管理员账号登录

2. **进入商品管理页面**
   - 点击左侧菜单"商品管理"

3. **编辑套餐**
   - 点击任意套餐的"编辑"按钮
   - 查看"功能配额"区域

4. **验证功能选项**
   - ✅ 下拉选项应该显示"每月生成文章数"
   - ✅ 下拉选项应该显示"每月发布文章数"
   - ✅ 不应该有"每日"相关选项

5. **添加新功能配额**
   - 点击"添加功能配额"
   - 选择"每月生成文章数"
   - 输入配额值（如：100）
   - 验证单位显示为"篇"

### 4. 测试新增套餐

1. **点击"新增套餐"按钮**

2. **填写套餐信息**
   ```
   套餐代码：test_monthly
   套餐名称：测试每月套餐
   价格：99.00
   计费周期：月付
   有效天数：30
   描述：测试每月配额功能
   显示顺序：10
   启用状态：✓ 开启
   ```

3. **添加功能配额**
   - 点击"添加功能配额"
   - 选择"每月生成文章数"，输入：100
   - 再添加"每月发布文章数"，输入：200

4. **保存并验证**
   - 点击"保存"
   - 应该显示"套餐新增成功"
   - 套餐列表中应该显示新套餐
   - 功能配额应该显示"每月生成文章数 100"和"每月发布文章数 200"

### 5. 测试用户中心

1. **登录普通用户账号**
   - 如果没有，可以注册一个新账号

2. **查看用户中心**
   - 点击右上角用户头像
   - 选择"个人中心"或直接访问用户中心页面

3. **查看套餐信息**
   - 找到"我的套餐"或"功能配额"区域
   - 验证：
     - ✅ 显示"每月生成文章数"
     - ✅ 显示"每月发布文章数"
     - ✅ 显示正确的配额值和已使用量

### 6. 测试落地页

1. **访问落地页**
   ```
   http://localhost:8080
   ```

2. **滚动到定价区域**
   - 滚动到"灵活的使用方案"区域
   - 或直接访问 `http://localhost:8080#pricing`

3. **查看套餐卡片**
   - 验证每个套餐的功能列表
   - ✅ 应该显示"每月生成文章数 XX"
   - ✅ 应该显示"每月发布文章数 XX"
   - ✅ 不应该有"每日"字样

### 7. 测试定时任务

1. **查看后端日志**
   ```bash
   # 查看后端启动日志
   tail -f server/logs/app.log
   ```

2. **验证定时任务**
   - 应该看到类似输出：
   ```
   ✅ 每月配额重置任务已安排（每月1号00:00执行）
   ```

3. **手动触发测试（可选）**
   ```bash
   # 连接数据库手动测试重置逻辑
   psql postgresql://lzc@localhost:5432/geo_system << 'EOF'
   -- 查看当前使用记录
   SELECT * FROM user_usage 
   WHERE feature_code IN ('articles_per_month', 'publish_per_month')
   LIMIT 5;
   EOF
   ```

### 8. 测试配额使用

1. **生成文章**
   - 在系统中生成一篇文章
   - 查看配额是否正确扣减

2. **发布文章**
   - 发布一篇文章到平台
   - 查看配额是否正确扣减

3. **查看使用统计**
   - 在用户中心查看配额使用情况
   - 验证：
     - ✅ 已使用量正确增加
     - ✅ 剩余配额正确减少
     - ✅ 显示"每月重置"提示

## 数据库验证命令

### 查看所有功能配额
```sql
SELECT 
  sp.plan_name,
  pf.feature_code,
  pf.feature_name,
  pf.feature_value,
  pf.feature_unit
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
ORDER BY sp.display_order, pf.feature_code;
```

### 查看用户使用记录
```sql
SELECT 
  u.username,
  uu.feature_code,
  uu.used_count,
  uu.period_start,
  uu.period_end
FROM user_usage uu
JOIN users u ON u.id = uu.user_id
WHERE uu.feature_code IN ('articles_per_month', 'publish_per_month')
ORDER BY uu.created_at DESC
LIMIT 10;
```

### 查看配额预警
```sql
SELECT 
  u.username,
  qa.feature_code,
  qa.current_usage,
  qa.quota_limit,
  qa.alert_level,
  qa.is_sent
FROM quota_alerts qa
JOIN users u ON u.id = qa.user_id
WHERE qa.feature_code IN ('articles_per_month', 'publish_per_month')
ORDER BY qa.created_at DESC
LIMIT 10;
```

## 常见问题

### Q1: 商品管理页面还显示"每日"？
**A**: 
1. 清除浏览器缓存（Ctrl+Shift+R）
2. 重启前端开发服务器
3. 确认后端已重启

### Q2: 数据库中还有旧的配额代码？
**A**: 
1. 确认迁移已执行：
   ```bash
   cd server
   npx ts-node src/db/run-migration-016.ts
   ```
2. 查看迁移记录：
   ```sql
   SELECT * FROM schema_migrations WHERE version = '016';
   ```

### Q3: 配额值不正确？
**A**: 
1. 检查数据库中的配额值
2. 如果是负数或异常值，手动修复：
   ```sql
   -- 修复无限制配额
   UPDATE plan_features 
   SET feature_value = -1 
   WHERE feature_value < 0 
   AND feature_code IN ('articles_per_month', 'publish_per_month');
   ```

### Q4: 定时任务没有启动？
**A**: 
1. 检查后端日志
2. 确认 SchedulerService 已正确初始化
3. 重启后端服务

## 验收标准

- ✅ 数据库迁移成功执行
- ✅ 所有功能代码都是 `articles_per_month` 和 `publish_per_month`
- ✅ 商品管理页面显示"每月"选项
- ✅ 用户中心显示"每月"配额
- ✅ 落地页显示"每月"配额
- ✅ 定时任务已安排（每月1号00:00）
- ✅ 配额值合理（免费版30，专业版3000/6000）
- ✅ 无TypeScript错误
- ✅ 无控制台错误

## 回滚方案（如需要）

如果需要回滚到每日配额：

```sql
-- 回滚功能代码
UPDATE plan_features 
SET 
  feature_code = 'articles_per_day',
  feature_name = '每日生成文章数',
  feature_value = CASE 
    WHEN feature_value = -1 THEN -1 
    ELSE feature_value / 30 
  END
WHERE feature_code = 'articles_per_month';

UPDATE plan_features 
SET 
  feature_code = 'publish_per_day',
  feature_name = '每日发布文章数',
  feature_value = CASE 
    WHEN feature_value = -1 THEN -1 
    ELSE feature_value / 30 
  END
WHERE feature_code = 'publish_per_month';
```

然后还原代码修改并重启服务。

## 总结

测试通过后，系统将完全使用每月配额制度。用户可以在整个月内自由分配使用配额，无需担心每天的限制。这将大大提升用户体验和系统的灵活性。
