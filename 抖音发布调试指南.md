# 抖音发布调试指南

## 问题：浏览器过早关闭

### 可能原因
1. 某个步骤找不到元素，抛出异常
2. 等待时间不够，元素还没加载完
3. 发布按钮选择器不正确

## 已优化内容

### 1. 增加截图功能
在关键步骤自动截图，方便调试：
- `douyin-home-page.png` - 首页加载完成
- `douyin-menu-popup.png` - 菜单弹出后
- `douyin-before-publish.png` - 点击发布前
- `douyin-after-publish.png` - 点击发布后
- `douyin-error.png` - 发生错误时（全页截图）

### 2. 发布按钮使用文字匹配
```typescript
// 方案1：XPath文字匹配
const publishXPath = "//button[contains(text(), '发布')]";
await page.waitForXPath(publishXPath);

// 方案2：CSS选择器（备用）
const publishButton = '#DCPF > div > ... > button.button-dhlUZE';
await page.waitForSelector(publishButton);
```

### 3. 增加等待时间
- 发布按钮等待：从10秒增加到15秒
- 发布完成等待：从5秒增加到10秒
- 错误时等待：10秒后才关闭浏览器

### 4. 详细的按钮检查
```typescript
// 检查按钮是否可见
const isVisible = await page.evaluate(el => {
  const style = window.getComputedStyle(el);
  const rect = el.getBoundingClientRect();
  return style.display !== 'none' && 
         style.visibility !== 'hidden' && 
         style.opacity !== '0' &&
         rect.width > 0 && 
         rect.height > 0;
}, button);
```

## 调试步骤

### 步骤1：查看日志
```bash
# 查看完整日志
tail -f server/logs/app.log | grep "抖音号"
```

关键日志：
```
[抖音号] 🚀 开始抖音号发布流程（7步）
[抖音号] 📝 步骤1/7：悬停在高清发布按钮上5秒，点击发布图文
[抖音号] 📷 步骤2/7：点击上传图文按钮，上传图片
[抖音号] 📝 步骤3/7：填写标题
[抖音号] 📄 步骤4/7：填写描述（正文）
[抖音号] 🏷️  步骤5/7：添加话题
[抖音号] 📋 步骤6/7：添加自主声明（内容由AI生成）
[抖音号] 🚀 步骤7/7：点击发布按钮
✅ 抖音号文章发布成功！
```

### 步骤2：查看截图
检查以下截图文件：
```bash
ls -lh douyin-*.png
```

重点查看：
1. `douyin-menu-popup.png` - 菜单是否正确弹出？
2. `douyin-before-publish.png` - 内容是否填写完整？
3. `douyin-error.png` - 如果失败，错误发生在哪里？

### 步骤3：分析失败原因

#### 情况A：步骤1失败（找不到"发布图文"）
**日志特征**：
```
[抖音号] ✅ 悬停5秒完成，二级菜单应该已完全显示
[抖音号] ⚠️ XPath查找失败，尝试遍历所有元素...
❌ 找不到可点击的"发布图文"按钮
```

**解决方案**：
1. 查看 `douyin-menu-popup.png`
2. 确认菜单是否弹出
3. 确认菜单中是否有"发布图文"选项
4. 如果文字不是"发布图文"，需要更新匹配文字

#### 情况B：步骤2-6失败（找不到输入框）
**日志特征**：
```
[抖音号] ⏳ 等待标题输入框出现（10秒）...
❌ Waiting for selector ... failed
```

**解决方案**：
1. 页面可能没有正确跳转
2. 选择器可能已过期
3. 需要更新选择器

#### 情况C：步骤7失败（找不到发布按钮）
**日志特征**：
```
[抖音号] 🚀 步骤7/7：点击发布按钮
[抖音号] ⚠️ XPath查找失败，尝试CSS选择器...
[抖音号] ❌ CSS选择器也失败了
```

**解决方案**：
1. 查看 `douyin-before-publish.png`
2. 确认是否有发布按钮
3. 确认按钮文字是什么
4. 更新XPath或选择器

#### 情况D：浏览器过早关闭
**日志特征**：
```
[抖音号] ✅ 已点击发布按钮
[抖音号] ⏳ 等待发布完成（10秒）...
✅ 抖音号文章发布成功！
```
但实际没有发布成功。

**解决方案**：
1. 增加等待时间（目前是10秒）
2. 添加发布成功的验证逻辑
3. 检查是否有确认对话框

## 常见问题

### Q1: 日志显示成功，但实际没发布？
**A**: 可能的原因：
1. 点击发布按钮后，有确认对话框需要再次确认
2. 等待时间不够，发布还在进行中
3. 发布失败但没有检测到

**解决方案**：
- 增加等待时间到20秒
- 添加发布成功的验证
- 检查是否有错误提示

### Q2: 找不到"发布图文"按钮？
**A**: 可能的原因：
1. 菜单没有完全弹出
2. 文字不是"发布图文"
3. 元素被遮挡

**解决方案**：
- 增加悬停时间到10秒
- 查看截图确认实际文字
- 尝试点击其他位置

### Q3: 浏览器立即关闭，看不到过程？
**A**: 修改代码，增加调试模式：
```typescript
// 在 BrowserAutomationService.ts 中
const browser = await puppeteer.launch({
  headless: false,  // 改为 false，显示浏览器
  devtools: true,   // 打开开发者工具
  slowMo: 100       // 减慢操作速度
});
```

## 性能优化建议

### 1. 减少不必要的等待
某些步骤可以并行或减少等待时间：
```typescript
// 不好：固定等待
await new Promise(resolve => setTimeout(resolve, 5000));

// 好：等待特定元素
await page.waitForSelector(selector, { timeout: 5000 });
```

### 2. 使用更可靠的选择器
优先级：
1. ID选择器（最快）
2. 文字匹配（最可靠）
3. CSS选择器（可能过期）
4. XPath（灵活但慢）

### 3. 添加重试机制
```typescript
async function clickWithRetry(page, selector, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      await page.click(selector);
      return true;
    } catch (e) {
      if (i === maxRetries - 1) throw e;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
}
```

## 下一步行动

1. **运行测试**，查看日志和截图
2. **定位失败步骤**，根据日志确定哪一步失败
3. **查看截图**，确认页面实际状态
4. **调整代码**，根据实际情况更新选择器或逻辑
5. **重新测试**，验证修复效果

## 更新日期
2024-12-17

## 相关文件
- `server/src/services/adapters/DouyinAdapter.ts` - 抖音适配器
- `抖音自动发布全流程说明.md` - 发布流程说明
- `抖音登录问题修复说明.md` - 登录问题说明
