# 测试免费版订阅功能

## 快速测试

### 1. 测试新用户注册自动开通

```bash
# 方法 1: 通过 API 注册新用户
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser_'$(date +%s)'",
    "password": "Test123456!"
  }'

# 注册成功后，检查用户订阅
# 使用返回的 token 查询订阅信息
```

### 2. 测试批量重置现有用户

```bash
cd server
npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

### 3. 运行完整测试套件

```bash
cd server
npx ts-node src/scripts/test-free-subscription.ts
```

## 验证结果

### 检查用户订阅

```sql
-- 查看用户订阅
SELECT 
  u.id,
  u.username,
  us.status,
  sp.plan_name,
  us.start_date,
  us.end_date,
  us.is_gift
FROM users u
LEFT JOIN user_subscriptions us ON us.user_id = u.id AND us.status = 'active'
LEFT JOIN subscription_plans sp ON sp.id = us.plan_id
WHERE u.username = 'your_test_username';
```

### 检查用户配额

```sql
-- 查看用户配额
SELECT 
  uu.feature_code,
  pf.feature_name,
  uu.usage_count,
  pf.feature_value as quota_limit,
  uu.period_start,
  uu.period_end
FROM user_usage uu
JOIN user_subscriptions us ON us.user_id = uu.user_id AND us.status = 'active'
JOIN plan_features pf ON pf.plan_id = us.plan_id AND pf.feature_code = uu.feature_code
WHERE uu.user_id = (SELECT id FROM users WHERE username = 'your_test_username');
```

### 检查存储空间

```sql
-- 查看存储空间
SELECT 
  user_id,
  image_storage_bytes,
  document_storage_bytes,
  article_storage_bytes,
  total_storage_bytes,
  storage_quota_bytes,
  purchased_storage_bytes
FROM user_storage_usage
WHERE user_id = (SELECT id FROM users WHERE username = 'your_test_username');
```

## 预期结果

### 新用户注册后应该有：

1. ✅ 一个活跃的免费版订阅
2. ✅ 有效期 1 年
3. ✅ 5 项配额记录（文章生成、发布、平台账号、关键词蒸馏、存储空间）
4. ✅ 存储空间配额（根据免费版套餐配置）
5. ✅ `is_gift = true`，`gift_reason = '新用户注册赠送'`

### 批量重置后应该有：

1. ✅ 所有无订阅用户都获得免费版订阅
2. ✅ 旧的配额记录被清除
3. ✅ 新的配额记录被初始化
4. ✅ 存储空间配额被更新

## 常见问题排查

### 问题 1: 注册成功但没有订阅

**检查日志**：
```bash
# 查看服务器日志，搜索 FreeSubscription
tail -f server/logs/app.log | grep FreeSubscription
```

**可能原因**：
- 免费版套餐不存在或未激活
- 数据库连接问题
- 权限问题

**解决方法**：
```sql
-- 确认免费版套餐存在
SELECT * FROM subscription_plans WHERE plan_code = 'free';

-- 如果不存在，插入免费版套餐
INSERT INTO subscription_plans (plan_code, plan_name, price, billing_cycle, is_active, display_order, description)
VALUES ('free', '免费版', 0.00, 'monthly', true, 1, '适合个人用户体验基础功能')
ON CONFLICT (plan_code) DO NOTHING;
```

### 问题 2: 配额未初始化

**检查配额配置**：
```sql
-- 查看免费版的功能配置
SELECT pf.* 
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
WHERE sp.plan_code = 'free';
```

**如果配额为空，需要初始化**：
参考 `server/src/db/migrations/archive/001_create_subscription_tables.sql`

### 问题 3: 存储空间配额异常

**检查存储配额配置**：
```sql
-- 查看免费版的存储空间配置
SELECT pf.* 
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
WHERE sp.plan_code = 'free' AND pf.feature_code = 'storage_space';
```

## 测试通过标准

✅ 新用户注册后自动获得免费版订阅  
✅ 订阅有效期为 1 年  
✅ 所有配额正确初始化  
✅ 存储空间正确初始化  
✅ 防止重复订阅  
✅ 批量重置功能正常  
✅ 失败不影响注册流程  
✅ 详细的日志记录  

## 性能测试

### 批量重置性能

```bash
# 测试批量重置 100 个用户的时间
time npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

预期：每个用户处理时间 < 100ms

### 注册性能

```bash
# 测试注册 10 个用户的时间
for i in {1..10}; do
  time curl -X POST http://localhost:3000/api/auth/register \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"perf_test_$i\",\"password\":\"Test123456!\"}"
done
```

预期：每次注册时间 < 500ms

## 监控指标

### 关键指标

1. **订阅开通成功率**：应该 > 99%
2. **配额初始化成功率**：应该 = 100%
3. **平均处理时间**：< 200ms
4. **失败重试次数**：< 1%

### 监控查询

```sql
-- 统计今天新注册用户的订阅情况
SELECT 
  COUNT(*) as total_users,
  COUNT(us.id) as users_with_subscription,
  ROUND(COUNT(us.id)::NUMERIC / COUNT(*)::NUMERIC * 100, 2) as subscription_rate
FROM users u
LEFT JOIN user_subscriptions us ON us.user_id = u.id AND us.status = 'active'
WHERE u.created_at >= CURRENT_DATE;
```

## 回滚方案

如果需要回滚功能：

1. **移除注册时的自动开通**：
   注释掉 `AuthService.ts` 中的自动开通代码

2. **删除测试数据**：
```sql
-- 删除测试用户的订阅
DELETE FROM user_subscriptions 
WHERE is_gift = true 
  AND gift_reason IN ('新用户注册赠送', '系统批量赠送免费版');
```

3. **恢复数据库**：
```bash
# 如果有备份
psql -U postgres -d geo_system < backup.sql
```
