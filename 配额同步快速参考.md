# 配额同步快速参考

## QuotaSyncService 作用范围

### ✅ 对所有配额项目都有效

| 配额项目 | 代码 | 同步 |
|---------|------|------|
| 文章生成 | `articles_per_month` | ✅ |
| 文章发布 | `publish_per_month` | ✅ |
| 平台账号 | `platform_accounts` | ✅ |
| 关键词蒸馏 | `keyword_distillation` | ✅ |
| 企业图库 | `gallery_albums` | ✅ |
| 知识库 | `knowledge_bases` | ✅ |
| 存储空间 | `storage_space` | ✅ + 表同步 |

## 四大同步功能

### 1. 清除 Redis 缓存
- **影响**: 所有配额 ✅
- **作用**: 删除所有配额相关缓存

### 2. 同步存储配额
- **影响**: 仅存储空间 ⚠️
- **作用**: 同步到 `user_storage_usage` 表

### 3. 推送 WebSocket 通知
- **影响**: 所有配额 ✅
- **作用**: 实时通知前端

### 4. 刷新配额概览
- **影响**: 所有配额 ✅
- **作用**: 预热所有配额检查

## 使用方法

```typescript
import { QuotaSyncService } from './QuotaSyncService';

// 调整任意配额后调用
await QuotaSyncService.syncUserQuota(userId, '配额调整原因');
```

## 核心修复

### check_user_quota 函数

**修复前** ❌: 只读取 `plan_features`

**修复后** ✅: 优先读取 `custom_quotas`

**影响**: 所有配额项目

## 为什么存储配额特殊？

**其他配额**:
- 只需更新 `custom_quotas`
- `check_user_quota` 自动读取

**存储配额**:
- 需要同步到 `user_storage_usage` 表
- 因为使用独立的 `StorageQuotaService`

## 快速测试

```bash
# 测试配额同步
npx ts-node src/scripts/test-complete-quota-sync.ts

# 验证修复
npx ts-node src/scripts/test-quota-check-after-adjustment.ts
```

## 关键点

1. ✅ QuotaSyncService 对**所有配额**都有效
2. ✅ 核心修复是 `check_user_quota` 函数
3. ⚠️ 存储配额需要额外的表同步
4. ✅ 调整任意配额后，所有配额都会刷新
