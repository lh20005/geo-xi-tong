# 账号不存在问题诊断

## 问题描述
在账号管理列表点击"测试登录"时，显示"账号不存在"。

## 问题原因分析

### 数据流程
1. **登录成功** → 保存到本地缓存 → 同步到后端
2. **获取账号列表** → 从后端获取 → 更新本地缓存
3. **测试登录** → 从本地缓存获取账号信息

### 可能的原因

#### 1. 后端同步失败 ⭐ 最可能
登录成功后，账号保存到本地缓存，但同步到后端失败。当前端获取账号列表时，从后端获取不到新账号。

**检查方法**：
```bash
# 查看日志
tail -f ~/Library/Logs/windows-login-manager/main.log | grep "同步"
```

**关键日志**：
- `[平台名] 账号已同步到后端` - 同步成功
- `[平台名] 账号同步失败，已加入队列` - 同步失败

#### 2. 后端 API 错误
后端的 `/api/publishing/accounts` 接口可能有问题。

**检查方法**：
```bash
# 查看后端日志
cd server
npm run dev
# 观察是否有错误
```

#### 3. 认证问题
Windows 登录管理器可能没有正确的认证 token。

**检查方法**：
```bash
# 查看日志中的认证信息
tail -f ~/Library/Logs/windows-login-manager/main.log | grep "auth\|token"
```

## 诊断步骤

### 步骤1：检查后端是否运行
```bash
cd server
npm run dev
```

确保后端服务正常运行在 `http://localhost:3000`。

### 步骤2：检查登录日志
```bash
# 实时查看日志
tail -f ~/Library/Logs/windows-login-manager/main.log
```

登录一个账号，观察日志输出：

**成功的日志应该包含**：
```
[平台名] 开始登录流程
[平台名] WebView 创建成功
[平台名] 登录成功检测到
[平台名] 用户名提取成功: xxx
[平台名] 账号已保存到本地
[平台名] 账号已同步到后端  ← 关键！
[平台名] 登录成功完成
```

**如果看到**：
```
[平台名] 账号同步失败，已加入队列
```
说明后端同步失败了。

### 步骤3：手动测试后端 API
```bash
# 测试创建账号 API
curl -X POST http://localhost:3000/api/publishing/accounts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "platform_id": "test",
    "account_name": "测试账号",
    "real_username": "测试用户",
    "credentials": {
      "cookies": [],
      "storage": {}
    }
  }'
```

### 步骤4：检查数据库
```bash
cd server
npm run db:studio
```

查看 `platform_accounts` 表，看是否有新创建的账号。

## 解决方案

### 方案1：确保后端运行（推荐）
```bash
# 终端1：启动后端
cd server
npm run dev

# 终端2：启动 Windows 登录管理器
cd windows-login-manager
npm run dev
```

### 方案2：检查认证状态
在 Windows 登录管理器中：
1. 先登录系统（使用系统账号）
2. 确保有有效的 token
3. 然后再登录平台账号

### 方案3：查看同步队列
如果同步失败，账号会被加入队列。可以手动触发同步：

在应用中：
1. 打开"设置"
2. 找到"同步"选项
3. 点击"立即同步"

### 方案4：直接查看本地缓存
```bash
# macOS
cat ~/Library/Application\ Support/windows-login-manager/config.json | jq '.accounts_cache'
```

## 临时解决方案

如果需要立即测试登录功能，可以修改代码使用本地缓存：

### 修改 handler.ts
```typescript
// 测试账号登录
ipcMain.handle('test-account-login', async (event, accountId: number) => {
  try {
    log.info(`IPC: test-account-login - ${accountId}`);

    const mainWindow = appManager.getMainWindow();
    if (!mainWindow) {
      throw new Error('Main window not available');
    }

    // 从本地缓存获取账号（临时方案）
    const accounts = await storageManager.getAccountsCache();
    const account = accounts.find(a => a.id === accountId);
    
    if (!account) {
      log.error(`Account not found in cache: ${accountId}`);
      log.info(`Available accounts: ${JSON.stringify(accounts.map(a => ({ id: a.id, platform: a.platform_id, name: a.account_name })))}`);
      return {
        success: false,
        message: '账号不存在'
      };
    }

    // ... 其余代码
  }
});
```

## 验证修复

### 1. 登录新账号
1. 打开 Windows 登录管理器
2. 登录一个新账号
3. 查看日志确认同步成功

### 2. 刷新账号列表
1. 在账号管理页面点击"刷新"
2. 确认新账号出现在列表中

### 3. 测试登录
1. 点击账号的"测试登录"按钮
2. 应该能正常打开测试页面

## 调试命令

```bash
# 查看所有日志
tail -f ~/Library/Logs/windows-login-manager/main.log

# 只看同步相关
tail -f ~/Library/Logs/windows-login-manager/main.log | grep "sync\|同步"

# 只看账号相关
tail -f ~/Library/Logs/windows-login-manager/main.log | grep "account\|账号"

# 只看错误
tail -f ~/Library/Logs/windows-login-manager/main.log | grep "error\|Error\|错误"
```

## 预期结果

修复后，完整流程应该是：

1. **登录账号**
   - 日志：`[平台名] 账号已同步到后端` ✅
   
2. **刷新列表**
   - 日志：`IPC: 从后端获取到 X 个账号` ✅
   - 界面：新账号出现在列表中 ✅

3. **测试登录**
   - 日志：`Test login webview opened for account: xxx` ✅
   - 界面：打开测试页面，显示登录状态 ✅

## 下一步

1. 按照诊断步骤检查问题
2. 查看日志找出具体原因
3. 应用对应的解决方案
4. 验证修复是否成功
