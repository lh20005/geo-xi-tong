# å¹³å°ç™»å½•åŠŸèƒ½ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ åŠŸèƒ½è¯´æ˜

è¿™ä¸ªåŠŸèƒ½å…è®¸ä½ é€šè¿‡æµè§ˆå™¨ç™»å½•å„ä¸ªå†…å®¹å¹³å°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜ç™»å½•Cookieï¼Œç”¨äºåç»­çš„æ–‡ç« å‘å¸ƒã€‚

### ä¸»è¦ç‰¹æ€§

1. **ä¸€é”®æµè§ˆå™¨ç™»å½•**ï¼šç‚¹å‡»å¹³å°å¡ç‰‡ï¼Œè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ç™»å½•é¡µé¢
2. **è‡ªåŠ¨ä¿å­˜Cookie**ï¼šç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜Cookieï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
3. **è´¦å·ä¿¡æ¯ç®¡ç†**ï¼šåœ¨è¡¨æ ¼ä¸­æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å·²ä¿å­˜çš„è´¦å·
4. **å®‰å…¨åŠ å¯†å­˜å‚¨**ï¼šæ‰€æœ‰Cookieä½¿ç”¨AES-256åŠ å¯†å­˜å‚¨

## ğŸ“‹ å‰ç½®è¦æ±‚

### 1. ç¡®ä¿æ•°æ®åº“è¡¨å·²åˆ›å»º

è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼š

```bash
cd server
npm run migrate:publishing
```

æˆ–è€…æ‰‹åŠ¨è¿è¡Œï¼š

```bash
cd server
npx tsx src/db/migrate-publishing.ts
```

### 2. ç¡®ä¿Puppeteerå·²å®‰è£…

Puppeteeråº”è¯¥å·²ç»åœ¨serverçš„package.jsonä¸­ï¼Œå¦‚æœæ²¡æœ‰ï¼š

```bash
cd server
npm install puppeteer
```

### 3. å¯åŠ¨æœåŠ¡

**å¯åŠ¨åç«¯æœåŠ¡ï¼š**
```bash
cd server
npm run dev
```

**å¯åŠ¨å‰ç«¯æœåŠ¡ï¼š**
```bash
cd client
npm start
```

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ–¹å¼ä¸€ï¼šåœ¨å‰ç«¯åº”ç”¨ä¸­ä½¿ç”¨

1. **æ‰“å¼€å¹³å°ç™»å½•é¡µé¢**
   - è®¿é—® http://localhost:3000
   - ç‚¹å‡»å·¦ä¾§èœå•çš„ã€å¹³å°ç™»å½•ã€‘

2. **é€‰æ‹©å¹³å°ç™»å½•**
   - åœ¨é¡µé¢ä¸Šæ–¹çœ‹åˆ°æ‰€æœ‰å¯ç”¨å¹³å°çš„å¡ç‰‡
   - ç‚¹å‡»ä»»æ„å¹³å°å¡ç‰‡ï¼ˆå¦‚ï¼šçŸ¥ä¹ã€ç®€ä¹¦ã€CSDNç­‰ï¼‰

3. **åœ¨æµè§ˆå™¨ä¸­ç™»å½•**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€ä¸€ä¸ªæ–°çš„æµè§ˆå™¨çª—å£
   - åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä½ çš„è´¦å·å’Œå¯†ç 
   - å®Œæˆç™»å½•ï¼ˆå¯èƒ½éœ€è¦éªŒè¯ç æˆ–äºŒæ¬¡éªŒè¯ï¼‰

4. **ç­‰å¾…è‡ªåŠ¨ä¿å­˜**
   - ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
     - è·å–Cookie
     - æå–ç”¨æˆ·ä¿¡æ¯
     - ä¿å­˜åˆ°æ•°æ®åº“
     - å…³é—­æµè§ˆå™¨çª—å£
   - é¡µé¢ä¼šæ˜¾ç¤º"ç™»å½•æˆåŠŸ"çš„æç¤º

5. **æŸ¥çœ‹è´¦å·ä¿¡æ¯**
   - åœ¨é¡µé¢ä¸‹æ–¹çš„è¡¨æ ¼ä¸­æŸ¥çœ‹åˆšåˆšä¿å­˜çš„è´¦å·
   - è¡¨æ ¼æ˜¾ç¤ºï¼šå¹³å°ã€è´¦å·åç§°ã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ç­‰ä¿¡æ¯

### æ–¹å¼äºŒï¼šä½¿ç”¨æµ‹è¯•é¡µé¢

1. **æ‰“å¼€æµ‹è¯•é¡µé¢**
   ```bash
   open test-platform-login.html
   ```
   æˆ–åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š`file:///path/to/test-platform-login.html`

2. **åŠ è½½å¹³å°åˆ—è¡¨**
   - ç‚¹å‡»"åŠ è½½å¹³å°åˆ—è¡¨"æŒ‰é’®
   - æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„å¹³å°

3. **æµ‹è¯•ç™»å½•**
   - ç‚¹å‡»ä»»æ„å¹³å°å¡ç‰‡
   - æˆ–ç‚¹å‡»"æµ‹è¯•æµè§ˆå™¨ç™»å½•ï¼ˆçŸ¥ä¹ï¼‰"æŒ‰é’®
   - åœ¨å¼¹å‡ºçš„æµè§ˆå™¨ä¸­å®Œæˆç™»å½•

4. **æŸ¥çœ‹ç»“æœ**
   - ç‚¹å‡»"åŠ è½½è´¦å·åˆ—è¡¨"æŒ‰é’®
   - æŸ¥çœ‹å·²ä¿å­˜çš„è´¦å·ä¿¡æ¯

## ğŸ”§ æ”¯æŒçš„å¹³å°

ç›®å‰æ”¯æŒä»¥ä¸‹å¹³å°çš„æµè§ˆå™¨ç™»å½•ï¼š

| å¹³å° | ç™»å½•URL | çŠ¶æ€ |
|------|---------|------|
| å¾®ä¿¡å…¬ä¼—å· | https://mp.weixin.qq.com/ | âœ… æ”¯æŒ |
| å¤´æ¡å· | https://mp.toutiao.com/auth/page/login/ | âœ… æ”¯æŒ |
| çŸ¥ä¹ | https://www.zhihu.com/signin | âœ… æ”¯æŒ |
| ç®€ä¹¦ | https://www.jianshu.com/sign_in | âœ… æ”¯æŒ |
| CSDN | https://passport.csdn.net/login | âœ… æ”¯æŒ |
| æ˜é‡‘ | https://juejin.cn/login | âœ… æ”¯æŒ |
| SegmentFault | https://segmentfault.com/user/login | âœ… æ”¯æŒ |
| å¼€æºä¸­å›½ | https://www.oschina.net/home/login | âœ… æ”¯æŒ |
| åšå®¢å›­ | https://account.cnblogs.com/signin | âœ… æ”¯æŒ |
| V2EX | https://www.v2ex.com/signin | âœ… æ”¯æŒ |

## ğŸ“Š è´¦å·ä¿¡æ¯è¡¨æ ¼è¯´æ˜

è¡¨æ ¼æ˜¾ç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š

- **å¹³å°**ï¼šè´¦å·æ‰€å±çš„å¹³å°
- **è´¦å·åç§°**ï¼šè‡ªåŠ¨æå–æˆ–ç”Ÿæˆçš„è´¦å·åç§°
- **çŠ¶æ€**ï¼š
  - ğŸŸ¢ æ­£å¸¸ï¼šè´¦å·å¯ç”¨
  - âšª æœªæ¿€æ´»ï¼šè´¦å·æœªæ¿€æ´»
- **åˆ›å»ºæ—¶é—´**ï¼šè´¦å·é¦–æ¬¡ä¿å­˜çš„æ—¶é—´
- **æœ€åä½¿ç”¨**ï¼šè´¦å·æœ€åä¸€æ¬¡ç”¨äºå‘å¸ƒçš„æ—¶é—´
- **æ“ä½œ**ï¼š
  - â­ é»˜è®¤æ ‡è®°ï¼šé»˜è®¤è´¦å·ä¼šæ˜¾ç¤ºæ˜Ÿæ ‡
  - ğŸ—‘ï¸ åˆ é™¤ï¼šåˆ é™¤è´¦å·åŠå…¶Cookie

## ğŸ” å®‰å…¨è¯´æ˜

### CookieåŠ å¯†å­˜å‚¨

æ‰€æœ‰Cookieæ•°æ®éƒ½ç»è¿‡AES-256åŠ å¯†åå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼š

```typescript
// å­˜å‚¨æ ¼å¼
{
  "username": "ç”¨æˆ·å",
  "password": "cookie_auth",
  "cookies": [
    {
      "name": "cookieåç§°",
      "value": "cookieå€¼",
      "domain": "åŸŸå",
      ...
    }
  ],
  "loginTime": "2024-12-16T...",
  "userInfo": {
    "username": "æå–çš„ç”¨æˆ·å"
  }
}
```

### åŠ å¯†å¯†é’¥ç®¡ç†

- åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡æˆ–æ•°æ®åº“ä¸­
- ä½¿ç”¨EncryptionServiceè¿›è¡Œç»Ÿä¸€ç®¡ç†
- æ”¯æŒå¯†é’¥è½®æ¢

## ğŸ› å¸¸è§é—®é¢˜

### 1. æµè§ˆå™¨æ— æ³•æ‰“å¼€

**é—®é¢˜**ï¼šç‚¹å‡»å¹³å°å¡ç‰‡åæ²¡æœ‰ååº”

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥Puppeteeræ˜¯å¦æ­£ç¡®å®‰è£…
- æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœ‰Chromium
- æŸ¥çœ‹åç«¯æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

```bash
cd server
npm install puppeteer --force
```

### 2. ç™»å½•è¶…æ—¶

**é—®é¢˜**ï¼š5åˆ†é’Ÿå†…æœªå®Œæˆç™»å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é‡æ–°ç‚¹å‡»å¹³å°å¡ç‰‡
- ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
- å¦‚éœ€æ›´é•¿æ—¶é—´ï¼Œå¯ä¿®æ”¹è¶…æ—¶è®¾ç½®ï¼š

```typescript
// server/src/services/AccountService.ts
await page.waitForFunction(
  () => ...,
  { timeout: 600000 } // æ”¹ä¸º10åˆ†é’Ÿ
);
```

### 3. Cookieæœªä¿å­˜

**é—®é¢˜**ï¼šç™»å½•æˆåŠŸä½†è´¦å·åˆ—è¡¨ä¸­æ²¡æœ‰æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥åç«¯æ—¥å¿—
- ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
- æ‰‹åŠ¨åˆ·æ–°é¡µé¢

### 4. æ— æ³•æå–ç”¨æˆ·å

**é—®é¢˜**ï¼šè´¦å·åç§°æ˜¾ç¤ºä¸ºæ—¶é—´æˆ³

**è§£å†³æ–¹æ¡ˆ**ï¼š
è¿™æ˜¯æ­£å¸¸çš„ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè´¦å·åç§°ã€‚ä½ å¯ä»¥ï¼š
- åœ¨AccountManagementModalä¸­ç¼–è¾‘è´¦å·åç§°
- æˆ–åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨ä¿®æ”¹

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### æµ‹è¯•APIæ¥å£

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
./test-platform-login.sh

# æˆ–æ‰‹åŠ¨æµ‹è¯•
curl http://localhost:3001/api/publishing/platforms
curl http://localhost:3001/api/publishing/accounts
```

### æµ‹è¯•æµè§ˆå™¨ç™»å½•

```bash
# ä½¿ç”¨æµ‹è¯•é¡µé¢
open test-platform-login.html

# æˆ–åœ¨å‰ç«¯åº”ç”¨ä¸­æµ‹è¯•
# è®¿é—® http://localhost:3000/platform-management
```

## ğŸ“ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°å¹³å°æ”¯æŒ

1. **åœ¨æ•°æ®åº“ä¸­æ·»åŠ å¹³å°é…ç½®**

```sql
INSERT INTO platforms_config 
(platform_id, platform_name, icon_url, adapter_class, required_fields)
VALUES ('new_platform', 'æ–°å¹³å°', '/icons/new.png', 'NewAdapter', '["username", "password"]');
```

2. **åœ¨AccountServiceä¸­æ·»åŠ ç™»å½•URL**

```typescript
// server/src/services/AccountService.ts
private getPlatformLoginUrl(platformId: string): string | null {
  const loginUrls: { [key: string]: string } = {
    // ... ç°æœ‰å¹³å°
    'new_platform': 'https://new-platform.com/login'
  };
  return loginUrls[platformId] || null;
}
```

3. **æ·»åŠ ç­‰å¾…æ¡ä»¶ï¼ˆå¯é€‰ï¼‰**

```typescript
private async waitForLogin(page: any, platformId: string): Promise<void> {
  const waitConditions: { [key: string]: () => Promise<void> } = {
    // ... ç°æœ‰å¹³å°
    'new_platform': async () => {
      await page.waitForFunction(
        () => window.location.href.includes('dashboard'),
        { timeout: 300000 }
      );
    }
  };
  // ...
}
```

4. **æ·»åŠ ç”¨æˆ·ä¿¡æ¯æå–ï¼ˆå¯é€‰ï¼‰**

```typescript
private async extractUserInfo(page: any, platformId: string): Promise<any> {
  const selectors: { [key: string]: string } = {
    // ... ç°æœ‰å¹³å°
    'new_platform': '.user-profile-name'
  };
  // ...
}
```

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å¯ä»¥ï¼š
- âœ… é€šè¿‡æµè§ˆå™¨ç™»å½•å„ä¸ªå¹³å°
- âœ… è‡ªåŠ¨ä¿å­˜å’Œç®¡ç†Cookie
- âœ… æŸ¥çœ‹æ‰€æœ‰å·²ä¿å­˜çš„è´¦å·ä¿¡æ¯
- âœ… ä½¿ç”¨è¿™äº›è´¦å·è¿›è¡Œæ–‡ç« å‘å¸ƒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- åç«¯æ—¥å¿—ï¼š`server/logs/`
- å‰ç«¯æ§åˆ¶å°ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·
- æ•°æ®åº“ï¼š`platform_accounts` è¡¨
