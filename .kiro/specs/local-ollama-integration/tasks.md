# 实现计划

- [x] 1. 数据库Schema扩展
  - 修改`api_configs`表以支持ollama provider类型
  - 添加`ollama_base_url`和`ollama_model`字段
  - 将`api_key`字段改为可选（ollama不需要）
  - 创建数据库迁移脚本
  - _需求: 5.1, 5.4_

- [x] 2. 创建OllamaService服务类
  - 实现`checkConnection()`方法检测Ollama服务可用性
  - 实现`listModels()`方法获取已安装模型列表
  - 实现`getDeepSeekModels()`方法过滤DeepSeek模型
  - 实现`chat()`方法调用Ollama进行对话
  - 添加错误处理和超时控制
  - _需求: 2.1, 2.2, 4.1_

- [ ]* 2.1 编写OllamaService的属性测试
  - **属性 2: DeepSeek模型过滤完整性**
  - **验证: 需求 2.2, 2.5**

- [x] 3. 扩展AIService以支持Ollama
  - 修改`AIProvider`类型定义，添加'ollama'选项
  - 修改`AIConfig`接口，添加ollama相关字段
  - 在构造函数中初始化OllamaService实例
  - 实现`callOllama()`私有方法
  - 修改`callAI()`方法的路由逻辑，支持ollama分支
  - 确保Ollama响应格式与云端API统一
  - _需求: 4.1, 4.2, 4.3, 4.5_

- [ ]* 3.1 编写AIService路由的属性测试
  - **属性 5: AI服务路由正确性**
  - **验证: 需求 4.1**

- [ ]* 3.2 编写Ollama响应解析的属性测试
  - **属性 6: Ollama响应解析正确性**
  - **验证: 需求 4.5**

- [x] 4. 扩展配置API端点
  - 创建`GET /api/config/ollama/models`端点检测本地模型
  - 创建`POST /api/config/ollama/test`端点测试Ollama连接
  - 修改`POST /api/config`端点支持保存ollama配置
  - 修改`GET /api/config/active`端点返回ollama配置信息
  - 实现配置验证逻辑（验证baseUrl格式、模型存在性等）
  - _需求: 2.1, 3.1, 5.1_

- [ ]* 4.1 编写配置往返的属性测试
  - **属性 3: 配置往返一致性**
  - **验证: 需求 5.1, 5.4**

- [ ]* 4.2 编写provider切换的属性测试
  - **属性 4: Provider切换时配置清理**
  - **验证: 需求 6.1, 6.2**

- [x] 5. 更新前端ConfigPage组件
  - 在provider下拉框中添加"本地Ollama"选项
  - 添加`ollamaBaseUrl`输入框（默认值：http://localhost:11434）
  - 添加`ollamaModel`下拉框用于选择模型
  - 实现provider切换时的字段显示/隐藏逻辑
  - 添加"检测模型"按钮和loading状态
  - 添加"测试连接"按钮
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 6. 实现前端模型检测逻辑
  - 创建`detectOllamaModels()`函数调用检测API
  - 在用户选择ollama时自动触发检测
  - 在用户修改baseUrl时重新检测
  - 显示检测到的模型列表
  - 处理检测失败的情况（显示错误提示）
  - _需求: 2.1, 2.2, 2.3, 2.4, 3.4_

- [ ]* 6.1 编写UI字段显示的属性测试
  - **属性 1: UI字段显示一致性**
  - **验证: 需求 1.2, 1.3, 1.4**

- [ ]* 6.2 编写地址变化触发检测的属性测试
  - **属性 7: 地址变化触发重新检测**
  - **验证: 需求 3.4**

- [x] 7. 实现连接测试功能
  - 在前端添加测试连接按钮的点击处理
  - 调用`/api/config/ollama/test` API
  - 显示测试结果（成功/失败消息）
  - 在测试成功时显示检测到的模型数量
  - _需求: 3.1, 3.2, 3.3_

- [x] 8. 实现错误处理和用户提示
  - 添加Ollama服务不可访问的错误提示
  - 添加未检测到DeepSeek模型的提示和安装指引
  - 添加模型推理超时的错误处理
  - 添加配置保存失败的错误提示
  - 确保所有错误消息用户友好且可操作
  - _需求: 2.3, 2.4, 4.4_

- [ ]* 8.1 编写错误处理的属性测试
  - **属性 8: 错误处理不影响系统状态**
  - **验证: 需求 6.4, 4.4**

- [x] 9. 更新环境配置文件
  - 在`.env.example`中添加`OLLAMA_BASE_URL`配置项
  - 添加配置说明注释
  - _需求: 5.1_

- [x] 10. 集成测试和端到端验证
  - 测试完整的配置流程（选择ollama → 检测模型 → 保存配置）
  - 测试使用ollama执行关键词蒸馏任务
  - 测试使用ollama执行文章生成任务
  - 测试从云端API切换到ollama的流程
  - 测试从ollama切换到云端API的流程
  - 验证配置持久化和恢复
  - _需求: 4.2, 4.3, 5.2, 5.3, 6.1, 6.2, 6.3_

- [x] 11. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
