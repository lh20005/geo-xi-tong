# 需求文档

## 简介

本功能旨在优化文章生成模块中蒸馏结果的选择算法。当前实现存在一个严重问题：在"新建任务"选择"蒸馏历史"时，系统会重复使用同一个蒸馏结果生成所有文章，而不是根据使用次数智能选择不同的蒸馏结果。这导致其他蒸馏结果从未被使用，违背了平均使用的设计目标。

本功能将修复这个问题，实现真正的智能循环选择算法：
1. 在创建任务时，根据请求的文章数量，选择使用次数最少的N个蒸馏结果
2. 为每篇文章分配不同的蒸馏结果
3. 生成文章后更新对应蒸馏结果的使用计数
4. 确保所有蒸馏结果被平均使用

## 术语表

- **系统 (System)**: 指整个文章生成和蒸馏结果管理应用
- **蒸馏结果 (Distillation Result)**: 通过关键词蒸馏生成的话题列表，每个蒸馏结果包含一个关键词和多个相关话题
- **文章生成任务 (Generation Task)**: 用户创建的批量文章生成任务，每个任务可以使用多个不同的蒸馏结果生成多篇文章
- **使用次数 (Usage Count)**: 某个蒸馏结果被用于文章生成的总次数
- **智能选择 (Smart Selection)**: 根据使用次数自动选择使用次数最少的N个蒸馏结果的算法
- **循环使用 (Circular Usage)**: 确保所有蒸馏结果被平均使用，当所有结果使用次数相同时，从最早创建的开始重新使用
- **蒸馏结果池 (Distillation Pool)**: 为单个任务选择的一组蒸馏结果，每篇文章从池中选择一个不同的蒸馏结果

## 需求

### 需求 1：任务创建时的智能选择

**用户故事：** 作为系统，我需要在创建文章生成任务时，根据请求的文章数量智能选择使用次数最少的N个蒸馏结果，以便实现蒸馏结果的平均使用。

#### 验收标准

1. WHEN 用户创建生成N篇文章的任务 THEN 系统应当查询所有有话题的蒸馏结果并按usage_count升序、created_at升序排序
2. WHEN 系统选择蒸馏结果 THEN 系统应当选择排序后的前N个蒸馏结果
3. WHEN 可用蒸馏结果数量少于请求数量 THEN 系统应当返回错误提示用户
4. WHEN 系统选择蒸馏结果 THEN 系统应当将选择的结果ID列表保存到任务记录中
5. WHEN 多个蒸馏结果的usage_count相同 THEN 系统应当优先选择created_at较早的蒸馏结果

### 需求 2：任务执行时的蒸馏结果分配

**用户故事：** 作为系统，我需要在执行文章生成任务时，为每篇文章分配不同的蒸馏结果，以便避免重复使用同一个蒸馏结果。

#### 验收标准

1. WHEN 系统开始执行任务 THEN 系统应当从任务记录中读取预选的蒸馏结果ID列表
2. WHEN 系统生成第i篇文章 THEN 系统应当使用列表中的第i个蒸馏结果
3. WHEN 系统为文章选择蒸馏结果 THEN 系统应当提取该蒸馏结果的关键词和话题列表
4. WHEN 系统生成单篇文章 THEN 系统应当仅使用一个蒸馏结果的数据
5. WHEN 任务中的所有文章生成完成 THEN 系统应当确保每个预选的蒸馏结果都被使用了恰好一次

### 需求 3：使用计数的准确更新

**用户故事：** 作为系统，我需要在每篇文章生成并保存后，立即更新对应蒸馏结果的使用计数，以便保持统计数据的准确性。

#### 验收标准

1. WHEN 系统保存文章 THEN 系统应当在同一事务中更新对应蒸馏结果的usage_count
2. WHEN 系统更新usage_count THEN 系统应当使用原子操作（SQL INCREMENT）
3. WHEN 文章保存失败 THEN 系统应当回滚事务，不更新usage_count
4. WHEN 系统更新usage_count THEN 系统应当确保计数值准确反映实际使用次数
5. WHEN 多个任务并发执行 THEN 系统应当使用数据库锁确保usage_count更新的正确性

### 需求 4：数据库架构扩展

**用户故事：** 作为系统管理员，我需要扩展数据库架构以支持任务级别的蒸馏结果选择，以便系统能够记录每个任务使用了哪些蒸馏结果。

#### 验收标准

1. WHEN 系统创建任务 THEN 系统应当在generation_tasks表中存储selected_distillation_ids字段（JSON数组）
2. WHEN 系统查询任务 THEN 系统应当能够读取selected_distillation_ids字段
3. WHEN 系统执行任务 THEN 系统应当使用selected_distillation_ids中的蒸馏结果ID
4. WHEN selected_distillation_ids为空或NULL THEN 系统应当抛出错误
5. WHEN 系统存储selected_distillation_ids THEN 系统应当验证所有ID都是有效的蒸馏结果ID

### 需求 5：任务配置验证

**用户故事：** 作为系统，我需要在创建任务时验证蒸馏结果的可用性，以便在任务执行前发现问题。

#### 验收标准

1. WHEN 用户请求生成N篇文章 THEN 系统应当验证至少有N个有话题的蒸馏结果可用
2. WHEN 可用蒸馏结果不足 THEN 系统应当返回400错误并提示当前可用数量
3. WHEN 系统验证蒸馏结果 THEN 系统应当排除没有话题的蒸馏结果
4. WHEN 系统验证蒸馏结果 THEN 系统应当排除已被删除的蒸馏结果
5. WHEN 验证通过 THEN 系统应当继续创建任务

### 需求 6：错误处理和恢复

**用户故事：** 作为系统，我需要在任务执行过程中正确处理错误，以便在部分文章生成失败时仍能保持数据一致性。

#### 验收标准

1. WHEN 单篇文章生成失败 THEN 系统应当记录错误但继续处理下一篇文章
2. WHEN 文章保存失败 THEN 系统应当回滚该文章的所有数据库操作
3. WHEN 任务执行过程中发生错误 THEN 系统应当保存已成功生成的文章
4. WHEN 任务部分完成 THEN 系统应当更新任务状态为completed并记录实际生成数量
5. WHEN 所有文章都生成失败 THEN 系统应当标记任务为failed并记录错误信息

### 需求 7：并发控制

**用户故事：** 作为系统，我需要在多个任务并发执行时正确处理蒸馏结果的选择和使用计数更新，以便避免数据竞争。

#### 验收标准

1. WHEN 多个任务同时创建 THEN 系统应当使用数据库事务隔离确保每个任务选择的蒸馏结果不重复
2. WHEN 多个任务同时更新同一蒸馏结果的usage_count THEN 系统应当使用原子操作确保计数准确
3. WHEN 并发更新发生冲突 THEN 系统应当重试操作（最多3次）
4. WHEN 重试失败 THEN 系统应当记录错误日志并标记任务为失败
5. WHEN 系统选择蒸馏结果 THEN 系统应当在事务中锁定选中的记录直到任务创建完成

### 需求 8：任务详情显示

**用户故事：** 作为用户，我希望在任务详情中看到该任务使用了哪些蒸馏结果，以便了解任务的配置。

#### 验收标准

1. WHEN 用户查看任务详情 THEN 系统应当显示该任务使用的所有蒸馏结果的关键词列表
2. WHEN 系统显示蒸馏结果列表 THEN 系统应当按照使用顺序显示
3. WHEN 某个蒸馏结果被删除 THEN 系统应当在列表中显示"已删除"
4. WHEN 用户查看任务列表 THEN 系统应当在"蒸馏结果"列显示第一个蒸馏结果的关键词
5. WHEN 任务使用多个蒸馏结果 THEN 系统应当在"蒸馏结果"列显示"多个蒸馏结果"或数量提示

### 需求 9：向后兼容性

**用户故事：** 作为系统管理员，我需要确保新的实现与现有数据兼容，以便不影响已创建的任务。

#### 验收标准

1. WHEN 系统读取旧任务（没有selected_distillation_ids） THEN 系统应当使用distillation_id字段作为后备
2. WHEN 系统执行旧任务 THEN 系统应当使用原有的单蒸馏结果逻辑
3. WHEN 系统显示旧任务 THEN 系统应当正确显示蒸馏结果信息
4. WHEN 系统迁移数据库 THEN 系统应当为所有现有任务初始化selected_distillation_ids
5. WHEN 迁移完成 THEN 系统应当验证所有任务都有有效的selected_distillation_ids

### 需求 10：数据一致性验证

**用户故事：** 作为系统管理员，我需要工具来验证和修复蒸馏结果使用计数的准确性，以便在数据异常时进行维护。

#### 验收标准

1. WHEN 管理员运行验证工具 THEN 系统应当比对每个蒸馏结果的usage_count与实际使用记录数量
2. WHEN 发现不一致 THEN 系统应当记录详细的差异信息
3. WHEN 管理员运行修复工具 THEN 系统应当重新计算所有蒸馏结果的usage_count
4. WHEN 修复完成 THEN 系统应当返回修复的记录数量和详细信息
5. WHEN 系统检测到数据不一致 THEN 系统应当记录警告日志

### 需求 11：性能优化

**用户故事：** 作为系统，我需要优化蒸馏结果选择的性能，以便在大量蒸馏结果的情况下仍能快速响应。

#### 验收标准

1. WHEN 系统选择蒸馏结果 THEN 系统应当使用索引优化查询性能
2. WHEN 系统查询蒸馏结果 THEN 系统应当使用LIMIT限制返回数量
3. WHEN 系统更新usage_count THEN 系统应当使用单条UPDATE语句而非读-修改-写
4. WHEN 系统执行任务 THEN 系统应当批量加载所有需要的蒸馏结果数据
5. WHEN 系统处理大量任务 THEN 系统应当使用连接池管理数据库连接

### 需求 12：日志和监控

**用户故事：** 作为系统管理员，我需要详细的日志来追踪蒸馏结果的选择和使用情况，以便诊断问题。

#### 验收标准

1. WHEN 系统选择蒸馏结果 THEN 系统应当记录选择的蒸馏结果ID列表
2. WHEN 系统为文章分配蒸馏结果 THEN 系统应当记录分配的蒸馏结果ID和关键词
3. WHEN 系统更新usage_count THEN 系统应当记录更新前后的值
4. WHEN 发生错误 THEN 系统应当记录详细的错误信息和上下文
5. WHEN 任务完成 THEN 系统应当记录每个蒸馏结果的使用情况统计

### 需求 13：API接口更新

**用户故事：** 作为前端开发者，我需要更新的API接口来支持新的蒸馏结果选择逻辑，以便前端能够正确显示信息。

#### 验收标准

1. WHEN 前端创建任务 THEN 系统应当返回选择的蒸馏结果ID列表
2. WHEN 前端查询任务详情 THEN 系统应当返回所有使用的蒸馏结果的详细信息
3. WHEN 前端查询任务列表 THEN 系统应当返回每个任务的蒸馏结果摘要
4. WHEN API返回数据 THEN 系统应当确保数据结构的一致性
5. WHEN API发生错误 THEN 系统应当返回清晰的错误信息和HTTP状态码

### 需求 14：测试和验证

**用户故事：** 作为开发者，我需要全面的测试来验证新的选择算法的正确性，以便确保功能按预期工作。

#### 验收标准

1. WHEN 运行单元测试 THEN 系统应当验证智能选择算法的正确性
2. WHEN 运行集成测试 THEN 系统应当验证完整的任务执行流程
3. WHEN 运行并发测试 THEN 系统应当验证多任务并发执行的正确性
4. WHEN 运行性能测试 THEN 系统应当验证大量蒸馏结果情况下的性能
5. WHEN 所有测试通过 THEN 系统应当确保没有回归问题

### 需求 15：文档更新

**用户故事：** 作为开发者和用户，我需要更新的文档来了解新的蒸馏结果选择逻辑，以便正确使用和维护系统。

#### 验收标准

1. WHEN 开发者查看设计文档 THEN 系统应当提供详细的算法说明
2. WHEN 开发者查看API文档 THEN 系统应当提供更新的接口说明
3. WHEN 用户查看用户手册 THEN 系统应当解释蒸馏结果的选择和使用逻辑
4. WHEN 管理员查看运维文档 THEN 系统应当提供数据迁移和验证工具的使用说明
5. WHEN 文档更新完成 THEN 系统应当确保所有相关文档都已同步更新
