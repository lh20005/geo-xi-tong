# 实现计划

- [x] 1. 数据库架构扩展
  - 为generation_tasks表添加selected_distillation_ids字段
  - 创建必要的索引
  - 编写数据迁移脚本
  - _需求: 4.1, 4.2_

- [x] 1.1 编写数据库迁移脚本
  - 创建003_add_smart_selection.sql迁移文件
  - 添加selected_distillation_ids TEXT字段
  - 创建索引idx_generation_tasks_selected_distillations
  - 为现有任务初始化selected_distillation_ids
  - _需求: 4.1, 9.4_

- [x] 1.2 运行和验证迁移
  - 执行迁移脚本
  - 验证字段和索引创建成功
  - 验证现有数据的JSON格式正确
  - 验证所有任务都有有效的selected_distillation_ids
  - _需求: 9.5_

- [ ] 2. 实现智能选择算法
  - 实现selectDistillationsForTask方法
  - 实现排序逻辑（usage_count ASC, created_at ASC）
  - 实现过滤逻辑（排除没有话题的蒸馏结果）
  - 实现可用性验证
  - _需求: 1.1, 1.2, 1.5, 5.1, 5.3, 5.4_

- [x] 2.1 实现蒸馏结果查询和排序
  - 编写SQL查询获取所有有话题的蒸馏结果
  - 实现按usage_count和created_at排序
  - 使用LIMIT限制返回数量
  - 处理空结果情况
  - _需求: 1.1, 1.2, 1.5_

- [x] 2.2 实现可用性验证
  - 验证可用蒸馏结果数量是否充足
  - 返回清晰的错误消息（包含可用数量）
  - 记录验证失败日志
  - _需求: 1.3, 5.1, 5.2_

- [ ] 2.3 编写属性测试：智能选择排序正确性
  - **属性 1: 智能选择排序正确性**
  - **验证需求: 1.1, 1.5**
  - 生成随机蒸馏结果数据
  - 验证返回结果按usage_count和created_at排序
  - 运行至少100次迭代

- [ ] 2.4 编写属性测试：选择数量正确性
  - **属性 2: 选择数量正确性**
  - **验证需求: 1.2**
  - 生成随机请求数量
  - 验证返回结果数量正确
  - 运行至少100次迭代

- [ ] 2.5 编写属性测试：过滤逻辑正确性
  - **属性 12: 过滤逻辑正确性**
  - **验证需求: 5.3, 5.4**
  - 生成包含无效蒸馏结果的数据
  - 验证返回结果不包含无效数据
  - 运行至少100次迭代

- [ ] 3. 修改任务创建逻辑
  - 修改createTask方法调用selectDistillationsForTask
  - 将选择的ID列表保存到selected_distillation_ids字段
  - 实现ID验证逻辑
  - 更新API响应包含selectedDistillationIds
  - _需求: 1.4, 4.1, 4.5, 13.1_

- [x] 3.1 实现ID列表保存
  - 将ID数组序列化为JSON字符串
  - 保存到generation_tasks.selected_distillation_ids
  - 验证JSON格式正确
  - _需求: 1.4, 4.1_

- [x] 3.2 实现ID验证
  - 验证所有ID都是有效的蒸馏结果ID
  - 验证所有蒸馏结果都有话题
  - 返回清晰的错误消息
  - _需求: 4.5_

- [ ] 3.3 编写属性测试：ID列表持久化
  - **属性 3: ID列表持久化**
  - **验证需求: 1.4, 4.1, 4.2**
  - 生成随机ID列表
  - 验证保存后能正确读取
  - 运行至少100次迭代

- [ ] 3.4 编写属性测试：ID验证有效性
  - **属性 10: ID验证有效性**
  - **验证需求: 4.5**
  - 生成包含无效ID的列表
  - 验证系统正确拒绝
  - 运行至少100次迭代

- [ ] 4. 实现批量加载蒸馏结果数据
  - 实现loadDistillationData方法
  - 使用单次查询批量加载所有蒸馏结果
  - 返回Map<id, {keyword, topics}>
  - 处理缺失数据情况
  - _需求: 2.1, 2.3_

- [x] 4.1 编写批量查询SQL
  - 使用array_agg聚合话题
  - 使用WHERE id = ANY($1)批量查询
  - 优化查询性能
  - _需求: 2.1_

- [x] 4.2 实现数据映射
  - 将查询结果转换为Map结构
  - 处理缺失的蒸馏结果
  - 记录警告日志
  - _需求: 2.3_

- [ ] 5. 修改任务执行逻辑
  - 修改executeTask方法读取selected_distillation_ids
  - 实现向后兼容逻辑（处理旧任务）
  - 为每篇文章分配不同的蒸馏结果
  - 确保每个蒸馏结果被使用恰好一次
  - _需求: 2.1, 2.2, 2.4, 2.5, 4.3, 9.1, 9.2_

- [x] 5.1 实现selected_distillation_ids读取
  - 从数据库读取JSON字符串
  - 反序列化为ID数组
  - 处理NULL或空值情况（向后兼容）
  - _需求: 2.1, 4.3_

- [x] 5.2 实现向后兼容逻辑
  - 检查selected_distillation_ids是否为空
  - 如果为空，使用distillation_id作为后备
  - 记录使用旧逻辑的日志
  - _需求: 9.1, 9.2_

- [x] 5.3 实现蒸馏结果分配
  - 调用loadDistillationData批量加载数据
  - 为第i篇文章使用selected_distillation_ids[i]
  - 提取对应的关键词和话题
  - 确保单文章数据隔离
  - _需求: 2.2, 2.3, 2.4_

- [ ] 5.4 编写属性测试：蒸馏结果分配正确性
  - **属性 4: 蒸馏结果分配正确性**
  - **验证需求: 2.1, 2.2, 4.3**
  - 生成随机ID列表和文章索引
  - 验证分配的蒸馏结果ID正确
  - 运行至少100次迭代

- [ ] 5.5 编写属性测试：单文章数据隔离
  - **属性 6: 单文章数据隔离**
  - **验证需求: 2.4**
  - 生成随机文章数据
  - 验证每篇文章只使用一个蒸馏结果
  - 运行至少100次迭代

- [ ] 5.6 编写属性测试：蒸馏结果使用唯一性
  - **属性 7: 蒸馏结果使用唯一性**
  - **验证需求: 2.5**
  - 生成随机任务
  - 验证每个蒸馏结果被使用恰好一次
  - 运行至少100次迭代

- [ ] 5.7 编写属性测试：向后兼容性
  - **属性 18: 向后兼容性**
  - **验证需求: 9.1, 9.2, 9.3**
  - 创建旧格式任务
  - 验证任务能正常执行
  - 运行至少100次迭代

- [ ] 6. 确保事务完整性和使用计数准确性
  - 验证saveArticleWithUsageTracking方法的事务逻辑
  - 确保文章保存、使用记录创建、usage_count更新在同一事务中
  - 实现回滚逻辑
  - _需求: 3.1, 3.3, 3.4_

- [ ] 6.1 编写属性测试：事务完整性
  - **属性 8: 事务完整性**
  - **验证需求: 3.1, 3.3, 6.2**
  - 模拟保存失败情况
  - 验证事务回滚
  - 验证usage_count不变
  - 运行至少100次迭代

- [ ] 6.2 编写属性测试：使用计数准确性
  - **属性 9: 使用计数准确性**
  - **验证需求: 3.4**
  - 生成随机任务序列
  - 验证usage_count等于实际使用记录数
  - 运行至少100次迭代

- [ ] 7. 实现错误处理和部分失败逻辑
  - 实现单篇文章生成失败时继续处理下一篇
  - 实现任务部分完成的状态更新
  - 记录详细的错误信息
  - _需求: 6.1, 6.3, 6.4_

- [x] 7.1 实现部分失败处理
  - 捕获单篇文章生成错误
  - 记录错误但继续处理
  - 保存已成功生成的文章
  - _需求: 6.1, 6.3_

- [x] 7.2 实现任务状态更新
  - 根据实际生成数量更新任务状态
  - 如果部分成功，标记为completed
  - 如果全部失败，标记为failed
  - 记录实际生成数量
  - _需求: 6.4, 6.5_

- [ ] 7.3 编写属性测试：部分失败处理
  - **属性 13: 部分失败处理**
  - **验证需求: 6.1, 6.3**
  - 模拟部分文章生成失败
  - 验证已成功文章被保存
  - 运行至少100次迭代

- [ ] 7.4 编写属性测试：任务状态更新正确性
  - **属性 14: 任务状态更新正确性**
  - **验证需求: 6.4**
  - 生成随机成功/失败组合
  - 验证任务状态和生成数量正确
  - 运行至少100次迭代

- [ ] 8. 实现并发控制
  - 验证usage_count更新使用原子操作
  - 实现重试机制处理并发冲突
  - 记录并发冲突日志
  - _需求: 3.2, 3.5, 7.2, 7.3_

- [ ] 8.1 编写并发测试：并发更新正确性
  - **属性 15: 并发更新正确性**
  - **验证需求: 7.2**
  - 模拟多个任务并发执行
  - 验证最终usage_count准确
  - 运行至少100次迭代

- [ ] 9. 更新API接口
  - 修改任务创建API返回selectedDistillationIds
  - 修改任务详情API返回selectedDistillations
  - 修改任务列表API返回蒸馏结果摘要
  - 确保API响应数据结构一致
  - _需求: 8.1, 8.2, 8.4, 8.5, 13.1, 13.2, 13.3, 13.4_

- [x] 9.1 修改任务创建API响应
  - 在响应中添加selectedDistillationIds字段
  - 返回选择的ID列表
  - _需求: 13.1_

- [x] 9.2 修改任务详情API响应
  - 查询selected_distillation_ids对应的蒸馏结果
  - 返回selectedDistillations数组（包含id和keyword）
  - 按使用顺序排列
  - 处理已删除的蒸馏结果
  - _需求: 8.1, 8.2, 8.3, 13.2_

- [x] 9.3 修改任务列表API响应
  - 显示第一个蒸馏结果的关键词
  - 如果使用多个蒸馏结果，显示"使用了N个蒸馏结果"
  - _需求: 8.4, 8.5, 13.3_

- [ ] 9.4 编写属性测试：API响应完整性
  - **属性 21-24: API响应完整性**
  - **验证需求: 13.1, 13.2, 13.3, 13.4**
  - 验证所有API响应包含必需字段
  - 验证数据结构一致性
  - 运行至少100次迭代

- [ ] 9.5 编写属性测试：API错误响应正确性
  - **属性 25: API错误响应正确性**
  - **验证需求: 13.5**
  - 模拟各种错误情况
  - 验证错误响应格式和状态码
  - 运行至少100次迭代

- [ ] 10. 实现数据验证和修复工具
  - 实现验证工具比对usage_count与实际使用记录
  - 实现修复工具重新计算usage_count
  - 提供命令行接口
  - _需求: 10.1, 10.2, 10.3, 10.4_

- [ ] 10.1 实现验证工具
  - 查询所有蒸馏结果的usage_count
  - 查询实际使用记录数量
  - 比对并报告不一致
  - _需求: 10.1, 10.2_

- [ ] 10.2 实现修复工具
  - 重新计算所有蒸馏结果的usage_count
  - 更新不一致的记录
  - 返回修复详情
  - _需求: 10.3, 10.4_

- [ ] 10.3 编写属性测试：验证工具正确性
  - **属性 19: 验证工具正确性**
  - **验证需求: 10.1, 10.2**
  - 人为制造数据不一致
  - 验证工具能正确检测
  - 运行至少100次迭代

- [ ] 10.4 编写属性测试：修复工具正确性
  - **属性 20: 修复工具正确性**
  - **验证需求: 10.3, 10.4**
  - 人为制造数据不一致
  - 运行修复工具
  - 验证数据被正确修复
  - 运行至少100次迭代

- [x] 11. 添加日志和监控
  - 添加智能选择的日志
  - 添加蒸馏结果分配的日志
  - 添加usage_count更新的日志
  - 添加错误和警告日志
  - _需求: 12.1, 12.2, 12.3, 12.4_

- [ ] 12. 编写集成测试
  - 测试完整的任务创建-执行-完成流程
  - 测试并发场景
  - 测试错误恢复
  - 测试向后兼容性
  - 测试大规模场景
  - _需求: 14.1, 14.2, 14.3, 14.4_

- [ ] 12.1 编写完整流程集成测试
  - 创建任务 → 验证ID列表 → 执行任务 → 验证文章 → 验证usage_count
  - 验证每个步骤的数据正确性

- [ ] 12.2 编写并发场景集成测试
  - 多个任务同时创建和执行
  - 验证蒸馏结果选择正确性
  - 验证usage_count准确性

- [ ] 12.3 编写错误恢复集成测试
  - 模拟各种错误情况
  - 验证错误处理逻辑
  - 验证数据一致性

- [ ] 12.4 编写向后兼容性集成测试
  - 创建旧格式任务
  - 验证任务能正常执行
  - 验证数据迁移逻辑

- [ ] 13. Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 14. 更新文档
  - 更新API文档
  - 更新用户手册
  - 更新运维文档
  - 更新开发者文档
  - _需求: 15.1, 15.2, 15.3, 15.4_

- [ ] 15. 最终验证和部署
  - 运行所有测试
  - 验证数据迁移
  - 部署到测试环境
  - 进行端到端测试
  - 部署到生产环境
  - 监控错误日志
  - _需求: 14.5_
