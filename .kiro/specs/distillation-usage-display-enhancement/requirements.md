# 需求文档

## 简介

本功能旨在增强蒸馏结果的使用追踪和显示功能,确保用户能够清晰地看到每个蒸馏结果被文章生成功能引用的次数,并确保文章生成时能够均衡使用所有蒸馏结果。这是对现有文章生成、智能选择和使用追踪功能的前端展示增强。

核心目标:
1. 在蒸馏结果页面显示每条记录的"被引用次数"
2. 确保文章生成时均衡使用蒸馏结果(已有后端逻辑,需验证)
3. 保证数据修改时的同步性
4. 优先使用已有的数据库字段和API接口

## 术语表

- **系统 (System)**: 指整个文章生成和蒸馏结果管理应用
- **蒸馏结果 (Distillation Result)**: 通过关键词蒸馏生成的话题列表,每个蒸馏结果包含一个关键词和多个相关话题
- **被引用次数 (Usage Count)**: 某个蒸馏结果被用于文章生成的总次数,存储在distillations表的usage_count字段中
- **均衡使用 (Balanced Usage)**: 文章生成时优先选择使用次数最少的蒸馏结果,确保所有蒸馏结果被平均使用
- **蒸馏结果页面 (Distillation Results Page)**: 显示所有蒸馏历史记录的前端页面
- **数据同步 (Data Synchronization)**: 当蒸馏结果被修改或删除时,相关的使用统计数据保持一致性

## 需求

### 需求 1: 蒸馏结果列表显示增强

**用户故事:** 作为用户,我希望在蒸馏结果列表中看到每条记录的被引用次数,以便我了解哪些蒸馏结果被使用得更频繁。

#### 验收标准

1. WHEN 系统显示蒸馏结果列表 THEN 系统应当在列表中添加"被引用次数"列
2. WHEN 系统显示蒸馏结果列表 THEN 系统应当显示每个蒸馏结果的usage_count值
3. WHEN 蒸馏结果从未被使用 THEN 系统应当显示"0次"或"未使用"
4. WHEN 蒸馏结果被使用过 THEN 系统应当显示具体的使用次数(如"5次")
5. WHEN 用户点击被引用次数 THEN 系统应当显示该蒸馏结果的详细使用历史

### 需求 2: 蒸馏结果详情页增强

**用户故事:** 作为用户,我希望在蒸馏结果详情页看到详细的使用统计信息,以便我了解该蒸馏结果的使用情况。

#### 验收标准

1. WHEN 用户查看蒸馏结果详情 THEN 系统应当显示总被引用次数
2. WHEN 用户查看蒸馏结果详情 THEN 系统应当显示最近一次被使用的时间
3. WHEN 用户查看蒸馏结果详情 THEN 系统应当提供"查看使用历史"按钮
4. WHEN 用户点击"查看使用历史" THEN 系统应当显示所有使用该蒸馏结果生成的文章列表
5. WHEN 使用历史为空 THEN 系统应当显示"该蒸馏结果尚未被使用"

### 需求 3: 使用历史详情展示

**用户故事:** 作为用户,我希望能够查看某个蒸馏结果的详细使用历史,以便我了解它在哪些文章生成任务中被使用过。

#### 验收标准

1. WHEN 用户查看使用历史 THEN 系统应当显示任务ID、文章标题、生成时间
2. WHEN 系统显示使用历史 THEN 系统应当按生成时间降序排序(最新的在前)
3. WHEN 使用历史记录较多 THEN 系统应当支持分页显示(每页10条)
4. WHEN 关联的文章被删除 THEN 系统应当在历史记录中显示"文章已删除"
5. WHEN 用户点击文章标题 THEN 系统应当跳转到对应的文章详情页

### 需求 4: API接口验证和使用

**用户故事:** 作为开发者,我需要验证现有API接口是否已包含usage_count数据,如果没有则需要扩展API。

#### 验收标准

1. WHEN 前端请求蒸馏结果列表 THEN 系统应当返回包含usage_count字段的数据
2. WHEN 前端请求蒸馏结果详情 THEN 系统应当返回包含usage_count和最近使用时间的数据
3. WHEN 前端请求使用历史 THEN 系统应当返回分页的历史记录列表
4. WHEN API不存在 THEN 系统应当扩展现有API而非创建新API
5. WHEN API返回数据 THEN 系统应当确保数据结构的一致性

### 需求 5: 均衡使用验证

**用户故事:** 作为系统,我需要验证文章生成时是否正确实现了均衡使用逻辑,以便确保所有蒸馏结果被平均使用。

#### 验收标准

1. WHEN 系统创建文章生成任务 THEN 系统应当调用selectDistillationsForTask方法选择蒸馏结果
2. WHEN 系统选择蒸馏结果 THEN 系统应当按usage_count升序排序
3. WHEN 多个蒸馏结果的usage_count相同 THEN 系统应当按created_at升序排序
4. WHEN 系统生成文章 THEN 系统应当为每篇文章使用不同的蒸馏结果
5. WHEN 系统保存文章 THEN 系统应当在同一事务中更新对应蒸馏结果的usage_count

### 需求 6: 数据同步性保证

**用户故事:** 作为系统,我需要确保蒸馏结果被修改或删除时,相关的使用统计数据保持一致性。

#### 验收标准

1. WHEN 用户删除蒸馏结果 THEN 系统应当通过级联删除自动删除所有相关的使用记录
2. WHEN 用户删除文章 THEN 系统应当减少对应蒸馏结果的usage_count
3. WHEN 系统更新usage_count THEN 系统应当使用原子操作(SQL INCREMENT)
4. WHEN 系统检测到数据不一致 THEN 系统应当提供修复工具重新计算usage_count
5. WHEN 并发更新发生 THEN 系统应当使用数据库事务确保数据一致性

### 需求 7: 前端组件实现

**用户故事:** 作为开发者,我需要在前端实现显示被引用次数的组件,以便用户能够看到使用统计信息。

#### 验收标准

1. WHEN 系统渲染蒸馏结果列表 THEN 系统应当在表格中添加"被引用次数"列
2. WHEN 系统显示被引用次数 THEN 系统应当使用Badge或Tag组件突出显示
3. WHEN 被引用次数为0 THEN 系统应当使用灰色或默认样式
4. WHEN 被引用次数大于0 THEN 系统应当使用蓝色或成功样式
5. WHEN 用户悬停在被引用次数上 THEN 系统应当显示提示信息"点击查看使用历史"

### 需求 8: 使用历史弹窗

**用户故事:** 作为用户,我希望能够通过弹窗查看蒸馏结果的使用历史,而不需要跳转到新页面。

#### 验收标准

1. WHEN 用户点击被引用次数或"查看使用历史"按钮 THEN 系统应当打开使用历史弹窗
2. WHEN 使用历史弹窗打开 THEN 系统应当显示蒸馏结果的关键词和总使用次数
3. WHEN 使用历史弹窗显示记录 THEN 系统应当以表格形式展示任务ID、文章标题、生成时间
4. WHEN 使用历史为空 THEN 系统应当显示空状态提示
5. WHEN 用户关闭弹窗 THEN 系统应当返回到蒸馏结果列表页面

### 需求 9: 排序和筛选功能

**用户故事:** 作为用户,我希望能够按被引用次数对蒸馏结果进行排序和筛选,以便快速找到使用频率高或低的蒸馏结果。

#### 验收标准

1. WHEN 用户点击"被引用次数"列标题 THEN 系统应当支持升序和降序排序
2. WHEN 系统排序蒸馏结果 THEN 系统应当在前端或后端执行排序逻辑
3. WHEN 用户选择筛选条件"未使用" THEN 系统应当只显示usage_count为0的蒸馏结果
4. WHEN 用户选择筛选条件"已使用" THEN 系统应当只显示usage_count大于0的蒸馏结果
5. WHEN 用户清除筛选条件 THEN 系统应当显示所有蒸馏结果

### 需求 10: 性能优化

**用户故事:** 作为系统,我需要优化蒸馏结果列表的加载性能,以便在大量数据的情况下仍能快速响应。

#### 验收标准

1. WHEN 系统查询蒸馏结果列表 THEN 系统应当使用索引优化查询性能
2. WHEN 系统加载使用历史 THEN 系统应当支持分页加载
3. WHEN 系统计算usage_count THEN 系统应当使用数据库聚合函数而非应用层计算
4. WHEN 系统显示大量蒸馏结果 THEN 系统应当使用虚拟滚动或分页展示
5. WHEN 系统更新usage_count THEN 系统应当使用单条UPDATE语句而非读-修改-写

### 需求 11: 错误处理

**用户故事:** 作为系统,我需要正确处理查询使用统计信息时的错误,以便在异常情况下仍能提供友好的用户体验。

#### 验收标准

1. WHEN API请求失败 THEN 系统应当显示错误提示信息
2. WHEN 蒸馏结果不存在 THEN 系统应当返回404错误并提示用户
3. WHEN 使用历史查询失败 THEN 系统应当显示"加载失败,请重试"
4. WHEN 网络超时 THEN 系统应当提供重试按钮
5. WHEN 数据格式错误 THEN 系统应当记录错误日志并显示默认值

### 需求 12: 移动端适配

**用户故事:** 作为移动端用户,我希望能够在手机上查看蒸馏结果的使用统计信息,以便随时随地了解使用情况。

#### 验收标准

1. WHEN 用户在移动端访问蒸馏结果列表 THEN 系统应当使用响应式布局
2. WHEN 屏幕宽度小于768px THEN 系统应当隐藏次要列,保留关键词和被引用次数
3. WHEN 用户在移动端点击被引用次数 THEN 系统应当打开全屏使用历史页面
4. WHEN 使用历史在移动端显示 THEN 系统应当使用卡片布局而非表格
5. WHEN 用户在移动端操作 THEN 系统应当确保所有交互元素足够大(最小44x44px)

### 需求 13: 数据导出功能

**用户故事:** 作为管理员,我希望能够导出蒸馏结果的使用统计数据,以便进行数据分析和报告。

#### 验收标准

1. WHEN 管理员点击"导出"按钮 THEN 系统应当生成包含所有蒸馏结果和使用统计的CSV文件
2. WHEN 系统导出数据 THEN 系统应当包含关键词、话题数量、被引用次数、创建时间、最近使用时间
3. WHEN 导出文件生成 THEN 系统应当自动下载文件到用户设备
4. WHEN 导出数据量较大 THEN 系统应当显示进度提示
5. WHEN 导出失败 THEN 系统应当显示错误信息并提供重试选项

### 需求 14: 实时更新

**用户故事:** 作为用户,我希望在文章生成完成后,蒸馏结果列表中的被引用次数能够自动更新,而不需要手动刷新页面。

#### 验收标准

1. WHEN 文章生成任务完成 THEN 系统应当触发蒸馏结果列表的数据刷新
2. WHEN 系统刷新数据 THEN 系统应当只更新被引用次数列,不重新加载整个列表
3. WHEN 用户正在查看使用历史弹窗 THEN 系统应当自动更新弹窗中的数据
4. WHEN 多个用户同时使用系统 THEN 系统应当确保每个用户看到最新的使用统计
5. WHEN 系统更新失败 THEN 系统应当静默失败,不影响用户当前操作

### 需求 15: 测试和验证

**用户故事:** 作为开发者,我需要全面的测试来验证使用统计功能的正确性,以便确保功能按预期工作。

#### 验收标准

1. WHEN 运行单元测试 THEN 系统应当验证usage_count的计算逻辑
2. WHEN 运行集成测试 THEN 系统应当验证文章生成后usage_count的更新
3. WHEN 运行UI测试 THEN 系统应当验证前端组件的正确渲染
4. WHEN 运行并发测试 THEN 系统应当验证多任务并发时usage_count的准确性
5. WHEN 所有测试通过 THEN 系统应当确保没有回归问题
