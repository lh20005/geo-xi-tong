# 实现计划

- [x] 1. 验证和准备数据库
- [x] 1.1 验证distillations表的usage_count字段存在
  - 检查数据库schema
  - 验证字段类型和默认值
  - _需求: 4.1_

- [x] 1.2 验证distillation_usage表存在
  - 检查表结构
  - 验证外键约束
  - _需求: 6.1_

- [x] 1.3 创建必要的数据库索引
  - 创建usage_count和created_at的复合索引
  - 创建distillation_id索引
  - 创建used_at索引
  - _需求: 10.1_

- [x] 1.4 编写数据库索引验证脚本
  - 验证所有索引已创建
  - 测试查询性能
  - _需求: 10.1_

- [x] 2. 扩展后端API接口
- [x] 2.1 扩展蒸馏结果列表API
  - 在现有GET /api/distillation/history接口中添加usage_count字段
  - 添加sortBy, sortOrder, filterUsage查询参数支持
  - 使用JOIN查询获取usage_count和lastUsedAt
  - 实现排序逻辑(usage_count, created_at)
  - 实现筛选逻辑(all, used, unused)
  - _需求: 4.1, 9.1, 9.3, 9.4_

- [x] 2.2 编写属性测试验证API响应结构
  - **Property 8: API响应结构一致性**
  - **验证: 需求 4.1**
  - 生成随机查询参数,验证响应包含usage_count
  - 验证响应schema一致性

- [x] 2.3 扩展蒸馏结果详情API
  - 在现有GET /api/distillation/history/:id接口中添加usage_count和lastUsedAt字段
  - 使用子查询获取最近使用时间
  - _需求: 4.2, 2.1, 2.2_

- [x] 2.4 编写属性测试验证详情页数据完整性
  - **Property 3: 详情页数据完整性**
  - **验证: 需求 2.1, 2.2**
  - 生成随机蒸馏结果ID,验证响应包含usage_count和lastUsedAt

- [x] 2.5 创建使用历史查询API
  - 实现GET /api/distillation/history/:id/usage接口
  - 支持分页参数(page, pageSize)
  - JOIN查询distillation_usage和articles表
  - 处理文章已删除的情况
  - 按used_at降序排序
  - _需求: 4.3, 3.1, 3.2, 3.4_

- [x] 2.6 编写属性测试验证使用历史查询
  - **Property 4: 使用历史查询完整性**
  - **验证: 需求 2.4, 3.1**
  - 生成随机蒸馏结果和使用记录,验证查询返回所有相关记录
  - **Property 5: 使用历史排序正确性**
  - **验证: 需求 3.2**
  - 验证记录按used_at降序排列

- [x] 2.7 编写属性测试验证分页逻辑
  - **Property 6: 分页逻辑正确性**
  - **验证: 需求 3.3**
  - 生成随机数量的使用记录,验证分页正确工作

- [x] 2.8 创建修复使用计数API
  - 实现POST /api/distillation/fix-usage-count接口
  - 支持单个或全部蒸馏结果修复
  - 重新计算usage_count(COUNT查询distillation_usage)
  - 返回修复详情(oldCount, newCount, actualCount)
  - _需求: 6.4_

- [x] 2.9 编写属性测试验证修复工具
  - **Property 14: 修复工具正确性**
  - **验证: 需求 6.4**
  - 生成随机的不一致数据,运行修复,验证usage_count正确

- [x] 3. 扩展后端服务层
- [x] 3.1 扩展DistillationService的getDistillations方法
  - 添加sortBy, sortOrder, filterUsage参数
  - 实现动态SQL构建
  - 添加usage_count和lastUsedAt字段查询
  - _需求: 4.1, 9.1_

- [x] 3.2 扩展DistillationService的getDistillationDetail方法
  - 添加usage_count和lastUsedAt字段查询
  - 使用子查询获取最近使用时间
  - _需求: 4.2_

- [x] 3.3 实现DistillationService的getUsageHistory方法
  - 实现分页查询逻辑
  - JOIN查询distillation_usage和articles表
  - 处理文章已删除的情况
  - 返回完整的使用历史数据
  - _需求: 4.3, 3.1_

- [x] 3.4 实现DistillationService的fixUsageCount方法
  - 查询实际使用记录数(COUNT)
  - 比对当前usage_count
  - 更新不一致的记录
  - 返回修复详情
  - _需求: 6.4_

- [x] 3.5 实现DistillationService的decrementUsageCount方法
  - 使用原子操作(SQL DECREMENT)
  - 在删除文章时调用
  - 确保usage_count不小于0
  - _需求: 6.2_

- [x] 3.6 编写属性测试验证删除文章后的数据一致性
  - **Property 7: 删除文章后的数据一致性**
  - **验证: 需求 6.2**
  - 生成随机文章,删除后验证usage_count减1

- [x] 4. 验证文章生成服务的均衡使用逻辑
- [x] 4.1 验证selectDistillationsForTask方法存在
  - 检查ArticleGenerationService中的方法
  - 验证按usage_count升序排序逻辑
  - _需求: 5.1, 5.2_

- [x] 4.2 编写属性测试验证均衡选择算法
  - **Property 9: 均衡选择算法正确性**
  - **验证: 需求 5.2**
  - 生成随机蒸馏结果集合,验证选择的是usage_count最小的N个
  - **Property 10: 次要排序条件正确性**
  - **验证: 需求 5.3**
  - 验证usage_count相同时按created_at升序排序

- [x] 4.3 验证executeTask方法中的usage_count更新
  - 检查saveArticleWithUsageTracking方法
  - 验证在同一事务中更新usage_count
  - _需求: 5.5_

- [x] 4.4 编写属性测试验证事务原子性
  - **Property 12: 事务原子性**
  - **验证: 需求 5.5**
  - 模拟保存失败,验证usage_count未更新

- [x] 4.5 编写属性测试验证文章生成数据唯一性
  - **Property 11: 文章生成数据唯一性**
  - **验证: 需求 5.4**
  - 生成随机任务,验证每篇文章使用不同的蒸馏结果ID

- [x] 5. 验证数据库级联删除
- [x] 5.1 验证distillation_usage表的外键约束
  - 检查ON DELETE CASCADE约束
  - 测试删除蒸馏结果时的级联删除
  - _需求: 6.1_

- [x] 5.2 编写属性测试验证级联删除
  - **Property 13: 级联删除正确性**
  - **验证: 需求 6.1**
  - 生成随机蒸馏结果和使用记录,删除后验证记录被删除

- [x] 5.3 在文章删除API中添加usage_count更新
  - 在DELETE /api/articles/:id中调用decrementUsageCount
  - 使用事务确保原子性
  - _需求: 6.2_

- [x] 6. 创建前端组件 - UsageCountBadge
- [x] 6.1 创建UsageCountBadge组件
  - 接收count和onClick props
  - count为0时显示灰色Badge
  - count大于0时显示蓝色Badge
  - 格式化显示"N次"
  - 支持点击事件
  - _需求: 1.2, 1.4, 7.2, 7.4_

- [x] 6.2 编写属性测试验证使用次数格式化
  - **Property 2: 使用次数格式化**
  - **验证: 需求 1.4**
  - 生成随机正整数,验证显示为"N次"格式

- [x] 6.3 编写单元测试验证Badge样式
  - 测试count=0时的灰色样式
  - 测试count>0时的蓝色样式
  - 测试点击事件触发
  - _需求: 7.3, 7.4_

- [x] 7. 创建前端组件 - UsageHistoryModal
- [x] 7.1 创建UsageHistoryModal组件基础结构
  - 创建Modal组件
  - 接收visible, distillationId, onClose props
  - 实现打开和关闭逻辑
  - _需求: 8.1, 8.5_

- [x] 7.2 实现使用历史数据加载
  - 调用GET /api/distillation/history/:id/usage API
  - 处理loading状态
  - 处理错误状态
  - 显示蒸馏结果关键词和总使用次数
  - _需求: 8.2_

- [x] 7.3 实现使用历史列表展示
  - 使用Table组件显示任务ID、文章标题、生成时间
  - 处理文章已删除的情况
  - 实现文章标题点击跳转
  - _需求: 3.1, 3.4, 3.5, 8.3_

- [x] 7.4 实现分页功能
  - 添加Pagination组件
  - 处理页码变化
  - 每页显示10条记录
  - _需求: 3.3_

- [x] 7.5 实现空状态显示
  - 当使用历史为空时显示Empty组件
  - 显示"该蒸馏结果尚未被使用"提示
  - _需求: 2.5, 8.4_

- [x] 7.6 编写单元测试验证UsageHistoryModal
  - 测试数据加载和显示
  - 测试分页功能
  - 测试空状态显示
  - 测试错误处理
  - _需求: 2.4, 3.1, 3.3_

- [x] 8. 增强前端页面 - DistillationResultsPage
- [x] 8.1 在蒸馏结果列表中添加"被引用次数"列
  - 在Table columns中添加新列
  - 使用UsageCountBadge组件显示
  - 添加点击事件打开使用历史弹窗
  - _需求: 1.1, 1.2, 1.5_

- [x] 8.2 编写属性测试验证列表显示完整性
  - **Property 1: 列表显示完整性**
  - **验证: 需求 1.1, 1.2**
  - 生成随机蒸馏结果数据,验证列表包含usage_count列

- [x] 8.3 添加排序功能
  - 在"被引用次数"列添加sorter配置
  - 实现前端或后端排序
  - 支持升序和降序
  - _需求: 9.1_

- [x] 8.4 编写属性测试验证排序功能
  - **Property 17: 排序功能正确性**
  - **验证: 需求 9.1**
  - 生成随机数据集,验证排序正确改变顺序

- [x] 8.5 添加筛选功能
  - 添加筛选下拉框(全部/已使用/未使用)
  - 实现筛选逻辑
  - 更新API调用参数
  - _需求: 9.3, 9.4, 9.5_

- [x] 8.6 编写属性测试验证筛选逻辑
  - **Property 16: 筛选逻辑正确性**
  - **验证: 需求 9.3**
  - 生成随机数据集,验证筛选"未使用"只返回usage_count=0的记录

- [x] 8.7 集成UsageHistoryModal组件
  - 添加modal state管理
  - 实现打开和关闭逻辑
  - 传递正确的props
  - _需求: 1.5, 8.1_

- [x] 8.8 添加悬停提示
  - 在UsageCountBadge上添加Tooltip
  - 显示"点击查看使用历史"提示
  - _需求: 7.5_

- [ ] 9. 实现错误处理
- [ ] 9.1 添加API请求错误处理
  - 使用try-catch捕获错误
  - 显示Toast错误提示
  - 提供重试按钮
  - _需求: 11.1_

- [ ] 9.2 编写属性测试验证错误处理
  - **Property 18: 错误处理完整性**
  - **验证: 需求 11.1**
  - 模拟API错误,验证显示错误提示

- [ ] 9.3 添加资源不存在错误处理
  - 处理404错误
  - 显示"蒸馏结果不存在"提示
  - _需求: 11.2_

- [ ] 9.4 添加网络超时处理
  - 设置30秒超时
  - 显示超时提示
  - 提供重试按钮
  - _需求: 11.4_

- [ ] 9.5 添加数据格式错误处理
  - 验证API响应格式
  - 使用默认值(usage_count=0)
  - 记录错误日志
  - _需求: 11.5_

- [ ] 10. 实现响应式设计
- [ ] 10.1 添加响应式布局
  - 使用Ant Design的Grid系统
  - 定义不同屏幕尺寸的断点
  - _需求: 12.1_

- [ ] 10.2 编写属性测试验证响应式布局
  - **Property 19: 响应式布局正确性**
  - **验证: 需求 12.1**
  - 模拟不同屏幕尺寸,验证布局适配

- [ ] 10.3 实现移动端列隐藏
  - 在屏幕宽度<768px时隐藏次要列
  - 保留关键词和被引用次数列
  - _需求: 12.2_

- [ ] 10.4 实现移动端使用历史全屏显示
  - 在移动端使用全屏Modal
  - 使用卡片布局替代表格
  - _需求: 12.3, 12.4_

- [ ] 10.5 确保移动端交互元素大小
  - 设置最小点击区域44x44px
  - 调整按钮和Badge大小
  - _需求: 12.5_

- [ ] 11. 实现数据导出功能
- [ ] 11.1 创建导出API
  - 实现GET /api/distillation/export接口
  - 查询所有蒸馏结果和使用统计
  - 生成CSV格式数据
  - _需求: 13.1_

- [ ] 11.2 实现CSV数据生成
  - 包含关键词、话题数量、被引用次数、创建时间、最近使用时间
  - 使用正确的CSV格式(逗号分隔,引号转义)
  - _需求: 13.2_

- [ ] 11.3 编写属性测试验证导出数据完整性
  - **Property 20: 导出数据完整性**
  - **验证: 需求 13.1, 13.2**
  - 生成随机数据集,验证CSV包含所有必需字段

- [ ] 11.4 添加前端导出按钮
  - 在蒸馏结果页面添加"导出"按钮
  - 调用导出API
  - 触发文件下载
  - _需求: 13.3_

- [ ] 11.5 添加导出进度提示
  - 显示Loading状态
  - 数据量大时显示进度条
  - _需求: 13.4_

- [ ] 11.6 添加导出错误处理
  - 捕获导出失败
  - 显示错误信息
  - 提供重试选项
  - _需求: 13.5_

- [ ] 12. 实现实时更新功能
- [ ] 12.1 添加文章生成完成事件监听
  - 在ArticleGenerationPage中监听任务完成
  - 触发蒸馏结果列表刷新
  - _需求: 14.1_

- [ ] 12.2 编写属性测试验证实时更新
  - **Property 21: 实时更新正确性**
  - **验证: 需求 14.1**
  - 模拟文章生成完成,验证usage_count自动更新

- [ ] 12.3 实现局部数据更新
  - 只更新usage_count字段
  - 不重新加载整个列表
  - 使用setState局部更新
  - _需求: 14.2_

- [ ] 12.4 编写属性测试验证局部更新
  - **Property 22: 局部更新正确性**
  - **验证: 需求 14.2**
  - 验证只更新usage_count,不重新加载列表

- [ ] 12.5 实现使用历史弹窗自动更新
  - 当弹窗打开时监听数据变化
  - 自动刷新使用历史数据
  - _需求: 14.3_

- [ ] 12.6 添加更新失败静默处理
  - 捕获更新错误
  - 静默失败,不影响用户操作
  - 记录错误日志
  - _需求: 14.5_

- [x] 13. 实现并发安全性
- [x] 13.1 验证usage_count更新使用原子操作
  - 检查SQL使用INCREMENT而非读-修改-写
  - 验证在事务中执行
  - _需求: 6.3, 6.5_

- [x] 13.2 编写并发测试验证数据一致性
  - **Property 15: 并发安全性**
  - **验证: 需求 6.5**
  - 模拟多个并发文章生成,验证最终usage_count正确

- [x] 13.3 添加数据库事务隔离级别配置
  - 设置适当的隔离级别(READ COMMITTED)
  - 处理死锁和冲突
  - _需求: 6.5_

- [ ] 14. 创建管理员修复工具界面
- [ ] 14.1 创建修复工具页面或弹窗
  - 添加"修复使用计数"按钮(仅管理员可见)
  - 显示修复前的数据统计
  - _需求: 6.4_

- [ ] 14.2 实现修复功能调用
  - 调用POST /api/distillation/fix-usage-count API
  - 显示修复进度
  - 显示修复结果详情
  - _需求: 6.4_

- [ ] 14.3 添加修复确认对话框
  - 显示将要修复的记录数
  - 要求用户确认
  - 防止误操作
  - _需求: 6.4_

- [ ] 15. 编写集成测试
- [ ] 15.1 编写端到端测试 - 查看使用历史流程
  - 测试从列表点击到查看使用历史的完整流程
  - 验证数据正确显示
  - _需求: 1.5, 2.4, 3.1_

- [ ] 15.2 编写集成测试 - 文章生成后usage_count更新
  - 创建文章生成任务
  - 验证任务完成后usage_count增加
  - 验证使用历史中有新记录
  - _需求: 5.5, 14.1_

- [ ] 15.3 编写集成测试 - 删除文章后usage_count更新
  - 创建文章
  - 删除文章
  - 验证usage_count减少
  - _需求: 6.2_

- [ ] 15.4 编写集成测试 - 修复工具
  - 创建不一致的数据
  - 运行修复工具
  - 验证usage_count正确
  - _需求: 6.4_

- [ ] 16. 性能优化和测试
- [ ] 16.1 验证数据库查询性能
  - 使用EXPLAIN分析查询计划
  - 确认索引被正确使用
  - 优化慢查询
  - _需求: 10.1_

- [ ] 16.2 实现前端虚拟滚动(可选)
  - 当列表数据量大时使用虚拟滚动
  - 提升渲染性能
  - _需求: 10.4_

- [ ] 16.3 添加防抖和节流
  - 搜索输入防抖(300ms)
  - 筛选操作节流
  - 减少API调用频率
  - _需求: 10.1_

- [ ] 17. 文档和部署
- [ ] 17.1 更新API文档
  - 记录扩展的API接口
  - 添加请求和响应示例
  - 说明新增的查询参数
  - _需求: 4.1, 4.2, 4.3_

- [ ] 17.2 编写用户使用指南
  - 说明如何查看被引用次数
  - 说明如何查看使用历史
  - 说明排序和筛选功能
  - _需求: 1.1, 2.4, 9.1_

- [ ] 17.3 编写管理员运维文档
  - 说明如何使用修复工具
  - 说明如何监控数据一致性
  - 提供故障排查指南
  - _需求: 6.4_

- [ ] 17.4 运行数据库迁移
  - 验证usage_count字段存在
  - 创建必要的索引
  - 运行修复工具初始化usage_count
  - _需求: 1.1, 6.4_

- [ ] 17.5 部署前端更新
  - 构建生产版本
  - 测试响应式布局
  - 验证移动端体验
  - _需求: 12.1_

- [ ] 18. 最终验证和测试
- [ ] 18.1 运行所有单元测试
  - 确保所有测试通过
  - 验证代码覆盖率
  - _需求: 15.1_

- [ ] 18.2 运行所有属性测试
  - 确保所有属性测试通过(100次迭代)
  - 验证正确性属性
  - _需求: 15.2_

- [ ] 18.3 运行所有集成测试
  - 测试完整的用户流程
  - 验证数据一致性
  - _需求: 15.3_

- [ ] 18.4 进行手动测试
  - 测试所有UI交互
  - 测试不同屏幕尺寸
  - 测试错误场景
  - _需求: 15.4_

- [ ] 18.5 性能测试
  - 测试大数据量下的性能
  - 验证查询响应时间
  - 测试并发场景
  - _需求: 10.1, 15.5_

- [ ] 19. Checkpoint - 确保所有测试通过
  - 确保所有测试通过,如有问题请询问用户
