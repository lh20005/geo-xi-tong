# 需求文档

## 简介

本功能旨在解决文章生成模块中的两个核心问题：
1. 修复文章生成任务列表中"蒸馏结果"列显示错误的问题（当前显示的是大模型提供商，应该显示蒸馏结果的关键词内容）
2. 实现蒸馏结果的使用次数追踪和智能循环使用机制，确保所有蒸馏结果被平均使用，避免重复使用同一个蒸馏结果生成文章

## 术语表

- **系统 (System)**: 指整个文章生成和蒸馏结果管理应用
- **蒸馏结果 (Distillation Result)**: 通过关键词蒸馏生成的话题列表，每个蒸馏结果包含一个关键词和多个相关话题
- **文章生成任务 (Generation Task)**: 用户创建的批量文章生成任务，每个任务使用一个蒸馏结果生成多篇文章
- **使用次数 (Usage Count)**: 某个蒸馏结果被用于文章生成的总次数
- **使用记录 (Usage Record)**: 记录某个蒸馏结果在某次文章生成中被使用的详细信息
- **智能选择 (Smart Selection)**: 根据使用次数自动选择使用次数最少的蒸馏结果的算法
- **循环使用 (Circular Usage)**: 确保所有蒸馏结果被平均使用，当所有结果使用次数相同时，从最早创建的开始重新使用

## 需求

### 需求 1：显示错误修复

**用户故事：** 作为用户，我希望在文章生成任务列表中看到正确的蒸馏结果信息，以便我能清楚地知道每个任务使用了哪个关键词的蒸馏结果。

#### 验收标准

1. WHEN 系统显示文章生成任务列表 THEN 系统应当在"蒸馏结果"列中显示该任务使用的蒸馏结果的关键词
2. WHEN 系统显示文章生成任务详情 THEN 系统应当显示蒸馏结果的关键词而非大模型提供商名称
3. WHEN 蒸馏结果被删除后 THEN 系统应当在任务列表中显示"已删除"或类似的提示信息
4. WHEN 系统查询任务列表 THEN 系统应当通过JOIN查询获取关联的蒸馏结果关键词
5. WHEN 前端接收任务数据 THEN 系统应当包含keyword字段用于显示蒸馏结果

### 需求 2：数据库架构扩展

**用户故事：** 作为系统管理员，我希望数据库能够存储蒸馏结果的使用统计信息，以便系统能够追踪和管理蒸馏结果的使用情况。

#### 验收标准

1. WHEN 系统创建新的蒸馏结果 THEN 系统应当初始化usage_count字段为0
2. WHEN 系统查询蒸馏结果 THEN 系统应当返回包含usage_count字段的完整数据
3. WHEN 系统需要按使用次数排序 THEN 系统应当使用索引优化查询性能
4. WHEN 系统创建使用记录 THEN 系统应当在distillation_usage表中插入新记录
5. WHEN 系统删除文章 THEN 系统应当通过级联删除自动删除相关的使用记录
6. WHEN 系统删除蒸馏结果 THEN 系统应当通过级联删除自动删除所有相关的使用记录

### 需求 3：使用记录创建和追踪

**用户故事：** 作为系统，我需要在每次文章生成时记录蒸馏结果的使用情况，以便准确追踪每个蒸馏结果的使用历史。

#### 验收标准

1. WHEN 系统保存新生成的文章 THEN 系统应当在distillation_usage表中创建一条使用记录
2. WHEN 系统创建使用记录 THEN 系统应当记录distillation_id、task_id、article_id和使用时间
3. WHEN 系统创建使用记录 THEN 系统应当确保每篇文章只有一条使用记录（通过唯一约束）
4. WHEN 系统保存文章和创建使用记录 THEN 系统应当在同一个数据库事务中执行这两个操作
5. WHEN 文章保存失败 THEN 系统应当回滚使用记录的创建

### 需求 4：前端蒸馏结果列表增强

**用户故事：** 作为用户，我希望在蒸馏结果列表中看到每个结果的使用次数和使用历史，以便我了解哪些蒸馏结果被使用得更频繁。

#### 验收标准

1. WHEN 系统显示蒸馏结果列表 THEN 系统应当在列表中添加"使用次数"列
2. WHEN 系统显示蒸馏结果列表 THEN 系统应当按使用次数升序排序（使用次数少的排在前面）
3. WHEN 用户点击"查看使用历史"按钮 THEN 系统应当显示该蒸馏结果的详细使用历史
4. WHEN 系统显示使用历史 THEN 系统应当包含任务ID、文章标题、使用时间等信息
5. WHEN 系统显示使用历史 THEN 系统应当支持分页显示

### 需求 5：使用历史查询

**用户故事：** 作为用户，我希望能够查看某个蒸馏结果的详细使用历史，以便我了解它在哪些文章生成任务中被使用过。

#### 验收标准

1. WHEN 用户请求查看使用历史 THEN 系统应当返回该蒸馏结果的所有使用记录
2. WHEN 系统返回使用历史 THEN 系统应当包含任务ID、文章ID、文章标题和使用时间
3. WHEN 系统返回使用历史 THEN 系统应当按使用时间降序排序（最新的在前）
4. WHEN 使用历史记录较多 THEN 系统应当支持分页查询
5. WHEN 关联的文章被删除 THEN 系统应当在历史记录中显示"文章已删除"

### 需求 6：前端任务配置页面增强

**用户故事：** 作为用户，我希望在创建文章生成任务时能够看到蒸馏结果的使用次数和推荐信息，以便我选择合适的蒸馏结果。

#### 验收标准

1. WHEN 系统显示蒸馏结果选择下拉列表 THEN 系统应当显示每个蒸馏结果的使用次数
2. WHEN 系统显示蒸馏结果选择下拉列表 THEN 系统应当按使用次数升序排序
3. WHEN 系统显示蒸馏结果选择下拉列表 THEN 系统应当为使用次数最少的前3个结果添加"推荐"标记
4. WHEN 用户悬停在推荐标记上 THEN 系统应当显示推荐原因的提示信息
5. WHEN 蒸馏结果没有可用话题 THEN 系统应当在下拉列表中禁用该选项并显示提示

### 需求 7：智能选择算法

**用户故事：** 作为系统，我需要在文章生成时自动选择使用次数最少的蒸馏结果，以便实现蒸馏结果的平均使用。

#### 验收标准

1. WHEN 系统选择蒸馏结果 THEN 系统应当优先选择usage_count最小的蒸馏结果
2. WHEN 多个蒸馏结果的usage_count相同 THEN 系统应当选择创建时间最早的蒸馏结果
3. WHEN 蒸馏结果没有可用话题 THEN 系统应当跳过该蒸馏结果
4. WHEN 所有蒸馏结果都被使用过 THEN 系统应当从使用次数最少的开始重新循环使用
5. WHEN 可用蒸馏结果数量少于请求数量 THEN 系统应当返回所有可用的蒸馏结果

### 需求 8：批量文章生成中的智能分配

**用户故事：** 作为用户，我希望在一个任务中生成多篇文章时，系统能够智能地分配蒸馏结果，确保使用次数的平衡。

#### 验收标准

1. WHEN 用户创建生成N篇文章的任务 THEN 系统应当选择使用次数最少的N个蒸馏结果
2. WHEN 系统为任务选择多个蒸馏结果 THEN 系统应当按usage_count升序排序后依次选择
3. WHEN 可用蒸馏结果少于请求数量 THEN 系统应当抛出错误并提示用户
4. WHEN 系统生成每篇文章 THEN 系统应当立即更新对应蒸馏结果的usage_count
5. WHEN 系统在同一任务中选择蒸馏结果 THEN 系统应当确保不重复选择同一个蒸馏结果

### 需求 9：数据一致性保证

**用户故事：** 作为系统管理员，我希望系统能够保证使用次数和使用记录的数据一致性，即使在并发或异常情况下。

#### 验收标准

1. WHEN 系统保存文章和更新使用次数 THEN 系统应当在同一个数据库事务中执行
2. WHEN 任何操作失败 THEN 系统应当回滚整个事务确保数据一致性
3. WHEN 用户删除文章 THEN 系统应当同时删除使用记录并减少对应蒸馏结果的usage_count
4. WHEN 系统更新usage_count THEN 系统应当使用原子操作（如SQL的INCREMENT）
5. WHEN 系统检测到数据不一致 THEN 系统应当提供修复工具重新计算usage_count

### 需求 10：前端任务详情显示

**用户故事：** 作为用户，我希望在任务详情和列表中看到正确的蒸馏结果信息，以便我了解任务的配置。

#### 验收标准

1. WHEN 系统显示任务详情 THEN 系统应当显示蒸馏结果的关键词
2. WHEN 系统显示任务列表 THEN 系统应当在"蒸馏结果"列显示关键词而非提供商
3. WHEN 蒸馏结果被删除 THEN 系统应当显示"已删除"或"-"
4. WHEN 系统显示任务详情 THEN 系统应当显示该蒸馏结果的当前使用次数
5. WHEN 用户查看任务 THEN 系统应当提供链接跳转到对应的蒸馏结果详情页

### 需求 11：推荐功能

**用户故事：** 作为用户，我希望系统能够推荐使用次数较少的蒸馏结果，以便我做出更好的选择。

#### 验收标准

1. WHEN 系统提供推荐 THEN 系统应当返回使用次数最少的前3个蒸馏结果
2. WHEN 多个蒸馏结果使用次数相同 THEN 系统应当优先推荐创建时间较早的
3. WHEN 推荐的蒸馏结果没有可用话题 THEN 系统应当跳过该结果
4. WHEN 系统显示推荐结果 THEN 系统应当包含关键词、使用次数、话题数量等信息
5. WHEN 用户请求推荐 THEN 系统应当实时计算并返回最新的推荐结果

### 需求 12：API接口设计

**用户故事：** 作为前端开发者，我需要清晰的API接口来获取蒸馏结果的使用统计和历史信息。

#### 验收标准

1. WHEN 前端请求蒸馏结果列表 THEN 系统应当返回包含usage_count的完整数据
2. WHEN 前端请求使用历史 THEN 系统应当返回分页的历史记录列表
3. WHEN 前端请求推荐结果 THEN 系统应当返回使用次数最少的蒸馏结果列表
4. WHEN API返回数据 THEN 系统应当确保数据结构的一致性和完整性
5. WHEN API发生错误 THEN 系统应当返回清晰的错误信息和HTTP状态码

### 需求 13：数据迁移

**用户故事：** 作为系统管理员，我需要安全地迁移现有数据到新的数据库架构，确保不丢失任何数据。

#### 验收标准

1. WHEN 系统执行数据库迁移 THEN 系统应当为distillations表添加usage_count字段
2. WHEN 系统执行数据库迁移 THEN 系统应当创建distillation_usage表
3. WHEN 系统执行数据库迁移 THEN 系统应当创建必要的索引
4. WHEN 系统迁移现有数据 THEN 系统应当为所有现有蒸馏结果初始化usage_count为0
5. WHEN 系统迁移现有数据 THEN 系统应当根据现有文章记录重新计算usage_count

### 需求 14：管理功能

**用户故事：** 作为系统管理员，我希望能够重置或修复蒸馏结果的使用统计，以便在数据异常时进行维护。

#### 验收标准

1. WHEN 管理员重置单个蒸馏结果 THEN 系统应当将其usage_count设为0并删除所有使用记录
2. WHEN 管理员重置所有蒸馏结果 THEN 系统应当将所有usage_count设为0并清空使用记录表
3. WHEN 管理员执行修复操作 THEN 系统应当重新计算每个蒸馏结果的usage_count
4. WHEN 系统修复数据 THEN 系统应当比对usage_count与实际使用记录数量
5. WHEN 系统发现不一致 THEN 系统应当更新usage_count为正确的值并记录修复日志

### 需求 15：并发控制

**用户故事：** 作为系统，我需要在多个任务并发执行时正确处理蒸馏结果的选择和使用次数更新，避免数据竞争。

#### 验收标准

1. WHEN 多个任务同时选择蒸馏结果 THEN 系统应当使用数据库锁确保选择的正确性
2. WHEN 多个任务同时更新同一蒸馏结果的usage_count THEN 系统应当使用原子操作确保计数准确
3. WHEN 并发更新发生冲突 THEN 系统应当重试操作（最多3次）
4. WHEN 重试失败 THEN 系统应当记录错误日志并通知管理员
5. WHEN 系统选择蒸馏结果 THEN 系统应当在事务中锁定选中的记录直到使用次数更新完成
