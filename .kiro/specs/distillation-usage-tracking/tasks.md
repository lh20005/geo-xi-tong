# 实施计划

- [x] 1. 数据库架构扩展和迁移
  - 创建数据库迁移脚本002_add_usage_tracking.sql
  - 添加usage_count字段到distillations表
  - 创建distillation_usage表及其索引
  - 为现有蒸馏记录初始化usage_count
  - 根据现有文章记录重新计算usage_count
  - _需求: 2.1, 2.2, 2.4, 2.5, 2.6, 13.1-13.5_

- [x] 1.1 编写属性测试：新蒸馏结果初始化
  - **属性 2: 新蒸馏结果初始化**
  - **验证需求: 2.1**

- [x] 1.2 编写属性测试：查询结果包含使用次数
  - **属性 3: 查询结果包含使用次数**
  - **验证需求: 2.2, 6.1, 12.1**

- [x] 1.3 编写属性测试：级联删除一致性
  - **属性 5: 级联删除一致性**
  - **验证需求: 2.5, 2.6**

- [x] 2. 修复任务列表显示错误
  - 修改任务列表查询，JOIN distillations表获取keyword
  - 更新GenerationTask类型定义，添加keyword字段
  - 修改前端ArticleGenerationPage，在"蒸馏结果"列显示keyword
  - 处理蒸馏结果被删除的情况（显示"已删除"或"-"）
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 10.1, 10.2, 10.3_

- [x] 2.1 编写属性测试：任务列表显示关键词
  - **属性 1: 任务列表显示关键词**
  - **验证需求: 1.1, 1.2, 1.5, 10.1, 10.2**

- [x] 3. 实现DistillationService核心功能
  - 创建server/src/services/distillationService.ts
  - 实现getDistillationsWithStats方法（包含使用统计的列表查询）
  - 实现getUsageHistory方法（查询使用历史，支持分页）
  - 实现getRecommendedDistillations方法（推荐使用次数最少的前N条）
  - _需求: 4.1, 4.2, 5.1, 5.2, 5.3, 6.2, 11.1-11.4, 12.1-12.3_

- [x] 3.1 编写属性测试：蒸馏结果排序规则
  - **属性 8: 蒸馏结果排序规则**
  - **验证需求: 4.2, 6.2, 7.2, 11.2**

- [x] 3.2 编写属性测试：使用历史数据完整性
  - **属性 9: 使用历史数据完整性**
  - **验证需求: 4.4, 5.2**

- [x] 3.3 编写属性测试：使用历史查询正确性
  - **属性 10: 使用历史查询正确性**
  - **验证需求: 5.1, 5.3**

- [x] 3.4 编写属性测试：推荐结果标记
  - **属性 11: 推荐结果标记**
  - **验证需求: 6.3**

- [x] 3.5 编写属性测试：推荐算法正确性
  - **属性 18: 推荐算法正确性**
  - **验证需求: 11.1, 12.3**

- [x] 3.6 编写属性测试：推荐结果数据完整性
  - **属性 19: 推荐结果数据完整性**
  - **验证需求: 11.4**

- [x] 4. 实现使用记录创建和追踪
  - 在ArticleGenerationService中实现recordDistillationUsage方法
  - 在ArticleGenerationService中实现incrementUsageCount方法
  - 在ArticleGenerationService中实现saveArticleWithUsageTracking方法（事务处理）
  - 修改现有的文章保存逻辑，使用新的事务方法
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 9.1, 9.2_

- [x] 4.1 编写属性测试：使用记录创建完整性
  - **属性 4: 使用记录创建完整性**
  - **验证需求: 2.4, 3.1, 3.2**

- [x] 4.2 编写属性测试：唯一约束保证
  - **属性 6: 唯一约束保证**
  - **验证需求: 3.3**

- [x] 4.3 编写属性测试：事务完整性
  - **属性 7: 事务完整性**
  - **验证需求: 3.4, 3.5, 9.1, 9.2**

- [x] 5. 实现智能选择算法
  - 在ArticleGenerationService中实现selectDistillationsForTask方法
  - 实现按usage_count和created_at排序的查询逻辑
  - 实现跳过没有话题的蒸馏结果的逻辑
  - 实现可用数量验证（少于请求数量时抛出错误）
  - 修改executeTask方法使用新的智能选择算法
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2, 8.3, 8.5_

- [x] 5.1 编写属性测试：智能选择最小使用次数
  - **属性 12: 智能选择最小使用次数**
  - **验证需求: 7.1**

- [x] 5.2 编写属性测试：循环使用策略
  - **属性 13: 循环使用策略**
  - **验证需求: 7.4**

- [x] 5.3 编写属性测试：批量选择正确性
  - **属性 14: 批量选择正确性**
  - **验证需求: 8.1, 8.2**

- [x] 5.4 编写属性测试：任务内选择唯一性
  - **属性 16: 任务内选择唯一性**
  - **验证需求: 8.5**

- [x] 6. 实现立即更新机制
  - 确保在saveArticleWithUsageTracking中立即更新usage_count
  - 验证更新操作在文章保存的同一事务中
  - 使用原子操作（UPDATE ... SET usage_count = usage_count + 1）
  - _需求: 8.4, 9.1_

- [x] 6.1 编写属性测试：立即更新使用次数
  - **属性 15: 立即更新使用次数**
  - **验证需求: 8.4**

- [x] 7. 实现删除操作的一致性
  - 修改文章删除逻辑，在删除文章时减少usage_count
  - 验证级联删除配置正确（distillation_usage表）
  - 实现事务处理确保删除操作的原子性
  - _需求: 9.3, 9.4, 2.5, 2.6_

- [x] 7.1 编写属性测试：删除操作一致性
  - **属性 17: 删除操作一致性**
  - **验证需求: 9.3**

- [x] 8. 实现管理功能
  - 在DistillationService中实现resetUsageStats方法（重置单条记录）
  - 在DistillationService中实现resetAllUsageStats方法（重置所有记录）
  - 在DistillationService中实现repairUsageStats方法（修复不一致数据）
  - _需求: 9.5, 14.1-14.5_

- [x] 9. 创建API路由
  - 创建server/src/routes/distillation.ts（如果不存在）
  - 创建GET /api/distillation/stats路由（获取统计列表）
  - 创建GET /api/distillation/:id/usage-history路由（获取使用历史）
  - 创建GET /api/distillation/recommended路由（获取推荐）
  - 创建POST /api/distillation/:id/reset-usage路由（重置单条）
  - 创建POST /api/distillation/reset-all-usage路由（重置所有）
  - 创建POST /api/distillation/repair-usage-stats路由（修复统计）
  - 添加错误处理和参数验证
  - _需求: 12.1-12.5_

- [x] 9.1 编写属性测试：API响应数据一致性
  - **属性 20: API响应数据一致性**
  - **验证需求: 12.4**

- [x] 10. 实现并发控制
  - 在selectDistillationsForTask中使用SELECT FOR UPDATE锁定选中的记录
  - 在incrementUsageCount中使用原子操作
  - 实现重试机制（最多3次）
  - 添加并发冲突检测和错误记录
  - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

- [x] 10.1 编写属性测试：并发选择正确性
  - **属性 21: 并发选择正确性**
  - **验证需求: 15.1, 15.5**

- [x] 10.2 编写属性测试：并发更新准确性
  - **属性 22: 并发更新准确性**
  - **验证需求: 15.2**

- [x] 11. 更新前端蒸馏结果页面
  - 在DistillationResultsPage中添加"使用次数"列
  - 实现"查看使用历史"功能按钮
  - 创建使用历史弹窗组件（UsageHistoryModal）
  - 在列表中显示推荐标记（使用次数最少的前3条）
  - 实现分页功能
  - _需求: 4.1-4.5, 6.3, 11.1-11.4_

- [x] 12. 更新前端任务配置页面
  - 修改TaskConfigModal中的蒸馏结果下拉列表
  - 显示每个蒸馏结果的使用次数
  - 添加推荐标记（使用次数最少的前3条）
  - 实现推荐提示功能（悬停显示推荐原因）
  - 禁用没有话题的蒸馏结果选项
  - _需求: 6.1-6.5, 11.1-11.5_

- [x] 13. 更新前端API客户端
  - 在client/src/api中创建distillationApi.ts
  - 实现getDistillationsWithStats方法
  - 实现getUsageHistory方法
  - 实现getRecommendedDistillations方法
  - 更*新articleGenerationApi.ts中的fetchTasks方法（处理新的keyword字*段）
  - _需求: 1.5, 4.1, 5.1, 11.1, 12.1-12.3_

- [x] 14. 检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 修复任何失败的测试
  - 确保代码覆盖率达标
  - 如有问题请询问用户

- [x] 15. 集成测试
  - 编写完整文章生成流程的集成测试
  - 编写并发场景的集成测试
  - 编写删除操作的集成测试
  - 编写数据一致性验证的集成测试
  - _需求: 所有需求_

- [x] 16. 数据迁移和验证
  - 备份数据库
  - 运行数据库迁移脚本
  - 验证表结构和索引
  - 运行修复工具计算现有数据的usage_count
  - 验证数据一致性
  - 测试回滚计划
  - _需求: 13.1-13.5, 9.5_

- [x] 17. 前端UI测试和优化
  - 测试任务列表页面的关键词显示
  - 测试蒸馏结果页面的使用次数和历史功能
  - 测试任务配置页面的推荐功能
  - 优化UI交互和用户体验
  - 处理边缘情况（蒸馏结果被删除、没有话题等）
  - _需求: 1.1-1.3, 4.1-4.5, 6.1-6.5, 10.1-10.5_

- [x] 18. 文档和部署准备
  - 更新API文档
  - 创建部署检查清单
  - 编写监控和维护指南
  - 准备回滚计划
  - 编写用户使用指南
  - _需求: 所有需求_
