# Design Document

## Overview

æœ¬è®¾è®¡æ–‡æ¡£æè¿°å¦‚ä½•ä¿®å¤æŠ–éŸ³å¹³å°ç™»å½•åæ— æ³•è·å–è´¦å·ä¿¡æ¯çš„é—®é¢˜ã€‚é€šè¿‡å‚ç…§å¤´æ¡å·çš„æˆåŠŸå®ç°ï¼Œä¼˜åŒ–æŠ–éŸ³å¹³å°çš„ç”¨æˆ·åæå–é€‰æ‹©å™¨é…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿå¯é åœ°æå–ç”¨æˆ·åä¿¡æ¯ã€‚

## Architecture

### ç°æœ‰æ¶æ„

AccountService ä¸­çš„ `extractUserInfo` æ–¹æ³•è´Ÿè´£ä»ç™»å½•åçš„é¡µé¢æå–ç”¨æˆ·ä¿¡æ¯ï¼š

```
æµè§ˆå™¨ç™»å½•æµç¨‹:
1. æ‰“å¼€å¹³å°ç™»å½•é¡µé¢
2. ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç™»å½•
3. æå–Cookieå’Œç”¨æˆ·ä¿¡æ¯
4. ä¿å­˜åˆ°æ•°æ®åº“

ç”¨æˆ·ä¿¡æ¯æå–:
- ä½¿ç”¨CSSé€‰æ‹©å™¨ä»é¡µé¢æå–ç”¨æˆ·å
- æ”¯æŒå¤šä¸ªå¤‡ç”¨é€‰æ‹©å™¨ï¼ˆæŒ‰é¡ºåºå°è¯•ï¼‰
- æå–å¤±è´¥æ—¶ä¿å­˜HTMLç”¨äºè°ƒè¯•
```

### é—®é¢˜åˆ†æ

**æŠ–éŸ³å¹³å°å½“å‰é€‰æ‹©å™¨é…ç½®ï¼š**
```typescript
'douyin': [
  '.name-_lSSDc',  // ä¸»é€‰æ‹©å™¨ - åŠ¨æ€ç”Ÿæˆçš„classï¼Œå®¹æ˜“å¤±æ•ˆ
  '.container-vEyGlK .content-fFY6HC .header-_F2uzl .left-zEzdJX .name-_lSSDc',
  '.header-_F2uzl .name-_lSSDc',
  '[class*="name-"][class*="_"]',
  '.semi-navigation-header-username',  // é€šç”¨é€‰æ‹©å™¨ - æ’åœ¨æœ€å
  '.username',
  '.user-name',
  '[class*="username"]'
]
```

**å¤´æ¡å·æˆåŠŸçš„é€‰æ‹©å™¨é…ç½®ï¼š**
```typescript
'toutiao': [
  '.auth-avator-name',
  '.user-name',
  '.username', 
  '.account-name',
  '[class*="username"]',
  '[class*="user-name"]',
  '.semi-navigation-header-username'  // é€šç”¨é€‰æ‹©å™¨
]
```

**æ ¸å¿ƒé—®é¢˜ï¼š**
1. æŠ–éŸ³çš„ä¸»é€‰æ‹©å™¨ä½¿ç”¨äº†åŠ¨æ€ç”Ÿæˆçš„classåç§°ï¼ˆå¦‚ `name-_lSSDc`ï¼‰ï¼Œè¿™ç±»åç§°åœ¨æ„å»ºæ—¶ä¼šå˜åŒ–
2. é€šç”¨é€‰æ‹©å™¨ `.semi-navigation-header-username` æ’åœ¨åˆ—è¡¨æœ«å°¾ï¼Œå¯¼è‡´ä¼˜å…ˆå°è¯•å¤±æ•ˆçš„é€‰æ‹©å™¨
3. å¤´æ¡å·å’ŒæŠ–éŸ³éƒ½ä½¿ç”¨ç›¸åŒçš„UIæ¡†æ¶ï¼ˆSemi Designï¼‰ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨é€šç”¨é€‰æ‹©å™¨

## Components and Interfaces

### ä¿®æ”¹çš„ç»„ä»¶

**AccountService.extractUserInfo()**
- ä½ç½®ï¼š`server/src/services/AccountService.ts`
- ä¿®æ”¹ï¼šæ›´æ–°æŠ–éŸ³å¹³å°çš„é€‰æ‹©å™¨é…ç½®
- å½±å“ï¼šä»…å½±å“æŠ–éŸ³å¹³å°çš„ç”¨æˆ·åæå–ï¼Œä¸å½±å“å…¶ä»–å¹³å°

### é€‰æ‹©å™¨é…ç½®ç»“æ„

```typescript
const selectors: { [key: string]: string[] } = {
  'douyin': [
    // ä¼˜å…ˆçº§1: é€šç”¨é€‰æ‹©å™¨ï¼ˆä¸å¤´æ¡å·ç›¸åŒï¼‰
    '.semi-navigation-header-username',
    
    // ä¼˜å…ˆçº§2: å¸¸è§çš„ç”¨æˆ·åclass
    '.username',
    '.user-name',
    '[class*="username"]',
    '[class*="user-name"]',
    
    // ä¼˜å…ˆçº§3: ç‰¹å®šå¹³å°é€‰æ‹©å™¨ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
    '.name-_lSSDc',
    '.header-_F2uzl .name-_lSSDc',
    '[class*="name-"][class*="_"]'
  ]
}
```

## Data Models

æ— éœ€ä¿®æ”¹æ•°æ®æ¨¡å‹ã€‚ç°æœ‰çš„ `real_username` å­—æ®µå·²ç»å­˜åœ¨äº `platform_accounts` è¡¨ä¸­ã€‚

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: é€‰æ‹©å™¨å°è¯•é¡ºåº

*For any* å¹³å°çš„é€‰æ‹©å™¨åˆ—è¡¨ï¼Œç³»ç»Ÿåº”è¯¥æŒ‰ç…§é…ç½®çš„é¡ºåºä¾æ¬¡å°è¯•æ¯ä¸ªé€‰æ‹©å™¨ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆçš„å…ƒç´ æˆ–å°è¯•å®Œæ‰€æœ‰é€‰æ‹©å™¨ã€‚

**Validates: Requirements 1.2**

### Property 2: é€šç”¨é€‰æ‹©å™¨ä¼˜å…ˆ

*For any* ä½¿ç”¨Semi Designæ¡†æ¶çš„å¹³å°ï¼ˆå¦‚æŠ–éŸ³ã€å¤´æ¡å·ï¼‰ï¼Œé€šç”¨é€‰æ‹©å™¨ `.semi-navigation-header-username` åº”è¯¥åœ¨é€‰æ‹©å™¨åˆ—è¡¨çš„å‰é¢ä½ç½®ã€‚

**Validates: Requirements 1.4, 2.1**

### Property 3: ç”¨æˆ·åæå–æˆåŠŸåä¿å­˜

*For any* æˆåŠŸæå–çš„ç”¨æˆ·åï¼Œç³»ç»Ÿåº”è¯¥å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“çš„ `real_username` å­—æ®µï¼Œå¹¶ä¸”è¯¥å€¼åº”è¯¥éç©ºã€‚

**Validates: Requirements 1.5**

### Property 4: è°ƒè¯•ä¿¡æ¯å®Œæ•´æ€§

*For any* é€‰æ‹©å™¨å°è¯•å¤±è´¥çš„æƒ…å†µï¼Œç³»ç»Ÿåº”è¯¥è®°å½•è¯¥é€‰æ‹©å™¨çš„åç§°å’Œå¤±è´¥åŸå› ï¼Œå¹¶åœ¨æ‰€æœ‰é€‰æ‹©å™¨éƒ½å¤±è´¥æ—¶ä¿å­˜é¡µé¢HTMLã€‚

**Validates: Requirements 3.1, 3.2**

## Error Handling

### é€‰æ‹©å™¨å¤±æ•ˆå¤„ç†

1. **ä¸»é€‰æ‹©å™¨å¤±æ•ˆ**ï¼šè‡ªåŠ¨å°è¯•å¤‡ç”¨é€‰æ‹©å™¨
2. **æ‰€æœ‰é€‰æ‹©å™¨å¤±è´¥**ï¼š
   - ä¿å­˜é¡µé¢HTMLåˆ° `debug/` ç›®å½•
   - è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - è¿”å›ç©ºç”¨æˆ·åï¼ˆä¸é˜»å¡è´¦å·ä¿å­˜ï¼‰

### æ—¥å¿—è®°å½•

```typescript
// æˆåŠŸæå–
console.log(`[æå–ç”¨æˆ·ä¿¡æ¯] âœ… æˆåŠŸæå–ç”¨æˆ·å: "${username}"`);

// é€‰æ‹©å™¨å¤±è´¥
console.log(`[æå–ç”¨æˆ·ä¿¡æ¯] âŒ æœªæ‰¾åˆ°å…ƒç´ : ${selector}`);

// æ‰€æœ‰é€‰æ‹©å™¨å¤±è´¥
console.log(`[æå–ç”¨æˆ·ä¿¡æ¯] âš ï¸  æ‰€æœ‰é€‰æ‹©å™¨éƒ½æœªèƒ½æå–åˆ°ç”¨æˆ·å`);
console.log(`[æå–ç”¨æˆ·ä¿¡æ¯] ğŸ“„ å·²ä¿å­˜é¡µé¢HTML: ${filepath}`);
```

## Testing Strategy

### Unit Tests

1. **æµ‹è¯•é€‰æ‹©å™¨é…ç½®**
   - éªŒè¯æŠ–éŸ³é€‰æ‹©å™¨åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ `.semi-navigation-header-username`
   - éªŒè¯é€‰æ‹©å™¨åˆ—è¡¨åŒ…å«æ‰€æœ‰å¿…è¦çš„å¤‡ç”¨é€‰æ‹©å™¨

2. **æµ‹è¯•é€‰æ‹©å™¨å°è¯•é€»è¾‘**
   - æ¨¡æ‹Ÿé¡µé¢å…ƒç´ å­˜åœ¨çš„æƒ…å†µ
   - æ¨¡æ‹Ÿé¡µé¢å…ƒç´ ä¸å­˜åœ¨çš„æƒ…å†µ
   - éªŒè¯æŒ‰é¡ºåºå°è¯•é€‰æ‹©å™¨

3. **æµ‹è¯•ç”¨æˆ·åä¿å­˜**
   - éªŒè¯æå–çš„ç”¨æˆ·åæ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
   - éªŒè¯ç©ºç”¨æˆ·åä¸ä¼šå¯¼è‡´ä¿å­˜å¤±è´¥

### Property-Based Tests

ç”±äºè¿™æ˜¯é…ç½®ä¿®æ”¹è€Œéç®—æ³•å®ç°ï¼Œproperty-based testingä¸å¤ªé€‚ç”¨ã€‚ä¸»è¦ä¾èµ–å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

### Integration Tests

1. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - ä½¿ç”¨çœŸå®çš„æŠ–éŸ³ç™»å½•é¡µé¢ï¼ˆæˆ–mocké¡µé¢ï¼‰
   - éªŒè¯èƒ½å¤ŸæˆåŠŸæå–ç”¨æˆ·å
   - éªŒè¯ç”¨æˆ·åä¿å­˜åˆ°æ•°æ®åº“

2. **å›å½’æµ‹è¯•**
   - éªŒè¯ä¿®æ”¹ä¸å½±å“å…¶ä»–å¹³å°çš„ç”¨æˆ·åæå–
   - ç‰¹åˆ«æµ‹è¯•å¤´æ¡å·çš„ç”¨æˆ·åæå–ä»ç„¶æ­£å¸¸å·¥ä½œ

### Manual Testing

1. åœ¨å¼€å‘ç¯å¢ƒä¸­ç™»å½•æŠ–éŸ³å¹³å°
2. æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„é€‰æ‹©å™¨
3. éªŒè¯æ•°æ®åº“ä¸­çš„ `real_username` å­—æ®µå·²æ­£ç¡®å¡«å……
4. æ£€æŸ¥å‰ç«¯æ˜¾ç¤ºçš„ç”¨æˆ·åæ˜¯å¦æ­£ç¡®

## Implementation Notes

### ä¿®æ”¹èŒƒå›´

ä»…éœ€ä¿®æ”¹ `server/src/services/AccountService.ts` æ–‡ä»¶ä¸­çš„é€‰æ‹©å™¨é…ç½®ï¼Œå…·ä½“ä½ç½®åœ¨ `extractUserInfo` æ–¹æ³•çš„ `selectors` å¯¹è±¡ä¸­ã€‚

### å‘åå…¼å®¹æ€§

- ä¿®æ”¹ä¸å½±å“ç°æœ‰çš„è´¦å·æ•°æ®
- ä¿®æ”¹ä¸å½±å“å…¶ä»–å¹³å°çš„åŠŸèƒ½
- å¦‚æœæ–°é€‰æ‹©å™¨å¤±è´¥ï¼Œä»ä¼šå°è¯•æ—§çš„é€‰æ‹©å™¨ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰

### éƒ¨ç½²å»ºè®®

1. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ä¿®æ”¹
2. ä½¿ç”¨çœŸå®çš„æŠ–éŸ³è´¦å·æµ‹è¯•ç™»å½•æµç¨‹
3. ç¡®è®¤ç”¨æˆ·åæå–æˆåŠŸåå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
4. éƒ¨ç½²åç›‘æ§æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰æ–°çš„é”™è¯¯

## References

- å¤´æ¡å·æˆåŠŸå®ç°ï¼š`server/src/services/AccountService.ts` ç¬¬550-700è¡Œ
- æŠ–éŸ³é€‚é…å™¨ï¼š`server/src/services/adapters/DouyinAdapter.ts`
- Semi Design UIæ¡†æ¶æ–‡æ¡£ï¼šhttps://semi.design/
