# 实施计划：存储空间管理

## 概述

本实施计划将存储空间管理功能分解为离散的、增量式的任务。每个任务都建立在之前的工作基础上，并通过测试进行验证。实施遵循自下而上的方法：数据库架构 → 服务 → API → 前端集成。

## 任务列表

- [x] 1. 数据库架构和迁移
  - 创建存储管理表的迁移文件
  - 添加 user_storage_usage 表，包含资源类型计数器
  - 添加 storage_usage_history 表用于每日快照
  - 添加 storage_transactions 表用于审计跟踪
  - 在 plan_features 表中添加 storage_space 功能
  - 创建数据库索引以提升性能
  - 创建数据库函数用于原子更新
  - _需求: 1.1, 3.1-3.7, 13.1_

- [ ] 1.1 编写存储计算的属性测试
  - **属性 4: 总存储计算**
  - **验证: 需求 3.6**

- [x] 2. 初始化默认存储配额
  - [x] 2.1 更新用户注册以初始化存储记录
    - 修改用户创建逻辑以调用存储初始化
    - 为普通用户设置 20MB 默认配额
    - 为管理员用户设置无限制（-1）配额
    - _需求: 2.1, 2.2, 2.3_

  - [ ]* 2.2 编写默认配额分配的单元测试
    - 测试普通用户获得 20MB 配额
    - 测试管理员用户获得无限配额
    - 测试用户注册时创建存储记录
    - _需求: 2.1, 2.2, 2.3_

- [-] 3. 实现 StorageService
  - [x] 3.1 创建 StorageService 类及核心方法
    - 实现 getUserStorageUsage()
    - 实现 getStorageBreakdown()
    - 实现 initializeUserStorage()
    - _需求: 3.1-3.7_

  - [x] 3.2 实现存储跟踪方法
    - 实现 recordStorageUsage() 用于添加资源
    - 实现 removeStorageUsage() 用于删除资源
    - 使用数据库事务确保原子性
    - _需求: 3.1-3.4, 3.7_

  - [ ] 3.3 编写存储添加的属性测试
    - **属性 1: 存储添加不变性**
    - **验证: 需求 3.1, 3.2, 3.3**

  - [ ]* 3.4 编写存储删除往返的属性测试
    - **属性 2: 存储删除往返**
    - **验证: 需求 3.4**

  - [ ]* 3.5 编写计数器独立性的属性测试
    - **属性 3: 存储计数器独立性**
    - **验证: 需求 3.5**

  - [x] 3.6 实现配额管理方法
    - 实现 updateStorageQuota() 用于套餐变更
    - 实现 addPurchasedStorage() 用于存储购买
    - 确保保留现有资源
    - _需求: 2.4, 2.5, 12.2, 12.3_

  - [ ]* 3.7 编写配额更新的属性测试
    - **属性 24: 套餐配额更新传播**
    - **属性 25: 配额变更时资源保留**
    - **验证: 需求 2.4, 2.5**

  - [x] 3.8 实现存储历史方法
    - 实现 getStorageHistory() 用于日期范围查询
    - 实现 createDailySnapshot() 用于定时任务
    - _需求: 13.1, 13.2, 13.6_

  - [x] 3.9 实现存储对账
    - 实现 reconcileStorage() 比较数据库与磁盘
    - 检测孤立文件
    - 计算差异
    - _需求: 10.5, 10.6_

- [ ] 4. 实现 StorageQuotaService
  - [x] 4.1 创建 StorageQuotaService 类
    - 实现 checkQuota() 方法
    - 实现 getEffectiveQuota() 方法
    - 实现 hasUnlimitedStorage() 方法
    - _需求: 4.1-4.3, 4.7_

  - [ ]* 4.2 编写配额执行的属性测试
    - **属性 5: 有限存储的配额执行**
    - **属性 6: 无限存储永不拒绝**
    - **验证: 需求 4.1, 4.2, 4.3**

  - [ ]* 4.3 编写剩余空间计算的属性测试
    - **属性 7: 配额检查返回剩余空间**
    - **验证: 需求 4.7**

  - [x] 4.4 实现文件大小验证
    - 实现 validateFileSize() 方法
    - 定义最大文件大小限制（图片 50MB，文档 100MB）
    - 允许管理员配置限制
    - _需求: 14.1-14.5_

  - [ ]* 4.5 编写文件大小限制的单元测试
    - 测试图片 50MB 限制
    - 测试文档 100MB 限制
    - 测试带描述性错误的拒绝
    - _需求: 14.1, 14.2, 14.3_

- [ ] 5. 实现 StorageAlertService
  - [x] 5.1 创建 StorageAlertService 类
    - 实现 checkAndCreateAlerts() 方法
    - 实现通过 WebSocket 的 sendStorageAlert()
    - 实现 getPendingAlerts() 方法
    - _需求: 7.1-7.7_

  - [x] 5.2 实现警报阈值检测
    - 检查 80% 警告阈值
    - 检查 95% 严重阈值
    - 检查 100% 耗尽阈值
    - 防止重复警报
    - _需求: 7.1-7.3, 7.6_

  - [ ]* 5.3 编写警报生成的单元测试
    - 测试 80% 时的警告警报
    - 测试 95% 时的严重警报
    - 测试 100% 时的耗尽警报
    - _需求: 7.1, 7.2, 7.3_

  - [ ]* 5.4 编写警报去重的属性测试
    - **属性 12: 警报去重**
    - **验证: 需求 7.6**

- [ ] 6. 检查点 - 核心服务完成
  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 将存储跟踪集成到上传流程
  - [x] 7.1 更新图片上传端点
    - 上传前添加配额检查
    - 添加文件大小验证
    - 成功上传后记录存储使用
    - 处理配额超限错误
    - _需求: 4.1-4.6_

  - [x] 7.2 更新文档上传端点
    - 上传前添加配额检查
    - 添加文件大小验证
    - 成功上传后记录存储使用
    - 处理配额超限错误
    - _需求: 4.1-4.6_

  - [x] 7.3 更新文章生成端点
    - 保存前添加配额检查
    - 计算文章大小
    - 成功保存后记录存储使用
    - 处理配额超限错误
    - _需求: 4.1-4.6_

  - [ ]* 7.4 编写上传流程的集成测试
    - 测试有可用配额时的成功上传
    - 测试配额超限时的拒绝上传
    - 测试无限配额允许所有上传
    - _需求: 4.1, 4.2, 4.3_

- [x] 8. 将存储清理集成到删除流程
  - [x] 8.1 更新图片删除端点
    - 验证用户所有权
    - 从磁盘删除文件
    - 减少存储使用
    - 优雅处理文件删除失败
    - _需求: 5.3, 5.5, 10.1, 10.4_

  - [x] 8.2 更新文档删除端点
    - 验证用户所有权
    - 从磁盘删除文件
    - 减少存储使用
    - 优雅处理文件删除失败
    - _需求: 5.3, 5.5, 10.2, 10.4_

  - [x] 8.3 更新文章删除端点
    - 验证用户所有权
    - 从数据库删除内容
    - 减少存储使用
    - _需求: 5.3, 5.5, 10.3_

  - [ ]* 8.4 编写删除清理的属性测试
    - **属性 16: 资源删除清理**
    - **验证: 需求 10.1, 10.2, 10.3, 10.4**

  - [ ]* 8.5 编写所有权验证的属性测试
    - **属性 9: 删除的所有权验证**
    - **验证: 需求 5.3, 5.5**

- [-] 9. 实现存储 API 端点
  - [x] 9.1 创建存储路由文件
    - GET /api/storage/usage - 获取当前使用情况
    - GET /api/storage/breakdown - 按类型获取明细
    - POST /api/storage/check-quota - 检查是否允许上传
    - GET /api/storage/history - 获取使用历史
    - GET /api/storage/transactions - 获取事务日志
    - 为所有路由添加身份验证中间件
    - _需求: 8.1-8.7_

  - [ ]* 9.2 编写 API 端点的单元测试
    - 测试端点存在性和响应格式
    - 测试身份验证要求
    - 测试响应包含剩余空间
    - 测试响应包含格式化值
    - _需求: 8.1-8.7_

  - [ ]* 9.3 编写 API 身份验证的属性测试
    - **属性 13: API 身份验证执行**
    - **验证: 需求 8.5**

  - [ ]* 9.4 编写 API 响应完整性的属性测试
    - **属性 14: API 响应完整性**
    - **验证: 需求 8.6, 8.7**

- [x] 10. 实现用户隔离
  - [x] 10.1 为所有存储查询添加 user_id 过滤
    - 更新 StorageService 方法按 user_id 过滤
    - 使用请求上下文中的已认证用户
    - 防止跨用户数据访问
    - _需求: 5.1, 5.2, 5.4_

  - [ ]* 10.2 编写存储隔离的属性测试
    - **属性 8: 用户存储隔离**
    - **验证: 需求 5.1, 5.2, 5.4**

- [-] 11. 实现管理员存储管理
  - [x] 11.1 创建管理员存储路由
    - GET /api/admin/storage/users - 列出所有用户的存储
    - PUT /api/admin/storage/quota/:userId - 更新用户配额
    - GET /api/admin/storage/breakdown/:userId - 获取用户明细
    - GET /api/admin/storage/stats - 获取系统统计
    - POST /api/admin/storage/reconcile/:userId - 触发对账
    - 添加管理员身份验证中间件
    - _需求: 9.1-9.7_

  - [x] 11.2 实现配额修改日志
    - 记录所有管理员配额更改
    - 包含 admin_id、user_id、旧值/新值
    - 向受影响用户发送 WebSocket 通知
    - _需求: 9.6, 9.7_

  - [ ]* 11.3 编写管理员日志的属性测试
    - **属性 15: 管理员配额修改日志**
    - **验证: 需求 9.6**

  - [ ]* 11.4 编写管理员端点的单元测试
    - 测试管理员可以查看所有用户的存储
    - 测试管理员可以修改用户配额
    - 测试管理员可以触发对账
    - 测试非管理员无法访问管理员端点
    - _需求: 9.1-9.7_

- [ ] 12. 检查点 - 后端完成
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 13. 实现 Redis 缓存
  - [x] 13.1 为 StorageService 添加缓存
    - 缓存 getUserStorageUsage() 结果，TTL 为 5 分钟
    - 存储更新时使缓存失效
    - 缓存未命中时回退到数据库
    - _需求: 15.1, 15.2_

  - [ ]* 13.2 编写缓存失效的属性测试
    - **属性 21: 更新时缓存失效**
    - **验证: 需求 15.2**

- [x] 14. 实现购买存储功能
  - [x] 14.1 添加存储购买产品集成
    - 在产品管理中创建存储产品卡
    - 实现购买处理程序以添加存储
    - 支持购买的累积叠加
    - 将购买的存储与套餐存储分开跟踪
    - _需求: 12.1-12.5_

  - [ ]* 14.2 编写购买存储的属性测试
    - **属性 17: 购买存储添加**
    - **属性 18: 购买存储持久性**
    - **验证: 需求 12.2, 12.3, 12.5**

  - [x] 14.3 实现存储过期跟踪
    - 为购买的存储添加 expiration_date 字段
    - 创建定时任务检查即将过期的存储
    - 在过期前发送通知
    - _需求: 12.6, 12.7_

- [x] 15. 实现存储使用报告
  - [x] 15.1 创建每日快照定时任务
    - 安排任务在每天午夜运行
    - 为所有用户创建快照
    - 存储在 storage_usage_history 表中
    - _需求: 13.1_

  - [x] 15.2 实现增长率计算
    - 计算每天/每周/每月的 MB 增长
    - 识别增长最快的资源类型
    - 提供趋势分析
    - _需求: 13.3, 13.4_

  - [ ]* 15.3 编写增长率计算的属性测试
    - **属性 19: 存储增长率计算**
    - **验证: 需求 13.3**

  - [x] 15.4 实现 CSV 导出功能
    - 创建存储历史的导出端点
    - 将数据格式化为 CSV
    - 包含所有资源类型和日期
    - _需求: 13.5_

- [-] 16. 实现前端存储可视化
  - [x] 16.1 创建 StorageUsageCard 组件
    - 显示总使用量和配额
    - 显示带颜色编码的进度条
    - 显示警告/严重指示器
    - 按资源类型显示明细
    - _需求: 6.1-6.8_

  - [x] 16.2 创建 StorageBreakdownChart 组件
    - 实现资源类型明细的饼图
    - 显示百分比和绝对大小
    - 显示每种类型的项目数量
    - 使用适当的大小单位（KB/MB/GB）
    - _需求: 6.3, 6.4, 6.7, 6.8_

  - [x] 16.3 将存储可视化集成到 UserCenterPage
    - 在用户中心添加新的"存储"标签页
    - 显示 StorageUsageCard
    - 显示 StorageBreakdownChart
    - 如有警报则显示存储警报
    - 接近限制时添加"升级套餐"按钮
    - _需求: 6.1-6.8, 7.5, 7.7_

  - [ ]* 16.4 编写存储组件的单元测试
    - 测试进度条在阈值处的颜色变化
    - 测试警告指示器正确显示
    - 测试大小格式化（KB/MB/GB）
    - 测试图表数据渲染
    - _需求: 6.2, 6.4, 6.5, 6.6_

- [x] 17. 实现实时存储更新
  - [x] 17.1 添加 WebSocket 事件处理器
    - 监听 'storage_updated' 事件
    - 监听 'storage_alert' 事件
    - 监听 'storage_quota_changed' 事件
    - 收到事件时实时更新 UI
    - _需求: 7.4, 9.7_

  - [x] 17.2 实现存储警报通知
    - 为存储警报显示提示通知
    - 显示警报类型（警告/严重/耗尽）
    - 在通知中包含升级链接
    - _需求: 7.4, 7.5, 7.7_

- [x] 18. 更新上传组件以包含配额检查
  - [x] 18.1 更新 ImageUpload 组件
    - 允许文件选择前检查配额
    - 显示剩余存储空间
    - 配额超限时显示错误
    - 显示最大文件大小限制
    - _需求: 4.1-4.6, 14.6_

  - [x] 18.2 更新 DocumentUpload 组件
    - 允许文件选择前检查配额
    - 显示剩余存储空间
    - 配额超限时显示错误
    - 显示最大文件大小限制
    - _需求: 4.1-4.6, 14.6_

  - [x] 18.3 更新 ArticleGeneration 组件
    - 生成文章前检查配额
    - 显示剩余存储空间
    - 配额超限时显示错误
    - _需求: 4.1-4.6_

- [x] 19. 为现有用户实现存储迁移
  - [x] 19.1 创建迁移脚本
    - 扫描所有现有用户
    - 从现有资源计算当前存储使用量
    - 初始化存储跟踪记录
    - 根据当前订阅套餐分配配额
    - _需求: 11.1-11.8_

  - [x] 19.2 测试迁移脚本
    - 在开发数据库上测试
    - 验证所有用户都有存储记录
    - 验证使用量计算准确
    - 验证配额与订阅套餐匹配
    - _需求: 11.1-11.8_

  - [x] 19.3 在生产环境执行迁移
    - 创建数据库备份
    - 运行迁移脚本
    - 验证结果
    - 监控问题
    - _需求: 11.1-11.8_

- [x] 20. 实现并发安全
  - [x]* 20.1 编写并发更新的属性测试
    - **属性 23: 并发更新安全**
    - **验证: 需求 3.7, 15.7**

  - [x]* 20.2 编写事务原子性的属性测试
    - **属性 22: 事务原子性**
    - **验证: 需求 15.5**

- [x] 21. 最终集成测试
  - [x]* 21.1 编写端到端集成测试
    - 测试带配额执行的完整上传流程
    - 测试带清理的完整删除流程
    - 测试配额更新传播
    - 测试警报生成和通知
    - 测试管理员管理功能
    - _需求: 全部_

- [x] 22. 最终检查点 - 完整系统
  - [x] 确保所有测试通过，如有问题请询问用户。
  - [x] 验证所有需求已实现
  - [x] 审查代码覆盖率（目标：85%）
  - [x] 对 UI 组件进行手动测试
  - [x] 验证 WebSocket 通知正常工作

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 集成测试验证端到端流程
- 迁移任务（19.x）应谨慎执行并做好备份
