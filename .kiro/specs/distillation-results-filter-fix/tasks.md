# 实现计划

- [ ] 1. 数据库层：添加关键词查询方法
  - [x] 1.1 在database.ts中创建getAllKeywords方法
    - 实现SQL查询获取所有唯一关键词
    - 只返回有话题的关键词
    - 按字母顺序排序
    - _需求：1.1, 1.2, 4.1_
  
  - [ ]* 1.2 编写属性测试验证关键词列表完整性
    - **属性 1: 关键词列表完整性**
    - **验证需求：1.1, 1.2**
  
  - [ ]* 1.3 编写属性测试验证关键词列表排序正确性
    - **属性 2: 关键词列表排序正确性**
    - **验证需求：1.2**

- [ ] 2. 数据库层：修改话题查询方法支持搜索
  - [x] 2.1 修改getTopicsWithReferences方法支持search参数
    - 添加search参数到TopicsQueryFilters接口
    - 实现搜索SQL逻辑（LIKE查询，不区分大小写）
    - 确保search参数优先级高于其他筛选条件
    - _需求：2.1, 4.2_
  
  - [ ]* 2.2 编写属性测试验证搜索全局性
    - **属性 3: 搜索全局性**
    - **验证需求：2.1, 2.2**
  
  - [ ]* 2.3 编写属性测试验证搜索不区分大小写
    - **属性 4: 搜索不区分大小写**
    - **验证需求：2.1**

- [ ] 3. 后端服务层：实现关键词列表服务
  - [x] 3.1 在distillationService.ts中实现getAllKeywords方法
    - 调用数据库查询方法
    - 实现错误处理和日志记录
    - 返回格式化的关键词数组
    - _需求：1.1, 1.2_
  
  - [ ]* 3.2 编写单元测试验证服务方法正确性
    - 测试正常查询流程
    - 测试错误处理
    - _需求：1.1, 1.2_

- [ ] 4. 后端API层：添加关键词列表端点
  - [x] 4.1 在distillation.ts路由文件中添加GET /api/distillation/keywords端点
    - 调用服务层方法
    - 返回关键词数组
    - 实现错误处理
    - _需求：1.1, 4.1_
  
  - [ ]* 4.2 编写集成测试验证API端点
    - 测试端点返回正确的数据格式
    - 测试错误场景
    - _需求：4.1, 4.5_

- [ ] 5. 后端API层：修改结果列表端点支持搜索
  - [x] 5.1 修改GET /api/distillation/results端点支持search参数
    - 解析search查询参数
    - 传递search参数到服务层
    - 确保search参数优先级
    - _需求：2.1, 4.2_
  
  - [ ]* 5.2 编写属性测试验证API参数优先级
    - **属性 9: API参数优先级**
    - **验证需求：4.2**
  
  - [ ]* 5.3 编写集成测试验证搜索API流程
    - 测试搜索端点的完整流程
    - 测试搜索结果的准确性
    - _需求：2.1, 2.2, 4.4_

- [ ] 6. 前端数据层：更新类型定义和API客户端
  - [x] 6.1 更新types/distillationResults.ts添加搜索相关类型
    - 添加KeywordsResponse接口
    - 修改QueryFilters接口添加search字段
    - _需求：1.1, 2.1_
  
  - [x] 6.2 在api/distillationResultsApi.ts中添加fetchAllKeywords方法
    - 实现调用GET /api/distillation/keywords
    - 实现错误处理
    - _需求：1.1_
  
  - [x] 6.3 修改fetchResultsWithReferences方法支持search参数
    - 添加search参数支持
    - 更新API调用
    - _需求：2.1_

- [ ] 7. 前端UI层：重构关键词列表加载逻辑
  - [x] 7.1 修改DistillationResultsPage组件添加独立的关键词加载
    - 添加allKeywords状态
    - 实现loadAllKeywords方法
    - 在组件挂载时调用loadAllKeywords
    - 移除从当前页数据提取关键词的逻辑
    - _需求：1.1, 1.5_
  
  - [ ]* 7.2 编写单元测试验证关键词列表加载
    - 测试组件挂载时加载关键词
    - 测试关键词列表更新
    - _需求：1.1, 1.5_

- [ ] 8. 前端UI层：实现搜索功能
  - [x] 8.1 修改搜索逻辑从本地搜索改为API搜索
    - 移除本地filteredData逻辑
    - 修改loadData方法支持search参数
    - 确保搜索时调用后端API
    - _需求：2.1, 2.2_
  
  - [x] 8.2 实现搜索和筛选的互斥逻辑
    - 搜索时清空关键词和AI模型筛选
    - 筛选时清空搜索框
    - 添加isSearchMode状态
    - _需求：2.5, 3.1, 3.2_
  
  - [ ]* 8.3 编写属性测试验证筛选和搜索互斥性
    - **属性 5: 筛选和搜索互斥性**
    - **验证需求：3.1, 3.2**
  
  - [x] 8.4 实现搜索防抖功能
    - 保持300ms延迟
    - 确保防抖正确工作
    - _需求：2.4_
  
  - [ ]* 8.5 编写单元测试验证搜索防抖
    - 测试防抖延迟时间
    - 测试防抖取消
    - _需求：2.4_

- [ ] 9. 前端UI层：优化筛选和清除逻辑
  - [x] 9.1 修改handleKeywordChange清空搜索
    - 筛选时清空searchInput和searchText
    - 退出搜索模式
    - 重置分页
    - _需求：3.1, 3.4_
  
  - [x] 9.2 修改handleClearFilters清除所有条件
    - 清空所有筛选条件
    - 清空搜索文本
    - 退出搜索模式
    - 重置分页
    - _需求：3.3_
  
  - [ ]* 9.3 编写属性测试验证清除筛选完整性
    - **属性 6: 清除筛选完整性**
    - **验证需求：3.3**
  
  - [ ]* 9.4 编写属性测试验证分页重置一致性
    - **属性 7: 分页重置一致性**
    - **验证需求：3.4**

- [ ] 10. 前端UI层：添加UI反馈优化
  - [x] 10.1 实现"清除筛选"按钮的启用/禁用状态
    - 计算hasActiveFilters
    - 根据状态设置按钮disabled属性
    - _需求：5.4_
  
  - [x] 10.2 添加搜索模式提示
    - 搜索时显示Alert提示
    - 提供关闭搜索的快捷方式
    - _需求：5.2_
  
  - [x] 10.3 优化空状态提示
    - 搜索无结果时显示友好提示
    - 筛选无结果时显示友好提示
    - _需求：5.5_
  
  - [ ]* 10.4 编写单元测试验证UI反馈
    - 测试按钮状态
    - 测试提示显示
    - 测试空状态
    - _需求：5.4, 5.5_

- [ ] 11. 集成和测试
  - [x] 11.1 测试完整的关键词加载流程
    - 测试页面加载时关键词列表正确显示
    - 测试关键词列表包含所有关键词
    - _需求：1.1, 1.2_
  
  - [x] 11.2 测试完整的搜索流程
    - 测试搜索能找到所有匹配的话题
    - 测试搜索不受筛选条件限制
    - 测试搜索清空筛选条件
    - _需求：2.1, 2.2, 2.5_
  
  - [x] 11.3 测试筛选和搜索的互斥行为
    - 测试筛选清空搜索
    - 测试搜索清空筛选
    - 测试清除筛选的完整性
    - _需求：3.1, 3.2, 3.3_
  
  - [x] 11.4 测试统计信息的一致性
    - 测试筛选后统计信息正确
    - 测试搜索后统计信息正确
    - _需求：3.5_
  
  - [ ]* 11.5 编写属性测试验证统计信息一致性
    - **属性 8: 统计信息一致性**
    - **验证需求：3.5**

- [ ] 12. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. 性能优化和缓存
  - [x] 13.1 实现后端关键词列表缓存
    - 使用内存缓存（5分钟过期）
    - 新增蒸馏记录时清除缓存
    - _需求：1.1_
  
  - [x] 13.2 实现前端关键词列表缓存
    - 使用React Query或本地状态缓存
    - 缓存时间5分钟
    - _需求：1.1_
  
  - [x] 13.3 优化搜索查询性能
    - 验证数据库索引
    - 测试大数据量下的性能
    - _需求：2.1_

- [ ] 14. 文档和清理
  - [x] 14.1 更新API文档
    - 记录新增的/keywords端点
    - 记录/results端点的search参数
    - 添加使用示例
    - _需求：所有_
  
  - [x] 14.2 添加代码注释
    - 为关键逻辑添加注释
    - 为互斥行为添加说明
    - _需求：所有_
  
  - [x] 14.3 清理和优化代码
    - 移除未使用的代码
    - 统一代码风格
    - 优化性能
    - _需求：所有_
