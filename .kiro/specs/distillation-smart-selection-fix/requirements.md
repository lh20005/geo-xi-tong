# 需求文档

## 简介

本功能旨在修复蒸馏结果智能选择功能中的两个关键bug：

1. **重复使用问题**：在生成文章模块中，选择蒸馏历史后，系统反复使用其中一条蒸馏结果，而不能平均使用其他结果
2. **计数不同步问题**：生成文章后，不能将本次使用的蒸馏结果做计数记录，计数结果无法和"蒸馏结果"模块中"被引用次数"列同步更新

## 术语表

- **系统 (System)**: 指整个文章生成和蒸馏结果管理应用
- **蒸馏结果 (Distillation Result)**: 通过关键词蒸馏生成的话题列表
- **使用次数 (Usage Count)**: 某个蒸馏结果被用于文章生成的总次数
- **智能选择 (Smart Selection)**: 根据使用次数自动选择使用次数最少的N个蒸馏结果的算法

## 需求

### 需求 1：修复重复使用问题

**用户故事：** 作为用户，我希望在创建生成任务时，系统能够平均使用不同的蒸馏结果，而不是反复使用同一个蒸馏结果。

#### 验收标准

1. WHEN 用户创建生成N篇文章的任务 THEN 系统应当选择N个不同的蒸馏结果
2. WHEN 系统执行任务 THEN 系统应当为每篇文章使用不同的蒸馏结果
3. WHEN 系统生成第i篇文章 THEN 系统应当使用selected_distillation_ids[i]对应的蒸馏结果
4. WHEN 任务完成 THEN 系统应当确保每个预选的蒸馏结果都被使用了恰好一次
5. WHEN 系统记录日志 THEN 系统应当清晰记录每篇文章使用了哪个蒸馏结果

### 需求 2：修复使用计数同步问题

**用户故事：** 作为用户，我希望在生成文章后，系统能够正确更新蒸馏结果的使用计数，并在"蒸馏结果"模块中显示准确的"被引用次数"。

#### 验收标准

1. WHEN 系统保存文章 THEN 系统应当在同一事务中更新对应蒸馏结果的usage_count
2. WHEN 系统更新usage_count THEN 系统应当使用原子操作确保计数准确
3. WHEN 文章保存成功 THEN 系统应当确保usage_count增加1
4. WHEN 查询蒸馏结果列表 THEN 系统应当显示准确的被引用次数
5. WHEN 多个任务并发执行 THEN 系统应当确保usage_count更新的正确性

### 需求 3：验证和诊断工具

**用户故事：** 作为开发者，我需要工具来验证修复是否成功，以及诊断可能的数据不一致问题。

#### 验收标准

1. WHEN 开发者运行验证脚本 THEN 系统应当检查usage_count与实际使用记录的一致性
2. WHEN 发现不一致 THEN 系统应当报告详细的差异信息
3. WHEN 开发者运行修复脚本 THEN 系统应当重新计算所有usage_count
4. WHEN 修复完成 THEN 系统应当确保所有数据一致
5. WHEN 系统记录日志 THEN 系统应当包含足够的信息用于问题诊断

### 需求 4：日志增强

**用户故事：** 作为开发者，我需要详细的日志来追踪蒸馏结果的选择和使用情况，以便快速定位问题。

#### 验收标准

1. WHEN 系统选择蒸馏结果 THEN 系统应当记录选择的所有蒸馏结果ID和关键词
2. WHEN 系统为文章分配蒸馏结果 THEN 系统应当记录分配的蒸馏结果ID、关键词和文章索引
3. WHEN 系统更新usage_count THEN 系统应当记录更新前后的值
4. WHEN 系统保存文章 THEN 系统应当记录文章ID、蒸馏结果ID和关键词
5. WHEN 任务完成 THEN 系统应当记录每个蒸馏结果的使用情况统计
