# 实现计划：文章生成失败诊断与修复

- [x] 1. 创建诊断工具和接口
  - 实现诊断方法，检查任务配置的完整性
  - 创建诊断报告数据结构
  - 添加诊断API端点
  - _需求: 1.1_

- [ ] 2. 增强ArticleGenerationService错误处理
- [x] 2.1 添加配置验证方法
  - 实现validateTaskConfiguration方法
  - 验证所有引用的资源是否存在
  - 验证AI配置是否有效
  - _需求: 1.2, 1.3_

- [x] 2.2 重构executeTask方法
  - 添加详细的步骤日志
  - 实现容错的文章生成循环
  - 收集每篇文章的错误信息
  - 根据实际生成数量决定最终状态
  - _需求: 2.2, 2.3, 2.4, 3.1, 3.2, 3.3_

- [ ] 2.3 编写属性测试：错误记录完整性
  - **属性 1：错误记录完整性**
  - **验证：需求 1.2**

- [ ] 2.4 编写属性测试：失败状态正确性
  - **属性 2：失败状态正确性**
  - **验证：需求 1.3**

- [ ] 2.5 编写属性测试：错误恢复连续性
  - **属性 3：错误恢复连续性**
  - **验证：需求 2.2**

- [-] 3. 增强generateSingleArticle错误处理
  - 添加try-catch包装AI调用
  - 返回更详细的错误信息
  - 添加响应解析的错误处理
  - _需求: 3.1_

- [ ] 3.1 编写属性测试：文章持久化一致性
  - **属性 4：文章持久化一致性**
  - **验证：需求 3.2**

- [ ] 3.2 编写属性测试：计数器同步性
  - **属性 5：计数器同步性**
  - **验证：需求 3.3**

- [ ] 4. 实现任务重试功能
- [x] 4.1 添加retryTask方法
  - 重置任务状态为pending
  - 清空error_message和generated_count
  - 重新调用executeTask
  - _需求: 4.1, 4.2, 4.3_

- [x] 4.2 添加重试API端点
  - 创建POST /api/article-generation/tasks/:id/retry路由
  - 验证任务存在且可以重试
  - 返回重试结果
  - _需求: 4.1_

- [ ] 4.3 编写属性测试：重试状态重置
  - **属性 6：重试状态重置**
  - **验证：需求 4.2, 4.3**

- [ ] 5. 创建诊断脚本
  - 编写独立的诊断脚本用于调试
  - 输出任务状态和配置检查结果
  - 提供修复建议
  - _需求: 1.1_

- [ ] 6. 编写集成测试
  - 创建完整的测试数据
  - 测试端到端文章生成流程
  - 测试错误恢复场景
  - 测试重试功能
  - _需求: 3.1, 3.2, 3.3, 4.1_

- [ ] 7. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
