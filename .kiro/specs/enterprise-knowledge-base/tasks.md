# 企业知识库 - 实施任务列表

## 任务概述

本任务列表将指导完成企业知识库模块的开发，包括数据库设计、后端API、文档解析服务、前端界面以及AI集成。任务按照依赖关系排序，确保每个步骤都能在前一步的基础上进行。

---

## 第一阶段：数据库与基础设施

- [x] 1. 创建数据库表结构
  - 在`server/src/db/schema.sql`中添加`knowledge_bases`和`knowledge_documents`表定义
  - 创建必要的索引以优化查询性能
  - 添加外键约束确保数据完整性
  - _需求: 6.1, 6.2, 6.4_

- [x] 2. 设置文档解析依赖
  - 在`server/package.json`中添加`pdf-parse`、`mammoth`等文档解析库
  - 运行`npm install`安装依赖
  - _需求: 5.1, 5.2, 5.3, 5.4_

---

## 第二阶段：后端服务层

- [ ] 3. 实现文档解析服务
  - [x] 3.1 创建`DocumentParserService`类
    - 在`server/src/services/documentParser.ts`中创建服务类
    - 实现`parseFile`主方法，根据文件扩展名分发到具体解析器
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [x] 3.2 实现各格式解析器
    - 实现`parseTxt`方法处理纯文本文件
    - 实现`parseMarkdown`方法处理Markdown文件
    - 实现`parsePdf`方法使用pdf-parse提取PDF文本
    - 实现`parseWord`方法使用mammoth提取Word文档文本
    - 添加错误处理，对不支持的格式抛出明确错误
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 3.3 编写属性测试
    - **属性 10: 支持格式的完整性**
    - **验证: 需求 5.1, 5.2, 5.3, 5.4**
    - 使用fast-check生成各种支持格式的测试文件
    - 验证每种格式都能成功提取文本内容

- [ ] 4. 实现知识库服务
  - [x] 4.1 创建`KnowledgeBaseService`类
    - 在`server/src/services/knowledgeBaseService.ts`中创建服务类
    - 实现`getKnowledgeContext`方法，从数据库获取文档并格式化
    - 实现`formatForAI`方法，将文档内容组织成AI可理解的格式
    - _需求: 4.2, 4.3_

  - [x] 4.2 编写属性测试
    - **属性 7: AI上下文注入的正确性**
    - **验证: 需求 4.2, 4.3**
    - 生成随机知识库ID集合
    - 验证返回的上下文包含所有指定知识库的文档内容

---

## 第三阶段：后端API路由

- [ ] 5. 实现知识库管理API
  - [x] 5.1 创建知识库路由文件
    - 创建`server/src/routes/knowledgeBase.ts`
    - 配置multer中间件处理文件上传
    - 设置上传目录为`server/uploads/knowledge`（临时存储）
    - _需求: 2.1, 2.2_

  - [x] 5.2 实现知识库CRUD接口
    - 实现`GET /api/knowledge-bases`获取所有知识库
    - 实现`POST /api/knowledge-bases`创建知识库
    - 实现`GET /api/knowledge-bases/:id`获取知识库详情
    - 实现`PATCH /api/knowledge-bases/:id`更新知识库
    - 实现`DELETE /api/knowledge-bases/:id`删除知识库
    - 使用Zod验证输入数据
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 5.3 编写属性测试
    - **属性 1: 知识库创建后可检索**
    - **验证: 需求 1.2, 1.3**
    - 生成随机知识库名称
    - 验证创建后能够检索到相同名称的知识库

  - [x] 5.4 编写属性测试
    - **属性 5: 知识库删除的级联完整性**
    - **验证: 需求 1.5, 6.4**
    - 创建知识库并添加随机数量的文档
    - 验证删除知识库后所有文档也被删除

- [ ] 6. 实现文档管理API
  - [x] 6.1 实现文档上传接口
    - 实现`POST /api/knowledge-bases/:id/documents`上传文档
    - 使用multer接收文件，限制大小为10MB
    - 调用`DocumentParserService`提取文本内容
    - 使用事务将文档信息和内容存入数据库
    - 上传成功后删除临时文件
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 6.2 编写属性测试
    - **属性 2: 文档上传后内容可访问**
    - **验证: 需求 2.2, 2.4**
    - 生成随机文本内容并创建测试文件
    - 验证上传后能从数据库检索到相同内容

  - [x] 6.3 编写属性测试
    - **属性 3: 文件格式验证的一致性**
    - **验证: 需求 2.1, 5.5**
    - 生成不支持格式的文件名
    - 验证系统拒绝上传并返回错误

  - [x] 6.4 编写属性测试
    - **属性 4: 文件大小限制的强制执行**
    - **验证: 需求 2.3**
    - 生成超过10MB的文件大小
    - 验证系统拒绝上传并提示文件过大

  - [x] 6.5 实现文档查询和删除接口
    - 实现`GET /api/knowledge-bases/documents/:id`获取文档详情
    - 实现`DELETE /api/knowledge-bases/documents/:id`删除文档
    - 实现`GET /api/knowledge-bases/:id/documents/search`搜索文档
    - 使用PostgreSQL全文搜索功能
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 6.6 编写属性测试
    - **属性 6: 文档搜索的准确性**
    - **验证: 需求 3.5**
    - 生成随机搜索关键词
    - 验证返回的所有文档都包含该关键词

  - [x] 6.7 编写属性测试
    - **属性 8: 事务一致性**
    - **验证: 需求 6.2, 6.3**
    - 模拟文档解析失败的场景
    - 验证数据库中没有留下部分状态

- [x] 7. 注册知识库路由
  - 在`server/src/routes/index.ts`中导入并注册知识库路由
  - 确保路由前缀为`/api/knowledge-bases`
  - _需求: 所有API需求_

---

## 第四阶段：AI服务集成

- [ ] 8. 增强AI服务以支持知识库
  - [x] 8.1 修改`AIService.generateArticle`方法
    - 在`server/src/services/aiService.ts`中添加`knowledgeContext`可选参数
    - 修改prompt构建逻辑，在有知识上下文时注入到prompt中
    - 确保知识库内容在prompt中的位置合理
    - _需求: 4.2, 4.3_

  - [x] 8.2 修改文章生成API
    - 在`server/src/routes/article.ts`的`POST /api/articles/generate`中添加`knowledgeBaseIds`参数
    - 如果提供了`knowledgeBaseIds`，调用`KnowledgeBaseService`获取知识上下文
    - 将知识上下文传递给`AIService.generateArticle`
    - _需求: 4.1, 4.2, 4.3_

---

## 第五阶段：前端界面开发

- [ ] 9. 创建知识库列表页面
  - [x] 9.1 创建`KnowledgeBasePage`组件
    - 创建`client/src/pages/KnowledgeBasePage.tsx`
    - 实现状态管理（知识库列表、加载状态、模态框状态）
    - 实现`loadKnowledgeBases`函数调用API获取列表
    - _需求: 1.3, 7.1_

  - [x] 9.2 实现知识库列表UI
    - 使用Ant Design的Card和Grid组件展示知识库
    - 显示知识库名称、描述、文档数量、创建时间
    - 添加"新建知识库"按钮
    - 实现空状态提示
    - _需求: 1.3, 7.1, 7.2_

  - [x] 9.3 实现创建知识库功能
    - 创建模态框，包含名称和描述输入框
    - 实现`handleCreateKnowledgeBase`函数调用API
    - 添加表单验证
    - 显示成功/失败消息
    - _需求: 1.1, 1.2, 7.3, 7.4_

  - [x] 9.4 实现编辑和删除功能
    - 为每个知识库卡片添加编辑和删除按钮
    - 实现编辑模态框修改名称和描述
    - 实现删除确认对话框
    - 调用相应的API接口
    - _需求: 1.4, 1.5, 7.3, 7.4_

- [ ] 10. 创建知识库详情页面
  - [x] 10.1 创建`KnowledgeBaseDetailPage`组件
    - 创建`client/src/pages/KnowledgeBaseDetailPage.tsx`
    - 使用`useParams`获取知识库ID
    - 实现状态管理（文档列表、选中文档、模态框状态）
    - 实现`loadDocuments`函数获取文档列表
    - _需求: 3.1, 3.2_

  - [x] 10.2 实现文档上传功能
    - 使用Ant Design的Upload组件
    - 配置文件类型限制（.txt, .md, .pdf, .doc, .docx）
    - 配置文件大小限制（10MB）
    - 支持多文件上传
    - 显示上传进度
    - _需求: 2.1, 2.2, 2.3, 8.2_

  - [x] 10.3 实现文档列表UI
    - 使用Table或List组件展示文档
    - 显示文件名、文件类型、大小、上传时间
    - 显示内容预览（前200字符）
    - 添加查看、删除按钮
    - _需求: 3.1, 3.4, 8.5_

  - [x] 10.4 编写属性测试
    - **属性 9: 内容预览的截断正确性**
    - **验证: 需求 8.5**
    - 生成不同长度的文档内容
    - 验证超过200字符的内容被正确截断

  - [x] 10.5 实现文档查看功能
    - 创建文档查看模态框
    - 显示完整的文档内容
    - 添加复制内容按钮
    - _需求: 3.2, 3.3_

  - [x] 10.6 实现文档搜索功能
    - 添加搜索输入框
    - 实现防抖搜索
    - 调用搜索API
    - 高亮搜索关键词
    - _需求: 3.5_

  - [x] 10.7 实现文档删除功能
    - 添加删除确认对话框
    - 调用删除API
    - 刷新文档列表
    - _需求: 3.3_

- [x] 11. 更新侧边栏导航
  - 在`client/src/components/Layout/Sidebar.tsx`中添加"企业知识库"菜单项
  - 使用`BookOutlined`图标
  - 放置在"企业图库"下方
  - 路由路径为`/knowledge-base`
  - _需求: 7.1_

- [x] 12. 配置前端路由
  - 在`client/src/App.tsx`中添加知识库相关路由
  - 添加`/knowledge-base`路由指向`KnowledgeBasePage`
  - 添加`/knowledge-base/:id`路由指向`KnowledgeBaseDetailPage`
  - _需求: 7.1_

---

## 第六阶段：文章生成页面集成

- [ ] 13. 增强文章生成页面
  - [x] 13.1 添加知识库选择器
    - 在`client/src/pages/ArticlePage.tsx`中添加知识库选择状态
    - 在页面加载时获取可用知识库列表
    - 在文章要求输入框上方添加知识库多选框
    - 使用Ant Design的Select组件（mode="multiple"）
    - _需求: 4.1_

  - [x] 13.2 显示知识库信息
    - 显示每个知识库的文档数量
    - 添加提示文本说明知识库的作用
    - 实现知识库选择的视觉反馈
    - _需求: 4.1, 7.3_

  - [x] 13.3 修改文章生成逻辑
    - 在调用生成API时包含`knowledgeBaseIds`参数
    - 处理知识库相关的错误（如知识库不存在）
    - 在生成成功后显示使用了哪些知识库
    - _需求: 4.2, 4.3, 4.4_

---

## 第七阶段：测试与优化

- [x] 14. 数据库性能优化
  - 验证所有索引已正确创建
  - 测试大量文档时的查询性能
  - 优化全文搜索查询
  - _需求: 8.1, 8.3_

- [ ] 15. 前端性能优化
  - [x] 15.1 实现文档列表分页
    - 在文档列表中添加分页组件
    - 每页显示20个文档
    - 实现前端分页或后端分页
    - _需求: 8.1_

  - [x] 15.2 优化大文件上传体验
    - 显示上传进度条
    - 实现上传取消功能
    - 添加上传队列管理
    - _需求: 8.2_

- [x] 16. 集成测试
  - 测试完整的知识库创建和文档上传流程
  - 测试知识库与AI生成文章的集成
  - 测试并发上传多个文档
  - 测试删除知识库的级联删除
  - _需求: 所有需求_

---

## 第八阶段：文档与部署

- [x] 17. 运行数据库迁移
  - 执行`npm run db:migrate`创建新表
  - 验证表和索引已正确创建
  - 测试外键约束
  - _需求: 6.1, 6.4_

- [x] 18. 更新项目文档
  - 在`docs/项目总览.md`中添加企业知识库功能说明
  - 更新API接口文档
  - 添加使用示例和截图
  - _需求: 所有需求_

- [x] 19. 最终检查点
  - 确保所有测试通过
  - 验证所有功能正常工作
  - 检查错误处理和用户提示
  - 测试不同浏览器的兼容性
  - 询问用户是否有问题或需要调整

---

## 任务完成标准

每个任务完成时应满足：
1. 代码已编写并通过TypeScript类型检查
2. 相关的属性测试已编写并通过（如果标记为必需）
3. 功能已在本地环境测试验证
4. 代码符合项目的编码规范
5. 添加了必要的错误处理和用户提示

## 注意事项

- 所有任务（包括测试任务）都是必需的，以确保全面的测试覆盖
- 每个阶段完成后建议进行一次集成测试
- 遇到问题时及时记录并寻求帮助
- 保持代码风格与现有项目一致
