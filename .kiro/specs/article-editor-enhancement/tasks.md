# 实现计划

- [x] 1. 数据库迁移 - 添加发布状态字段
  - 创建迁移脚本 add_publication_status.sql
  - 为articles表添加 is_published (BOOLEAN, 默认false) 和 published_at (TIMESTAMP) 字段
  - 创建索引 idx_articles_is_published 和 idx_articles_published_at
  - 运行迁移并验证数据库schema
  - _需求: 4.4, 4.5, 5.5_

- [x] 1.1 编写属性测试 - 新文章默认状态
  - **属性 8: 新文章默认状态**
  - **验证需求: 4.4**

- [x] 2. 后端API - 扩展文章更新端点
  - 修改 PUT /articles/:id 端点以支持HTML格式的富文本内容
  - 更新ArticleService.updateArticle()方法
  - 添加内容验证（标题和内容非空）
  - 确保updated_at字段自动更新
  - _需求: 2.5, 2.6_

- [x] 2.1 编写属性测试 - 内容往返一致性
  - **属性 2: 内容往返一致性**
  - **验证需求: 2.5, 2.6**

- [x] 2.2 编写单元测试 - 文章更新端点
  - 测试成功更新文章
  - 测试无效ID返回404
  - 测试空内容验证失败
  - 测试updated_at字段更新
  - _需求: 2.5_

- [x] 3. 后端API - 发布状态管理端点
  - 创建 PUT /articles/:id/publish 端点
  - 实现ArticleService.publishArticle()方法
  - 当is_published设为true时，设置published_at为当前时间
  - 返回更新后的文章对象（包含发布状态和时间）
  - _需求: 5.1, 5.2, 5.3, 5.6_

- [x] 3.1 编写属性测试 - 状态更新时间记录
  - **属性 9: 状态更新时间记录**
  - **验证需求: 4.5**

- [x] 3.2 编写属性测试 - 无效ID拒绝
  - **属性 10: 无效ID拒绝**
  - **验证需求: 5.2**

- [x] 3.3 编写属性测试 - 发布响应完整性
  - **属性 11: 发布响应完整性**
  - **验证需求: 5.3**

- [x] 3.4 编写属性测试 - API错误处理
  - **属性 13: API错误处理**
  - **验证需求: 5.6**

- [x] 3.5 编写单元测试 - 发布状态端点
  - 测试发布文章（is_published: true）
  - 测试取消发布（is_published: false）
  - 测试无效ID返回404
  - 测试响应包含所有必需字段
  - _需求: 5.1, 5.2, 5.3_

- [x] 4. 后端API - 智能排版端点
  - 创建 POST /articles/:id/smart-format 端点
  - 实现ArticleService.smartFormat()方法
  - 提取HTML内容为纯文本
  - 调用AIService.formatArticle()进行排版
  - 处理图片占位符，将图片插入第一段后
  - 将排版后的文本转换回HTML格式
  - 添加30秒超时和错误处理
  - _需求: 3.2, 3.3, 3.4, 3.7_

- [x] 4.1 扩展AIService - 添加智能排版方法
  - 在AIService类中添加formatArticle()方法
  - 设计新闻稿格式的prompt（导语、段落结构、图片占位符）
  - 使用现有的callAI()方法调用大模型
  - 处理AI服务错误和超时
  - _需求: 3.2, 3.3, 3.4_

- [x] 4.2 编写属性测试 - 智能排版API调用
  - **属性 3: 智能排版API调用**
  - **验证需求: 3.2**

- [x] 4.3 编写属性测试 - 图片位置规则
  - **属性 4: 图片位置规则**
  - **验证需求: 3.4**

- [x] 4.4 编写属性测试 - 排版失败内容不变
  - **属性 5: 排版失败内容不变**
  - **验证需求: 3.7**

- [x] 4.5 编写单元测试 - 智能排版功能
  - 测试成功排版（使用mock AI服务）
  - 测试图片占位符处理
  - 测试AI服务失败时的错误处理
  - 测试超时处理
  - _需求: 3.2, 3.4, 3.7_

- [x] 5. 后端API - 更新查询端点返回发布状态
  - 修改 GET /articles 端点，在响应中包含 isPublished 和 publishedAt 字段
  - 修改 GET /articles/:id 端点，在响应中包含发布状态字段
  - 确保字段命名使用camelCase（与前端一致）
  - _需求: 5.4_

- [x] 5.1 编写属性测试 - 查询响应包含发布状态
  - **属性 12: 查询响应包含发布状态**
  - **验证需求: 5.4**

- [x] 5.2 编写单元测试 - 查询端点
  - 测试GET /articles返回发布状态字段
  - 测试GET /articles/:id返回发布状态字段
  - 测试字段命名格式正确
  - _需求: 5.4_

- [x] 6. 检查点 - 确保所有后端测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 7. 前端 - 修改ArticleListPage组件
  - 在操作列添加独立的"编辑"按钮（使用EditOutlined图标）
  - 添加"发布状态"列到表格配置中
  - 实现发布状态的渲染逻辑（未发布显示"草稿"Tag，已发布显示"已发布"Tag和时间）
  - 移除"查看"模态框中的编辑功能
  - 更新handleView函数，使其仅用于只读查看
  - _需求: 1.1, 1.2, 1.3, 4.1, 4.2, 4.3_

- [x] 7.1 编写属性测试 - 未发布文章显示规则
  - **属性 6: 未发布文章显示规则**
  - **验证需求: 4.2**

- [x] 7.2 编写属性测试 - 已发布文章显示规则
  - **属性 7: 已发布文章显示规则**
  - **验证需求: 4.3**

- [x] 7.3 编写单元测试 - ArticleListPage组件
  - 测试操作列包含"编辑"按钮
  - 测试"发布状态"列正确显示
  - 测试"查看"模式不包含编辑功能
  - 测试发布状态标签渲染
  - _需求: 1.1, 1.3, 4.1, 4.2, 4.3_

- [x] 8. 前端 - 创建ArticleEditorModal组件
  - 创建新组件 client/src/components/ArticleEditorModal.tsx
  - 集成React-Quill富文本编辑器
  - 配置工具栏（字体、字号、粗体、斜体、下划线、颜色、对齐、列表、图片）
  - 实现编辑/预览标签页切换
  - 添加"智能排版"按钮到工具栏
  - 实现表单验证（标题和内容非空）
  - 添加保存和取消按钮
  - _需求: 1.2, 1.4, 2.1, 2.3, 3.1_

- [x] 8.1 安装依赖
  - 安装 react-quill 和 @types/react-quill
  - 安装 dompurify 和 @types/dompurify（用于XSS防护）
  - 在package.json中添加依赖
  - _需求: 2.1_

- [x] 8.2 编写属性测试 - 编辑器内容加载完整性
  - **属性 1: 编辑器内容加载完整性**
  - **验证需求: 1.4**

- [x] 8.3 编写单元测试 - ArticleEditorModal组件
  - 测试组件渲染
  - 测试富文本编辑器工具栏存在
  - 测试智能排版按钮存在
  - 测试编辑/预览标签切换
  - 测试表单验证
  - _需求: 1.2, 2.1, 3.1_

- [x] 9. 前端 - 实现编辑器保存功能
  - 在ArticleEditorModal中实现handleSave函数
  - 调用 PUT /articles/:id API保存富文本内容
  - 使用DOMPurify清理HTML内容（XSS防护）
  - 显示保存成功/失败消息
  - 保存成功后关闭模态框并刷新列表
  - 处理网络错误和验证错误
  - _需求: 2.5_

- [x] 9.1 编写单元测试 - 保存功能
  - 测试成功保存
  - 测试验证失败
  - 测试网络错误处理
  - 测试HTML内容清理
  - _需求: 2.5_

- [x] 10. 前端 - 实现智能排版功能
  - 在ArticleEditorModal中实现handleSmartFormat函数
  - 调用 POST /articles/:id/smart-format API
  - 显示加载状态（禁用编辑器和按钮）
  - 排版完成后更新编辑器内容
  - 处理超时和错误（显示错误消息，保持原内容）
  - _需求: 3.2, 3.5, 3.6, 3.7_

- [x] 10.1 编写单元测试 - 智能排版UI
  - 测试点击按钮触发API调用
  - 测试加载状态显示
  - 测试成功后内容更新
  - 测试失败时错误处理
  - _需求: 3.5, 3.6, 3.7_

- [x] 11. 前端 - 实现预览功能
  - 在ArticleEditorModal中添加预览标签页
  - 使用ArticleContent组件渲染预览
  - 确保预览使用与查看模式相同的渲染逻辑
  - 实时同步编辑器内容到预览
  - _需求: 6.2, 6.3_

- [x] 11.1 编写属性测试 - 预览渲染一致性
  - **属性 14: 预览渲染一致性**
  - **验证需求: 6.2**

- [x] 11.2 编写单元测试 - 预览功能
  - 测试预览标签存在
  - 测试预览内容渲染
  - 测试使用ArticleContent组件
  - _需求: 6.2, 6.3_

- [x] 12. 前端 - 集成ArticleEditorModal到ArticleListPage
  - 在ArticleListPage中导入ArticleEditorModal
  - 添加状态管理（editModal, editArticle）
  - 实现handleEdit函数（加载文章并打开编辑器）
  - 将编辑按钮连接到handleEdit
  - 实现onSave回调（保存后刷新列表）
  - _需求: 1.2, 1.4_

- [x] 12.1 编写单元测试 - 编辑器集成
  - 测试点击编辑按钮打开模态框
  - 测试文章数据正确传递
  - 测试保存后列表刷新
  - _需求: 1.2, 1.4_

- [x] 13. 前端API客户端 - 添加新端点
  - 在 client/src/api/client.ts 或相关API文件中添加：
    - publishArticle(id, isPublished) 方法
    - smartFormatArticle(id, content, imageUrl) 方法
  - 确保错误处理和类型定义
  - _需求: 5.1, 3.2_

- [x] 13.1 编写单元测试 - API客户端
  - 测试publishArticle方法
  - 测试smartFormatArticle方法
  - 测试错误处理
  - _需求: 5.1, 3.2_

- [x] 14. 检查点 - 确保所有前端测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 集成测试 - 端到端编辑流程
  - 创建集成测试文件
  - 测试完整编辑流程：打开编辑器 → 修改内容 → 保存 → 验证更新
  - 测试智能排版流程：加载文章 → 点击智能排版 → 验证结果
  - 测试发布流程：创建文章 → 发布 → 验证状态
  - _需求: 所有需求_

- [x] 15.1 编写集成测试
  - 测试编辑和保存流程
  - 测试智能排版流程
  - 测试发布状态更新流程
  - 测试错误场景
  - _需求: 所有需求_

- [x] 16. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
