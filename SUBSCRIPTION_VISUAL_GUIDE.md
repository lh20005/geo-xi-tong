# 商品订阅系统 - 可视化指南

## 页面导航

```
┌─────────────────────────────────────────────────────────────┐
│  GEO优化系统                                    [用户头像 ▼] │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐                                                │
│  │ 侧边栏   │                                                │
│  │          │                                                │
│  │ 工作台   │                                                │
│  │ ...      │                                                │
│  │ 商品管理 │ ← 管理员专属                                   │
│  │ 系统配置 │                                                │
│  └──────────┘                                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘

用户头像下拉菜单：
├─ 个人中心 ← 新增
├─ 个人设置
└─ 返回主页
```

## 1. 商品管理页面（管理员）

**路径**: `/products`  
**权限**: 仅管理员可访问

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  商品管理                                                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 套餐名称    │ 价格      │ 计费周期 │ 功能配额 │ 操作   ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 体验版      │ ¥0.00    │ 月付     │ 10篇/天  │ 编辑   ││
│  │             │          │          │ 20篇/天  │ 历史   ││
│  │             │          │          │ 1个账号  │        ││
│  │             │          │          │ 50关键词 │        ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 专业版      │ ¥99.00   │ 月付     │ 100篇/天 │ 编辑   ││
│  │             │          │          │ 200篇/天 │ 历史   ││
│  │             │          │          │ 3个账号  │        ││
│  │             │          │          │ 500关键词│        ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 企业版      │ ¥299.00  │ 月付     │ 无限制   │ 编辑   ││
│  │             │          │          │ 无限制   │ 历史   ││
│  │             │          │          │ 10个账号 │        ││
│  │             │          │          │ 无限制   │        ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 编辑对话框

```
┌─────────────────────────────────────────┐
│  编辑套餐 - 专业版                      │
├─────────────────────────────────────────┤
│                                         │
│  价格（元）                             │
│  ┌─────────────────────────────────┐   │
│  │ 99.00                           │   │
│  └─────────────────────────────────┘   │
│                                         │
│  启用状态                               │
│  ┌─────┐                               │
│  │ ON  │ 启用 / 停用                   │
│  └─────┘                               │
│                                         │
│  每日生成文章数（-1表示无限制）         │
│  ┌─────────────────────────────────┐   │
│  │ 100                             │   │
│  └─────────────────────────────────┘   │
│                                         │
│  每日发布文章数（-1表示无限制）         │
│  ┌─────────────────────────────────┐   │
│  │ 200                             │   │
│  └─────────────────────────────────┘   │
│                                         │
│  可管理平台账号数（-1表示无限制）       │
│  ┌─────────────────────────────────┐   │
│  │ 3                               │   │
│  └─────────────────────────────────┘   │
│                                         │
│  关键词蒸馏数（-1表示无限制）           │
│  ┌─────────────────────────────────┐   │
│  │ 500                             │   │
│  └─────────────────────────────────┘   │
│                                         │
│         [取消]          [确定]          │
└─────────────────────────────────────────┘
```

### 配置历史对话框

```
┌─────────────────────────────────────────────────────────────┐
│  配置历史 - 专业版                                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 时间        │ 类型 │ 字段 │ 旧值 │ 新值 │ 操作人 │ 操作 ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 2025-12-25  │ 价格 │price │ 89  │ 99  │ admin │ 回滚 ││
│  │ 11:00:00    │      │      │     │     │       │      ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 2025-12-24  │ 功能 │art.. │ 80  │ 100 │ admin │ 回滚 ││
│  │ 15:30:00    │      │      │     │     │       │      ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│                          [关闭]                               │
└─────────────────────────────────────────────────────────────┘
```

## 2. 用户个人中心页面

**路径**: `/user-center`  
**权限**: 所有登录用户

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  👑 我的订阅                    [关闭自动续费] [升级套餐]    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 当前套餐 │  │ 到期时间 │  │ 订阅状态 │  │ 自动续费 │   │
│  │          │  │          │  │          │  │          │   │
│  │ 专业版   │  │2026-01-25│  │  正常    │  │ 已开启   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                               │
│  ⚠️ 还有 7 天到期                                            │
│                                                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  使用统计                                          [刷新]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 每日生成文章数                          每日重置         ││
│  │ ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  5 / 100         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 每日发布文章数                          每日重置         ││
│  │ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0 / 200         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 可管理平台账号数                        永久             ││
│  │ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0 / 3           ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 关键词蒸馏数                            每月重置         ││
│  │ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0 / 500         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  📋 订单记录                                       [刷新]     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 订单号    │ 套餐   │ 金额    │ 状态   │ 创建时间       ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 20251225..│ 专业版 │ ¥99.00 │ 已支付 │ 2025-12-25    ││
│  │           │        │        │        │ 10:30:00      ││
│  ├─────────────────────────────────────────────────────────┤│
│  │ 20251220..│ 体验版 │ ¥0.00  │ 已支付 │ 2025-12-20    ││
│  │           │        │        │        │ 15:00:00      ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│                      [1] 2 3 4 5 >                            │
└─────────────────────────────────────────────────────────────┘
```

### 进度条颜色说明

```
绿色（0-70%）:  ████████████████████████░░░░░░░░░░░░░░░░
橙色（70-90%）: ████████████████████████████████░░░░░░░░
红色（90-100%）:████████████████████████████████████████

配额预警（90%以上）：
⚠️ 配额即将用完，建议升级套餐
```

## 3. 数据流程图

### 购买流程

```
用户选择套餐
    ↓
创建订单（POST /api/orders）
    ↓
调用微信支付 API
    ↓
返回支付参数给前端
    ↓
用户在微信中支付
    ↓
微信回调（POST /api/payment/wechat/notify）
    ↓
验证签名 ✓
    ↓
更新订单状态
    ↓
开通订阅（使用事务）
    ↓
返回成功 ✓
```

### 配额检查流程

```
用户请求功能
    ↓
checkQuota 中间件
    ↓
获取用户订阅
    ↓
获取套餐配额
    ↓
查询当前使用量
    ↓
判断是否超额？
    ├─ 是 → 拒绝请求 ✗
    └─ 否 → 允许请求 ✓
         ↓
    记录使用量
```

### 配置管理流程

```
管理员修改配置
    ↓
验证管理员权限 ✓
    ↓
验证输入有效性 ✓
    ↓
检查价格变动幅度
    ├─ >20% → 需要确认？
    │         ├─ 是 → 返回确认请求
    │         └─ 否 → 继续
    └─ ≤20% → 继续
         ↓
使用事务更新配置
    ↓
记录配置历史
    ↓
清除缓存
    ↓
通知所有管理员 ✓
```

## 4. 权限控制

```
┌─────────────────────────────────────────┐
│  页面/功能              │ 普通用户 │ 管理员 │
├─────────────────────────────────────────┤
│  商品管理页面           │    ✗    │   ✓   │
│  个人中心页面           │    ✓    │   ✓   │
│  查看套餐列表           │    ✓    │   ✓   │
│  创建订单               │    ✓    │   ✓   │
│  查看订单列表           │    ✓    │   ✓   │
│  查看使用统计           │    ✓    │   ✓   │
│  切换自动续费           │    ✓    │   ✓   │
│  更新套餐配置           │    ✗    │   ✓   │
│  查看配置历史           │    ✗    │   ✓   │
│  回滚配置               │    ✗    │   ✓   │
└─────────────────────────────────────────┘
```

## 5. API 端点总览

### 用户 API（需要登录）

```
GET    /api/subscription/plans          获取所有套餐
GET    /api/subscription/current        获取当前订阅
GET    /api/subscription/usage-stats    获取使用统计
PUT    /api/subscription/auto-renew     切换自动续费

POST   /api/orders                      创建订单
GET    /api/orders                      获取订单列表
GET    /api/orders/:orderNo/status      查询订单状态

POST   /api/payment/wechat/notify       微信支付回调
```

### 管理员 API（需要管理员权限）

```
GET    /api/admin/products              获取所有套餐
PUT    /api/admin/products/:id          更新套餐配置
GET    /api/admin/products/:id/history  获取配置历史
POST   /api/admin/products/:id/rollback 回滚配置
```

## 6. 数据库表关系

```
┌─────────────────┐
│subscription_plans│ 套餐配置表
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│  plan_features  │ 功能配额表
└─────────────────┘

┌─────────────────┐
│subscription_plans│
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│user_subscriptions│ 用户订阅表
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│    user_usage   │ 使用量统计表
└─────────────────┘

┌─────────────────┐
│subscription_plans│
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│     orders      │ 订单表
└─────────────────┘

┌─────────────────┐
│subscription_plans│
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│product_config_  │ 配置历史表
│    history      │
└─────────────────┘
```

## 7. 缓存策略

```
┌─────────────────────────────────────────┐
│  Redis 缓存                              │
├─────────────────────────────────────────┤
│                                          │
│  Key: plan_config:{plan_code}           │
│  TTL: 3600 秒（1小时）                   │
│  Value: 套餐配置 JSON                    │
│                                          │
│  更新时机：                              │
│  - 套餐配置更新后清除                    │
│  - 配置回滚后清除                        │
│                                          │
│  降级策略：                              │
│  - Redis 不可用时查询数据库              │
│  - 不影响核心功能                        │
│                                          │
└─────────────────────────────────────────┘
```

## 8. 安全措施

```
┌─────────────────────────────────────────┐
│  安全层级                                │
├─────────────────────────────────────────┤
│                                          │
│  1. JWT 认证                             │
│     - 所有用户 API 需要 token            │
│     - Token 过期自动刷新                 │
│                                          │
│  2. 权限验证                             │
│     - 管理员 API 需要 admin 角色         │
│     - 前端路由权限控制                   │
│                                          │
│  3. 微信支付签名验证                     │
│     - 验证回调签名                       │
│     - 防止伪造回调                       │
│                                          │
│  4. 审计日志                             │
│     - 记录操作人、时间、IP               │
│     - 记录变更内容                       │
│                                          │
│  5. 二次确认                             │
│     - 价格变动 >20% 需要确认             │
│     - 配置回滚需要确认                   │
│                                          │
│  6. 幂等性处理                           │
│     - 支付回调防止重复开通               │
│     - 订单号唯一性保证                   │
│                                          │
│  7. 数据库事务                           │
│     - 订单和订阅开通原子性               │
│     - 配置更新原子性                     │
│                                          │
└─────────────────────────────────────────┘
```

## 9. 用户体验优化

```
┌─────────────────────────────────────────┐
│  UX 特性                                 │
├─────────────────────────────────────────┤
│                                          │
│  1. 进度条可视化                         │
│     - 绿色（0-70%）                      │
│     - 橙色（70-90%）                     │
│     - 红色（90-100%）                    │
│                                          │
│  2. 配额预警                             │
│     - 90% 以上显示升级提示               │
│     - 到期前 7 天显示续费提醒            │
│                                          │
│  3. 加载状态                             │
│     - 所有异步操作显示 Loading           │
│     - 防止重复提交                       │
│                                          │
│  4. 错误提示                             │
│     - 友好的错误信息                     │
│     - 操作成功提示                       │
│                                          │
│  5. 响应式设计                           │
│     - 适配不同屏幕尺寸                   │
│     - 移动端友好                         │
│                                          │
│  6. 实时刷新                             │
│     - 手动刷新按钮                       │
│     - 未来支持 WebSocket 推送            │
│                                          │
└─────────────────────────────────────────┘
```

## 10. 测试场景

### 管理员测试场景

```
场景 1: 修改套餐价格（小幅变动）
1. 登录管理员账号
2. 访问商品管理页面
3. 点击"编辑"按钮
4. 修改价格（变动 <20%）
5. 点击"确定"
6. ✓ 配置立即生效

场景 2: 修改套餐价格（大幅变动）
1. 登录管理员账号
2. 访问商品管理页面
3. 点击"编辑"按钮
4. 修改价格（变动 >20%）
5. 点击"确定"
6. ✓ 显示二次确认对话框
7. 点击"确认"
8. ✓ 配置生效

场景 3: 查看配置历史
1. 登录管理员账号
2. 访问商品管理页面
3. 点击"历史"按钮
4. ✓ 显示所有配置变更记录

场景 4: 回滚配置
1. 登录管理员账号
2. 访问商品管理页面
3. 点击"历史"按钮
4. 点击某条记录的"回滚"按钮
5. ✓ 显示确认对话框
6. 点击"确认"
7. ✓ 配置回滚成功
```

### 用户测试场景

```
场景 1: 查看订阅信息
1. 登录用户账号
2. 点击右上角用户头像
3. 点击"个人中心"
4. ✓ 显示当前订阅信息

场景 2: 切换自动续费
1. 访问个人中心
2. 点击"关闭自动续费"按钮
3. ✓ 自动续费状态更新

场景 3: 查看使用统计
1. 访问个人中心
2. 滚动到使用统计卡片
3. ✓ 显示所有功能的使用量和配额
4. ✓ 进度条颜色正确

场景 4: 查看订单记录
1. 访问个人中心
2. 滚动到订单记录卡片
3. ✓ 显示订单列表
4. 点击分页按钮
5. ✓ 分页正常工作
```

## 总结

商品订阅系统的前端页面已经完整实现，包括：
- ✅ 管理员商品管理页面（编辑、历史、回滚）
- ✅ 用户个人中心页面（订阅、统计、订单）
- ✅ 完善的权限控制和安全措施
- ✅ 友好的用户体验和交互设计

系统已经可以投入使用！🎉
