# 测试存储空间配额调整和同步

## 修复内容

### 问题1：用户管理中调整配额时，存储空间没有单位
✅ **已修复**：在配额调整模态框中添加 MB 单位显示

**修改文件**：`client/src/components/UserSubscription/AdjustQuotaModal.tsx`

**修复内容**：
1. 输入框添加 "MB" 后缀
2. 标签显示 "新配额值 (MB)"
3. 提示文本说明单位为 MB
4. 下拉选项中格式化显示存储空间（自动转换 GB）
5. 当前配额信息中格式化显示存储空间

### 问题2：调整存储空间配额后，个人中心没有同步更新
✅ **已修复**：添加 WebSocket 通知机制

**修改文件**：`server/src/services/UserSubscriptionManagementService.ts`

**修复内容**：
- 在 `adjustQuota` 方法中，当调整存储空间配额时，额外发送 `storage_quota_changed` 事件
- 个人中心已经监听此事件，会自动刷新存储数据

## 测试步骤

### 1. 测试配额调整界面的单位显示

1. 登录管理员账号
2. 进入"用户管理"页面
3. 点击任意用户的"订阅详情"
4. 点击"调整配额"按钮
5. 在功能下拉框中选择"存储空间"

**预期结果**：
- ✅ 下拉选项显示：`存储空间 (当前: 100 MB, 已用: 10 MB)` 或 `(当前: 1.5 GB, 已用: 500 MB)`
- ✅ 输入框标签显示：`新配额值 (MB)`
- ✅ 输入框右侧显示 "MB" 后缀
- ✅ 提示文本：`-1 表示无限制，单位为 MB（1024 MB = 1 GB）`
- ✅ 当前配额信息卡片中，配额和使用量都显示单位（MB 或 GB）

### 2. 测试配额调整后的同步

**准备工作**：
```bash
# 1. 启动后端服务
cd server
npm run dev

# 2. 启动前端服务
cd client
npm run dev
```

**测试流程**：

1. **打开两个浏览器窗口**：
   - 窗口A：管理员账号，进入"用户管理"
   - 窗口B：普通用户账号（testuser），进入"个人中心" > "存储空间"标签页

2. **记录初始状态**：
   - 在窗口B中查看当前存储配额（例如：100 MB）
   - 记录当前使用量

3. **调整配额**：
   - 在窗口A中，找到 testuser
   - 点击"订阅详情" > "调整配额"
   - 选择"存储空间"
   - 输入新配额值：`200`（会自动显示为 200 MB）
   - 输入调整原因：`测试配额同步`
   - 点击"确认"

4. **验证同步**：
   - 在窗口B中，**无需刷新页面**
   - 应该看到：
     - ✅ 弹出提示：`存储配额已更新`
     - ✅ 存储配额自动更新为 200 MB
     - ✅ 进度条和百分比自动更新
     - ✅ 可用空间自动更新

### 3. 测试不同配额值的显示

在配额调整界面测试以下值：

| 输入值 | 预期显示 |
|--------|----------|
| 100 | 100 MB |
| 512 | 512 MB |
| 1024 | 1.0 GB |
| 2048 | 2.0 GB |
| 1536 | 1.5 GB |
| -1 | 无限制 |

### 4. 测试 WebSocket 连接

**检查 WebSocket 事件**：

打开浏览器控制台（F12），在调整配额后应该看到：

```javascript
// 窗口B（用户个人中心）的控制台输出
[UserCenter] 配额变更: {
  userId: 123,
  newQuotaMB: 200,
  oldQuotaMB: 100
}
```

## 验证清单

- [ ] 配额调整下拉框中，存储空间显示 MB/GB 单位
- [ ] 配额调整输入框显示 "MB" 后缀
- [ ] 配额调整输入框标签显示 "(MB)"
- [ ] 当前配额信息卡片中显示格式化的存储空间
- [ ] 调整配额后，用户个人中心自动更新（无需刷新）
- [ ] 调整配额后，显示"存储配额已更新"提示
- [ ] 存储使用卡片中的配额、使用量、可用空间都正确更新
- [ ] 存储使用进度条和百分比正确更新
- [ ] 大于 1024 MB 的值自动显示为 GB

## 技术细节

### WebSocket 事件流

```
管理员调整配额
    ↓
UserSubscriptionManagementService.adjustQuota()
    ↓
发送两个 WebSocket 事件：
  1. quota:adjusted (通用配额调整事件)
  2. storage_quota_changed (存储专用事件)
    ↓
用户个人中心监听 storage_quota_changed
    ↓
调用 fetchStorageData() 刷新存储数据
    ↓
UI 自动更新
```

### 单位转换逻辑

```typescript
// 格式化显示
if (value >= 1024) {
  return `${(value / 1024).toFixed(1)} GB`;
} else {
  return `${value} MB`;
}
```

## 常见问题

### Q1: 调整配额后，个人中心没有更新？
**A**: 检查以下几点：
1. WebSocket 连接是否正常（查看控制台）
2. 用户是否在"存储空间"标签页
3. 浏览器是否阻止了 WebSocket 连接

### Q2: 输入 1024 显示为 1024 MB 而不是 1 GB？
**A**: 这是正常的，输入框显示原始值（MB），只有在显示配额信息时才会自动转换为 GB

### Q3: 如何测试 WebSocket 断线重连？
**A**: 
1. 打开个人中心
2. 停止后端服务
3. 调整配额（会失败）
4. 重启后端服务
5. WebSocket 会自动重连
6. 再次调整配额，应该能正常同步

## 相关文件

- `client/src/components/UserSubscription/AdjustQuotaModal.tsx` - 配额调整模态框
- `client/src/pages/UserCenterPage.tsx` - 个人中心页面（监听 WebSocket）
- `server/src/services/UserSubscriptionManagementService.ts` - 配额调整服务
- `client/src/api/storage.ts` - 存储 API 和格式化函数
