# 存储空间上传问题修复完成

## 问题描述
用户反馈：明明有存储空间，但上传图片或文档时提示"存储空间不足"

## 根本原因

PostgreSQL 的 `BIGINT` 类型在 Node.js 的 `pg` 驱动中会被返回为**字符串类型**，而不是数字。这导致在进行数值计算时出现错误：

```javascript
// 问题代码
const totalStorageBytes = '0';  // 字符串
const fileSizeBytes = 1048576;  // 数字
const afterUpload = totalStorageBytes + fileSizeBytes;
// 结果: '01048576' (字符串拼接) 而不是 1048576 (数值相加)
```

## 修复内容

### 1. StorageQuotaService.ts - 配额检查修复

**文件**: `server/src/services/StorageQuotaService.ts`

**修复**:
```typescript
// 修复前
const effectiveQuota = usage.storageQuotaBytes + usage.purchasedStorageBytes;
const afterUploadBytes = usage.totalStorageBytes + fileSizeBytes;

// 修复后
const currentUsage = Number(usage.totalStorageBytes);
const quotaBytes = Number(usage.storageQuotaBytes);
const purchasedBytes = Number(usage.purchasedStorageBytes);
const effectiveQuota = quotaBytes + purchasedBytes;
const afterUploadBytes = currentUsage + fileSizeBytes;
```

**改进**:
- ✅ 使用 `Number()` 确保类型转换
- ✅ 添加详细的调试日志
- ✅ 改进错误提示信息，显示可用空间

### 2. StorageService.ts - 存储使用查询修复

**文件**: `server/src/services/StorageService.ts`

**修复**:
```typescript
// 修复前
const imageStorageBytes = parseInt(row.imageStorageBytes);
const totalStorageBytes = parseInt(row.totalStorageBytes);

// 修复后
const imageStorageBytes = Number(row.imageStorageBytes) || 0;
const totalStorageBytes = Number(row.totalStorageBytes) || 0;
```

**改进**:
- ✅ 使用 `Number()` 替代 `parseInt()`
- ✅ 添加默认值处理 `|| 0`
- ✅ 添加类型检查日志

### 3. 其他修复

#### SchedulerService.ts - 重复函数定义
- 合并了两个重复的 `scheduleMonthlyQuotaResetTask()` 函数
- 统一处理所有每月配额重置

#### Feature Code 更新
- `articles_per_day` → `articles_per_month`
- `publish_per_day` → `publish_per_month`
- 更新了所有相关文件

## 调试日志输出

修复后，后端会输出详细的调试信息：

```
[StorageService] 用户存储使用: {
  userId: 1,
  totalStorageBytes: 0,
  storageQuotaBytes: 104857600,
  purchasedStorageBytes: 0,
  effectiveQuota: 104857600,
  rawTotal: '0',
  rawQuota: '104857600',
  totalType: 'string',
  quotaType: 'string'
}

[StorageQuotaService] 配额检查: {
  userId: 1,
  currentUsage: 0,
  quotaBytes: 104857600,
  purchasedBytes: 0,
  effectiveQuota: 104857600,
  fileSizeBytes: 1048576
}

[StorageQuotaService] 检查结果: {
  afterUploadBytes: 1048576,
  allowed: true,
  availableBytes: 104857600,
  needBytes: 1048576
}
```

## 测试步骤

### 1. 测试图片上传
1. 登录系统
2. 进入"企业图库"
3. 创建或选择相册
4. 上传图片（确保小于配额）

**预期结果**: ✅ 上传成功

### 2. 测试文档上传
1. 进入"企业知识库"
2. 创建或选择知识库
3. 上传文档（确保小于配额）

**预期结果**: ✅ 上传成功

### 3. 测试配额限制
1. 上传文件直到接近配额
2. 尝试上传超过剩余空间的文件

**预期结果**: ❌ 正确拒绝，显示清晰的错误信息

## 验证场景

| 场景 | 配额 | 已使用 | 上传大小 | 预期结果 |
|------|------|--------|----------|----------|
| 空间充足 | 100MB | 0MB | 5MB | ✅ 允许 |
| 空间不足 | 100MB | 98MB | 5MB | ❌ 拒绝 |
| 无限配额 | -1 | 任意 | 任意 | ✅ 允许 |
| 边界情况 | 100MB | 95MB | 5MB | ✅ 允许 |

## 部署状态

✅ 代码已修复
✅ TypeScript 编译通过
✅ 后端服务已重启
✅ 服务运行正常

**后端服务**: http://localhost:3000
**WebSocket**: ws://localhost:3000/ws

## 相关文件

- `server/src/services/StorageQuotaService.ts` - 配额检查服务
- `server/src/services/StorageService.ts` - 存储管理服务
- `server/src/routes/gallery.ts` - 图库上传路由
- `server/src/routes/knowledgeBase.ts` - 知识库上传路由
- `server/src/services/SchedulerService.ts` - 定时任务调度

## 技术说明

### 为什么使用 Number() 而不是 parseInt()？

1. **更安全**: `Number()` 可以处理浮点数和科学计数法
2. **更严格**: `Number('123abc')` 返回 `NaN`，而 `parseInt('123abc')` 返回 `123`
3. **更明确**: 明确表示要转换为数字类型

### PostgreSQL BIGINT 类型处理

PostgreSQL 的 BIGINT 范围是 `-9223372036854775808` 到 `9223372036854775807`，超过了 JavaScript 的 `Number.MAX_SAFE_INTEGER` (`9007199254740991`)。

`pg` 驱动为了安全起见，将 BIGINT 返回为字符串。在我们的场景中，存储空间不会超过安全整数范围，所以可以安全地转换为数字。

## 后续建议

1. **监控日志**: 观察生产环境中的类型转换日志
2. **性能优化**: 如果日志过多，可以在确认稳定后移除调试日志
3. **单元测试**: 添加针对类型转换的单元测试
4. **文档更新**: 更新开发文档，说明 BIGINT 类型的处理方式

## 修复确认

- ✅ 类型转换问题已修复
- ✅ 配额检查逻辑正确
- ✅ 错误提示清晰明确
- ✅ 调试日志完善
- ✅ 代码编译通过
- ✅ 服务运行正常

**状态**: 修复完成，可以进行测试验证

---

**修复时间**: 2026-01-04
**修复人**: Kiro AI Assistant
