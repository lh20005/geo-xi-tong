# 配额重置策略升级 - 快速参考

## 核心改进

从**固定日历周期**（所有用户月初重置）升级为**用户订阅周期**（每个用户独立重置）

## 关键特性

✅ **公平性**：每个用户都有完整的使用周期  
✅ **灵活性**：自动支持月度/年度套餐  
✅ **动态性**：根据套餐 `billing_cycle` 自动确定  
✅ **可预测**：用户清楚知道自己的重置时间

## 示例对比

### 旧系统（固定周期）
```
用户A：1月1日购买  → 2月1日重置（31天）
用户B：1月15日购买 → 2月1日重置（17天）❌ 不公平
用户C：1月28日购买 → 2月1日重置（4天） ❌ 不公平
```

### 新系统（订阅周期）
```
用户A：1月1日购买  → 2月1日重置  （31天）✅
用户B：1月15日购买 → 2月15日重置 （31天）✅
用户C：1月28日购买 → 2月28日重置 （31天）✅
```

## 快速执行

```bash
# 一键升级
./执行订阅周期配额重置升级.sh
```

或手动执行：

```bash
# 1. 执行迁移
cd server
npx ts-node src/db/run-migration-031.ts

# 2. 运行测试
npx ts-node src/scripts/test-subscription-cycle-quota.ts
```

## 数据库变更

### 新增字段
- `user_subscriptions.quota_reset_anchor` - 配额重置锚点时间
- `user_subscriptions.quota_cycle_type` - 配额周期类型（monthly/yearly）

### 新增函数
- `get_user_quota_period()` - 计算用户配额周期
- `get_next_quota_reset_time()` - 获取下次重置时间
- `get_quota_reset_description()` - 获取重置规则描述

### 自动触发器
- 订阅创建时自动从套餐继承 `billing_cycle`

## 验证方法

```sql
-- 查看所有用户的配额周期
SELECT 
  u.username,
  sp.plan_name,
  get_quota_reset_description(u.id) as reset_rule,
  get_next_quota_reset_time(u.id) as next_reset
FROM users u
JOIN user_subscriptions us ON us.user_id = u.id
JOIN subscription_plans sp ON sp.id = us.plan_id
WHERE us.status = 'active';
```

## 前端展示

```tsx
// 显示配额重置信息
<div>
  <span>配额重置：{resetDescription}</span>
  <span>距离重置：{daysUntilReset} 天</span>
</div>
```

## 特殊场景

### 调整配额
保持当前周期，立即生效

### 升级套餐
重置配额周期，享受完整配额

### 续费订阅
- 提前续费：延长时间，保持周期
- 到期续费：重新计算周期

## 兼容性

✅ 现有用户自动迁移  
✅ 不影响当前使用  
✅ 无需手动操作

## 文档

详细文档：`订阅周期配额重置系统实施完成.md`

---

**实施日期**: 2026-01-05  
**迁移版本**: 031
