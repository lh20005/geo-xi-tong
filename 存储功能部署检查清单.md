# 存储功能部署检查清单

## 📋 部署前检查

### 1. 数据库准备
- [ ] 确认 PostgreSQL 连接正常
- [ ] 确认 Redis 连接正常
- [ ] 创建数据库备份
  ```bash
  pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
  ```

### 2. 运行数据库迁移
- [ ] 运行迁移 017 (存储管理表)
  ```bash
  cd server
  npx ts-node src/db/run-migration-017.ts
  ```
- [ ] 运行迁移 018 (存储购买表)
  ```bash
  npx ts-node src/db/run-migration-018.ts
  ```
- [ ] 验证表已创建
  ```sql
  SELECT table_name FROM information_schema.tables 
  WHERE table_schema = 'public' 
  AND table_name IN ('user_storage_usage', 'storage_usage_history', 'storage_transactions', 'storage_purchases');
  ```

### 3. 迁移现有用户数据
- [ ] 在开发环境测试迁移脚本
  ```bash
  npx ts-node src/scripts/migrate-existing-users-storage.ts
  ```
- [ ] 检查生成的报告 `migration-report.json`
- [ ] 验证所有用户都有存储记录
  ```sql
  SELECT COUNT(*) FROM users;
  SELECT COUNT(*) FROM user_storage_usage;
  -- 两个数字应该相等
  ```
- [ ] 在生产环境运行迁移（如果测试通过）

### 4. 配置定时任务
- [ ] 配置每日快照任务
  ```bash
  # 添加到 crontab
  0 0 * * * cd /path/to/project && node dist/scripts/create-daily-snapshots.js
  ```
- [ ] 配置过期检查任务
  ```bash
  # 添加到 crontab
  0 * * * * psql $DATABASE_URL -c "SELECT expire_storage_purchases();"
  ```
- [ ] 测试定时任务执行

### 5. 编译和构建
- [ ] 编译后端代码
  ```bash
  cd server
  npm run build
  ```
- [ ] 编译前端代码
  ```bash
  cd client
  npm run build
  ```
- [ ] 检查编译错误

### 6. 服务重启
- [ ] 重启后端服务
  ```bash
  npm run server:dev  # 开发环境
  # 或
  pm2 restart geo-backend  # 生产环境
  ```
- [ ] 重启前端服务
  ```bash
  npm run client:dev  # 开发环境
  ```
- [ ] 检查服务状态
  ```bash
  curl http://localhost:3000/api/health
  ```

---

## 🧪 功能测试

### 1. 基础功能测试
- [ ] 登录系统
- [ ] 访问个人中心 → 存储空间标签页
- [ ] 验证显示存储使用情况
- [ ] 验证显示资源明细
- [ ] 验证显示饼图

### 2. 上传功能测试
- [ ] 上传图片到相册
  - [ ] 验证配额检查
  - [ ] 验证存储使用更新
  - [ ] 验证实时 UI 更新
- [ ] 上传文档到知识库
  - [ ] 验证配额检查
  - [ ] 验证存储使用更新
  - [ ] 验证实时 UI 更新
- [ ] 生成文章
  - [ ] 验证存储使用更新

### 3. 删除功能测试
- [ ] 删除图片
  - [ ] 验证存储使用减少
  - [ ] 验证实时 UI 更新
- [ ] 删除文档
  - [ ] 验证存储使用减少
  - [ ] 验证实时 UI 更新
- [ ] 删除文章
  - [ ] 验证存储使用减少

### 4. 配额限制测试
- [ ] 上传大文件（超过配额）
  - [ ] 验证被拒绝
  - [ ] 验证错误提示
  - [ ] 验证升级引导
- [ ] 上传超大文件（超过文件大小限制）
  - [ ] 验证被拒绝
  - [ ] 验证错误提示

### 5. 警报测试
- [ ] 使用量达到 80%
  - [ ] 验证警告警报
  - [ ] 验证 WebSocket 通知
  - [ ] 验证页面提示
- [ ] 使用量达到 95%
  - [ ] 验证严重警报
- [ ] 使用量达到 100%
  - [ ] 验证耗尽警报
  - [ ] 验证无法上传

### 6. 存储购买测试
- [ ] 查看存储产品列表
- [ ] 创建购买订单
- [ ] 完成支付
- [ ] 验证存储自动激活
- [ ] 验证配额增加
- [ ] 验证 WebSocket 通知

### 7. 管理员功能测试
- [ ] 以管理员身份登录
- [ ] 查看所有用户存储
- [ ] 修改用户配额
- [ ] 查看系统统计
- [ ] 触发存储对账

### 8. API 测试
- [ ] `GET /api/storage/usage`
- [ ] `GET /api/storage/breakdown`
- [ ] `POST /api/storage/check-quota`
- [ ] `GET /api/storage/history`
- [ ] `GET /api/storage/transactions`
- [ ] `GET /api/storage/alerts`
- [ ] `GET /api/storage/growth-rate`
- [ ] `GET /api/storage/export`
- [ ] `GET /api/storage-products`
- [ ] `POST /api/storage-products/purchase`

---

## 🔍 性能检查

### 1. 数据库性能
- [ ] 检查索引是否创建
  ```sql
  SELECT indexname FROM pg_indexes 
  WHERE tablename IN ('user_storage_usage', 'storage_usage_history', 'storage_transactions', 'storage_purchases');
  ```
- [ ] 检查查询性能
  ```sql
  EXPLAIN ANALYZE SELECT * FROM user_storage_usage WHERE user_id = 1;
  ```

### 2. Redis 缓存
- [ ] 验证缓存工作
  ```bash
  redis-cli KEYS "storage:user:*"
  ```
- [ ] 验证缓存失效
  - 上传文件后检查缓存是否清除

### 3. WebSocket 性能
- [ ] 验证连接正常
- [ ] 验证消息推送及时
- [ ] 检查连接数

---

## 📊 监控设置

### 1. 日志监控
- [ ] 检查存储相关日志
  ```bash
  tail -f logs/server.log | grep Storage
  ```
- [ ] 设置错误告警

### 2. 数据库监控
- [ ] 监控表大小增长
  ```sql
  SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
  FROM pg_tables
  WHERE tablename LIKE 'storage%'
  ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
  ```

### 3. 用户使用监控
- [ ] 监控配额耗尽用户数
  ```sql
  SELECT COUNT(*) FROM user_storage_usage 
  WHERE storage_quota_bytes != -1 
  AND total_storage_bytes >= (storage_quota_bytes + purchased_storage_bytes);
  ```

---

## 🚨 回滚计划

如果部署出现问题，按以下步骤回滚：

### 1. 停止服务
```bash
pm2 stop geo-backend
```

### 2. 恢复数据库
```bash
psql $DATABASE_URL < backup_YYYYMMDD_HHMMSS.sql
```

### 3. 回滚代码
```bash
git checkout <previous-commit>
npm run build
```

### 4. 重启服务
```bash
pm2 start geo-backend
```

---

## ✅ 部署完成确认

- [ ] 所有迁移成功执行
- [ ] 所有用户数据已迁移
- [ ] 定时任务已配置
- [ ] 所有功能测试通过
- [ ] 性能指标正常
- [ ] 监控已设置
- [ ] 文档已更新
- [ ] 团队已培训

---

## 📝 部署记录

**部署日期**: _______________  
**部署人员**: _______________  
**环境**: [ ] 开发 [ ] 测试 [ ] 生产  
**版本号**: _______________  

**遇到的问题**:
- 

**解决方案**:
- 

**备注**:
- 

---

## 📞 紧急联系

如遇紧急问题，请联系：
- 技术负责人: _______________
- 数据库管理员: _______________
- 运维工程师: _______________
