# 文章发布状态管理 - 快速修复指南

## 问题：relation "publishing_records" does not exist

### ✅ 已解决

数据库迁移已成功执行：
- ✅ `publishing_records` 表已创建
- ✅ `articles` 表字段 `is_published` 和 `published_at` 已添加

### 下一步操作

**重启服务器以加载新路由：**

1. **停止当前服务器**
   - 在运行服务器的终端按 `Ctrl + C`

2. **重新启动服务器**
   ```bash
   cd server
   npm run dev
   ```

3. **验证功能**
   - 访问：http://localhost:5173/publishing-records
   - 应该能正常显示页面（即使没有数据）

### 测试步骤

1. **访问发布记录页面**
   ```
   http://localhost:5173/publishing-records
   ```
   应该看到：
   - 统计卡片（总发布次数、今日发布、本周发布、本月发布）
   - 空的发布记录列表（如果还没有发布过文章）

2. **创建测试数据**
   - 访问：http://localhost:5173/publishing-tasks
   - 选择一篇文章
   - 选择一个平台
   - 创建并执行发布任务

3. **验证发布记录**
   - 发布成功后，返回发布记录页面
   - 应该能看到新的发布记录

### API 测试

```bash
# 测试发布记录 API
curl http://localhost:3001/api/publishing/records

# 测试发布统计 API
curl http://localhost:3001/api/publishing/stats

# 测试文章列表（未发布）
curl "http://localhost:3001/api/articles?publishStatus=unpublished"
```

### 如果还有问题

1. **检查服务器日志**
   - 查看终端输出是否有错误

2. **检查数据库表**
   ```sql
   -- 连接数据库
   psql -U postgres -d geo_optimization
   
   -- 查看表结构
   \d publishing_records
   
   -- 查看 articles 表字段
   \d articles
   ```

3. **清除浏览器缓存**
   - 按 `Ctrl + Shift + R` 强制刷新

4. **检查前端控制台**
   - 按 `F12` 打开开发者工具
   - 查看 Console 和 Network 标签

### 完整重启流程

如果问题持续，执行完整重启：

```bash
# 1. 停止所有服务
# 按 Ctrl+C 停止服务器和前端

# 2. 重启服务器
cd server
npm run dev

# 3. 重启前端（新终端）
cd client
npm run dev

# 4. 访问页面
# http://localhost:5173/publishing-records
```

### 数据库迁移详情

已执行的迁移：
```sql
-- 创建发布记录表
CREATE TABLE publishing_records (
  id SERIAL PRIMARY KEY,
  article_id INTEGER NOT NULL,
  task_id INTEGER NOT NULL,
  platform_id VARCHAR(50) NOT NULL,
  account_id INTEGER NOT NULL,
  account_name VARCHAR(100),
  platform_article_id VARCHAR(255),
  platform_url VARCHAR(500),
  published_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加索引
CREATE INDEX idx_publishing_records_article ON publishing_records(article_id);
CREATE INDEX idx_publishing_records_task ON publishing_records(task_id);
CREATE INDEX idx_publishing_records_platform ON publishing_records(platform_id);
CREATE INDEX idx_publishing_records_published_at ON publishing_records(published_at DESC);

-- 为 articles 表添加字段
ALTER TABLE articles ADD COLUMN is_published BOOLEAN DEFAULT FALSE;
ALTER TABLE articles ADD COLUMN published_at TIMESTAMP;

-- 添加索引
CREATE INDEX idx_articles_is_published ON articles(is_published);
CREATE INDEX idx_articles_published_at ON articles(published_at DESC);
```

### 验证清单

- [x] 数据库迁移已执行
- [ ] 服务器已重启
- [ ] 前端可以访问发布记录页面
- [ ] API 接口返回正常
- [ ] 可以创建发布任务
- [ ] 发布成功后记录显示正常

---

**当前状态：** 数据库迁移完成 ✅  
**下一步：** 重启服务器
