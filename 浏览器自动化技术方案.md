# æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯æ–¹æ¡ˆ

## ä½¿ç”¨çš„æŠ€æœ¯

### Puppeteer v24.33.0

**Puppeteer** æ˜¯ Google Chrome å›¢é˜Ÿå¼€å‘çš„ Node.js åº“ï¼Œæä¾›äº†ä¸€ä¸ªé«˜çº§ API æ¥é€šè¿‡ DevTools åè®®æ§åˆ¶ Chrome/Chromiumã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹© Puppeteer

### 1. å®˜æ–¹æ”¯æŒ
- Google Chrome å›¢é˜Ÿç»´æŠ¤
- ä¸ Chrome DevTools Protocol æ·±åº¦é›†æˆ
- ç¨³å®šå¯é 

### 2. åŠŸèƒ½å¼ºå¤§
- âœ… å®Œæ•´çš„æµè§ˆå™¨æ§åˆ¶
- âœ… æ”¯æŒ Cookie ç®¡ç†
- âœ… æ”¯æŒæˆªå›¾å’Œ PDF ç”Ÿæˆ
- âœ… æ”¯æŒç½‘ç»œæ‹¦æˆª
- âœ… æ”¯æŒé”®ç›˜å’Œé¼ æ ‡äº‹ä»¶æ¨¡æ‹Ÿ

### 3. æ˜“äºä½¿ç”¨
- API ç®€æ´ç›´è§‚
- æ–‡æ¡£å®Œå–„
- ç¤¾åŒºæ´»è·ƒ

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React)                          â”‚
â”‚              http://localhost:5173                       â”‚
â”‚                                                          â”‚
â”‚  ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œ"æŒ‰é’®                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP POST /api/publishing/tasks/:id/execute
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç«¯ (Node.js + Express)                    â”‚
â”‚              http://localhost:3000                       â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PublishingExecutor                              â”‚   â”‚
â”‚  â”‚  - è·å–ä»»åŠ¡ä¿¡æ¯                                   â”‚   â”‚
â”‚  â”‚  - è·å–æ–‡ç« å†…å®¹                                   â”‚   â”‚
â”‚  â”‚  - è°ƒç”¨ BrowserAutomationService                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  BrowserAutomationService                       â”‚   â”‚
â”‚  â”‚  - å¯åŠ¨ Puppeteer                                â”‚   â”‚
â”‚  â”‚  - åˆ›å»ºæµè§ˆå™¨å®ä¾‹                                 â”‚   â”‚
â”‚  â”‚  - ç®¡ç†é¡µé¢ç”Ÿå‘½å‘¨æœŸ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ToutiaoAdapter (å¹³å°é€‚é…å™¨)                     â”‚   â”‚
â”‚  â”‚  - performLogin() - ç™»å½•                         â”‚   â”‚
â”‚  â”‚  - performPublish() - å‘å¸ƒæ–‡ç«                    â”‚   â”‚
â”‚  â”‚  - æŸ¥æ‰¾å…ƒç´ ã€ç‚¹å‡»ã€è¾“å…¥æ–‡æœ¬                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Chrome DevTools Protocol (CDP)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Chrome/Chromium æµè§ˆå™¨                      â”‚
â”‚              (Puppeteer æ§åˆ¶)                            â”‚
â”‚                                                          â”‚
â”‚  - è‡ªåŠ¨æ‰“å¼€å¤´æ¡å·å‘å¸ƒé¡µé¢                                 â”‚
â”‚  - è‡ªåŠ¨å¡«å†™æ ‡é¢˜å’Œå†…å®¹                                     â”‚
â”‚  - è‡ªåŠ¨ç‚¹å‡»å‘å¸ƒæŒ‰é’®                                       â”‚
â”‚  - ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ•´ä¸ªè‡ªåŠ¨åŒ–è¿‡ç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒä»£ç 

### 1. å¯åŠ¨æµè§ˆå™¨

```typescript
// BrowserAutomationService.ts
async launchBrowser(options?: BrowserOptions): Promise<Browser> {
  this.browser = await puppeteer.launch({
    headless: false,  // æ˜¾ç¤ºæµè§ˆå™¨çª—å£
    executablePath: '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-blink-features=AutomationControlled'
    ],
    defaultViewport: {
      width: 1920,
      height: 1080
    }
  });
  
  return this.browser;
}
```

### 2. åˆ›å»ºé¡µé¢

```typescript
async createPage(): Promise<Page> {
  if (!this.browser) {
    throw new Error('æµè§ˆå™¨æœªå¯åŠ¨');
  }
  
  const page = await this.browser.newPage();
  
  // è®¾ç½®ç”¨æˆ·ä»£ç†ï¼Œé¿å…è¢«æ£€æµ‹ä¸ºæœºå™¨äºº
  await page.setUserAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...');
  
  return page;
}
```

### 3. æŸ¥æ‰¾å…ƒç´ 

```typescript
// æŸ¥æ‰¾æ ‡é¢˜è¾“å…¥æ¡†
const titleInput = await page.$('input[placeholder*="æ ‡é¢˜"]');

// æŸ¥æ‰¾æ‰€æœ‰inputå…ƒç´ 
const allInputs = await page.$$('input');

// ä½¿ç”¨XPathæŸ¥æ‰¾
const elements = await page.$x("//input[contains(@placeholder, 'æ ‡é¢˜')]");
```

### 4. ç‚¹å‡»å…ƒç´ 

```typescript
// ç‚¹å‡»æ ‡é¢˜è¾“å…¥æ¡†
await titleInput.click();

// ç­‰å¾…å…ƒç´ å‡ºç°åç‚¹å‡»
await page.waitForSelector('button.publish');
await page.click('button.publish');
```

### 5. è¾“å…¥æ–‡æœ¬

```typescript
// æ–¹æ³•1ï¼šä½¿ç”¨ keyboard.typeï¼ˆæ¨¡æ‹ŸçœŸå®é”®ç›˜è¾“å…¥ï¼‰
await titleInput.click();
await page.keyboard.type('æ–‡ç« æ ‡é¢˜', { delay: 80 });

// æ–¹æ³•2ï¼šç›´æ¥è®¾ç½® valueï¼ˆå¿«é€Ÿä½†å¯èƒ½ä¸è§¦å‘æŸäº›äº‹ä»¶ï¼‰
await page.evaluate((el, val) => {
  (el as HTMLInputElement).value = val;
  el.dispatchEvent(new Event('input', { bubbles: true }));
}, titleInput, 'æ–‡ç« æ ‡é¢˜');
```

### 6. è®¾ç½® Cookie

```typescript
// è®¾ç½® Cookie å®ç°å…ç™»å½•
await page.setCookie(...cookies);
await page.reload();
```

### 7. æˆªå›¾è°ƒè¯•

```typescript
// ä¿å­˜é¡µé¢æˆªå›¾
await page.screenshot({ 
  path: 'debug.png', 
  fullPage: true 
});
```

### 8. æ‰§è¡Œ JavaScript

```typescript
// åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç 
const result = await page.evaluate(() => {
  const inputs = document.querySelectorAll('input');
  return Array.from(inputs).map(input => ({
    type: input.type,
    placeholder: input.placeholder
  }));
});
```

## å…³é”®é…ç½®

### headless æ¨¡å¼

```typescript
// headless: false - æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼ˆç”¨äºè°ƒè¯•å’Œæ¼”ç¤ºï¼‰
await puppeteer.launch({ headless: false });

// headless: true - æ— å¤´æ¨¡å¼ï¼ˆç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ›´å¿«ï¼‰
await puppeteer.launch({ headless: true });
```

### åæ£€æµ‹é…ç½®

```typescript
args: [
  '--no-sandbox',
  '--disable-setuid-sandbox',
  '--disable-blink-features=AutomationControlled',  // éšè—è‡ªåŠ¨åŒ–ç‰¹å¾
  '--disable-web-security',
  '--disable-features=IsolateOrigins,site-per-process'
]
```

## ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

### Puppeteer vs Selenium

| ç‰¹æ€§ | Puppeteer | Selenium |
|------|-----------|----------|
| é€Ÿåº¦ | âš¡ å¿« | ğŸ¢ æ…¢ |
| å®‰è£… | ç®€å• | éœ€è¦ WebDriver |
| API | ç°ä»£ Promise | ä¼ ç»Ÿå›è°ƒ |
| Chrome æ”¯æŒ | åŸç”Ÿ | éœ€è¦ ChromeDriver |
| è·¨æµè§ˆå™¨ | ä»… Chrome/Chromium | æ”¯æŒå¤šæµè§ˆå™¨ |
| æ–‡æ¡£ | ä¼˜ç§€ | ä¸€èˆ¬ |

### Puppeteer vs Playwright

| ç‰¹æ€§ | Puppeteer | Playwright |
|------|-----------|------------|
| ç»´æŠ¤è€… | Google | Microsoft |
| è·¨æµè§ˆå™¨ | Chrome/Chromium | Chrome/Firefox/Safari |
| API | ç®€æ´ | æ›´å¼ºå¤§ |
| å­¦ä¹ æ›²çº¿ | å¹³ç¼“ | ç¨é™¡ |
| ç¤¾åŒº | å¤§ | å¿«é€Ÿå¢é•¿ |

## ä¸ºä»€ä¹ˆä¸ç”¨ Selenium

1. **æ€§èƒ½**ï¼šPuppeteer æ¯” Selenium å¿« 2-3 å€
2. **ç®€å•**ï¼šä¸éœ€è¦å®‰è£… WebDriver
3. **ç°ä»£**ï¼šåŸºäº Promise/async-await
4. **é›†æˆ**ï¼šä¸ Chrome DevTools æ·±åº¦é›†æˆ
5. **è°ƒè¯•**ï¼šæ›´å¥½çš„è°ƒè¯•å·¥å…·

## ä¸ºä»€ä¹ˆä¸ç”¨ Playwright

1. **æˆç†Ÿåº¦**ï¼šPuppeteer æ›´æˆç†Ÿï¼Œç¤¾åŒºæ›´å¤§
2. **éœ€æ±‚**ï¼šæˆ‘ä»¬åªéœ€è¦ Chrome æ”¯æŒ
3. **ç®€å•**ï¼šPuppeteer API æ›´ç®€æ´
4. **æ–‡æ¡£**ï¼šPuppeteer æ–‡æ¡£æ›´å®Œå–„

## å®é™…åº”ç”¨åœºæ™¯

### 1. è‡ªåŠ¨ç™»å½•
```typescript
await page.goto('https://mp.toutiao.com/auth/page/login');
await page.setCookie(...savedCookies);
await page.reload();
```

### 2. è‡ªåŠ¨å¡«è¡¨
```typescript
await page.type('input[name="title"]', 'æ–‡ç« æ ‡é¢˜');
await page.type('textarea[name="content"]', 'æ–‡ç« å†…å®¹');
```

### 3. è‡ªåŠ¨ç‚¹å‡»
```typescript
await page.click('button.publish');
await page.waitForNavigation();
```

### 4. ç­‰å¾…å…ƒç´ 
```typescript
await page.waitForSelector('.success-message', { timeout: 10000 });
```

### 5. å¤„ç†å¼¹çª—
```typescript
page.on('dialog', async dialog => {
  await dialog.accept();
});
```

## è°ƒè¯•æŠ€å·§

### 1. æ…¢åŠ¨ä½œæ¨¡å¼
```typescript
await puppeteer.launch({ 
  headless: false,
  slowMo: 100  // æ¯ä¸ªæ“ä½œå»¶è¿Ÿ 100ms
});
```

### 2. æˆªå›¾è°ƒè¯•
```typescript
await page.screenshot({ path: 'step1.png' });
// ... æ‰§è¡Œæ“ä½œ
await page.screenshot({ path: 'step2.png' });
```

### 3. æ§åˆ¶å°æ—¥å¿—
```typescript
page.on('console', msg => console.log('æµè§ˆå™¨æ—¥å¿—:', msg.text()));
```

### 4. ç½‘ç»œç›‘æ§
```typescript
page.on('request', request => {
  console.log('è¯·æ±‚:', request.url());
});
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¦ç”¨ä¸å¿…è¦çš„èµ„æº
```typescript
await page.setRequestInterception(true);
page.on('request', request => {
  if (['image', 'stylesheet', 'font'].includes(request.resourceType())) {
    request.abort();
  } else {
    request.continue();
  }
});
```

### 2. å¤ç”¨æµè§ˆå™¨å®ä¾‹
```typescript
// ä¸è¦æ¯æ¬¡éƒ½å¯åŠ¨æ–°æµè§ˆå™¨
// å¤ç”¨åŒä¸€ä¸ªæµè§ˆå™¨å®ä¾‹ï¼Œåªåˆ›å»ºæ–°é¡µé¢
```

### 3. å¹¶å‘æ§åˆ¶
```typescript
// é™åˆ¶åŒæ—¶æ‰“å¼€çš„é¡µé¢æ•°é‡
const maxPages = 5;
```

## å®‰å…¨è€ƒè™‘

### 1. Cookie åŠ å¯†å­˜å‚¨
- Cookie å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- ä½¿ç”¨ AES-256-GCM åŠ å¯†
- å®šæœŸæ›´æ–°

### 2. æ²™ç®±æ¨¡å¼
```typescript
args: ['--no-sandbox']  // ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
```

### 3. èµ„æºæ¸…ç†
```typescript
finally {
  if (page) await page.close();
  if (browser) await browser.close();
}
```

## æ€»ç»“

ä½¿ç”¨ **Puppeteer** æ˜¯å› ä¸ºï¼š
- âœ… æ€§èƒ½ä¼˜ç§€
- âœ… API ç®€æ´
- âœ… æ–‡æ¡£å®Œå–„
- âœ… ç¤¾åŒºæ´»è·ƒ
- âœ… ä¸ Chrome æ·±åº¦é›†æˆ
- âœ… é€‚åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼ˆåªéœ€è¦ Chrome æ”¯æŒï¼‰

è¿™æ˜¯ç›®å‰æœ€é€‚åˆè‡ªåŠ¨åŒ–å‘å¸ƒä»»åŠ¡çš„æ–¹æ¡ˆã€‚
