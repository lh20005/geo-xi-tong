# ç”Ÿäº§ç¯å¢ƒç«¯å£å’Œå®‰å…¨é…ç½®æŒ‡å—

## æ¶æ„æ¦‚è§ˆ

```
äº’è”ç½‘
  â†“
[é˜²ç«å¢™] åªå¼€æ”¾ 80/443
  â†“
[Nginx åå‘ä»£ç†] (443ç«¯å£ï¼ŒSSLç»ˆæ­¢)
  â†“
  â”œâ”€â†’ ä¸»åº”ç”¨ (å†…ç½‘ localhost:5173 æˆ–æ„å»ºåçš„é™æ€æ–‡ä»¶)
  â”œâ”€â†’ APIæœåŠ¡ (å†…ç½‘ localhost:3000)
  â””â”€â†’ è½åœ°é¡µ (å†…ç½‘ localhost:8080 æˆ–é™æ€æ–‡ä»¶)
```

## ç«¯å£å®‰å…¨æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒï¼ˆå½“å‰ï¼‰

```bash
# ä»…æœ¬åœ°è®¿é—®
å‰ç«¯ï¼šhttp://localhost:5173
åç«¯ï¼šhttp://localhost:3000
è½åœ°é¡µï¼šhttp://localhost:8080

# å®‰å…¨æ€§ï¼šâœ… é»˜è®¤åªç›‘å¬ 127.0.0.1ï¼Œå¤–ç½‘æ— æ³•è®¿é—®
```

### 2. ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰

#### æ–¹æ¡ˆ Aï¼šNginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰

```nginx
# /etc/nginx/sites-available/geo-system

# ä¸»åº”ç”¨
server {
    listen 443 ssl http2;
    server_name app.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # é™æ€æ–‡ä»¶ï¼ˆæ„å»ºåçš„å‰ç«¯ï¼‰
    location / {
        root /var/www/geo-system/client/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # API ä»£ç†
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket æ”¯æŒ
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

# è½åœ°é¡µ
server {
    listen 443 ssl http2;
    server_name www.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        root /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /index.html;
    }
}

# ç®¡ç†åå°ï¼ˆå¯é€‰ï¼Œç‹¬ç«‹å­åŸŸåï¼‰
server {
    listen 443 ssl http2;
    server_name admin.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # IP ç™½åå•ï¼ˆä»…åŠå…¬ç½‘ç»œå¯è®¿é—®ï¼‰
    allow 203.0.113.0/24;  # ä½ çš„åŠå…¬å®¤IPæ®µ
    deny all;
    
    location / {
        root /var/www/geo-system/admin/dist;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:3000;
        # ... åŒä¸Š
    }
}
```

#### æ–¹æ¡ˆ Bï¼šDocker + å†…ç½‘éš”ç¦»

```yaml
# docker-compose.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    networks:
      - public

  frontend:
    build: ./client
    expose:
      - "5173"  # åªæš´éœ²ç»™å†…ç½‘ï¼Œä¸æ˜ å°„åˆ°å®¿ä¸»æœº
    networks:
      - internal

  backend:
    build: ./server
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
    networks:
      - internal
      - database

  postgres:
    image: postgres:15
    expose:
      - "5432"  # åªåœ¨å†…ç½‘å¯è®¿é—®
    networks:
      - database

networks:
  public:
    driver: bridge
  internal:
    driver: bridge
    internal: true  # å®Œå…¨éš”ç¦»ï¼Œæ— æ³•è®¿é—®å¤–ç½‘
  database:
    driver: bridge
    internal: true
```

### 3. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian (ufw)
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# æ£€æŸ¥çŠ¶æ€
sudo ufw status verbose

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

## å®‰å…¨æ£€æŸ¥æ¸…å•

### å¼€å‘ç¯å¢ƒ
- [ ] ç¡®ä¿å¼€å‘æœåŠ¡å™¨åªç›‘å¬ 127.0.0.1
- [ ] ä¸è¦åœ¨å…¬ç½‘ç¯å¢ƒè¿è¡Œ `npm run dev`
- [ ] ä½¿ç”¨ `.env` æ–‡ä»¶ç®¡ç†æ•æ„Ÿé…ç½®ï¼Œä¸æäº¤åˆ° Git

### ç”Ÿäº§ç¯å¢ƒ
- [ ] ä½¿ç”¨ HTTPS (443ç«¯å£)ï¼Œå¼ºåˆ¶ HTTP é‡å®šå‘åˆ° HTTPS
- [ ] å†…éƒ¨æœåŠ¡ç«¯å£ä¸å¯¹å¤–æš´éœ²ï¼ˆ3000, 5173, 8080ï¼‰
- [ ] é…ç½®é˜²ç«å¢™ï¼Œåªå¼€æ”¾ 80/443/22
- [ ] ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginx/Caddyï¼‰
- [ ] å¯ç”¨ SSL/TLSï¼ˆLet's Encrypt å…è´¹è¯ä¹¦ï¼‰
- [ ] é…ç½®å®‰å…¨å“åº”å¤´ï¼ˆå·²åœ¨ä»£ç ä¸­å®ç° helmetï¼‰
- [ ] é™æµä¿æŠ¤ï¼ˆå·²åœ¨ä»£ç ä¸­å®ç° express-rate-limitï¼‰
- [ ] å®šæœŸæ›´æ–°ä¾èµ–å’Œç³»ç»Ÿè¡¥ä¸

### ç®¡ç†åå°é¢å¤–å®‰å…¨
- [ ] ä½¿ç”¨ç‹¬ç«‹å­åŸŸåï¼ˆadmin.yourdomain.comï¼‰
- [ ] IP ç™½åå•é™åˆ¶
- [ ] å¼ºåˆ¶ 2FA åŒå› ç´ è®¤è¯
- [ ] å®¡è®¡æ—¥å¿—è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œ
- [ ] æ›´çŸ­çš„ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆ15åˆ†é’Ÿï¼‰

## å¸¸è§ç«¯å£è¯´æ˜

| ç«¯å£ | ç”¨é€” | æ˜¯å¦å¯¹å¤– | å®‰å…¨çº§åˆ« |
|------|------|----------|----------|
| 22 | SSH | âœ… (é™åˆ¶IP) | é«˜å± |
| 80 | HTTP | âœ… (é‡å®šå‘åˆ°443) | ä¸­å± |
| 443 | HTTPS | âœ… | å®‰å…¨ |
| 3000 | åç«¯API | âŒ å†…ç½‘ | - |
| 5173 | å‰ç«¯å¼€å‘ | âŒ å†…ç½‘ | - |
| 5432 | PostgreSQL | âŒ å†…ç½‘ | é«˜å± |
| 6379 | Redis | âŒ å†…ç½‘ | é«˜å± |
| 8080 | è½åœ°é¡µ | âŒ å†…ç½‘ | - |

## å¿«é€Ÿéƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy-production.sh

set -e

echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."

# 1. æ„å»ºå‰ç«¯
echo "ğŸ“¦ æ„å»ºä¸»åº”ç”¨..."
cd client
npm run build
cd ..

echo "ğŸ“¦ æ„å»ºè½åœ°é¡µ..."
cd landing
npm run build
cd ..

# 2. æ„å»ºåç«¯
echo "ğŸ“¦ æ„å»ºåç«¯..."
cd server
npm run build
cd ..

# 3. å¤åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§ç›®å½•
echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶..."
sudo mkdir -p /var/www/geo-system
sudo cp -r client/dist /var/www/geo-system/client
sudo cp -r landing/dist /var/www/geo-system/landing
sudo cp -r server/dist /var/www/geo-system/server
sudo cp -r server/node_modules /var/www/geo-system/server/

# 4. é…ç½® Nginx
echo "âš™ï¸  é…ç½® Nginx..."
sudo cp config/nginx/geo-system.conf /etc/nginx/sites-available/
sudo ln -sf /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 5. é…ç½® PM2ï¼ˆåç«¯è¿›ç¨‹ç®¡ç†ï¼‰
echo "ğŸ”„ å¯åŠ¨åç«¯æœåŠ¡..."
cd /var/www/geo-system/server
pm2 start dist/index.js --name geo-api
pm2 save
pm2 startup

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€ï¼š"
echo "  ä¸»åº”ç”¨: https://app.yourdomain.com"
echo "  è½åœ°é¡µ: https://www.yourdomain.com"
```

## ç›‘æ§å’Œç»´æŠ¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx

# æŸ¥çœ‹æ—¥å¿—
pm2 logs geo-api
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# é‡å¯æœåŠ¡
pm2 restart geo-api
sudo systemctl restart nginx
```

## åº”æ€¥å“åº”

å¦‚æœå‘ç°å®‰å…¨é—®é¢˜ï¼š

1. **ç«‹å³éš”ç¦»**ï¼šå…³é—­å—å½±å“çš„æœåŠ¡
   ```bash
   pm2 stop geo-api
   sudo systemctl stop nginx
   ```

2. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥æ‰¾å¼‚å¸¸è®¿é—®
   ```bash
   sudo grep "POST /api/admin" /var/log/nginx/access.log
   ```

3. **ä¸´æ—¶å°ç¦**ï¼šæ·»åŠ  IP é»‘åå•
   ```bash
   sudo ufw deny from æ”»å‡»è€…IP
   ```

4. **ä¿®å¤æ¼æ´**ï¼šæ›´æ–°ä»£ç å¹¶é‡æ–°éƒ¨ç½²

5. **é€šçŸ¥ç”¨æˆ·**ï¼šå¦‚æœ‰æ•°æ®æ³„éœ²ï¼ŒåŠæ—¶é€šçŸ¥å—å½±å“ç”¨æˆ·
