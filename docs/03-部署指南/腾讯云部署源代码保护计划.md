# è…¾è®¯äº‘éƒ¨ç½²æºä»£ç ä¿æŠ¤å¼€å‘è®¡åˆ’

> åŸºäº 2024-2025 å¹´æœ€ä½³å®è·µå’Œå®‰å…¨æ ‡å‡†

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡ï¼š** å°† GEO ä¼˜åŒ–ç³»ç»Ÿå®‰å…¨éƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼Œç¡®ä¿æºä»£ç å’Œæ•æ„Ÿä¿¡æ¯ä¸è¢«æ³„éœ²

**æ—¶é—´è§„åˆ’ï¼š** 3-5 å¤©
**éƒ¨ç½²æ–¹å¼ï¼š** ç¼–è¯‘åéƒ¨ç½²ï¼ˆæ¨èæ–°æ‰‹ï¼‰

---

## ç¬¬ä¸€é˜¶æ®µï¼šä»£ç å®‰å…¨åŠ å›ºï¼ˆ1-2 å¤©ï¼‰

### ä»»åŠ¡ 1.1ï¼šå‰ç«¯ä»£ç ä¿æŠ¤ â­â­â­

**ä¼˜å…ˆçº§ï¼š** æœ€é«˜
**è€—æ—¶ï¼š** 2 å°æ—¶

#### 1.1.1 ç¦ç”¨ Source Map

**æ–‡ä»¶ï¼š** `client/vite.config.ts`

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      },
      '/uploads': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  },
  
  build: {
    // ç¦ç”¨ Source Mapï¼ˆæœ€é‡è¦ï¼ï¼‰
    sourcemap: false,
    
    // ä»£ç æ··æ·†å’Œå‹ç¼©
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
        pure_funcs: ['console.log', 'console.info', 'console.debug']
      },
      mangle: {
        safari10: true
      },
      format: {
        comments: false
      }
    },
    
    // åˆ†å—ç­–ç•¥
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'antd-vendor': ['antd', '@ant-design/icons']
        }
      }
    }
  }
});
```

**éªŒè¯ï¼š**
```bash
cd client
npm run build
find dist -name "*.map"  # åº”è¯¥æ²¡æœ‰è¾“å‡º
```

#### 1.1.2 åŒæ ·é…ç½® Landing é¡µ

**æ–‡ä»¶ï¼š** `landing/vite.config.ts`

```typescript
// å¤åˆ¶ç›¸åŒçš„é…ç½®
export default defineConfig({
  // ... åŒ client é…ç½®
  build: {
    sourcemap: false,
    minify: 'terser',
    // ...
  }
});
```


### ä»»åŠ¡ 1.2ï¼šåç«¯é”™è¯¯å¤„ç†ä¼˜åŒ– â­â­â­

**ä¼˜å…ˆçº§ï¼š** é«˜
**è€—æ—¶ï¼š** 1 å°æ—¶

**æ–‡ä»¶ï¼š** `server/src/middleware/errorHandler.ts`

```typescript
import { Request, Response, NextFunction } from 'express';

// å®‰å…¨çš„é”™è¯¯æ¶ˆæ¯æ˜ å°„
const SAFE_ERROR_MESSAGES: Record<string, string> = {
  'ValidationError': 'è¯·æ±‚å‚æ•°é”™è¯¯',
  'UnauthorizedError': 'æœªæˆæƒè®¿é—®',
  'ForbiddenError': 'æ— æƒè®¿é—®',
  'NotFoundError': 'èµ„æºä¸å­˜åœ¨',
  'ConflictError': 'èµ„æºå†²çª',
  'DatabaseError': 'æ•°æ®æ“ä½œå¤±è´¥',
  'NetworkError': 'ç½‘ç»œè¯·æ±‚å¤±è´¥'
};

export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  // è¯¦ç»†æ—¥å¿—è®°å½•åˆ°æœåŠ¡å™¨
  console.error('[Error]', {
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    user: (req as any).user?.id,
    timestamp: new Date().toISOString()
  });
  
  const statusCode = (err as any).statusCode || 500;
  
  if (process.env.NODE_ENV === 'production') {
    // ç”Ÿäº§ç¯å¢ƒï¼šè¿”å›å®‰å…¨æ¶ˆæ¯
    const safeMessage = SAFE_ERROR_MESSAGES[err.name] || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
    
    res.status(statusCode).json({
      success: false,
      message: safeMessage
    });
  } else {
    // å¼€å‘ç¯å¢ƒï¼šè¿”å›è¯¦ç»†ä¿¡æ¯
    res.status(statusCode).json({
      success: false,
      message: err.message,
      stack: err.stack,
      name: err.name
    });
  }
}
```

### ä»»åŠ¡ 1.3ï¼šæ·»åŠ å®‰å…¨ä¸­é—´ä»¶ â­â­

**ä¼˜å…ˆçº§ï¼š** é«˜
**è€—æ—¶ï¼š** 30 åˆ†é’Ÿ

**å®‰è£…ä¾èµ–ï¼š**
```bash
cd server
npm install helmet express-rate-limit
```

**æ–‡ä»¶ï¼š** `server/src/index.ts`

åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ ï¼š

```typescript
import helmet from 'helmet';
import rateLimit from 'express-rate-limit';

// åœ¨ app åˆ›å»ºåç«‹å³æ·»åŠ 
const app = express();

// 1. Helmet å®‰å…¨ Headers
app.use(helmet({
  contentSecurityPolicy: false,
  crossOriginEmbedderPolicy: false
}));

// 2. éšè—æŠ€æœ¯æ ˆ
app.disable('x-powered-by');
app.use((req, res, next) => {
  res.removeHeader('X-Powered-By');
  res.setHeader('Server', 'WebServer');
  next();
});

// 3. é€Ÿç‡é™åˆ¶
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100, // æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,
  legacyHeaders: false
});

app.use('/api', limiter);

// 4. CORS é…ç½®
const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [
  'http://localhost:5173',
  'http://localhost:8080'
];

app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('ä¸å…è®¸çš„æ¥æº'));
    }
  },
  credentials: true
}));

// ... å…¶ä»–ä¸­é—´ä»¶
```

### ä»»åŠ¡ 1.4ï¼šç¯å¢ƒå˜é‡å®‰å…¨ â­â­â­

**ä¼˜å…ˆçº§ï¼š** æœ€é«˜
**è€—æ—¶ï¼š** 30 åˆ†é’Ÿ

#### 1.4.1 ç”Ÿæˆå¼ºå¯†é’¥

```bash
# ç”Ÿæˆ JWT_SECRET
openssl rand -hex 32

# ç”Ÿæˆæ•°æ®åº“å¯†ç 
openssl rand -base64 24 | tr -d "=+/" | cut -c1-24

# ç”Ÿæˆç®¡ç†å‘˜å¯†ç 
openssl rand -base64 16 | tr -d "=+/" | cut -c1-16
```

#### 1.4.2 æ›´æ–° .env.example

**æ–‡ä»¶ï¼š** `.env.example`

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:password@localhost:5432/geo_system

# AI APIé…ç½®
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx
GEMINI_API_KEY=AIzaSyxxxxxxxxxxxxxxxx

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# JWTå¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ä½¿ç”¨ openssl rand -hex 32 ç”Ÿæˆï¼‰
JWT_SECRET=è¯·ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²

# ç®¡ç†å‘˜è´¦å·ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
ADMIN_USERNAME=admin
ADMIN_PASSWORD=è¯·ä½¿ç”¨å¼ºå¯†ç 

# CORS å…è®¸çš„æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒåŸŸåï¼‰
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com

# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_PAY_APP_ID=
WECHAT_PAY_MCH_ID=
WECHAT_PAY_API_V3_KEY=
WECHAT_PAY_SERIAL_NO=
WECHAT_PAY_PRIVATE_KEY_PATH=/secure/path/to/apiclient_key.pem
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/payment/wechat/notify

# Redisé…ç½®
REDIS_URL=redis://:password@localhost:6379
```

#### 1.4.3 ç¡®ä¿ .gitignore æ­£ç¡®

**æ–‡ä»¶ï¼š** `.gitignore`

```gitignore
# ç¯å¢ƒå˜é‡
.env
.env.*
!.env.example

# æ•æ„Ÿæ–‡ä»¶
*.key
*.pem
*.crt
secrets/

# æˆªå›¾
server/*.png
screenshots/
*.png
!client/public/**/*.png

# å…¶ä»–
node_modules/
dist/
build/
.DS_Store
```

---

## ç¬¬äºŒé˜¶æ®µï¼šè…¾è®¯äº‘ç¯å¢ƒå‡†å¤‡ï¼ˆåŠå¤©ï¼‰

### ä»»åŠ¡ 2.1ï¼šè´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨ â­â­â­

**æ¨èé…ç½®ï¼š**
- **äº§å“ï¼š** è½»é‡åº”ç”¨æœåŠ¡å™¨
- **åœ°åŸŸï¼š** å›½å†…ï¼ˆå¦‚å¹¿å·ã€ä¸Šæµ·ï¼‰
- **é…ç½®ï¼š** 2æ ¸4Gï¼ˆèµ·æ­¥ï¼‰æˆ– 4æ ¸8Gï¼ˆæ¨èï¼‰
- **ç³»ç»Ÿï¼š** Ubuntu 20.04 LTS æˆ– CentOS 7.9
- **å¸¦å®½ï¼š** 5Mbps èµ·æ­¥

**è´­ä¹°é“¾æ¥ï¼š** https://cloud.tencent.com/product/lighthouse

### ä»»åŠ¡ 2.2ï¼šé…ç½®å®‰å…¨ç»„ â­â­

**å¼€æ”¾ç«¯å£ï¼š**
- 22 (SSH) - ä»…å…è®¸ä½ çš„ IP
- 80 (HTTP)
- 443 (HTTPS)
- å…¶ä»–ç«¯å£å…¨éƒ¨å…³é—­

**é…ç½®æ­¥éª¤ï¼š**
1. è¿›å…¥è…¾è®¯äº‘æ§åˆ¶å°
2. æ‰¾åˆ°ä½ çš„æœåŠ¡å™¨
3. ç‚¹å‡»"é˜²ç«å¢™"
4. æ·»åŠ è§„åˆ™

### ä»»åŠ¡ 2.3ï¼šé…ç½®åŸŸåï¼ˆå¯é€‰ä½†æ¨èï¼‰â­â­

**æ­¥éª¤ï¼š**
1. åœ¨è…¾è®¯äº‘è´­ä¹°åŸŸåæˆ–ä½¿ç”¨å·²æœ‰åŸŸå
2. æ·»åŠ  DNS è§£æè®°å½•ï¼š
   - A è®°å½•ï¼š`@` â†’ æœåŠ¡å™¨ IP
   - A è®°å½•ï¼š`www` â†’ æœåŠ¡å™¨ IP
3. ç­‰å¾…è§£æç”Ÿæ•ˆï¼ˆ10-30 åˆ†é’Ÿï¼‰

---

## ç¬¬ä¸‰é˜¶æ®µï¼šæœåŠ¡å™¨ç¯å¢ƒé…ç½®ï¼ˆ1 å¤©ï¼‰

### ä»»åŠ¡ 3.1ï¼šè¿æ¥æœåŠ¡å™¨

```bash
# ä½¿ç”¨ SSH è¿æ¥
ssh root@your-server-ip

# æˆ–ä½¿ç”¨è…¾è®¯äº‘æ§åˆ¶å°çš„ Web Shell
```

### ä»»åŠ¡ 3.2ï¼šå®‰è£…åŸºç¡€è½¯ä»¶ â­â­â­

```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y  # Ubuntu
# æˆ–
yum update -y  # CentOS

# å®‰è£… Node.js 18 LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs  # Ubuntu
# æˆ–
yum install -y nodejs  # CentOS

# éªŒè¯å®‰è£…
node -v  # åº”è¯¥æ˜¾ç¤º v18.x.x
npm -v

# å®‰è£… PostgreSQL
apt install -y postgresql postgresql-contrib  # Ubuntu
# æˆ–
yum install -y postgresql-server postgresql-contrib  # CentOS
systemctl enable postgresql
systemctl start postgresql

# å®‰è£… Redis
apt install -y redis-server  # Ubuntu
# æˆ–
yum install -y redis  # CentOS
systemctl enable redis
systemctl start redis

# å®‰è£… Nginx
apt install -y nginx  # Ubuntu
# æˆ–
yum install -y nginx  # CentOS
systemctl enable nginx
systemctl start nginx

# å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰
npm install -g pm2

# å®‰è£… Git
apt install -y git  # Ubuntu
# æˆ–
yum install -y git  # CentOS
```

### ä»»åŠ¡ 3.3ï¼šé…ç½® PostgreSQL â­â­

```bash
# åˆ‡æ¢åˆ° postgres ç”¨æˆ·
sudo -u postgres psql

# åœ¨ PostgreSQL ä¸­æ‰§è¡Œ
CREATE DATABASE geo_system;
CREATE USER geo_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE geo_system TO geo_user;
\q

# é…ç½®å…è®¸è¿œç¨‹è¿æ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
nano /etc/postgresql/*/main/postgresql.conf
# æ‰¾åˆ° listen_addressesï¼Œæ”¹ä¸ºï¼š
# listen_addresses = 'localhost'

nano /etc/postgresql/*/main/pg_hba.conf
# æ·»åŠ ï¼š
# local   all   geo_user   md5

# é‡å¯ PostgreSQL
systemctl restart postgresql
```

### ä»»åŠ¡ 3.4ï¼šé…ç½® Redis â­

```bash
# ç¼–è¾‘é…ç½®
nano /etc/redis/redis.conf

# è®¾ç½®å¯†ç 
requirepass your_redis_password

# ç»‘å®šåˆ°æœ¬åœ°ï¼ˆå®‰å…¨ï¼‰
bind 127.0.0.1

# é‡å¯ Redis
systemctl restart redis
```

---

## ç¬¬å››é˜¶æ®µï¼šä»£ç ç¼–è¯‘å’Œä¸Šä¼ ï¼ˆåŠå¤©ï¼‰

### ä»»åŠ¡ 4.1ï¼šæœ¬åœ°ç¼–è¯‘ â­â­â­

```bash
# 1. ç¼–è¯‘åç«¯
cd server
npm install
npm run build  # ç”Ÿæˆ dist/ ç›®å½•

# 2. ç¼–è¯‘å‰ç«¯
cd ../client
npm install
npm run build  # ç”Ÿæˆ dist/ ç›®å½•

# 3. ç¼–è¯‘ Landing é¡µ
cd ../landing
npm install
npm run build  # ç”Ÿæˆ dist/ ç›®å½•
```

### ä»»åŠ¡ 4.2ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ â­â­

```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºç›®å½•
ssh root@your-server-ip
mkdir -p /var/www/geo-system/{server,client,landing}
exit

# ä¸Šä¼ åç«¯
cd server
scp -r dist package*.json root@your-server-ip:/var/www/geo-system/server/

# ä¸Šä¼ å‰ç«¯
cd ../client
scp -r dist root@your-server-ip:/var/www/geo-system/client/

# ä¸Šä¼  Landing
cd ../landing
scp -r dist root@your-server-ip:/var/www/geo-system/landing/
```

### ä»»åŠ¡ 4.3ï¼šæœåŠ¡å™¨å®‰è£…ä¾èµ– â­â­

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@your-server-ip

# å®‰è£…åç«¯ä¾èµ–
cd /var/www/geo-system/server
npm ci --production

# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
nano /var/www/geo-system/.env
# ç²˜è´´ä½ çš„ç”Ÿäº§ç¯å¢ƒé…ç½®
```

---

## ç¬¬äº”é˜¶æ®µï¼šNginx é…ç½®ï¼ˆåŠå¤©ï¼‰

### ä»»åŠ¡ 5.1ï¼šåˆ›å»º Nginx é…ç½® â­â­â­

**æ–‡ä»¶ï¼š** `/etc/nginx/sites-available/geo-system`

```nginx
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS ä¸»é…ç½®
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL è¯ä¹¦ï¼ˆç¨åé…ç½®ï¼‰
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # ========== å®‰å…¨ Headers ==========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # ========== ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶ ==========
    location ~ /\. {
        deny all;
        return 404;
    }
    
    location ~ ^/(src|server|node_modules|dist|build) {
        deny all;
        return 404;
    }
    
    location ~ \.(env|json|yml|yaml|config|ini|ts|map)$ {
        deny all;
        return 404;
    }
    
    location ~ \.(bak|backup|old|tmp|temp|swp|~|log)$ {
        deny all;
        return 404;
    }
    
    autoindex off;
    
    # ========== å‰ç«¯ä¸»åº”ç”¨ ==========
    location / {
        root /var/www/geo-system/client/dist;
        try_files $uri $uri/ /index.html;
        
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ========== Landing é¡µ ==========
    location /landing {
        alias /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /landing/index.html;
    }
    
    # ========== åç«¯ API ==========
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_hide_header X-Powered-By;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ========== WebSocket ==========
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
    
    # ========== ä¸Šä¼ æ–‡ä»¶ ==========
    location /uploads {
        alias /var/www/geo-system/server/uploads;
        
        location ~ \.(jpg|jpeg|png|gif|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
    }
}
```

**å¯ç”¨é…ç½®ï¼š**
```bash
# åˆ›å»ºè½¯é“¾æ¥
ln -s /etc/nginx/sites-available/geo-system /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
nginx -t

# é‡å¯ Nginx
systemctl restart nginx
```

### ä»»åŠ¡ 5.2ï¼šé…ç½® SSL è¯ä¹¦ â­â­â­

```bash
# å®‰è£… Certbot
apt install -y certbot python3-certbot-nginx  # Ubuntu
# æˆ–
yum install -y certbot python3-certbot-nginx  # CentOS

# è·å–è¯ä¹¦
certbot --nginx -d your-domain.com -d www.your-domain.com

# è‡ªåŠ¨ç»­æœŸ
certbot renew --dry-run
```

---

## ç¬¬å…­é˜¶æ®µï¼šå¯åŠ¨æœåŠ¡ï¼ˆåŠå¤©ï¼‰

### ä»»åŠ¡ 6.1ï¼šä½¿ç”¨ PM2 å¯åŠ¨åç«¯ â­â­â­

```bash
cd /var/www/geo-system/server

# å¯åŠ¨åº”ç”¨
pm2 start dist/index.js --name geo-backend

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs geo-backend

# æŸ¥çœ‹çŠ¶æ€
pm2 status
```

### ä»»åŠ¡ 6.2ï¼šéªŒè¯éƒ¨ç½² â­â­â­

```bash
# 1. æ£€æŸ¥åç«¯
curl http://localhost:3000/api/health

# 2. æ£€æŸ¥ Nginx
curl http://localhost

# 3. æ£€æŸ¥ HTTPS
curl https://your-domain.com

# 4. æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æ˜¯å¦è¢«ä¿æŠ¤
curl https://your-domain.com/.env  # åº”è¯¥ 404
curl https://your-domain.com/.git/config  # åº”è¯¥ 404
curl https://your-domain.com/server/src/index.ts  # åº”è¯¥ 404
```

---

## ç¬¬ä¸ƒé˜¶æ®µï¼šå®‰å…¨æ£€æŸ¥å’Œä¼˜åŒ–ï¼ˆåŠå¤©ï¼‰

### ä»»åŠ¡ 7.1ï¼šå®‰å…¨æ£€æŸ¥æ¸…å• â­â­â­

```bash
# 1. æ£€æŸ¥ Source Map
curl -I https://your-domain.com/assets/index-*.js.map
# åº”è¯¥è¿”å› 404

# 2. æ£€æŸ¥é”™è¯¯ä¿¡æ¯
curl https://your-domain.com/api/nonexistent
# ä¸åº”è¯¥è¿”å› stack trace

# 3. æ£€æŸ¥ HTTP Headers
curl -I https://your-domain.com
# åº”è¯¥åŒ…å«å®‰å…¨ headers

# 4. æ£€æŸ¥ä¾èµ–æ¼æ´
cd /var/www/geo-system/server
npm audit

# 5. æ£€æŸ¥é˜²ç«å¢™
ufw status  # Ubuntu
# æˆ–
firewall-cmd --list-all  # CentOS
```

### ä»»åŠ¡ 7.2ï¼šæ€§èƒ½ä¼˜åŒ– â­â­

```bash
# 1. å¯ç”¨ Gzip å‹ç¼©
nano /etc/nginx/nginx.conf

# åœ¨ http å—ä¸­æ·»åŠ ï¼š
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss;

# 2. é…ç½®ç¼“å­˜
# å·²åœ¨ Nginx é…ç½®ä¸­è®¾ç½®

# 3. é‡å¯ Nginx
systemctl restart nginx
```

### ä»»åŠ¡ 7.3ï¼šç›‘æ§å’Œæ—¥å¿— â­â­

```bash
# 1. é…ç½® PM2 ç›‘æ§
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7

# 2. æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop  # éœ€è¦å…ˆå®‰è£…ï¼šapt install htop

# 3. æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 4. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs geo-backend --lines 100
```

---

## ğŸ“‹ å®Œæ•´æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] å‰ç«¯ Source Map å·²ç¦ç”¨
- [ ] å‰ç«¯ä»£ç å·²æ··æ·†
- [ ] åç«¯é”™è¯¯å¤„ç†å·²ä¼˜åŒ–
- [ ] å®‰å…¨ä¸­é—´ä»¶å·²æ·»åŠ 
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å¼ºå¯†é’¥å·²ç”Ÿæˆ
- [ ] .gitignore å·²æ›´æ–°
- [ ] ä»£ç å·²ç¼–è¯‘
- [ ] ç¼–è¯‘äº§ç‰©å·²éªŒè¯

### æœåŠ¡å™¨æ£€æŸ¥

- [ ] æœåŠ¡å™¨å·²è´­ä¹°
- [ ] å®‰å…¨ç»„å·²é…ç½®
- [ ] åŸŸåå·²è§£æ
- [ ] Node.js å·²å®‰è£…
- [ ] PostgreSQL å·²å®‰è£…å¹¶é…ç½®
- [ ] Redis å·²å®‰è£…å¹¶é…ç½®
- [ ] Nginx å·²å®‰è£…
- [ ] PM2 å·²å®‰è£…

### éƒ¨ç½²åæ£€æŸ¥

- [ ] ä»£ç å·²ä¸Šä¼ 
- [ ] ä¾èµ–å·²å®‰è£…
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] Nginx é…ç½®å·²ç”Ÿæ•ˆ
- [ ] SSL è¯ä¹¦å·²é…ç½®
- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] ç½‘ç«™å¯ä»¥è®¿é—®
- [ ] API æ­£å¸¸å·¥ä½œ
- [ ] WebSocket æ­£å¸¸å·¥ä½œ

### å®‰å…¨æ£€æŸ¥

- [ ] .env æ–‡ä»¶ä¸å¯è®¿é—®
- [ ] .git ç›®å½•ä¸å¯è®¿é—®
- [ ] æºä»£ç ç›®å½•ä¸å¯è®¿é—®
- [ ] Source Map ä¸å¯è®¿é—®
- [ ] é”™è¯¯ä¿¡æ¯å®‰å…¨
- [ ] HTTP Headers æ­£ç¡®
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] ä¾èµ–æ— æ¼æ´

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

### æœ¬åœ°ç¼–è¯‘è„šæœ¬

**æ–‡ä»¶ï¼š** `deploy-build.sh`

```bash
#!/bin/bash

echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."

# ç¼–è¯‘åç«¯
echo "ğŸ“¦ ç¼–è¯‘åç«¯..."
cd server
npm install
npm run build

# ç¼–è¯‘å‰ç«¯
echo "ğŸ“¦ ç¼–è¯‘å‰ç«¯..."
cd ../client
npm install
npm run build

# ç¼–è¯‘ Landing
echo "ğŸ“¦ ç¼–è¯‘ Landing..."
cd ../landing
npm install
npm run build

echo "âœ… ç¼–è¯‘å®Œæˆï¼"
echo "ğŸ“ ç¼–è¯‘äº§ç‰©ï¼š"
echo "  - server/dist/"
echo "  - client/dist/"
echo "  - landing/dist/"
```

### æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬

**æ–‡ä»¶ï¼š** `deploy-server.sh`

```bash
#!/bin/bash

SERVER_IP="your-server-ip"
SERVER_USER="root"
APP_DIR="/var/www/geo-system"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."

# ä¸Šä¼ åç«¯
echo "ğŸ“¤ ä¸Šä¼ åç«¯..."
scp -r server/dist server/package*.json $SERVER_USER@$SERVER_IP:$APP_DIR/server/

# ä¸Šä¼ å‰ç«¯
echo "ğŸ“¤ ä¸Šä¼ å‰ç«¯..."
scp -r client/dist $SERVER_USER@$SERVER_IP:$APP_DIR/client/

# ä¸Šä¼  Landing
echo "ğŸ“¤ ä¸Šä¼  Landing..."
scp -r landing/dist $SERVER_USER@$SERVER_IP:$APP_DIR/landing/

# é‡å¯æœåŠ¡
echo "ğŸ”„ é‡å¯æœåŠ¡..."
ssh $SERVER_USER@$SERVER_IP << 'EOF'
cd /var/www/geo-system/server
npm ci --production
pm2 restart geo-backend
pm2 save
EOF

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ è®¿é—®ï¼šhttps://your-domain.com"
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: éƒ¨ç½²åç½‘ç«™æ— æ³•è®¿é—®ï¼Ÿ

**æ£€æŸ¥ï¼š**
```bash
# 1. æ£€æŸ¥ Nginx çŠ¶æ€
systemctl status nginx

# 2. æ£€æŸ¥åç«¯çŠ¶æ€
pm2 status

# 3. æ£€æŸ¥ç«¯å£
netstat -tlnp | grep :80
netstat -tlnp | grep :443
netstat -tlnp | grep :3000

# 4. æ£€æŸ¥é˜²ç«å¢™
ufw status
```

### Q2: API è¯·æ±‚å¤±è´¥ï¼Ÿ

**æ£€æŸ¥ï¼š**
```bash
# 1. æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs geo-backend

# 2. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# 3. æµ‹è¯•åç«¯ç›´æ¥è®¿é—®
curl http://localhost:3000/api/health
```

### Q3: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ

**æ£€æŸ¥ï¼š**
```bash
# 1. æ£€æŸ¥ PostgreSQL çŠ¶æ€
systemctl status postgresql

# 2. æµ‹è¯•è¿æ¥
psql -U geo_user -d geo_system -h localhost

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /var/www/geo-system/.env | grep DATABASE_URL
```

### Q4: å¦‚ä½•æ›´æ–°ä»£ç ï¼Ÿ

```bash
# 1. æœ¬åœ°ç¼–è¯‘
./deploy-build.sh

# 2. å¤‡ä»½æœåŠ¡å™¨
ssh root@your-server-ip
cp -r /var/www/geo-system /var/www/geo-system.backup

# 3. ä¸Šä¼ æ–°ä»£ç 
./deploy-server.sh

# 4. éªŒè¯
curl https://your-domain.com
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Vite æ„å»ºé…ç½®](https://vitejs.dev/config/build-options.html)
- [Node.js ç”Ÿäº§æœ€ä½³å®è·µ](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)
- [Nginx é…ç½®æŒ‡å—](https://nginx.org/en/docs/)
- [è…¾è®¯äº‘æ–‡æ¡£](https://cloud.tencent.com/document/product)

### å®‰å…¨èµ„æº
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Node.js å®‰å…¨æœ€ä½³å®è·µ](https://nodejs.org/en/docs/guides/security/)
- [Helmet.js æ–‡æ¡£](https://helmetjs.github.io/)

### å·¥å…·
- [SSL Labs æµ‹è¯•](https://www.ssllabs.com/ssltest/)
- [Security Headers æ£€æŸ¥](https://securityheaders.com/)
- [npm audit](https://docs.npmjs.com/cli/v8/commands/npm-audit)

---

## ğŸ¯ æ€»ç»“

**å…³é”®å®‰å…¨æªæ–½ï¼š**
1. âœ… ç¦ç”¨å‰ç«¯ Source Map
2. âœ… ä»£ç æ··æ·†å’Œå‹ç¼©
3. âœ… åç«¯é”™è¯¯å¤„ç†ä¼˜åŒ–
4. âœ… å®‰å…¨ä¸­é—´ä»¶ï¼ˆHelmetã€é€Ÿç‡é™åˆ¶ï¼‰
5. âœ… Nginx å®‰å…¨é…ç½®
6. âœ… HTTPS å¼ºåˆ¶
7. âœ… ç¯å¢ƒå˜é‡ç®¡ç†
8. âœ… é˜²ç«å¢™é…ç½®

**é¢„è®¡æ—¶é—´ï¼š** 3-5 å¤©
**éš¾åº¦ï¼š** ä¸­ç­‰
**å®‰å…¨ç­‰çº§ï¼š** ğŸŸ¢ é«˜

æŒ‰ç…§è¿™ä¸ªè®¡åˆ’æ‰§è¡Œï¼Œä½ çš„ç³»ç»Ÿå°†å®‰å…¨éƒ¨ç½²åˆ°è…¾è®¯äº‘ï¼
