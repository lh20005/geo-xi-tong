# è…¾è®¯äº‘å¿«é€Ÿéƒ¨ç½²æŒ‡å—

> âœ… æ‰€æœ‰éƒ¨ç½²å‰æ£€æŸ¥å·²é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²ï¼

---

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡ï¼ˆå·²å®Œæˆï¼‰

- âœ… ä»£ç ä¿æŠ¤å·²å®Œæˆ
- âœ… å¼ºå¯†é’¥å·²é…ç½®
- âœ… æ‰€æœ‰é¡¹ç›®å·²ç¼–è¯‘
- âœ… Source Map å·²ç¦ç”¨
- âœ… å®‰å…¨ä¸­é—´ä»¶å·²é…ç½®
- âœ… ç¯å¢ƒå˜é‡å·²ä¿æŠ¤

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šè´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨ï¼ˆ15åˆ†é’Ÿï¼‰

#### 1.1 è®¿é—®è…¾è®¯äº‘æ§åˆ¶å°

https://console.cloud.tencent.com/lighthouse/instance/index

#### 1.2 é€‰æ‹©é…ç½®

```
äº§å“ï¼šè½»é‡åº”ç”¨æœåŠ¡å™¨
åœ°åŸŸï¼šå¹¿å·/ä¸Šæµ·ï¼ˆé€‰æ‹©ç¦»ä½ æœ€è¿‘çš„ï¼‰
é•œåƒï¼šUbuntu Server 22.04 LTS 64ä½
å¥—é¤ï¼š2æ ¸4GBï¼ˆæ¨èï¼‰æˆ– 4æ ¸8GBï¼ˆæ›´å¥½ï¼‰
æ—¶é•¿ï¼š1ä¸ªæœˆï¼ˆå…ˆæµ‹è¯•ï¼‰
```

#### 1.3 é…ç½®å®‰å…¨ç»„

```
å¼€æ”¾ç«¯å£ï¼š
- 22 (SSH)
- 80 (HTTP)
- 443 (HTTPS)
```

#### 1.4 è´­ä¹°å¹¶å¯åŠ¨

ç‚¹å‡»"ç«‹å³è´­ä¹°"ï¼Œç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

---

### ç¬¬äºŒæ­¥ï¼šè¿æ¥æœåŠ¡å™¨ï¼ˆ5åˆ†é’Ÿï¼‰

#### 2.1 è·å–æœåŠ¡å™¨ä¿¡æ¯

åœ¨è…¾è®¯äº‘æ§åˆ¶å°è·å–ï¼š
- å…¬ç½‘ IPï¼š`123.456.789.0`ï¼ˆç¤ºä¾‹ï¼‰
- ç”¨æˆ·åï¼š`ubuntu`
- å¯†ç ï¼šåœ¨æ§åˆ¶å°é‡ç½®å¯†ç 

#### 2.2 SSH è¿æ¥

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ç»ˆç«¯
ssh ubuntu@123.456.789.0

# æ–¹æ³• 2ï¼šä½¿ç”¨è…¾è®¯äº‘ Web Shell
# åœ¨æ§åˆ¶å°ç‚¹å‡»"ç™»å½•"æŒ‰é’®
```

---

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®æœåŠ¡å™¨ç¯å¢ƒï¼ˆ30åˆ†é’Ÿï¼‰

#### 3.1 æ›´æ–°ç³»ç»Ÿ

```bash
sudo apt update
sudo apt upgrade -y
```

#### 3.2 å®‰è£… Node.js 18

```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo bash -
sudo apt install -y nodejs

# éªŒè¯å®‰è£…
node -v  # åº”è¯¥æ˜¾ç¤º v18.x.x
npm -v
```

#### 3.3 å®‰è£… PostgreSQL

```bash
sudo apt install -y postgresql postgresql-contrib

# å¯åŠ¨æœåŠ¡
sudo systemctl enable postgresql
sudo systemctl start postgresql

# é…ç½®æ•°æ®åº“
sudo -u postgres psql << EOF
CREATE DATABASE geo_system;
CREATE USER geo_user WITH PASSWORD 'H2SwIAkyzT1G4mAhkbtSULfG';
GRANT ALL PRIVILEGES ON DATABASE geo_system TO geo_user;
\q
EOF
```

#### 3.4 å®‰è£… Redis

```bash
sudo apt install -y redis-server

# é…ç½® Redis
sudo nano /etc/redis/redis.conf
# æ‰¾åˆ°å¹¶ä¿®æ”¹ï¼š
# requirepass your_redis_password
# bind 127.0.0.1

# é‡å¯ Redis
sudo systemctl restart redis
sudo systemctl enable redis
```

#### 3.5 å®‰è£… Nginx

```bash
sudo apt install -y nginx

# å¯åŠ¨æœåŠ¡
sudo systemctl enable nginx
sudo systemctl start nginx
```

#### 3.6 å®‰è£… PM2

```bash
sudo npm install -g pm2
```

#### 3.7 å®‰è£… Puppeteer ä¾èµ–

```bash
sudo apt install -y \
  chromium-browser \
  fonts-liberation \
  libasound2 \
  libatk-bridge2.0-0 \
  libatk1.0-0 \
  libcups2 \
  libdbus-1-3 \
  libdrm2 \
  libgbm1 \
  libgtk-3-0 \
  libnspr4 \
  libnss3 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  xdg-utils
```

---

### ç¬¬å››æ­¥ï¼šä¸Šä¼ ä»£ç ï¼ˆ15åˆ†é’Ÿï¼‰

#### 4.1 åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºç›®å½•

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
sudo mkdir -p /var/www/geo-system/{server,client,landing}
sudo chown -R ubuntu:ubuntu /var/www/geo-system
```

#### 4.2 åœ¨æœ¬åœ°æ‰“åŒ…ä»£ç 

```bash
# åœ¨ä½ çš„æœ¬åœ°ç”µè„‘ä¸Šæ‰§è¡Œ

# æ‰“åŒ…åç«¯
cd server
tar -czf server-dist.tar.gz dist package.json package-lock.json

# æ‰“åŒ…å‰ç«¯
cd ../client
tar -czf client-dist.tar.gz dist

# æ‰“åŒ… Landing
cd ../landing
tar -czf landing-dist.tar.gz dist
```

#### 4.3 ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# åœ¨ä½ çš„æœ¬åœ°ç”µè„‘ä¸Šæ‰§è¡Œ
# æ›¿æ¢ 123.456.789.0 ä¸ºä½ çš„æœåŠ¡å™¨ IP

# ä¸Šä¼ åç«¯
scp server/server-dist.tar.gz ubuntu@123.456.789.0:/var/www/geo-system/server/

# ä¸Šä¼ å‰ç«¯
scp client/client-dist.tar.gz ubuntu@123.456.789.0:/var/www/geo-system/client/

# ä¸Šä¼  Landing
scp landing/landing-dist.tar.gz ubuntu@123.456.789.0:/var/www/geo-system/landing/
```

#### 4.4 åœ¨æœåŠ¡å™¨ä¸Šè§£å‹

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

# è§£å‹åç«¯
cd /var/www/geo-system/server
tar -xzf server-dist.tar.gz
rm server-dist.tar.gz

# è§£å‹å‰ç«¯
cd /var/www/geo-system/client
tar -xzf client-dist.tar.gz
rm client-dist.tar.gz

# è§£å‹ Landing
cd /var/www/geo-system/landing
tar -xzf landing-dist.tar.gz
rm landing-dist.tar.gz
```

---

### ç¬¬äº”æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆ10åˆ†é’Ÿï¼‰

#### 5.1 åˆ›å»º .env æ–‡ä»¶

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /var/www/geo-system
nano .env
```

#### 5.2 å¡«å…¥é…ç½®

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://geo_user:H2SwIAkyzT1G4mAhkbtSULfG@localhost:5432/geo_system

# AI APIé…ç½®ï¼ˆä½¿ç”¨ä½ çš„çœŸå® API Keyï¼‰
DEEPSEEK_API_KEY=sk-your-real-deepseek-key
GEMINI_API_KEY=AIzaSy-your-real-gemini-key

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# ğŸ”’ å¼ºå¯†é’¥ï¼ˆä½¿ç”¨ç”Ÿæˆçš„ï¼‰
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144
JWT_REFRESH_SECRET=fcb44972cd8b6833229122d109cf7bca8254332045fef7a683de973fd84ec392

# ç®¡ç†å‘˜è´¦å·
ADMIN_USERNAME=lzc2005
ADMIN_PASSWORD=jehI2oBuNMMJehMM

# CORS å…è®¸çš„æ¥æºï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
ALLOWED_ORIGINS=http://123.456.789.0,http://your-domain.com

# Redisé…ç½®
REDIS_URL=redis://:your_redis_password@localhost:6379
```

#### 5.3 ä¿å­˜å¹¶è®¾ç½®æƒé™

```bash
# Ctrl+O ä¿å­˜ï¼ŒCtrl+X é€€å‡º

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 .env

# éªŒè¯æƒé™
ls -la .env
# åº”è¯¥æ˜¾ç¤ºï¼š-rw------- 1 ubuntu ubuntu
```

---

### ç¬¬å…­æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶å¯åŠ¨ï¼ˆ10åˆ†é’Ÿï¼‰

#### 6.1 å®‰è£…åç«¯ä¾èµ–

```bash
cd /var/www/geo-system/server
npm ci --production
```

#### 6.2 è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# å¦‚æœæœ‰è¿ç§»è„šæœ¬
npm run db:migrate
```

#### 6.3 å¯åŠ¨åç«¯æœåŠ¡

```bash
# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start dist/index.js --name geo-backend

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs geo-backend

# æŸ¥çœ‹çŠ¶æ€
pm2 status
```

---

### ç¬¬ä¸ƒæ­¥ï¼šé…ç½® Nginxï¼ˆ15åˆ†é’Ÿï¼‰

#### 7.1 åˆ›å»º Nginx é…ç½®

```bash
sudo nano /etc/nginx/sites-available/geo-system
```

#### 7.2 å¡«å…¥é…ç½®

```nginx
server {
    listen 80;
    server_name 123.456.789.0;  # æ›¿æ¢ä¸ºä½ çš„ IP æˆ–åŸŸå
    
    # ========== å®‰å…¨ Headers ==========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # ========== ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶ ==========
    location ~ /\. {
        deny all;
        return 404;
    }
    
    location ~ ^/(src|server|node_modules) {
        deny all;
        return 404;
    }
    
    location ~ \.(env|json|yml|yaml|config|ts|map)$ {
        deny all;
        return 404;
    }
    
    autoindex off;
    
    # ========== å‰ç«¯ä¸»åº”ç”¨ ==========
    location / {
        root /var/www/geo-system/client/dist;
        try_files $uri $uri/ /index.html;
        
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ========== Landing é¡µ ==========
    location /landing {
        alias /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /landing/index.html;
    }
    
    # ========== åç«¯ API ==========
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_hide_header X-Powered-By;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ========== WebSocket ==========
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
    
    # ========== ä¸Šä¼ æ–‡ä»¶ ==========
    location /uploads {
        alias /var/www/geo-system/server/uploads;
        
        location ~ \.(jpg|jpeg|png|gif|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
    }
}
```

#### 7.3 å¯ç”¨é…ç½®

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/geo-system /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

---

### ç¬¬å…«æ­¥ï¼šéªŒè¯éƒ¨ç½²ï¼ˆ5åˆ†é’Ÿï¼‰

#### 8.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯
pm2 status

# æ£€æŸ¥ Nginx
sudo systemctl status nginx

# æ£€æŸ¥ PostgreSQL
sudo systemctl status postgresql

# æ£€æŸ¥ Redis
sudo systemctl status redis
```

#### 8.2 æµ‹è¯•è®¿é—®

```bash
# æµ‹è¯•åç«¯ API
curl http://localhost:3000/api/health

# æµ‹è¯• Nginx
curl http://localhost
```

#### 8.3 æµè§ˆå™¨è®¿é—®

```
å‰ç«¯ä¸»åº”ç”¨ï¼šhttp://123.456.789.0
Landing é¡µï¼šhttp://123.456.789.0/landing
APIï¼šhttp://123.456.789.0/api/health
```

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

### è®¿é—®åœ°å€

```
å‰ç«¯ï¼šhttp://your-server-ip
ç®¡ç†å‘˜ç™»å½•ï¼š
  ç”¨æˆ·åï¼šlzc2005
  å¯†ç ï¼šjehI2oBuNMMJehMM
```

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs geo-backend

# é‡å¯æœåŠ¡
pm2 restart geo-backend

# åœæ­¢æœåŠ¡
pm2 stop geo-backend

# åˆ é™¤æœåŠ¡
pm2 delete geo-backend
```

### Nginx ç®¡ç†

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿æ¥æ•°æ®åº“
psql -U geo_user -d geo_system -h localhost

# å¤‡ä»½æ•°æ®åº“
pg_dump -U geo_user geo_system > backup.sql

# æ¢å¤æ•°æ®åº“
psql -U geo_user geo_system < backup.sql
```

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥

### éƒ¨ç½²åå¿…é¡»æ£€æŸ¥

```bash
# 1. æ£€æŸ¥ .env æ–‡ä»¶æƒé™
ls -la /var/www/geo-system/.env
# åº”è¯¥æ˜¯ï¼š-rw------- 1 ubuntu ubuntu

# 2. æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æ˜¯å¦å¯è®¿é—®
curl http://your-server-ip/.env  # åº”è¯¥ 404
curl http://your-server-ip/.git/config  # åº”è¯¥ 404
curl http://your-server-ip/server/src/index.ts  # åº”è¯¥ 404

# 3. æ£€æŸ¥ HTTP Headers
curl -I http://your-server-ip
# åº”è¯¥åŒ…å«å®‰å…¨ headers

# 4. æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

---

## ğŸ“ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### 1. é…ç½®åŸŸåï¼ˆæ¨èï¼‰

```bash
# è´­ä¹°åŸŸååï¼Œæ·»åŠ  DNS è§£æ
# A è®°å½•ï¼š@ â†’ æœåŠ¡å™¨ IP
# A è®°å½•ï¼šwww â†’ æœåŠ¡å™¨ IP
```

### 2. é…ç½® HTTPSï¼ˆæ¨èï¼‰

```bash
# å®‰è£… Certbot
sudo apt install -y certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### 3. é…ç½®ç›‘æ§

```bash
# å®‰è£… PM2 ç›‘æ§
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç½‘ç«™æ— æ³•è®¿é—®ï¼Ÿ

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :3000

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### Q2: API è¯·æ±‚å¤±è´¥ï¼Ÿ

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs geo-backend

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æµ‹è¯•åç«¯ç›´æ¥è®¿é—®
curl http://localhost:3000/api/health
```

### Q3: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ

```bash
# æ£€æŸ¥ PostgreSQL çŠ¶æ€
sudo systemctl status postgresql

# æµ‹è¯•è¿æ¥
psql -U geo_user -d geo_system -h localhost

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /var/www/geo-system/.env | grep DATABASE_URL
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è…¾è®¯äº‘éƒ¨ç½²æºä»£ç ä¿æŠ¤è®¡åˆ’.md](./è…¾è®¯äº‘éƒ¨ç½²æºä»£ç ä¿æŠ¤è®¡åˆ’.md)
- [è…¾è®¯äº‘æœåŠ¡å™¨é•œåƒé€‰æ‹©æŒ‡å—.md](./è…¾è®¯äº‘æœåŠ¡å™¨é•œåƒé€‰æ‹©æŒ‡å—.md)
- [ä»£ç ä¿æŠ¤å®ŒæˆæŠ¥å‘Š.md](./ä»£ç ä¿æŠ¤å®ŒæˆæŠ¥å‘Š.md)

---

**é¢„è®¡æ€»è€—æ—¶ï¼š** 1.5-2 å°æ—¶  
**éš¾åº¦ï¼š** ä¸­ç­‰  
**æˆåŠŸç‡ï¼š** é«˜

ç¥ä½ éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€
