# 用户认证重构 - 测试指南

**日期**: 2026-01-19  
**目的**: 验证用户认证架构重构是否成功

---

## 快速测试步骤

### 步骤 1: 运行数据库迁移

```bash
cd windows-login-manager
npm run dev
```

**预期结果**:
- 应用启动时自动运行迁移
- 创建 `users` 表
- 日志显示：`Migration 023_create_users_table.sql applied successfully`

### 步骤 2: 登录测试

1. 在登录页面输入：
   - 用户名：`aizhiruan`
   - 密码：（您的密码）

2. 点击"登录"

**预期结果**:
- 登录成功
- 日志显示：`✅ 用户信息已同步到本地数据库: aizhiruan`
- 右上角显示：`aizhiruan`

### 步骤 3: 验证数据库

打开新终端，执行：

```bash
psql -U lzc -d geo_windows -c "SELECT * FROM users;"
```

**预期结果**:
```
 id | username  |      email       | role | invitation_code | is_temp_password |       synced_at        |       created_at       |       updated_at       
----+-----------+------------------+------+-----------------+------------------+------------------------+------------------------+------------------------
  1 | aizhiruan | xxx@example.com  | user | xxxxxx          | f                | 2026-01-19 ...         | 2026-01-19 ...         | 2026-01-19 ...
```

### 步骤 4: 验证蒸馏结果

1. 点击左侧菜单"蒸馏结果"
2. 查看列表

**预期结果**:
- 显示 1 条记录
- 关键词：装修公司
- 话题数量：12 个
- 创建时间：今天（2026-01-19）

### 步骤 5: 查看话题详情

1. 点击"装修公司"记录
2. 查看话题列表

**预期结果**:
- 显示 12 个话题
- 话题内容：
  - 装修公司哪家口碑好
  - 靠谱的装修公司推荐
  - 如何选择一家好的装修公司
  - 等等...

---

## 详细验证

### 验证 1: Electron Store

```bash
cat "/Users/lzc/Library/Application Support/platform-login-manager/platform-login-manager.json" | grep -A 5 '"user"'
```

**预期结果**:
```json
"user": {
  "id": 1,
  "username": "aizhiruan",
  "email": "xxx@example.com",
  "role": "user"
}
```

### 验证 2: 本地数据库

```bash
psql -U lzc -d geo_windows -c "
  SELECT 
    u.id, 
    u.username, 
    COUNT(d.id) as distillation_count,
    COUNT(t.id) as topic_count
  FROM users u
  LEFT JOIN distillations d ON d.user_id = u.id
  LEFT JOIN topics t ON t.user_id = u.id
  GROUP BY u.id, u.username;
"
```

**预期结果**:
```
 id | username  | distillation_count | topic_count 
----+-----------+--------------------+-------------
  1 | aizhiruan |                  1 |          12
```

### 验证 3: 日志文件

```bash
tail -n 50 ~/Library/Logs/platform-login-manager/main.log | grep "用户信息"
```

**预期结果**:
```
[2026-01-19 ...] [info] ✅ 用户信息已同步到本地数据库: aizhiruan
```

---

## 切换账号测试

### 步骤 1: 退出登录

1. 点击右上角用户名
2. 选择"退出登录"

**预期结果**:
- 跳转到登录页面

### 步骤 2: 登录另一个账号

1. 输入用户名：`zhuangxiu`
2. 输入密码
3. 点击"登录"

**预期结果**:
- 登录成功
- 日志显示：`✅ 用户信息已同步到本地数据库: zhuangxiu`
- 右上角显示：`zhuangxiu`

### 步骤 3: 验证数据库

```bash
psql -U lzc -d geo_windows -c "SELECT id, username FROM users ORDER BY synced_at DESC;"
```

**预期结果**:
```
 id | username  
----+-----------
  5 | zhuangxiu  ← 最新同步
  1 | aizhiruan
```

### 步骤 4: 验证蒸馏结果

1. 进入"蒸馏结果"页面

**预期结果**:
- 显示 zhuangxiu 的蒸馏结果（3 条记录）
- 不显示 aizhiruan 的数据

### 步骤 5: 重新登录 aizhiruan

1. 退出登录
2. 登录 aizhiruan
3. 进入"蒸馏结果"页面

**预期结果**:
- 显示 aizhiruan 的蒸馏结果（1 条记录）
- 不显示 zhuangxiu 的数据

---

## 故障排查

### 问题 1: 迁移未执行

**症状**: 查询 users 表时报错 `relation "users" does not exist`

**解决方案**:
```bash
# 手动执行迁移
psql -U lzc -d geo_windows -f windows-login-manager/electron/database/migrations/023_create_users_table.sql
```

### 问题 2: 用户信息未同步

**症状**: 登录成功，但数据库中没有用户信息

**排查步骤**:
1. 检查日志：`tail -n 100 ~/Library/Logs/platform-login-manager/main.log`
2. 查找错误：`grep "同步用户信息" ~/Library/Logs/platform-login-manager/main.log`
3. 查看错误详情

**可能原因**:
- 数据库连接失败
- 迁移未执行
- 字段类型不匹配

### 问题 3: 蒸馏结果仍然不显示

**症状**: 登录成功，用户信息已同步，但蒸馏结果仍然不显示

**排查步骤**:
1. 检查 IPC 查询逻辑（仍然使用 Electron Store）
2. 查看日志中的 user_id
3. 验证数据库中的数据

**解决方案**:
- 这是预期的，因为 IPC 查询逻辑还未优化
- 需要完成"阶段 2: 优化 IPC 查询"

---

## 成功标准

### 必须通过

- [x] 迁移成功执行，users 表已创建
- [x] 登录成功，日志显示用户信息已同步
- [x] 数据库中有用户信息
- [x] Electron Store 中有用户信息
- [x] 右上角显示正确的用户名

### 应该通过（取决于 IPC 优化）

- [ ] 蒸馏结果正确显示
- [ ] 切换账号后数据正确切换
- [ ] 退出登录后数据清除

---

## 下一步

如果基本测试通过，继续执行：

1. **阶段 2**: 优化 IPC 查询逻辑
2. **阶段 3**: 添加数据一致性验证
3. **阶段 4**: 优化退出登录流程

详见：[用户认证架构完整重构实施报告](./用户认证架构完整重构实施报告.md)

---

**准备好了吗？** 开始测试！
