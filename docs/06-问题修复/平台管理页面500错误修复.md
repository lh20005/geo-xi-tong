# å¹³å°ç®¡ç†é¡µé¢ 500 é”™è¯¯ä¿®å¤

## é—®é¢˜æè¿°

è®¿é—® `http://43.143.163.6/platform-management` é¡µé¢æ—¶ï¼Œå‡ºç°"åŠ è½½æ•°æ®å¤±è´¥"é”™è¯¯ã€‚

æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºå¤šä¸ª API 500 é”™è¯¯ï¼š
```
GET /api/articles?page=1&pageSize=10&publishStatus=unpublished 500
GET /api/publishing/tasks?page=1&pageSize=1000 ERR_EMPTY_RESPONSE
```

## æ ¹æœ¬åŸå› 

`articles` è¡¨ç¼ºå°‘ `publishing_status` åˆ—ï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚

### é”™è¯¯è¯¦æƒ…

```
column a.publishing_status does not exist
```

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºæ•°æ®åº“è¿ç§»

åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼š`server/src/db/migrations/012_add_publishing_status_column.sql`

```sql
-- ==================== UP ====================
-- æ·»åŠ  publishing_status åˆ—åˆ° articles è¡¨

ALTER TABLE articles 
ADD COLUMN IF NOT EXISTS publishing_status VARCHAR(20) DEFAULT 'unpublished';

-- æ›´æ–°ç°æœ‰æ•°æ®
UPDATE articles 
SET publishing_status = CASE 
  WHEN is_published = true THEN 'published'
  ELSE 'unpublished'
END
WHERE publishing_status = 'unpublished';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_articles_publishing_status 
ON articles(publishing_status);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN articles.publishing_status IS 'å‘å¸ƒçŠ¶æ€: unpublished(æœªå‘å¸ƒ), publishing(å‘å¸ƒä¸­), published(å·²å‘å¸ƒ), failed(å‘å¸ƒå¤±è´¥)';

-- ==================== DOWN ====================
DROP INDEX IF EXISTS idx_articles_publishing_status;
ALTER TABLE articles DROP COLUMN IF EXISTS publishing_status;
```

### 2. æ‰§è¡Œè¿ç§»

```bash
# æ–¹æ³•1ï¼šåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œ
ssh ubuntu@43.143.163.6
PGPASSWORD='H2SwIAkyzT1G4mAhkbtSULfG' psql -h localhost -U geo_user -d geo_system <<EOF
ALTER TABLE articles ADD COLUMN IF NOT EXISTS publishing_status VARCHAR(20) DEFAULT 'unpublished';
UPDATE articles SET publishing_status = CASE WHEN is_published = true THEN 'published' ELSE 'unpublished' END;
CREATE INDEX IF NOT EXISTS idx_articles_publishing_status ON articles(publishing_status);
EOF

# æ–¹æ³•2ï¼šä½¿ç”¨è¿ç§»ç³»ç»Ÿï¼ˆæ¨èï¼‰
cd /var/www/geo-system/server
npm run db:migrate
```

### 3. éªŒè¯ä¿®å¤

```bash
# éªŒè¯åˆ—å·²æ·»åŠ 
psql -U geo_user -d geo_system -c "\d articles" | grep publishing_status

# æµ‹è¯• API
curl "http://43.143.163.6/api/articles?page=1&pageSize=10&publishStatus=unpublished"
# åº”è¯¥è¿”å›ï¼š{"articles":[],"total":0,"page":1,"pageSize":10}

curl "http://43.143.163.6/api/publishing/tasks?page=1&pageSize=10"
# åº”è¯¥è¿”å›ï¼š{"success":true,"data":{"tasks":[],"total":0}}
```

## æŠ€æœ¯ç»†èŠ‚

### publishing_status å­—æ®µè¯´æ˜

| å€¼ | è¯´æ˜ |
|---|---|
| `unpublished` | æœªå‘å¸ƒï¼ˆé»˜è®¤ï¼‰ |
| `publishing` | å‘å¸ƒä¸­ |
| `published` | å·²å‘å¸ƒ |
| `failed` | å‘å¸ƒå¤±è´¥ |

### ä¸ is_published çš„å…³ç³»

- `is_published` (boolean) - ç®€å•çš„å·²å‘å¸ƒ/æœªå‘å¸ƒæ ‡è®°
- `publishing_status` (varchar) - æ›´è¯¦ç»†çš„å‘å¸ƒçŠ¶æ€ï¼Œæ”¯æŒä¸­é—´çŠ¶æ€

è¿ç§»æ—¶ä¼šæ ¹æ® `is_published` çš„å€¼åˆå§‹åŒ– `publishing_status`ï¼š
- `is_published = true` â†’ `publishing_status = 'published'`
- `is_published = false` â†’ `publishing_status = 'unpublished'`

## ç›¸å…³ API

### 1. è·å–æ–‡ç« åˆ—è¡¨

```
GET /api/articles?page=1&pageSize=10&publishStatus=unpublished
```

**å‚æ•°ï¼š**
- `publishStatus`: å‘å¸ƒçŠ¶æ€è¿‡æ»¤ï¼ˆunpublished, publishing, published, failedï¼‰

### 2. è·å–å‘å¸ƒä»»åŠ¡

```
GET /api/publishing/tasks?page=1&pageSize=10
```

### 3. è·å–å¹³å°é…ç½®

```
GET /api/publishing/platforms
```

### 4. è·å–è´¦å·åˆ—è¡¨

```
GET /api/publishing/accounts
```

## å½±å“èŒƒå›´

### å—å½±å“çš„é¡µé¢

- âœ… å¹³å°ç®¡ç†é¡µé¢ (`/platform-management`)
- âœ… æ–‡ç« åˆ—è¡¨é¡µé¢ (`/articles`)
- âœ… å‘å¸ƒä»»åŠ¡é¡µé¢ (`/publishing-tasks`)
- âœ… Dashboard é¡µé¢ï¼ˆæ–‡ç« ç»Ÿè®¡ï¼‰

### å—å½±å“çš„åŠŸèƒ½

- âœ… æ–‡ç« å‘å¸ƒçŠ¶æ€æŸ¥è¯¢
- âœ… å‘å¸ƒä»»åŠ¡åˆ›å»º
- âœ… å‘å¸ƒè®°å½•æŸ¥çœ‹
- âœ… æ–‡ç« ç»Ÿè®¡

## é¢„é˜²æªæ–½

### 1. ä½¿ç”¨è¿ç§»ç³»ç»Ÿ

æ‰€æœ‰æ•°æ®åº“å˜æ›´éƒ½åº”è¯¥é€šè¿‡è¿ç§»ç³»ç»Ÿè¿›è¡Œï¼š

```bash
# åˆ›å»ºè¿ç§»
npm run db:create -- add_new_column

# æ‰§è¡Œè¿ç§»
npm run db:migrate

# æŸ¥çœ‹çŠ¶æ€
npm run db:status
```

### 2. éƒ¨ç½²å‰æ£€æŸ¥

éƒ¨ç½²å‰è¿è¡Œå®Œæ•´çš„æ•°æ®åº“è¿ç§»ï¼š

```bash
./scripts/deployment/deploy-migrations.sh
```

### 3. API æµ‹è¯•

éƒ¨ç½²åæµ‹è¯•å…³é”® APIï¼š

```bash
# æµ‹è¯•æ–‡ç«  API
curl "http://YOUR_SERVER/api/articles?page=1&pageSize=10"

# æµ‹è¯•å‘å¸ƒ API
curl "http://YOUR_SERVER/api/publishing/platforms"
curl "http://YOUR_SERVER/api/publishing/accounts"
curl "http://YOUR_SERVER/api/publishing/tasks?page=1&pageSize=10"
```

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [æ•°æ®åº“è¿ç§»æŒ‡å—](../03-éƒ¨ç½²æŒ‡å—/DATABASE_MIGRATION_GUIDE.md)
- ğŸ“– [éƒ¨ç½²é—®é¢˜æ’æŸ¥](../03-éƒ¨ç½²æŒ‡å—/DEPLOYMENT_TROUBLESHOOTING.md)
- ğŸ“– [API ä¿®å¤æˆåŠŸ](./API_FIX_SUCCESS.md)

## æ€»ç»“

âœ… **é—®é¢˜å·²è§£å†³** - æ·»åŠ  `publishing_status` åˆ—  
âœ… **API æ­£å¸¸** - æ‰€æœ‰ç›¸å…³ API è¿”å› 200  
âœ… **é¡µé¢æ­£å¸¸** - å¹³å°ç®¡ç†é¡µé¢å¯ä»¥æ­£å¸¸åŠ è½½  
âœ… **è¿ç§»å·²åˆ›å»º** - 012_add_publishing_status_column.sql  

---

**ä¿®å¤æ—¶é—´**: 2025-12-27  
**ä¿®å¤äºº**: Kiro AI Assistant  
**çŠ¶æ€**: âœ… å·²ä¿®å¤
