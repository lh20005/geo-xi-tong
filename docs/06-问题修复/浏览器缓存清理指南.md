# 浏览器缓存清理指南

## 问题

部署新版本后，浏览器仍然加载旧的 JavaScript 文件，导致功能不正常。

### 症状

- 保存配置返回 401 错误
- 新功能不可用
- 控制台显示旧的 JS 文件名（如 `index-CMdy-wqx.js` 而不是 `index-CHgsGOYu.js`）

## 原因

浏览器缓存了旧的 HTML 和 JavaScript 文件。

## 解决方案

### 方法 1：硬刷新（推荐）⭐

最快速的方法，适合大多数情况。

#### Windows / Linux
```
Ctrl + Shift + R
或
Ctrl + F5
```

#### Mac
```
Cmd + Shift + R
或
Cmd + Option + R
```

### 方法 2：清除浏览器缓存

#### Chrome
1. 按 `F12` 打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

或者：
1. 设置 → 隐私和安全 → 清除浏览数据
2. 选择"缓存的图片和文件"
3. 点击"清除数据"

#### Firefox
1. 按 `Ctrl + Shift + Delete`（Mac: `Cmd + Shift + Delete`）
2. 选择"缓存"
3. 点击"立即清除"

#### Safari
1. 偏好设置 → 高级
2. 勾选"在菜单栏中显示开发菜单"
3. 开发 → 清空缓存

### 方法 3：无痕模式测试

打开无痕/隐私浏览窗口测试：

- Chrome: `Ctrl + Shift + N`（Mac: `Cmd + Shift + N`）
- Firefox: `Ctrl + Shift + P`（Mac: `Cmd + Shift + P`）
- Safari: `Cmd + Shift + N`

### 方法 4：禁用缓存（开发者）

开发者工具中禁用缓存：

1. 按 `F12` 打开开发者工具
2. Network 标签
3. 勾选"Disable cache"
4. 保持开发者工具打开状态

## 验证是否成功

### 1. 检查 JS 文件名

打开开发者工具 → Network 标签 → 刷新页面

查看加载的 JS 文件名：
- ✅ 正确：`index-CHgsGOYu.js`（新版本，18:08）
- ❌ 错误：`index-CMdy-wqx.js`（旧版本，16:28）

### 2. 检查缓存头

在 Network 标签中点击 HTML 文件，查看 Response Headers：

```
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
```

### 3. 测试功能

尝试保存 API 配置：
- ✅ 成功：显示"API配置保存成功！"
- ❌ 失败：返回 401 错误

## 预防措施

### 服务器端（已实施）✅

**Nginx 配置已更新：**

```nginx
# HTML 文件不缓存
location ~ \.html$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# JS/CSS 文件长期缓存（文件名包含hash）
location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

**工作原理：**
- HTML 永不缓存 → 总是获取最新版本
- JS/CSS 长期缓存 → 文件名包含 hash，内容变化时文件名也变化
- 浏览器会自动加载新的 JS/CSS 文件

### 客户端

**开发时：**
- 保持开发者工具打开
- 勾选"Disable cache"

**部署后：**
- 通知用户硬刷新
- 或使用无痕模式测试

## 技术细节

### 为什么会缓存？

浏览器缓存是为了提升性能：
- 减少网络请求
- 加快页面加载
- 节省带宽

### 缓存策略

| 资源类型 | 缓存策略 | 原因 |
|---------|---------|------|
| HTML | 不缓存 | 需要总是获取最新版本 |
| JS/CSS（带hash） | 长期缓存（1年） | 文件名变化时自动更新 |
| 图片/字体 | 长期缓存（1年） | 很少变化 |
| API 响应 | 不缓存 | 数据实时性 |

### Hash 文件名

Vite 构建时会在文件名中添加 hash：

```
index-CMdy-wqx.js  ← 旧版本
index-CHgsGOYu.js  ← 新版本
```

当代码变化时，hash 也会变化，浏览器会自动下载新文件。

## 常见问题

### Q1: 硬刷新后仍然是旧版本

**可能原因：**
1. 代理服务器缓存
2. CDN 缓存
3. Service Worker 缓存

**解决：**
```javascript
// 在浏览器控制台执行
navigator.serviceWorker.getRegistrations().then(registrations => {
  registrations.forEach(registration => registration.unregister());
});
```

### Q2: 部分用户看到旧版本

**原因：** 用户没有刷新页面

**解决：**
- 在应用中添加版本检测
- 提示用户刷新页面

### Q3: 移动端如何清除缓存？

**iOS Safari：**
1. 设置 → Safari
2. 清除历史记录与网站数据

**Android Chrome：**
1. 设置 → 隐私和安全
2. 清除浏览数据

## 自动化方案（未来）

### 版本检测

在应用中添加版本检测：

```typescript
// 定期检查版本
setInterval(async () => {
  const response = await fetch('/version.json');
  const { version } = await response.json();
  
  if (version !== currentVersion) {
    // 提示用户刷新
    Modal.info({
      title: '新版本可用',
      content: '检测到新版本，请刷新页面以获取最新功能',
      onOk: () => window.location.reload()
    });
  }
}, 60000); // 每分钟检查一次
```

### Service Worker

使用 Service Worker 控制缓存：

```javascript
// 检测到新版本时自动更新
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => caches.delete(cacheName))
      );
    })
  );
});
```

## 相关文档

- 📖 [Nginx 配置](../../config/nginx/geo-system-fixed.conf)
- 📖 [前端构建配置](../../client/vite.config.ts)
- 📖 [部署指南](../03-部署指南/腾讯云快速部署指南.md)

## 总结

✅ **Nginx 已配置** - HTML 不缓存，JS/CSS 长期缓存  
✅ **用户操作** - 硬刷新（Ctrl+Shift+R）  
✅ **验证方法** - 检查 JS 文件名和功能  
✅ **预防措施** - 使用 hash 文件名  

---

**创建时间**: 2025-12-27  
**作者**: Kiro AI Assistant  
**状态**: ✅ 已实施
