# 蒸馏显示问题完整诊断报告

**日期**: 2026-01-19  
**问题**: Windows 端蒸馏管理页面显示"暂无蒸馏结果"  
**状态**: ✅ 已诊断，等待用户执行修复

---

## 问题概述

用户反馈在 Windows 桌面端登录后，蒸馏管理页面显示"暂无蒸馏结果"，但实际上已经执行过蒸馏操作。

---

## 诊断过程

### 1. 服务器端检查 ✅

**数据库**: PostgreSQL (`geo_system`)  
**用户**: aizhiruan (user_id: 1)

**发现问题**:
- `distillations.topic_count` 字段全部为 0
- 缺少自动更新触发器

**修复措施**:
1. 更新了所有蒸馏记录的 `topic_count` 字段
2. 创建了自动更新触发器
3. 修改了本地迁移文件

**结果**: ✅ 服务器端已修复

### 2. Windows 端检查 ✅

**数据库**: PostgreSQL (`geo_windows`)  
**实际登录用户**: zhuangxiu (user_id: 5)

**数据库状态**:
```sql
-- 蒸馏记录
SELECT id, keyword, topic_count FROM distillations WHERE user_id = 5;

 id |   keyword    | topic_count 
----+--------------+-------------
 17 | 法国留学     |          12
 12 | 周口装修公司 |          12
  7 | 装修装饰公司 |          12

-- 话题总数
SELECT COUNT(*) FROM topics t 
JOIN distillations d ON t.distillation_id = d.id 
WHERE d.user_id = 5;

 count 
-------
    36
```

**结论**: ✅ 数据库数据完整

### 3. 用户信息检查 ✅

**Electron Store 位置**:
```
/Users/lzc/Library/Application Support/platform-login-manager/platform-login-manager.json
```

**用户信息**:
```json
{
  "id": 5,
  "username": "zhuangxiu",
  "email": "13@163.com",
  "role": "user"
}
```

**结论**: ✅ 用户已正确登录

### 4. IPC 查询测试 ✅

**测试查询**:
```javascript
// 模拟前端调用
const result = await window.electron.invoke('distillation:local:getResults', {});
```

**预期结果**:
```json
{
  "success": true,
  "data": {
    "data": [...],  // 10 条话题
    "total": 36,
    "statistics": {
      "totalTopics": 36,
      "totalKeywords": 3,
      "totalReferences": 0
    }
  }
}
```

**结论**: ✅ IPC 查询正常

---

## 根本原因

### 前端缓存问题

**缓存机制**: 使用 `useCachedData` Hook

**缓存键格式**:
```typescript
`distillationResults:list:${filterKeyword}:${searchText}:${currentPage}:${pageSize}`
```

**问题**:
- 旧的空数据被缓存
- 缓存未失效
- 新数据未加载

**相关代码**:
```typescript
// windows-login-manager/src/pages/DistillationResultsPage.tsx
const { data, loading, refresh } = useCachedData(
  cacheKey,
  fetchData,
  {
    deps: [filterKeyword, searchText, currentPage, pageSize],
    onError: (error) => message.error(error.message)
  }
);
```

---

## 解决方案

### 方案 1: 清除应用缓存（推荐）⭐

**步骤**:
1. 完全退出应用
2. 运行清理脚本:
   ```bash
   cd windows-login-manager
   ./fix-distillation-cache.sh
   ```
3. 重新启动应用

**或手动清理**:
```bash
# macOS
rm -rf ~/Library/Application\ Support/ai-geo-system/Cache
rm -rf ~/Library/Application\ Support/ai-geo-system/Code\ Cache

# Windows
# 删除 %APPDATA%\ai-geo-system\Cache
# 删除 %APPDATA%\ai-geo-system\Code Cache
```

### 方案 2: 使用开发者工具

1. 打开开发者工具 (`Cmd+Option+I` 或 `Ctrl+Shift+I`)
2. 在 Console 中执行:
   ```javascript
   localStorage.clear();
   sessionStorage.clear();
   location.reload();
   ```

### 方案 3: 强制刷新

1. 进入蒸馏管理页面
2. 点击右上角"刷新"按钮
3. 或按 `Cmd+Shift+R` (macOS) / `Ctrl+Shift+R` (Windows)

---

## 验证结果

修复后应该看到:

### 蒸馏结果列表

| 关键词 | 话题数 | 状态 |
|--------|--------|------|
| 法国留学 | 12 个 | ✅ |
| 周口装修公司 | 12 个 | ✅ |
| 装修装饰公司 | 12 个 | ✅ |

### 统计信息

```
总话题数: 36 个
关键词数量: 3 个
总被引用次数: 0 次
当前显示: 10 个
```

---

## 技术细节

### 数据流程

```
前端页面
  ↓ (调用)
useCachedData Hook
  ↓ (检查缓存)
cacheStore
  ↓ (缓存未命中)
fetchLocalResultsWithReferences
  ↓ (IPC 调用)
window.electron.invoke('distillation:local:getResults')
  ↓ (Electron 主进程)
localDistillationHandlers.ts
  ↓ (查询数据库)
PostgreSQL (geo_windows)
  ↓ (返回数据)
前端页面显示
```

### 缓存失效条件

1. **依赖项变化**:
   - filterKeyword
   - searchText
   - currentPage
   - pageSize

2. **手动刷新**:
   - 调用 `refresh(true)`
   - 调用 `invalidateCacheByPrefix('distillationResults:')`

3. **应用重启**:
   - 缓存存储在内存中
   - 重启后自动清空

### SQL 查询

```sql
-- 查询话题列表
SELECT 
  t.id,
  t.question,
  t.distillation_id,
  t.created_at as "createdAt",
  d.keyword,
  COALESCE(
    (SELECT COUNT(*) FROM articles a WHERE a.topic_id = t.id),
    0
  ) as "referenceCount"
FROM topics t
JOIN distillations d ON t.distillation_id = d.id
WHERE t.user_id = $1
ORDER BY t.created_at DESC
LIMIT $2 OFFSET $3
```

---

## 相关文件

### 前端

- `windows-login-manager/src/pages/DistillationResultsPage.tsx` - 蒸馏结果页面
- `windows-login-manager/src/api/localDistillationResultsApi.ts` - API 客户端
- `windows-login-manager/src/hooks/useCachedData.ts` - 缓存 Hook
- `windows-login-manager/src/stores/cacheStore.ts` - 缓存 Store

### 后端

- `windows-login-manager/electron/ipc/handlers/localDistillationHandlers.ts` - IPC Handler
- `windows-login-manager/electron/storage/manager.ts` - 存储管理器
- `windows-login-manager/electron/database/postgres.ts` - 数据库连接

### 诊断脚本

- `windows-login-manager/diagnose-local-distillation.js` - 数据库诊断
- `windows-login-manager/check-real-store.js` - 用户信息检查
- `windows-login-manager/test-ipc-distillation.js` - IPC 调用测试
- `windows-login-manager/fix-distillation-cache.sh` - 快速修复脚本

---

## 预防措施

### 1. 改进缓存策略

建议在以下情况自动失效缓存:

- 用户执行蒸馏操作后
- 用户删除蒸馏记录后
- 用户登录/登出时

### 2. 添加缓存指示器

在 UI 上显示数据来源:

```typescript
{isFromCache && (
  <Tag color="gold">缓存</Tag>
)}
```

### 3. 提供手动刷新

在页面上提供明显的"刷新"按钮，允许用户强制重新加载数据。

---

## 总结

### 问题分类

- ❌ 服务器端数据问题: 已修复
- ❌ Windows 端数据问题: 无问题
- ✅ 前端缓存问题: **需要用户清除缓存**

### 修复状态

| 组件 | 状态 | 说明 |
|------|------|------|
| 服务器数据库 | ✅ 已修复 | topic_count 已更新，触发器已创建 |
| Windows 数据库 | ✅ 正常 | 有 3 条蒸馏记录，36 个话题 |
| 用户登录 | ✅ 正常 | zhuangxiu (ID: 5) 已登录 |
| IPC 查询 | ✅ 正常 | 能正确返回数据 |
| 前端缓存 | ⚠️ 需清除 | 旧的空数据被缓存 |

### 用户操作

**推荐**: 运行清理脚本

```bash
cd windows-login-manager
./fix-distillation-cache.sh
```

**或手动清理缓存后重启应用**

---

**最后更新**: 2026-01-19 16:40  
**诊断人员**: AI Assistant  
**状态**: 等待用户执行修复步骤
