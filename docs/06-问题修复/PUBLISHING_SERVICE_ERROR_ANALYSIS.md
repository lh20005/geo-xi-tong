# PublishingService æ¨¡å—ç¼ºå¤±é”™è¯¯åˆ†æ

## é”™è¯¯ä¿¡æ¯

```
Error: Cannot find module './services/PublishingService'
Require stack:
- /var/www/geo-system/server/index.js
```

## é—®é¢˜åˆ†æ

### 1. é”™è¯¯åŸå› 

**æœåŠ¡å™¨ç«¯ `index.js` ä¸­æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åœ¨å°è¯•åŠ è½½ `PublishingService` æ¨¡å—**ï¼š

```javascript
// ä½ç½®ï¼šserver/index.js ç¬¬ 285 è¡Œ
const schedulePublishingTaskCleanup = async () => {
    const { publishingService } = await Promise.resolve()
        .then(() => __importStar(require('./services/PublishingService')));
    // ... æ¸…ç†æ—§å‘å¸ƒä»»åŠ¡çš„é€»è¾‘
};
```

**ä½†æ˜¯**ï¼š
- `PublishingService` æ¨¡å—çš„**æºæ–‡ä»¶**ï¼ˆ`server/src/services/PublishingService.ts`ï¼‰å·²è¢«åˆ é™¤
- æœåŠ¡å™¨ä¸Šè¿˜ä¿ç•™ç€**ç¼–è¯‘åçš„æ–‡ä»¶**ï¼ˆ`server/dist/services/PublishingService.js`ï¼‰
- æœ¬åœ°ç¼–è¯‘æ—¶æ²¡æœ‰åŒ…å«è¿™ä¸ªæ–‡ä»¶ï¼Œå¯¼è‡´ä¸Šä¼ åè·¯å¾„ä¸åŒ¹é…

### 2. ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ

åœ¨ç³»ç»Ÿæ”¹é€ è¿‡ç¨‹ä¸­ï¼š
- **å‘å¸ƒåŠŸèƒ½å·²è¿ç§»åˆ° Windows ç«¯æœ¬åœ°æ‰§è¡Œ**
- `PublishingService` çš„æºæ–‡ä»¶è¢«åˆ é™¤æˆ–ç§»åŠ¨
- ä½† `server/index.js` ä¸­çš„å®šæ—¶æ¸…ç†ä»»åŠ¡ä»£ç æ²¡æœ‰åŒæ­¥æ›´æ–°
- æœåŠ¡å™¨ä¸Šæ—§çš„ç¼–è¯‘æ–‡ä»¶è¿˜åœ¨ï¼Œæ‰€ä»¥ä¹‹å‰æ²¡æŠ¥é”™
- ç°åœ¨é‡æ–°ç¼–è¯‘ä¸Šä¼ åï¼Œæ–°çš„ `index.js` æ‰¾ä¸åˆ°è¿™ä¸ªæ¨¡å—

### 3. è¿™ä¸ªå®šæ—¶ä»»åŠ¡çš„ä½œç”¨

```javascript
// æ¯å¤©å‡Œæ™¨ 4 ç‚¹æ‰§è¡Œ
schedulePublishingTaskCleanup();

// åŠŸèƒ½ï¼šæ¸…ç† 10 å¤©å‰çš„æ—§å‘å¸ƒä»»åŠ¡
const deletedCount = await publishingService.cleanupOldTasks(10);
```

**ç›®çš„**ï¼šå®šæœŸæ¸…ç†æ•°æ®åº“ä¸­çš„æ—§å‘å¸ƒä»»åŠ¡è®°å½•ï¼Œé¿å…æ•°æ®åº“è†¨èƒ€ã€‚

## å½±å“è¯„ä¼°

### å½“å‰å½±å“

| å½±å“é¡¹ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|--------|---------|------|
| æœåŠ¡å¯åŠ¨ | âœ… æ— å½±å“ | æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼Œåªæ˜¯æŠ¥é”™ |
| æ ¸å¿ƒåŠŸèƒ½ | âœ… æ— å½±å“ | ä¸å½±å“è’¸é¦ã€ç”¨æˆ·ç®¡ç†ç­‰åŠŸèƒ½ |
| å‘å¸ƒåŠŸèƒ½ | âœ… æ— å½±å“ | å‘å¸ƒå·²åœ¨ Windows ç«¯æ‰§è¡Œ |
| æ•°æ®æ¸…ç† | âš ï¸ è½»å¾®å½±å“ | æ—§ä»»åŠ¡ä¸ä¼šè‡ªåŠ¨æ¸…ç† |
| æ—¥å¿—å™ªéŸ³ | âš ï¸ è½»å¾®å½±å“ | æ¯æ¬¡å¯åŠ¨éƒ½ä¼šæŠ¥é”™ |

### é•¿æœŸå½±å“

å¦‚æœä¸ä¿®å¤ï¼š
- âŒ æœåŠ¡å™¨æ•°æ®åº“ä¸­çš„æ—§å‘å¸ƒä»»åŠ¡ä¼šä¸€ç›´ç´¯ç§¯
- âŒ æ—¥å¿—ä¸­ä¼šæŒç»­å‡ºç°é”™è¯¯ä¿¡æ¯
- âŒ å¯èƒ½å½±å“æ•°æ®åº“æ€§èƒ½ï¼ˆå¦‚æœä»»åŠ¡è®°å½•å¾ˆå¤šï¼‰

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåˆ é™¤å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆæ¨èï¼‰â­

**åŸå› **ï¼š
- å‘å¸ƒåŠŸèƒ½å·²å®Œå…¨è¿ç§»åˆ° Windows ç«¯
- æœåŠ¡å™¨ç«¯ä¸å†éœ€è¦ç®¡ç†å‘å¸ƒä»»åŠ¡
- å‘å¸ƒä»»åŠ¡çš„æ¸…ç†åº”è¯¥åœ¨ Windows ç«¯æœ¬åœ°è¿›è¡Œ

**æ“ä½œ**ï¼š
1. ä» `server/src/index.ts` ä¸­åˆ é™¤ `schedulePublishingTaskCleanup()` å‡½æ•°åŠå…¶è°ƒç”¨
2. é‡æ–°ç¼–è¯‘å¹¶éƒ¨ç½²

**ä¼˜ç‚¹**ï¼š
- âœ… å½»åº•è§£å†³é—®é¢˜
- âœ… ç¬¦åˆç³»ç»Ÿæ¶æ„ï¼ˆå‘å¸ƒåŠŸèƒ½åœ¨ Windows ç«¯ï¼‰
- âœ… å‡å°‘æœåŠ¡å™¨ç«¯ä»£ç å¤æ‚åº¦

**ç¼ºç‚¹**ï¼š
- âš ï¸ æœåŠ¡å™¨æ•°æ®åº“ä¸­çš„æ—§ä»»åŠ¡è®°å½•ä¸ä¼šè‡ªåŠ¨æ¸…ç†ï¼ˆä½†è¿™äº›è®°å½•å·²ç»æ²¡ç”¨äº†ï¼‰

### æ–¹æ¡ˆ 2ï¼šä¿ç•™å¹¶ä¿®å¤æ¨¡å—å¼•ç”¨

**åŸå› **ï¼š
- å¦‚æœæœåŠ¡å™¨ç«¯è¿˜éœ€è¦ç®¡ç†ä¸€äº›å‘å¸ƒä»»åŠ¡è®°å½•
- å¦‚æœéœ€è¦ä¿ç•™æ¸…ç†åŠŸèƒ½

**æ“ä½œ**ï¼š
1. ä»å¤‡ä»½æ¢å¤ `PublishingService.ts`
2. é‡æ–°ç¼–è¯‘å¹¶éƒ¨ç½²

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿ç•™æ¸…ç†åŠŸèƒ½

**ç¼ºç‚¹**ï¼š
- âŒ ä¸ç³»ç»Ÿæ¶æ„ä¸ç¬¦ï¼ˆå‘å¸ƒå·²è¿ç§»åˆ° Windows ç«¯ï¼‰
- âŒ å¢åŠ ç»´æŠ¤æˆæœ¬
- âŒ æœåŠ¡å™¨ç«¯ä¿ç•™ä¸éœ€è¦çš„ä»£ç 

### æ–¹æ¡ˆ 3ï¼šæ‰‹åŠ¨æ¸…ç†æ—§æ•°æ®

**åŸå› **ï¼š
- ä¸€æ¬¡æ€§æ¸…ç†æœåŠ¡å™¨æ•°æ®åº“ä¸­çš„æ—§ä»»åŠ¡è®°å½•
- ç„¶ååˆ é™¤å®šæ—¶ä»»åŠ¡ä»£ç 

**æ“ä½œ**ï¼š
1. åœ¨æœåŠ¡å™¨æ•°æ®åº“ä¸­æ‰‹åŠ¨åˆ é™¤æ—§ä»»åŠ¡è®°å½•
2. åˆ é™¤å®šæ—¶ä»»åŠ¡ä»£ç 
3. é‡æ–°ç¼–è¯‘å¹¶éƒ¨ç½²

**ä¼˜ç‚¹**ï¼š
- âœ… æ¸…ç†æ—§æ•°æ®
- âœ… ç¬¦åˆç³»ç»Ÿæ¶æ„

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ‰‹åŠ¨æ“ä½œæ•°æ®åº“

## æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ 1ï¼šåˆ é™¤å®šæ—¶æ¸…ç†ä»»åŠ¡**

### ç†ç”±

1. **æ¶æ„ä¸€è‡´æ€§**
   - å‘å¸ƒåŠŸèƒ½å·²å®Œå…¨è¿ç§»åˆ° Windows ç«¯
   - æœåŠ¡å™¨ç«¯ä¸åº”è¯¥å†ç®¡ç†å‘å¸ƒä»»åŠ¡

2. **ç®€åŒ–ç»´æŠ¤**
   - å‡å°‘æœåŠ¡å™¨ç«¯ä»£ç å¤æ‚åº¦
   - é¿å…ç»´æŠ¤ä¸éœ€è¦çš„åŠŸèƒ½

3. **æ•°æ®ç®¡ç†**
   - æœåŠ¡å™¨æ•°æ®åº“ä¸­çš„å‘å¸ƒä»»åŠ¡è®°å½•å·²ç»è¿‡æ—¶
   - æ–°çš„å‘å¸ƒä»»åŠ¡éƒ½åœ¨ Windows ç«¯æœ¬åœ°æ•°æ®åº“

4. **é£é™©æœ€å°**
   - ä¸å½±å“ä»»ä½•æ ¸å¿ƒåŠŸèƒ½
   - åªæ˜¯åˆ é™¤ä¸€ä¸ªä¸å†éœ€è¦çš„å®šæ—¶ä»»åŠ¡

## ä¿®å¤æ­¥éª¤ï¼ˆæ–¹æ¡ˆ 1ï¼‰

### 1. ä¿®æ”¹æœ¬åœ°ä»£ç 

ç¼–è¾‘ `server/src/index.ts`ï¼Œåˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š

```typescript
// åˆ é™¤è¿™ä¸ªå‡½æ•°å®šä¹‰
const schedulePublishingTaskCleanup = async () => {
  // ... æ•´ä¸ªå‡½æ•°
};

// åˆ é™¤è¿™ä¸ªå‡½æ•°è°ƒç”¨
schedulePublishingTaskCleanup();
```

### 2. é‡æ–°ç¼–è¯‘

```bash
cd server
npm run build
```

### 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨

```bash
scp -i "ç§é’¥è·¯å¾„" server/dist/index.js ubuntu@124.221.247.107:/var/www/geo-system/server/
ssh -i "ç§é’¥è·¯å¾„" ubuntu@124.221.247.107 "pm2 restart geo-server"
```

### 4. éªŒè¯

```bash
# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ä¸å†æœ‰ PublishingService é”™è¯¯
pm2 logs geo-server --lines 50
```

## å¯é€‰ï¼šæ¸…ç†æ—§æ•°æ®

å¦‚æœéœ€è¦æ¸…ç†æœåŠ¡å™¨æ•°æ®åº“ä¸­çš„æ—§å‘å¸ƒä»»åŠ¡è®°å½•ï¼š

```sql
-- æŸ¥çœ‹æ—§ä»»åŠ¡æ•°é‡
SELECT COUNT(*) FROM publishing_tasks WHERE created_at < NOW() - INTERVAL '10 days';

-- åˆ é™¤æ—§ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
DELETE FROM publishing_tasks WHERE created_at < NOW() - INTERVAL '10 days';
```

## æ€»ç»“

**é—®é¢˜æœ¬è´¨**ï¼šç³»ç»Ÿæ”¹é€ åï¼ŒæœåŠ¡å™¨ç«¯ä»£ç æ²¡æœ‰å®Œå…¨æ¸…ç†å·²è¿ç§»åŠŸèƒ½çš„å¼•ç”¨ã€‚

**æ¨èæ–¹æ¡ˆ**ï¼šåˆ é™¤å®šæ—¶æ¸…ç†ä»»åŠ¡ä»£ç ï¼Œå› ä¸ºå‘å¸ƒåŠŸèƒ½å·²å®Œå…¨è¿ç§»åˆ° Windows ç«¯ã€‚

**å½±å“è¯„ä¼°**ï¼šå½“å‰ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œåªæ˜¯æ—¥å¿—å™ªéŸ³ï¼Œä½†å»ºè®®å°½å¿«ä¿®å¤ä»¥ä¿æŒä»£ç æ•´æ´ã€‚

**ä¿®å¤éš¾åº¦**ï¼šâ­ ç®€å•ï¼ˆåˆ é™¤å‡ è¡Œä»£ç å³å¯ï¼‰

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­ç­‰ï¼ˆä¸ç´§æ€¥ï¼Œä½†å»ºè®®ä¿®å¤ï¼‰
