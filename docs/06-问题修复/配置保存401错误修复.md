# é…ç½®ä¿å­˜ 401 é”™è¯¯ä¿®å¤

## é—®é¢˜æè¿°

åœ¨æœåŠ¡å™¨ä¸Šé…ç½®ç³»ç»Ÿæ—¶ï¼Œä¿å­˜ DeepSeek API é…ç½®å¤±è´¥ï¼Œè¿”å›ž 401 Unauthorized é”™è¯¯ï¼š

```
POST http://43.143.163.6/api/config 401 (Unauthorized)
```

## æ ¹æœ¬åŽŸå› 

åŽç«¯çš„ `/api/config` è·¯ç”±éœ€è¦**ç¡®è®¤ä»¤ç‰Œ**ï¼ˆConfirmation Tokenï¼‰æ¥ä¿æŠ¤æ•æ„Ÿæ“ä½œï¼Œä½†å‰ç«¯æ²¡æœ‰å®žçŽ°èŽ·å–å’Œå‘é€ç¡®è®¤ä»¤ç‰Œçš„é€»è¾‘ã€‚

### åŽç«¯è¦æ±‚

```typescript
// server/src/routes/config.ts
configRouter.post('/', 
  authenticate,           // âœ… ç”¨æˆ·è®¤è¯
  requireAdmin,          // âœ… ç®¡ç†å‘˜æƒé™
  configRateLimit,       // âœ… é€ŸçŽ‡é™åˆ¶
  requireConfirmation('update-api-config'),  // âŒ ç¡®è®¤ä»¤ç‰Œï¼ˆå‰ç«¯æœªå®žçŽ°ï¼‰
  async (req, res) => {
    // ä¿å­˜é…ç½®...
  }
);
```

### ç¡®è®¤ä»¤ç‰Œæœºåˆ¶

è¿™æ˜¯ä¸€ä¸ªäºŒæ¬¡ç¡®è®¤æœºåˆ¶ï¼Œç”¨äºŽä¿æŠ¤æ•æ„Ÿæ“ä½œï¼š

1. **ç¬¬ä¸€æ­¥**ï¼šè°ƒç”¨ `/api/confirm/initiate` èŽ·å–ç¡®è®¤ä»¤ç‰Œ
2. **ç¬¬äºŒæ­¥**ï¼šåœ¨è¯·æ±‚å¤´ä¸­åŒ…å« `X-Confirmation-Token` æ‰§è¡Œæ“ä½œ

## è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å‰ç«¯ä»£ç 

**æ–‡ä»¶ï¼š** `client/src/pages/ConfigPage.tsx`

#### 1. API é…ç½®ä¿å­˜

```typescript
const handleSubmit = async (values: any) => {
  setLoading(true);
  try {
    // ç¬¬ä¸€æ­¥ï¼šèŽ·å–ç¡®è®¤ä»¤ç‰Œ
    const confirmResponse = await axios.post('/api/confirm/initiate', {
      action: 'update-api-config',
      data: values
    });

    if (!confirmResponse.data.success) {
      throw new Error('èŽ·å–ç¡®è®¤ä»¤ç‰Œå¤±è´¥');
    }

    const confirmationToken = confirmResponse.data.data.token;

    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ç¡®è®¤ä»¤ç‰Œä¿å­˜é…ç½®
    await axios.post('/api/config', values, {
      headers: {
        'X-Confirmation-Token': confirmationToken
      }
    });

    message.success('APIé…ç½®ä¿å­˜æˆåŠŸï¼');
    loadConfig();
    form.resetFields();
  } catch (error: any) {
    const errorMsg = error.response?.data?.error || 
                     error.response?.data?.message || 
                     'ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥';
    message.error(errorMsg);
    console.error('ä¿å­˜é…ç½®é”™è¯¯:', error.response?.data || error);
  } finally {
    setLoading(false);
  }
};
```

#### 2. å…³é”®è¯è’¸é¦é…ç½®ä¿å­˜

```typescript
const handleSubmit = async (values: any) => {
  setLoading(true);
  try {
    // ç¬¬ä¸€æ­¥ï¼šèŽ·å–ç¡®è®¤ä»¤ç‰Œ
    const confirmResponse = await axios.post('/api/confirm/initiate', {
      action: 'update-distillation-config',
      data: values
    });

    if (!confirmResponse.data.success) {
      throw new Error('èŽ·å–ç¡®è®¤ä»¤ç‰Œå¤±è´¥');
    }

    const confirmationToken = confirmResponse.data.data.token;

    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ç¡®è®¤ä»¤ç‰Œä¿å­˜é…ç½®
    await axios.post('/api/config/distillation', values, {
      headers: {
        'X-Confirmation-Token': confirmationToken
      }
    });

    message.success('å…³é”®è¯è’¸é¦é…ç½®ä¿å­˜æˆåŠŸï¼');
    loadConfig();
  } catch (error: any) {
    const errorMsg = error.response?.data?.error || 
                     error.response?.data?.message || 
                     'ä¿å­˜é…ç½®å¤±è´¥';
    message.error(errorMsg);
    console.error('ä¿å­˜é…ç½®é”™è¯¯:', error.response?.data || error);
  } finally {
    setLoading(false);
  }
};
```

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. é‡æ–°æž„å»ºå‰ç«¯
cd client
npm run build

# 2. éƒ¨ç½²åˆ°æœåŠ¡å™¨
scp -r dist/* ubuntu@43.143.163.6:/var/www/geo-system/client/dist/

# 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# ç”¨æˆ·éœ€è¦ç¡¬åˆ·æ–°ï¼šCtrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac)
```

## æŠ€æœ¯ç»†èŠ‚

### ç¡®è®¤ä»¤ç‰Œæµç¨‹

```
å®¢æˆ·ç«¯                          æœåŠ¡å™¨
  |                              |
  |--1. POST /api/confirm/initiate-->|
  |    { action, data }          |
  |                              |
  |<--2. è¿”å›žç¡®è®¤ä»¤ç‰Œ ------------|
  |    { token, expiresIn: 300 } |
  |                              |
  |--3. POST /api/config -------->|
  |    Header: X-Confirmation-Token
  |                              |
  |<--4. ä¿å­˜æˆåŠŸ ---------------|
  |    { success: true }         |
```

### ç¡®è®¤ä»¤ç‰Œç‰¹æ€§

- **æœ‰æ•ˆæœŸ**ï¼š5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰
- **ä¸€æ¬¡æ€§**ï¼šä½¿ç”¨åŽç«‹å³å¤±æ•ˆ
- **ç”¨æˆ·ç»‘å®š**ï¼šåªèƒ½ç”±ç”Ÿæˆä»¤ç‰Œçš„ç”¨æˆ·ä½¿ç”¨
- **æ“ä½œç»‘å®š**ï¼šå¿…é¡»åŒ¹é…æŒ‡å®šçš„æ“ä½œç±»åž‹

### éœ€è¦ç¡®è®¤ä»¤ç‰Œçš„æ“ä½œ

| æ“ä½œ | Action åç§° | è¯´æ˜Ž |
|------|------------|------|
| ä¿å­˜ API é…ç½® | `update-api-config` | DeepSeek/Gemini/Ollama é…ç½® |
| ä¿å­˜è’¸é¦é…ç½® | `update-distillation-config` | å…³é”®è¯è’¸é¦æç¤ºè¯ |
| æ›´æ–°ç”¨æˆ· | `update-user` | ä¿®æ”¹ç”¨æˆ·è§’è‰²ç­‰ |
| é‡ç½®å¯†ç  | `reset-password` | é‡ç½®ç”¨æˆ·å¯†ç  |
| åˆ é™¤ç”¨æˆ· | `delete-user` | åˆ é™¤ç”¨æˆ·è´¦å· |

## ä¸ºä»€ä¹ˆéœ€è¦ç¡®è®¤ä»¤ç‰Œï¼Ÿ

### å®‰å…¨è€ƒè™‘

1. **é˜²æ­¢ CSRF æ”»å‡»** - å³ä½¿æ”»å‡»è€…èŽ·å–äº†ç”¨æˆ·çš„ sessionï¼Œä¹Ÿæ— æ³•æ‰§è¡Œæ•æ„Ÿæ“ä½œ
2. **äºŒæ¬¡ç¡®è®¤** - ç¡®ä¿ç”¨æˆ·çœŸçš„æƒ³æ‰§è¡Œè¿™ä¸ªæ“ä½œ
3. **å®¡è®¡è¿½è¸ª** - è®°å½•æ•æ„Ÿæ“ä½œçš„ç¡®è®¤è¿‡ç¨‹
4. **æ—¶é—´é™åˆ¶** - 5 åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œå‡å°‘ä»¤ç‰Œè¢«æ»¥ç”¨çš„é£Žé™©

### é€‚ç”¨åœºæ™¯

- âœ… ä¿®æ”¹ç³»ç»Ÿé…ç½®
- âœ… ç”¨æˆ·ç®¡ç†æ“ä½œ
- âœ… æƒé™å˜æ›´
- âœ… åˆ é™¤é‡è¦æ•°æ®
- âŒ æ™®é€šæŸ¥è¯¢æ“ä½œ
- âŒ åˆ›å»ºå†…å®¹

## æµ‹è¯•éªŒè¯

### 1. æµ‹è¯• API é…ç½®ä¿å­˜

```bash
# è®¿é—®é…ç½®é¡µé¢
http://43.143.163.6/app/config

# å¡«å†™ DeepSeek API Key
# ç‚¹å‡»ä¿å­˜

# åº”è¯¥çœ‹åˆ°ï¼š
# âœ… "APIé…ç½®ä¿å­˜æˆåŠŸï¼"
```

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Networkï¼š

```
1. POST /api/confirm/initiate
   Request: { action: "update-api-config", data: {...} }
   Response: { success: true, data: { token: "xxx" } }

2. POST /api/config
   Headers: X-Confirmation-Token: xxx
   Response: { success: true, message: "APIé…ç½®ä¿å­˜æˆåŠŸ" }
```

### 3. éªŒè¯é…ç½®ç”Ÿæ•ˆ

```bash
# æŸ¥çœ‹æ•°æ®åº“
ssh ubuntu@43.143.163.6
psql -U geo_user -d geo_system

SELECT provider, is_active, created_at 
FROM api_configs 
ORDER BY created_at DESC 
LIMIT 1;

# åº”è¯¥çœ‹åˆ°æ–°ä¿å­˜çš„é…ç½®
```

## å¸¸è§é—®é¢˜

### Q1: ä»ç„¶è¿”å›ž 401 é”™è¯¯

**åŽŸå› ï¼š** æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ JS æ–‡ä»¶

**è§£å†³ï¼š** ç¡¬åˆ·æ–°æµè§ˆå™¨
- Windows: `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`

### Q2: ç¡®è®¤ä»¤ç‰Œè¿‡æœŸ

**é”™è¯¯ï¼š** "ç¡®è®¤ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"

**åŽŸå› ï¼š** ä»¤ç‰Œæœ‰æ•ˆæœŸåªæœ‰ 5 åˆ†é’Ÿ

**è§£å†³ï¼š** é‡æ–°æäº¤è¡¨å•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨èŽ·å–æ–°ä»¤ç‰Œ

### Q3: æ“ä½œç±»åž‹ä¸åŒ¹é…

**é”™è¯¯ï¼š** "ç¡®è®¤ä»¤ç‰Œæ“ä½œç±»åž‹ä¸åŒ¹é…"

**åŽŸå› ï¼š** ä»¤ç‰Œçš„ action ä¸Žå®žé™…æ“ä½œä¸åŒ¹é…

**è§£å†³ï¼š** æ£€æŸ¥ä»£ç ä¸­çš„ action åç§°æ˜¯å¦æ­£ç¡®

## ç›¸å…³æ–‡æ¡£

- ðŸ“– [ç¡®è®¤ä»¤ç‰Œä¸­é—´ä»¶](../../server/src/middleware/requireConfirmation.ts)
- ðŸ“– [é…ç½®è·¯ç”±](../../server/src/routes/config.ts)
- ðŸ“– [å®‰å…¨æœ€ä½³å®žè·µ](../04-å®‰å…¨æŒ‡å—/SECURITY_BEST_PRACTICES.md)

## æ€»ç»“

âœ… **é—®é¢˜å·²ä¿®å¤** - æ·»åŠ ç¡®è®¤ä»¤ç‰Œæ”¯æŒ  
âœ… **API é…ç½®** - å¯ä»¥æ­£å¸¸ä¿å­˜  
âœ… **è’¸é¦é…ç½®** - å¯ä»¥æ­£å¸¸ä¿å­˜  
âœ… **å®‰å…¨æ€§æå‡** - æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤  
âœ… **å·²éƒ¨ç½²** - å‰ç«¯ä»£ç å·²æ›´æ–°åˆ°æœåŠ¡å™¨  

---

**ä¿®å¤æ—¶é—´**: 2025-12-27  
**ä¿®å¤äºº**: Kiro AI Assistant  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éƒ¨ç½²
