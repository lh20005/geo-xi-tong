# 本地发布调试指南

## 📋 功能说明

系统现已支持**智能浏览器模式切换**，可以在本地开发时显示浏览器窗口，方便调试发布流程。

## 🎯 核心特性

### 1. 智能环境检测
- **本地开发环境**（localhost/127.0.0.1）：默认**可视化模式**
- **生产环境**（服务器）：自动强制**静默模式**

### 2. 用户可控
- 前端提供浏览器模式切换开关
- 可随时在静默/可视化模式间切换
- 设置实时生效，无需重启

### 3. 服务器兼容
- 服务器环境（无显示器的 Linux）自动使用 headless 模式
- 确保生产环境稳定运行

## 🚀 使用方法

### 步骤 1：启动本地开发环境

```bash
# 启动后端
cd server
npm run dev

# 启动前端（新终端）
cd client
npm run dev
```

### 步骤 2：访问发布任务页面

打开浏览器访问：`http://localhost:5173/publishing-tasks`

### 步骤 3：切换浏览器模式

在"发布配置和操作"区域，找到**浏览器模式**开关：


- **静默模式**（🔇）：后台运行，不显示浏览器窗口（推荐）
- **可视化模式**（👁️）：显示浏览器窗口，便于调试（仅本地开发）

### 步骤 4：创建发布任务

1. 选择要发布的文章
2. 选择目标平台账号
3. 设置发布间隔
4. 切换到**可视化模式**（如需调试）
5. 点击"创建发布任务"

### 步骤 5：观察发布过程

- **可视化模式**：会弹出浏览器窗口，可以看到整个发布过程
- **静默模式**：后台运行，通过日志查看进度

## 🔧 技术实现

### 前端改动

**文件**：`client/src/pages/PublishingTasksPage.tsx`

```typescript
// 智能环境检测
const isLocalDev = window.location.hostname === 'localhost' 
  || window.location.hostname === '127.0.0.1';
const [headlessMode, setHeadlessMode] = useState<boolean>(!isLocalDev);
```

### 后端支持

**文件**：`server/src/config/browserConfig.ts`

```typescript
// 服务器环境自动使用 headless
const isServer = !process.env.DISPLAY && process.platform === 'linux';
return {
  headless: options.headless ?? isServer,
  // ...
};
```

## 📊 模式对比

| 特性 | 静默模式 | 可视化模式 |
|------|---------|-----------|
| 浏览器窗口 | ❌ 不显示 | ✅ 显示 |
| 资源占用 | 低 | 中等 |
| 调试便利性 | 通过日志 | 直观可见 |
| 适用场景 | 生产环境、批量发布 | 本地开发、调试 |
| 服务器支持 | ✅ 完全支持 | ❌ 需要显示器 |

## ⚠️ 注意事项

### 1. 环境限制

- **可视化模式**仅在有显示器的环境下可用
- 服务器环境（无 DISPLAY）会自动强制使用静默模式
- macOS/Windows 本地开发完全支持

### 2. 性能考虑

- 可视化模式会占用更多系统资源
- 批量发布建议使用静默模式
- 调试单个平台时可使用可视化模式

### 3. 调试技巧

```bash
# 查看浏览器启动日志
tail -f server/logs/server.log | grep "浏览器"

# 查看任务执行日志
# 在前端"发布任务"页面点击"日志"按钮
```

## 🎯 最佳实践

### 本地开发调试流程

1. **首次调试新平台**
   - 使用可视化模式
   - 观察登录和发布流程
   - 记录可能的问题点

2. **验证修复**
   - 修改适配器代码后
   - 使用可视化模式验证
   - 确认流程正常后切换回静默模式

3. **批量测试**
   - 使用静默模式
   - 通过日志监控进度
   - 提高测试效率

### 生产环境部署

- 服务器自动使用静默模式
- 无需手动配置
- 通过日志和任务状态监控

## 🐛 常见问题

### Q1: 可视化模式下浏览器没有弹出？

**A**: 检查以下几点：
- 确认是本地开发环境（localhost）
- 检查系统是否有显示器
- 查看后端日志是否有错误

### Q2: 服务器上能使用可视化模式吗？

**A**: 不能。服务器环境（无显示器的 Linux）会自动强制使用静默模式，这是系统设计的安全机制。

### Q3: 如何在可视化模式下暂停调试？

**A**: 可以在适配器代码中添加断点或 `await page.pause()`（Playwright 调试方法）。

## 📚 相关文档

- [Playwright 调试文档](https://playwright.dev/docs/debug)
- [浏览器自动化最佳实践](https://playwright.bootcss.com/docs/next/debug)
- [平台适配器开发指南](../07-开发文档/)

## 🎉 总结

通过智能环境检测和用户可控的浏览器模式切换，系统现在支持：

✅ 本地开发时默认可视化，方便调试  
✅ 用户可随时切换模式  
✅ 服务器环境自动静默，确保稳定  
✅ 零后端改动，完全向后兼容  

这是实现本地发布调试的**最小改动方案**，既保持了系统的稳定性，又提供了灵活的调试能力。
