# 数据库连接说明

**更新日期**: 2026-01-16

## 本地开发环境数据库配置

### 两个独立的数据库

本地开发环境有**两个独立的 PostgreSQL 数据库**，用途不同：

| 数据库名 | 用途 | 连接方 | 配置文件 |
|---------|------|--------|---------|
| `geo_windows` | Windows 桌面客户端本地存储 | Electron 应用 | `windows-login-manager/.env` |
| `geo_system` | 服务器端 API（本地开发测试） | Node.js API | `server/.env` |

### 为什么需要两个数据库？

1. **`geo_windows`** - 客户端本地数据
   - 存储用户的文章、知识库、图库、平台账号等
   - 数据完全本地化，保护隐私
   - 支持离线工作

2. **`geo_system`** - 服务器端数据（本地测试用）
   - 存储用户认证、配额、订阅、支付等
   - 本地开发时模拟服务器环境
   - 方便测试服务器端功能

### 如何区分连接到哪个数据库？

#### Windows 端连接检查

```typescript
// windows-login-manager/electron/database/postgres.ts
const config = {
  database: process.env.DB_NAME || 'geo_windows',  // 默认 geo_windows
  user: process.env.DB_USER || 'lzc'
};
```

**验证方法**：
```bash
# 进入 Windows 端数据库
psql -d geo_windows

# 查看当前数据库
\conninfo
# 应该显示：You are connected to database "geo_windows"
```

#### 服务器端连接检查

```typescript
// server/src/db/database.ts
const pool = new Pool({
  connectionString: process.env.DATABASE_URL  // postgresql://lzc@localhost:5432/geo_system
});
```

**验证方法**：
```bash
# 进入服务器端数据库
psql -d geo_system

# 查看当前数据库
\conninfo
# 应该显示：You are connected to database "geo_system"
```

### 数据库创建命令

```bash
# 创建 Windows 端数据库
createdb geo_windows

# 创建服务器端数据库（本地测试用）
createdb geo_system
```

### 数据库初始化

```bash
# Windows 端初始化
cd windows-login-manager
npm run db:init

# 服务器端初始化
cd server
npm run db:migrate
```

### 常见问题

#### Q1: 我不确定连接到哪个数据库了？

**A**: 查看环境变量：

```bash
# Windows 端
cat windows-login-manager/.env | grep DB_NAME
# 应该显示：DB_NAME=geo_windows

# 服务器端
cat server/.env | grep DATABASE_URL
# 应该显示：DATABASE_URL=postgresql://lzc@localhost:5432/geo_system
```

#### Q2: 我可以删除 `geo_system` 吗？

**A**: 可以，如果你不需要在本地开发服务器端代码：

```bash
# 删除本地的 geo_system
dropdb geo_system
```

但建议保留，方便本地测试服务器端功能。

#### Q3: 生产服务器的数据库是什么？

**A**: 生产服务器（124.221.247.107）上的数据库：
- 数据库名：`geo_system`
- 用户：`geo_user`
- 与本地的 `geo_system` 是**完全独立**的

#### Q4: 数据会不会混淆？

**A**: 不会，因为：
- Windows 端只连接 `geo_windows`
- 服务器端只连接 `geo_system`
- 两个数据库名称不同，不会互相影响

### 最佳实践

1. **开发 Windows 端功能**：
   - 只需要 `geo_windows` 数据库
   - 不需要启动服务器端

2. **开发服务器端功能**：
   - 需要 `geo_system` 数据库
   - 启动服务器：`npm run server:dev`

3. **全栈开发**：
   - 同时保留两个数据库
   - 分别启动 Windows 端和服务器端

### 部署到生产环境

生产环境只需要部署服务器端：

```bash
# 服务器上的数据库
DATABASE_URL=postgresql://geo_user:password@localhost:5432/geo_system
```

Windows 端不需要部署，用户在本地安装桌面应用。

---

## 总结

- ✅ 本地有两个数据库：`geo_windows`（客户端）和 `geo_system`（服务器端测试）
- ✅ 两者用途不同，不会混淆
- ✅ 通过环境变量 `DB_NAME` 和 `DATABASE_URL` 区分
- ✅ 生产服务器只有 `geo_system`，与本地独立
