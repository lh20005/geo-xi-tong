# 元数据验证实施计划

## 概述

本文档描述如何实施"客户端预验证 + 元数据传递"方案，以改进当前的 UUID 验证策略。

## 实施阶段

### 阶段 1：数据库迁移（1 天）

#### 1.1 创建迁移文件

```bash
cd server
npm run db:create -- add_resource_metadata_to_tasks
```

#### 1.2 编写迁移 SQL

**文件**：`server/src/db/migrations/XXX_add_resource_metadata_to_tasks.sql`

```sql
-- ==================== UP ====================

-- 添加元数据字段
ALTER TABLE generation_tasks 
ADD COLUMN album_metadata JSONB,
ADD COLUMN knowledge_base_metadata JSONB;

-- 添加 GIN 索引（用于 JSONB 查询）
CREATE INDEX idx_generation_tasks_album_metadata 
ON generation_tasks USING GIN (album_metadata);

CREATE INDEX idx_generation_tasks_kb_metadata 
ON generation_tasks USING GIN (knowledge_base_metadata);

-- 添加注释
COMMENT ON COLUMN generation_tasks.album_metadata IS 
'本地图库元数据（UUID格式时使用），包含：uuid, name, imageCount, totalSize';

COMMENT ON COLUMN generation_tasks.knowledge_base_metadata IS 
'本地知识库元数据（UUID格式时使用），包含：uuid, name, documentCount, totalSize';

-- 创建验证失败记录表（用于审计）
CREATE TABLE IF NOT EXISTS resource_verification_failures (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resource_type VARCHAR(50) NOT NULL,  -- 'album' 或 'knowledge_base'
    resource_id TEXT NOT NULL,  -- UUID 或数字 ID
    failure_reason TEXT,
    failed_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 添加索引
CREATE INDEX idx_verification_failures_user 
ON resource_verification_failures(user_id, failed_at);

CREATE INDEX idx_verification_failures_resource 
ON resource_verification_failures(resource_type, resource_id);

-- 添加注释
COMMENT ON TABLE resource_verification_failures IS 
'资源验证失败记录，用于审计和安全监控';

-- ==================== DOWN ====================

DROP TABLE IF EXISTS resource_verification_failures;
DROP INDEX IF EXISTS idx_generation_tasks_kb_metadata;
DROP INDEX IF EXISTS idx_generation_tasks_album_metadata;
ALTER TABLE generation_tasks DROP COLUMN IF EXISTS knowledge_base_metadata;
ALTER TABLE generation_tasks DROP COLUMN IF EXISTS album_metadata;
```

#### 1.3 执行迁移

```bash
# 本地测试
cd server
npm run db:migrate

# 部署到服务器
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "cd /var/www/geo-system/server && npm run db:migrate"
```

---

### 阶段 2：类型定义更新（0.5 天）

#### 2.1 更新共享类型

**文件**：`windows-login-manager/src/types/articleGeneration.ts`

```typescript
// 资源元数据接口
export interface AlbumMetadata {
  uuid: string;  // UUID
  name: string;  // 图库名称
  imageCount: number;  // 图片数量
  totalSize: number;  // 总大小（字节）
  coverImage?: string;  // 封面图片路径
}

export interface KnowledgeBaseMetadata {
  uuid: string;  // UUID
  name: string;  // 知识库名称
  documentCount: number;  // 文档数量
  totalSize: number;  // 总大小（字节）
  description?: string;  // 描述
}

// 更新 TaskConfig 接口
export interface TaskConfig {
  distillationId: number;
  albumId: number | string;  // 支持数字或 UUID
  knowledgeBaseId: number | string;  // 支持数字或 UUID
  articleSettingId: number;
  conversionTargetId?: number;
  articleCount: number;
  
  // 新增：元数据字段（UUID 格式时必须提供）
  albumMetadata?: AlbumMetadata;
  knowledgeBaseMetadata?: KnowledgeBaseMetadata;
}

// 验证失败记录
export interface ResourceVerificationFailure {
  id: number;
  userId: number;
  resourceType: 'album' | 'knowledge_base';
  resourceId: string;
  failureReason?: string;
  failedAt: string;
}
```

#### 2.2 更新服务器类型

**文件**：`server/src/types/articleGeneration.ts`

```typescript
export interface AlbumMetadata {
  uuid: string;
  name: string;
  imageCount: number;
  totalSize: number;
  coverImage?: string;
}

export interface KnowledgeBaseMetadata {
  uuid: string;
  name: string;
  documentCount: number;
  totalSize: number;
  description?: string;
}

export interface CreateTaskParams {
  distillationId: number;
  albumId: number | string;
  knowledgeBaseId: number | string;
  articleSettingId: number;
  conversionTargetId?: number;
  articleCount: number;
  userId: number;
  
  // 元数据
  albumMetadata?: AlbumMetadata;
  knowledgeBaseMetadata?: KnowledgeBaseMetadata;
}
```

---

### 阶段 3：Windows 端实现（1 天）

#### 3.1 添加资源信息获取方法

**文件**：`windows-login-manager/electron/services/GalleryService.ts`

```typescript
export class GalleryService extends BaseService {
  // 现有方法...
  
  /**
   * 获取图库信息（用于元数据）
   */
  async getAlbumInfo(albumId: string): Promise<AlbumMetadata | null> {
    try {
      const album = this.db.prepare(`
        SELECT 
          id,
          name,
          (SELECT COUNT(*) FROM images WHERE album_id = ?) as image_count,
          (SELECT COALESCE(SUM(file_size), 0) FROM images WHERE album_id = ?) as total_size,
          (SELECT path FROM images WHERE album_id = ? ORDER BY created_at DESC LIMIT 1) as cover_image
        FROM albums
        WHERE id = ?
      `).get(albumId, albumId, albumId, albumId) as any;
      
      if (!album) {
        return null;
      }
      
      return {
        uuid: album.id,
        name: album.name,
        imageCount: album.image_count || 0,
        totalSize: album.total_size || 0,
        coverImage: album.cover_image
      };
    } catch (error) {
      console.error('获取图库信息失败:', error);
      return null;
    }
  }
}
```

**文件**：`windows-login-manager/electron/services/KnowledgeService.ts`

```typescript
export class KnowledgeService extends BaseService {
  // 现有方法...
  
  /**
   * 获取知识库信息（用于元数据）
   */
  async getKnowledgeBaseInfo(kbId: string): Promise<KnowledgeBaseMetadata | null> {
    try {
      const kb = this.db.prepare(`
        SELECT 
          id,
          name,
          description,
          (SELECT COUNT(*) FROM knowledge_documents WHERE knowledge_base_id = ?) as document_count,
          (SELECT COALESCE(SUM(file_size), 0) FROM knowledge_documents WHERE knowledge_base_id = ?) as total_size
        FROM knowledge_bases
        WHERE id = ?
      `).get(kbId, kbId, kbId) as any;
      
      if (!kb) {
        return null;
      }
      
      return {
        uuid: kb.id,
        name: kb.name,
        documentCount: kb.document_count || 0,
        totalSize: kb.total_size || 0,
        description: kb.description
      };
    } catch (error) {
      console.error('获取知识库信息失败:', error);
      return null;
    }
  }
}
```

#### 3.2 更新 IPC 处理器

**文件**：`windows-login-manager/electron/ipc/handlers/localGalleryHandlers.ts`

```typescript
// 添加新的 IPC 方法
ipcMain.handle('gallery:getAlbumInfo', async (event, albumId: string) => {
  try {
    const info = await galleryService.getAlbumInfo(albumId);
    return { success: true, data: info };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
});
```

**文件**：`windows-login-manager/electron/ipc/handlers/localKnowledgeHandlers.ts`

```typescript
// 添加新的 IPC 方法
ipcMain.handle('localKnowledge:getKnowledgeBaseInfo', async (event, kbId: string) => {
  try {
    const info = await knowledgeService.getKnowledgeBaseInfo(kbId);
    return { success: true, data: info };
  } catch (error: any) {
    return { success: false, error: error.message };
  }
});
```

#### 3.3 更新 preload 类型

**文件**：`windows-login-manager/electron/preload.ts`

```typescript
const electronAPI = {
  // 现有方法...
  
  gallery: {
    // 现有方法...
    getAlbumInfo: (albumId: string) => 
      ipcRenderer.invoke('gallery:getAlbumInfo', albumId),
  },
  
  localKnowledge: {
    // 现有方法...
    getKnowledgeBaseInfo: (kbId: string) => 
      ipcRenderer.invoke('localKnowledge:getKnowledgeBaseInfo', kbId),
  }
};
```

#### 3.4 更新前端 API

**文件**：`windows-login-manager/src/api/articleGenerationApi.ts`

```typescript
export async function createTask(config: TaskConfig): Promise<CreateTaskResponse> {
  // 1. 如果使用本地资源（UUID），获取元数据
  let albumMetadata: AlbumMetadata | undefined;
  let knowledgeBaseMetadata: KnowledgeBaseMetadata | undefined;
  
  if (typeof config.albumId === 'string' && window.electron) {
    const result = await window.electron.gallery.getAlbumInfo(config.albumId);
    if (!result.success || !result.data) {
      throw new Error('选择的图库不存在或已被删除');
    }
    albumMetadata = result.data;
    
    // 验证图库是否有图片
    if (albumMetadata.imageCount === 0) {
      throw new Error('选择的图库中没有图片，请先上传图片');
    }
  }
  
  if (typeof config.knowledgeBaseId === 'string' && window.electron) {
    const result = await window.electron.localKnowledge.getKnowledgeBaseInfo(config.knowledgeBaseId);
    if (!result.success || !result.data) {
      throw new Error('选择的知识库不存在或已被删除');
    }
    knowledgeBaseMetadata = result.data;
    
    // 验证知识库是否有文档
    if (knowledgeBaseMetadata.documentCount === 0) {
      throw new Error('选择的知识库中没有文档，请先上传文档');
    }
  }
  
  // 2. 构建请求数据
  const requestData: TaskConfig = {
    ...config,
    albumMetadata,
    knowledgeBaseMetadata
  };
  
  // 3. 发送请求
  const response = await apiClient.post('/article-generation/tasks', requestData);
  return response.data;
}
```

---

### 阶段 4：服务器端实现（1 天）

#### 4.1 更新路由验证

**文件**：`server/src/routes/articleGeneration.ts`

```typescript
// 更新 Zod schema
const createTaskSchema = z.object({
  distillationId: z.number().int().positive(),
  
  albumId: z.union([
    z.number().int().positive(),
    z.string().uuid()
  ]),
  
  albumMetadata: z.object({
    uuid: z.string().uuid(),
    name: z.string().min(1).max(100),
    imageCount: z.number().int().min(0).max(10000),
    totalSize: z.number().int().min(0),
    coverImage: z.string().optional()
  }).optional(),
  
  knowledgeBaseId: z.union([
    z.number().int().positive(),
    z.string().uuid()
  ]),
  
  knowledgeBaseMetadata: z.object({
    uuid: z.string().uuid(),
    name: z.string().min(1).max(100),
    documentCount: z.number().int().min(0).max(1000),
    totalSize: z.number().int().min(0),
    description: z.string().optional()
  }).optional(),
  
  articleSettingId: z.number().int().positive(),
  conversionTargetId: z.number().int().positive().optional(),
  articleCount: z.number().int().positive().max(100)
});

articleGenerationRouter.post('/tasks', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const validatedData = createTaskSchema.parse(req.body);
    
    // 验证图库
    if (typeof validatedData.albumId === 'string') {
      // UUID 格式，必须提供元数据
      if (!validatedData.albumMetadata) {
        return res.status(400).json({ 
          error: '使用本地图库时必须提供元数据' 
        });
      }
      
      // 验证 UUID 匹配
      if (validatedData.albumMetadata.uuid !== validatedData.albumId) {
        return res.status(400).json({ 
          error: '图库UUID与元数据不匹配' 
        });
      }
      
      // 验证图片数量
      if (validatedData.albumMetadata.imageCount === 0) {
        return res.status(400).json({ 
          error: '图库中没有图片，无法生成文章' 
        });
      }
      
      // 合理性检查
      if (validatedData.albumMetadata.imageCount > 10000) {
        return res.status(400).json({ 
          error: '图库图片数量异常（超过10000张）' 
        });
      }
      
      console.log(`[任务创建] 使用本地图库: ${validatedData.albumMetadata.name}, 图片数: ${validatedData.albumMetadata.imageCount}`);
    } else {
      // 数字格式，验证服务器数据库
      const albumCheck = await pool.query(
        'SELECT id FROM albums WHERE id = $1',
        [validatedData.albumId]
      );
      if (albumCheck.rows.length === 0) {
        return res.status(404).json({ error: '图库不存在' });
      }
    }
    
    // 类似的逻辑验证知识库...
    if (typeof validatedData.knowledgeBaseId === 'string') {
      if (!validatedData.knowledgeBaseMetadata) {
        return res.status(400).json({ 
          error: '使用本地知识库时必须提供元数据' 
        });
      }
      
      if (validatedData.knowledgeBaseMetadata.uuid !== validatedData.knowledgeBaseId) {
        return res.status(400).json({ 
          error: '知识库UUID与元数据不匹配' 
        });
      }
      
      if (validatedData.knowledgeBaseMetadata.documentCount === 0) {
        return res.status(400).json({ 
          error: '知识库中没有文档，无法生成文章' 
        });
      }
      
      console.log(`[任务创建] 使用本地知识库: ${validatedData.knowledgeBaseMetadata.name}, 文档数: ${validatedData.knowledgeBaseMetadata.documentCount}`);
    } else {
      const kbCheck = await pool.query(
        'SELECT id FROM knowledge_bases WHERE id = $1',
        [validatedData.knowledgeBaseId]
      );
      if (kbCheck.rows.length === 0) {
        return res.status(404).json({ error: '知识库不存在' });
      }
    }
    
    // 创建任务（传递元数据）
    const taskId = await service.createTask({
      ...validatedData,
      userId
    });
    
    res.json({ taskId, status: 'pending' });
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ 
        error: '数据验证失败', 
        details: error.errors 
      });
    }
    console.error('创建任务错误:', error);
    res.status(500).json({ error: '创建任务失败', details: error.message });
  }
});
```

#### 4.2 更新服务层

**文件**：`server/src/services/articleGenerationService.ts`

```typescript
async createTask(params: CreateTaskParams): Promise<number> {
  // 插入任务时保存元数据
  const result = await pool.query(
    `INSERT INTO generation_tasks (
      user_id, distillation_id, album_id, knowledge_base_id,
      article_setting_id, conversion_target_id, requested_count,
      album_metadata, knowledge_base_metadata,
      status, created_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, 'pending', NOW())
    RETURNING id`,
    [
      params.userId,
      params.distillationId,
      params.albumId,
      params.knowledgeBaseId,
      params.articleSettingId,
      params.conversionTargetId || null,
      params.articleCount,
      params.albumMetadata ? JSON.stringify(params.albumMetadata) : null,
      params.knowledgeBaseMetadata ? JSON.stringify(params.knowledgeBaseMetadata) : null
    ]
  );
  
  return result.rows[0].id;
}

// 更新验证方法
async validateTaskConfiguration(taskId: number): Promise<void> {
  const task = await this.getTaskDetail(taskId);
  if (!task) {
    throw new Error('任务不存在');
  }
  
  // 验证图库
  if (typeof task.albumId === 'number') {
    // 服务器数据，完整验证
    const albumResult = await pool.query(
      'SELECT id FROM albums WHERE id = $1',
      [task.albumId]
    );
    if (albumResult.rows.length === 0) {
      throw new Error(`图库ID ${task.albumId} 不存在`);
    }
  } else {
    // UUID 格式，验证元数据
    if (!task.albumMetadata) {
      throw new Error('本地图库缺少元数据');
    }
    
    console.log(`[任务 ${taskId}] 使用本地图库: ${task.albumMetadata.name}, 图片数: ${task.albumMetadata.imageCount}`);
  }
  
  // 类似的逻辑验证知识库...
  if (typeof task.knowledgeBaseId === 'number') {
    const kbResult = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1',
      [task.knowledgeBaseId]
    );
    if (kbResult.rows.length === 0) {
      throw new Error(`知识库ID ${task.knowledgeBaseId} 不存在`);
    }
  } else {
    if (!task.knowledgeBaseMetadata) {
      throw new Error('本地知识库缺少元数据');
    }
    
    console.log(`[任务 ${taskId}] 使用本地知识库: ${task.knowledgeBaseMetadata.name}, 文档数: ${task.knowledgeBaseMetadata.documentCount}`);
  }
  
  // 其他验证...
}
```

---

### 阶段 5：测试（1 天）

#### 5.1 单元测试

创建测试文件：`server/src/services/__tests__/articleGenerationService.metadata.test.ts`

```typescript
describe('ArticleGenerationService - Metadata Validation', () => {
  test('应该接受带有有效元数据的 UUID', async () => {
    const taskConfig = {
      distillationId: 1,
      albumId: '550e8400-e29b-41d4-a716-446655440000',
      albumMetadata: {
        uuid: '550e8400-e29b-41d4-a716-446655440000',
        name: '测试图库',
        imageCount: 10,
        totalSize: 1024000
      },
      knowledgeBaseId: '660e8400-e29b-41d4-a716-446655440001',
      knowledgeBaseMetadata: {
        uuid: '660e8400-e29b-41d4-a716-446655440001',
        name: '测试知识库',
        documentCount: 5,
        totalSize: 2048000
      },
      articleSettingId: 1,
      articleCount: 1,
      userId: 1
    };
    
    const taskId = await service.createTask(taskConfig);
    expect(taskId).toBeGreaterThan(0);
  });
  
  test('应该拒绝 UUID 但缺少元数据', async () => {
    const taskConfig = {
      distillationId: 1,
      albumId: '550e8400-e29b-41d4-a716-446655440000',
      // 缺少 albumMetadata
      knowledgeBaseId: 1,
      articleSettingId: 1,
      articleCount: 1,
      userId: 1
    };
    
    await expect(service.createTask(taskConfig)).rejects.toThrow('必须提供元数据');
  });
  
  test('应该拒绝元数据中图片数量为 0', async () => {
    const taskConfig = {
      distillationId: 1,
      albumId: '550e8400-e29b-41d4-a716-446655440000',
      albumMetadata: {
        uuid: '550e8400-e29b-41d4-a716-446655440000',
        name: '空图库',
        imageCount: 0,  // 无效
        totalSize: 0
      },
      knowledgeBaseId: 1,
      articleSettingId: 1,
      articleCount: 1,
      userId: 1
    };
    
    await expect(service.createTask(taskConfig)).rejects.toThrow('没有图片');
  });
});
```

#### 5.2 集成测试

手动测试步骤：

1. **测试本地资源（UUID）**：
   - 创建本地图库和知识库
   - 创建文章生成任务
   - 验证元数据是否正确传递
   - 检查服务器日志

2. **测试服务器资源（数字 ID）**：
   - 使用服务器图库和知识库
   - 创建文章生成任务
   - 验证向后兼容性

3. **测试错误情况**：
   - 传递不存在的 UUID
   - 传递空图库
   - 传递不匹配的元数据

---

### 阶段 6：部署（0.5 天）

#### 6.1 部署清单

- [ ] 数据库迁移
- [ ] 后端代码部署
- [ ] 前端代码构建
- [ ] 文档更新
- [ ] 监控配置

#### 6.2 部署脚本

```bash
#!/bin/bash
# deploy-metadata-validation.sh

echo "=== 部署元数据验证功能 ==="

# 1. 数据库迁移
echo "1. 执行数据库迁移..."
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "cd /var/www/geo-system/server && npm run db:migrate"

# 2. 编译后端
echo "2. 编译后端代码..."
cd server
npm run build

# 3. 上传后端文件
echo "3. 上传后端文件..."
scp -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" \
  dist/services/articleGenerationService.js \
  ubuntu@124.221.247.107:/var/www/geo-system/server/services/

scp -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" \
  dist/routes/articleGeneration.js \
  ubuntu@124.221.247.107:/var/www/geo-system/server/routes/

# 4. 重启服务
echo "4. 重启服务..."
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "pm2 restart geo-server"

# 5. 验证部署
echo "5. 验证部署..."
sleep 3
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "pm2 logs geo-server --lines 20 --nostream"

echo "=== 部署完成 ==="
```

#### 6.3 回滚计划

如果部署出现问题：

```bash
# 1. 回滚数据库
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "cd /var/www/geo-system/server && npm run db:rollback"

# 2. 恢复旧代码
# （从备份恢复或重新部署上一个版本）

# 3. 重启服务
ssh -i "/Users/lzc/Desktop/GEO资料/腾讯云ssh秘钥/kiro.pem" ubuntu@124.221.247.107 \
  "pm2 restart geo-server"
```

---

## 时间估算

| 阶段 | 工作量 | 依赖 |
|------|--------|------|
| 阶段 1：数据库迁移 | 1 天 | - |
| 阶段 2：类型定义 | 0.5 天 | 阶段 1 |
| 阶段 3：Windows 端 | 1 天 | 阶段 2 |
| 阶段 4：服务器端 | 1 天 | 阶段 2 |
| 阶段 5：测试 | 1 天 | 阶段 3, 4 |
| 阶段 6：部署 | 0.5 天 | 阶段 5 |
| **总计** | **5 天** | |

## 风险和缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 数据库迁移失败 | 高 | 低 | 先在本地测试，准备回滚脚本 |
| 向后兼容性问题 | 中 | 中 | 保持数字 ID 支持，充分测试 |
| 性能下降 | 中 | 低 | 添加索引，监控查询性能 |
| 用户体验影响 | 低 | 低 | 元数据获取很快，影响可忽略 |

## 成功标准

- [ ] 所有测试通过
- [ ] 数据库迁移成功
- [ ] 服务器日志显示元数据信息
- [ ] 任务创建时间无明显增加（< 100ms）
- [ ] 向后兼容性验证通过
- [ ] 文档更新完成

## 后续工作

实施完成后，可以考虑：

1. **审计功能**：定期分析元数据，发现异常模式
2. **配额优化**：根据实际资源使用调整配额计算
3. **监控告警**：异常元数据触发告警
4. **用户反馈**：收集用户对新验证机制的反馈
