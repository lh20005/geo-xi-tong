# æœ¬åœ°å‘å¸ƒæ•°æ®æµè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ ¸å¿ƒé—®é¢˜

1. **å‘å¸ƒä»»åŠ¡æ—¶é€‰æ‹©çš„æ•°æ®ï¼Œéœ€è¦å»æœåŠ¡å™¨è°ƒå–ï¼Ÿ** â†’ æ˜¯çš„
2. **å‘å¸ƒæˆåŠŸåçš„æ•°æ®åé¦ˆå†ä¼ å›åˆ°æœåŠ¡å™¨ï¼Ÿ** â†’ æ˜¯çš„

## ğŸ”„ å®Œæ•´æ•°æ®æµ

### é˜¶æ®µ 1ï¼šä»»åŠ¡åˆ›å»ºï¼ˆå‰ç«¯ â†’ æœåŠ¡å™¨ï¼‰

```
ç”¨æˆ·åœ¨ Electron åº”ç”¨ä¸­ï¼š
  1. é€‰æ‹©æ–‡ç« 
  2. é€‰æ‹©å¹³å°è´¦å·
  3. é…ç½®å‘å¸ƒå‚æ•°
  â†“
Electron æ¸²æŸ“è¿›ç¨‹ â†’ æœåŠ¡å™¨ API
  POST /api/publishing/tasks
  {
    article_id: 123,
    account_id: 456,
    platform_id: "xiaohongshu",
    config: { headless: false }
  }
  â†“
æœåŠ¡å™¨ä¿å­˜ä»»åŠ¡åˆ°æ•°æ®åº“
  â†“
è¿”å›ä»»åŠ¡ ID
  {
    success: true,
    data: { id: 789, status: "pending" }
  }
```

### é˜¶æ®µ 2ï¼šä»»åŠ¡æ‰§è¡Œå‡†å¤‡ï¼ˆElectron â†’ æœåŠ¡å™¨ï¼‰

```
Electron ä¸»è¿›ç¨‹è·å–ä»»åŠ¡è¯¦æƒ…ï¼š
  GET /api/publishing/tasks/789
  â†“
æœåŠ¡å™¨è¿”å›å®Œæ•´ä»»åŠ¡æ•°æ®ï¼š
  {
    id: 789,
    article_id: 123,
    account_id: 456,
    platform_id: "xiaohongshu",
    config: { headless: false },
    // å…³é”®ï¼šåŒ…å«æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰æ•°æ®
    article: {
      id: 123,
      title: "æ–‡ç« æ ‡é¢˜",
      content: "æ–‡ç« å†…å®¹...",
      keyword: "å…³é”®è¯",
      image_url: "/uploads/xxx.jpg"
    },
    account: {
      id: 456,
      platform_id: "xiaohongshu",
      account_name: "æµ‹è¯•è´¦å·",
      credentials: {
        cookies: [...],  // ç™»å½•å‡­è¯
        username: "xxx",
        password: "***"
      }
    }
  }
```

### é˜¶æ®µ 3ï¼šæœ¬åœ°æ‰§è¡Œï¼ˆElectron ä¸»è¿›ç¨‹ï¼‰

```
Electron ä¸»è¿›ç¨‹ï¼š
  1. å¯åŠ¨æµè§ˆå™¨
  2. ä½¿ç”¨ account.credentials ç™»å½•
  3. ä½¿ç”¨ article æ•°æ®å‘å¸ƒå†…å®¹
  4. å®æ—¶å‘é€æ—¥å¿—åˆ°æ¸²æŸ“è¿›ç¨‹
  5. åŒæ­¥æ—¥å¿—åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
```

### é˜¶æ®µ 4ï¼šçŠ¶æ€åŒæ­¥ï¼ˆElectron â†’ æœåŠ¡å™¨ï¼‰

```
æ‰§è¡Œè¿‡ç¨‹ä¸­å®æ—¶åŒæ­¥ï¼š
  
  å¼€å§‹æ‰§è¡Œï¼š
    PUT /api/publishing/tasks/789/status
    { status: "running", started_at: "2024-01-20T10:00:00Z" }
  
  è®°å½•æ—¥å¿—ï¼ˆå¯é€‰ï¼‰ï¼š
    POST /api/publishing/tasks/789/logs
    { level: "info", message: "å¼€å§‹ç™»å½•..." }
  
  æ‰§è¡ŒæˆåŠŸï¼š
    PUT /api/publishing/tasks/789/status
    { 
      status: "success", 
      completed_at: "2024-01-20T10:05:00Z"
    }
  
  æ‰§è¡Œå¤±è´¥ï¼š
    PUT /api/publishing/tasks/789/status
    { 
      status: "failed", 
      error_message: "ç™»å½•å¤±è´¥",
      completed_at: "2024-01-20T10:02:00Z"
    }
```

### é˜¶æ®µ 5ï¼šåˆ›å»ºå‘å¸ƒè®°å½•ï¼ˆElectron â†’ æœåŠ¡å™¨ï¼‰

```
å‘å¸ƒæˆåŠŸåï¼š
  POST /api/publishing/records
  {
    task_id: 789,
    article_id: 123,
    account_id: 456,
    platform_id: "xiaohongshu",
    published_at: "2024-01-20T10:05:00Z",
    // æ–‡ç« å¿«ç…§
    article_title: "æ–‡ç« æ ‡é¢˜",
    article_content: "æ–‡ç« å†…å®¹...",
    article_keyword: "å…³é”®è¯"
  }
```

## ğŸ“Š è¯¦ç»† API è®¾è®¡

### 1. è·å–ä»»åŠ¡è¯¦æƒ…ï¼ˆå«æ‰§è¡Œæ•°æ®ï¼‰

**è¯·æ±‚**ï¼š
```http
GET /api/publishing/tasks/:id?include=article,account
Authorization: Bearer <token>
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 789,
    "article_id": 123,
    "account_id": 456,
    "platform_id": "xiaohongshu",
    "user_id": 1,
    "status": "pending",
    "config": {
      "headless": false,
      "timeout_minutes": 15
    },
    "scheduled_at": null,
    "created_at": "2024-01-20T09:55:00Z",
    
    // æ–‡ç« æ•°æ®ï¼ˆæ‰§è¡Œæ—¶éœ€è¦ï¼‰
    "article": {
      "id": 123,
      "title": "å¦‚ä½•ä¼˜åŒ– SEO",
      "content": "<p>æ–‡ç« å†…å®¹...</p>",
      "keyword": "SEOä¼˜åŒ–",
      "image_url": "/uploads/2024/01/image.jpg"
    },
    
    // è´¦å·æ•°æ®ï¼ˆæ‰§è¡Œæ—¶éœ€è¦ï¼‰
    "account": {
      "id": 456,
      "platform_id": "xiaohongshu",
      "account_name": "æµ‹è¯•è´¦å·",
      "real_username": "user123",
      "status": "active",
      "credentials": {
        "cookies": [
          {
            "name": "session_id",
            "value": "xxx",
            "domain": ".xiaohongshu.com",
            "path": "/",
            "expires": 1705747200
          }
        ]
      }
    }
  }
}
```

### 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€

**è¯·æ±‚**ï¼š
```http
PUT /api/publishing/tasks/:id/status
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": "running",
  "started_at": "2024-01-20T10:00:00Z"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°"
}
```

### 3. æ·»åŠ ä»»åŠ¡æ—¥å¿—

**è¯·æ±‚**ï¼š
```http
POST /api/publishing/tasks/:id/logs
Authorization: Bearer <token>
Content-Type: application/json

{
  "level": "info",
  "message": "ğŸ” å¼€å§‹ç™»å½•å°çº¢ä¹¦...",
  "details": {
    "step": "login",
    "platform": "xiaohongshu"
  }
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 12345,
    "created_at": "2024-01-20T10:00:05Z"
  }
}
```

### 4. åˆ›å»ºå‘å¸ƒè®°å½•

**è¯·æ±‚**ï¼š
```http
POST /api/publishing/records
Authorization: Bearer <token>
Content-Type: application/json

{
  "task_id": 789,
  "article_id": 123,
  "account_id": 456,
  "platform_id": "xiaohongshu",
  "account_name": "æµ‹è¯•è´¦å·",
  "user_id": 1,
  "published_at": "2024-01-20T10:05:00Z",
  "article_title": "å¦‚ä½•ä¼˜åŒ– SEO",
  "article_content": "<p>æ–‡ç« å†…å®¹...</p>",
  "article_keyword": "SEOä¼˜åŒ–",
  "article_image_url": "/uploads/2024/01/image.jpg"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 999,
    "created_at": "2024-01-20T10:05:10Z"
  }
}
```

## ğŸ’» Electron å®ç°ä»£ç 

### ä¸»è¿›ç¨‹ï¼šä»»åŠ¡æ‰§è¡Œå™¨

```typescript
// electron/services/PublishingExecutor.ts
import { apiClient } from '../api/client';

export class PublishingExecutor {
  async executeTask(taskId: number) {
    try {
      // 1. ä»æœåŠ¡å™¨è·å–ä»»åŠ¡è¯¦æƒ…ï¼ˆå«æ–‡ç« å’Œè´¦å·æ•°æ®ï¼‰
      const task = await this.fetchTaskDetails(taskId);
      
      // 2. æ›´æ–°çŠ¶æ€ä¸ºæ‰§è¡Œä¸­
      await this.updateTaskStatus(taskId, 'running', {
        started_at: new Date().toISOString()
      });
      
      // 3. è®°å½•æ—¥å¿—
      await this.addLog(taskId, 'info', 'ğŸš€ å¼€å§‹æ‰§è¡Œå‘å¸ƒä»»åŠ¡');
      
      // 4. è·å–å¹³å°é€‚é…å™¨
      const adapter = adapterRegistry.getAdapter(task.platform_id);
      
      // 5. å¯åŠ¨æµè§ˆå™¨
      await this.addLog(taskId, 'info', 'ğŸŒ å¯åŠ¨æµè§ˆå™¨...');
      await browserService.launchBrowser({ 
        headless: task.config.headless 
      });
      
      const page = await browserService.createPage();
      
      // 6. æ‰§è¡Œç™»å½•
      await this.addLog(taskId, 'info', `ğŸ” ç™»å½• ${task.platform_id}...`);
      const loginSuccess = await adapter.performLogin(
        page, 
        task.account.credentials
      );
      
      if (!loginSuccess) {
        throw new Error('ç™»å½•å¤±è´¥');
      }
      
      // 7. æ‰§è¡Œå‘å¸ƒ
      await this.addLog(taskId, 'info', 'ğŸ“ å¼€å§‹å‘å¸ƒæ–‡ç« ...');
      const publishSuccess = await adapter.performPublish(
        page,
        task.article,
        task.config
      });
      
      if (!publishSuccess) {
        throw new Error('å‘å¸ƒå¤±è´¥');
      }
      
      // 8. æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
      await this.updateTaskStatus(taskId, 'success', {
        completed_at: new Date().toISOString()
      });
      
      await this.addLog(taskId, 'info', 'âœ… å‘å¸ƒæˆåŠŸï¼');
      
      // 9. åˆ›å»ºå‘å¸ƒè®°å½•
      await this.createPublishingRecord(task);
      
      // 10. å…³é—­æµè§ˆå™¨
      await browserService.closeBrowser();
      
    } catch (error) {
      // é”™è¯¯å¤„ç†
      await this.updateTaskStatus(taskId, 'failed', {
        error_message: error.message,
        completed_at: new Date().toISOString()
      });
      
      await this.addLog(taskId, 'error', `âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`);
      
      throw error;
    }
  }
  
  // ä»æœåŠ¡å™¨è·å–ä»»åŠ¡è¯¦æƒ…
  private async fetchTaskDetails(taskId: number) {
    const response = await apiClient.get(
      `/publishing/tasks/${taskId}?include=article,account`
    );
    return response.data.data;
  }
  
  // æ›´æ–°ä»»åŠ¡çŠ¶æ€
  private async updateTaskStatus(
    taskId: number, 
    status: string, 
    data: any
  ) {
    await apiClient.put(`/publishing/tasks/${taskId}/status`, {
      status,
      ...data
    });
  }
  
  // æ·»åŠ æ—¥å¿—
  private async addLog(
    taskId: number, 
    level: string, 
    message: string
  ) {
    // å‘é€åˆ°æ¸²æŸ“è¿›ç¨‹ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
    this.sendToRenderer('task-log', { taskId, level, message });
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨ï¼ˆæŒä¹…åŒ–ï¼‰
    await apiClient.post(`/publishing/tasks/${taskId}/logs`, {
      level,
      message,
      timestamp: new Date().toISOString()
    });
  }
  
  // åˆ›å»ºå‘å¸ƒè®°å½•
  private async createPublishingRecord(task: any) {
    await apiClient.post('/publishing/records', {
      task_id: task.id,
      article_id: task.article_id,
      account_id: task.account_id,
      platform_id: task.platform_id,
      account_name: task.account.account_name,
      user_id: task.user_id,
      published_at: new Date().toISOString(),
      article_title: task.article.title,
      article_content: task.article.content,
      article_keyword: task.article.keyword,
      article_image_url: task.article.image_url
    });
  }
}
```

### ä¸»è¿›ç¨‹ï¼šIPC å¤„ç†

```typescript
// electron/main/ipc-handlers.ts
import { ipcMain } from 'electron';
import { publishingExecutor } from '../services/PublishingExecutor';

export function setupIpcHandlers() {
  // æ‰§è¡Œä»»åŠ¡
  ipcMain.handle('execute-task', async (event, taskId: number) => {
    try {
      await publishingExecutor.executeTask(taskId);
      return { success: true };
    } catch (error) {
      return { 
        success: false, 
        error: error.message 
      };
    }
  });
  
  // è·å–ä»»åŠ¡åˆ—è¡¨
  ipcMain.handle('get-tasks', async (event, filters) => {
    const response = await apiClient.get('/publishing/tasks', {
      params: filters
    });
    return response.data;
  });
}
```

### æ¸²æŸ“è¿›ç¨‹ï¼šReact ç»„ä»¶

```typescript
// windows-login-manager/src/pages/PublishingTasksPage.tsx
const handleExecuteTask = async (taskId: number) => {
  try {
    setExecuting(true);
    
    // è°ƒç”¨ä¸»è¿›ç¨‹æ‰§è¡Œä»»åŠ¡
    const result = await window.electron.executeTask(taskId);
    
    if (result.success) {
      message.success('ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ');
      loadTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
    } else {
      message.error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result.error}`);
    }
  } catch (error) {
    message.error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
  } finally {
    setExecuting(false);
  }
};

// ç›‘å¬å®æ—¶æ—¥å¿—
useEffect(() => {
  const unsubscribe = window.electron.onTaskLog((data) => {
    if (data.taskId === currentTaskId) {
      setLogs(prev => [...prev, {
        level: data.level,
        message: data.message,
        timestamp: new Date().toISOString()
      }]);
    }
  });
  
  return unsubscribe;
}, [currentTaskId]);
```

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•æ„Ÿæ•°æ®ä¼ è¾“

```typescript
// è´¦å·å‡­è¯åŠ å¯†ä¼ è¾“
const task = await apiClient.get(`/publishing/tasks/${taskId}`, {
  headers: {
    'X-Decrypt-Credentials': 'true' // æœåŠ¡å™¨è§£å¯†åè¿”å›
  }
});
```

### 2. Token ç®¡ç†

```typescript
// æœ¬åœ°å­˜å‚¨ Tokenï¼ˆåŠ å¯†ï¼‰
import { safeStorage } from 'electron';

const encryptedToken = safeStorage.encryptString(token);
localStorage.setItem('auth_token', encryptedToken);
```

### 3. API è¯·æ±‚æ‹¦æˆª

```typescript
// è‡ªåŠ¨æ·»åŠ  Token
apiClient.interceptors.request.use(config => {
  const token = getDecryptedToken();
  config.headers.Authorization = `Bearer ${token}`;
  return config;
});
```

## ğŸ“Š æ•°æ®æµæ—¶åºå›¾

```
ç”¨æˆ·                Electronæ¸²æŸ“è¿›ç¨‹    Electronä¸»è¿›ç¨‹    æœåŠ¡å™¨
 â”‚                      â”‚                  â”‚              â”‚
 â”‚  ç‚¹å‡»"æ‰§è¡Œä»»åŠ¡"       â”‚                  â”‚              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚
 â”‚                      â”‚  executeTask()   â”‚              â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
 â”‚                      â”‚                  â”‚ GET /tasks/789?include=article,account
 â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                      â”‚                  â”‚ è¿”å›å®Œæ•´æ•°æ®  â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚                  â”‚ PUT /tasks/789/status (running)
 â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚  å®æ—¶æ—¥å¿—         â”‚              â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚  æ˜¾ç¤ºæ—¥å¿—             â”‚                  â”‚              â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚              â”‚
 â”‚                      â”‚                  â”‚ POST /tasks/789/logs
 â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚                  â”‚ [æ‰§è¡Œå‘å¸ƒ]    â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚                  â”‚ PUT /tasks/789/status (success)
 â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚                  â”‚ POST /publishing/records
 â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                  â”‚              â”‚
 â”‚                      â”‚  æ‰§è¡Œå®Œæˆ         â”‚              â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚  æ˜¾ç¤ºæˆåŠŸæç¤º         â”‚                  â”‚              â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚              â”‚
```

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### æ•°æ®è·å–

1. **ä»»åŠ¡åˆ›å»ºæ—¶**ï¼šåªä¿å­˜åŸºæœ¬ä¿¡æ¯ï¼ˆarticle_id, account_idï¼‰
2. **ä»»åŠ¡æ‰§è¡Œæ—¶**ï¼šä»æœåŠ¡å™¨è·å–å®Œæ•´æ•°æ®ï¼ˆarticle, accountï¼‰
3. **ä¼˜åŠ¿**ï¼šæ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„ï¼Œé¿å…æœ¬åœ°ç¼“å­˜è¿‡æœŸ

### æ•°æ®åŒæ­¥

1. **çŠ¶æ€åŒæ­¥**ï¼šå®æ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆrunning â†’ success/failedï¼‰
2. **æ—¥å¿—åŒæ­¥**ï¼šå¯é€‰ï¼Œç”¨äºæŒä¹…åŒ–å’Œå¤šç«¯æŸ¥çœ‹
3. **ç»“æœåŒæ­¥**ï¼šåˆ›å»ºå‘å¸ƒè®°å½•ï¼Œä¿å­˜æ–‡ç« å¿«ç…§

### æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡è·å–**ï¼šä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼ˆinclude å‚æ•°ï¼‰
2. **å¢é‡åŒæ­¥**ï¼šåªåŒæ­¥å˜åŒ–çš„æ•°æ®
3. **æœ¬åœ°ç¼“å­˜**ï¼šç¼“å­˜ä¸å¸¸å˜åŒ–çš„æ•°æ®ï¼ˆå¹³å°åˆ—è¡¨ç­‰ï¼‰

---

**è¿™å°±æ˜¯å®Œæ•´çš„æ•°æ®æµæ–¹æ¡ˆï¼** ğŸ‰


## ğŸ”„ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šå‘å¸ƒä¸€ç¯‡æ–‡ç« åˆ°å°çº¢ä¹¦

#### Step 1: ç”¨æˆ·åˆ›å»ºä»»åŠ¡

```typescript
// å‰ç«¯ä»£ç 
const handleCreateTask = async () => {
  const response = await apiClient.post('/publishing/tasks', {
    article_id: 123,
    account_id: 456,
    platform_id: 'xiaohongshu',
    config: {
      headless: false,
      timeout_minutes: 15
    }
  });
  
  const taskId = response.data.data.id; // 789
  console.log('ä»»åŠ¡å·²åˆ›å»º:', taskId);
};
```

#### Step 2: ç”¨æˆ·ç‚¹å‡»æ‰§è¡Œ

```typescript
// å‰ç«¯ä»£ç 
const handleExecute = async (taskId: number) => {
  // è°ƒç”¨ Electron ä¸»è¿›ç¨‹
  const result = await window.electron.executeTask(taskId);
  
  if (result.success) {
    message.success('ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ');
  }
};
```

#### Step 3: Electron ä¸»è¿›ç¨‹æ‰§è¡Œ

```typescript
// electron/main/index.ts
ipcMain.handle('execute-task', async (event, taskId) => {
  // 1. è·å–ä»»åŠ¡è¯¦æƒ…ï¼ˆå«æ–‡ç« å’Œè´¦å·ï¼‰
  const task = await fetch(
    `http://localhost:3000/api/publishing/tasks/${taskId}?include=article,account`,
    {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    }
  ).then(res => res.json());
  
  console.log('è·å–åˆ°ä»»åŠ¡æ•°æ®:', {
    taskId: task.data.id,
    articleTitle: task.data.article.title,
    accountName: task.data.account.account_name,
    hasCookies: task.data.account.credentials.cookies.length > 0
  });
  
  // 2. æ›´æ–°çŠ¶æ€ä¸ºæ‰§è¡Œä¸­
  await fetch(
    `http://localhost:3000/api/publishing/tasks/${taskId}/status`,
    {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status: 'running',
        started_at: new Date().toISOString()
      })
    }
  );
  
  // 3. æ‰§è¡Œå‘å¸ƒ
  try {
    await publishingExecutor.execute(task.data);
    
    // 4. æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
    await fetch(
      `http://localhost:3000/api/publishing/tasks/${taskId}/status`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'success',
          completed_at: new Date().toISOString()
        })
      }
    );
    
    // 5. åˆ›å»ºå‘å¸ƒè®°å½•
    await fetch(
      'http://localhost:3000/api/publishing/records',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: taskId,
          article_id: task.data.article_id,
          account_id: task.data.account_id,
          platform_id: task.data.platform_id,
          published_at: new Date().toISOString(),
          article_title: task.data.article.title,
          article_content: task.data.article.content
        })
      }
    );
    
    return { success: true };
  } catch (error) {
    // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
    await fetch(
      `http://localhost:3000/api/publishing/tasks/${taskId}/status`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'failed',
          error_message: error.message,
          completed_at: new Date().toISOString()
        })
      }
    );
    
    return { success: false, error: error.message };
  }
});
```

## ğŸ“¦ æœåŠ¡å™¨ API å®ç°

### 1. è·å–ä»»åŠ¡è¯¦æƒ…ï¼ˆå«å…³è”æ•°æ®ï¼‰

```typescript
// server/src/routes/publishingTasks.ts
router.get('/tasks/:id', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const taskId = parseInt(req.params.id);
    const include = req.query.include as string; // "article,account"
    
    // è·å–ä»»åŠ¡åŸºæœ¬ä¿¡æ¯
    const taskResult = await pool.query(
      'SELECT * FROM publishing_tasks WHERE id = $1 AND user_id = $2',
      [taskId, userId]
    );
    
    if (taskResult.rows.length === 0) {
      return res.status(404).json({
        success: false,
        message: 'ä»»åŠ¡ä¸å­˜åœ¨'
      });
    }
    
    const task = taskResult.rows[0];
    
    // æ ¹æ® include å‚æ•°åŠ è½½å…³è”æ•°æ®
    if (include) {
      const includes = include.split(',');
      
      // åŠ è½½æ–‡ç« æ•°æ®
      if (includes.includes('article')) {
        const articleResult = await pool.query(
          'SELECT id, title, content, keyword, image_url FROM articles WHERE id = $1',
          [task.article_id]
        );
        task.article = articleResult.rows[0] || null;
      }
      
      // åŠ è½½è´¦å·æ•°æ®ï¼ˆå«å‡­è¯ï¼‰
      if (includes.includes('account')) {
        const accountResult = await pool.query(
          'SELECT id, platform_id, account_name, real_username, status, credentials FROM platform_accounts WHERE id = $1 AND user_id = $2',
          [task.account_id, userId]
        );
        
        if (accountResult.rows[0]) {
          const account = accountResult.rows[0];
          // è§£å¯†å‡­è¯
          account.credentials = JSON.parse(
            decryptCredentials(account.credentials)
          );
          task.account = account;
        }
      }
    }
    
    res.json({
      success: true,
      data: task
    });
  } catch (error) {
    console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥'
    });
  }
});
```

### 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€

```typescript
// server/src/routes/publishingTasks.ts
router.put('/tasks/:id/status', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const taskId = parseInt(req.params.id);
    const { status, started_at, completed_at, error_message } = req.body;
    
    // éªŒè¯ä»»åŠ¡æ‰€æœ‰æƒ
    const taskResult = await pool.query(
      'SELECT * FROM publishing_tasks WHERE id = $1 AND user_id = $2',
      [taskId, userId]
    );
    
    if (taskResult.rows.length === 0) {
      return res.status(404).json({
        success: false,
        message: 'ä»»åŠ¡ä¸å­˜åœ¨'
      });
    }
    
    // æ„å»ºæ›´æ–°è¯­å¥
    const updates: string[] = ['status = $1', 'updated_at = CURRENT_TIMESTAMP'];
    const params: any[] = [status];
    let paramIndex = 2;
    
    if (started_at) {
      updates.push(`started_at = $${paramIndex}`);
      params.push(started_at);
      paramIndex++;
    }
    
    if (completed_at) {
      updates.push(`completed_at = $${paramIndex}`);
      params.push(completed_at);
      paramIndex++;
    }
    
    if (error_message) {
      updates.push(`error_message = $${paramIndex}`);
      params.push(error_message);
      paramIndex++;
    }
    
    params.push(taskId);
    
    await pool.query(
      `UPDATE publishing_tasks SET ${updates.join(', ')} WHERE id = $${paramIndex}`,
      params
    );
    
    res.json({
      success: true,
      message: 'ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°'
    });
  } catch (error) {
    console.error('æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥'
    });
  }
});
```

### 3. æ·»åŠ ä»»åŠ¡æ—¥å¿—

```typescript
// server/src/routes/publishingTasks.ts
router.post('/tasks/:id/logs', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const taskId = parseInt(req.params.id);
    const { level, message, details } = req.body;
    
    // éªŒè¯ä»»åŠ¡æ‰€æœ‰æƒ
    const taskResult = await pool.query(
      'SELECT * FROM publishing_tasks WHERE id = $1 AND user_id = $2',
      [taskId, userId]
    );
    
    if (taskResult.rows.length === 0) {
      return res.status(404).json({
        success: false,
        message: 'ä»»åŠ¡ä¸å­˜åœ¨'
      });
    }
    
    // æ’å…¥æ—¥å¿—
    const result = await pool.query(
      `INSERT INTO publishing_logs (task_id, level, message, details) 
       VALUES ($1, $2, $3, $4) 
       RETURNING id, created_at`,
      [taskId, level, message, details ? JSON.stringify(details) : null]
    );
    
    res.json({
      success: true,
      data: result.rows[0]
    });
  } catch (error) {
    console.error('æ·»åŠ ä»»åŠ¡æ—¥å¿—å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ·»åŠ ä»»åŠ¡æ—¥å¿—å¤±è´¥'
    });
  }
});
```

## ğŸ¯ æ•°æ®ç¼“å­˜ç­–ç•¥

### æœ¬åœ°ç¼“å­˜ï¼ˆElectronï¼‰

```typescript
// electron/services/CacheService.ts
export class CacheService {
  private cache = new Map<string, any>();
  
  // ç¼“å­˜å¹³å°åˆ—è¡¨ï¼ˆä¸å¸¸å˜åŒ–ï¼‰
  async getPlatforms() {
    const cacheKey = 'platforms';
    
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }
    
    const response = await apiClient.get('/platforms');
    const platforms = response.data.data;
    
    this.cache.set(cacheKey, platforms);
    
    // 1å°æ—¶åè¿‡æœŸ
    setTimeout(() => {
      this.cache.delete(cacheKey);
    }, 3600000);
    
    return platforms;
  }
  
  // ä¸ç¼“å­˜ä»»åŠ¡æ•°æ®ï¼ˆå®æ—¶æ€§è¦æ±‚é«˜ï¼‰
  async getTask(taskId: number) {
    // æ¯æ¬¡éƒ½ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
    const response = await apiClient.get(
      `/publishing/tasks/${taskId}?include=article,account`
    );
    return response.data.data;
  }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡åˆ›å»ºä»»åŠ¡
const tasks = await Promise.all(
  articles.map(article => 
    accounts.map(account =>
      apiClient.post('/publishing/tasks', {
        article_id: article.id,
        account_id: account.id,
        platform_id: account.platform_id
      })
    )
  ).flat()
);
```

### 2. å¢é‡åŒæ­¥

```typescript
// åªåŒæ­¥å˜åŒ–çš„æ—¥å¿—
let lastLogId = 0;

setInterval(async () => {
  const response = await apiClient.get(
    `/publishing/tasks/${taskId}/logs?since=${lastLogId}`
  );
  
  const newLogs = response.data.data;
  if (newLogs.length > 0) {
    lastLogId = newLogs[newLogs.length - 1].id;
    updateUI(newLogs);
  }
}, 1000);
```

### 3. å‹ç¼©ä¼ è¾“

```typescript
// æœåŠ¡å™¨ç«¯å¯ç”¨ gzip
app.use(compression());

// å®¢æˆ·ç«¯è‡ªåŠ¨è§£å‹
apiClient.defaults.headers['Accept-Encoding'] = 'gzip, deflate';
```

## ğŸ”’ é”™è¯¯å¤„ç†

### ç½‘ç»œé”™è¯¯é‡è¯•

```typescript
// electron/services/ApiClient.ts
export class ApiClient {
  async request(config: any, retries = 3) {
    try {
      return await axios(config);
    } catch (error) {
      if (retries > 0 && this.isNetworkError(error)) {
        console.log(`ç½‘ç»œé”™è¯¯ï¼Œ${retries} æ¬¡é‡è¯•å‰©ä½™`);
        await this.sleep(1000);
        return this.request(config, retries - 1);
      }
      throw error;
    }
  }
  
  private isNetworkError(error: any) {
    return error.code === 'ECONNREFUSED' 
      || error.code === 'ETIMEDOUT'
      || error.message.includes('Network Error');
  }
  
  private sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ¢å¤

```typescript
// ä»»åŠ¡æ‰§è¡Œå¤±è´¥åï¼ŒçŠ¶æ€å·²åŒæ­¥åˆ°æœåŠ¡å™¨
// ç”¨æˆ·å¯ä»¥åœ¨ç•Œé¢ä¸Šé‡æ–°æ‰§è¡Œ
const handleRetry = async (taskId: number) => {
  // é‡ç½®ä»»åŠ¡çŠ¶æ€
  await apiClient.put(`/publishing/tasks/${taskId}/status`, {
    status: 'pending',
    error_message: null
  });
  
  // é‡æ–°æ‰§è¡Œ
  await window.electron.executeTask(taskId);
};
```

## ğŸ‰ æ€»ç»“

### æ•°æ®æµæ ¸å¿ƒåŸåˆ™

1. **æœåŠ¡å™¨æ˜¯æ•°æ®æº**ï¼šæ‰€æœ‰æ•°æ®ä»æœåŠ¡å™¨è·å–
2. **æœ¬åœ°æ˜¯æ‰§è¡Œå™¨**ï¼šElectron è´Ÿè´£æ‰§è¡Œä»»åŠ¡
3. **å®æ—¶åŒå‘åŒæ­¥**ï¼šçŠ¶æ€å’Œæ—¥å¿—å®æ—¶åŒæ­¥

### å…³é”®ä¼˜åŠ¿

- âœ… æ•°æ®å§‹ç»ˆæœ€æ–°ï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰
- âœ… æ‰§è¡Œå®Œå…¨æœ¬åœ°ï¼ˆé™ä½æœåŠ¡å™¨è´Ÿæ‹…ï¼‰
- âœ… çŠ¶æ€å®æ—¶åŒæ­¥ï¼ˆç”¨æˆ·ä½“éªŒå¥½ï¼‰
- âœ… ç¦»çº¿å‹å¥½ï¼ˆå¯ç¼“å­˜éƒ¨åˆ†æ•°æ®ï¼‰

### å®æ–½å»ºè®®

1. **å…ˆå®ç°æ ¸å¿ƒæµç¨‹**ï¼šåˆ›å»ºä»»åŠ¡ â†’ æ‰§è¡Œ â†’ åŒæ­¥çŠ¶æ€
2. **å†ä¼˜åŒ–æ€§èƒ½**ï¼šç¼“å­˜ã€æ‰¹é‡ã€å‹ç¼©
3. **æœ€åå®Œå–„ä½“éªŒ**ï¼šé”™è¯¯å¤„ç†ã€é‡è¯•ã€æ—¥å¿—

---

**è¿™å°±æ˜¯å®Œæ•´çš„æ•°æ®æµè®¾è®¡æ–¹æ¡ˆï¼** ğŸš€
