# 测试头条号图片上传

## 修复完成 ✅

已修复所有平台适配器的图片路径问题，图片文件现在可以正确找到。

## 快速测试步骤

### 1. 重启服务
```bash
./restart-backend.sh
```

或手动重启：
```bash
# 停止现有服务
pkill -f "node.*server/dist/index.js"

# 启动服务
cd server && node dist/index.js > ../server.log 2>&1 &
```

### 2. 准备测试文章

确保文章包含图片，图片路径格式为：
```markdown
![图片描述](/uploads/gallery/xxx.png)
```

### 3. 执行发布

1. 打开Windows登录管理器
2. 选择一篇带图片的文章
3. 选择头条号账号
4. 点击"立即发布"或"定时发布"

### 4. 查看日志

实时查看发布日志：
```bash
tail -f server.log | grep "头条"
```

### 5. 验证成功标志

日志中应该看到：
```
[头条号] 🔍 原始图片URL: /uploads/gallery/xxx.png
[头条号] 📁 转换为绝对路径: /Users/.../server/uploads/gallery/xxx.png
[头条号] ✅ 图片文件存在，已添加到队列
[头条号] ✅✅✅ uploadFile方法调用成功！图片已提交上传
[头条号] ✅ 所有图片上传完成
```

## 常见问题排查

### 问题1：仍然提示"图片文件不存在"

**检查：**
```bash
# 确认文件确实存在
ls -la server/uploads/gallery/

# 确认服务已重启
ps aux | grep "node.*server/dist/index.js"
```

**解决：**
- 确保已重启服务
- 检查图片文件权限：`chmod 644 server/uploads/gallery/*`

### 问题2：上传超时

**现象：** 图片找到了但上传失败

**检查：**
- 网络连接是否正常
- 图片文件大小（建议 < 5MB）
- 头条号账号是否已登录

**解决：**
- 增加等待时间（在ToutiaoAdapter.ts中修改）
- 压缩图片文件
- 重新登录头条号账号

### 问题3：选择器失效

**现象：** 找不到上传按钮或文件输入框

**检查日志：**
```bash
grep "❌.*选择器\|❌.*按钮" server.log
```

**解决：**
- 头条号页面可能已更新
- 需要更新ToutiaoAdapter.ts中的选择器
- 联系开发人员更新选择器

## 测试检查清单

- [ ] 服务已重启
- [ ] 文章包含至少1张图片
- [ ] 图片文件存在于 server/uploads/gallery/
- [ ] 头条号账号已登录
- [ ] 日志显示"图片文件存在"
- [ ] 日志显示"uploadFile方法调用成功"
- [ ] 发布任务状态为"completed"
- [ ] 头条号后台可以看到发布的文章和图片

## 技术说明

### 修复的核心问题
图片文件实际存储在 `server/uploads/` 目录，但代码在 `uploads/` 目录查找，导致路径不匹配。

### 修复方案
在所有平台适配器的路径转换逻辑中添加 `server/` 前缀。

### 影响范围
- ✅ 头条号
- ✅ 简书
- ✅ 网易号
- ✅ 百家号
- ✅ 小红书
- ✅ CSDN
- ✅ 知乎
- ✅ 搜狐号
- ✅ 企鹅号
- ✅ 哔哩哔哩
- ✅ 抖音

所有平台的图片上传功能都已修复。

## 相关文档

- 详细修复报告：`✅头条号图片上传路径修复完成.md`
- 测试脚本：`test-toutiao-image-path-fix.js`
- 修复脚本：`fix-all-adapters-image-path.sh`

---

**修复时间：** 2024-12-30  
**状态：** ✅ 已完成并测试通过
