# 测试关闭浏览器按钮

## 快速测试步骤

### 1. 重启Windows登录管理器
```bash
# 停止当前运行的实例
# 然后重新启动
./启动Windows管理器.command
```

### 2. 测试关闭按钮
1. 打开应用后，进入"平台管理"页面
2. 点击任意平台卡片（建议选择"头条号"或"小红书"）
3. 等待浏览器窗口弹出
4. 观察右上角的工具栏，应该看到：
   - 左侧：状态图标 + "正在登录平台..."
   - 右侧：红色的"✕ 关闭浏览器"按钮
5. 点击"✕ 关闭浏览器"按钮
6. 验证结果

## 预期结果

### ✅ 成功的表现
- 点击按钮后，浏览器窗口立即关闭
- 返回到平台管理页面
- 应用界面恢复正常
- 没有错误提示

### 📊 控制台日志（按 F12 打开开发者工具）
应该看到以下日志：
```
[WebView] Close button clicked
[WebView] Global close function called
[WebView] Calling cancelLogin via IPC
[WebView] cancelLogin result: { success: true }
```

### ❌ 如果失败
如果点击按钮后没有反应，检查控制台是否有以下错误：
```
[WebView] __closeWebView function not available
```
或
```
[WebView] electronAPI.cancelLogin not available
```

## 调试方法

### 方法1：检查全局函数是否存在
在浏览器窗口打开时，打开开发者工具（F12），在控制台输入：
```javascript
console.log('__closeWebView exists:', typeof window.__closeWebView);
console.log('electronAPI exists:', typeof window.electronAPI);
```

应该看到：
```
__closeWebView exists: function
electronAPI exists: object
```

### 方法2：手动调用关闭函数
在控制台输入：
```javascript
window.__closeWebView();
```

如果这个命令能关闭浏览器，说明函数本身工作正常，问题在于按钮的事件绑定。

### 方法3：检查按钮元素
在控制台输入：
```javascript
const btn = document.getElementById('close-browser-btn');
console.log('Button exists:', !!btn);
console.log('Button onclick:', btn?.onclick);
console.log('Button listeners:', getEventListeners(btn));
```

## 常见问题

### Q1: 点击按钮没有任何反应
**原因**：可能是事件监听器没有正确绑定
**解决**：检查控制台日志，确认是否有 "[WebView] Close button clicked" 输出

### Q2: 看到错误 "electronAPI not available"
**原因**：preload 脚本没有正确加载
**解决**：检查 `windows-login-manager/electron/preload.ts` 是否正确编译

### Q3: 按钮点击后有延迟
**原因**：这是正常的，因为需要：
1. 调用 IPC
2. 停止登录检测
3. 销毁 WebView
4. 恢复界面
**解决**：通常在 100-300ms 内完成

## 测试不同平台

建议测试以下平台，确保关闭按钮在所有场景下都能正常工作：

- ✅ 头条号（使用专用管理器）
- ✅ 抖音号（使用专用管理器）- **特别注意：之前无法关闭，现已修复**
- ✅ 小红书（使用通用管理器）
- ✅ 搜狐号（使用通用管理器）
- ✅ 企鹅号（使用通用管理器）
- ✅ 哔哩哔哩（使用通用管理器）

### 特别说明：抖音登录关闭问题
抖音使用专用的 `douyinLoginManager`，之前由于 IPC handler 的逻辑问题，无法正确关闭。现已修复：
- 修改了 `cancel-login` handler，当没有传递 `platformId` 时，会检查所有登录管理器的状态
- 自动检测并取消正在进行的登录（头条号、抖音号或通用登录）
- 详见：`✅抖音关闭按钮修复完成.md`

## 修复内容总结

1. **创建全局关闭函数** - 在 WebView 创建时注入 `window.__closeWebView`
2. **修改按钮事件** - 直接调用全局函数而不是查找不存在的元素
3. **添加清理机制** - 销毁 WebView 时删除全局函数
4. **完善日志** - 添加详细的日志输出便于调试
5. **类型声明** - 添加 TypeScript 类型支持

## 相关文件
- `windows-login-manager/electron/login/webview-manager.ts`
- `windows-login-manager/src/types/electron.d.ts`
- `✅关闭浏览器按钮修复完成.md`
