# å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»è„šæœ¬
**æ–‡ä»¶ï¼š** `server/src/db/migrations/add-multi-tenancy.sql`

ä¸ºä»¥ä¸‹10ä¸ªæ ¸å¿ƒä¸šåŠ¡è¡¨æ·»åŠ äº† `user_id` å­—æ®µï¼š
- âœ… albumsï¼ˆç›¸å†Œï¼‰
- âœ… knowledge_basesï¼ˆçŸ¥è¯†åº“ï¼‰
- âœ… conversion_targetsï¼ˆè½¬åŒ–ç›®æ ‡ï¼‰
- âœ… article_settingsï¼ˆæ–‡ç« è®¾ç½®ï¼‰
- âœ… distillationsï¼ˆå…³é”®è¯è’¸é¦ï¼‰
- âœ… articlesï¼ˆæ–‡ç« ï¼‰
- âœ… generation_tasksï¼ˆç”Ÿæˆä»»åŠ¡ï¼‰
- âœ… platform_accountsï¼ˆå¹³å°è´¦å·ï¼‰
- âœ… distillation_configï¼ˆè’¸é¦é…ç½®ï¼‰
- âœ… api_configsï¼ˆAPIé…ç½®ï¼‰

### 2. è¿ç§»æ‰§è¡Œè„šæœ¬
**æ–‡ä»¶ï¼š** `server/src/db/migrate-multi-tenancy.ts`

è‡ªåŠ¨åŒ–æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ŒåŒ…å«ï¼š
- äº‹åŠ¡å¤„ç†ï¼ˆå¤±è´¥è‡ªåŠ¨å›æ»šï¼‰
- è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
- é”™è¯¯å¤„ç†

### 3. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶
**æ–‡ä»¶ï¼š** `server/src/middleware/tenantContext.ts`

æä¾›ï¼š
- `setTenantContext()` - è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- `requireTenantContext()` - è¦æ±‚ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- `getCurrentTenantId()` - è·å–å½“å‰ç§Ÿæˆ·ID
- `isAdmin()` - æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜

### 4. ç§Ÿæˆ·æœåŠ¡
**æ–‡ä»¶ï¼š** `server/src/services/TenantService.ts`

ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼š
- `query()` - æŸ¥è¯¢ç”¨æˆ·æ•°æ®
- `insert()` - æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨æ·»åŠ user_idï¼‰
- `update()` - æ›´æ–°æ•°æ®ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
- `delete()` - åˆ é™¤æ•°æ®ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
- `checkOwnership()` - æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ
- `countUserResources()` - ç»Ÿè®¡ç”¨æˆ·èµ„æºæ•°é‡

### 5. é…é¢ç®¡ç†æœåŠ¡
**æ–‡ä»¶ï¼š** `server/src/services/QuotaService.ts`

åŠŸèƒ½ï¼š
- å®šä¹‰ä¸åŒå¥—é¤çš„é…é¢ï¼ˆfree/basic/pro/enterpriseï¼‰
- è·å–ç”¨æˆ·å½“å‰å¥—é¤
- è·å–ç”¨æˆ·é…é¢å’Œä½¿ç”¨é‡
- æ£€æŸ¥æ˜¯å¦è¶…å‡ºé…é¢
- ç”Ÿæˆé…é¢ä½¿ç”¨æ‘˜è¦

### 6. é…é¢æ£€æŸ¥ä¸­é—´ä»¶
**æ–‡ä»¶ï¼š** `server/src/middleware/checkQuotaMiddleware.ts`

åœ¨åˆ›å»ºèµ„æºå‰è‡ªåŠ¨æ£€æŸ¥é…é¢ï¼š
```typescript
router.post('/albums', 
  requireTenantContext,
  checkQuota('albums'),
  async (req, res) => { ... }
);
```

### 7. é…é¢ç®¡ç†API
**æ–‡ä»¶ï¼š** `server/src/routes/quota.ts`

æä¾›APIæ¥å£ï¼š
- `GET /api/quota` - è·å–é…é¢ä½¿ç”¨æƒ…å†µ
- `GET /api/quota/check/:resourceType` - æ£€æŸ¥ç‰¹å®šèµ„æºé…é¢
- `GET /api/quota/plan` - è·å–å¥—é¤ä¿¡æ¯

### 8. è·¯ç”±ä¿®æ”¹ç¤ºä¾‹
**æ–‡ä»¶ï¼š** `server/src/routes/albums-multi-tenant-example.ts`

å®Œæ•´çš„å¤šç§Ÿæˆ·è·¯ç”±ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ï¼š
- æŸ¥è¯¢ç”¨æˆ·è‡ªå·±çš„æ•°æ®
- åˆ›å»ºèµ„æºæ—¶å…³è”ç”¨æˆ·
- æ›´æ–°/åˆ é™¤æ—¶éªŒè¯æ‰€æœ‰æƒ

### 9. å®æ–½æŒ‡å—
**æ–‡ä»¶ï¼š** `MULTI_TENANCY_IMPLEMENTATION_GUIDE.md`

è¯¦ç»†çš„å®æ–½æ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- é—®é¢˜åˆ†æ
- å®æ–½æ­¥éª¤
- ä»£ç ç¤ºä¾‹
- æµ‹è¯•æ¸…å•
- æœ€ä½³å®è·µ
- å¸¸è§é—®é¢˜

### 10. è‡ªåŠ¨åŒ–å®æ–½è„šæœ¬
**æ–‡ä»¶ï¼š** `implement-multi-tenancy.sh`

ä¸€é”®æ‰§è¡Œï¼š
- æ•°æ®åº“å¤‡ä»½
- æ‰§è¡Œè¿ç§»
- éªŒè¯ç»“æœ

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### æ•°æ®éš”ç¦»
- âœ… æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç©ºé—´
- âœ… ç”¨æˆ·ä¹‹é—´æ•°æ®å®Œå…¨éš”ç¦»
- âœ… è‡ªåŠ¨éªŒè¯èµ„æºæ‰€æœ‰æƒ
- âœ… é˜²æ­¢è·¨ç”¨æˆ·æ•°æ®è®¿é—®

### é…é¢ç®¡ç†
- âœ… 4ä¸ªå¥—é¤ç­‰çº§ï¼ˆfree/basic/pro/enterpriseï¼‰
- âœ… å¤šç»´åº¦é…é¢æ§åˆ¶ï¼ˆç›¸å†Œã€æ–‡ç« ã€çŸ¥è¯†åº“ã€å­˜å‚¨ç­‰ï¼‰
- âœ… å®æ—¶é…é¢æ£€æŸ¥
- âœ… é…é¢ä½¿ç”¨ç»Ÿè®¡

### å®‰å…¨æ€§
- âœ… ä»JWT tokenæå–ç”¨æˆ·IDï¼ˆä¸ä¿¡ä»»å‰ç«¯ï¼‰
- âœ… æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢åŒ…å«user_idè¿‡æ»¤
- âœ… èµ„æºæ‰€æœ‰æƒéªŒè¯
- âœ… ç®¡ç†å‘˜ç‰¹æƒæ”¯æŒ

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¿…é¡»å®Œæˆï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   ./implement-multi-tenancy.sh
   ```

2. **æ›´æ–°è®¤è¯ä¸­é—´ä»¶**
   åœ¨ `server/src/index.ts` ä¸­æ·»åŠ ï¼š
   ```typescript
   import { setTenantContext } from './middleware/tenantContext';
   app.use(authenticateToken);
   app.use(setTenantContext);
   ```

3. **ä¿®æ”¹æ ¸å¿ƒè·¯ç”±**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
   - [ ] `server/src/routes/gallery.ts` - ç›¸å†Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
   - [ ] `server/src/routes/article.ts` - æ–‡ç« ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
   - [ ] `server/src/routes/knowledgeBase.ts` - çŸ¥è¯†åº“ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
   - [ ] `server/src/routes/articleGeneration.ts` - æ–‡ç« ç”Ÿæˆ
   - [ ] `server/src/routes/distillation.ts` - å…³é”®è¯è’¸é¦
   - [ ] `server/src/routes/conversionTarget.ts` - è½¬åŒ–ç›®æ ‡
   - [ ] `server/src/routes/articleSettings.ts` - æ–‡ç« è®¾ç½®
   - [ ] `server/src/routes/platformAccounts.ts` - å¹³å°è´¦å·
   - [ ] `server/src/routes/config.ts` - APIé…ç½®

4. **æ›´æ–°æœåŠ¡å±‚**
   æ‰€æœ‰æœåŠ¡æ–¹æ³•æ·»åŠ  `userId` å‚æ•°

5. **æ·»åŠ é…é¢è·¯ç”±**
   åœ¨ `server/src/index.ts` ä¸­ï¼š
   ```typescript
   import quotaRouter from './routes/quota';
   app.use('/api/quota', quotaRouter);
   ```

### å¯é€‰åŠŸèƒ½ï¼ˆå¢å¼ºä½“éªŒï¼‰

6. **å‰ç«¯é…é¢æ˜¾ç¤º**
   - åœ¨ä»ªè¡¨æ¿æ˜¾ç¤ºé…é¢ä½¿ç”¨æƒ…å†µ
   - åˆ›å»ºèµ„æºå‰æç¤ºé…é¢é™åˆ¶
   - é…é¢ä¸è¶³æ—¶å¼•å¯¼å‡çº§

7. **æ•°æ®è¿ç§»å·¥å…·**
   - å°†ç°æœ‰æ•°æ®åˆ†é…ç»™ä¸åŒç”¨æˆ·
   - æ‰¹é‡å¯¼å…¥/å¯¼å‡ºç”¨æˆ·æ•°æ®

8. **ç®¡ç†å‘˜åŠŸèƒ½å¢å¼º**
   - æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æ•°æ®
   - è°ƒæ•´ç”¨æˆ·é…é¢
   - æ•°æ®ç»Ÿè®¡å’Œåˆ†æ

## ğŸ” æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
```typescript
// æµ‹è¯•æ•°æ®éš”ç¦»
describe('Multi-tenancy', () => {
  it('ç”¨æˆ·Aæ— æ³•è®¿é—®ç”¨æˆ·Bçš„ç›¸å†Œ', async () => {
    // æµ‹è¯•ä»£ç 
  });
  
  it('åˆ›å»ºèµ„æºæ—¶è‡ªåŠ¨å…³è”ç”¨æˆ·', async () => {
    // æµ‹è¯•ä»£ç 
  });
});
```

### é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·æ³¨å†Œååˆ›å»ºèµ„æº
- [ ] ç”¨æˆ·ç™»å½•ååªçœ‹åˆ°è‡ªå·±çš„æ•°æ®
- [ ] é…é¢é™åˆ¶æ­£å¸¸å·¥ä½œ
- [ ] ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®

### æ‰‹åŠ¨æµ‹è¯•
1. åˆ›å»ºä¸¤ä¸ªæµ‹è¯•ç”¨æˆ·
2. ç”¨æˆ·Aåˆ›å»ºç›¸å†Œã€æ–‡ç« 
3. ç”¨æˆ·Bç™»å½•ï¼Œç¡®è®¤çœ‹ä¸åˆ°ç”¨æˆ·Açš„æ•°æ®
4. æµ‹è¯•é…é¢é™åˆ¶
5. æµ‹è¯•å‡çº§å¥—é¤

## ğŸ“Š å¥—é¤é…é¢å®šä¹‰

| åŠŸèƒ½ | Free | Basic | Pro | Enterprise |
|------|------|-------|-----|------------|
| ç›¸å†Œ | 5 | 20 | 100 | æ— é™ |
| æ–‡ç«  | 50 | 200 | 1000 | æ— é™ |
| çŸ¥è¯†åº“ | 2 | 10 | 50 | æ— é™ |
| æ¯ç›¸å†Œå›¾ç‰‡ | 20 | 100 | 500 | æ— é™ |
| APIè°ƒç”¨/å¤© | 100 | 1000 | 10000 | æ— é™ |
| å­˜å‚¨ç©ºé—´ | 100MB | 1GB | 10GB | æ— é™ |

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. ä¿®æ”¹è·¯ç”±æ·»åŠ æ•°æ®éš”ç¦»

**ä¿®æ”¹å‰ï¼š**
```typescript
router.get('/albums', async (req, res) => {
  const result = await pool.query('SELECT * FROM albums');
  res.json(result.rows);
});
```

**ä¿®æ”¹åï¼š**
```typescript
router.get('/albums', requireTenantContext, async (req, res) => {
  const userId = getCurrentTenantId(req);
  const result = await pool.query(
    'SELECT * FROM albums WHERE user_id = $1',
    [userId]
  );
  res.json(result.rows);
});
```

### 2. æ·»åŠ é…é¢æ£€æŸ¥

```typescript
router.post('/albums', 
  requireTenantContext,
  checkQuota('albums'),  // è‡ªåŠ¨æ£€æŸ¥é…é¢
  async (req, res) => {
    const userId = getCurrentTenantId(req);
    // åˆ›å»ºç›¸å†Œé€»è¾‘
  }
);
```

### 3. å‰ç«¯æ˜¾ç¤ºé…é¢

```typescript
// è·å–é…é¢ä¿¡æ¯
const response = await fetch('/api/quota', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

const { data } = await response.json();
console.log(`ç›¸å†Œä½¿ç”¨: ${data.usage.albums}/${data.quotas.albums}`);
console.log(`ä½¿ç”¨ç‡: ${data.percentages.albums}%`);
```

## âš ï¸ é‡è¦æé†’

1. **å¤‡ä»½æ•°æ®åº“**
   æ‰§è¡Œè¿ç§»å‰åŠ¡å¿…å¤‡ä»½ï¼

2. **ç°æœ‰æ•°æ®å¤„ç†**
   è¿ç§»åæ‰€æœ‰ç°æœ‰æ•°æ®å…³è”åˆ°ç”¨æˆ·ID=1ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒæ•´

3. **çº§è”åˆ é™¤**
   åˆ é™¤ç”¨æˆ·ä¼šåˆ é™¤å…¶æ‰€æœ‰æ•°æ®ï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦è½¯åˆ é™¤

4. **æ€§èƒ½ä¼˜åŒ–**
   ç¡®ä¿æ‰€æœ‰ `user_id` å­—æ®µéƒ½æœ‰ç´¢å¼•

5. **å®‰å…¨æ€§**
   æ°¸è¿œä»JWT tokenæå–ç”¨æˆ·IDï¼Œä¸è¦ä¿¡ä»»å‰ç«¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®æ–½æŒ‡å—](./MULTI_TENANCY_IMPLEMENTATION_GUIDE.md) - è¯¦ç»†å®æ–½æ­¥éª¤
- [è·¯ç”±ç¤ºä¾‹](./server/src/routes/albums-multi-tenant-example.ts) - ä»£ç ç¤ºä¾‹
- [é…é¢æœåŠ¡](./server/src/services/QuotaService.ts) - é…é¢ç®¡ç†
- [ç§Ÿæˆ·æœåŠ¡](./server/src/services/TenantService.ts) - æ•°æ®éš”ç¦»

## ğŸ‰ é¢„æœŸæ•ˆæœ

å®æ–½å®Œæˆåï¼š
- âœ… æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç©ºé—´
- âœ… å¯ä»¥æŒ‰ç”¨æˆ·é”€å”®ä¸åŒå¥—é¤
- âœ… è‡ªåŠ¨è¿›è¡Œé…é¢ç®¡ç†å’Œé™åˆ¶
- âœ… ä¸ºSaaSå•†ä¸šåŒ–åšå¥½å‡†å¤‡

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹å®æ–½å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ï¼** ğŸš€

æ‰§è¡Œå‘½ä»¤ï¼š
```bash
./implement-multi-tenancy.sh
```
