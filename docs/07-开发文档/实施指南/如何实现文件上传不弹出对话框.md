# ğŸ“ å¦‚ä½•å®ç°æ–‡ä»¶ä¸Šä¼ ä¸å¼¹å‡ºå¯¹è¯æ¡†

## ğŸ¯ æ ¸å¿ƒåŸç†

ä½¿ç”¨ Playwright çš„ `fileChooser` äº‹ä»¶æ¥æ‹¦æˆªæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼Œåœ¨å¯¹è¯æ¡†æ˜¾ç¤ºä¹‹å‰è‡ªåŠ¨è®¾ç½®æ–‡ä»¶ã€‚

---

## ğŸ’¡ å®ç°æ–¹å¼

### æ–¹æ³• 1ï¼šä½¿ç”¨ fileChooser äº‹ä»¶ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** ç‚¹å‡»æŒ‰é’®ä¼šè§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†

```typescript
// ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ–‡ä»¶è·¯å¾„
const imagePath = '/path/to/image.jpg';

// ç¬¬äºŒæ­¥ï¼šç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶ï¼ˆåœ¨ç‚¹å‡»ä¹‹å‰è®¾ç½®ç›‘å¬ï¼‰
const fileChooserPromise = page.waitForEvent('filechooser');

// ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»è§¦å‘æ–‡ä»¶é€‰æ‹©çš„æŒ‰é’®
await page.getByRole('button', { name: 'ä¸Šä¼ å›¾æ–‡' }).click();

// ç¬¬å››æ­¥ï¼šæ‹¦æˆªæ–‡ä»¶é€‰æ‹©å™¨å¹¶è‡ªåŠ¨è®¾ç½®æ–‡ä»¶ï¼ˆå¯¹è¯æ¡†ä¸ä¼šæ˜¾ç¤ºï¼‰
const fileChooser = await fileChooserPromise;
await fileChooser.setFiles(imagePath);

// ç¬¬äº”æ­¥ï¼šç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ
await page.waitForTimeout(3000);
```

**å…³é”®ç‚¹ï¼š**
- âœ… å¿…é¡»åœ¨ç‚¹å‡»ä¹‹å‰è®¾ç½® `waitForEvent('filechooser')`
- âœ… ç‚¹å‡»åç«‹å³ç­‰å¾… `fileChooserPromise`
- âœ… ä½¿ç”¨ `fileChooser.setFiles()` è®¾ç½®æ–‡ä»¶
- âœ… å¯¹è¯æ¡†ä¸ä¼šæ˜¾ç¤ºç»™ç”¨æˆ·

---

### æ–¹æ³• 2ï¼šç›´æ¥è®¾ç½® input[type="file"]ï¼ˆå¤‡é€‰ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** é¡µé¢ä¸Šæœ‰éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶

```typescript
// ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ–‡ä»¶è·¯å¾„
const imagePath = '/path/to/image.jpg';

// ç¬¬äºŒæ­¥ï¼šæ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶
const fileInput = page.locator('input[type="file"]').first();

// ç¬¬ä¸‰æ­¥ï¼šç›´æ¥è®¾ç½®æ–‡ä»¶ï¼ˆä¸è§¦å‘å¯¹è¯æ¡†ï¼‰
await fileInput.setInputFiles(imagePath);

// ç¬¬å››æ­¥ï¼šç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ
await page.waitForTimeout(3000);
```

**å…³é”®ç‚¹ï¼š**
- âœ… ä¸éœ€è¦ç‚¹å‡»æŒ‰é’®
- âœ… ç›´æ¥æ“ä½œéšè—çš„ input å…ƒç´ 
- âœ… é€‚ç”¨äºå°çº¢ä¹¦ç­‰å¹³å°

---

## ğŸ” ä¸¤ç§æ–¹æ³•çš„åŒºåˆ«

| ç‰¹æ€§ | æ–¹æ³•1ï¼šfileChooser | æ–¹æ³•2ï¼šsetInputFiles |
|------|-------------------|---------------------|
| æ˜¯å¦éœ€è¦ç‚¹å‡»æŒ‰é’® | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ |
| æ˜¯å¦æ‹¦æˆªå¯¹è¯æ¡† | âœ… æ‹¦æˆª | âŒ ä¸è§¦å‘ |
| é€‚ç”¨åœºæ™¯ | ç‚¹å‡»æŒ‰é’®è§¦å‘ä¸Šä¼  | é¡µé¢æœ‰éšè—çš„ input |
| ä»£ç å¤æ‚åº¦ | ä¸­ç­‰ | ç®€å• |
| æ¨èåº¦ | â­â­â­â­â­ | â­â­â­â­ |

---

## ğŸ“ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæŠ–éŸ³å›¾æ–‡ä¸Šä¼ ï¼ˆä½¿ç”¨ fileChooserï¼‰

```typescript
// æŠ–éŸ³éœ€è¦ç‚¹å‡»"ä¸Šä¼ å›¾æ–‡"æŒ‰é’®æ‰èƒ½ä¸Šä¼ 
const imagePath = await this.prepareImage(article);

// ç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨
const fileChooserPromise = page.waitForEvent('filechooser');

// ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
await page.getByRole('button', { name: 'ä¸Šä¼ å›¾æ–‡' }).click();

// æ‹¦æˆªå¹¶è®¾ç½®æ–‡ä»¶
const fileChooser = await fileChooserPromise;
await fileChooser.setFiles(imagePath);

// ç­‰å¾…ä¸Šä¼ å®Œæˆ
await page.waitForTimeout(5000);
```

### æ¡ˆä¾‹ 2ï¼šå°çº¢ä¹¦ç¬”è®°ä¸Šä¼ ï¼ˆä½¿ç”¨ setInputFilesï¼‰

```typescript
// å°çº¢ä¹¦é¡µé¢ä¸Šæœ‰éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶
const imagePath = this.resolveImagePath(firstImage);

// ç›´æ¥è®¾ç½®æ–‡ä»¶
const fileInput = page.locator('input[type="file"]').first();
await fileInput.setInputFiles(imagePath);

// ç­‰å¾…ä¸Šä¼ å®Œæˆ
await page.waitForTimeout(3000);
```

---

## ğŸ“ ä¸‹æ¬¡ä½ è¯¥å¦‚ä½•æè¿°

### åœºæ™¯ 1ï¼šç‚¹å‡»æŒ‰é’®è§¦å‘ä¸Šä¼ 

**ä½ å¯ä»¥è¿™æ ·è¯´ï¼š**

> "ä½¿ç”¨ Playwright çš„ fileChooser äº‹ä»¶æ‹¦æˆªæ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†ã€‚åœ¨ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ä¹‹å‰ï¼Œå…ˆç›‘å¬ filechooser äº‹ä»¶ï¼Œç„¶åç‚¹å‡»æŒ‰é’®ï¼Œæœ€åç”¨ fileChooser.setFiles() è‡ªåŠ¨è®¾ç½®æ–‡ä»¶ï¼Œè¿™æ ·å¯¹è¯æ¡†å°±ä¸ä¼šå¼¹å‡ºã€‚"

**æˆ–è€…ç®€çŸ­ç‰ˆï¼š**

> "ç”¨ fileChooser äº‹ä»¶æ‹¦æˆªæ–‡ä»¶ä¸Šä¼ ï¼Œä¸å¼¹å‡ºå¯¹è¯æ¡†ã€‚"

**æˆ–è€…æ›´ç®€å•ï¼š**

> "å‚ç…§æŠ–éŸ³çš„æ–‡ä»¶ä¸Šä¼ æ–¹å¼ï¼Œä½¿ç”¨ fileChooser æ‹¦æˆªã€‚"

---

### åœºæ™¯ 2ï¼šç›´æ¥è®¾ç½®éšè—çš„ input

**ä½ å¯ä»¥è¿™æ ·è¯´ï¼š**

> "ç›´æ¥æ‰¾åˆ°é¡µé¢ä¸Šçš„ input[type='file'] å…ƒç´ ï¼Œç”¨ setInputFiles() è®¾ç½®æ–‡ä»¶ï¼Œä¸è§¦å‘å¯¹è¯æ¡†ã€‚"

**æˆ–è€…ç®€çŸ­ç‰ˆï¼š**

> "ç›´æ¥è®¾ç½® input[type='file']ï¼Œä¸å¼¹å‡ºå¯¹è¯æ¡†ã€‚"

**æˆ–è€…æ›´ç®€å•ï¼š**

> "å‚ç…§å°çº¢ä¹¦çš„æ–‡ä»¶ä¸Šä¼ æ–¹å¼ï¼Œç›´æ¥è®¾ç½® inputã€‚"

---

## ğŸ”§ å®Œæ•´ä»£ç æ¨¡æ¿

### æ¨¡æ¿ 1ï¼šfileChooser æ–¹å¼

```typescript
/**
 * ä¸Šä¼ æ–‡ä»¶ï¼ˆä½¿ç”¨ fileChooser æ‹¦æˆªå¯¹è¯æ¡†ï¼‰
 */
private async uploadFile(page: Page, filePath: string): Promise<void> {
  try {
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(filePath)) {
      throw new Error(`æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
    }

    await this.log('info', 'å‡†å¤‡ä¸Šä¼ æ–‡ä»¶', { path: filePath });

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶
    const fileChooserPromise = page.waitForEvent('filechooser');

    // ç‚¹å‡»è§¦å‘ä¸Šä¼ çš„æŒ‰é’®
    await page.getByRole('button', { name: 'ä¸Šä¼ ' }).click();

    // æ‹¦æˆªæ–‡ä»¶é€‰æ‹©å™¨å¹¶è®¾ç½®æ–‡ä»¶
    const fileChooser = await fileChooserPromise;
    await fileChooser.setFiles(filePath);

    await this.log('info', 'æ–‡ä»¶å·²è®¾ç½®ï¼Œç­‰å¾…ä¸Šä¼ å®Œæˆ...');

    // ç­‰å¾…ä¸Šä¼ å®Œæˆ
    await page.waitForTimeout(5000);

    await this.log('info', 'âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ');
  } catch (error: any) {
    await this.log('error', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', { error: error.message });
    throw error;
  }
}
```

### æ¨¡æ¿ 2ï¼šsetInputFiles æ–¹å¼

```typescript
/**
 * ä¸Šä¼ æ–‡ä»¶ï¼ˆç›´æ¥è®¾ç½® input å…ƒç´ ï¼‰
 */
private async uploadFile(page: Page, filePath: string): Promise<void> {
  try {
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(filePath)) {
      throw new Error(`æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
    }

    await this.log('info', 'å‡†å¤‡ä¸Šä¼ æ–‡ä»¶', { path: filePath });

    // æ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶
    const fileInput = page.locator('input[type="file"]').first();

    // ç›´æ¥è®¾ç½®æ–‡ä»¶
    await fileInput.setInputFiles(filePath);

    await this.log('info', 'æ–‡ä»¶å·²è®¾ç½®ï¼Œç­‰å¾…ä¸Šä¼ å®Œæˆ...');

    // ç­‰å¾…ä¸Šä¼ å®Œæˆ
    await page.waitForTimeout(3000);

    await this.log('info', 'âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ');
  } catch (error: any) {
    await this.log('error', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', { error: error.message });
    throw error;
  }
}
```

---

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### 1. fileChooser æ–¹å¼ï¼ˆæŠ–éŸ³ï¼‰

**æ ¸å¿ƒæ­¥éª¤ï¼š**
1. å‡†å¤‡æ–‡ä»¶è·¯å¾„
2. ç›‘å¬ `filechooser` äº‹ä»¶
3. ç‚¹å‡»è§¦å‘ä¸Šä¼ çš„æŒ‰é’®
4. æ‹¦æˆªå¹¶è®¾ç½®æ–‡ä»¶
5. ç­‰å¾…ä¸Šä¼ å®Œæˆ

**å…³é”®ä»£ç ï¼š**
```typescript
const fileChooserPromise = page.waitForEvent('filechooser');
await page.click('ä¸Šä¼ æŒ‰é’®');
const fileChooser = await fileChooserPromise;
await fileChooser.setFiles(filePath);
```

### 2. setInputFiles æ–¹å¼ï¼ˆå°çº¢ä¹¦ï¼‰

**æ ¸å¿ƒæ­¥éª¤ï¼š**
1. å‡†å¤‡æ–‡ä»¶è·¯å¾„
2. æ‰¾åˆ° `input[type="file"]` å…ƒç´ 
3. ç›´æ¥è®¾ç½®æ–‡ä»¶
4. ç­‰å¾…ä¸Šä¼ å®Œæˆ

**å…³é”®ä»£ç ï¼š**
```typescript
const fileInput = page.locator('input[type="file"]').first();
await fileInput.setInputFiles(filePath);
```

---

## ğŸ’¬ ä¸‹æ¬¡æ²Ÿé€šçš„æ ‡å‡†è¯æœ¯

### ç®€çŸ­ç‰ˆï¼ˆæ¨èï¼‰

> "æ–‡ä»¶ä¸Šä¼ ä¸å¼¹å‡ºå¯¹è¯æ¡†ï¼Œç”¨ fileChooser æ‹¦æˆªã€‚"

### è¯¦ç»†ç‰ˆ

> "åœ¨ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ä¹‹å‰ï¼Œå…ˆç”¨ page.waitForEvent('filechooser') ç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶ï¼Œç„¶åç‚¹å‡»æŒ‰é’®ï¼Œæœ€åç”¨ fileChooser.setFiles() è®¾ç½®æ–‡ä»¶ï¼Œè¿™æ ·å¯¹è¯æ¡†å°±ä¸ä¼šå¼¹å‡ºã€‚"

### å‚è€ƒç‰ˆ

> "å‚ç…§æŠ–éŸ³é€‚é…å™¨çš„æ–‡ä»¶ä¸Šä¼ æ–¹å¼ã€‚"

æˆ–

> "å‚ç…§å°çº¢ä¹¦é€‚é…å™¨çš„æ–‡ä»¶ä¸Šä¼ æ–¹å¼ã€‚"

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šå¯¹è¯æ¡†è¿˜æ˜¯å¼¹å‡ºäº†

**åŸå› ï¼š** ç›‘å¬äº‹ä»¶çš„æ—¶æœºä¸å¯¹

**è§£å†³ï¼š** ç¡®ä¿åœ¨ç‚¹å‡»ä¹‹å‰å°±è®¾ç½®å¥½ç›‘å¬
```typescript
// âŒ é”™è¯¯ï¼šå…ˆç‚¹å‡»å†ç›‘å¬
await page.click('ä¸Šä¼ æŒ‰é’®');
const fileChooserPromise = page.waitForEvent('filechooser');

// âœ… æ­£ç¡®ï¼šå…ˆç›‘å¬å†ç‚¹å‡»
const fileChooserPromise = page.waitForEvent('filechooser');
await page.click('ä¸Šä¼ æŒ‰é’®');
```

### é—®é¢˜ 2ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶

**åŸå› ï¼š** é€‰æ‹©å™¨ä¸æ­£ç¡®

**è§£å†³ï¼š** å°è¯•ä¸åŒçš„é€‰æ‹©å™¨
```typescript
// æ–¹å¼1ï¼šç¬¬ä¸€ä¸ª file input
page.locator('input[type="file"]').first()

// æ–¹å¼2ï¼šæ‰€æœ‰ file input
page.locator('input[type="file"]')

// æ–¹å¼3ï¼šå¸¦ accept å±æ€§çš„
page.locator('input[type="file"][accept*="image"]')
```

### é—®é¢˜ 3ï¼šæ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ

**åŸå› ï¼š** æ–‡ä»¶ç±»å‹ä¸åŒ¹é… accept å±æ€§

**è§£å†³ï¼š** æ£€æŸ¥ accept å±æ€§ï¼Œç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®
```typescript
// æ£€æŸ¥ accept å±æ€§
const accept = await fileInput.getAttribute('accept');
console.log('æ¥å—çš„æ–‡ä»¶ç±»å‹:', accept);
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Playwright FileChooser æ–‡æ¡£](https://playwright.dev/docs/api/class-filechooser)
- [Playwright Input æ–‡æ¡£](https://playwright.dev/docs/input)
- [æŠ–éŸ³é€‚é…å™¨æºç ](./server/src/services/adapters/DouyinAdapter.ts)
- [å°çº¢ä¹¦é€‚é…å™¨æºç ](./server/src/services/adapters/XiaohongshuAdapter.ts)

---

## âœ… å¿«é€Ÿå‚è€ƒ

**ä¸‹æ¬¡ä½ åªéœ€è¦è¯´ï¼š**

1. "ç”¨ fileChooser æ‹¦æˆªæ–‡ä»¶ä¸Šä¼ "
2. "å‚ç…§æŠ–éŸ³çš„ä¸Šä¼ æ–¹å¼"
3. "ä¸å¼¹å‡ºå¯¹è¯æ¡†ä¸Šä¼ æ–‡ä»¶"
4. "ä½¿ç”¨ Playwright çš„ fileChooser äº‹ä»¶"

æˆ‘å°±çŸ¥é“ä½ è¦å®ç°ä»€ä¹ˆäº†ï¼ğŸ‰
