# 微信支付测试 - 完整流程

## 问题说明

支付完成后页面没有跳转，控制台显示：
```
GET http://localhost:3000/api/orders/xxx/status net::ERR_CONNECTION_REFUSED
```

**原因：** 通过 ngrok 公网地址访问 landing 页面时，前端无法访问 `localhost:3000` 的后端 API。

## 解决方案

### 方案1：通过 ngrok 访问（推荐 - 用于微信扫码支付）

#### 步骤1：构建 landing 页面

```bash
cd landing
npm run build
cd ..
```

#### 步骤2：确保 ngrok 正在运行

```bash
# 检查 ngrok 状态
ps aux | grep ngrok

# 如果没有运行，启动 ngrok
ngrok http 3000
```

#### 步骤3：获取 ngrok 地址

访问 http://localhost:4040 或运行：
```bash
curl -s http://localhost:4040/api/tunnels | python3 -m json.tool
```

你的 ngrok 地址：`https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev`

#### 步骤4：更新微信支付回调地址

编辑 `server/.env`：
```env
WECHAT_PAY_NOTIFY_URL=https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/payment/wechat/notify
```

#### 步骤5：重启后端服务

```bash
# 停止现有服务
pkill -f "node.*server"

# 重新启动
cd server
npm run dev
```

#### 步骤6：测试支付

1. 通过 ngrok 地址访问：`https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev`
2. 点击套餐购买
3. 使用微信扫码支付
4. 支付完成后，页面应该自动跳转

### 方案2：本地测试（不需要微信扫码）

如果只是测试前端逻辑，不需要真实支付：

```bash
# 直接访问本地地址
open http://localhost:8080
```

## 技术说明

### 前端配置更新

`landing/src/config/env.ts` 现在支持自动检测 ngrok 环境：

```typescript
// ngrok 环境配置
ngrok: {
  apiUrl: `${window.location.protocol}//${window.location.host}/api`,
  clientUrl: 'http://localhost:5173',
  environment: 'ngrok'
}
```

### 后端配置更新

`server/src/index.ts` 现在提供 landing 静态文件服务：

```typescript
// 提供 landing 页面静态文件（用于 ngrok 访问）
const landingDistPath = path.join(__dirname, '../../landing/dist');
if (require('fs').existsSync(landingDistPath)) {
  app.use(express.static(landingDistPath));
}
```

## 验证步骤

### 1. 检查前端配置

打开浏览器控制台，应该看到：
```
[Landing Config] 环境: {
  isNgrok: true,
  apiUrl: "https://xxx.ngrok-free.dev/api"
}
```

### 2. 检查后端连接

在浏览器中访问：
```
https://your-ngrok-url.ngrok-free.dev/api/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "..."
}
```

### 3. 测试支付流程

1. 访问 ngrok 地址
2. 登录账号
3. 选择套餐
4. 生成二维码
5. 微信扫码支付
6. 等待页面自动跳转

## 常见问题

### Q1: ngrok 地址访问显示 "Tunnel not found"

**解决：** 重启 ngrok
```bash
pkill -f ngrok
ngrok http 3000
```

### Q2: 支付后仍然没有跳转

**检查：**
1. 浏览器控制台是否有错误
2. 后端日志是否收到支付回调
3. 订单状态是否更新为 "paid"

```bash
# 查看后端日志
cd server
npm run dev
```

### Q3: 前端显示 CORS 错误

**检查：** `server/.env` 中的 `ALLOWED_ORIGINS` 是否包含 ngrok 域名

```env
ALLOWED_ORIGINS=http://localhost,http://localhost:5173,https://your-ngrok-url.ngrok-free.dev
```

## 下一步

支付测试成功后：

1. ✅ 验证订单状态更新
2. ✅ 验证订阅激活
3. ✅ 验证用户权限
4. ✅ 测试套餐升级功能

## 快速命令

```bash
# 一键启动测试环境
cd landing && npm run build && cd ..
cd server && npm run dev

# 在另一个终端
ngrok http 3000

# 获取 ngrok 地址
curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*ngrok[^"]*'
```
