# ✅ 微信支付配置完成

## 配置状态

### ✅ 已完成的配置

1. **AppID**: `wx_your_app_id_here`
2. **商户号**: `your_merchant_id`
3. **APIv3密钥**: 已配置
4. **证书序列号**: `your_certificate_serial_number_here`
5. **私钥文件**: `/Users/lzc/.wechat-pay/apiclient_key.pem` ✅ 已验证
6. **回调地址**: `http://localhost:3000/api/payment/wechat/notify` ⚠️ 临时地址

### ⚠️ 注意事项

**回调地址使用HTTP（临时）**：
- 当前使用 `http://localhost:3000` 仅用于本地测试
- 微信支付要求回调地址必须使用 HTTPS
- 实际支付时需要使用 ngrok 提供的 HTTPS 地址

---

## 当前可以做什么

### ✅ 可以测试的功能

1. **创建订单**：
   - 访问 http://localhost:8080
   - 点击任意套餐的"点击购买"按钮
   - 应该能成功创建订单并显示二维码

2. **查看订单**：
   - 在后台管理系统查看订单列表
   - 订单状态应该是"待支付"

### ❌ 暂时无法完成的功能

1. **实际支付**：
   - 微信扫码后无法完成支付
   - 因为回调地址是 localhost，微信服务器无法访问

2. **支付回调**：
   - 支付成功后无法收到回调通知
   - 订单状态不会自动更新

---

## 下一步：配置ngrok（可选）

如果你想测试完整的支付流程，需要配置 ngrok：

### 1. 安装ngrok

```bash
brew install ngrok
```

或访问 https://ngrok.com 下载

### 2. 注册并配置

```bash
# 访问 https://ngrok.com 注册账号
# 获取 authtoken

# 配置 token
ngrok config add-authtoken 你的token
```

### 3. 启动ngrok

```bash
ngrok http 3000
```

会显示类似：
```
Forwarding: https://abc123.ngrok.io -> http://localhost:3000
```

### 4. 更新回调地址

编辑 `.env` 文件（根目录），修改：

```env
WECHAT_PAY_NOTIFY_URL=https://abc123.ngrok.io/api/payment/wechat/notify
```

### 5. 重启服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
cd server
npm run dev
```

### 6. 测试支付

现在可以用微信扫码支付，支付成功后会自动：
- 更新订单状态
- 开通订阅
- 分配配额

---

## 服务器启动日志

启动服务器后，应该看到：

```
✅ 微信支付初始化成功
```

如果看到警告：
```
⚠️ 回调 URL 必须使用 HTTPS 协议
```

这是正常的，因为我们使用的是 localhost。配置 ngrok 后这个警告会消失。

---

## 测试步骤

### 测试1：创建订单

1. 确保所有服务运行：
   ```bash
   # 终端1：后端
   cd server && npm run dev
   
   # 终端2：营销网站
   cd landing && npm run dev
   
   # 终端3：客户端
   cd client && npm run dev
   ```

2. 访问 http://localhost:8080

3. 登录账号（lzc2005）

4. 滚动到"价格方案"

5. 点击"专业版"的"点击购买"

6. 应该弹出支付弹窗，显示二维码

### 测试2：查看订单

1. 访问 http://localhost:5173

2. 登录后台管理系统

3. 查看订单列表

4. 应该能看到刚才创建的订单

---

## 文件位置

### 配置文件

- **环境变量**: `.env` (根目录)
- **私钥文件**: `~/.wechat-pay/apiclient_key.pem`
- **证书文件**: `~/Desktop/your_merchant_id_20251229_cert/`

### 文档文件

- **快速设置**: `QUICK_SETUP_WECHAT_PAY.md`
- **完整指南**: `WECHAT_PAY_SETUP_GUIDE.md`
- **故障排除**: `WECHAT_PAY_TROUBLESHOOTING.md`
- **私钥下载**: `HOW_TO_GET_PRIVATE_KEY.md`
- **你的配置**: `YOUR_WECHAT_PAY_CONFIG.md`

---

## 常见问题

### Q1：点击购买后显示"创建订单失败"

**可能原因**：
1. 服务器没有启动
2. 环境变量没有正确加载
3. 私钥文件路径不对

**解决方案**：
```bash
# 检查服务器日志
# 应该看到"微信支付初始化成功"

# 如果看到错误，检查 .env 文件
cat .env | grep WECHAT_PAY

# 检查私钥文件
cat ~/.wechat-pay/apiclient_key.pem
```

### Q2：二维码显示但扫码后无法支付

**原因**：回调地址是 localhost，微信服务器无法访问

**解决方案**：配置 ngrok（见上面的步骤）

### Q3：支付成功但订单状态没有更新

**原因**：回调地址不正确或服务器没有收到回调

**解决方案**：
1. 确保使用 ngrok 的 HTTPS 地址
2. 确保服务器在运行
3. 查看服务器日志是否收到回调

---

## 技术细节

### 微信支付初始化

代码位置：`server/src/services/PaymentService.ts`

初始化时会：
1. 读取环境变量
2. 验证配置完整性
3. 检查私钥文件是否存在
4. 创建微信支付客户端

### 订单创建流程

1. 用户点击"购买"按钮
2. 前端调用 `/api/orders/create` API
3. 后端创建订单记录
4. 调用微信支付 API 创建预支付订单
5. 返回二维码 URL
6. 前端显示二维码

### 支付回调流程

1. 用户扫码支付
2. 微信服务器发送回调到 `WECHAT_PAY_NOTIFY_URL`
3. 后端验证回调签名
4. 更新订单状态为"已支付"
5. 创建用户订阅
6. 分配配额
7. 通过 WebSocket 通知前端

---

## 安全提示

1. **私钥文件**：
   - 已保存在 `~/.wechat-pay/apiclient_key.pem`
   - 权限设置为 600（只有你能读取）
   - 不要分享给任何人
   - 不要上传到 Git

2. **API密钥**：
   - 已保存在 `.env` 文件
   - `.env` 文件已在 `.gitignore` 中
   - 不要提交到版本控制

3. **证书备份**：
   - 原始证书在 `~/Desktop/your_merchant_id_20251229_cert/`
   - 建议备份到安全位置
   - 可以删除桌面上的文件夹

---

**配置完成时间**: 2024年12月29日  
**配置状态**: ✅ 基础配置完成，可以创建订单  
**下一步**: 配置 ngrok 以测试完整支付流程（可选）

