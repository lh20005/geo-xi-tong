# 🚀 完整测试流程

## 当前状态

✅ **已完成**：
- ngrok 已安装
- 微信支付配置已完成
- 所有服务正在运行：
  - 后端服务器：http://localhost:3000
  - 营销网站：http://localhost:8080
  - 客户端：http://localhost:5173

⏳ **待完成**：
- 配置 ngrok authtoken
- 启动 ngrok
- 更新回调地址

---

## 第一步：获取 ngrok authtoken

### 1. 访问 ngrok 网站

打开浏览器：https://ngrok.com

### 2. 注册/登录

- 点击 "Sign up" 注册（或 "Log in" 登录）
- 推荐使用 Google 账号快速注册

### 3. 获取 authtoken

登录后：
- 左侧菜单点击 "Your Authtoken"
- 或访问：https://dashboard.ngrok.com/get-started/your-authtoken
- 复制显示的 token（类似：`2abc123def456...`）

### 4. 配置 authtoken

在终端执行：

```bash
ngrok config add-authtoken 你的token
```

例如：
```bash
ngrok config add-authtoken 2abc123def456ghi789jkl012mno345pqr678stu901vwx234yz
```

---

## 第二步：启动 ngrok

打开一个新的终端窗口，执行：

```bash
ngrok http 3000
```

**会显示类似内容**：

```
ngrok

Session Status                online
Account                       你的邮箱
Version                       3.x.x
Region                        United States (us)
Latency                       50ms
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://abc123.ngrok.io -> http://localhost:3000

Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

**重要**：记下 `Forwarding` 那一行的 HTTPS 地址！

例如：`https://abc123.ngrok.io`

---

## 第三步：更新回调地址

### 方法1：手动编辑（推荐）

编辑根目录的 `.env` 文件，找到这一行：

```env
WECHAT_PAY_NOTIFY_URL=http://localhost:3000/api/payment/wechat/notify
```

改成（替换成你的 ngrok 地址）：

```env
WECHAT_PAY_NOTIFY_URL=https://abc123.ngrok.io/api/payment/wechat/notify
```

### 方法2：使用命令（快速）

在终端执行（替换成你的 ngrok 地址）：

```bash
# 备份原文件
cp .env .env.backup

# 更新回调地址（替换 abc123 为你的实际地址）
sed -i '' 's|WECHAT_PAY_NOTIFY_URL=.*|WECHAT_PAY_NOTIFY_URL=https://abc123.ngrok.io/api/payment/wechat/notify|' .env

# 验证
grep WECHAT_PAY_NOTIFY_URL .env
```

---

## 第四步：重启服务器

服务器需要重新加载环境变量。

### 方法1：使用 Kiro（推荐）

告诉我："重启服务器"，我会帮你重启。

### 方法2：手动重启

在运行服务器的终端：
1. 按 `Ctrl+C` 停止服务器
2. 执行：
   ```bash
   cd server
   npm run dev
   ```

**检查日志**：

应该看到：
```
✅ 微信支付初始化成功
```

如果还看到 HTTPS 警告，说明回调地址没有更新成功。

---

## 第五步：测试支付

### 1. 访问营销网站

打开浏览器：http://localhost:8080

### 2. 登录

- 用户名：`lzc2005`
- 密码：你的密码

### 3. 购买套餐

1. 滚动到"价格方案"部分
2. 点击任意套餐的"点击购买"按钮
3. 应该弹出支付弹窗，显示二维码

### 4. 扫码支付

1. 用微信扫描二维码
2. 支付 0.01 元（测试金额）
3. 确认支付

### 5. 验证结果

**预期结果**：
- ✅ 支付成功
- ✅ 页面自动跳转或显示成功提示
- ✅ 订单状态更新为"已支付"
- ✅ 订阅自动开通
- ✅ 配额自动分配

**查看订单**：
1. 访问：http://localhost:5173
2. 登录后台管理系统
3. 点击"订单管理"
4. 查看订单状态

---

## 第六步：查看 ngrok 日志

在 ngrok 终端窗口，你可以看到：

```
HTTP Requests
-------------

POST /api/payment/wechat/notify    200 OK
```

这说明微信支付成功回调了！

你也可以访问：http://127.0.0.1:4040

这是 ngrok 的 Web 界面，可以看到所有请求的详细信息。

---

## 故障排除

### 问题1：ngrok 显示 "ERR_NGROK_108"

**原因**：authtoken 无效或未配置

**解决方案**：
```bash
ngrok config add-authtoken 你的正确token
```

### 问题2：支付后没有回调

**检查清单**：
- [ ] ngrok 是否在运行
- [ ] ngrok 地址是否正确
- [ ] .env 中的回调地址是否更新
- [ ] 服务器是否重启
- [ ] 服务器日志是否有错误

**查看 ngrok 日志**：
- 在 ngrok 终端查看是否收到请求
- 访问 http://127.0.0.1:4040 查看详细日志

### 问题3：服务器日志显示 HTTPS 警告

**原因**：回调地址还是 localhost

**解决方案**：
```bash
# 检查配置
grep WECHAT_PAY_NOTIFY_URL .env

# 应该显示 ngrok 的 HTTPS 地址
# 如果不是，重新编辑 .env 文件
```

### 问题4：ngrok 地址变了

**原因**：免费版 ngrok 每次重启地址会变

**解决方案**：
1. 记下新的 ngrok 地址
2. 更新 .env 文件
3. 重启服务器

**避免频繁变化**：
- 保持 ngrok 一直运行
- 或升级到付费版（固定域名）

---

## 终端窗口管理

测试时需要保持这些终端窗口运行：

**终端1 - 后端服务器**：
```bash
cd server
npm run dev
```

**终端2 - ngrok**：
```bash
ngrok http 3000
```

**终端3 - 营销网站**：
```bash
cd landing
npm run dev
```

**终端4 - 客户端**：
```bash
cd client
npm run dev
```

---

## 测试完成后

### 停止服务

在每个终端按 `Ctrl+C` 停止服务。

### 清理（可选）

```bash
# 删除测试订单（如果需要）
# 在后台管理系统操作

# 保留 ngrok 配置
# authtoken 已保存，下次直接启动即可
```

---

## 下次测试

下次测试时，只需要：

1. 启动 ngrok：
   ```bash
   ngrok http 3000
   ```

2. 如果地址变了，更新 .env 并重启服务器

3. 开始测试

---

## 生产环境部署

测试成功后，部署到生产环境时：

1. **使用真实服务器**
   - 不需要 ngrok
   - 配置真实域名和 HTTPS

2. **更新回调地址**
   ```env
   WECHAT_PAY_NOTIFY_URL=https://你的域名.com/api/payment/wechat/notify
   ```

3. **在微信支付商户平台配置**
   - 登录商户平台
   - 配置支付回调域名

---

**创建时间**：2024年12月29日  
**当前进度**：等待配置 ngrok authtoken

**下一步**：
1. 获取 ngrok authtoken
2. 配置 authtoken
3. 启动 ngrok
4. 告诉我 ngrok 地址，我会帮你更新配置
