# 🧪 测试小红书自动发布

## 🚀 快速测试步骤

### 1. 重启服务器

```bash
cd server
npm run dev
```

**预期输出：**
```
✅ 注册平台适配器: 小红书 (xiaohongshu)
✅ 已注册 1 个平台适配器
服务器启动成功...
```

### 2. 准备测试数据

确保你有：
- ✅ 一篇文章（包含标题和内容）
- ✅ 文章中至少有一张图片
- ✅ 小红书账号的 Cookie

### 3. 创建发布任务

在前端系统中：
1. 选择一篇文章
2. 选择"小红书"平台
3. 点击"发布"

---

## 📋 测试场景

### 场景 1：完整发布流程

**测试内容：**
- 标题：自动填充文章标题
- 正文：自动填充文章内容（清理后）
- 图片：自动上传第一张图片

**预期结果：**
- ✅ 标题正确显示
- ✅ 正文正确显示（无 HTML 标签）
- ✅ 图片成功上传
- ✅ 发布成功

### 场景 2：长内容处理

**测试内容：**
- 文章内容超过 1000 字

**预期结果：**
- ✅ 内容自动截断为 997 字 + "..."
- ✅ 显示警告日志："内容超过1000字，已截断"

### 场景 3：无图片文章

**测试内容：**
- 文章中没有图片

**预期结果：**
- ✅ 显示警告："文章中没有找到图片"
- ✅ 继续发布（不影响流程）

### 场景 4：HTML 内容清理

**测试内容：**
```html
<p>这是一段文字</p>
<img src="image.jpg" />
<p>这是另一段文字</p>
```

**预期结果：**
```
这是一段文字
这是另一段文字
```
- ✅ HTML 标签已移除
- ✅ 图片标签已移除
- ✅ 段落格式保留

---

## 🔍 查看日志

### 成功日志示例

```
[小红书] 开始登录小红书
[小红书] 尝试使用 Cookie 登录
[小红书] Cookie 登录成功
[小红书] 开始发布小红书笔记 { title: '测试文章' }
[小红书] 点击发布笔记按钮
[小红书] 选择上传图文
[小红书] 找到 1 张图片，准备上传第一张
[小红书] 上传图片 { path: '/path/to/image.jpg' }
[小红书] 图片上传完成
[小红书] 填写标题 { title: '测试文章' }
[小红书] 填写正文内容
[小红书] 内容填写完成
[小红书] 点击发布按钮
[小红书] 发布成功（URL验证）
[小红书] ✅ 小红书笔记发布成功
```

### 错误日志示例

```
[小红书] 开始发布小红书笔记
[小红书] 点击发布笔记按钮
[小红书] 选择上传图文
[小红书] 图片文件不存在 { path: '/path/to/image.jpg' }
[小红书] 图片上传失败 { error: 'File not found' }
[小红书] 填写标题
[小红书] 填写正文内容
[小红书] 点击发布按钮
[小红书] 发布失败 { error: 'Element not found' }
[小红书] 已保存错误截图 { path: 'error-xiaohongshu-1234567890.png' }
```

---

## 🐛 常见问题排查

### 问题 1：Cookie 登录失败

**症状：**
```
[小红书] Cookie 登录失败，需要手动登录
```

**解决方法：**
1. 检查 Cookie 是否过期
2. 重新手动登录小红书
3. 保存新的 Cookie

### 问题 2：图片上传失败

**症状：**
```
[小红书] 图片文件不存在
```

**解决方法：**
1. 检查图片路径是否正确
2. 确认图片文件存在
3. 检查文件权限

### 问题 3：内容填写失败

**症状：**
```
[小红书] 填写内容失败
```

**解决方法：**
1. 检查选择器是否正确
2. 查看错误截图
3. 检查页面是否加载完成

### 问题 4：发布按钮点击失败

**症状：**
```
[小红书] 点击发布按钮失败
```

**解决方法：**
1. 检查是否所有必填项都已填写
2. 查看错误截图
3. 增加等待时间

---

## 📸 调试技巧

### 1. 查看错误截图

发布失败时会自动保存截图：
```
error-xiaohongshu-1234567890.png
```

打开截图查看：
- 当前页面状态
- 是否有错误提示
- 元素是否正确显示

### 2. 增加等待时间

如果页面加载慢，可以增加等待时间：

```typescript
// 在 XiaohongshuAdapter.ts 中
await page.waitForTimeout(3000); // 增加到 3 秒
```

### 3. 使用可视化模式

在开发环境中，可以看到浏览器操作：

```typescript
// 在 BrowserAutomationService.ts 中
const browser = await chromium.launch({
  headless: false, // 改为 false
});
```

### 4. 添加更多日志

在关键步骤添加日志：

```typescript
await this.log('info', '当前步骤', { detail: '详细信息' });
```

---

## ✅ 验证清单

### 启动验证
- [ ] 服务器启动成功
- [ ] 看到"注册平台适配器: 小红书"
- [ ] 没有错误信息

### 功能验证
- [ ] Cookie 登录成功
- [ ] 导航到发布页面
- [ ] 点击"发布笔记"成功
- [ ] 选择"上传图文"成功
- [ ] 图片上传成功
- [ ] 标题填写正确
- [ ] 正文填写正确
- [ ] 点击发布成功
- [ ] 验证发布结果成功

### 内容验证
- [ ] 标题与文章标题一致
- [ ] 正文无 HTML 标签
- [ ] 正文无图片语法
- [ ] 图片正确显示
- [ ] 长度限制生效

### 日志验证
- [ ] 每个步骤都有日志
- [ ] 错误有详细信息
- [ ] 成功有确认信息

---

## 🎯 测试用例

### 用例 1：标准文章

**输入：**
```
标题：装修公司现场照片分享
内容：
<p>今天去了装修现场，拍了一些照片。</p>
![照片1](uploads/images/photo1.jpg)
<p>整体效果很不错。</p>
![照片2](uploads/images/photo2.jpg)
```

**预期输出：**
```
标题：装修公司现场照片分享
内容：
今天去了装修现场，拍了一些照片。
整体效果很不错。

图片：photo1.jpg（已上传）
```

### 用例 2：长文章

**输入：**
```
标题：长文章测试
内容：1200 字的文章内容...
```

**预期输出：**
```
标题：长文章测试
内容：997 字 + "..."
警告：内容超过1000字，已截断
```

### 用例 3：无图片文章

**输入：**
```
标题：纯文字文章
内容：这是一篇纯文字文章，没有图片。
```

**预期输出：**
```
标题：纯文字文章
内容：这是一篇纯文字文章，没有图片。
警告：文章中没有找到图片
```

---

## 📊 性能指标

### 正常发布时间
- 登录：2-3 秒
- 导航：2-3 秒
- 上传图片：3-5 秒
- 填写内容：2-3 秒
- 发布：3-5 秒
- **总计：12-19 秒**

### 优化建议
- 减少不必要的等待时间
- 使用更快的图片格式
- 优化内容清理逻辑

---

## 🚀 开始测试

### 命令

```bash
# 1. 重启服务器
cd server
npm run dev

# 2. 在前端创建发布任务

# 3. 查看日志输出

# 4. 检查发布结果
```

### 预期结果

- ✅ 服务器启动成功
- ✅ 适配器注册成功
- ✅ 发布任务执行成功
- ✅ 小红书笔记发布成功

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试时间：** 2024-01-01 10:00:00
**测试人员：** XXX
**测试环境：** 开发环境

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 服务器启动 | ✅ | 正常 |
| 适配器注册 | ✅ | 正常 |
| Cookie 登录 | ✅ | 正常 |
| 标题填写 | ✅ | 正常 |
| 正文填写 | ✅ | 正常 |
| 图片上传 | ✅ | 正常 |
| 发布成功 | ✅ | 正常 |

### 问题记录

1. 无

### 改进建议

1. 无

### 总结

小红书自动发布功能正常，可以投入使用。
```

---

**开始测试吧！** 🎉

有任何问题随时告诉我！
