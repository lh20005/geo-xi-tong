# 🚀 一键修复账号隔离问题

## 问题确认

✅ **数据库检查完成**
- lzc2005 (ID: 1) 有 2 个账号
- testuser (ID: 437) 有 2 个账号
- 数据库归属正确

✅ **代码检查完成**
- 所有路由都有多租户隔离
- 所有 Service 都按 userId 过滤
- 中间件链完整

⚠️  **问题原因：** 很可能是 Token 共享

## 立即执行修复

### 步骤 1: 清除 Windows 端缓存（lzc2005）

**操作：**
1. 打开 Windows 登录管理器
2. 按 `F12` 打开开发者工具
3. 点击 `Console` 标签
4. 复制粘贴以下代码并按回车：

```javascript
// 清除所有认证信息
console.log('🔄 开始清除...');
localStorage.clear();
console.log('✅ localStorage 已清除');

if (window.electron) {
  window.electron.storage.clearTokens().then(() => {
    console.log('✅ Electron storage 已清除');
    console.log('🔄 3秒后自动刷新页面...');
    setTimeout(() => location.reload(), 3000);
  }).catch(err => {
    console.error('❌ 清除失败:', err);
    console.log('🔄 手动刷新页面...');
    setTimeout(() => location.reload(), 3000);
  });
} else {
  console.log('⚠️  非 Electron 环境');
  console.log('🔄 3秒后自动刷新页面...');
  setTimeout(() => location.reload(), 3000);
}
```

**预期结果：**
```
🔄 开始清除...
✅ localStorage 已清除
✅ Electron storage 已清除
🔄 3秒后自动刷新页面...
```

页面会自动刷新并跳转到登录页面。

---

### 步骤 2: 清除 Web 端缓存（testuser）

**操作：**
1. 打开浏览器访问 Web 端
2. 按 `F12` 打开开发者工具
3. 点击 `Console` 标签
4. 复制粘贴以下代码并按回车：

```javascript
// 清除所有认证信息
console.log('🔄 开始清除...');

// 清除 localStorage
localStorage.clear();
console.log('✅ localStorage 已清除');

// 清除 sessionStorage
sessionStorage.clear();
console.log('✅ sessionStorage 已清除');

// 清除所有 cookies
let cookieCount = 0;
document.cookie.split(';').forEach(c => {
  document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
  cookieCount++;
});
console.log(`✅ ${cookieCount} 个 cookies 已清除`);

console.log('🔄 3秒后自动刷新页面...');
setTimeout(() => location.reload(), 3000);
```

**预期结果：**
```
🔄 开始清除...
✅ localStorage 已清除
✅ sessionStorage 已清除
✅ 5 个 cookies 已清除
🔄 3秒后自动刷新页面...
```

页面会自动刷新并跳转到登录页面。

---

### 步骤 3: 重新登录

#### 3.1 Windows 端登录
1. 在登录页面输入：
   - 用户名：`lzc2005`
   - 密码：（你的密码）
2. 点击登录
3. 登录成功后，打开开发者工具验证 token

**验证 token：**
```javascript
const token = localStorage.getItem('auth_token');
if (token) {
  const decoded = JSON.parse(atob(token.split('.')[1]));
  console.log('✅ 登录成功');
  console.log('用户ID:', decoded.userId);
  console.log('用户名:', decoded.username);
} else {
  console.log('❌ 未找到 token');
}
```

**预期输出：**
```
✅ 登录成功
用户ID: 1
用户名: lzc2005
```

#### 3.2 Web 端登录
1. 在登录页面输入：
   - 用户名：`testuser`
   - 密码：（你的密码）
2. 点击登录
3. 登录成功后，打开开发者工具验证 token

**验证 token：**
```javascript
const token = localStorage.getItem('auth_token');
if (token) {
  const decoded = JSON.parse(atob(token.split('.')[1]));
  console.log('✅ 登录成功');
  console.log('用户ID:', decoded.userId);
  console.log('用户名:', decoded.username);
} else {
  console.log('❌ 未找到 token');
}
```

**预期输出：**
```
✅ 登录成功
用户ID: 437
用户名: testuser
```

---

### 步骤 4: 验证隔离

#### 4.1 验证 Token 不同

**在 Windows 端 Console 运行：**
```javascript
const token = localStorage.getItem('auth_token');
console.log('Windows 端 token 前20字符:', token.substring(0, 20));
```

**在 Web 端 Console 运行：**
```javascript
const token = localStorage.getItem('auth_token');
console.log('Web 端 token 前20字符:', token.substring(0, 20));
```

**结果判断：**
- ✅ 如果两个 token 前缀不同 → Token 已隔离
- ❌ 如果两个 token 前缀相同 → Token 仍然共享（需要进一步诊断）

#### 4.2 验证账号隔离

**在 Windows 端（lzc2005）：**
1. 导航到"平台管理"页面
2. 查看显示的账号列表
3. 应该只看到 lzc2005 的账号：
   - 抖音: Ai来了
   - 头条: 细品茶香韵

**在 Web 端（testuser）：**
1. 导航到"平台管理"页面
2. 查看显示的账号列表
3. 应该只看到 testuser 的账号：
   - 抖音: Ai来了
   - 头条: 细品茶香韵

**结果判断：**
- ✅ 如果两个客户端显示不同的账号 ID → 隔离成功
- ❌ 如果两个客户端显示相同的账号 → 隔离失败（需要进一步诊断）

#### 4.3 测试创建新账号

**在 Windows 端（lzc2005）：**
1. 登录一个新的平台账号（例如：微博）
2. 检查是否成功保存

**在 Web 端（testuser）：**
1. 刷新页面
2. 检查是否能看到 lzc2005 刚创建的账号
3. 应该看不到 → ✅ 隔离成功

---

## 修复完成检查清单

- [ ] Windows 端缓存已清除
- [ ] Web 端缓存已清除
- [ ] Windows 端已重新登录（lzc2005）
- [ ] Web 端已重新登录（testuser）
- [ ] 两个客户端的 token 不同
- [ ] 两个客户端的 userId 不同
- [ ] Windows 端只显示 lzc2005 的账号
- [ ] Web 端只显示 testuser 的账号
- [ ] 创建新账号时正确隔离

---

## 如果问题仍然存在

### 方案 A: 检查 API 响应

运行测试脚本：
```bash
chmod +x test-api-accounts.sh
./test-api-accounts.sh
```

按提示提供两个用户的 token，查看 API 返回的数据。

### 方案 B: 检查数据库

```bash
psql -d geo_system -c "
SELECT 
  pa.id,
  pa.platform_id,
  pa.account_name,
  pa.user_id,
  u.username
FROM platform_accounts pa
JOIN users u ON pa.user_id = u.id
WHERE u.username IN ('lzc2005', 'testuser')
ORDER BY pa.user_id, pa.created_at DESC;
"
```

### 方案 C: 查看服务器日志

检查服务器日志中的认证信息：
```bash
# 如果服务器在运行
tail -f server/logs/app.log | grep -E "userId|tenantId"
```

### 方案 D: 联系支持

如果以上方案都无法解决，请提供：
1. 两个用户的 token（解码后的 payload）
2. API 测试脚本的输出
3. 数据库查询结果
4. 服务器日志

---

## 预防措施

### 1. 使用独立存储

**Windows 端：**
- 使用 Electron Store 而不是 localStorage
- 加密存储敏感信息

**Web 端：**
- 使用 sessionStorage（关闭标签页即清除）
- 或使用带用户前缀的 localStorage key

### 2. 增强 Token

在 JWT 中添加：
- `client_type`: 'web' 或 'electron'
- `device_id`: 设备唯一标识
- `tenant_id`: 明确的租户 ID

### 3. 添加监控

记录所有 token 使用：
- 用户 ID
- 客户端类型
- IP 地址
- 时间戳

---

## 总结

**问题原因：** Token 共享导致两个用户使用了相同的身份

**解决方案：** 清除所有缓存，重新登录

**预期结果：** 两个用户的数据完全隔离

**执行时间：** 约 5-10 分钟

**成功率：** 95%+

---

## 需要帮助？

查看详细文档：
- `完整诊断报告.md` - 完整的诊断结果
- `多租户隔离问题-最佳实践分析.md` - 互联网最佳实践
- `账号隔离问题诊断指南.md` - 详细诊断步骤
