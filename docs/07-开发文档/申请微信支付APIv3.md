# ⚠️ 此文档已过时 - 申请微信支付 APIv3（公钥模式）

**重要：** 微信支付已改用公钥模式，不再需要申请平台证书。

**请参考最新文档：**
- `WECHAT_PAY_SETUP_GUIDE.md` - 完整配置指南
- `微信支付公钥配置-最新官方方案.md` - 最新公钥方案
- 官方文档：https://pay.weixin.qq.com/doc/v3/partner/4012925323

---

# 申请微信支付 APIv3（已废弃）

**⚠️ 以下内容已过时，仅供参考**

## 问题说明

当前错误：
```
无可用的平台证书，请在商户平台-API安全申请使用微信支付公钥
```

这说明你的商户号还没有开通 APIv3 接口，需要在商户平台申请。

---

## 解决方案

### 方法1：在商户平台申请 APIv3（推荐）

#### 步骤1：登录商户平台

访问：https://pay.weixin.qq.com

使用管理员账号登录

#### 步骤2：进入 API 安全

左侧菜单 → "账户中心" → "API安全"

#### 步骤3：申请 APIv3 密钥

1. 找到 "APIv3密钥" 部分
2. 如果显示"未设置"，点击"设置密钥"
3. 如果已经设置过，你之前提供的密钥应该是正确的

#### 步骤4：申请使用微信支付公钥

1. 在 "API安全" 页面
2. 找到 "微信支付公钥" 或 "平台证书" 部分
3. 点击"申请使用"或"开通"按钮
4. 按照提示完成申请

#### 步骤5：等待审核

- 通常几分钟到几小时
- 审核通过后会收到通知

---

### 方法2：使用 APIv2（备选方案）

如果 APIv3 申请比较麻烦，可以暂时使用 APIv2 接口。但是：

**不推荐**：
- APIv2 是旧版本
- 安全性较低
- 微信支付正在逐步淘汰

**推荐使用 APIv3**

---

## 检查当前状态

### 1. 检查是否已开通 APIv3

登录商户平台 → "账户中心" → "API安全"

查看：
- ✅ APIv3密钥：已设置
- ❓ 微信支付公钥/平台证书：？

### 2. 检查 APIv3 密钥

你之前提供的 APIv3 密钥：`your_32_character_api_v3_key_here`

在商户平台确认这个密钥是否正确。

---

## 常见问题

### Q1：找不到"申请使用微信支付公钥"的入口

**可能原因**：
1. 商户号类型不支持 APIv3
2. 需要先设置 APIv3 密钥
3. 界面位置变化了

**解决方案**：
1. 联系微信支付客服
2. 在"帮助中心"搜索"APIv3"
3. 查看官方文档：https://pay.weixin.qq.com/doc/v3/

### Q2：APIv3 密钥是什么时候设置的？

你之前提供的密钥应该是在商户平台设置的。

**验证方法**：
1. 登录商户平台
2. "账户中心" → "API安全"
3. 查看 "APIv3密钥" 状态

### Q3：需要重新设置 APIv3 密钥吗？

**不需要**，除非：
- 密钥泄露
- 密钥错误
- 需要更换密钥

---

## 临时解决方案

在等待 APIv3 开通期间，你可以：

### 选项1：联系客服加急

1. 商户平台右上角"帮助中心"
2. 点击"在线客服"
3. 说明情况：需要开通 APIv3 接口
4. 提供商户号：`your_merchant_id`

### 选项2：检查商户号类型

某些商户号类型可能不支持 APIv3：
- 个人商户
- 特殊行业商户

**检查方法**：
1. 商户平台 → "账户中心" → "商户信息"
2. 查看商户类型

---

## 开通后的操作

### 1. 重新运行获取证书脚本

```bash
cd server
npx tsx download-platform-cert.ts
```

应该会成功获取平台证书。

### 2. 重启服务器

```bash
# 停止服务器（Ctrl+C）
cd server
npm run dev
```

### 3. 测试支付

访问 http://localhost:8080 测试购买功能。

---

## 预计时间

- **申请提交**：5分钟
- **审核时间**：几分钟到几小时
- **配置测试**：10分钟

**总计**：最快30分钟，最慢1天

---

## 需要帮助？

### 微信支付客服

- **在线客服**：商户平台右上角"帮助中心"
- **服务时间**：9:00-21:00
- **电话客服**：95017

### 提供信息

联系客服时提供：
- 商户号：`your_merchant_id`
- 问题：需要开通 APIv3 接口
- 错误信息：无可用的平台证书

---

**创建时间**：2024年12月29日  
**下一步**：登录商户平台申请开通 APIv3
