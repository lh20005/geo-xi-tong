# 🎯 下一步操作指南（简化版）

## 当前状态

✅ **已完成**：
- 支付功能代码已开发完成
- 微信支付配置已填写4项（AppID、商户号、APIv3密钥、证书序列号）
- 本地开发环境已配置

❌ **还需要完成**：
- 下载私钥文件
- 配置回调地址

---

## 第一步：下载私钥文件（最重要！）

### 1. 下载证书工具

访问这个网址：
```
https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay7_0.shtml
```

或者：
1. 登录微信支付商户平台：https://pay.weixin.qq.com
2. 左侧菜单 → "账户中心" → "API安全"
3. 找到"API证书"部分
4. 点击"申请证书"或"下载证书工具"
5. 选择 **Mac版本** 下载

### 2. 安装并使用证书工具

1. 双击下载的 `.dmg` 文件
2. 拖到"应用程序"文件夹
3. 打开证书工具
4. 输入商户号：`your_merchant_id`
5. 点击"申请证书"
6. 用微信扫码确认
7. 等待几秒钟，证书会自动下载

### 3. 找到私钥文件

打开终端（Terminal），执行：

```bash
# 查找私钥文件
find ~ -name "apiclient_key.pem" 2>/dev/null
```

通常在这个位置：
```
/Users/lzc/cert/apiclient_key.pem
```

### 4. 验证私钥文件

```bash
# 查看文件内容（假设在 ~/cert/ 目录）
cat ~/cert/apiclient_key.pem
```

**正确的内容应该是**：
```
-----BEGIN PRIVATE KEY-----
（很多行内容）
-----END PRIVATE KEY-----
```

**如果看到的是**：
- `BEGIN CERTIFICATE` → 这是公钥证书，不对
- `BEGIN CERTIFICATE REQUEST` → 这是证书请求，不对

### 5. 移动到安全位置

```bash
# 创建目录
mkdir -p ~/.wechat-pay

# 移动文件
mv ~/cert/apiclient_key.pem ~/.wechat-pay/

# 设置权限
chmod 600 ~/.wechat-pay/apiclient_key.pem

# 再次验证
cat ~/.wechat-pay/apiclient_key.pem
```

### 6. 更新配置文件

编辑 `server/.env` 文件，找到这一行：
```env
# WECHAT_PAY_PRIVATE_KEY_PATH=/Users/lzc/.wechat-pay/apiclient_key.pem
```

去掉前面的 `#`，改成：
```env
WECHAT_PAY_PRIVATE_KEY_PATH=/Users/lzc/.wechat-pay/apiclient_key.pem
```

---

## 第二步：配置回调地址

### 1. 安装ngrok

```bash
# 使用Homebrew安装
brew install ngrok
```

如果没有Homebrew，访问：https://ngrok.com 下载

### 2. 注册ngrok账号

1. 访问：https://ngrok.com
2. 点击"Sign up"注册免费账号
3. 登录后，在Dashboard找到你的authtoken

### 3. 配置ngrok

```bash
# 配置token（只需要一次，替换成你的token）
ngrok config add-authtoken 你的token
```

### 4. 启动ngrok

```bash
# 暴露本地3000端口
ngrok http 3000
```

启动后会显示类似：
```
Forwarding: https://abc123.ngrok.io -> http://localhost:3000
```

**记下这个地址**：`https://abc123.ngrok.io`

### 5. 更新配置文件

编辑 `server/.env` 文件，找到这一行：
```env
# WECHAT_PAY_NOTIFY_URL=https://你的ngrok地址.ngrok.io/api/payment/wechat/notify
```

去掉前面的 `#`，改成（替换成你的ngrok地址）：
```env
WECHAT_PAY_NOTIFY_URL=https://abc123.ngrok.io/api/payment/wechat/notify
```

---

## 第三步：重启服务器

### 1. 停止当前服务器

在运行服务器的终端按 `Ctrl+C`

### 2. 重新启动

```bash
cd server
npm run dev
```

### 3. 检查启动日志

应该看到：
```
✅ 微信支付初始化成功
```

如果看到错误，说明配置有问题。

---

## 第四步：测试支付

### 1. 确保所有服务运行

你需要4个终端窗口：

**终端1 - 后端服务器**：
```bash
cd server
npm run dev
```

**终端2 - ngrok**：
```bash
ngrok http 3000
```

**终端3 - 营销网站**：
```bash
cd landing
npm run dev
```

**终端4 - 客户端**：
```bash
cd client
npm run dev
```

### 2. 测试购买流程

1. 打开浏览器访问：http://localhost:8080
2. 登录你的账号
3. 滚动到"价格方案"部分
4. 点击任意套餐的"点击购买"按钮
5. 应该弹出支付弹窗，显示二维码
6. 用微信扫码支付

---

## 常见问题

### Q1：找不到私钥文件怎么办？

**A**：执行搜索命令
```bash
find ~ -name "apiclient_key.pem" 2>/dev/null
```

如果还是找不到，重新使用证书工具申请。

### Q2：私钥文件内容不对怎么办？

**A**：确保文件开头是 `-----BEGIN PRIVATE KEY-----`

如果不是，说明下载错了文件，需要重新申请。

### Q3：ngrok地址变化了怎么办？

**A**：每次重启ngrok都会得到新地址，需要：
1. 更新 `server/.env` 中的 `WECHAT_PAY_NOTIFY_URL`
2. 重启服务器

### Q4：支付后没有回调怎么办？

**A**：检查：
1. ngrok是否在运行
2. 回调地址是否正确
3. 服务器是否在运行
4. 查看服务器日志

---

## 完成检查清单

- [ ] 已下载证书工具
- [ ] 已使用证书工具申请证书
- [ ] 已找到私钥文件 `apiclient_key.pem`
- [ ] 私钥文件内容正确（BEGIN PRIVATE KEY）
- [ ] 已移动私钥到 `~/.wechat-pay/`
- [ ] 已安装ngrok
- [ ] 已注册ngrok账号
- [ ] 已配置ngrok authtoken
- [ ] 已启动ngrok
- [ ] 已获取ngrok公网地址
- [ ] 已更新 `server/.env` 的私钥路径
- [ ] 已更新 `server/.env` 的回调地址
- [ ] 已重启服务器
- [ ] 启动日志显示"微信支付初始化成功"
- [ ] 已测试购买流程
- [ ] 支付弹窗显示二维码

---

## 需要帮助？

如果遇到任何问题，随时问我！

**创建时间**：2024年12月29日
