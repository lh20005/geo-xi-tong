# å¤–é”®çº¦æŸæ›¿ä»£å®æ–½æ¸…å•

**ç›®çš„**: ç¡®ä¿ç§»é™¤çš„ 16 ä¸ªå¤–é”®çº¦æŸçš„åŠŸèƒ½é€šè¿‡åº”ç”¨å±‚å®Œå…¨å¤åŸï¼Œä¸é€ æˆä»»ä½•åŠŸèƒ½ç¼ºå¤±ã€‚

**åˆ›å»ºæ—¥æœŸ**: 2026-01-16  
**çŠ¶æ€**: å¾…å®æ–½

---

## ğŸ“‹ ç§»é™¤çš„å¤–é”®çº¦æŸæ¸…å•

### ç±»å‹ 1ï¼šuser_id å¤–é”®ï¼ˆ13 ä¸ªï¼‰

æ‰€æœ‰è¿ç§»çš„è¡¨éƒ½æœ‰ `user_id` å­—æ®µï¼ŒåŸæœ¬å¼•ç”¨ `users(id)`ã€‚

| # | è¡¨å | åŸå¤–é”®çº¦æŸ | ON DELETE | åŠŸèƒ½ |
|---|------|-----------|-----------|------|
| 1 | articles | articles_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤æ–‡ç«  |
| 2 | albums | albums_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤ç›¸å†Œ |
| 3 | images | images_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å›¾ç‰‡ |
| 4 | knowledge_bases | knowledge_bases_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤çŸ¥è¯†åº“ |
| 5 | knowledge_documents | knowledge_documents_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤æ–‡æ¡£ |
| 6 | platform_accounts | platform_accounts_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è´¦å· |
| 7 | publishing_tasks | publishing_tasks_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤ä»»åŠ¡ |
| 8 | publishing_records | publishing_records_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è®°å½• |
| 9 | publishing_logs | publishing_logs_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤æ—¥å¿— |
| 10 | conversion_targets | conversion_targets_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è½¬åŒ–ç›®æ ‡ |
| 11 | distillations | distillations_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è’¸é¦ |
| 12 | topics | topics_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è¯é¢˜ |
| 13 | article_settings | article_settings_user_id_fkey | CASCADE | åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è®¾ç½® |

### ç±»å‹ 2ï¼štask_id å¤–é”®ï¼ˆ3 ä¸ªï¼‰

éƒ¨åˆ†è¡¨æœ‰ `task_id` å­—æ®µï¼ŒåŸæœ¬å¼•ç”¨ `generation_tasks(id)`ã€‚

| # | è¡¨å | åŸå¤–é”®çº¦æŸ | ON DELETE | åŠŸèƒ½ |
|---|------|-----------|-----------|------|
| 14 | articles | articles_task_id_fkey | SET NULL | åˆ é™¤ä»»åŠ¡æ—¶å°†æ–‡ç« çš„ task_id è®¾ä¸º NULL |
| 15 | publishing_tasks | publishing_tasks_task_id_fkey | SET NULL | åˆ é™¤ä»»åŠ¡æ—¶å°†å‘å¸ƒä»»åŠ¡çš„ task_id è®¾ä¸º NULL |
| 16 | publishing_records | publishing_records_task_id_fkey | SET NULL | åˆ é™¤ä»»åŠ¡æ—¶å°†å‘å¸ƒè®°å½•çš„ task_id è®¾ä¸º NULL |

---

## ğŸ› ï¸ æ›¿ä»£æ–¹æ¡ˆå®æ–½è®¡åˆ’

### æ–¹æ¡ˆ Aï¼šuser_id å¼•ç”¨å®Œæ•´æ€§ï¼ˆ13 ä¸ªå¤–é”®ï¼‰

#### A1. å¼•ç”¨å®Œæ•´æ€§æ£€æŸ¥

**åŸåŠŸèƒ½**: æ’å…¥æ•°æ®æ—¶æ£€æŸ¥ user_id æ˜¯å¦å­˜åœ¨äº users è¡¨

**æ›¿ä»£æ–¹æ¡ˆ**: ä» JWT token è·å– user_idï¼Œåº”ç”¨å±‚å¼ºåˆ¶ä½¿ç”¨

**å®æ–½ä½ç½®**: `windows-login-manager/electron/services/BaseService.ts`

**å®æ–½ä»£ç **:

```typescript
// BaseService.ts
import jwt from 'jsonwebtoken';

export class BaseService {
  protected db: any; // PostgreSQL è¿æ¥
  protected userId: number;

  constructor(db: any) {
    this.db = db;
    this.userId = this.getCurrentUserId();
  }

  /**
   * ä» JWT token è·å–å½“å‰ç”¨æˆ· ID
   * è¿™æ˜¯å”¯ä¸€çš„ user_id æ¥æºï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
   */
  private getCurrentUserId(): number {
    // ä»æœ¬åœ°å­˜å‚¨è·å– token
    const token = localStorage.getItem('auth_token');
    
    if (!token) {
      throw new Error('ç”¨æˆ·æœªç™»å½•');
    }

    try {
      // è§£ç  JWT tokenï¼ˆæœåŠ¡å™¨ç­¾å‘ï¼Œæ— æ³•ä¼ªé€ ï¼‰
      const decoded = jwt.decode(token) as { userId: number };
      
      if (!decoded || !decoded.userId) {
        throw new Error('æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ');
      }

      return decoded.userId;
    } catch (error) {
      throw new Error('è®¤è¯ä»¤ç‰Œè§£æå¤±è´¥');
    }
  }

  /**
   * éªŒè¯ user_idï¼ˆæ‰€æœ‰æ“ä½œå‰è°ƒç”¨ï¼‰
   */
  protected validateUserId(): void {
    if (!this.userId || this.userId <= 0) {
      throw new Error('æ— æ•ˆçš„ç”¨æˆ· ID');
    }
  }

  /**
   * åˆ›å»ºè®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  user_idï¼‰
   */
  protected async create(table: string, data: any): Promise<any> {
    this.validateUserId();

    // å¼ºåˆ¶ä½¿ç”¨å½“å‰ç”¨æˆ· ID
    const recordData = {
      ...data,
      user_id: this.userId,
      created_at: new Date(),
      updated_at: new Date()
    };

    const fields = Object.keys(recordData);
    const values = Object.values(recordData);
    const placeholders = fields.map((_, i) => `$${i + 1}`).join(', ');

    const query = `
      INSERT INTO ${table} (${fields.join(', ')})
      VALUES (${placeholders})
      RETURNING *
    `;

    const result = await this.db.query(query, values);
    return result.rows[0];
  }

  /**
   * æŸ¥è¯¢è®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  user_id è¿‡æ»¤ï¼‰
   */
  protected async findAll(table: string, conditions: any = {}): Promise<any[]> {
    this.validateUserId();

    // å¼ºåˆ¶æ·»åŠ  user_id æ¡ä»¶
    const whereConditions = {
      ...conditions,
      user_id: this.userId
    };

    const whereClauses = Object.keys(whereConditions).map((key, i) => `${key} = $${i + 1}`);
    const values = Object.values(whereConditions);

    const query = `
      SELECT * FROM ${table}
      WHERE ${whereClauses.join(' AND ')}
      ORDER BY created_at DESC
    `;

    const result = await this.db.query(query, values);
    return result.rows;
  }

  /**
   * æ›´æ–°è®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  user_id è¿‡æ»¤ï¼‰
   */
  protected async update(table: string, id: number, data: any): Promise<any> {
    this.validateUserId();

    const updateData = {
      ...data,
      updated_at: new Date()
    };

    const fields = Object.keys(updateData);
    const values = Object.values(updateData);
    const setClauses = fields.map((field, i) => `${field} = $${i + 1}`);

    const query = `
      UPDATE ${table}
      SET ${setClauses.join(', ')}
      WHERE id = $${fields.length + 1} AND user_id = $${fields.length + 2}
      RETURNING *
    `;

    const result = await this.db.query(query, [...values, id, this.userId]);

    if (result.rowCount === 0) {
      throw new Error('è®°å½•ä¸å­˜åœ¨æˆ–æ— æƒé™ä¿®æ”¹');
    }

    return result.rows[0];
  }

  /**
   * åˆ é™¤è®°å½•ï¼ˆè‡ªåŠ¨æ·»åŠ  user_id è¿‡æ»¤ï¼‰
   */
  protected async delete(table: string, id: number): Promise<void> {
    this.validateUserId();

    const query = `
      DELETE FROM ${table}
      WHERE id = $1 AND user_id = $2
    `;

    const result = await this.db.query(query, [id, this.userId]);

    if (result.rowCount === 0) {
      throw new Error('è®°å½•ä¸å­˜åœ¨æˆ–æ— æƒé™åˆ é™¤');
    }
  }
}
```

**å®æ–½æ£€æŸ¥æ¸…å•**:
- [x] åˆ›å»º BaseService ç±» âœ… `BaseServicePostgres.ts`
- [x] å®ç° getCurrentUserId æ–¹æ³• âœ…
- [x] å®ç° validateUserId æ–¹æ³• âœ…
- [x] å®ç° create æ–¹æ³•ï¼ˆè‡ªåŠ¨æ·»åŠ  user_idï¼‰ âœ…
- [x] å®ç° findAll æ–¹æ³•ï¼ˆè‡ªåŠ¨è¿‡æ»¤ user_idï¼‰ âœ…
- [x] å®ç° update æ–¹æ³•ï¼ˆè‡ªåŠ¨è¿‡æ»¤ user_idï¼‰ âœ…
- [x] å®ç° delete æ–¹æ³•ï¼ˆè‡ªåŠ¨è¿‡æ»¤ user_idï¼‰ âœ…
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

---

#### A2. çº§è”åˆ é™¤åŠŸèƒ½

**åŸåŠŸèƒ½**: åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼ˆCASCADEï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: åº”ç”¨å±‚æ‰‹åŠ¨å®ç°çº§è”åˆ é™¤

**å®æ–½ä½ç½®**: `windows-login-manager/electron/services/UserService.ts`

**å®æ–½ä»£ç **:

```typescript
// UserService.ts
export class UserService extends BaseService {
  /**
   * åˆ é™¤ç”¨æˆ·è´¦å·ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
   * 
   * æ³¨æ„ï¼šè¿™ä¸ªåŠŸèƒ½é€šå¸¸ä¸ä¼šåœ¨ Windows ç«¯æ‰§è¡Œ
   * ç”¨æˆ·è´¦å·ç®¡ç†åœ¨æœåŠ¡å™¨ç«¯
   * è¿™é‡Œåªæ˜¯æ¼”ç¤ºå¦‚ä½•å®ç°çº§è”åˆ é™¤
   */
  async deleteAccount(): Promise<void> {
    this.validateUserId();

    try {
      // ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
      await this.db.query('BEGIN');

      // æŒ‰ä¾èµ–é¡ºåºåˆ é™¤æ•°æ®
      // 1. åˆ é™¤å‘å¸ƒæ—¥å¿—ï¼ˆä¾èµ– publishing_tasksï¼‰
      await this.db.query('DELETE FROM publishing_logs WHERE user_id = $1', [this.userId]);

      // 2. åˆ é™¤å‘å¸ƒè®°å½•ï¼ˆä¾èµ– publishing_tasksï¼‰
      await this.db.query('DELETE FROM publishing_records WHERE user_id = $1', [this.userId]);

      // 3. åˆ é™¤å‘å¸ƒä»»åŠ¡
      await this.db.query('DELETE FROM publishing_tasks WHERE user_id = $1', [this.userId]);

      // 4. åˆ é™¤ä½¿ç”¨è¿½è¸ªè¡¨
      await this.db.query('DELETE FROM image_usage WHERE user_id = $1', [this.userId]);
      await this.db.query('DELETE FROM distillation_usage WHERE user_id = $1', [this.userId]);
      await this.db.query('DELETE FROM topic_usage WHERE user_id = $1', [this.userId]);

      // 5. åˆ é™¤æ–‡ç« 
      await this.db.query('DELETE FROM articles WHERE user_id = $1', [this.userId]);

      // 6. åˆ é™¤è¯é¢˜
      await this.db.query('DELETE FROM topics WHERE user_id = $1', [this.userId]);

      // 7. åˆ é™¤è’¸é¦
      await this.db.query('DELETE FROM distillations WHERE user_id = $1', [this.userId]);

      // 8. åˆ é™¤çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆä¾èµ– knowledge_basesï¼‰
      await this.db.query(`
        DELETE FROM knowledge_documents 
        WHERE knowledge_base_id IN (
          SELECT id FROM knowledge_bases WHERE user_id = $1
        )
      `, [this.userId]);

      // 9. åˆ é™¤çŸ¥è¯†åº“
      await this.db.query('DELETE FROM knowledge_bases WHERE user_id = $1', [this.userId]);

      // 10. åˆ é™¤å›¾ç‰‡
      await this.db.query('DELETE FROM images WHERE user_id = $1', [this.userId]);

      // 11. åˆ é™¤ç›¸å†Œ
      await this.db.query('DELETE FROM albums WHERE user_id = $1', [this.userId]);

      // 12. åˆ é™¤å¹³å°è´¦å·
      await this.db.query('DELETE FROM platform_accounts WHERE user_id = $1', [this.userId]);

      // 13. åˆ é™¤è½¬åŒ–ç›®æ ‡
      await this.db.query('DELETE FROM conversion_targets WHERE user_id = $1', [this.userId]);

      // 14. åˆ é™¤æ–‡ç« è®¾ç½®
      await this.db.query('DELETE FROM article_settings WHERE user_id = $1', [this.userId]);

      // 15. åˆ é™¤è’¸é¦é…ç½®
      await this.db.query('DELETE FROM distillation_config WHERE user_id = $1', [this.userId]);

      // æäº¤äº‹åŠ¡
      await this.db.query('COMMIT');

      // é€šçŸ¥æœåŠ¡å™¨åˆ é™¤è´¦å·
      await this.notifyServerDeleteAccount();

      console.log('ç”¨æˆ·è´¦å·åŠæ‰€æœ‰æ•°æ®å·²åˆ é™¤');
    } catch (error) {
      // å›æ»šäº‹åŠ¡
      await this.db.query('ROLLBACK');
      throw new Error(`åˆ é™¤è´¦å·å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * é€šçŸ¥æœåŠ¡å™¨åˆ é™¤è´¦å·
   */
  private async notifyServerDeleteAccount(): Promise<void> {
    try {
      await apiClient.delete('/api/user/account');
    } catch (error) {
      console.error('é€šçŸ¥æœåŠ¡å™¨åˆ é™¤è´¦å·å¤±è´¥:', error);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºæœ¬åœ°æ•°æ®å·²åˆ é™¤
    }
  }
}
```

**å®æ–½æ£€æŸ¥æ¸…å•**:
- [x] åˆ›å»º UserService ç±» âœ… `UserServicePostgres.ts`
- [x] å®ç° deleteAccount æ–¹æ³• âœ…
- [x] æŒ‰æ­£ç¡®çš„ä¾èµ–é¡ºåºåˆ é™¤æ•°æ® âœ… (17 ä¸ªè¡¨ï¼ŒæŒ‰ä¾èµ–é¡ºåº)
- [x] ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§ âœ…
- [x] å®ç°å›æ»šæœºåˆ¶ âœ…
- [x] é€šçŸ¥æœåŠ¡å™¨åˆ é™¤è´¦å· âœ…
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•äº‹åŠ¡å›æ»š

---

### æ–¹æ¡ˆ Bï¼štask_id å¼•ç”¨å¤„ç†ï¼ˆ3 ä¸ªå¤–é”®ï¼‰

#### B1. articles.task_id

**åŸåŠŸèƒ½**: 
- å¼•ç”¨ generation_tasks(id)
- ON DELETE SET NULLï¼ˆåˆ é™¤ä»»åŠ¡æ—¶è®¾ä¸º NULLï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: 
- è¿ç§»æ—¶å·²å°† task_id è®¾ä¸º NULL
- æ–°åˆ›å»ºçš„æ–‡ç« ä¸è®¾ç½® task_id
- ä¿ç•™å­—æ®µç”¨äºæœªæ¥å¯èƒ½çš„ç”¨é€”

**å®æ–½ä½ç½®**: `windows-login-manager/electron/services/ArticleService.ts`

**å®æ–½ä»£ç **:

```typescript
// ArticleService.ts
export class ArticleService extends BaseService {
  /**
   * ä¿å­˜ AI ç”Ÿæˆçš„æ–‡ç« 
   * task_id è®¾ä¸º NULLï¼ˆgeneration_tasks è¡¨åœ¨æœåŠ¡å™¨ï¼‰
   */
  async saveGeneratedArticle(article: GeneratedArticle): Promise<Article> {
    this.validateUserId();

    const articleData = {
      user_id: this.userId,
      title: article.title,
      keyword: article.keyword,
      content: article.content,
      provider: article.provider,
      distillation_id: article.distillationId || null,
      topic_id: article.topicId || null,
      image_id: article.imageId || null,
      task_id: null,  // â­ å§‹ç»ˆè®¾ä¸º NULL
      requirements: article.requirements || null,
      image_url: article.imageUrl || null,
      image_size_bytes: article.imageSizeBytes || 0,
      is_published: false,
      publishing_status: null,
      published_at: null,
      distillation_keyword_snapshot: article.distillationKeywordSnapshot || null,
      topic_question_snapshot: article.topicQuestionSnapshot || null,
      created_at: new Date(),
      updated_at: new Date()
    };

    return await this.create('articles', articleData);
  }
}
```

**å®æ–½æ£€æŸ¥æ¸…å•**:
- [x] åˆ›å»º ArticleService ç±» âœ… `ArticleServicePostgres.ts`
- [x] saveGeneratedArticle æ–¹æ³•ä¸­ task_id è®¾ä¸º NULL âœ…
- [x] ç¡®ä¿ä¸ä¼šå°è¯•è®¾ç½® task_id âœ…
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

---

#### B2. publishing_tasks.task_id å’Œ publishing_records.task_id

**åŸåŠŸèƒ½**: 
- å¼•ç”¨ generation_tasks(id)
- ON DELETE SET NULL

**æ›¿ä»£æ–¹æ¡ˆ**: 
- è¿™ä¸¤ä¸ªè¡¨å¯èƒ½æ²¡æœ‰ task_id å­—æ®µï¼ˆéœ€è¦éªŒè¯ï¼‰
- å¦‚æœæœ‰ï¼Œè¿ç§»æ—¶è®¾ä¸º NULL
- æ–°åˆ›å»ºçš„è®°å½•ä¸è®¾ç½® task_id

**å®æ–½ä½ç½®**: éœ€è¦å…ˆéªŒè¯è¿™ä¸¤ä¸ªè¡¨æ˜¯å¦æœ‰ task_id å­—æ®µ

**éªŒè¯æ­¥éª¤**:
```sql
-- æ£€æŸ¥ publishing_tasks è¡¨ç»“æ„
\d publishing_tasks

-- æ£€æŸ¥ publishing_records è¡¨ç»“æ„
\d publishing_records
```

**å®æ–½æ£€æŸ¥æ¸…å•**:
- [ ] éªŒè¯ publishing_tasks æ˜¯å¦æœ‰ task_id å­—æ®µ
- [ ] éªŒè¯ publishing_records æ˜¯å¦æœ‰ task_id å­—æ®µ
- [ ] å¦‚æœæœ‰ï¼Œç¡®ä¿æ–°è®°å½•ä¸è®¾ç½® task_id
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

---

## ğŸ“Š å®æ–½è¿›åº¦è·Ÿè¸ª

### user_id å¤–é”®æ›¿ä»£ï¼ˆ13 ä¸ªï¼‰

| # | è¡¨å | å¼•ç”¨å®Œæ•´æ€§ | çº§è”åˆ é™¤ | çŠ¶æ€ |
|---|------|-----------|---------|------|
| 1 | articles | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 2 | albums | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 3 | images | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 4 | knowledge_bases | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 5 | knowledge_documents | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 6 | platform_accounts | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 7 | publishing_tasks | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 8 | publishing_records | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 9 | publishing_logs | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 10 | conversion_targets | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 11 | distillations | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 12 | topics | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 13 | article_settings | âœ… å·²å®æ–½ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |

**è¯´æ˜**: æ‰€æœ‰ 13 ä¸ªè¡¨çš„ user_id å¤–é”®åŠŸèƒ½å·²é€šè¿‡ `BaseServicePostgres` ç±»ç»Ÿä¸€å®ç°

### task_id å¤–é”®æ›¿ä»£ï¼ˆ3 ä¸ªï¼‰

| # | è¡¨å | å­—æ®µéªŒè¯ | ä»£ç å®æ–½ | çŠ¶æ€ |
|---|------|---------|---------|------|
| 14 | articles | âœ… å·²éªŒè¯ | âœ… å·²å®æ–½ | âœ… å®Œæˆ |
| 15 | publishing_tasks | â³ å¾…éªŒè¯ | â³ å¾…å®æ–½ | â³ æœªå¼€å§‹ |
| 16 | publishing_records | â³ å¾…éªŒè¯ | â³ å¾…å®æ–½ | â³ æœªå¼€å§‹ |

**è¯´æ˜**: articles è¡¨çš„ task_id å·²åœ¨ `ArticleServicePostgres` ä¸­å¤„ç†ï¼ˆè®¾ä¸º NULLï¼‰

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯

æ¯ä¸ªæ›¿ä»£æ–¹æ¡ˆå®æ–½åï¼Œå¿…é¡»éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

#### 1. å¼•ç”¨å®Œæ•´æ€§

- [ ] åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ· ID
- [ ] æ— æ³•åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„è®°å½•
- [ ] æŸ¥è¯¢æ—¶åªè¿”å›å½“å‰ç”¨æˆ·çš„è®°å½•
- [ ] æ›´æ–°æ—¶åªèƒ½ä¿®æ”¹å½“å‰ç”¨æˆ·çš„è®°å½•
- [ ] åˆ é™¤æ—¶åªèƒ½åˆ é™¤å½“å‰ç”¨æˆ·çš„è®°å½•

#### 2. çº§è”åˆ é™¤

- [ ] åˆ é™¤è´¦å·æ—¶æ‰€æœ‰æ•°æ®è¢«åˆ é™¤
- [ ] åˆ é™¤å¤±è´¥æ—¶äº‹åŠ¡å›æ»š
- [ ] åˆ é™¤é¡ºåºæ­£ç¡®ï¼ˆé¿å…å¤–é”®å†²çªï¼‰
- [ ] æœåŠ¡å™¨æ”¶åˆ°åˆ é™¤é€šçŸ¥

#### 3. æ•°æ®éš”ç¦»

- [ ] ç”¨æˆ· A æ— æ³•è®¿é—®ç”¨æˆ· B çš„æ•°æ®
- [ ] ç”¨æˆ· A æ— æ³•ä¿®æ”¹ç”¨æˆ· B çš„æ•°æ®
- [ ] ç”¨æˆ· A æ— æ³•åˆ é™¤ç”¨æˆ· B çš„æ•°æ®

#### 4. é”™è¯¯å¤„ç†

- [ ] æœªç™»å½•æ—¶æŠ›å‡ºé”™è¯¯
- [ ] æ— æ•ˆ token æ—¶æŠ›å‡ºé”™è¯¯
- [ ] æ— æƒé™æ“ä½œæ—¶æŠ›å‡ºé”™è¯¯
- [ ] äº‹åŠ¡å¤±è´¥æ—¶æ­£ç¡®å›æ»š

---

## ğŸ“ æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```typescript
// BaseService.test.ts
describe('BaseService', () => {
  describe('getCurrentUserId', () => {
    it('should get user ID from JWT token', () => {
      // æµ‹è¯•ä» JWT è·å– user_id
    });

    it('should throw error if token is missing', () => {
      // æµ‹è¯•æœªç™»å½•æ—¶æŠ›å‡ºé”™è¯¯
    });

    it('should throw error if token is invalid', () => {
      // æµ‹è¯•æ— æ•ˆ token æ—¶æŠ›å‡ºé”™è¯¯
    });
  });

  describe('create', () => {
    it('should add user_id automatically', async () => {
      // æµ‹è¯•è‡ªåŠ¨æ·»åŠ  user_id
    });

    it('should not allow creating records for other users', async () => {
      // æµ‹è¯•æ— æ³•åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„è®°å½•
    });
  });

  describe('findAll', () => {
    it('should filter by user_id automatically', async () => {
      // æµ‹è¯•è‡ªåŠ¨è¿‡æ»¤ user_id
    });

    it('should not return other users data', async () => {
      // æµ‹è¯•ä¸è¿”å›å…¶ä»–ç”¨æˆ·çš„æ•°æ®
    });
  });

  describe('update', () => {
    it('should only update own records', async () => {
      // æµ‹è¯•åªèƒ½ä¿®æ”¹è‡ªå·±çš„è®°å½•
    });

    it('should throw error when updating other users records', async () => {
      // æµ‹è¯•ä¿®æ”¹å…¶ä»–ç”¨æˆ·è®°å½•æ—¶æŠ›å‡ºé”™è¯¯
    });
  });

  describe('delete', () => {
    it('should only delete own records', async () => {
      // æµ‹è¯•åªèƒ½åˆ é™¤è‡ªå·±çš„è®°å½•
    });

    it('should throw error when deleting other users records', async () => {
      // æµ‹è¯•åˆ é™¤å…¶ä»–ç”¨æˆ·è®°å½•æ—¶æŠ›å‡ºé”™è¯¯
    });
  });
});

// UserService.test.ts
describe('UserService', () => {
  describe('deleteAccount', () => {
    it('should delete all user data in correct order', async () => {
      // æµ‹è¯•æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤æ‰€æœ‰æ•°æ®
    });

    it('should rollback on error', async () => {
      // æµ‹è¯•å¤±è´¥æ—¶å›æ»š
    });

    it('should notify server', async () => {
      // æµ‹è¯•é€šçŸ¥æœåŠ¡å™¨
    });
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
// integration.test.ts
describe('Data Integrity', () => {
  it('should maintain data isolation between users', async () => {
    // æµ‹è¯•ç”¨æˆ·æ•°æ®éš”ç¦»
  });

  it('should cascade delete all user data', async () => {
    // æµ‹è¯•çº§è”åˆ é™¤
  });

  it('should prevent unauthorized access', async () => {
    // æµ‹è¯•é˜²æ­¢æœªæˆæƒè®¿é—®
  });
});
```

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å®æ–½ï¼‰

1. **BaseService ç±»** - æ‰€æœ‰ Service çš„åŸºç¡€
2. **å¼•ç”¨å®Œæ•´æ€§æ£€æŸ¥** - ä¿è¯æ•°æ®å®‰å…¨
3. **user_id è‡ªåŠ¨ç®¡ç†** - æ ¸å¿ƒåŠŸèƒ½

### ä¸­ä¼˜å…ˆçº§ï¼ˆé‡è¦ä½†ä¸ç´§æ€¥ï¼‰

4. **çº§è”åˆ é™¤åŠŸèƒ½** - ç”¨æˆ·æ³¨é”€æ—¶éœ€è¦
5. **é”™è¯¯å¤„ç†** - æå‡ç”¨æˆ·ä½“éªŒ

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

6. **task_id å¤„ç†** - å·²åœ¨æ•°æ®å±‚é¢å¤„ç†ï¼Œä»£ç å±‚é¢åªéœ€ç¡®ä¿ä¸è®¾ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤–é”®çº¦æŸåŠŸèƒ½æ›¿ä»£æ–¹æ¡ˆ](./å¤–é”®çº¦æŸåŠŸèƒ½æ›¿ä»£æ–¹æ¡ˆ.md) - è¯¦ç»†çš„æŠ€æœ¯æ–¹æ¡ˆ
- [PostgreSQL è¿ç§»å®Œæ•´è®¡åˆ’](./PostgreSQLè¿ç§»å®Œæ•´è®¡åˆ’.md) - æ•´ä½“è¿ç§»è®¡åˆ’
- [è¿ç§»é—®é¢˜è§£ç­”](./è¿ç§»é—®é¢˜è§£ç­”.md) - å¸¸è§é—®é¢˜è§£ç­”

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-16  
**çŠ¶æ€**: å¾…å®æ–½

