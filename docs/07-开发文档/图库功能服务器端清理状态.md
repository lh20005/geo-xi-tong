# 图库功能服务器端清理状态

**日期**: 2026-01-18  
**问题**: 服务器数据库中不存在 gallery_albums 表，但代码中还保留旧的 API 路由  
**状态**: ✅ 路由已禁用，代码待清理

---

## 当前状态

### ✅ 已完成

1. **路由已禁用**：
   ```typescript
   // server/src/routes/index.ts
   // [已迁移到 Windows 端] import { galleryRouter } from './gallery';
   // [已迁移到 Windows 端] apiRouter.use('/gallery', galleryRouter);
   ```

2. **数据库表不存在**：
   - 服务器端 `geo_system` 数据库中没有 `gallery_albums` 和 `gallery_images` 表
   - 这是正确的，因为图库功能已完全迁移到 Windows 端

3. **Windows 端已实现**：
   - 本地数据库表：`albums` 和 `images`
   - 本地服务：`AlbumServicePostgres` 和 `ImageServicePostgres`
   - 本地 IPC handlers：`localGalleryHandlers.ts`

### ⏳ 待清理

以下文件仍然存在，但已不再使用：

1. **路由文件**：
   - `server/src/_deprecated/routes/gallery.ts` - 已移到 `_deprecated` 目录

2. **服务文件**：
   - 可能存在的 `ImageService.ts`（需要确认）

3. **迁移脚本**：
   - `server/src/db/migrate-gallery.ts` - 旧的迁移脚本
   - `server/src/db/migrations/024_add_gallery_knowledge_quotas.sql`
   - `server/src/db/migrations/025_update_quota_functions_for_gallery_knowledge.sql`
   - `server/src/db/migrations/026_update_check_user_quota_for_gallery_knowledge.sql`

4. **其他引用**：
   - `server/src/services/UserService.ts` - 删除用户时清理图库文件
   - `server/src/services/OrphanImageCleanupService.ts` - 孤儿图片清理
   - `server/src/services/articleGenerationService.ts` - 图片引用

---

## 是否需要修复？

### 建议：⏳ 暂不修复，等待统一清理

**原因**：

1. **功能已正常**：
   - 路由已禁用，不会被调用
   - Windows 端功能正常工作
   - 不影响用户使用

2. **有完整清理计划**：
   - 已有详细的《服务器端表清理计划》
   - 包含 17 个表的清理方案
   - 图库只是其中一部分

3. **应该统一清理**：
   - 一次性清理所有已迁移功能
   - 避免多次修改和部署
   - 降低风险

### 如果要立即清理图库

如果确实需要立即清理图库相关代码，可以执行以下步骤：

#### 步骤 1：备份（可选）

```bash
# 图库路由已在 _deprecated 目录，无需额外备份
```

#### 步骤 2：删除文件

```bash
# 删除废弃的路由文件
rm server/src/_deprecated/routes/gallery.ts

# 删除迁移脚本（如果不再需要）
rm server/src/db/migrate-gallery.ts
```

#### 步骤 3：清理代码引用

**文件**: `server/src/services/UserService.ts`

```typescript
// 删除图库文件清理逻辑
// 因为图库文件现在在 Windows 端本地，服务器端不需要清理
```

**文件**: `server/src/services/OrphanImageCleanupService.ts`

```typescript
// 删除图库相关的孤儿文件清理逻辑
// 或者标记为 deprecated
```

**文件**: `server/src/services/articleGenerationService.ts`

```typescript
// 保留图片引用逻辑，但改为：
// 1. 客户端传递图片 URL
// 2. 服务器端不再从数据库读取图片
```

#### 步骤 4：测试

```bash
# 编译服务器端代码
cd server
npm run build

# 检查编译错误
# 如果有错误，说明还有其他地方引用了图库代码

# 部署到服务器
# 测试现有功能是否正常
```

---

## 推荐方案

### 方案 A：等待统一清理（推荐）✅

**优点**：
- 一次性清理所有已迁移功能
- 降低风险
- 减少部署次数

**缺点**：
- 代码中保留无用文件

**时间**：等待完整清理计划执行

### 方案 B：立即清理图库

**优点**：
- 立即清理无用代码
- 减少代码库大小

**缺点**：
- 需要额外的测试和部署
- 可能遗漏某些引用

**时间**：约 2-4 小时

---

## 相关文档

- `docs/07-开发文档/服务器端表清理计划.md` - 完整清理计划
- `服务器文件备份/备份说明-最终版.md` - 备份说明
- `服务器文件备份/删除清单.md` - 删除清单

---

## 决策

**建议**：✅ 采用方案 A - 等待统一清理

**原因**：
1. 当前状态不影响功能
2. 有完整的清理计划
3. 统一清理更安全

**如果用户坚持立即清理**：
- 可以执行方案 B
- 但需要充分测试
- 建议先在测试环境验证

---

## 总结

✅ 图库路由已禁用  
✅ 数据库表不存在（正确）  
✅ Windows 端功能正常  
⏳ 代码文件待清理（建议等待统一清理）  

**不影响当前功能，可以继续使用。**
