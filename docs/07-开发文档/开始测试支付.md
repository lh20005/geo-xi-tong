# ✅ 准备就绪！开始测试支付

## 当前状态

### ✅ 所有配置完成

1. **微信支付配置**：
   - AppID: `wx_your_app_id_here`
   - 商户号: `your_merchant_id`
   - APIv3密钥: 已配置
   - 证书序列号: `your_certificate_serial_number_here`
   - 私钥文件: `/Users/lzc/.wechat-pay/apiclient_key.pem`
   - 回调地址: `https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/payment/wechat/notify`

2. **服务运行状态**：
   - ✅ 后端服务器：http://localhost:3000
   - ✅ ngrok：https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
   - ✅ 营销网站：http://localhost:8080
   - ✅ 客户端：http://localhost:5173

3. **服务器日志**：
   - ✅ 支付配置验证通过
   - ✅ 微信支付初始化成功

---

## 🎯 测试步骤

### 第一步：访问营销网站

打开浏览器，访问：**http://localhost:8080**

### 第二步：登录账号

- 用户名：`lzc2005`
- 密码：你的密码

### 第三步：选择套餐

滚动到页面下方的"价格方案"部分，你会看到三个套餐：

1. **免费版** - ¥0/月
2. **专业版** - ¥99/月
3. **企业版** - ¥299/月

### 第四步：点击购买

点击任意套餐的"点击购买"按钮（建议先测试专业版）

### 第五步：查看支付弹窗

应该弹出支付弹窗，显示：
- ✅ 订单信息
- ✅ 套餐名称
- ✅ 金额
- ✅ 二维码
- ✅ 订单号

### 第六步：扫码支付

1. 打开微信
2. 扫描二维码
3. 确认支付金额（测试金额 0.01 元）
4. 完成支付

### 第七步：等待结果

支付成功后：
- ✅ 页面会自动更新或跳转
- ✅ 显示支付成功提示
- ✅ 订单状态自动更新
- ✅ 订阅自动开通
- ✅ 配额自动分配

---

## 🔍 验证结果

### 方法1：查看订单列表

1. 访问：http://localhost:5173
2. 登录后台管理系统
3. 点击左侧菜单"订单管理"
4. 查看订单状态（应该是"已支付"）

### 方法2：查看用户订阅

1. 在后台管理系统
2. 点击"用户管理"
3. 找到你的用户
4. 查看订阅状态（应该显示已开通的套餐）

### 方法3：查看 ngrok 日志

在 ngrok 终端窗口，应该能看到：

```
POST /api/payment/wechat/notify    200 OK
```

这说明微信支付成功回调了！

### 方法4：访问 ngrok Web 界面

打开浏览器访问：http://127.0.0.1:4040

可以看到所有请求的详细信息，包括：
- 请求时间
- 请求内容
- 响应内容

---

## 📊 测试数据

### 当前数据库中的套餐

根据之前的检查，数据库中有以下套餐：

1. **免费版**：
   - 价格：¥0
   - 每日配额：10
   - 每月配额：300

2. **专业版**：
   - 价格：¥99
   - 每日配额：100
   - 每月配额：3000

3. **企业版**：
   - 价格：¥299
   - 每日配额：无限制
   - 每月配额：无限制

---

## ⚠️ 注意事项

### 关于测试金额

- 微信支付没有真正的测试环境
- 需要真实支付（建议使用最小金额 0.01 元）
- 测试完成后可以申请退款

### 关于 ngrok 地址

- 当前地址：`https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev`
- 免费版每次重启会变化
- 如果重启了 ngrok，需要：
  1. 记下新地址
  2. 更新 `.env` 文件
  3. 重启服务器

### 保持 ngrok 运行

- 测试期间不要关闭 ngrok 终端
- 如果关闭了，重新启动：`ngrok http 3000`

---

## 🐛 故障排除

### 问题1：点击购买后没有反应

**检查**：
- 浏览器控制台是否有错误
- 服务器日志是否有错误
- 是否已登录

### 问题2：二维码不显示

**检查**：
- 服务器是否在运行
- 微信支付配置是否正确
- 查看浏览器控制台错误

### 问题3：扫码后无法支付

**检查**：
- 二维码是否有效
- 微信账号是否正常
- 支付金额是否正确

### 问题4：支付成功但订单状态没有更新

**检查**：
- ngrok 是否在运行
- 查看 ngrok 日志是否收到回调
- 查看服务器日志
- 访问 http://127.0.0.1:4040 查看详细请求

### 问题5：服务器报错

**常见错误**：
- "微信支付未配置"：检查环境变量
- "私钥文件不存在"：检查私钥路径
- "签名验证失败"：检查证书序列号

---

## 📝 测试记录

建议记录测试结果：

### 测试1：创建订单
- [ ] 点击购买按钮
- [ ] 支付弹窗显示
- [ ] 二维码显示
- [ ] 订单信息正确

### 测试2：扫码支付
- [ ] 微信扫码成功
- [ ] 支付金额正确
- [ ] 支付成功

### 测试3：回调处理
- [ ] ngrok 收到回调
- [ ] 服务器处理回调
- [ ] 订单状态更新

### 测试4：订阅开通
- [ ] 订阅自动创建
- [ ] 配额自动分配
- [ ] 用户可以使用服务

---

## 🎉 测试成功后

### 下一步工作

1. **测试其他套餐**
   - 测试免费版
   - 测试企业版

2. **测试边界情况**
   - 重复支付
   - 支付超时
   - 订单取消

3. **准备生产环境**
   - 部署到真实服务器
   - 配置真实域名
   - 更新微信支付回调地址

### 清理测试数据（可选）

如果需要清理测试订单：
1. 登录后台管理系统
2. 在订单管理中删除测试订单
3. 或保留作为演示数据

---

## 🚀 开始测试吧！

现在一切准备就绪，可以开始测试了！

**访问**：http://localhost:8080

**祝测试顺利！** 🎊

---

**配置完成时间**：2024年12月29日  
**ngrok 地址**：https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev  
**有效期**：ngrok 运行期间

如果遇到任何问题，随时告诉我！
