# ✅ 文章生成功能修复完成

## 问题描述

用户在网页端点击"生成文章"按钮时，遇到以下错误：
```
POST http://localhost:5173/api/article-generation/tasks 500 (Internal Server Error)
```

后端实际错误：
```
null value in column "user_id" of relation "generation_tasks" violates not-null constraint
```

## 根本原因

在多租户改造过程中，`generation_tasks` 表已经添加了 `user_id` 字段并设置为必填（NOT NULL），但是 **ArticleGenerationService 的 createTask 方法在插入数据时没有包含 user_id 字段**。

## 修复内容

### 修改文件
`server/src/services/articleGenerationService.ts`

### 修改位置
第 230-245 行，INSERT 语句

### 修改前
```typescript
const result = await pool.query(
  `INSERT INTO generation_tasks 
   (distillation_id, album_id, knowledge_base_id, article_setting_id, conversion_target_id, requested_count, selected_distillation_ids, status) 
   VALUES ($1, $2, $3, $4, $5, $6, $7, 'pending') 
   RETURNING id`,
  [
    config.distillationId,
    config.albumId,
    config.knowledgeBaseId,
    config.articleSettingId,
    config.conversionTargetId || null,
    1,
    selectedIdsJson
  ]
);
```

### 修改后
```typescript
const result = await pool.query(
  `INSERT INTO generation_tasks 
   (distillation_id, album_id, knowledge_base_id, article_setting_id, conversion_target_id, requested_count, selected_distillation_ids, user_id, status) 
   VALUES ($1, $2, $3, $4, $5, $6, $7, $8, 'pending') 
   RETURNING id`,
  [
    config.distillationId,
    config.albumId,
    config.knowledgeBaseId,
    config.articleSettingId,
    config.conversionTargetId || null,
    1,
    selectedIdsJson,
    config.userId // 添加用户ID
  ]
);
```

## 测试结果

### 测试账号
- 用户名：testuser
- 密码：123456

### 测试数据
- 蒸馏历史ID：25189
- 相册ID：90
- 知识库ID：4
- 文章设置ID：49

### 测试结果
```json
{
  "taskId": 732,
  "status": "running",
  "selectedDistillationIds": {
    "distillationId": 25189,
    "topicId": 27092
  },
  "createdAt": "2025-12-29T10:33:33.881Z"
}
```

✅ **任务创建成功！**

## 验证步骤

1. 登录网页端（http://localhost:5173）
2. 使用账号：testuser / 123456
3. 进入"文章生成"页面
4. 点击"生成文章"按钮
5. 填写配置信息并提交
6. 应该能成功创建任务

## 影响范围

- ✅ 修复了文章生成功能
- ✅ 确保多租户数据隔离正常工作
- ✅ 每个用户只能看到自己的生成任务

## 注意事项

1. **数据隔离**：每个用户只能看到自己创建的任务和生成的文章
2. **必需数据**：生成文章前需要先创建：
   - 蒸馏历史（包含话题）
   - 相册（包含图片）
   - 知识库（包含文档）
   - 文章设置（提示词模板）
3. **系统级AI配置**：需要管理员配置系统级的AI服务（DeepSeek/OpenAI/Ollama）

## 相关文件

- `server/src/services/articleGenerationService.ts` - 文章生成服务
- `server/src/routes/articleGeneration.ts` - 文章生成路由
- `server/src/db/migrations/add-multi-tenancy.sql` - 多租户迁移脚本
- `fix-generation-tasks-user-id.sql` - 数据库修复脚本

## 完成时间

2025-12-29 18:33

---

**状态：✅ 已完成并测试通过**
