# ğŸš¨ çŸ¥è¯†åº“ä¸Šä¼ é—®é¢˜ - ç´§æ€¥ä¿®å¤æŒ‡å—

## é—®é¢˜ç°è±¡

åœ¨ Windows ç«¯åˆ›å»ºçŸ¥è¯†åº“"è£…ä¿®"åï¼Œä¸Šä¼ æ–‡ä»¶æ—¶æç¤ºæ— æ³•ä¸Šä¼ ã€‚

## æ ¹æœ¬åŸå› 

çŸ¥è¯†åº“è·¯ç”±å­˜åœ¨**ä¸¥é‡çš„å®‰å…¨æ¼æ´**ï¼š

1. âŒ UPDATEè·¯ç”±ç¼ºå°‘æƒé™éªŒè¯
2. âŒ UPDATEè·¯ç”±å­˜åœ¨SQLæ³¨å…¥æ¼æ´  
3. âŒ è·å–æ–‡æ¡£è¯¦æƒ…æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ
4. âŒ åˆ é™¤æ–‡æ¡£æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ
5. âŒ æœç´¢æ–‡æ¡£æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ

## ç´§æ€¥ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: æ‰“å¼€æ–‡ä»¶

```bash
# ç¼–è¾‘çŸ¥è¯†åº“è·¯ç”±æ–‡ä»¶
code server/src/routes/knowledgeBase.ts
```

### æ­¥éª¤2: ä¿®å¤UPDATEè·¯ç”±ï¼ˆç¬¬157-204è¡Œï¼‰

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
// æ›´æ–°çŸ¥è¯†åº“
knowledgeBaseRouter.patch('/:id', async (req, res) => {
  try {
    const kbId = parseInt(req.params.id);
```

**æ›¿æ¢ä¸º**:
```typescript
// æ›´æ–°çŸ¥è¯†åº“ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
knowledgeBaseRouter.patch('/:id', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);  // â† æ·»åŠ è¿™è¡Œ
    const kbId = parseInt(req.params.id);
```

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
    // æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦å­˜åœ¨
    const checkResult = await pool.query('SELECT id FROM knowledge_bases WHERE id = $1', [kbId]);
```

**æ›¿æ¢ä¸º**:
```typescript
    // æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
    const checkResult = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
      [kbId, userId]
    );
```

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
      return res.status(404).json({ error: 'çŸ¥è¯†åº“ä¸å­˜åœ¨' });
```

**æ›¿æ¢ä¸º**:
```typescript
      return res.status(404).json({ error: 'çŸ¥è¯†åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®' });
```

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
    if (validatedData.name !== undefined) {
      updates.push(`name = ${paramIndex++}`);
      values.push(validatedData.name);
    }
    
    if (validatedData.description !== undefined) {
      updates.push(`description = ${paramIndex++}`);
      values.push(validatedData.description);
    }
```

**æ›¿æ¢ä¸º**:
```typescript
    if (validatedData.name !== undefined) {
      updates.push(`name = $${paramIndex++}`);  // â† æ·»åŠ  $ ç¬¦å·
      values.push(validatedData.name);
    }
    
    if (validatedData.description !== undefined) {
      updates.push(`description = $${paramIndex++}`);  // â† æ·»åŠ  $ ç¬¦å·
      values.push(validatedData.description);
    }
```

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
    updates.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(kbId);
    
    const result = await pool.query(
      `UPDATE knowledge_bases SET ${updates.join(', ')} WHERE id = ${paramIndex} RETURNING id, name, description, updated_at`,
      values
    );
```

**æ›¿æ¢ä¸º**:
```typescript
    updates.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(kbId);
    values.push(userId);  // â† æ·»åŠ è¿™è¡Œ
    
    const result = await pool.query(
      `UPDATE knowledge_bases 
       SET ${updates.join(', ')} 
       WHERE id = $${paramIndex} AND user_id = $${paramIndex + 1}  // â† ä¿®æ”¹è¿™è¡Œ
       RETURNING id, name, description, updated_at`,
      values
    );
```

### æ­¥éª¤3: ä¿®å¤æœç´¢æ–‡æ¡£è·¯ç”±ï¼ˆç¬¬430è¡Œå·¦å³ï¼‰

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
// æœç´¢æ–‡æ¡£
knowledgeBaseRouter.get('/:id/documents/search', async (req, res) => {
  try {
    const kbId = parseInt(req.params.id);
    const query = req.query.q as string;
```

**æ›¿æ¢ä¸º**:
```typescript
// æœç´¢æ–‡æ¡£ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
knowledgeBaseRouter.get('/:id/documents/search', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);  // â† æ·»åŠ è¿™è¡Œ
    const kbId = parseInt(req.params.id);
    const query = req.query.q as string;
```

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
    if (!query || query.trim().length === 0) {
      return res.status(400).json({ error: 'è¯·æä¾›æœç´¢å…³é”®è¯' });
    }
    
    // ä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢
    const result = await pool.query(
```

**æ›¿æ¢ä¸º**:
```typescript
    if (!query || query.trim().length === 0) {
      return res.status(400).json({ error: 'è¯·æä¾›æœç´¢å…³é”®è¯' });
    }
    
    // éªŒè¯çŸ¥è¯†åº“æ‰€æœ‰æƒ
    const kbCheck = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
      [kbId, userId]
    );
    
    if (kbCheck.rows.length === 0) {
      return res.status(404).json({ error: 'çŸ¥è¯†åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®' });
    }
    
    // ä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢
    const result = await pool.query(
```

### æ­¥éª¤4: é‡å¯æœåŠ¡å™¨

```bash
# é‡å¯åç«¯æœåŠ¡
# å¦‚æœä½¿ç”¨ npm run devï¼ŒæŒ‰ Ctrl+C åœæ­¢ï¼Œç„¶åé‡æ–°è¿è¡Œ
npm run server:dev
```

### æ­¥éª¤5: æµ‹è¯•éªŒè¯

1. åœ¨ Windows ç«¯åˆ›å»ºçŸ¥è¯†åº“"è£…ä¿®"
2. å°è¯•ä¸Šä¼ æ–‡æ¡£
3. åº”è¯¥å¯ä»¥æˆåŠŸä¸Šä¼ 

## å·²è‡ªåŠ¨ä¿®å¤çš„éƒ¨åˆ†

ä»¥ä¸‹è·¯ç”±å·²ç»é€šè¿‡ä»£ç è‡ªåŠ¨ä¿®å¤ï¼š

âœ… **è·å–æ–‡æ¡£è¯¦æƒ…** - å·²æ·»åŠ æƒé™éªŒè¯  
âœ… **åˆ é™¤æ–‡æ¡£** - å·²æ·»åŠ æƒé™éªŒè¯

## å®‰å…¨å½±å“

ä¿®å¤å‰çš„æ¼æ´å¯èƒ½å¯¼è‡´ï¼š

- ğŸ”´ **æƒé™ç»•è¿‡**: ç”¨æˆ·å¯ä»¥è®¿é—®/ä¿®æ”¹/åˆ é™¤å…¶ä»–ç”¨æˆ·çš„çŸ¥è¯†åº“
- ğŸ”´ **SQLæ³¨å…¥**: UPDATEè¯­å¥å­˜åœ¨SQLæ³¨å…¥é£é™©
- ğŸ”´ **æ•°æ®æ³„éœ²**: ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„æ–‡æ¡£å†…å®¹

## éªŒè¯æ¸…å•

ä¿®å¤åè¯·éªŒè¯ï¼š

- [ ] ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„çŸ¥è¯†åº“åˆ—è¡¨
- [ ] ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„çŸ¥è¯†åº“
- [ ] ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„çŸ¥è¯†åº“
- [ ] ç”¨æˆ·åªèƒ½ä¸Šä¼ æ–‡æ¡£åˆ°è‡ªå·±çš„çŸ¥è¯†åº“
- [ ] ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
- [ ] ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
- [ ] ç”¨æˆ·åªèƒ½æœç´¢è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
- [ ] å°è¯•è®¿é—®å…¶ä»–ç”¨æˆ·çš„çŸ¥è¯†åº“IDåº”è¯¥è¿”å›404

## ç›¸å…³æ–‡æ¡£

- `âœ…çŸ¥è¯†åº“å¤šç§Ÿæˆ·éš”ç¦»ä¿®å¤å®Œæˆ.md` - è¯¦ç»†ä¿®å¤è¯´æ˜
- `fix-knowledge-base-update.patch` - UPDATEè·¯ç”±ä¿®å¤è¡¥ä¸
- `server/src/routes/knowledgeBase.ts` - éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

---

**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**å®‰å…¨ç­‰çº§**: ğŸ”´ é«˜å±  
**ä¿®å¤æ—¶é—´**: çº¦10åˆ†é’Ÿ  
**å½±å“èŒƒå›´**: çŸ¥è¯†åº“åŠŸèƒ½

**è¯·ç«‹å³ä¿®å¤ä»¥ç¡®ä¿æ•°æ®å®‰å…¨ï¼**
