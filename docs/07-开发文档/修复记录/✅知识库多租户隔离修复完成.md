# âœ… çŸ¥è¯†åº“å¤šç§Ÿæˆ·éš”ç¦»ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ Windows ç«¯åˆ›å»ºçŸ¥è¯†åº“"è£…ä¿®"åŽï¼Œä¸Šä¼ æ–‡ä»¶æ—¶æç¤ºæ— æ³•ä¸Šä¼ ã€‚

## é—®é¢˜åˆ†æž

ç»è¿‡æ£€æŸ¥å‘çŽ°çŸ¥è¯†åº“è·¯ç”±å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### 1. UPDATEè·¯ç”±ç¼ºå°‘æƒé™éªŒè¯ âŒ
```typescript
// æ—§ä»£ç  - æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ
const checkResult = await pool.query('SELECT id FROM knowledge_bases WHERE id = $1', [kbId]);
```

### 2. UPDATEè·¯ç”±å­˜åœ¨SQLæ³¨å…¥æ¼æ´ž âŒ
```typescript
// æ—§ä»£ç  - ç¼ºå°‘ $ ç¬¦å·
updates.push(`name = ${paramIndex++}`);  // åº”è¯¥æ˜¯ $${paramIndex++}
```

### 3. èŽ·å–æ–‡æ¡£è¯¦æƒ…æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ âŒ
```typescript
// æ—§ä»£ç  - ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä»»ä½•æ–‡æ¡£
const result = await pool.query(
  'SELECT * FROM knowledge_documents WHERE id = $1',
  [docId]
);
```

### 4. åˆ é™¤æ–‡æ¡£æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ âŒ
```typescript
// æ—§ä»£ç  - ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ é™¤ä»»ä½•æ–‡æ¡£
await pool.query('DELETE FROM knowledge_documents WHERE id = $1', [docId]);
```

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤UPDATEè·¯ç”± âœ…

**æ·»åŠ æƒé™éªŒè¯**:
```typescript
const userId = getCurrentTenantId(req);
const checkResult = await pool.query(
  'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
  [kbId, userId]
);
```

**ä¿®å¤SQLæ³¨å…¥æ¼æ´ž**:
```typescript
updates.push(`name = $${paramIndex++}`);  // æ·»åŠ  $ ç¬¦å·
updates.push(`description = $${paramIndex++}`);
```

**æ·»åŠ ç”¨æˆ·éªŒè¯åˆ°UPDATEè¯­å¥**:
```typescript
const result = await pool.query(
  `UPDATE knowledge_bases 
   SET ${updates.join(', ')} 
   WHERE id = $${paramIndex} AND user_id = $${paramIndex + 1}
   RETURNING id, name, description, updated_at`,
  values
);
```

### 2. ä¿®å¤èŽ·å–æ–‡æ¡£è¯¦æƒ… âœ…

```typescript
const userId = getCurrentTenantId(req);
const result = await pool.query(
  `SELECT kd.* 
   FROM knowledge_documents kd
   JOIN knowledge_bases kb ON kd.knowledge_base_id = kb.id
   WHERE kd.id = $1 AND kb.user_id = $2`,
  [docId, userId]
);
```

### 3. ä¿®å¤åˆ é™¤æ–‡æ¡£ âœ…

```typescript
const userId = getCurrentTenantId(req);
const result = await pool.query(
  `DELETE FROM knowledge_documents kd
   USING knowledge_bases kb
   WHERE kd.knowledge_base_id = kb.id
     AND kd.id = $1
     AND kb.user_id = $2
   RETURNING kd.id`,
  [docId, userId]
);
```

## ä¿®å¤çŠ¶æ€

| è·¯ç”± | é—®é¢˜ | çŠ¶æ€ |
|------|------|------|
| GET / | âœ… å·²æœ‰æƒé™éªŒè¯ | æ­£å¸¸ |
| POST / | âœ… å·²æœ‰æƒé™éªŒè¯ | æ­£å¸¸ |
| GET /:id | âœ… å·²æœ‰æƒé™éªŒè¯ | æ­£å¸¸ |
| PATCH /:id | âŒ ç¼ºå°‘æƒé™éªŒè¯ + SQLæ³¨å…¥ | âš ï¸ éœ€è¦æ‰‹åŠ¨ä¿®å¤ |
| DELETE /:id | âœ… å·²æœ‰æƒé™éªŒè¯ | æ­£å¸¸ |
| POST /:id/documents | âœ… å·²æœ‰æƒé™éªŒè¯ | æ­£å¸¸ |
| GET /documents/:id | âŒ ç¼ºå°‘æƒé™éªŒè¯ | âœ… å·²ä¿®å¤ |
| DELETE /documents/:id | âŒ ç¼ºå°‘æƒé™éªŒè¯ | âœ… å·²ä¿®å¤ |
| GET /:id/documents/search | âš ï¸ éœ€è¦æ·»åŠ æƒé™éªŒè¯ | âš ï¸ å¾…ä¿®å¤ |

## éœ€è¦æ‰‹åŠ¨ä¿®å¤çš„ä»£ç 

### ä¿®å¤ UPDATE è·¯ç”±

åœ¨ `server/src/routes/knowledgeBase.ts` ç¬¬157-204è¡Œï¼Œæ›¿æ¢ä¸ºï¼š

```typescript
// æ›´æ–°çŸ¥è¯†åº“ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
knowledgeBaseRouter.patch('/:id', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const kbId = parseInt(req.params.id);
    if (isNaN(kbId) || kbId <= 0) {
      return res.status(400).json({ error: 'æ— æ•ˆçš„çŸ¥è¯†åº“ID' });
    }
    
    const validatedData = updateKnowledgeBaseSchema.parse(req.body);
    
    // æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦å­˜åœ¨ä¸”å±žäºŽå½“å‰ç”¨æˆ·
    const checkResult = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
      [kbId, userId]
    );
    if (checkResult.rows.length === 0) {
      return res.status(404).json({ error: 'çŸ¥è¯†åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®' });
    }
    
    // æž„å»ºæ›´æ–°è¯­å¥
    const updates: string[] = [];
    const values: any[] = [];
    let paramIndex = 1;
    
    if (validatedData.name !== undefined) {
      updates.push(`name = $${paramIndex++}`);
      values.push(validatedData.name);
    }
    
    if (validatedData.description !== undefined) {
      updates.push(`description = $${paramIndex++}`);
      values.push(validatedData.description);
    }
    
    updates.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(kbId);
    values.push(userId);
    
    const result = await pool.query(
      `UPDATE knowledge_bases 
       SET ${updates.join(', ')} 
       WHERE id = $${paramIndex} AND user_id = $${paramIndex + 1}
       RETURNING id, name, description, updated_at`,
      values
    );
    
    res.json(result.rows[0]);
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ error: 'æ•°æ®éªŒè¯å¤±è´¥', details: error.errors });
    }
    console.error('æ›´æ–°çŸ¥è¯†åº“é”™è¯¯:', error);
    res.status(500).json({ error: 'æ›´æ–°çŸ¥è¯†åº“å¤±è´¥', details: error.message });
  }
});
```

### ä¿®å¤æœç´¢æ–‡æ¡£è·¯ç”±

åœ¨ `server/src/routes/knowledgeBase.ts` ç¬¬430è¡Œå·¦å³ï¼Œæ·»åŠ æƒé™éªŒè¯ï¼š

```typescript
// æœç´¢æ–‡æ¡£ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
knowledgeBaseRouter.get('/:id/documents/search', async (req, res) => {
  try {
    const userId = getCurrentTenantId(req);
    const kbId = parseInt(req.params.id);
    const query = req.query.q as string;
    
    if (isNaN(kbId) || kbId <= 0) {
      return res.status(400).json({ error: 'æ— æ•ˆçš„çŸ¥è¯†åº“ID' });
    }
    
    if (!query || query.trim().length === 0) {
      return res.status(400).json({ error: 'è¯·æä¾›æœç´¢å…³é”®è¯' });
    }
    
    // éªŒè¯çŸ¥è¯†åº“æ‰€æœ‰æƒ
    const kbCheck = await pool.query(
      'SELECT id FROM knowledge_bases WHERE id = $1 AND user_id = $2',
      [kbId, userId]
    );
    
    if (kbCheck.rows.length === 0) {
      return res.status(404).json({ error: 'çŸ¥è¯†åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®' });
    }
    
    // ä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢
    const result = await pool.query(
      `SELECT id, filename, file_type, file_size, 
              LEFT(content, 200) as content_preview,
              created_at
       FROM knowledge_documents
       WHERE knowledge_base_id = $1 
         AND (filename ILIKE $2 OR content ILIKE $2)
       ORDER BY created_at DESC
       LIMIT 50`,
      [kbId, `%${query}%`]
    );
    
    res.json({ documents: result.rows });
  } catch (error: any) {
    console.error('æœç´¢æ–‡æ¡£é”™è¯¯:', error);
    res.status(500).json({ error: 'æœç´¢æ–‡æ¡£å¤±è´¥', details: error.message });
  }
});
```

## éªŒè¯æµ‹è¯•

ä¿®å¤åŽéœ€è¦æµ‹è¯•ï¼š

1. âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„çŸ¥è¯†åº“
2. âœ… ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„çŸ¥è¯†åº“
3. âœ… ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„çŸ¥è¯†åº“
4. âœ… ç”¨æˆ·åªèƒ½ä¸Šä¼ æ–‡æ¡£åˆ°è‡ªå·±çš„çŸ¥è¯†åº“
5. âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
6. âœ… ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£
7. âœ… ç”¨æˆ·åªèƒ½æœç´¢è‡ªå·±çŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£

## ç›¸å…³æ–‡ä»¶

- `server/src/routes/knowledgeBase.ts` - çŸ¥è¯†åº“è·¯ç”±ï¼ˆéœ€è¦æ‰‹åŠ¨ä¿®å¤ï¼‰
- `fix-knowledge-base-update.patch` - UPDATEè·¯ç”±ä¿®å¤è¡¥ä¸

## æ³¨æ„äº‹é¡¹

1. ä¿®å¤åŽéœ€è¦é‡å¯æœåŠ¡å™¨
2. å»ºè®®æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æƒé™éš”ç¦»
3. å‰ç«¯éœ€è¦æ­£ç¡®å¤„ç†403/404é”™è¯¯

---

**ä¿®å¤æ—¶é—´**: 2025-12-30  
**ä¿®å¤çŠ¶æ€**: âš ï¸ éƒ¨åˆ†å®Œæˆï¼ˆéœ€è¦æ‰‹åŠ¨ä¿®å¤UPDATEå’Œæœç´¢è·¯ç”±ï¼‰  
**å®‰å…¨ç­‰çº§**: ðŸ”´ é«˜å±ï¼ˆå­˜åœ¨æƒé™ç»•è¿‡å’ŒSQLæ³¨å…¥æ¼æ´žï¼‰
