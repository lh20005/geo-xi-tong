# âœ… å®Œæ•´æ”¯ä»˜æµ‹è¯•æŒ‡å— - æ‰€æœ‰é—®é¢˜å·²è§£å†³

## ğŸ¯ é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: æœåŠ¡å™¨å¯åŠ¨å´©æºƒ
**åŸå› :** `wechatpay-axios-plugin` åˆå§‹åŒ–æ—¶è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ API éªŒè¯è¯ä¹¦ï¼Œè¿”å› 404 å¯¼è‡´å´©æºƒ

**è§£å†³æ–¹æ¡ˆ:** 
- å»¶è¿Ÿåˆå§‹åŒ–å¾®ä¿¡æ”¯ä»˜æœåŠ¡
- åªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆå§‹åŒ–
- æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢å´©æºƒ

### é—®é¢˜ 2: CORS è·¨åŸŸé”™è¯¯
**åŸå› :** ç¯å¢ƒå˜é‡é…ç½®åœ¨é”™è¯¯çš„æ–‡ä»¶ä¸­ï¼ˆæ ¹ç›®å½• vs server ç›®å½•ï¼‰

**è§£å†³æ–¹æ¡ˆ:**
- åˆ é™¤æ ¹ç›®å½•çš„ `.env`
- ç»Ÿä¸€ä½¿ç”¨ `server/.env`
- ä¿®æ”¹æ‰€æœ‰è¯»å–ç¯å¢ƒå˜é‡çš„ä»£ç è·¯å¾„

### é—®é¢˜ 3: å‰ç«¯æ— æ³•è¿æ¥åç«¯ API
**åŸå› :** é€šè¿‡ ngrok è®¿é—®æ—¶ï¼Œå‰ç«¯å°è¯•è¿æ¥ `localhost:3000`

**è§£å†³æ–¹æ¡ˆ:**
- æ„å»º landing é¡µé¢é™æ€æ–‡ä»¶
- åç«¯æä¾›é™æ€æ–‡ä»¶æœåŠ¡
- å‰ç«¯è‡ªåŠ¨æ£€æµ‹ ngrok ç¯å¢ƒå¹¶ä½¿ç”¨æ­£ç¡®çš„ API åœ°å€

---

## âœ… å½“å‰é…ç½®çŠ¶æ€

### 1. ç¯å¢ƒå˜é‡ (server/.env)
```env
# æ•°æ®åº“
DATABASE_URL=postgresql://lzc@localhost:5432/geo_system

# ç®¡ç†å‘˜è´¦å·
ADMIN_USERNAME=lzc2005
ADMIN_PASSWORD=Woshixiaogou2005

# CORS é…ç½®
ALLOWED_ORIGINS=http://localhost,http://localhost:5173,http://localhost:5174,http://localhost:8080,https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev

# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_PAY_APP_ID=wx_your_app_id_here
WECHAT_PAY_MCH_ID=your_merchant_id
WECHAT_PAY_API_V3_KEY=your_32_character_api_v3_key_here
WECHAT_PAY_SERIAL_NO=your_certificate_serial_number_here
WECHAT_PAY_PRIVATE_KEY_PATH=/Users/lzc/.wechat-pay/apiclient_key.pem
WECHAT_PAY_NOTIFY_URL=https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/payment/wechat/notify
```

### 2. å¾®ä¿¡æ”¯ä»˜é…ç½®ï¼ˆå…¬é’¥æ¨¡å¼ï¼‰
- å•†æˆ·ç§é’¥: `/Users/lzc/.wechat-pay/apiclient_key.pem`
- è¯ä¹¦åºåˆ—å·: `your_certificate_serial_number_here`
- **æ³¨æ„ï¼š** ä½¿ç”¨å…¬é’¥æ¨¡å¼ï¼Œä¸éœ€è¦ä¸‹è½½å¹³å°è¯ä¹¦ã€‚è¯¦è§å®˜æ–¹æ–‡æ¡£ï¼šhttps://pay.weixin.qq.com/doc/v3/partner/4012925323

### 3. æœåŠ¡çŠ¶æ€
- âœ… åç«¯æœåŠ¡è¿è¡Œä¸­ (ç«¯å£ 3000)
- âœ… Landing é™æ€æ–‡ä»¶å·²æ„å»º
- âœ… ngrok éš§é“è¿è¡Œä¸­
- âœ… CORS é…ç½®æ­£ç¡®
- âœ… å¾®ä¿¡æ”¯ä»˜å·²é…ç½®

---

## ğŸš€ å®Œæ•´æµ‹è¯•æµç¨‹

### æ­¥éª¤ 1: ç¡®è®¤æ‰€æœ‰æœåŠ¡è¿è¡Œ

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:3000/api/health

# æ£€æŸ¥ ngrok
ps aux | grep ngrok

# æŸ¥çœ‹ ngrok æ§åˆ¶å°
open http://localhost:4040
```

### æ­¥éª¤ 2: è®¿é—® ngrok åœ°å€

```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
```

**é¦–æ¬¡è®¿é—®æç¤º:**
- ngrok å…è´¹ç‰ˆä¼šæ˜¾ç¤ºè­¦å‘Šé¡µé¢
- ç‚¹å‡» **"Visit Site"** æŒ‰é’®ç»§ç»­

### æ­¥éª¤ 3: ç™»å½•ç³»ç»Ÿ

**ç™»å½•ä¿¡æ¯:**
- ç”¨æˆ·å: `lzc2005`
- å¯†ç : `Woshixiaogou2005`

### æ­¥éª¤ 4: æµ‹è¯•æ”¯ä»˜æµç¨‹

1. **é€‰æ‹©å¥—é¤** - ç‚¹å‡»ä»»æ„å¥—é¤çš„"ç«‹å³è´­ä¹°"æŒ‰é’®
2. **æŸ¥çœ‹äºŒç»´ç ** - æ”¯ä»˜å¼¹çª—åº”è¯¥æ˜¾ç¤ºäºŒç»´ç 
3. **å¾®ä¿¡æ‰«ç ** - ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç 
4. **å®Œæˆæ”¯ä»˜** - åœ¨å¾®ä¿¡ä¸­å®Œæˆæ”¯ä»˜
5. **éªŒè¯å›è°ƒ** - é¡µé¢åº”è¯¥è‡ªåŠ¨æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸå¹¶è·³è½¬

---

## ğŸ” éªŒè¯æµ‹è¯•ç»“æœ

### å‰ç«¯éªŒè¯
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[Landing Config] ç¯å¢ƒ: {
  hostname: "granolithic-pseudoprosperous-rebeca.ngrok-free.dev",
  isNgrok: true,
  apiUrl: "https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api"
}
```

### åç«¯éªŒè¯
æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ… æä¾› Landing é¡µé¢é™æ€æ–‡ä»¶æœåŠ¡
ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3000
```

æ”¯ä»˜æˆåŠŸååº”è¯¥çœ‹åˆ°ï¼š

```
[å¾®ä¿¡æ”¯ä»˜] æ”¶åˆ°æ”¯ä»˜å›è°ƒ
âœ… è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ: paid
```

### æ•°æ®åº“éªŒè¯

```bash
psql -U lzc -d geo_system -c "SELECT order_no, status, amount, plan_id FROM orders ORDER BY created_at DESC LIMIT 5;"
```

åº”è¯¥çœ‹åˆ°è®¢å•çŠ¶æ€ä¸º `paid`

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: è®¿é—® ngrok åœ°å€æ˜¾ç¤ºç©ºç™½é¡µ

**æ£€æŸ¥:**
```bash
# 1. ç¡®è®¤ landing å·²æ„å»º
ls -la landing/dist/

# 2. é‡æ–°æ„å»º
cd landing && npm run build

# 3. é‡å¯åç«¯
# åœæ­¢å¹¶é‡æ–°å¯åŠ¨ server
```

### Q2: å‰ç«¯æ˜¾ç¤º "ERR_CONNECTION_REFUSED"

**åŸå› :** å‰ç«¯é…ç½®é”™è¯¯ï¼Œä»åœ¨å°è¯•è¿æ¥ localhost

**è§£å†³:**
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ `[Landing Config]` æ—¥å¿—
3. ç¡®è®¤ `apiUrl` æ˜¯å¦æ­£ç¡®æŒ‡å‘ ngrok åŸŸå

### Q3: æ”¯ä»˜åé¡µé¢æ²¡æœ‰è·³è½¬

**æ£€æŸ¥:**
1. åç«¯æ—¥å¿—æ˜¯å¦æ”¶åˆ°æ”¯ä»˜å›è°ƒ
2. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. è®¢å•çŠ¶æ€æ˜¯å¦æ›´æ–°ä¸º `paid`

```bash
# æŸ¥çœ‹è®¢å•çŠ¶æ€
psql -U lzc -d geo_system -c "SELECT order_no, status FROM orders WHERE order_no = 'ORDè®¢å•å·';"
```

### Q4: åˆ›å»ºè®¢å•å¤±è´¥

**å¯èƒ½åŸå› :**
1. å¾®ä¿¡æ”¯ä»˜é…ç½®é”™è¯¯
2. è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨
3. å…¬é’¥ ID ä¸æ­£ç¡®

**æ£€æŸ¥:**
```bash
# 1. æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
ls -la ~/.wechat-pay/

# 2. æŸ¥çœ‹åç«¯æ—¥å¿—
# åº”è¯¥çœ‹åˆ°å¾®ä¿¡æ”¯ä»˜åˆå§‹åŒ–æˆåŠŸçš„æ¶ˆæ¯
```

---

## ğŸ“ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Landing é¡µé¢ç¯å¢ƒæ£€æµ‹

```typescript
// landing/src/config/env.ts
const detectEnvironment = () => {
  const hostname = window.location.hostname;
  const isNgrok = hostname.includes('ngrok');
  
  return { isNgrok, ... };
};

// ngrok ç¯å¢ƒé…ç½®
ngrok: {
  apiUrl: `${window.location.protocol}//${window.location.host}/api`,
  environment: 'ngrok'
}
```

### 2. åç«¯é™æ€æ–‡ä»¶æœåŠ¡

```typescript
// server/src/index.ts
const landingDistPath = path.join(__dirname, '../../landing/dist');
if (fs.existsSync(landingDistPath)) {
  app.use(express.static(landingDistPath));
  
  // SPA è·¯ç”±æ”¯æŒ
  app.get('*', (req, res) => {
    if (!req.path.startsWith('/api')) {
      res.sendFile(path.join(landingDistPath, 'index.html'));
    }
  });
}
```

### 3. å¾®ä¿¡æ”¯ä»˜å»¶è¿Ÿåˆå§‹åŒ–

```typescript
// server/src/services/PaymentService.ts
private ensureInitialized() {
  if (!this.initialized) {
    try {
      this.initializeWeChatPay();
      this.initialized = true;
    } catch (error) {
      this.initializationError = error;
      throw new Error('å¾®ä¿¡æ”¯ä»˜æœåŠ¡åˆå§‹åŒ–å¤±è´¥');
    }
  }
}
```

---

## ğŸ‰ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] ngrok éš§é“è¿è¡Œä¸­
- [ ] Landing é¡µé¢å·²æ„å»º
- [ ] å¯ä»¥è®¿é—® ngrok åœ°å€
- [ ] å¯ä»¥æˆåŠŸç™»å½•
- [ ] å¯ä»¥çœ‹åˆ°å¥—é¤åˆ—è¡¨
- [ ] ç‚¹å‡»è´­ä¹°æ˜¾ç¤ºäºŒç»´ç 
- [ ] å¾®ä¿¡æ‰«ç å¯ä»¥æ‰“å¼€æ”¯ä»˜é¡µé¢
- [ ] æ”¯ä»˜æˆåŠŸåé¡µé¢è‡ªåŠ¨è·³è½¬
- [ ] è®¢å•çŠ¶æ€æ›´æ–°ä¸º paid
- [ ] åç«¯æ”¶åˆ°æ”¯ä»˜å›è°ƒ

---

## ğŸ”„ æ›´æ–° ngrok åœ°å€

å½“ ngrok é‡å¯ååŸŸåæ”¹å˜æ—¶ï¼š

### 1. æ›´æ–°ç¯å¢ƒå˜é‡

ç¼–è¾‘ `server/.env`:
```env
ALLOWED_ORIGINS=http://localhost,http://localhost:5173,http://localhost:5174,http://localhost:8080,https://æ–°çš„ngrokåŸŸå.ngrok-free.dev
WECHAT_PAY_NOTIFY_URL=https://æ–°çš„ngrokåŸŸå.ngrok-free.dev/api/payment/wechat/notify
```

### 2. é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢ç°æœ‰æœåŠ¡
pkill -f "tsx.*src/index.ts"

# é‡æ–°å¯åŠ¨
cd server
npm run dev
```

### 3. é‡æ–°æ„å»º Landing (å¯é€‰)

å¦‚æœå‰ç«¯é…ç½®æœ‰ç¼“å­˜é—®é¢˜ï¼š
```bash
cd landing
npm run build
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹åç«¯æ—¥å¿—** - æ£€æŸ¥æœåŠ¡å™¨è¾“å‡º
2. **æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°** - æ£€æŸ¥å‰ç«¯é”™è¯¯
3. **æŸ¥çœ‹ ngrok æ§åˆ¶å°** - http://localhost:4040
4. **æ£€æŸ¥æ•°æ®åº“** - æŸ¥çœ‹è®¢å•çŠ¶æ€

**å¿«é€Ÿè¯Šæ–­å‘½ä»¤:**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3000/api/health

# æ£€æŸ¥ ngrok
curl -I https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/

# æŸ¥çœ‹æœ€æ–°è®¢å•
psql -U lzc -d geo_system -c "SELECT * FROM orders ORDER BY created_at DESC LIMIT 1;"
```

---

## ğŸ¯ æ€»ç»“

âœ… æ‰€æœ‰é…ç½®é—®é¢˜å·²è§£å†³  
âœ… æœåŠ¡å™¨ç¨³å®šè¿è¡Œ  
âœ… å‰ç«¯å¯ä»¥æ­£ç¡®è¿æ¥åç«¯  
âœ… CORS é…ç½®æ­£ç¡®  
âœ… å¾®ä¿¡æ”¯ä»˜å·²é…ç½®  
âœ… å¯ä»¥é€šè¿‡ ngrok å®Œæ•´æµ‹è¯•æ”¯ä»˜æµç¨‹  

**ç°åœ¨å¯ä»¥å¼€å§‹å®Œæ•´çš„æ”¯ä»˜æµ‹è¯•äº†ï¼** ğŸš€
