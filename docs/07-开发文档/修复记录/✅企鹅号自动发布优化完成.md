# ✅ 企鹅号自动发布功能优化完成

## 完成时间
2024-12-31

## 优化内容

### 1. 基于真实录制脚本重构
- 使用 Chrome DevTools Recorder 录制的真实流程
- 更新所有选择器为实际可用的选择器
- 完整还原企鹅号发布的每一个步骤

### 2. 精确的选择器配置

```typescript
// 标题输入框
titleInput: 'div.omui-articletitle__title1 span'

// 内容编辑器
contentEditor: 'section.editor_container-cls1yCMh > div'

// 发布按钮
publishButton: 'li:nth-of-type(2) span'
```

### 3. 人性化时间间隔

#### 随机延迟函数
```typescript
private async humanDelay(min: number = 800, max: number = 1500): Promise<void> {
  const delay = Math.floor(Math.random() * (max - min + 1)) + min;
  await new Promise(resolve => setTimeout(resolve, delay));
}
```

#### 模拟人类打字
```typescript
private async humanType(page: Page, selector: string, text: string): Promise<void> {
  // 逐字输入，每个字符 40-120ms
  for (const char of text) {
    await page.keyboard.type(char, { delay: Math.random() * 80 + 40 });
  }
}
```

### 4. 完整的发布流程

#### 步骤1: 进入主页 (2-3秒)
```typescript
await page.goto('https://om.qq.com/main');
await this.humanDelay(2000, 3000);
```

#### 步骤2: 点击"开始创作" (2-3秒)
```typescript
const createButton = await page.waitForSelector('div.hello-clsnTcoH > button');
await createButton.click();
await this.humanDelay(2000, 3000);
```

#### 步骤3: 填写标题 (1-1.5秒准备 + 打字时间)
```typescript
await page.waitForSelector(selectors.titleInput);
await this.humanDelay(1000, 1500);
await this.humanType(page, selectors.titleInput, title);
await this.humanDelay(1500, 2500);
```

#### 步骤4: 点击编辑器 (0.8-1.2秒 + 1-1.5秒)
```typescript
await contentEditor.click();
await this.humanDelay(1000, 1500);
```

#### 步骤5: 输入正文 (分段输入，段落间0.3-0.6秒)
```typescript
const paragraphs = textOnly.split('\n\n');
for (const para of paragraphs) {
  await page.keyboard.type(para, { delay: 20-50ms per char });
  await page.keyboard.press('Enter');
  await this.humanDelay(300, 600);
}
```

#### 步骤6: 上传图片 (每张图片3-4秒)
```typescript
await uploadButton.click();
await this.humanDelay(1500, 2500);
await fileInput.uploadFile(imagePath);
await this.humanDelay(3000, 4000);
```

#### 步骤7: 设置封面图 (1-2秒准备 + 上传时间)
```typescript
await coverButton.click();
await this.humanDelay(1500, 2500);
await localUploadTab.click();
await this.humanDelay(1000, 1500);
await coverFileInput.uploadFile(imagePaths[0]);
await this.humanDelay(2000, 3000);
```

#### 步骤8: 添加内容声明 (1-1.5秒 + 1-1.5秒)
```typescript
await declarationButton.click();
await this.humanDelay(1500, 2500);
await confirmButton.click();
await this.humanDelay(1000, 1500);
```

#### 步骤9: 发布文章 (2-3秒准备 + 3-4秒等待)
```typescript
await this.humanDelay(2000, 3000);
await publishButton.click();
await this.humanDelay(3000, 4000);
```

## 时间间隔设计原则

### 1. 页面加载和导航
- **2-3秒**: 页面跳转后等待
- 模拟人类观察页面的时间

### 2. 按钮点击
- **1-2.5秒**: 点击前思考时间
- **1.5-2.5秒**: 点击后等待响应
- 模拟人类寻找和点击按钮的过程

### 3. 文字输入
- **40-120ms/字符**: 打字速度
- **300-600ms**: 段落间停顿
- 模拟真实的打字节奏

### 4. 文件上传
- **3-4秒**: 上传后等待处理
- 考虑网络传输和服务器处理时间

### 5. 表单操作
- **0.8-1.5秒**: 字段间切换
- **1-2秒**: 提交前检查
- 模拟人类填写表单的习惯

## 关键特性

### 1. 动态内容处理
- 自动提取文章标题
- 自动清理 Markdown 格式
- 自动提取图片路径
- 分段输入正文内容

### 2. 智能图片上传
- 从 Markdown 中提取图片
- 支持相对路径和绝对路径
- 自动上传到编辑器
- 第一张图片作为封面

### 3. 完整的错误处理
- 每个步骤都有 try-catch
- 详细的日志输出
- 失败时继续执行后续步骤

### 4. Cookie 登录支持
- 优先使用 Cookie 登录
- Cookie 失败时降级到表单登录
- 自动验证登录状态

## 测试建议

### 1. 准备测试数据
```bash
# 创建测试图片
mkdir -p server/uploads
# 放入测试图片文件
```

### 2. 测试不同场景
- 纯文字文章
- 带1张图片的文章
- 带多张图片的文章
- 长文章（1000字以上）
- 短文章（200字以内）

### 3. 观察时间间隔
- 检查是否自然流畅
- 确认没有过快或过慢
- 验证不会触发反爬虫机制

## 文件位置
- 适配器: `server/src/services/adapters/QieAdapter.ts`
- 测试脚本: `test-qie-publish.sh`

## 下一步
1. 在测试环境中验证发布流程
2. 调整时间间隔以获得最佳效果
3. 收集实际使用反馈
4. 根据企鹅号平台更新调整选择器

## 注意事项
1. 企鹅号可能会更新页面结构，需要定期检查选择器
2. 建议使用 Cookie 登录以提高成功率
3. 图片文件必须存在于服务器本地
4. 发布前确保账号已登录且有发布权限

---

**状态**: ✅ 已完成
**测试状态**: 待测试
**优先级**: 高
