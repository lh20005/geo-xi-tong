# 数据库表分类说明

## 📊 服务器 66 个表的分类

### 🎯 迁移策略

服务器的 66 个表按照功能分为两类：

1. **用户业务数据表**（17 个）→ 迁移到 Windows 端
2. **系统管理表**（49 个）→ 保留在服务器

### ❓ 为什么 66 个表只迁移 17 个？

**简单回答**: 因为 49 个表是**系统管理功能**，必须在服务器端统一管理，不能分散到每个客户端。

**详细解释**:

这 49 个表负责：
- 🔐 **用户认证**（5 个表）- 登录、密码、会话管理
- 💰 **订阅支付**（5 个表）- 套餐、订单、微信支付
- 📊 **配额管理**（6 个表）- 配额预扣减、使用量统计
- 🔐 **权限安全**（10 个表）- 权限控制、安全审计
- 📝 **审计日志**（4 个表）- 系统审计、合规要求
- ⚙️ **系统配置**（6 个表）- API 配置、平台配置
- 💼 **代理商系统**（2 个表）- 佣金、分润
- 🤖 **AI 生成管理**（2 个表）- AI 任务队列、统计
- 🔄 **数据同步**（2 个表）- 云端同步管理
- 💾 **存储管理**（4 个表）- 存储配额、计费
- 其他（3 个表）- 适配器版本、迁移记录等

**如果这些表也迁移到客户端会怎样？**
- ❌ 用户可以篡改配额（无限使用）
- ❌ 用户可以绕过支付（免费使用）
- ❌ 无法统一管理权限和安全
- ❌ 无法进行系统审计
- ❌ 多设备数据不一致

**所以**:
- ✅ 17 个表 = 用户的**内容数据**（文章、图片、知识库等）→ 本地存储，离线可用
- ✅ 49 个表 = 系统的**管理数据**（认证、配额、支付等）→ 服务器管理，安全可控

---

## ✅ 迁移到 Windows 端的表（17 个）

这些表存储**用户创建的内容和配置**，需要在本地访问和编辑：

### 核心内容表（9 个）
1. `articles` - 用户生成的文章
2. `albums` - 用户的图片相册
3. `images` - 用户上传的图片
4. `knowledge_bases` - 用户的知识库
5. `knowledge_documents` - 知识库中的文档
6. `platform_accounts` - 用户的平台账号（Cookie）
7. `conversion_targets` - 用户的转化目标
8. `article_settings` - 用户的文章设置
9. `distillation_config` - 用户的蒸馏配置

### 发布相关表（3 个）
10. `publishing_tasks` - 用户的发布任务
11. `publishing_records` - 发布记录
12. `publishing_logs` - 发布日志

### 蒸馏相关表（2 个）
13. `distillations` - 蒸馏记录
14. `topics` - 话题

### 使用追踪表（3 个）
15. `image_usage` - 图片使用追踪
16. `distillation_usage` - 蒸馏使用追踪
17. `topic_usage` - 话题使用追踪

**为什么迁移？**
- ✅ 用户需要离线访问和编辑
- ✅ 本地浏览器自动化需要读取（如平台账号）
- ✅ 本地发布执行需要读取（如发布任务）
- ✅ 数据隐私（如平台 Cookie）

---

## 🔒 保留在服务器的表（49 个）

这些表用于**系统管理、权限控制、配额管理**，必须在服务器端：

### 用户管理（5 个）
1. `users` - 用户账号
2. `user_sessions` - 用户会话
3. `refresh_tokens` - 刷新令牌
4. `verification_codes` - 验证码
5. `login_attempts` - 登录尝试记录

**为什么保留？**
- 🔐 用户认证必须在服务器端
- 🔐 密码哈希存储在服务器
- 🔐 多设备登录管理

### 订阅和支付（5 个）
6. `subscription_plans` - 订阅套餐
7. `user_subscriptions` - 用户订阅
8. `orders` - 订单
9. `subscription_adjustments` - 订阅调整
10. `plan_features` - 套餐功能

**为什么保留？**
- 💰 支付处理在服务器端
- 💰 订阅状态统一管理
- 💰 防止客户端篡改

### 配额管理（6 个）
11. `quota_configs` - 配额配置
12. `quota_reservations` - 配额预留（⚠️ AI 生成时使用）
13. `quota_alerts` - 配额警告
14. `quota_audit_logs` - 配额审计日志
15. `user_usage` - 用户使用量
16. `usage_records` - 使用记录

**为什么保留？**
- 📊 配额必须在服务器端统一管理
- 📊 防止客户端绕过配额限制
- 📊 AI 生成时的配额预扣减在服务器

### 存储管理（4 个）
17. `storage_purchases` - 存储购买
18. `storage_transactions` - 存储交易
19. `user_storage_usage` - 用户存储使用
20. `storage_usage_history` - 存储使用历史

**为什么保留？**
- 💾 存储配额管理
- 💾 存储计费

### 权限和安全（10 个）
21. `permissions` - 权限定义
22. `user_permissions` - 用户权限
23. `agents` - 代理商
24. `agent_audit_logs` - 代理商审计
25. `security_config` - 安全配置
26. `security_events` - 安全事件
27. `security_alerts` - 安全警告
28. `encryption_keys` - 加密密钥
29. `ip_whitelist` - IP 白名单
30. `password_history` - 密码历史

**为什么保留？**
- 🔐 权限控制必须在服务器端
- 🔐 安全审计
- 🔐 密钥管理

### 审计日志（4 个）
31. `audit_logs` - 审计日志
32. `admin_logs` - 管理员日志
33. `auth_logs` - 认证日志
34. `admin_quota_modifications` - 管理员配额修改

**为什么保留？**
- 📝 系统审计
- 📝 合规要求

### 系统配置（6 个）
35. `api_configs` - API 配置
36. `system_api_configs` - 系统 API 配置
37. `platforms_config` - 平台配置
38. `config_history` - 配置历史
39. `product_config_history` - 产品配置历史
40. `security_config_history` - 安全配置历史

**为什么保留？**
- ⚙️ 系统级配置
- ⚙️ 配置版本管理

### 代理商系统（2 个）
41. `commission_records` - 佣金记录
42. `profit_sharing_records` - 分润记录

**为什么保留？**
- 💼 代理商管理
- 💼 财务结算

### AI 生成管理（2 个）
43. `generation_tasks` - AI 生成任务队列（⚠️ 服务器端管理）
44. `publish_analytics` - 发布分析

**为什么保留？**
- 🤖 AI 生成任务在服务器端执行
- 🤖 统计分析

### 数据同步（2 个）
45. `sync_snapshots` - 同步快照
46. `publish_records` - 发布记录（旧表）

**为什么保留？**
- 🔄 云端同步管理

### 其他（3 个）
47. `adapter_versions` - 适配器版本
48. `schema_migrations` - 数据库迁移记录
49. `user_booster_quotas` - 用户加速配额

---

## 🔑 关键理解

### 数据分离原则

```
┌─────────────────────────────────────────────────────────┐
│              Windows 端（本地 PostgreSQL）                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  用户业务数据（17 个表）                           │   │
│  │  - 文章、图库、知识库                              │   │
│  │  - 平台账号（Cookie）                              │   │
│  │  - 发布任务和记录                                  │   │
│  │  - 蒸馏和话题                                      │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↕️ API 调用
┌─────────────────────────────────────────────────────────┐
│              服务器端（PostgreSQL）                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  系统管理数据（49 个表）                           │   │
│  │  - 用户账号和认证                                  │   │
│  │  - 订阅和支付                                      │   │
│  │  - 配额管理（⚠️ AI 生成配额）                      │   │
│  │  - 权限和安全                                      │   │
│  │  - 审计日志                                        │   │
│  │  - AI 生成任务队列                                 │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 工作流程示例

**AI 生成文章**:
1. Windows 端发起请求 → 服务器
2. 服务器检查配额（`quota_configs`, `user_subscriptions`）
3. 服务器预扣减配额（`quota_reservations`）
4. 服务器调用 AI API（DeepSeek/Gemini）
5. 服务器返回文章 → Windows 端
6. Windows 端保存到本地 `articles` 表 ✅

**发布文章**:
1. Windows 端从本地读取 `articles` 和 `platform_accounts`
2. Windows 端本地浏览器自动化发布
3. Windows 端保存到本地 `publishing_records`
4. Windows 端上报统计 → 服务器 `publish_analytics`

---

## 📋 总结

| 分类 | 表数 | 位置 | 原因 |
|------|------|------|------|
| 用户业务数据 | 17 | Windows 端 | 离线访问、本地执行、数据隐私 |
| 系统管理数据 | 49 | 服务器 | 认证、配额、支付、安全、审计 |

**关键点**:
- ✅ 17 个表迁移到 Windows 端 = 用户可以离线工作
- ✅ 49 个表保留在服务器 = 系统安全和配额管理
- ✅ 两端通过 API 通信 = 最佳架构

---

**文档版本**: 1.0  
**创建日期**: 2026-01-16
