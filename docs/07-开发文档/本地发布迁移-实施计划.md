# 本地发布迁移 - 实施计划

## 一、项目概述

### 1.1 目标
将发布任务的执行从服务器迁移到本地 Windows Electron 应用，服务器只负责数据存储。

### 1.2 架构变更

**迁移前（服务器执行）**
```
用户操作 → 前端页面 → 服务器 API → 服务器 PublishingExecutor → 服务器浏览器
                                              ↓
                                    服务器更新数据库
```

**迁移后（本地执行）**
```
用户操作 → 前端页面 → Electron IPC → 本地 PublishingExecutor → 本地浏览器
                                              ↓
                                    调用服务器 API 同步数据
```

---

## 二、现有资源盘点

### 2.1 可完全复用（无需修改）

| 资源 | 路径 | 说明 |
|------|------|------|
| 发布记录页面 | `windows-login-manager/src/pages/PublishingRecordsPage.tsx` | 展示发布成功的记录 |
| 前端 API 封装 | `windows-login-manager/src/api/publishing.ts` | 所有发布相关 API |
| 主进程 API 客户端 | `windows-login-manager/electron/api/client.ts` | HTTP 请求封装 |
| 发布记录路由 | `server/src/routes/publishingRecords.ts` | 发布记录 CRUD |
| 数据库表结构 | `publishing_tasks`, `publishing_records`, `publishing_logs` | 无需修改 |

### 2.2 需要修改

| 资源 | 路径 | 修改内容 |
|------|------|---------|
| 发布任务页面 | `windows-login-manager/src/pages/PublishingTasksPage.tsx` | 执行按钮改为调用 IPC |
| 发布任务路由 | `server/src/routes/publishingTasks.ts` | 添加 include 参数、状态更新 API |
| 服务器入口 | `server/src/index.ts` | 移除 TaskScheduler 启动 |

### 2.3 需要迁移到 Electron

| 服务器文件 | 目标路径 |
|-----------|---------|
| `server/src/services/PublishingExecutor.ts` | `electron/publishing/executor.ts` |
| `server/src/services/BrowserAutomationService.ts` | `electron/publishing/browser.ts` |
| `server/src/services/adapters/PlatformAdapter.ts` | `electron/publishing/adapters/base.ts` |
| `server/src/services/adapters/AdapterRegistry.ts` | `electron/publishing/adapters/index.ts` |
| `server/src/services/adapters/XiaohongshuAdapter.ts` | `electron/publishing/adapters/xiaohongshu.ts` |
| `server/src/services/adapters/DouyinAdapter.ts` | `electron/publishing/adapters/douyin.ts` |
| `server/src/services/adapters/ToutiaoAdapter.ts` | `electron/publishing/adapters/toutiao.ts` |
| `server/src/services/adapters/ZhihuAdapter.ts` | `electron/publishing/adapters/zhihu.ts` |
| `server/src/services/adapters/BaijiahaoAdapter.ts` | `electron/publishing/adapters/baijiahao.ts` |
| `server/src/services/adapters/WangyiAdapter.ts` | `electron/publishing/adapters/wangyi.ts` |
| `server/src/services/adapters/SohuAdapter.ts` | `electron/publishing/adapters/sohu.ts` |
| `server/src/services/adapters/CSDNAdapter.ts` | `electron/publishing/adapters/csdn.ts` |
| `server/src/services/adapters/JianshuAdapter.ts` | `electron/publishing/adapters/jianshu.ts` |
| `server/src/services/adapters/WechatAdapter.ts` | `electron/publishing/adapters/wechat.ts` |
| `server/src/services/adapters/QieAdapter.ts` | `electron/publishing/adapters/qie.ts` |
| `server/src/services/adapters/BilibiliAdapter.ts` | `electron/publishing/adapters/bilibili.ts` |
| `server/src/config/browserConfig.ts` | `electron/publishing/config.ts` |
| `server/src/utils/cookieNormalizer.ts` | `electron/publishing/utils.ts` |

---

## 三、详细实施计划

### 阶段 1：服务器端修改（预计 1 天）

#### 任务 1.1：修改任务详情 API
- [ ] **文件**：`server/src/routes/publishingTasks.ts`
- [ ] **位置**：`GET /tasks/:id` 路由
- [ ] **修改内容**：
  ```
  迁移前：只返回任务基本信息
  迁移后：支持 include 参数，可返回关联的文章和账号数据
  ```
- [ ] **具体改动**：
  - 解析 `include` 查询参数（值为 `article,account`）
  - 当包含 `article` 时，JOIN 查询 articles 表
  - 当包含 `account` 时，JOIN 查询 platform_accounts 表并解密 credentials
- [ ] **测试**：`GET /api/publishing/tasks/1?include=article,account` 返回完整数据

#### 任务 1.2：新增状态更新 API
- [ ] **文件**：`server/src/routes/publishingTasks.ts`
- [ ] **新增路由**：`PUT /tasks/:id/status`
- [ ] **请求体**：
  ```json
  {
    "status": "running|success|failed|timeout|cancelled",
    "started_at": "ISO时间",
    "completed_at": "ISO时间",
    "error_message": "错误信息"
  }
  ```
- [ ] **功能**：
  - 验证任务所有权
  - 更新任务状态和时间戳
  - 当 status=success 时：
    - 扣除用户发布配额
    - 调用现有 `createPublishingRecord` 逻辑创建发布记录
    - 清除文章的 publishing_status 锁
    - 删除原文章（如果没有其他待发布任务）
- [ ] **测试**：调用 API 更新状态，验证发布记录自动创建

#### 任务 1.3：新增日志同步 API
- [ ] **文件**：`server/src/routes/publishingTasks.ts`
- [ ] **新增路由**：`POST /tasks/:id/logs`
- [ ] **请求体**：
  ```json
  {
    "level": "info|warning|error",
    "message": "日志内容",
    "details": {}
  }
  ```
- [ ] **功能**：验证任务所有权，插入 publishing_logs 表
- [ ] **测试**：调用 API 添加日志，验证日志记录

#### 任务 1.4：禁用服务器端自动执行
- [ ] **文件**：`server/src/routes/publishingTasks.ts`
- [ ] **修改位置**：`POST /tasks` 路由
- [ ] **修改内容**：
  ```
  迁移前：创建任务后自动调用 publishingExecutor.executeTask()
  迁移后：只创建任务，不自动执行
  ```
- [ ] **修改位置**：`POST /tasks/:id/execute` 路由
- [ ] **修改内容**：
  ```
  迁移前：调用 publishingExecutor.executeTask()
  迁移后：返回提示 "请使用桌面客户端执行任务"
  ```

#### 任务 1.5：移除 TaskScheduler
- [ ] **文件**：`server/src/index.ts`
- [ ] **修改内容**：注释或删除 TaskScheduler 的启动代码
- [ ] **原因**：任务调度改为本地执行，服务器不再需要定时检查

---

### 阶段 2：Electron 主进程开发（预计 3 天）

#### 任务 2.1：安装依赖
- [ ] **目录**：`windows-login-manager/`
- [ ] **命令**：
  ```bash
  npm install playwright
  npx playwright install chromium
  ```
- [ ] **验证**：`node -e "require('playwright')"` 无报错

#### 任务 2.2：创建目录结构
- [ ] **创建目录**：`windows-login-manager/electron/publishing/`
- [ ] **创建目录**：`windows-login-manager/electron/publishing/adapters/`
- [ ] **目录结构**：
  ```
  electron/publishing/
  ├── executor.ts          # 发布执行器
  ├── browser.ts           # 浏览器服务
  ├── config.ts            # 浏览器配置
  ├── utils.ts             # 工具函数
  └── adapters/
      ├── index.ts         # 适配器注册表
      ├── base.ts          # 适配器基类
      └── [12个平台适配器]
  ```

#### 任务 2.3：迁移浏览器配置
- [ ] **源文件**：`server/src/config/browserConfig.ts`
- [ ] **目标文件**：`electron/publishing/config.ts`
- [ ] **修改内容**：
  ```
  迁移前：使用服务器环境变量
  迁移后：使用 Electron 环境，调整浏览器路径查找逻辑
  ```

#### 任务 2.4：迁移工具函数
- [ ] **源文件**：`server/src/utils/cookieNormalizer.ts`
- [ ] **目标文件**：`electron/publishing/utils.ts`
- [ ] **修改内容**：直接复制，无需修改

#### 任务 2.5：迁移浏览器服务
- [ ] **源文件**：`server/src/services/BrowserAutomationService.ts`
- [ ] **目标文件**：`electron/publishing/browser.ts`
- [ ] **修改内容**：
  ```
  迁移前：
  - 依赖 publishingService.logMessage() 记录日志
  - 使用服务器端浏览器路径
  
  迁移后：
  - 日志通过回调函数传递
  - 使用本地浏览器路径
  - 添加 setLogCallback(callback) 方法
  ```

#### 任务 2.6：迁移适配器基类
- [ ] **源文件**：`server/src/services/adapters/PlatformAdapter.ts`
- [ ] **目标文件**：`electron/publishing/adapters/base.ts`
- [ ] **修改内容**：
  ```
  迁移前：
  - log() 方法调用 publishingService.logMessage()
  
  迁移后：
  - log() 方法调用传入的回调函数
  - 添加 setLogCallback(callback) 方法
  ```

#### 任务 2.7：迁移适配器注册表
- [ ] **源文件**：`server/src/services/adapters/AdapterRegistry.ts`
- [ ] **目标文件**：`electron/publishing/adapters/index.ts`
- [ ] **修改内容**：修改 import 路径

#### 任务 2.8：迁移 12 个平台适配器
- [ ] 小红书：`xiaohongshu.ts`
- [ ] 抖音：`douyin.ts`
- [ ] 头条号：`toutiao.ts`
- [ ] 知乎：`zhihu.ts`
- [ ] 百家号：`baijiahao.ts`
- [ ] 网易号：`wangyi.ts`
- [ ] 搜狐号：`sohu.ts`
- [ ] CSDN：`csdn.ts`
- [ ] 简书：`jianshu.ts`
- [ ] 微信公众号：`wechat.ts`
- [ ] 企鹅号：`qie.ts`
- [ ] B站：`bilibili.ts`
- [ ] **修改内容**：只需修改 import 路径

#### 任务 2.9：迁移发布执行器
- [ ] **源文件**：`server/src/services/PublishingExecutor.ts`
- [ ] **目标文件**：`electron/publishing/executor.ts`
- [ ] **修改内容**：
  ```
  迁移前：
  - 直接操作数据库（pool.query）
  - 调用 publishingService 的方法
  - 调用 accountService 的方法
  
  迁移后：
  - 通过 API 获取数据
  - 通过 API 更新状态
  - 通过 API 同步日志
  - 通过 IPC 发送实时日志到渲染进程
  ```
- [ ] **核心方法改造**：
  ```typescript
  // executeTask() 方法改造
  async executeTask(taskId: number) {
    // 1. 调用 API 获取任务详情
    const task = await apiClient.get(`/publishing/tasks/${taskId}?include=article,account`);
    
    // 2. 调用 API 更新状态为 running
    await apiClient.put(`/publishing/tasks/${taskId}/status`, { status: 'running' });
    
    // 3. 执行发布（本地浏览器）
    // ...
    
    // 4. 调用 API 更新状态为 success/failed
    await apiClient.put(`/publishing/tasks/${taskId}/status`, { status: 'success' });
  }
  ```

#### 任务 2.10：注册 IPC 处理器
- [ ] **文件**：`electron/ipc/handler.ts`
- [ ] **新增处理器**：
  ```typescript
  ipcMain.handle('publishing:execute-task', async (event, taskId) => {
    return await publishingExecutor.executeTask(taskId);
  });
  
  ipcMain.handle('publishing:stop-task', async (event, taskId) => {
    return await publishingExecutor.stopTask(taskId);
  });
  ```
- [ ] **在 registerHandlers() 中调用新处理器注册**

#### 任务 2.11：更新 preload.ts
- [ ] **文件**：`electron/preload.ts`
- [ ] **新增暴露 API**：
  ```typescript
  contextBridge.exposeInMainWorld('publishing', {
    executeTask: (taskId: number) => ipcRenderer.invoke('publishing:execute-task', taskId),
    stopTask: (taskId: number) => ipcRenderer.invoke('publishing:stop-task', taskId),
    onTaskLog: (callback: Function) => {
      ipcRenderer.on('publishing:task-log', (_, data) => callback(data));
      return () => ipcRenderer.removeAllListeners('publishing:task-log');
    },
    onTaskStatus: (callback: Function) => {
      ipcRenderer.on('publishing:task-status', (_, data) => callback(data));
      return () => ipcRenderer.removeAllListeners('publishing:task-status');
    }
  });
  ```

#### 任务 2.12：添加 TypeScript 类型声明
- [ ] **文件**：`windows-login-manager/src/types/electron.d.ts`
- [ ] **内容**：
  ```typescript
  interface Window {
    publishing?: {
      executeTask: (taskId: number) => Promise<{ success: boolean; error?: string }>;
      stopTask: (taskId: number) => Promise<{ success: boolean }>;
      onTaskLog: (callback: (data: any) => void) => () => void;
      onTaskStatus: (callback: (data: any) => void) => () => void;
    };
  }
  ```

---

### 阶段 3：前端适配（预计 0.5 天）

#### 任务 3.1：修改执行按钮调用方式
- [ ] **文件**：`windows-login-manager/src/pages/PublishingTasksPage.tsx`
- [ ] **修改函数**：`handleExecuteTask`
- [ ] **修改内容**：
  ```typescript
  // 迁移前
  const handleExecuteTask = async (taskId: number) => {
    await executeTask(taskId);  // 调用服务器 API
  };
  
  // 迁移后
  const handleExecuteTask = async (taskId: number) => {
    if (window.publishing) {
      // Electron 环境：本地执行
      const result = await window.publishing.executeTask(taskId);
      if (!result.success) {
        message.error(result.error || '执行失败');
      }
    } else {
      // Web 环境：调用服务器（保持兼容）
      await executeTask(taskId);
    }
  };
  ```

#### 任务 3.2：添加实时日志监听
- [ ] **文件**：`windows-login-manager/src/pages/PublishingTasksPage.tsx`
- [ ] **添加 useEffect**：
  ```typescript
  useEffect(() => {
    if (!window.publishing) return;
    
    const unsubscribeLog = window.publishing.onTaskLog((data) => {
      if (logsModal.visible && logsModal.taskId === data.taskId) {
        setLogsModal(prev => ({
          ...prev,
          logs: [...prev.logs, data]
        }));
      }
    });
    
    const unsubscribeStatus = window.publishing.onTaskStatus((data) => {
      // 更新任务列表中的状态
      setTasks(prev => prev.map(t => 
        t.id === data.taskId ? { ...t, status: data.status } : t
      ));
    });
    
    return () => {
      unsubscribeLog();
      unsubscribeStatus();
    };
  }, [logsModal.visible, logsModal.taskId]);
  ```

#### 任务 3.3：修改终止按钮调用方式
- [ ] **文件**：`windows-login-manager/src/pages/PublishingTasksPage.tsx`
- [ ] **修改函数**：`handleTerminateTask`
- [ ] **修改内容**：
  ```typescript
  // 迁移前
  const handleTerminateTask = async (taskId: number) => {
    await terminateTask(taskId);  // 调用服务器 API
  };
  
  // 迁移后
  const handleTerminateTask = async (taskId: number) => {
    if (window.publishing) {
      await window.publishing.stopTask(taskId);
    } else {
      await terminateTask(taskId);
    }
  };
  ```

---

### 阶段 4：测试（预计 2 天）

#### 任务 4.1：单元测试 - 服务器 API
- [ ] 测试 `GET /tasks/:id?include=article,account` 返回完整数据
- [ ] 测试 `PUT /tasks/:id/status` 状态更新
- [ ] 测试 `POST /tasks/:id/logs` 日志记录
- [ ] 测试状态更新为 success 时自动创建发布记录

#### 任务 4.2：单元测试 - Electron 执行器
- [ ] 测试浏览器启动和关闭
- [ ] 测试 Cookie 设置
- [ ] 测试日志回调

#### 任务 4.3：集成测试 - 单平台
- [ ] 选择小红书进行完整流程测试
- [ ] 验证流程：创建任务 → 点击执行 → 本地浏览器启动 → 发布 → 状态同步 → 发布记录创建
- [ ] 验证日志实时显示

#### 任务 4.4：集成测试 - 多平台
- [ ] 测试抖音
- [ ] 测试头条号
- [ ] 测试知乎
- [ ] 测试百家号
- [ ] 测试网易号
- [ ] 测试搜狐号
- [ ] 测试 CSDN
- [ ] 测试简书
- [ ] 测试微信公众号
- [ ] 测试企鹅号
- [ ] 测试 B站

#### 任务 4.5：集成测试 - 批次任务
- [ ] 创建包含多篇文章的批次任务
- [ ] 验证任务按顺序执行
- [ ] 验证任务间隔正确

#### 任务 4.6：异常场景测试
- [ ] 测试网络断开时的处理
- [ ] 测试任务超时处理
- [ ] 测试用户取消任务
- [ ] 测试浏览器崩溃恢复

---

### 阶段 5：部署（预计 0.5 天）

#### 任务 5.1：服务器部署
- [ ] 本地编译：`npm run server:build`
- [ ] 上传文件到服务器
- [ ] 重启服务：`pm2 restart geo-server`
- [ ] 验证 API：`curl http://localhost:3000/api/health`

#### 任务 5.2：Electron 应用打包
- [ ] 确保 Playwright 浏览器包含在打包中
- [ ] 执行打包命令
- [ ] 测试安装包在 Windows 上的运行

#### 任务 5.3：文档更新
- [ ] 更新用户使用说明
- [ ] 标记本文档为已完成

---

## 四、进度跟踪

| 阶段 | 任务数 | 已完成 | 进度 | 状态 |
|------|--------|--------|------|------|
| 阶段 1：服务器端修改 | 5 | 0 | 0% | 未开始 |
| 阶段 2：Electron 开发 | 12 | 0 | 0% | 未开始 |
| 阶段 3：前端适配 | 3 | 0 | 0% | 未开始 |
| 阶段 4：测试 | 6 | 0 | 0% | 未开始 |
| 阶段 5：部署 | 3 | 0 | 0% | 未开始 |
| **总计** | **29** | **0** | **0%** | **未开始** |

---

## 五、时间估算

| 阶段 | 预计时间 | 实际时间 | 备注 |
|------|---------|---------|------|
| 阶段 1：服务器端修改 | 1 天 | - | |
| 阶段 2：Electron 开发 | 3 天 | - | |
| 阶段 3：前端适配 | 0.5 天 | - | |
| 阶段 4：测试 | 2 天 | - | |
| 阶段 5：部署 | 0.5 天 | - | |
| **总计** | **7 天** | **-** | |

---

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Playwright 打包体积过大 | 安装包过大 | 只打包 Chromium，不打包其他浏览器 |
| 平台适配器迁移后行为不一致 | 发布失败 | 逐个平台测试，保持代码一致 |
| 网络不稳定导致状态同步失败 | 数据不一致 | 添加重试机制，本地缓存状态 |

---

**文档版本**：v1.0
**创建日期**：2026-01-20
**最后更新**：2026-01-20
