# 🧪 快速测试多租户隔离

## 测试目标
验证新用户是否能看到管理员的旧数据（如果能看到，说明路由需要修复）

## 测试步骤

### 1️⃣ 创建新测试用户

在浏览器中访问你的应用注册页面，或使用 API：

```bash
# 注册新用户
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser_'$(date +%s)'",
    "password": "Test123456"
  }'
```

保存返回的 token。

### 2️⃣ 用新用户登录并查看数据

#### 方法A：使用浏览器（推荐）
1. 用新用户登录系统
2. 查看以下页面：
   - 转化目标列表
   - 文章列表
   - 蒸馏结果列表
   - 相册列表

#### 方法B：使用 API
```bash
TOKEN="<你的token>"

# 查看转化目标
curl -X GET http://localhost:3001/api/conversion-targets \
  -H "Authorization: Bearer $TOKEN"

# 查看文章列表
curl -X GET http://localhost:3001/api/articles \
  -H "Authorization: Bearer $TOKEN"

# 查看蒸馏结果
curl -X GET http://localhost:3001/api/distillation/history \
  -H "Authorization: Bearer $TOKEN"
```

### 3️⃣ 判断结果

#### ❌ 如果看到了旧数据（管理员的数据）
**说明：路由没有正确实现数据隔离**

表现：
- 新用户能看到很多不是自己创建的数据
- 列表中有创建时间很早的记录
- 数据量很多

**解决方案：**
需要修复路由文件，添加 user_id 过滤。查看 `fix-tenant-isolation.md`

#### ✅ 如果只看到空列表或自己创建的数据
**说明：数据隔离正常工作**

表现：
- 新用户看到的列表是空的
- 或者只有自己刚创建的数据
- 看不到管理员的旧数据

**结论：**
多租户隔离已正确实现！

## 🎯 快速判断方法

### 最简单的测试：
1. 用管理员账户登录，记录转化目标的数量（比如有 10 个）
2. 注册一个新用户
3. 用新用户登录，查看转化目标列表
4. **如果新用户也看到 10 个转化目标 → 需要修复路由**
5. **如果新用户看到 0 个转化目标 → 隔离正常**

## 📊 预期结果对比

### 当前状态（路由未修复）
```
管理员登录：
  - 转化目标：10 个（所有旧数据）
  - 文章：50 篇
  - 蒸馏结果：20 个

新用户登录：
  - 转化目标：10 个 ❌（不应该看到）
  - 文章：50 篇 ❌（不应该看到）
  - 蒸馏结果：20 个 ❌（不应该看到）
```

### 修复后（路由已修复）
```
管理员登录：
  - 转化目标：10 个（所有旧数据）
  - 文章：50 篇
  - 蒸馏结果：20 个

新用户登录：
  - 转化目标：0 个 ✅（只看到自己的）
  - 文章：0 篇 ✅（只看到自己的）
  - 蒸馏结果：0 个 ✅（只看到自己的）
```

## 🔧 如果测试失败

如果新用户能看到管理员的数据，说明需要修复路由。

### 修复优先级：
1. **高优先级**（核心业务数据）
   - `server/src/routes/article.ts`
   - `server/src/routes/distillation.ts`
   - `server/src/routes/conversionTarget.ts`

2. **中优先级**
   - `server/src/routes/articleGeneration.ts`
   - `server/src/routes/articleSettings.ts`
   - `server/src/routes/platformAccounts.ts`

### 修复方法：
查看 `fix-tenant-isolation.md` 获取详细的修复步骤。

核心修改：在所有查询中添加 `user_id` 过滤。

## 💡 提示

- 使用非管理员账户测试是最清晰的验证方法
- 管理员账户会看到所有旧数据（这是正常的）
- 新用户应该从零开始，不继承任何数据
- 如果你想让新用户也能访问某些共享数据，需要单独设计权限系统
