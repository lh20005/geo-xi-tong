# 速率限制配置说明

> 更新时间：2024-12-26  
> 当前配置：智能速率限制

---

## 📊 当前配置

### 生产环境
```typescript
限制：500次/分钟
窗口：1分钟
计算方式：按 IP 地址
```

### 开发环境
```typescript
限制：1000次/分钟
窗口：1分钟
计算方式：按 IP 地址
```

---

## 🎯 为什么是 500次/分钟？

### 实际使用场景分析

#### 单个用户正常使用
```
登录：3次
浏览工作台：10次
查看文章列表：5次
生成文章（含轮询）：30次
查看其他页面：20次
---
总计：约 70次/分钟
```

#### 多用户共享 IP（公司/学校）
```
假设：10个用户共享1个公网IP
每人平均：50次/分钟
总计：500次/分钟
```

#### 前端轮询场景
```
任务状态轮询：每2秒1次 = 30次/分钟
3个并发任务：90次/分钟
其他正常操作：50次/分钟
---
总计：约 140次/分钟
```

### 结论
✅ **500次/分钟 = 合理且充足**
- 单用户：有 7倍 余量（70 vs 500）
- 多用户：支持 10人 同时使用
- 轮询场景：支持 3个 并发任务
- 安全性：仍能防止暴力攻击

---

## 🔒 安全性分析

### 500次/分钟 能防止什么？

#### ✅ 可以防止
1. **暴力破解登录**
   - 正常登录：1-2次/分钟
   - 暴力破解：数百次/分钟
   - 500次限制足以阻止

2. **API 滥用**
   - 正常使用：50-100次/分钟
   - 恶意爬虫：数千次/分钟
   - 500次限制有效

3. **DDoS 攻击（部分）**
   - 单 IP 限制在 500次/分钟
   - 减轻服务器压力
   - 配合其他防护措施

#### ❌ 无法防止
1. **分布式攻击**
   - 多个 IP 同时攻击
   - 需要配合 WAF/CDN

2. **慢速攻击**
   - 每分钟少于 500次
   - 需要其他检测机制

---

## 📈 不同限制的对比

| 限制 | 单用户 | 10人共享IP | 安全性 | 推荐度 |
|------|--------|-----------|--------|--------|
| 100次/分钟 | ✅ 够用 | ❌ 不够 | 🟢 高 | ⭐⭐ |
| 300次/分钟 | ✅ 充足 | ⚠️ 勉强 | 🟢 高 | ⭐⭐⭐ |
| **500次/分钟** | ✅ 充足 | ✅ 够用 | 🟢 高 | ⭐⭐⭐⭐⭐ |
| 1000次/分钟 | ✅ 过剩 | ✅ 充足 | 🟡 中 | ⭐⭐⭐⭐ |
| 无限制 | ✅ 无限 | ✅ 无限 | 🔴 低 | ❌ |

---

## 🔧 如何调整？

### 方法 1：修改代码（推荐）

编辑 `server/src/index.ts`：

```typescript
const limiter = rateLimit({
  windowMs: 1 * 60 * 1000,
  max: process.env.NODE_ENV === 'production' ? 500 : 1000,  // 修改这里
  // ...
});
```

### 方法 2：环境变量（未来支持）

在 `.env` 文件中：
```bash
RATE_LIMIT_WINDOW_MS=60000      # 窗口时间（毫秒）
RATE_LIMIT_MAX=500              # 最大请求数
```

---

## 🎯 不同场景的推荐配置

### 个人使用/小团队（1-5人）
```typescript
max: 300  // 足够使用，安全性高
```

### 中小企业（5-20人）
```typescript
max: 500  // 当前配置，推荐 ⭐
```

### 大型企业（20-100人）
```typescript
max: 1000  // 支持更多并发
```

### 公开服务（不限人数）
```typescript
max: 2000  // 配合 CDN 和 WAF
```

---

## 🚨 监控和调整

### 如何知道限制是否合适？

#### 1. 查看日志
```bash
# 查看被限制的请求
grep "请求过于频繁" server/logs/*.log
```

#### 2. 监控指标
```bash
# 使用 PM2 监控
pm2 monit

# 查看请求统计
pm2 logs | grep "rate limit"
```

#### 3. 用户反馈
- 如果用户频繁报告"请求过于频繁"
- 说明限制太严格，需要调整

### 调整建议

#### 限制太严格的信号
- ✅ 用户频繁报告错误
- ✅ 日志中大量限制记录
- ✅ 正常操作被阻止

**解决方案：** 增加限制（如 500 → 800）

#### 限制太宽松的信号
- ✅ 服务器负载过高
- ✅ 发现恶意请求
- ✅ API 被滥用

**解决方案：** 降低限制（如 500 → 300）

---

## 🔐 额外的安全措施

### 1. 登录限流（已实现）
```typescript
// 更严格的登录限制
登录：5次/15分钟（按 IP+用户名）
注册：3次/1小时（按 IP）
```

### 2. WebSocket 不限制
```typescript
// WebSocket 连接不受全局限制
skip: (req) => req.path === '/ws'
```

### 3. 静态资源不限制
```typescript
// 图片、CSS、JS 等不限制
skip: (req) => req.path.startsWith('/uploads')
```

---

## 📊 性能影响

### 速率限制的开销

```
内存占用：约 1-5MB（存储 IP 计数）
CPU 占用：< 1%（检查请求）
响应延迟：< 1ms（几乎无影响）
```

### 结论
✅ **性能影响可以忽略不计**

---

## 🌐 生产环境最佳实践

### 1. 使用 CDN
```
优势：
- 分散请求到边缘节点
- 减少源站压力
- 自动防护 DDoS
```

### 2. 使用 WAF（Web Application Firewall）
```
推荐：
- 腾讯云 WAF
- Cloudflare
- AWS WAF
```

### 3. 使用 Redis 存储限流数据
```typescript
// 当前使用内存存储
// 生产环境可以改用 Redis
import RedisStore from 'rate-limit-redis';

const limiter = rateLimit({
  store: new RedisStore({
    client: redisClient
  }),
  // ...
});
```

---

## 📝 总结

### 当前配置（500次/分钟）

**优点：**
- ✅ 单用户有充足余量（7倍）
- ✅ 支持多用户共享 IP（10人）
- ✅ 支持前端轮询（3个任务）
- ✅ 仍能防止暴力攻击
- ✅ 符合行业最佳实践

**缺点：**
- ⚠️ 极端情况可能不够（20+人共享IP）
- ⚠️ 无法防止分布式攻击

**建议：**
- ✅ 保持当前配置（500次/分钟）
- ✅ 监控使用情况
- ✅ 根据实际情况调整
- ✅ 配合 CDN/WAF 使用

---

## 🔗 相关文档

- [安全配置优化建议](./docs/04-安全指南/安全配置优化建议.md)
- [安全最佳实践](./docs/04-安全指南/SECURITY_BEST_PRACTICES.md)
- [部署指南](./docs/03-部署指南/腾讯云快速部署指南.md)

---

**配置状态：** ✅ 已优化  
**推荐等级：** ⭐⭐⭐⭐⭐  
**适用场景：** 中小企业、团队协作

如需调整，请参考本文档的"如何调整"部分。
