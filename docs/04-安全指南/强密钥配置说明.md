# 强密钥配置说明

## 🔍 什么是强密钥？

强密钥就是**随机生成的、很难被破解的密码**，用来保护你的系统安全。

---

## ⚠️ 当前密钥的问题

### 你现在的密钥（不安全）

```bash
# 当前 .env 文件中的密钥
JWT_SECRET=geo_system_secret_key_2024
ADMIN_PASSWORD=Woshixiaogou2005
```

### 为什么不安全？

**1. JWT_SECRET 太简单**
```
当前：geo_system_secret_key_2024
问题：
❌ 包含可预测的单词（geo_system, secret, key）
❌ 包含年份（2024）
❌ 只有 28 个字符
❌ 黑客可以通过字典攻击破解

后果：
- 黑客可以伪造用户登录令牌
- 可以冒充任何用户（包括管理员）
- 可以访问所有数据
```

**2. ADMIN_PASSWORD 太弱**
```
当前：Woshixiaogou2005
问题：
❌ 包含拼音（Woshixiaogou）
❌ 包含年份（2005）
❌ 只有 16 个字符
❌ 容易被猜到

后果：
- 黑客可以暴力破解管理员密码
- 获得系统最高权限
- 可以删除所有数据
```

---

## ✅ 强密钥的标准

### 什么是强密钥？

```bash
# 强密钥示例
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144

特点：
✅ 完全随机生成
✅ 64 个字符（256位）
✅ 包含数字和字母
✅ 没有任何规律
✅ 几乎不可能被破解
```

### 破解难度对比

| 密钥类型 | 示例 | 破解时间 |
|---------|------|---------|
| 弱密钥 | `geo_system_secret_key_2024` | 几分钟到几小时 |
| 中等密钥 | `Woshixiaogou2005` | 几天到几周 |
| 强密钥 | `eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144` | 数十亿年 |

---

## 🔑 已生成的强密钥

我已经为你生成了以下强密钥：

```bash
# JWT 密钥（用于用户登录令牌加密）
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144

# JWT 刷新令牌密钥（用于刷新令牌加密）
JWT_REFRESH_SECRET=fcb44972cd8b6833229122d109cf7bca8254332045fef7a683de973fd84ec392

# 数据库密码（如果需要修改数据库密码）
DB_PASSWORD=H2SwIAkyzT1G4mAhkbtSULfG

# 管理员密码（用于登录管理后台）
ADMIN_PASSWORD=jehI2oBuNMMJehMM
```

---

## 📝 如何使用这些密钥？

### 方案 A：本地开发环境（现在）

**不需要立即更换**，因为：
- 你在本地开发，没有暴露到互联网
- 只有你自己能访问
- 风险较低

**但建议更换**，养成好习惯：

```bash
# 1. 备份当前 .env 文件
cp .env .env.backup

# 2. 编辑 .env 文件
nano .env

# 3. 替换以下内容：
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144
JWT_REFRESH_SECRET=fcb44972cd8b6833229122d109cf7bca8254332045fef7a683de973fd84ec392
ADMIN_PASSWORD=jehI2oBuNMMJehMM

# 4. 保存并重启服务器
# Ctrl+O 保存，Ctrl+X 退出
```

### 方案 B：生产环境部署（必须）

**部署到腾讯云时，必须使用强密钥！**

#### 步骤 1：在服务器上创建 .env 文件

```bash
# SSH 连接到服务器
ssh ubuntu@your-server-ip

# 进入项目目录
cd /var/www/geo-system

# 创建 .env 文件
nano .env
```

#### 步骤 2：填入配置

```bash
# 数据库配置（服务器上的数据库）
DATABASE_URL=postgresql://geo_user:H2SwIAkyzT1G4mAhkbtSULfG@localhost:5432/geo_system

# AI API配置（使用你的真实 API Key）
DEEPSEEK_API_KEY=sk-your-real-deepseek-key
GEMINI_API_KEY=AIzaSy-your-real-gemini-key

# 服务器配置
PORT=3000
NODE_ENV=production

# 🔒 强密钥（使用生成的）
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144
JWT_REFRESH_SECRET=fcb44972cd8b6833229122d109cf7bca8254332045fef7a683de973fd84ec392

# 管理员账号（使用强密码）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=jehI2oBuNMMJehMM

# CORS 允许的来源（你的域名）
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com

# 微信支付配置（如果使用）
WECHAT_PAY_APP_ID=wx1234567890abcdef
WECHAT_PAY_MCH_ID=1234567890
WECHAT_PAY_API_V3_KEY=your_32_character_api_v3_key_here
WECHAT_PAY_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678
WECHAT_PAY_PRIVATE_KEY_PATH=/var/www/geo-system/certs/apiclient_key.pem
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/payment/wechat/notify

# Redis配置
REDIS_URL=redis://:password@localhost:6379
```

#### 步骤 3：保存并设置权限

```bash
# 保存文件（Ctrl+O, Ctrl+X）

# 设置文件权限（只有 owner 可以读写）
chmod 600 .env

# 验证权限
ls -la .env
# 应该显示：-rw------- 1 ubuntu ubuntu
```

---

## 🔐 密钥的作用

### 1. JWT_SECRET

**作用：** 加密用户登录令牌

```typescript
// 用户登录时
const token = jwt.sign(
  { userId: user.id, username: user.username },
  process.env.JWT_SECRET,  // 使用这个密钥加密
  { expiresIn: '1h' }
);

// 验证令牌时
const decoded = jwt.verify(token, process.env.JWT_SECRET);
```

**如果被破解：**
- 黑客可以伪造任何用户的登录令牌
- 可以冒充管理员
- 可以访问所有数据

### 2. JWT_REFRESH_SECRET

**作用：** 加密刷新令牌（用于自动续期）

**如果被破解：**
- 黑客可以永久保持登录状态
- 即使修改密码也无法踢出黑客

### 3. ADMIN_PASSWORD

**作用：** 管理员登录密码

**如果被破解：**
- 黑客获得系统最高权限
- 可以删除所有数据
- 可以修改所有配置

---

## 📋 配置检查清单

### 本地开发环境

- [ ] 可以暂时不换（风险低）
- [ ] 建议更换（养成好习惯）
- [ ] 记住管理员密码：`jehI2oBuNMMJehMM`

### 生产环境部署

- [ ] **必须**使用强密钥
- [ ] **必须**修改 ADMIN_PASSWORD
- [ ] **必须**配置 ALLOWED_ORIGINS
- [ ] **必须**设置 .env 文件权限为 600
- [ ] **必须**确保 .env 不在 Git 中

---

## 🎯 简单总结

### 现在需要做什么？

**本地开发（可选）：**
```bash
# 1. 编辑 .env 文件
nano .env

# 2. 替换这三行：
JWT_SECRET=eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144
JWT_REFRESH_SECRET=fcb44972cd8b6833229122d109cf7bca8254332045fef7a683de973fd84ec392
ADMIN_PASSWORD=jehI2oBuNMMJehMM

# 3. 保存并重启服务器
```

**部署到腾讯云（必须）：**
```bash
# 在服务器上创建 .env 文件
# 使用生成的强密钥
# 设置文件权限为 600
```

### 为什么需要强密钥？

```
弱密钥：geo_system_secret_key_2024
破解时间：几小时

强密钥：eeca6b8fd34cc378411cee4d5d9e405ba2470f34f31f65ca42a3b2ec6c44a144
破解时间：数十亿年

结论：强密钥让你的系统几乎不可能被破解！
```

---

## ❓ 常见问题

### Q1: 我现在必须更换密钥吗？

**A:** 
- 本地开发：不必须，但建议更换
- 部署到服务器：**必须更换**

### Q2: 更换密钥后，现有用户会掉线吗？

**A:** 
- 是的，所有用户需要重新登录
- 这是正常的，因为旧的令牌无法用新密钥解密

### Q3: 我会忘记这么复杂的管理员密码怎么办？

**A:** 
- 把密码保存在安全的地方（如密码管理器）
- 或者使用你自己的强密码（至少 16 位，包含大小写字母、数字、特殊字符）
- 不要使用简单密码！

### Q4: 如果我忘记了管理员密码怎么办？

**A:** 
- 可以通过数据库直接修改
- 或者运行 `node change-admin-password.js` 脚本

### Q5: 这些密钥需要记住吗？

**A:** 
- 不需要记住
- 保存在 .env 文件中
- 系统会自动读取
- 但要妥善保管 .env 文件

### Q6: 可以自己生成密钥吗？

**A:** 
- 可以，使用命令：
  ```bash
  # 生成 64 字符的密钥
  openssl rand -hex 32
  
  # 生成 24 字符的密码
  openssl rand -base64 24 | tr -d "=+/" | cut -c1-24
  ```

---

## 🔒 安全建议

### ✅ 应该做的

1. ✅ 使用强密钥（64 字符随机）
2. ✅ 定期更换密钥（每 3-6 个月）
3. ✅ 不要在代码中硬编码密钥
4. ✅ 不要把 .env 文件提交到 Git
5. ✅ 设置 .env 文件权限为 600
6. ✅ 使用密码管理器保存密钥

### ❌ 不应该做的

1. ❌ 使用简单密码（如 123456）
2. ❌ 使用可预测的密码（如 geo_system_2024）
3. ❌ 在多个系统使用相同密钥
4. ❌ 把密钥发送到聊天工具
5. ❌ 把密钥写在纸上到处放
6. ❌ 与他人分享密钥

---

**总结：强密钥是保护系统安全的第一道防线，部署到生产环境时必须使用！**
