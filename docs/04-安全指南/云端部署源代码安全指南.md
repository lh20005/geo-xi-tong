# 云端部署源代码安全指南

## 🔍 源代码泄露风险分析

### 高风险场景 ⚠️

#### 1. 前端代码（完全暴露）
```
风险等级：🔴 高
原因：前端代码会被打包并发送到用户浏览器
```

**暴露内容：**
- ✅ 所有前端 JavaScript 代码（虽然被混淆）
- ✅ API 接口路径和参数
- ✅ 前端业务逻辑
- ✅ 组件结构和交互逻辑

**无法暴露：**
- ❌ 后端源代码
- ❌ 数据库密码
- ❌ API Key
- ❌ 服务器配置

#### 2. 后端代码（有风险）
```
风险等级：🟡 中等
原因：取决于服务器配置和部署方式
```

**可能泄露的途径：**

##### a) 服务器配置错误
```nginx
# ❌ 错误配置 - 暴露源代码
location / {
    root /var/www/app;  # 直接暴露整个目录
    autoindex on;       # 允许目录浏览
}

# 访问 https://your-domain.com/server/src/index.ts
# 可能直接下载源代码！
```

##### b) Git 目录暴露
```bash
# 如果 .git 目录可访问
https://your-domain.com/.git/config
https://your-domain.com/.git/HEAD

# 攻击者可以重建整个代码仓库！
```

##### c) 备份文件暴露
```bash
# 常见的备份文件
https://your-domain.com/index.js.bak
https://your-domain.com/config.js~
https://your-domain.com/.env.backup
```

##### d) 错误信息泄露
```javascript
// ❌ 生产环境显示详细错误
app.use((err, req, res, next) => {
  res.status(500).json({
    error: err.message,
    stack: err.stack,  // 暴露代码路径和逻辑
    file: err.fileName // 暴露文件结构
  });
});
```

##### e) Source Map 泄露
```javascript
// 前端打包后的文件
main.js
main.js.map  // ❌ 包含原始源代码！

// 攻击者可以通过 source map 还原完整源代码
```

### 低风险场景 ✅

#### 1. 正确的 Docker 部署
```dockerfile
# 只复制必要的文件
COPY package*.json ./
COPY dist/ ./dist/
# 不复制 src/ 目录
```

#### 2. 编译后的代码
```
Node.js 运行的是 JavaScript，不是源代码
TypeScript 编译后很难还原
```

## 🛡️ 防护措施

### 一、前端代码保护

#### 1. 代码混淆（已有）
```javascript
// Vite 默认会混淆代码
// vite.config.ts
export default {
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,  // 删除 console
        drop_debugger: true  // 删除 debugger
      },
      mangle: true  // 变量名混淆
    }
  }
}
```

**效果：**
```javascript
// 原始代码
function getUserData(userId) {
  return fetch(`/api/users/${userId}`);
}

// 混淆后
function a(b){return fetch("/api/users/"+b)}
```

#### 2. 禁用 Source Map（生产环境）
```javascript
// vite.config.ts
export default {
  build: {
    sourcemap: false  // ✅ 生产环境必须关闭
  }
}
```

#### 3. 关键逻辑后端化
```typescript
// ❌ 前端计算（可被破解）
const price = basePrice * discount;

// ✅ 后端计算（安全）
const price = await fetch('/api/calculate-price', {
  method: 'POST',
  body: JSON.stringify({ basePrice, discount })
});
```

### 二、后端代码保护

#### 1. Nginx 配置（关键！）

```nginx
# /etc/nginx/sites-available/your-app

server {
    listen 80;
    server_name your-domain.com;

    # ========== 安全配置 ==========
    
    # 1. 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        return 404;
    }

    # 2. 禁止访问源代码目录
    location ~ ^/(src|server|node_modules|.git) {
        deny all;
        return 404;
    }

    # 3. 禁止访问配置文件
    location ~ \.(env|json|yml|yaml|config)$ {
        deny all;
        return 404;
    }

    # 4. 禁止访问备份文件
    location ~ \.(bak|backup|old|tmp|temp|swp|~)$ {
        deny all;
        return 404;
    }

    # 5. 禁止目录浏览
    autoindex off;

    # 6. 前端静态文件
    location / {
        root /var/www/app/client/dist;
        try_files $uri $uri/ /index.html;
    }

    # 7. 后端 API（反向代理）
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # 隐藏后端服务器信息
        proxy_hide_header X-Powered-By;
    }
}
```

#### 2. 环境变量管理

```bash
# ❌ 错误：.env 文件在代码仓库中
git add .env
git commit -m "add config"

# ✅ 正确：使用云服务商的环境变量
# 阿里云/腾讯云控制台配置
# 或使用 Docker secrets
```

#### 3. 错误处理

```typescript
// server/src/middleware/errorHandler.ts

export function errorHandler(err: Error, req: Request, res: Response, next: NextFunction) {
  console.error('[Error]', err);  // 服务器日志
  
  if (process.env.NODE_ENV === 'production') {
    // ✅ 生产环境：隐藏详细信息
    res.status(500).json({
      success: false,
      message: '服务器内部错误'
      // 不返回 stack、file、line 等信息
    });
  } else {
    // 开发环境：显示详细信息
    res.status(500).json({
      success: false,
      message: err.message,
      stack: err.stack
    });
  }
}
```

#### 4. 隐藏服务器信息

```typescript
// server/src/index.ts

import helmet from 'helmet';

app.use(helmet());  // 自动设置安全 headers

// 隐藏 X-Powered-By
app.disable('x-powered-by');

// 自定义 Server header
app.use((req, res, next) => {
  res.removeHeader('X-Powered-By');
  res.setHeader('Server', 'WebServer');  // 不暴露具体技术栈
  next();
});
```

### 三、部署方式选择

#### 方案 A：编译后部署（推荐）

```bash
# 本地编译
cd server
npm run build  # 生成 dist/ 目录

# 只上传编译后的代码
scp -r dist/ user@server:/var/www/app/
scp package.json user@server:/var/www/app/
scp package-lock.json user@server:/var/www/app/

# 服务器上只安装生产依赖
npm ci --production
```

**优点：**
- ✅ 服务器上没有源代码
- ✅ 只有编译后的 JavaScript
- ✅ 即使被下载也难以理解

#### 方案 B：Docker 部署（最安全）

```dockerfile
# Dockerfile

# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 生产阶段
FROM node:18-alpine
WORKDIR /app

# 只复制必要文件
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
RUN npm ci --production

# 不复制 src/ 目录！
# 不复制 .git/ 目录！
# 不复制 .env 文件！

USER node
CMD ["node", "dist/index.js"]
```

**优点：**
- ✅ 多阶段构建，源代码不在最终镜像中
- ✅ 容器隔离，即使入侵也难以访问
- ✅ 可以使用私有镜像仓库

#### 方案 C：Serverless 部署

```yaml
# vercel.json 或 netlify.toml
# 代码在云服务商的安全环境中运行
# 用户无法直接访问服务器
```

### 四、Git 安全

#### 1. .gitignore 配置

```gitignore
# 敏感文件
.env
.env.*
*.key
*.pem
*.crt

# 源代码（如果使用编译部署）
src/
*.ts

# 配置文件
config/
secrets/

# 依赖
node_modules/

# 构建产物（可选）
dist/
build/
```

#### 2. 防止 .git 目录暴露

```nginx
# Nginx 配置
location ~ /\.git {
    deny all;
    return 404;
}
```

```bash
# 或者部署时删除 .git 目录
rm -rf .git
```

#### 3. 使用私有仓库

```bash
# GitHub/GitLab 设置为 Private
# 不要使用公开仓库存放生产代码
```

### 五、访问控制

#### 1. 管理后台保护

```typescript
// server/src/middleware/auth.ts

export function requireAdmin(req: Request, res: Response, next: NextFunction) {
  if (!req.user || req.user.role !== 'admin') {
    return res.status(403).json({ message: '无权访问' });
  }
  next();
}

// 应用到管理路由
app.use('/api/admin', authenticateToken, requireAdmin, adminRouter);
```

#### 2. IP 白名单（管理功能）

```typescript
// server/src/middleware/ipWhitelist.ts

const ADMIN_IPS = process.env.ADMIN_IPS?.split(',') || [];

export function checkAdminIP(req: Request, res: Response, next: NextFunction) {
  const clientIP = req.ip || req.connection.remoteAddress;
  
  if (!ADMIN_IPS.includes(clientIP)) {
    return res.status(403).json({ message: '访问被拒绝' });
  }
  
  next();
}
```

#### 3. 速率限制

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分钟
  max: 100, // 最多 100 个请求
  message: '请求过于频繁，请稍后再试'
});

app.use('/api', limiter);
```

## 🔍 安全检查清单

### 部署前检查

- [ ] 前端 Source Map 已禁用
- [ ] 前端代码已混淆
- [ ] .env 文件不在代码仓库中
- [ ] .gitignore 配置正确
- [ ] 敏感信息已移除（API Key、密码等）
- [ ] 错误处理不暴露详细信息
- [ ] 服务器信息已隐藏

### 部署后检查

```bash
# 1. 检查 .git 目录是否可访问
curl https://your-domain.com/.git/config
# 应该返回 404

# 2. 检查源代码目录是否可访问
curl https://your-domain.com/server/src/index.ts
# 应该返回 404

# 3. 检查 .env 文件是否可访问
curl https://your-domain.com/.env
# 应该返回 404

# 4. 检查 Source Map 是否暴露
curl https://your-domain.com/assets/main.js.map
# 应该返回 404

# 5. 检查错误信息
curl https://your-domain.com/api/nonexistent
# 不应该返回 stack trace

# 6. 检查服务器信息
curl -I https://your-domain.com
# Server header 不应该暴露具体技术
```

### 定期检查

- [ ] 扫描已知漏洞（npm audit）
- [ ] 更新依赖包
- [ ] 检查访问日志
- [ ] 审计异常请求
- [ ] 备份数据库

## 📊 风险等级评估

### 当前系统风险分析

| 组件 | 风险等级 | 说明 |
|------|---------|------|
| 前端代码 | 🟡 中 | 会被混淆但仍可分析 |
| 后端代码 | 🟢 低 | 正确配置下不会暴露 |
| API Key | 🟢 低 | 只在后端使用 |
| 数据库密码 | 🟢 低 | 只在后端使用 |
| 业务逻辑 | 🟡 中 | 前端逻辑可被分析 |
| 用户数据 | 🟢 低 | 有认证和授权保护 |

### 最坏情况分析

**如果攻击者获得了前端代码：**
- ✅ 可以看到 API 接口
- ✅ 可以看到前端业务逻辑
- ❌ 看不到后端源代码
- ❌ 看不到数据库密码
- ❌ 看不到 API Key
- ❌ 无法直接访问数据库

**如果攻击者获得了服务器访问权限：**
- ⚠️ 这是最严重的情况
- ⚠️ 可以访问所有代码和数据
- 🛡️ 防护：使用强密码、SSH 密钥、防火墙

## 🎯 推荐配置

### 最小安全配置（必须）

```bash
# 1. 更新 .gitignore
echo ".env" >> .gitignore
echo ".env.*" >> .gitignore
echo "*.key" >> .gitignore

# 2. 禁用前端 Source Map
# vite.config.ts: sourcemap: false

# 3. 配置 Nginx 安全规则
# 禁止访问 .git, src, .env 等

# 4. 使用环境变量管理敏感信息
# 不要硬编码 API Key
```

### 推荐安全配置

```bash
# 以上 + 

# 5. 使用 Docker 部署
# 多阶段构建，不包含源代码

# 6. 启用 HTTPS
# 使用 Let's Encrypt 免费证书

# 7. 配置防火墙
# 只开放 80, 443 端口

# 8. 定期更新依赖
npm audit fix
```

### 企业级安全配置

```bash
# 以上 + 

# 9. 使用 WAF（Web Application Firewall）
# 阿里云 WAF / Cloudflare

# 10. 启用日志监控
# ELK Stack / Grafana

# 11. 配置入侵检测
# Fail2ban / OSSEC

# 12. 定期安全审计
# 渗透测试 / 代码审计
```

## 📝 总结

### 源代码泄露风险

| 场景 | 风险 | 防护难度 |
|------|------|---------|
| 前端代码 | 🟡 中等 | 🟢 简单（混淆） |
| 后端代码 | 🟢 低 | 🟢 简单（正确配置） |
| 配置文件 | 🔴 高 | 🟢 简单（环境变量） |
| 数据库 | 🔴 高 | 🟡 中等（访问控制） |

### 关键要点

1. **前端代码必然暴露** - 但可以混淆
2. **后端代码可以保护** - 正确配置 Nginx
3. **敏感信息绝不暴露** - 使用环境变量
4. **Docker 是最佳实践** - 多阶段构建
5. **定期安全检查** - 防患于未然

### 你的系统安全吗？

基于当前代码分析：
- ✅ API Key 在后端（安全）
- ✅ 数据库密码在后端（安全）
- ✅ 有认证和授权机制（安全）
- ⚠️ 需要正确配置 Nginx（重要）
- ⚠️ 需要禁用前端 Source Map（重要）

**结论：只要正确部署，源代码泄露风险很低！**
