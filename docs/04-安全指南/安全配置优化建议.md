# å®‰å…¨é…ç½®ä¼˜åŒ–å»ºè®®

## ğŸ” å½“å‰å®‰å…¨çŠ¶å†µè¯„ä¼°

### âœ… å·²æœ‰çš„å®‰å…¨æªæ–½

1. **é”™è¯¯å¤„ç†** - ç”Ÿäº§ç¯å¢ƒä¸æ˜¾ç¤º stack trace
2. **ç¯å¢ƒå˜é‡** - API Key å­˜å‚¨åœ¨ .env æ–‡ä»¶
3. **.gitignore** - å·²é…ç½®å¿½ç•¥æ•æ„Ÿæ–‡ä»¶
4. **è®¤è¯æˆæƒ** - æœ‰ JWT è®¤è¯å’Œæƒé™æ§åˆ¶

### âš ï¸ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **å‰ç«¯ Source Map** - æœªæ˜ç¡®ç¦ç”¨
2. **é”™è¯¯ä¿¡æ¯** - ä»ç„¶è¿”å› `err.message`
3. **Nginx é…ç½®** - éœ€è¦æ·»åŠ å®‰å…¨è§„åˆ™
4. **æœåŠ¡å™¨ä¿¡æ¯** - æœªéšè—æŠ€æœ¯æ ˆä¿¡æ¯

## ğŸ› ï¸ ç«‹å³ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ç¦ç”¨å‰ç«¯ Source Map

**ä¿®æ”¹ `client/vite.config.ts`ï¼š**

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      },
      '/uploads': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  },
  build: {
    // ç”Ÿäº§ç¯å¢ƒç¦ç”¨ source map
    sourcemap: false,
    
    // ä»£ç æ··æ·†
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,  // åˆ é™¤ console.log
        drop_debugger: true, // åˆ é™¤ debugger
        pure_funcs: ['console.log', 'console.info', 'console.debug']
      },
      mangle: {
        safari10: true
      }
    },
    
    // åˆ†å—ç­–ç•¥
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'antd-vendor': ['antd', '@ant-design/icons']
        }
      }
    }
  }
});
```

### 2. æ”¹è¿›é”™è¯¯å¤„ç†

**ä¿®æ”¹ `server/src/middleware/errorHandler.ts`ï¼š**

```typescript
import { Request, Response, NextFunction } from 'express';

// å®šä¹‰å®‰å…¨çš„é”™è¯¯æ¶ˆæ¯æ˜ å°„
const SAFE_ERROR_MESSAGES: Record<string, string> = {
  'ValidationError': 'è¯·æ±‚å‚æ•°é”™è¯¯',
  'UnauthorizedError': 'æœªæˆæƒè®¿é—®',
  'ForbiddenError': 'æ— æƒè®¿é—®',
  'NotFoundError': 'èµ„æºä¸å­˜åœ¨',
  'ConflictError': 'èµ„æºå†²çª',
  'DatabaseError': 'æ•°æ®æ“ä½œå¤±è´¥',
  'NetworkError': 'ç½‘ç»œè¯·æ±‚å¤±è´¥'
};

export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  // è®°å½•è¯¦ç»†é”™è¯¯åˆ°æœåŠ¡å™¨æ—¥å¿—
  console.error('[Error]', {
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    user: (req as any).user?.id
  });
  
  // ç¡®å®š HTTP çŠ¶æ€ç 
  const statusCode = (err as any).statusCode || 500;
  
  if (process.env.NODE_ENV === 'production') {
    // ç”Ÿäº§ç¯å¢ƒï¼šè¿”å›å®‰å…¨çš„é”™è¯¯æ¶ˆæ¯
    const safeMessage = SAFE_ERROR_MESSAGES[err.name] || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
    
    res.status(statusCode).json({
      success: false,
      message: safeMessage,
      // ä¸è¿”å›ä»»ä½•è¯¦ç»†ä¿¡æ¯
    });
  } else {
    // å¼€å‘ç¯å¢ƒï¼šè¿”å›è¯¦ç»†ä¿¡æ¯
    res.status(statusCode).json({
      success: false,
      message: err.message,
      stack: err.stack,
      name: err.name
    });
  }
}
```

### 3. éšè—æœåŠ¡å™¨ä¿¡æ¯

**ä¿®æ”¹ `server/src/index.ts`ï¼š**

```typescript
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import dotenv from 'dotenv';
// ... å…¶ä»–å¯¼å…¥

dotenv.config({ path: path.join(__dirname, '../../.env') });

const app = express();
const PORT = process.env.PORT || 3000;

// ========== å®‰å…¨ä¸­é—´ä»¶ ==========

// 1. Helmet - è®¾ç½®å®‰å…¨ HTTP headers
app.use(helmet({
  contentSecurityPolicy: false, // å¦‚æœéœ€è¦å¯ä»¥è‡ªå®šä¹‰ CSP
  crossOriginEmbedderPolicy: false
}));

// 2. éšè—æŠ€æœ¯æ ˆä¿¡æ¯
app.disable('x-powered-by');
app.use((req, res, next) => {
  res.removeHeader('X-Powered-By');
  res.setHeader('Server', 'WebServer'); // ä¸æš´éœ² Express
  next();
});

// 3. CORS é…ç½®
const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [
  'http://localhost:5173',
  'http://localhost:8080'
];

app.use(cors({
  origin: (origin, callback) => {
    // å…è®¸æ²¡æœ‰ origin çš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanï¼‰
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('ä¸å…è®¸çš„æ¥æº'));
    }
  },
  credentials: true
}));

// 4. è¯·æ±‚ä½“å¤§å°é™åˆ¶
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ limit: '10mb', extended: true }));

// ... å…¶ä»–ä¸­é—´ä»¶å’Œè·¯ç”±
```

### 4. åˆ›å»º Nginx å®‰å…¨é…ç½®

**åˆ›å»º `nginx-security.conf`ï¼š**

```nginx
# Nginx å®‰å…¨é…ç½®æ¨¡æ¿

server {
    listen 80;
    server_name your-domain.com;
    
    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # ========== å®‰å…¨ Headers ==========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # ========== ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶ ==========
    
    # 1. ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶ï¼ˆ.git, .env ç­‰ï¼‰
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }
    
    # 2. ç¦æ­¢è®¿é—®æºä»£ç ç›®å½•
    location ~ ^/(src|server|node_modules|dist|build) {
        deny all;
        return 404;
    }
    
    # 3. ç¦æ­¢è®¿é—®é…ç½®æ–‡ä»¶
    location ~ \.(env|json|yml|yaml|config|ini|conf)$ {
        deny all;
        return 404;
    }
    
    # 4. ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ \.(bak|backup|old|tmp|temp|swp|~|log)$ {
        deny all;
        return 404;
    }
    
    # 5. ç¦æ­¢è®¿é—® TypeScript æºæ–‡ä»¶
    location ~ \.ts$ {
        deny all;
        return 404;
    }
    
    # 6. ç¦æ­¢è®¿é—® Source Map
    location ~ \.map$ {
        deny all;
        return 404;
    }
    
    # ========== ç¦æ­¢ç›®å½•æµè§ˆ ==========
    autoindex off;
    
    # ========== é™åˆ¶è¯·æ±‚æ–¹æ³• ==========
    if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS|HEAD)$ ) {
        return 405;
    }
    
    # ========== å‰ç«¯é™æ€æ–‡ä»¶ ==========
    location / {
        root /var/www/app/client/dist;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜é™æ€èµ„æº
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ========== åç«¯ API ==========
    location /api {
        # é€Ÿç‡é™åˆ¶
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # éšè—åç«¯æœåŠ¡å™¨ä¿¡æ¯
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ========== WebSocket ==========
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
    
    # ========== ä¸Šä¼ æ–‡ä»¶ ==========
    location /uploads {
        alias /var/www/app/server/uploads;
        
        # åªå…è®¸è®¿é—®å›¾ç‰‡
        location ~ \.(jpg|jpeg|png|gif|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
        
        # ç¦æ­¢è®¿é—®å…¶ä»–æ–‡ä»¶
        location ~ {
            deny all;
            return 404;
        }
    }
}

# ========== é€Ÿç‡é™åˆ¶é…ç½® ==========
# åœ¨ http å—ä¸­æ·»åŠ 
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
```

### 5. æ·»åŠ å®‰å…¨ä¾èµ–

```bash
cd server
npm install helmet express-rate-limit
```

### 6. é…ç½®ç¯å¢ƒå˜é‡

**æ›´æ–° `.env.example`ï¼š**

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:password@localhost:5432/geo_system

# AI APIé…ç½®
DEEPSEEK_API_KEY=your_deepseek_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# JWTå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ï¼‰
JWT_SECRET=ä½¿ç”¨_openssl_rand_-hex_32_ç”Ÿæˆ

# ç®¡ç†å‘˜è´¦å·ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ï¼‰
ADMIN_USERNAME=admin
ADMIN_PASSWORD=ä½¿ç”¨å¼ºå¯†ç 

# CORS å…è®¸çš„æ¥æºï¼ˆé€—å·åˆ†éš”ï¼‰
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com

# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_PAY_APP_ID=
WECHAT_PAY_MCH_ID=
WECHAT_PAY_API_V3_KEY=
WECHAT_PAY_SERIAL_NO=
WECHAT_PAY_PRIVATE_KEY_PATH=
WECHAT_PAY_NOTIFY_URL=

# Redisé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
REDIS_URL=redis://:password@localhost:6379
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [ ] ä¿®æ”¹ `client/vite.config.ts` ç¦ç”¨ source map
- [ ] ä¿®æ”¹ `server/src/middleware/errorHandler.ts` æ”¹è¿›é”™è¯¯å¤„ç†
- [ ] ä¿®æ”¹ `server/src/index.ts` æ·»åŠ å®‰å…¨ä¸­é—´ä»¶
- [ ] å®‰è£… `helmet` å’Œ `express-rate-limit`
- [ ] ç”Ÿæˆæ–°çš„ JWT_SECRET
- [ ] ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
- [ ] é…ç½® ALLOWED_ORIGINS
- [ ] åˆ é™¤ .git ç›®å½•ï¼ˆæˆ–ç¡®ä¿ Nginx ç¦æ­¢è®¿é—®ï¼‰

### éƒ¨ç½²æ—¶

- [ ] é…ç½® Nginx å®‰å…¨è§„åˆ™
- [ ] å¯ç”¨ HTTPSï¼ˆLet's Encryptï¼‰
- [ ] é…ç½®é˜²ç«å¢™ï¼ˆåªå¼€æ”¾ 80, 443ï¼‰
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¸è¦ä¸Šä¼  .env æ–‡ä»¶ï¼‰
- [ ] ä½¿ç”¨ `npm ci --production` å®‰è£…ä¾èµ–

### éƒ¨ç½²å

- [ ] æµ‹è¯• `.git` ç›®å½•æ˜¯å¦å¯è®¿é—®
- [ ] æµ‹è¯• `.env` æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
- [ ] æµ‹è¯•æºä»£ç ç›®å½•æ˜¯å¦å¯è®¿é—®
- [ ] æµ‹è¯• source map æ˜¯å¦å¯è®¿é—®
- [ ] æµ‹è¯•é”™è¯¯ä¿¡æ¯æ˜¯å¦å®‰å…¨
- [ ] æ£€æŸ¥ HTTP headers
- [ ] è¿è¡Œ `npm audit`

## ğŸ§ª å®‰å…¨æµ‹è¯•å‘½ä»¤

```bash
# 1. æµ‹è¯• .git ç›®å½•
curl -I https://your-domain.com/.git/config
# åº”è¯¥è¿”å› 404

# 2. æµ‹è¯• .env æ–‡ä»¶
curl -I https://your-domain.com/.env
# åº”è¯¥è¿”å› 404

# 3. æµ‹è¯•æºä»£ç 
curl -I https://your-domain.com/server/src/index.ts
# åº”è¯¥è¿”å› 404

# 4. æµ‹è¯• source map
curl -I https://your-domain.com/assets/index.js.map
# åº”è¯¥è¿”å› 404

# 5. æ£€æŸ¥ HTTP headers
curl -I https://your-domain.com
# åº”è¯¥åŒ…å«å®‰å…¨ headers

# 6. æµ‹è¯•é”™è¯¯ä¿¡æ¯
curl https://your-domain.com/api/nonexistent
# ä¸åº”è¯¥è¿”å› stack trace

# 7. æ£€æŸ¥ä¾èµ–æ¼æ´
npm audit

# 8. æ£€æŸ¥ SSL é…ç½®
openssl s_client -connect your-domain.com:443 -tls1_2
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰
- âš ï¸ Source map å¯èƒ½æš´éœ²
- âš ï¸ é”™è¯¯ä¿¡æ¯åŒ…å« message
- âš ï¸ æœåŠ¡å™¨ä¿¡æ¯æš´éœ²
- âš ï¸ æ²¡æœ‰é€Ÿç‡é™åˆ¶

### ä¼˜åŒ–å
- âœ… Source map å·²ç¦ç”¨
- âœ… é”™è¯¯ä¿¡æ¯å®‰å…¨
- âœ… æœåŠ¡å™¨ä¿¡æ¯éšè—
- âœ… æœ‰é€Ÿç‡é™åˆ¶
- âœ… æœ‰å®‰å…¨ headers
- âœ… HTTPS å¼ºåˆ¶

## ğŸ¯ æ€»ç»“

**æºä»£ç æ³„éœ²é£é™©ï¼š**
- å‰ç«¯ä»£ç ï¼šğŸŸ¡ ä¸­ç­‰ï¼ˆæ··æ·†åéš¾ä»¥ç†è§£ï¼‰
- åç«¯ä»£ç ï¼šğŸŸ¢ ä½ï¼ˆæ­£ç¡®é…ç½®åä¸ä¼šæš´éœ²ï¼‰
- æ•æ„Ÿä¿¡æ¯ï¼šğŸŸ¢ ä½ï¼ˆç¯å¢ƒå˜é‡ç®¡ç†ï¼‰

**å…³é”®é˜²æŠ¤æªæ–½ï¼š**
1. ç¦ç”¨ Source Map
2. æ”¹è¿›é”™è¯¯å¤„ç†
3. é…ç½® Nginx å®‰å…¨è§„åˆ™
4. ä½¿ç”¨ HTTPS
5. å®šæœŸå®‰å…¨æ£€æŸ¥

åªè¦æŒ‰ç…§ä»¥ä¸Šå»ºè®®é…ç½®ï¼Œä½ çš„ç³»ç»Ÿåœ¨äº‘ç«¯éƒ¨ç½²åæ˜¯å®‰å…¨çš„ï¼
