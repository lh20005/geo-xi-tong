# GEO ç³»ç»Ÿéƒ¨ç½²æœåŠ¡å™¨æ£€æŸ¥æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š2026-01-11
> ç›®æ ‡ï¼šç¡®ä¿ä¸€æ¬¡æ€§æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

---

## âœ… å·²ä¿®å¤é—®é¢˜

### 1. 001_initial_schema.sql å·²åŒ…å«å®Œæ•´è¡¨ç»“æ„
ä¹‹å‰è¯¥æ–‡ä»¶åªæ˜¯å ä½ç¬¦ï¼Œç°å·²ä¿®å¤ä¸ºåŒ…å«å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„ã€‚

### 2. è¿ç§»æ–‡ä»¶æ ¼å¼å·²ä¿®å¤
023_add_missing_quota_checks.sql ç¼ºå°‘æ ‡å‡† UP/DOWN æ ‡è®°ï¼Œå·²ä¿®å¤ã€‚

### 3. ç‰ˆæœ¬å·é—´éš™è¯´æ˜
è¿ç§»æ–‡ä»¶ç‰ˆæœ¬å·ä» 002 è·³åˆ° 011ï¼ˆè·³è¿‡ 003-010ï¼‰ï¼Œè¿™æ˜¯å†å²é—ç•™é—®é¢˜ä½†ä¸å½±å“æ‰§è¡Œï¼š
- è¿ç§»æ‰§è¡Œå™¨æŒ‰ç‰ˆæœ¬å·å­—ç¬¦ä¸²æ’åº
- `archive/` ç›®å½•ä¸­çš„æ—§æ–‡ä»¶ä¸ä¼šè¢«è¯»å–
- æ‰€æœ‰è¿ç§»æ–‡ä»¶éƒ½ä½¿ç”¨ `IF NOT EXISTS` ç¡®ä¿å¹‚ç­‰æ€§

---

## ğŸ“¦ ä¾èµ–å®‰è£…æ£€æŸ¥æ¸…å•

### æœåŠ¡å™¨ç³»ç»Ÿä¾èµ–
```bash
# Ubuntu/Debian æœåŠ¡å™¨å¿…éœ€
sudo apt update
sudo apt install -y \
  curl wget git unzip tar \
  build-essential python3 python3-pip \
  postgresql postgresql-contrib \
  redis-server \
  nginx

# Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo bash -
sudo apt install -y nodejs

# PM2 è¿›ç¨‹ç®¡ç†
sudo npm install -g pm2

# Google Chromeï¼ˆPlaywright éœ€è¦ï¼‰
wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo apt install -y ./google-chrome-stable_current_amd64.deb

# Playwright æµè§ˆå™¨ä¾èµ–ï¼ˆUbuntu 24.04ï¼‰
sudo apt install -y \
  ca-certificates fonts-liberation libappindicator3-1 libasound2t64 \
  libatk-bridge2.0-0 libatk1.0-0t64 libc6 libcairo2 libcups2t64 libdbus-1-3 \
  libexpat1 libfontconfig1 libgbm1 libgcc-s1 libglib2.0-0t64 libgtk-3-0t64 \
  libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 \
  libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 \
  libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
  lsb-release xdg-utils fonts-wqy-zenhei fonts-wqy-microhei
```

### Node.js é¡¹ç›®ä¾èµ–
```bash
# æ ¹ç›®å½•
npm install

# å„å­é¡¹ç›®
cd server && npm install
cd ../client && npm install
cd ../landing && npm install
cd ../windows-login-manager && npm install  # å¯é€‰ï¼Œä»…æ¡Œé¢åº”ç”¨éœ€è¦
```

### å…³é”®åç«¯ä¾èµ–ç‰ˆæœ¬
| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| express | ^4.18.2 | Web æ¡†æ¶ |
| pg | ^8.11.3 | PostgreSQL å®¢æˆ·ç«¯ |
| ioredis | ^5.8.2 | Redis å®¢æˆ·ç«¯ |
| playwright | ^1.57.0 | æµè§ˆå™¨è‡ªåŠ¨åŒ– |
| bcrypt | ^6.0.0 | å¯†ç åŠ å¯† |
| jsonwebtoken | ^9.0.3 | JWT è®¤è¯ |
| wechatpay-axios-plugin | ^0.9.5 | å¾®ä¿¡æ”¯ä»˜ |
| nodemailer | ^7.0.12 | é‚®ä»¶å‘é€ |

---

## ğŸ”§ ç¼–è¯‘æ„å»ºæ£€æŸ¥

### æ„å»ºå‘½ä»¤
```bash
# å®Œæ•´æ„å»ºï¼ˆæ¨èï¼‰
npm run build

# æˆ–åˆ†åˆ«æ„å»º
npm run client:build   # å‰ç«¯ â†’ client/dist/
npm run server:build   # åç«¯ â†’ server/dist/
npm run landing:build  # è½åœ°é¡µ â†’ landing/dist/
```

### TypeScript é…ç½®éªŒè¯
- åç«¯ï¼š`server/tsconfig.json` â†’ CommonJS æ¨¡å—ï¼ŒES2020 ç›®æ ‡
- å‰ç«¯ï¼š`client/tsconfig.json` â†’ ESNext æ¨¡å—ï¼Œbundler è§£æ
- è½åœ°é¡µï¼š`landing/tsconfig.json` â†’ ESNext æ¨¡å—

### æ„å»ºäº§ç‰©æ£€æŸ¥
```bash
# éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
ls -la client/dist/index.html
ls -la server/dist/index.js
ls -la landing/dist/index.html
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»è¯¦ç»†æ–¹æ¡ˆ

### è¿ç§»æ‰§è¡Œé¡ºåºï¼ˆ52 ä¸ªè¿ç§»æ–‡ä»¶ï¼‰

| ç‰ˆæœ¬ | æ–‡ä»¶å | æè¿° | ä¾èµ– |
|------|--------|------|------|
| 001 | initial_schema | åˆå§‹è¡¨ç»“æ„ | æ—  |
| 002 | add_missing_columns | æ·»åŠ ç¼ºå¤±åˆ— | 001 |
| 011 | add_user_id_to_publishing_records | ç”¨æˆ·éš”ç¦» | 001 |
| 012 | add_publishing_status_column | å‘å¸ƒçŠ¶æ€ | 011 |
| 013 | make_conversion_targets_fields_nullable | å­—æ®µå¯ç©º | 001 |
| 014 | add_usage_tracking_and_alerts | ä½¿ç”¨è·Ÿè¸ª | 001 |
| 015-026 | é…é¢ç³»ç»Ÿç›¸å…³ | é…é¢ç®¡ç† | 014 |
| 027 | add_subscription_management | è®¢é˜…ç®¡ç† | 001 |
| 028-032 | é…é¢ä¿®å¤ | é…é¢ç³»ç»Ÿä¿®å¤ | 027 |
| 033-042 | å¿«ç…§ä¿å­˜ | æ•°æ®å¿«ç…§ | 001 |
| 043-044 | agent_commission/discount | ä»£ç†ç³»ç»Ÿ | 027 |
| 045-051 | å„ç§ä¿®å¤ | Bug ä¿®å¤ | å„è‡ªä¾èµ– |
| 052 | add_email_verification | é‚®ç®±éªŒè¯ | 001 |

### æ–°æ•°æ®åº“è¿ç§»æ­¥éª¤

```bash
# 1. è¿æ¥åˆ°æœåŠ¡å™¨
ssh -i ~/.ssh/kiro.pem ubuntu@43.143.163.6

# 2. åˆ›å»ºæ•°æ®åº“
sudo -u postgres psql << EOF
DROP DATABASE IF EXISTS geo_system;
DROP USER IF EXISTS geo_user;
CREATE DATABASE geo_system;
CREATE USER geo_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE geo_system TO geo_user;
\c geo_system
GRANT ALL ON SCHEMA public TO geo_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO geo_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO geo_user;
EOF

# 3. æ‰§è¡Œè¿ç§»
cd /var/www/geo-system/server
npm run db:migrate

# 4. éªŒè¯è¿ç§»çŠ¶æ€
npm run db:status
```

### å·²æœ‰æ•°æ®åº“å¢é‡è¿ç§»

```bash
# 1. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
pg_dump -U geo_user -h localhost geo_system > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ£€æŸ¥å½“å‰è¿ç§»çŠ¶æ€
cd /var/www/geo-system/server
npm run db:status

# 3. æ‰§è¡Œå¾…è¿ç§»
npm run db:migrate

# 4. å¦‚æœå¤±è´¥ï¼Œå›æ»š
npm run db:rollback
```

### è¿ç§»å¤±è´¥æ¢å¤

```bash
# 1. æŸ¥çœ‹å¤±è´¥åŸå› 
npm run db:status

# 2. æ‰‹åŠ¨ä¿®å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo -u postgres psql geo_system

# 3. åˆ é™¤å¤±è´¥çš„è¿ç§»è®°å½•ï¼ˆè°¨æ…æ“ä½œï¼‰
DELETE FROM schema_migrations WHERE version = 'XXX';

# 4. é‡æ–°æ‰§è¡Œ
npm run db:migrate
```

---

## ğŸ” ç¯å¢ƒå˜é‡é…ç½®

### å¿…é¡»é…ç½®çš„å®‰å…¨å¯†é’¥

```bash
# ç”Ÿæˆ API_KEY_ENCRYPTION_KEYï¼ˆ32å­—èŠ‚åå…­è¿›åˆ¶ï¼‰
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# ç”Ÿæˆ JWT_SECRETï¼ˆ32å­—èŠ‚åå…­è¿›åˆ¶ï¼‰
openssl rand -hex 32

# ç”Ÿæˆ JWT_REFRESH_SECRETï¼ˆ32å­—èŠ‚åå…­è¿›åˆ¶ï¼‰
openssl rand -hex 32
```

### å®Œæ•´ .env æ¨¡æ¿

```env
# ==================== æ•°æ®åº“ ====================
DATABASE_URL=postgresql://geo_user:YOUR_DB_PASSWORD@localhost:5432/geo_system
REDIS_URL=redis://localhost:6379

# ==================== å®‰å…¨å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰====================
API_KEY_ENCRYPTION_KEY=ç”Ÿæˆçš„32å­—èŠ‚åå…­è¿›åˆ¶å­—ç¬¦ä¸²
JWT_SECRET=ç”Ÿæˆçš„32å­—èŠ‚åå…­è¿›åˆ¶å­—ç¬¦ä¸²
JWT_REFRESH_SECRET=ç”Ÿæˆçš„32å­—èŠ‚åå…­è¿›åˆ¶å­—ç¬¦ä¸²
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# ==================== æœåŠ¡å™¨é…ç½® ====================
PORT=3000
NODE_ENV=production
WEBSOCKET_PORT=8080

# ==================== ç®¡ç†å‘˜è´¦å·ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰====================
ADMIN_USERNAME=your_admin_username
ADMIN_PASSWORD=your_strong_password

# ==================== æµè§ˆå™¨è‡ªåŠ¨åŒ– ====================
PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
BROWSER_HEADLESS=true
BROWSER_TIMEOUT=60000

# ==================== é™æµé…ç½® ====================
LOGIN_RATE_LIMIT=5
LOGIN_RATE_WINDOW_MINUTES=15
REGISTRATION_RATE_LIMIT=3
REGISTRATION_RATE_WINDOW_HOURS=1

# ==================== CORS é…ç½® ====================
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com

# ==================== é‚®ä»¶æœåŠ¡ï¼ˆå¯é€‰ï¼‰====================
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=your-email@163.com
SMTP_PASS=your_smtp_password
SMTP_FROM_NAME=GEOç³»ç»Ÿ

# ==================== å¾®ä¿¡æ”¯ä»˜ï¼ˆå¯é€‰ï¼‰====================
WECHAT_PAY_APP_ID=wx1234567890abcdef
WECHAT_PAY_MCH_ID=1234567890
WECHAT_PAY_API_V3_KEY=your_32_character_api_v3_key
WECHAT_PAY_SERIAL_NO=è¯ä¹¦åºåˆ—å·
WECHAT_PAY_PRIVATE_KEY_PATH=/secure/path/to/apiclient_key.pem
WECHAT_PAY_PUBLIC_KEY_PATH=/secure/path/to/wechat_pay_public_key.pem
WECHAT_PAY_PUBLIC_KEY_ID=å…¬é’¥ID
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/payment/wechat/notify

# ==================== AI APIï¼ˆå¯é€‰ï¼Œä½¿ç”¨ç®¡ç†åå°é…ç½®ï¼‰====================
# DEEPSEEK_API_KEY=sk-xxx
# GEMINI_API_KEY=AIzaSy-xxx
OLLAMA_BASE_URL=http://localhost:11434
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤æ€»ç»“

### ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# æœ¬åœ°æ‰§è¡Œ
./scripts/deployment/deploy-to-server.sh
```

### æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

1. **æœ¬åœ°æ„å»º**
   ```bash
   npm run build
   ```

2. **ä¸Šä¼ æ–‡ä»¶**
   ```bash
   scp -r client/dist server/dist landing/dist ubuntu@server:/var/www/geo-system/
   ```

3. **æœåŠ¡å™¨é…ç½®**
   ```bash
   ssh ubuntu@server
   cd /var/www/geo-system/server
   npm ci --production
   npm run db:migrate
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   pm2 start dist/index.js --name geo-backend
   pm2 save
   ```

5. **é…ç½® Nginx**
   ```bash
   sudo cp config/nginx/geo-system.conf /etc/nginx/sites-available/
   sudo ln -sf /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/
   sudo nginx -t && sudo systemctl restart nginx
   ```

---

## âœ… éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### ä»£ç å’Œæ„å»º
- [ ] æ‰€æœ‰ä»£ç å·²æäº¤åˆ° Git
- [ ] `npm run build` æˆåŠŸå®Œæˆ
- [ ] `client/dist/`ã€`server/dist/`ã€`landing/dist/` å­˜åœ¨

### ç¯å¢ƒé…ç½®
- [ ] ç”Ÿæˆäº†æ–°çš„å®‰å…¨å¯†é’¥
- [ ] `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®
- [ ] æ•æ„Ÿä¿¡æ¯æœªæäº¤åˆ° Git

### æ•°æ®åº“
- [ ] PostgreSQL æœåŠ¡è¿è¡Œä¸­
- [ ] æ•°æ®åº“ç”¨æˆ·å’Œæƒé™å·²åˆ›å»º
- [ ] å·²å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆå¦‚æœæ˜¯æ›´æ–°ï¼‰
- [ ] `npm run db:status` æ˜¾ç¤ºæ­£ç¡®çŠ¶æ€

### æœåŠ¡
- [ ] Redis æœåŠ¡è¿è¡Œä¸­
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] PM2 å·²å®‰è£…
- [ ] Google Chrome å·²å®‰è£…ï¼ˆPlaywright éœ€è¦ï¼‰

### å®‰å…¨
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] CORS æ¥æºå·²æ­£ç¡®è®¾ç½®

---

## ğŸ“ æ•…éšœæ’é™¤

### è¿ç§»å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
npm run db:status
# æ£€æŸ¥ PostgreSQL æ—¥å¿—
sudo tail -f /var/log/postgresql/postgresql-*-main.log
```

### æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs geo-backend
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000
```

### Nginx 502 é”™è¯¯
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
pm2 status
# æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### Playwright æµè§ˆå™¨é—®é¢˜
```bash
# æ£€æŸ¥ Chrome æ˜¯å¦å®‰è£…
google-chrome --version
# æ£€æŸ¥ä¾èµ–
ldd /usr/bin/google-chrome | grep "not found"
```
