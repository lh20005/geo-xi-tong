# è¿ç§»æ–‡ä»¶æ•´ç†å®ŒæˆæŠ¥å‘Š - 2025-12-27

## æ•´ç†æ¦‚è¿°

å¯¹æ•°æ®åº“è¿ç§»æ–‡ä»¶è¿›è¡Œäº†å…¨é¢æ¸…ç†ï¼Œè§£å†³ç‰ˆæœ¬å·æ··ä¹±ã€æ–‡ä»¶é‡å¤ç­‰é—®é¢˜ã€‚

## é—®é¢˜åˆ†æ

### æ•´ç†å‰çš„é—®é¢˜

1. **ç‰ˆæœ¬å·é‡å¤** - å¤šä¸ªæ–‡ä»¶ä½¿ç”¨ç›¸åŒçš„ç‰ˆæœ¬å·ï¼ˆ001, 002, 003 ç­‰ï¼‰
2. **æ— ç‰ˆæœ¬å·æ–‡ä»¶** - 8 ä¸ªæ–‡ä»¶æ²¡æœ‰ç‰ˆæœ¬å·
3. **Rollback æ–‡ä»¶æ··æ‚** - 3 ä¸ª rollback æ–‡ä»¶æ··åœ¨è¿ç§»ç›®å½•ä¸­
4. **æ— æ³•è¿½è¸ª** - ä¸æ¸…æ¥šå“ªäº›è¿ç§»å·²æ‰§è¡Œ
5. **è¿ç§»ç³»ç»Ÿå¤±æ•ˆ** - ç‰ˆæœ¬å·é‡å¤å¯¼è‡´ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œ

### æ–‡ä»¶ç»Ÿè®¡

| ç±»å‹ | æ•°é‡ |
|------|------|
| æ€»æ–‡ä»¶æ•° | 33 ä¸ª |
| ç‰ˆæœ¬å·é‡å¤ | 19 ä¸ª |
| æ— ç‰ˆæœ¬å· | 8 ä¸ª |
| Rollback æ–‡ä»¶ | 3 ä¸ª |
| æœ‰æ•ˆè¿ç§» | 3 ä¸ª |

## æ•´ç†æ–¹æ¡ˆ

### 1. åˆ›å»ºå½’æ¡£ç›®å½•

```bash
server/src/db/migrations/archive/
```

### 2. ç§»åŠ¨æ–‡ä»¶åˆ°å½’æ¡£

#### Rollback æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
- `002_rollback_usage_tracking.sql`
- `003_rollback_smart_selection.sql`
- `rollback_001.sql`

#### æ— ç‰ˆæœ¬å·æ–‡ä»¶ï¼ˆ8ä¸ªï¼‰
- `add_article_generation.sql`
- `add_article_indexes.sql`
- `add_conversion_target_to_tasks.sql`
- `add_conversion_targets.sql`
- `add_distillation_config.sql`
- `add_publication_status.sql`
- `add_topic_usage_tracking.sql`
- `create_users_table.sql`

#### é‡å¤ç‰ˆæœ¬å·æ–‡ä»¶ï¼ˆ19ä¸ªï¼‰
- `001_add_ollama_support.sql`
- `001_create_security_tables.sql`
- `001_create_subscription_tables.sql`
- `002_add_upgrade_downgrade_support.sql`
- `002_add_usage_tracking.sql`
- `002_create_permission_tables.sql`
- `003_add_smart_selection.sql`
- `003_create_admin_logs.sql`
- `004_add_manual_distillation_support.sql`
- `004_create_security_alerts.sql`
- `005_fix_articles_distillation_fk.sql`
- `006_add_publishing_system.sql`
- `007_add_publishing_records.sql`
- `007_add_timeout_status.sql`
- `008_add_real_username.sql`
- `008_fix_publishing_records_cascade.sql`
- `009_add_platform_selectors.sql`
- `010_fix_platform_login_detection.sql`
- `011_fix_audit_logs_admin_id.sql`

**å½’æ¡£æ€»æ•°ï¼š30 ä¸ªæ–‡ä»¶**

### 3. ä¿ç•™æœ‰æ•ˆè¿ç§»

åªä¿ç•™ 3 ä¸ªæœ‰æ•ˆçš„è¿ç§»æ–‡ä»¶ï¼š

```
server/src/db/migrations/
â”œâ”€â”€ 001_initial_schema.sql              # åˆå§‹æ•°æ®åº“ç»“æ„ï¼ˆå ä½ç¬¦ï¼‰
â”œâ”€â”€ 002_add_missing_columns.sql         # æ·»åŠ ç¼ºå¤±çš„åˆ—
â””â”€â”€ 012_add_publishing_status_column.sql # æ·»åŠ å‘å¸ƒçŠ¶æ€åˆ—
```

## æ•´ç†ç»“æœ

### ç›®å½•ç»“æ„

```
server/src/db/migrations/
â”œâ”€â”€ 001_initial_schema.sql              âœ… æœ‰æ•ˆ
â”œâ”€â”€ 002_add_missing_columns.sql         âœ… æœ‰æ•ˆ
â”œâ”€â”€ 012_add_publishing_status_column.sql âœ… æœ‰æ•ˆ
â”œâ”€â”€ README.md                           ğŸ“– è¿ç§»ç³»ç»Ÿè¯´æ˜
â””â”€â”€ archive/                            ğŸ“¦ å½’æ¡£ç›®å½•
    â”œâ”€â”€ README.md                       ğŸ“– å½’æ¡£è¯´æ˜
    â”œâ”€â”€ 001_add_ollama_support.sql
    â”œâ”€â”€ 001_create_security_tables.sql
    â”œâ”€â”€ ... (å…± 30 ä¸ªæ–‡ä»¶)
    â””â”€â”€ rollback_001.sql
```

### ç»Ÿè®¡å¯¹æ¯”

| é¡¹ç›® | æ•´ç†å‰ | æ•´ç†å |
|------|--------|--------|
| è¿ç§»æ–‡ä»¶æ€»æ•° | 33 ä¸ª | 3 ä¸ª |
| å½’æ¡£æ–‡ä»¶ | 0 ä¸ª | 30 ä¸ª |
| ç‰ˆæœ¬å·å†²çª | æ˜¯ | å¦ |
| å¯è¿½è¸ªæ€§ | å·® | ä¼˜ |
| ç»´æŠ¤éš¾åº¦ | é«˜ | ä½ |

## æ•°æ®åº“å½“å‰çŠ¶æ€

### ç”Ÿäº§ç¯å¢ƒ

ç”Ÿäº§æ•°æ®åº“å·²åŒ…å«æ‰€æœ‰å¿…è¦çš„è¡¨å’Œå­—æ®µï¼š

- âœ… 40 ä¸ªè¡¨
- âœ… æ‰€æœ‰å¿…éœ€çš„åˆ—
- âœ… æ‰€æœ‰ç´¢å¼•å’Œå¤–é”®
- âœ… å‘å¸ƒç³»ç»Ÿç›¸å…³è¡¨
- âœ… å®‰å…¨ç³»ç»Ÿç›¸å…³è¡¨
- âœ… è®¢é˜…ç³»ç»Ÿç›¸å…³è¡¨
- âœ… `publishing_status` åˆ—ï¼ˆæœ€æ–°æ·»åŠ ï¼‰

### è¿ç§»å†å²

ç”±äºä¹‹å‰æ²¡æœ‰ä½¿ç”¨è¿ç§»ç³»ç»Ÿï¼Œç”Ÿäº§æ•°æ®åº“æ˜¯é€šè¿‡æ‰‹åŠ¨ SQL è„šæœ¬åˆ›å»ºçš„ã€‚

ç°åœ¨å¼€å§‹ä½¿ç”¨è¿ç§»ç³»ç»Ÿï¼Œä» 001 å¼€å§‹è®°å½•æ‰€æœ‰å˜æ›´ã€‚

## æœªæ¥è¿ç§»è§„èŒƒ

### å‘½åè§„èŒƒ

```
{ç‰ˆæœ¬å·}_{æè¿°}.sql

ç¤ºä¾‹ï¼š
013_add_user_avatar.sql
014_create_notifications_table.sql
015_add_article_tags.sql
```

### æ–‡ä»¶ç»“æ„

```sql
-- ==================== UP ====================
-- æè¿°ï¼šè¿™æ¬¡è¿ç§»åšä»€ä¹ˆ
-- ä½œè€…ï¼šä½ çš„åå­—
-- æ—¥æœŸï¼š2025-12-27

-- åœ¨è¿™é‡Œç¼–å†™å‘ä¸Šè¿ç§»çš„SQL
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar VARCHAR(500);

-- ==================== DOWN ====================
-- æè¿°ï¼šå¦‚ä½•å›æ»šè¿™æ¬¡è¿ç§»

-- åœ¨è¿™é‡Œç¼–å†™å‘ä¸‹è¿ç§»çš„SQL
ALTER TABLE users DROP COLUMN IF EXISTS avatar;
```

### æœ€ä½³å®è·µ

1. âœ… **ä½¿ç”¨ç‰ˆæœ¬å·** - é€’å¢çš„ä¸‰ä½æ•°ç‰ˆæœ¬å·
2. âœ… **å¹‚ç­‰æ€§** - ä½¿ç”¨ IF EXISTS / IF NOT EXISTS
3. âœ… **åŒ…å« UP å’Œ DOWN** - æ”¯æŒå›æ»š
4. âœ… **æ·»åŠ æ³¨é‡Š** - è¯´æ˜å˜æ›´åŸå› 
5. âœ… **æœ¬åœ°æµ‹è¯•** - åœ¨æœ¬åœ°æµ‹è¯•åå†éƒ¨ç½²
6. âœ… **ä¸€æ¬¡ä¸€ä¸ªå˜æ›´** - æ¯ä¸ªè¿ç§»åªåšä¸€ä»¶äº‹
7. âœ… **æäº¤åˆ° Git** - çº³å…¥ç‰ˆæœ¬æ§åˆ¶

## ä½¿ç”¨æŒ‡å—

### åˆ›å»ºæ–°è¿ç§»

```bash
cd server
npm run db:create -- add_user_avatar
```

### æ‰§è¡Œè¿ç§»

```bash
# æœ¬åœ°
npm run db:migrate

# ç”Ÿäº§ç¯å¢ƒ
./scripts/deployment/deploy-migrations.sh
```

### æŸ¥çœ‹çŠ¶æ€

```bash
npm run db:status
```

### å›æ»š

```bash
# å›æ»šæœ€åä¸€æ¬¡
npm run db:rollback

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
npm run db:rollback -- --to=002
```

## å½’æ¡£æ–‡ä»¶å¤„ç†

### å¦‚ä½•æŸ¥çœ‹å½’æ¡£æ–‡ä»¶

```bash
# æŸ¥çœ‹å½’æ¡£åˆ—è¡¨
ls -la server/src/db/migrations/archive/

# æŸ¥çœ‹å½’æ¡£è¯´æ˜
cat server/src/db/migrations/archive/README.md

# æŸ¥çœ‹ç‰¹å®šæ–‡ä»¶
cat server/src/db/migrations/archive/001_add_ollama_support.sql
```

### æ˜¯å¦éœ€è¦æ¢å¤ï¼Ÿ

**ä¸éœ€è¦ã€‚** å½’æ¡£æ–‡ä»¶çš„åŠŸèƒ½å·²ç»åœ¨ç”Ÿäº§æ•°æ®åº“ä¸­å®ç°ï¼Œä¸éœ€è¦é‡æ–°æ‰§è¡Œã€‚

å¦‚æœéœ€è¦å‚è€ƒæŸä¸ªåŠŸèƒ½çš„å®ç°ï¼Œå¯ä»¥æŸ¥çœ‹å½’æ¡£æ–‡ä»¶çš„å†…å®¹ã€‚

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [æ•°æ®åº“è¿ç§»æŒ‡å—](../03-éƒ¨ç½²æŒ‡å—/DATABASE_MIGRATION_GUIDE.md)
- ğŸ“– [è¿ç§»ç³»ç»Ÿæ€»ç»“](../03-éƒ¨ç½²æŒ‡å—/MIGRATION_SYSTEM_SUMMARY.md)
- ğŸ“– [è¿ç§»æ¸…ç†æŒ‡å—](../03-éƒ¨ç½²æŒ‡å—/MIGRATION_CLEANUP_GUIDE.md)
- ğŸ“– [å½’æ¡£è¯´æ˜](../../server/src/db/migrations/archive/README.md)

## æ€»ç»“

âœ… **æ¸…ç†å®Œæˆ** - å½’æ¡£ 30 ä¸ªæ—§æ–‡ä»¶  
âœ… **ç»“æ„æ¸…æ™°** - åªä¿ç•™ 3 ä¸ªæœ‰æ•ˆè¿ç§»  
âœ… **ç‰ˆæœ¬å·ç»Ÿä¸€** - è§£å†³é‡å¤é—®é¢˜  
âœ… **ä¾¿äºç»´æŠ¤** - æ–°è¿ç§»éµå¾ªç»Ÿä¸€è§„èŒƒ  
âœ… **æ–‡æ¡£å®Œæ•´** - å½’æ¡£è¯´æ˜å’Œä½¿ç”¨æŒ‡å—  

ç°åœ¨è¿ç§»ç³»ç»Ÿå¹²å‡€ã€æ¸…æ™°ã€æ˜“äºç»´æŠ¤ï¼ğŸ‰

---

**æ•´ç†æ—¶é—´**: 2025-12-27  
**æ•´ç†äºº**: Kiro AI Assistant  
**å½’æ¡£æ–‡ä»¶æ•°**: 30 ä¸ª  
**ä¿ç•™æ–‡ä»¶æ•°**: 3 ä¸ª  
**çŠ¶æ€**: âœ… å®Œæˆ
