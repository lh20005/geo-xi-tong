# æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ä¸€ã€ä¸éœ€è¦å‡çº§æœåŠ¡å™¨çš„ä¼˜åŒ–ï¼ˆç«‹å³å¯åšï¼‰

#### 1. **å‰ç«¯æ„å»ºä¼˜åŒ–** âœ… å·²å®Œæˆ
- âœ… ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰
- âœ… Tree Shaking
- âœ… å‹ç¼©å’Œæ··æ·†
- âœ… é•¿æœŸç¼“å­˜ç­–ç•¥

#### 2. **Nginx é…ç½®ä¼˜åŒ–** âœ… å·²å®Œæˆ
```bash
# ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®
sudo cp config/nginx/geo-system-optimized.conf /etc/nginx/sites-available/geo-system.conf
sudo nginx -t
sudo systemctl restart nginx
```

**ä¼˜åŒ–ç‚¹ï¼š**
- âœ… Gzip å‹ç¼©ï¼ˆå‡å°‘ä¼ è¾“å¤§å° 60-80%ï¼‰
- âœ… é™æ€æ–‡ä»¶é•¿æœŸç¼“å­˜ï¼ˆ365å¤©ï¼‰
- âœ… sendfile é›¶æ‹·è´
- âœ… æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜
- âœ… ç¼“å†²åŒºä¼˜åŒ–

#### 3. **æ•°æ®åº“ä¼˜åŒ–**
```bash
# ç¼–è¾‘ PostgreSQL é…ç½®
sudo nano /etc/postgresql/14/main/postgresql.conf
```

**æ¨èé…ç½®ï¼ˆ2æ ¸4GBæœåŠ¡å™¨ï¼‰ï¼š**
```conf
# å†…å­˜é…ç½®
shared_buffers = 1GB                    # æ€»å†…å­˜çš„ 25%
effective_cache_size = 3GB              # æ€»å†…å­˜çš„ 75%
maintenance_work_mem = 256MB
work_mem = 16MB

# è¿æ¥é…ç½®
max_connections = 100

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1                  # SSD ç¡¬ç›˜
effective_io_concurrency = 200          # SSD ç¡¬ç›˜

# WAL é…ç½®
wal_buffers = 16MB
checkpoint_completion_target = 0.9
```

```bash
# é‡å¯ PostgreSQL
sudo systemctl restart postgresql
```

#### 4. **Redis ä¼˜åŒ–**
```bash
# ç¼–è¾‘ Redis é…ç½®
sudo nano /etc/redis/redis.conf
```

**æ¨èé…ç½®ï¼š**
```conf
# å†…å­˜é™åˆ¶
maxmemory 512mb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–ï¼ˆæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼‰
save ""                                 # ç¦ç”¨ RDBï¼ˆæé«˜æ€§èƒ½ï¼‰
appendonly yes                          # å¯ç”¨ AOF
appendfsync everysec                    # æ¯ç§’åŒæ­¥

# æ€§èƒ½ä¼˜åŒ–
tcp-backlog 511
timeout 300
tcp-keepalive 60
```

```bash
# é‡å¯ Redis
sudo systemctl restart redis
```

#### 5. **Node.js è¿›ç¨‹ä¼˜åŒ–**
```bash
# ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹
npm install -g pm2

# å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨é›†ç¾¤æ¨¡å¼ï¼‰
cd /var/www/geo-system/server
pm2 start dist/index.js --name geo-server -i 2  # 2ä¸ªè¿›ç¨‹

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

#### 6. **ç³»ç»Ÿçº§ä¼˜åŒ–**
```bash
# ç¼–è¾‘ç³»ç»Ÿé™åˆ¶
sudo nano /etc/security/limits.conf
```

æ·»åŠ ï¼š
```conf
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
```

```bash
# ç¼–è¾‘ sysctl é…ç½®
sudo nano /etc/sysctl.conf
```

æ·»åŠ ï¼š
```conf
# ç½‘ç»œä¼˜åŒ–
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 1024 65535

# æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
fs.file-max = 2097152
```

```bash
# åº”ç”¨é…ç½®
sudo sysctl -p
```

---

### äºŒã€éœ€è¦å‡çº§æœåŠ¡å™¨çš„æƒ…å†µ

#### ğŸ” **å¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦å‡çº§ï¼Ÿ**

**1. ç›‘æ§å½“å‰èµ„æºä½¿ç”¨æƒ…å†µï¼š**
```bash
# CPU ä½¿ç”¨ç‡
top
htop

# å†…å­˜ä½¿ç”¨ç‡
free -h

# ç£ç›˜ I/O
iostat -x 1

# ç½‘ç»œæµé‡
iftop
```

**2. æ€§èƒ½ç“¶é¢ˆåˆ¤æ–­ï¼š**

| æŒ‡æ ‡ | æ­£å¸¸ | éœ€è¦ä¼˜åŒ– | éœ€è¦å‡çº§ |
|------|------|----------|----------|
| CPU ä½¿ç”¨ç‡ | < 60% | 60-80% | > 80% |
| å†…å­˜ä½¿ç”¨ç‡ | < 70% | 70-85% | > 85% |
| ç£ç›˜ I/O ç­‰å¾… | < 5% | 5-15% | > 15% |
| æ•°æ®åº“è¿æ¥æ•° | < 50 | 50-80 | > 80 |
| å“åº”æ—¶é—´ | < 200ms | 200-500ms | > 500ms |

#### ğŸ’° **æœåŠ¡å™¨é…ç½®å»ºè®®**

**å½“å‰é…ç½®ï¼ˆå‡è®¾ï¼‰ï¼š**
- CPU: 2æ ¸
- å†…å­˜: 4GB
- ç£ç›˜: 40GB SSD

**å‡çº§æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆ 1ï¼šè½»åº¦å‡çº§ï¼ˆé€‚åˆä¸­å°å‹åº”ç”¨ï¼‰**
- CPU: 4æ ¸
- å†…å­˜: 8GB
- ç£ç›˜: 80GB SSD
- **é¢„æœŸæå‡ï¼š** 50-100% æ€§èƒ½æå‡
- **æˆæœ¬ï¼š** çº¦ 2-3å€

**æ–¹æ¡ˆ 2ï¼šä¸­åº¦å‡çº§ï¼ˆé€‚åˆä¸­å‹åº”ç”¨ï¼‰**
- CPU: 8æ ¸
- å†…å­˜: 16GB
- ç£ç›˜: 160GB SSD
- **é¢„æœŸæå‡ï¼š** 100-200% æ€§èƒ½æå‡
- **æˆæœ¬ï¼š** çº¦ 4-5å€

**æ–¹æ¡ˆ 3ï¼šé‡åº¦å‡çº§ï¼ˆé€‚åˆå¤§å‹åº”ç”¨ï¼‰**
- CPU: 16æ ¸
- å†…å­˜: 32GB
- ç£ç›˜: 320GB SSD
- **é¢„æœŸæå‡ï¼š** 200-400% æ€§èƒ½æå‡
- **æˆæœ¬ï¼š** çº¦ 8-10å€

---

### ä¸‰ã€æ€§èƒ½ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

#### ğŸ“ˆ **ä¼˜åŒ–å‰ vs ä¼˜åŒ–å**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | é…ç½®ä¼˜åŒ–å | å‡çº§æœåŠ¡å™¨å |
|------|--------|------------|--------------|
| é¦–å±åŠ è½½æ—¶é—´ | 3-5ç§’ | 1-2ç§’ | 0.5-1ç§’ |
| API å“åº”æ—¶é—´ | 200-500ms | 100-200ms | 50-100ms |
| å¹¶å‘ç”¨æˆ·æ•° | 50 | 100-150 | 300-500 |
| é™æ€èµ„æºåŠ è½½ | 2-3ç§’ | 0.5-1ç§’ | 0.2-0.5ç§’ |

#### ğŸ’¡ **æ€§ä»·æ¯”åˆ†æ**

1. **é…ç½®ä¼˜åŒ–ï¼ˆå…è´¹ï¼‰**
   - æˆæœ¬ï¼š0å…ƒ
   - æ•ˆæœï¼š50-70% æ€§èƒ½æå‡
   - **æ¨èæŒ‡æ•°ï¼šâ­â­â­â­â­**

2. **è½»åº¦å‡çº§ï¼ˆä½æˆæœ¬ï¼‰**
   - æˆæœ¬ï¼šçº¦ 100-200å…ƒ/æœˆ
   - æ•ˆæœï¼š100-150% æ€§èƒ½æå‡
   - **æ¨èæŒ‡æ•°ï¼šâ­â­â­â­**

3. **ä¸­åº¦å‡çº§ï¼ˆä¸­ç­‰æˆæœ¬ï¼‰**
   - æˆæœ¬ï¼šçº¦ 300-500å…ƒ/æœˆ
   - æ•ˆæœï¼š200-300% æ€§èƒ½æå‡
   - **æ¨èæŒ‡æ•°ï¼šâ­â­â­**

4. **é‡åº¦å‡çº§ï¼ˆé«˜æˆæœ¬ï¼‰**
   - æˆæœ¬ï¼šçº¦ 800-1500å…ƒ/æœˆ
   - æ•ˆæœï¼š400-600% æ€§èƒ½æå‡
   - **æ¨èæŒ‡æ•°ï¼šâ­â­**ï¼ˆé™¤éç”¨æˆ·é‡å¾ˆå¤§ï¼‰

---

### å››ã€CDN åŠ é€Ÿï¼ˆæ¨èï¼‰

#### ğŸš€ **ä½¿ç”¨ CDN çš„å¥½å¤„**
- âœ… é™æ€èµ„æºåŠ è½½é€Ÿåº¦æå‡ 3-10å€
- âœ… å‡å°‘æœåŠ¡å™¨å¸¦å®½å‹åŠ›
- âœ… æé«˜å…¨å›½/å…¨çƒè®¿é—®é€Ÿåº¦
- âœ… æˆæœ¬ç›¸å¯¹è¾ƒä½

#### ğŸ“¦ **æ¨èçš„ CDN æœåŠ¡**

**1. è…¾è®¯äº‘ CDN**
- ä»·æ ¼ï¼šçº¦ 0.2å…ƒ/GB
- é¦–æœˆå…è´¹æµé‡ï¼š50GB
- é€‚åˆï¼šå›½å†…ç”¨æˆ·

**2. é˜¿é‡Œäº‘ CDN**
- ä»·æ ¼ï¼šçº¦ 0.24å…ƒ/GB
- é¦–æœˆå…è´¹æµé‡ï¼š50GB
- é€‚åˆï¼šå›½å†…ç”¨æˆ·

**3. Cloudflareï¼ˆå…è´¹ï¼‰**
- ä»·æ ¼ï¼šå…è´¹
- æµé‡ï¼šä¸é™
- é€‚åˆï¼šå›½é™…ç”¨æˆ·

#### ğŸ”§ **CDN é…ç½®æ­¥éª¤**

1. **æ³¨å†Œ CDN æœåŠ¡**
2. **æ·»åŠ åŠ é€ŸåŸŸå**
3. **é…ç½®æºç«™**ï¼ˆä½ çš„æœåŠ¡å™¨IPï¼‰
4. **ä¿®æ”¹ DNS è§£æ**
5. **é…ç½®ç¼“å­˜è§„åˆ™**

**ç¼“å­˜è§„åˆ™ç¤ºä¾‹ï¼š**
```
/app/assets/js/*.js     -> ç¼“å­˜ 365å¤©
/app/assets/css/*.css   -> ç¼“å­˜ 365å¤©
/app/assets/img/*       -> ç¼“å­˜ 365å¤©
/uploads/*              -> ç¼“å­˜ 30å¤©
/api/*                  -> ä¸ç¼“å­˜
```

---

### äº”ã€ç›‘æ§å’ŒæŒç»­ä¼˜åŒ–

#### ğŸ“Š **æ€§èƒ½ç›‘æ§å·¥å…·**

**1. å‰ç«¯æ€§èƒ½ç›‘æ§**
```bash
# ä½¿ç”¨ Lighthouse
npm install -g lighthouse
lighthouse https://your-domain.com --view
```

**2. æœåŠ¡å™¨ç›‘æ§**
```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt install htop iotop iftop

# å®æ—¶ç›‘æ§
htop           # CPU/å†…å­˜
iotop          # ç£ç›˜I/O
iftop          # ç½‘ç»œæµé‡
```

**3. åº”ç”¨æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰**
- æ¨èï¼šé˜¿é‡Œäº‘ ARMSã€è…¾è®¯äº‘ APM
- åŠŸèƒ½ï¼šAPI å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€æ…¢æŸ¥è¯¢ç­‰

#### ğŸ” **æ€§èƒ½åˆ†ææ¸…å•**

- [ ] å‰ç«¯æ‰“åŒ…ä½“ç§¯æ˜¯å¦è¿‡å¤§ï¼Ÿï¼ˆ> 1MBï¼‰
- [ ] æ˜¯å¦å¯ç”¨äº† Gzip å‹ç¼©ï¼Ÿ
- [ ] é™æ€èµ„æºæ˜¯å¦è®¾ç½®äº†é•¿æœŸç¼“å­˜ï¼Ÿ
- [ ] æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦æœ‰æ…¢æŸ¥è¯¢ï¼Ÿï¼ˆ> 100msï¼‰
- [ ] Redis ç¼“å­˜å‘½ä¸­ç‡æ˜¯å¦è¶³å¤Ÿï¼Ÿï¼ˆ> 80%ï¼‰
- [ ] API å“åº”æ—¶é—´æ˜¯å¦æ­£å¸¸ï¼Ÿï¼ˆ< 200msï¼‰
- [ ] æœåŠ¡å™¨ CPU/å†…å­˜æ˜¯å¦å……è¶³ï¼Ÿï¼ˆ< 70%ï¼‰

---

### å…­ã€å¿«é€Ÿä¼˜åŒ–æ£€æŸ¥è¡¨

#### âœ… **ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰**
- [ ] ä½¿ç”¨ä¼˜åŒ–åçš„ Vite é…ç½®é‡æ–°æ„å»º
- [ ] ä½¿ç”¨ä¼˜åŒ–åçš„ Nginx é…ç½®
- [ ] æ¸…ç†æµè§ˆå™¨ç¼“å­˜æµ‹è¯•

#### âœ… **çŸ­æœŸä¼˜åŒ–ï¼ˆ1å°æ—¶ï¼‰**
- [ ] ä¼˜åŒ– PostgreSQL é…ç½®
- [ ] ä¼˜åŒ– Redis é…ç½®
- [ ] ä½¿ç”¨ PM2 é›†ç¾¤æ¨¡å¼
- [ ] é…ç½®ç³»ç»Ÿå‚æ•°

#### âœ… **ä¸­æœŸä¼˜åŒ–ï¼ˆ1å¤©ï¼‰**
- [ ] æ¥å…¥ CDN æœåŠ¡
- [ ] é…ç½®æ€§èƒ½ç›‘æ§
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] ä»£ç å±‚é¢ä¼˜åŒ–

#### âœ… **é•¿æœŸä¼˜åŒ–ï¼ˆæŒç»­ï¼‰**
- [ ] ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- [ ] æ ¹æ®æ•°æ®å†³å®šæ˜¯å¦å‡çº§æœåŠ¡å™¨
- [ ] æŒç»­ä¼˜åŒ–ä»£ç å’ŒæŸ¥è¯¢

---

## ğŸ¯ æ€»ç»“

**æ¨èä¼˜åŒ–é¡ºåºï¼š**
1. **å…ˆåšé…ç½®ä¼˜åŒ–**ï¼ˆå…è´¹ï¼Œæ•ˆæœæ˜æ˜¾ï¼‰
2. **æ¥å…¥ CDN**ï¼ˆä½æˆæœ¬ï¼Œæ•ˆæœæ˜¾è‘—ï¼‰
3. **ç›‘æ§æ€§èƒ½æŒ‡æ ‡**ï¼ˆäº†è§£çœŸå®ç“¶é¢ˆï¼‰
4. **æ ¹æ®æ•°æ®å†³å®šæ˜¯å¦å‡çº§æœåŠ¡å™¨**

**å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé…ç½®ä¼˜åŒ– + CDN å°±èƒ½è§£å†³ 80% çš„æ€§èƒ½é—®é¢˜ï¼Œä¸éœ€è¦ç«‹å³å‡çº§æœåŠ¡å™¨ã€‚**

åªæœ‰å½“ä½ çš„åº”ç”¨çœŸæ­£é‡åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œæ‰è€ƒè™‘å‡çº§æœåŠ¡å™¨ï¼š
- å¹¶å‘ç”¨æˆ·æ•° > 100
- CPU æŒç»­ > 80%
- å†…å­˜æŒç»­ > 85%
- æ•°æ®åº“è¿æ¥æ•° > 80

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹æ—¥å¿—ï¼š`/var/log/nginx/geo-system-error.log`
2. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`sudo systemctl status nginx postgresql redis`
3. æ€§èƒ½æµ‹è¯•ï¼š`ab -n 1000 -c 10 http://your-domain.com/`
