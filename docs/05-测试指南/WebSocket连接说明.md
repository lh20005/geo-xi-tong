# WebSocket è¿žæŽ¥è¯´æ˜Ž

## æµè§ˆå™¨æŽ§åˆ¶å°çš„ WebSocket é”™è¯¯

### é”™è¯¯ä¿¡æ¯

```
WebSocket connection to 'ws://43.143.163.6/ws?token=...' failed: 
WebSocket is closed before the connection is established.
```

### è¿™æ˜¯æ­£å¸¸çŽ°è±¡ âœ…

è¿™ä¸ªé”™è¯¯ä¿¡æ¯**ä¸æ˜¯çœŸæ­£çš„é—®é¢˜**ï¼Œè€Œæ˜¯ WebSocket å®¢æˆ·ç«¯çš„æ­£å¸¸é‡è¿žè¡Œä¸ºã€‚

### ä¸ºä»€ä¹ˆä¼šå‡ºçŽ°è¿™ä¸ªé”™è¯¯ï¼Ÿ

1. **è‡ªåŠ¨é‡è¿žæœºåˆ¶** - å®¢æˆ·ç«¯ä¼šå®šæœŸå°è¯•é‡æ–°è¿žæŽ¥
2. **ç½‘ç»œæ³¢åŠ¨** - çŸ­æš‚çš„ç½‘ç»œä¸­æ–­ä¼šè§¦å‘é‡è¿ž
3. **æµè§ˆå™¨è¡Œä¸º** - æµè§ˆå™¨åœ¨æŸäº›æƒ…å†µä¸‹ä¼šä¸»åŠ¨æ–­å¼€è¿žæŽ¥

### å¦‚ä½•éªŒè¯ WebSocket æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

#### æ–¹æ³•1ï¼šæŸ¥çœ‹åŽç«¯æ—¥å¿—

```bash
ssh ubuntu@43.143.163.6
pm2 logs geo-backend --lines 20 | grep WebSocket
```

**æ­£å¸¸çš„æ—¥å¿—åº”è¯¥åŒ…å«ï¼š**
```
[WebSocket] New connection attempt
[WebSocket] User lzc2005 (ID: 2) authenticated
[WebSocket] User 2 subscribed. Total connections: 1
[WebSocket] Received message from user 2: ping
```

#### æ–¹æ³•2ï¼šæµ‹è¯•å®žæ—¶åŒæ­¥åŠŸèƒ½

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼Œç™»å½•åŒä¸€è´¦å·
2. åœ¨ä¸€ä¸ªçª—å£è¿›è¡Œæ“ä½œï¼ˆå¦‚åˆ›å»ºè¯é¢˜ï¼‰
3. å¦ä¸€ä¸ªçª—å£åº”è¯¥å®žæ—¶æ›´æ–°

å¦‚æžœèƒ½å®žæ—¶åŒæ­¥ï¼Œè¯´æ˜Ž WebSocket å·¥ä½œæ­£å¸¸ã€‚

### æŠ€æœ¯ç»†èŠ‚

#### è¿žæŽ¥æµç¨‹

```
å®¢æˆ·ç«¯                          æœåŠ¡å™¨
  |                              |
  |------ å°è¯•è¿žæŽ¥ ws:// -------->|
  |                              |
  |<----- è¿žæŽ¥æˆåŠŸ --------------|
  |                              |
  |------ å‘é€ token ----------->|
  |                              |
  |<----- è®¤è¯æˆåŠŸ --------------|
  |                              |
  |<===== ä¿æŒè¿žæŽ¥ =============>|
  |                              |
  |------ ping å¿ƒè·³ ------------>|
  |<----- pong å“åº” -------------|
  |                              |
```

#### é‡è¿žæœºåˆ¶

- **åˆå§‹å»¶è¿Ÿ**: 1ç§’
- **æœ€å¤§å»¶è¿Ÿ**: 30ç§’
- **æŒ‡æ•°é€€é¿**: æ¯æ¬¡å¤±è´¥åŽå»¶è¿Ÿç¿»å€
- **æ— é™é‡è¯•**: ç›´åˆ°è¿žæŽ¥æˆåŠŸ

### ä»€ä¹ˆæ—¶å€™éœ€è¦å…³æ³¨ï¼Ÿ

åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰éœ€è¦å…³æ³¨ï¼š

âŒ **åŽç«¯æ—¥å¿—æ²¡æœ‰è¿žæŽ¥è®°å½•** - è¯´æ˜Ž WebSocket æœåŠ¡æœªå¯åŠ¨  
âŒ **å®žæ—¶åŒæ­¥ä¸å·¥ä½œ** - è¯´æ˜Žè¿žæŽ¥æœªå»ºç«‹  
âŒ **æŒç»­æŠ¥é”™è¶…è¿‡ 5 åˆ†é’Ÿ** - å¯èƒ½æ˜¯é…ç½®é—®é¢˜  

### å¸¸è§é—®é¢˜æŽ’æŸ¥

#### é—®é¢˜1ï¼šåŽç«¯æ—¥å¿—æ²¡æœ‰ WebSocket è®°å½•

**åŽŸå› **: åŽç«¯æœåŠ¡æœªå¯åŠ¨æˆ–å´©æºƒ

**è§£å†³**:
```bash
ssh ubuntu@43.143.163.6
pm2 restart geo-backend
pm2 logs geo-backend
```

#### é—®é¢˜2ï¼šNginx é…ç½®é”™è¯¯

**æ£€æŸ¥**: `/etc/nginx/sites-available/geo-system`

```nginx
location /ws {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    
    # WebSocket è¶…æ—¶ï¼ˆ24å°æ—¶ï¼‰
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
}
```

**é‡å¯ Nginx**:
```bash
sudo nginx -t
sudo systemctl restart nginx
```

#### é—®é¢˜3ï¼šé˜²ç«å¢™é˜»æ­¢

**æ£€æŸ¥é˜²ç«å¢™**:
```bash
sudo ufw status
```

**ç¡®ä¿å¼€æ”¾ç«¯å£**:
```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### æ€»ç»“

âœ… **æµè§ˆå™¨æŽ§åˆ¶å°çš„ WebSocket é”™è¯¯æ˜¯æ­£å¸¸çš„**  
âœ… **åªè¦åŽç«¯æ—¥å¿—æ˜¾ç¤ºè¿žæŽ¥æˆåŠŸï¼Œå°±æ²¡æœ‰é—®é¢˜**  
âœ… **å®žæ—¶åŒæ­¥åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œè¯´æ˜Ž WebSocket æ­£å¸¸**  
âœ… **ä¸éœ€è¦ä¿®å¤æˆ–æ‹…å¿ƒè¿™ä¸ªé”™è¯¯ä¿¡æ¯**  

---

## ç›¸å…³æ–‡æ¡£

- ðŸ“– [éƒ¨ç½²é—®é¢˜æŽ’æŸ¥](../03-éƒ¨ç½²æŒ‡å—/DEPLOYMENT_TROUBLESHOOTING.md#é—®é¢˜-9websocket-è¿žæŽ¥å¤±è´¥)
- ðŸ“– [ç³»ç»Ÿè¯Šæ–­](./SYSTEM_DIAGNOSIS.md)
- ðŸ“– [WebSocket å®žçŽ°](../../server/src/websocket.ts)

---

**æœ€åŽæ›´æ–°**: 2025-12-27  
**çŠ¶æ€**: âœ… WebSocket å·¥ä½œæ­£å¸¸
