# å•†å“è®¢å•ç³»ç»Ÿå®Œæ•´è®¾è®¡è¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

ä½ çš„ç³»ç»Ÿé‡‡ç”¨äº†**æ··åˆæ–¹æ¡ˆ**è®¾è®¡ï¼Œç»“åˆäº†ä»£ç å®šä¹‰å’Œæ•°æ®åº“é…ç½®çš„ä¼˜ç‚¹ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

âœ… **å•†å“é…ç½®å¯ç®¡ç†** - ç®¡ç†å‘˜å¯ä»¥åœ¨ç½‘é¡µç«¯ä¿®æ”¹å¥—é¤ä»·æ ¼å’Œé…é¢
âœ… **è‡ªåŠ¨ç”Ÿæ•ˆ** - ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
âœ… **æ”¯ä»˜é›†æˆ** - é›†æˆå¾®ä¿¡æ”¯ä»˜ï¼Œè‡ªåŠ¨ç”ŸæˆäºŒç»´ç 
âœ… **è®¢å•è‡ªåŠ¨å¤„ç†** - æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å¼€é€šè®¢é˜…
âœ… **é…é¢è‡ªåŠ¨ç®¡ç†** - æ ¹æ®å¥—é¤è‡ªåŠ¨åˆ†é…å’Œæ£€æŸ¥é…é¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### 1. æ•°æ®åº“è®¾è®¡

```
subscription_plans (å¥—é¤è¡¨)
â”œâ”€â”€ id
â”œâ”€â”€ plan_code (free/professional/enterprise)
â”œâ”€â”€ plan_name (ä½“éªŒç‰ˆ/ä¸“ä¸šç‰ˆ/ä¼ä¸šç‰ˆ)
â”œâ”€â”€ price (ä»·æ ¼)
â”œâ”€â”€ is_active (æ˜¯å¦å¯ç”¨)
â””â”€â”€ display_order (æ˜¾ç¤ºé¡ºåº)

plan_features (å¥—é¤åŠŸèƒ½è¡¨)
â”œâ”€â”€ id
â”œâ”€â”€ plan_id (å…³è”å¥—é¤)
â”œâ”€â”€ feature_code (åŠŸèƒ½ä»£ç )
â”œâ”€â”€ feature_name (åŠŸèƒ½åç§°)
â”œâ”€â”€ feature_value (é…é¢å€¼ï¼Œ-1è¡¨ç¤ºæ— é™)
â””â”€â”€ feature_unit (å•ä½)

user_subscriptions (ç”¨æˆ·è®¢é˜…è¡¨)
â”œâ”€â”€ id
â”œâ”€â”€ user_id (ç”¨æˆ·ID)
â”œâ”€â”€ plan_id (å¥—é¤ID)
â”œâ”€â”€ status (active/expired/cancelled)
â”œâ”€â”€ start_date (å¼€å§‹æ—¥æœŸ)
â”œâ”€â”€ end_date (ç»“æŸæ—¥æœŸ)
â””â”€â”€ auto_renew (æ˜¯å¦è‡ªåŠ¨ç»­è´¹)

orders (è®¢å•è¡¨)
â”œâ”€â”€ id
â”œâ”€â”€ order_no (è®¢å•å·)
â”œâ”€â”€ user_id (ç”¨æˆ·ID)
â”œâ”€â”€ plan_id (å¥—é¤ID)
â”œâ”€â”€ order_type (purchase/upgrade)
â”œâ”€â”€ amount (é‡‘é¢)
â”œâ”€â”€ status (pending/paid/cancelled)
â”œâ”€â”€ qr_code_url (æ”¯ä»˜äºŒç»´ç )
â””â”€â”€ payment_time (æ”¯ä»˜æ—¶é—´)

product_config_history (é…ç½®å†å²è¡¨)
â”œâ”€â”€ id
â”œâ”€â”€ plan_id (å¥—é¤ID)
â”œâ”€â”€ changed_by (ä¿®æ”¹äºº)
â”œâ”€â”€ change_type (price/feature/status)
â”œâ”€â”€ field_name (å­—æ®µå)
â”œâ”€â”€ old_value (æ—§å€¼)
â”œâ”€â”€ new_value (æ–°å€¼)
â””â”€â”€ created_at (ä¿®æ”¹æ—¶é—´)
```

### 2. æœåŠ¡å±‚è®¾è®¡

```typescript
ProductService (å•†å“ç®¡ç†æœåŠ¡)
â”œâ”€â”€ updatePlan() - æ›´æ–°å¥—é¤é…ç½®
â”œâ”€â”€ recordConfigChange() - è®°å½•é…ç½®å˜æ›´
â”œâ”€â”€ getConfigHistory() - è·å–é…ç½®å†å²
â””â”€â”€ rollbackConfig() - å›æ»šé…ç½®

SubscriptionService (è®¢é˜…æœåŠ¡)
â”œâ”€â”€ getPlanConfig() - è·å–å¥—é¤é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰
â”œâ”€â”€ getUserActiveSubscription() - è·å–ç”¨æˆ·å½“å‰è®¢é˜…
â”œâ”€â”€ canUserPerformAction() - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥æ‰§è¡Œæ“ä½œ
â”œâ”€â”€ recordUsage() - è®°å½•ç”¨æˆ·ä½¿ç”¨é‡
â””â”€â”€ activateSubscription() - æ¿€æ´»è®¢é˜…

PaymentService (æ”¯ä»˜æœåŠ¡)
â”œâ”€â”€ createWeChatPayOrder() - åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•
â”œâ”€â”€ handleWeChatPayNotify() - å¤„ç†æ”¯ä»˜å›è°ƒ
â””â”€â”€ queryOrderStatus() - æŸ¥è¯¢è®¢å•çŠ¶æ€

OrderService (è®¢å•æœåŠ¡)
â”œâ”€â”€ createOrder() - åˆ›å»ºè®¢å•
â”œâ”€â”€ getOrderByNo() - è·å–è®¢å•è¯¦æƒ…
â”œâ”€â”€ getUserOrders() - è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
â””â”€â”€ updateOrderStatus() - æ›´æ–°è®¢å•çŠ¶æ€
```

---

## ğŸ”„ å®Œæ•´æµç¨‹è¯´æ˜

### æµç¨‹ä¸€ï¼šç®¡ç†å‘˜ä¿®æ”¹å•†å“é…ç½®

```
1. ç®¡ç†å‘˜ç™»å½•åå°
   â†“
2. è¿›å…¥"å•†å“ç®¡ç†"é¡µé¢
   â†“
3. ç‚¹å‡»"ç¼–è¾‘å¥—é¤"
   â†“
4. ä¿®æ”¹ä»·æ ¼æˆ–é…é¢
   ä¾‹å¦‚ï¼šå°†ä¸“ä¸šç‰ˆä»·æ ¼ä» 99 æ”¹ä¸º 89
        å°†æ¯æœˆæ–‡ç« æ•°ä» 100 æ”¹ä¸º 150
   â†“
5. ç‚¹å‡»"ä¿å­˜"
   â†“
6. åç«¯å¤„ç†ï¼š
   - æ›´æ–° subscription_plans è¡¨ï¼ˆä»·æ ¼ï¼‰
   - æ›´æ–° plan_features è¡¨ï¼ˆé…é¢ï¼‰
   - è®°å½•åˆ° product_config_historyï¼ˆå†å²ï¼‰
   - è®°å½•åˆ° admin_logsï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
   - æ¸…é™¤ Redis ç¼“å­˜
   â†“
7. ç«‹å³ç”Ÿæ•ˆ âœ…
   - æ–°ç”¨æˆ·è´­ä¹°æ—¶ä½¿ç”¨æ–°ä»·æ ¼
   - æ–°ç”¨æˆ·è·å¾—æ–°é…é¢
   - å·²æœ‰ç”¨æˆ·ä¸å—å½±å“ï¼ˆé™¤éå‡çº§ï¼‰
```

### æµç¨‹äºŒï¼šç”¨æˆ·è´­ä¹°å¥—é¤

```
1. ç”¨æˆ·è®¿é—®è½åœ°é¡µ
   â†“
2. æŸ¥çœ‹å¥—é¤ä»·æ ¼ï¼ˆä»æ•°æ®åº“è¯»å–æœ€æ–°é…ç½®ï¼‰
   GET /api/subscription/plans
   è¿”å›ï¼š
   {
     "free": { "price": 0, "features": {...} },
     "professional": { "price": 89, "features": {...} },
     "enterprise": { "price": 299, "features": {...} }
   }
   â†“
3. ç”¨æˆ·é€‰æ‹©"ä¸“ä¸šç‰ˆ"ï¼Œç‚¹å‡»"ç«‹å³è´­ä¹°"
   â†“
4. è·³è½¬åˆ°ç™»å½•é¡µï¼ˆå¦‚æœæœªç™»å½•ï¼‰
   â†“
5. ç™»å½•åè¿›å…¥ä¸»åº”ç”¨
   â†“
6. ç‚¹å‡»"ä¸ªäººä¸­å¿ƒ" â†’ "æˆ‘çš„è®¢é˜…" â†’ "å‡çº§å¥—é¤"
   â†“
7. é€‰æ‹©å¥—é¤ï¼Œç‚¹å‡»"ç«‹å³è´­ä¹°"
   â†“
8. å‰ç«¯è°ƒç”¨ï¼š
   POST /api/orders
   {
     "plan_id": 2,  // ä¸“ä¸šç‰ˆID
     "order_type": "purchase"
   }
   â†“
9. åç«¯å¤„ç†ï¼š
   a. éªŒè¯ç”¨æˆ·èº«ä»½
   b. è·å–å¥—é¤ä¿¡æ¯ï¼ˆä»æ•°æ®åº“ï¼Œä½¿ç”¨æœ€æ–°é…ç½®ï¼‰
   c. åˆ›å»ºè®¢å•è®°å½•
   d. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API
   e. ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
   f. è¿”å›è®¢å•ä¿¡æ¯å’ŒäºŒç»´ç URL
   â†“
10. å‰ç«¯æ˜¾ç¤ºï¼š
    - è®¢å•å·ï¼šORD20251225123456
    - é‡‘é¢ï¼šÂ¥89
    - äºŒç»´ç ï¼ˆç”¨æˆ·æ‰«ç æ”¯ä»˜ï¼‰
    â†“
11. ç”¨æˆ·æ‰«ç æ”¯ä»˜
    â†“
12. å¾®ä¿¡æ”¯ä»˜å›è°ƒï¼š
    POST /api/payment/wechat/notify
    â†“
13. åç«¯å¤„ç†å›è°ƒï¼š
    a. éªŒè¯ç­¾å
    b. è§£å¯†æ•°æ®
    c. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²æ”¯ä»˜"
    d. è°ƒç”¨ subscriptionService.activateSubscription()
    e. åˆ›å»ºç”¨æˆ·è®¢é˜…è®°å½•
    f. åˆ†é…å¥—é¤é…é¢
    g. é€šè¿‡ WebSocket æ¨é€é€šçŸ¥
    â†“
14. å‰ç«¯è‡ªåŠ¨åˆ·æ–°ï¼š
    - è®¢å•çŠ¶æ€å˜ä¸º"å·²æ”¯ä»˜"
    - è·³è½¬åˆ°"æˆ‘çš„è®¢é˜…"é¡µé¢
    - æ˜¾ç¤ºæ–°å¥—é¤ä¿¡æ¯å’Œé…é¢
    â†“
15. ç”¨æˆ·å¼€å§‹ä½¿ç”¨ âœ…
```

### æµç¨‹ä¸‰ï¼šç”¨æˆ·ä½¿ç”¨åŠŸèƒ½ï¼ˆé…é¢æ£€æŸ¥ï¼‰

```
1. ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆæ–‡ç« "
   â†“
2. å‰ç«¯è°ƒç”¨ï¼š
   POST /api/articles/generate
   â†“
3. åç«¯ä¸­é—´ä»¶æ£€æŸ¥ï¼š
   checkQuota('articles_per_month')
   â†“
4. è·å–ç”¨æˆ·è®¢é˜…ä¿¡æ¯ï¼š
   - æŸ¥è¯¢ user_subscriptions è¡¨
   - è·å–å½“å‰å¥—é¤ID
   â†“
5. è·å–å¥—é¤é…é¢ï¼š
   - ä» Redis ç¼“å­˜è¯»å–ï¼ˆå¦‚æœæœ‰ï¼‰
   - æˆ–ä»æ•°æ®åº“è¯»å–ï¼ˆplan_features è¡¨ï¼‰
   - ä¾‹å¦‚ï¼šä¸“ä¸šç‰ˆæ¯æœˆ150ç¯‡
   â†“
6. è·å–ç”¨æˆ·å·²ä½¿ç”¨é‡ï¼š
   - æŸ¥è¯¢ user_usage è¡¨
   - ä¾‹å¦‚ï¼šæœ¬æœˆå·²ç”Ÿæˆ45ç¯‡
   â†“
7. åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»§ç»­ï¼š
   if (å·²ä½¿ç”¨ < é…é¢) {
     å…è®¸ç»§ç»­ âœ…
   } else {
     è¿”å› 403 é”™è¯¯ âŒ
     æç¤ºï¼š"ä¸“ä¸šç‰ˆé…é¢å·²ç”¨å®Œï¼Œè¯·å‡çº§å¥—é¤"
   }
   â†“
8. å¦‚æœå…è®¸ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼š
   - ç”Ÿæˆæ–‡ç« 
   - è®°å½•ä½¿ç”¨é‡ +1
   - è¿”å›ç»“æœ
   â†“
9. å‰ç«¯æ˜¾ç¤ºï¼š
   - æ–‡ç« ç”ŸæˆæˆåŠŸ
   - é…é¢ä½¿ç”¨æƒ…å†µï¼š45/150
```

### æµç¨‹å››ï¼šå¥—é¤å‡çº§

```
1. ç”¨æˆ·å½“å‰æ˜¯"ä½“éªŒç‰ˆ"ï¼ˆå…è´¹ï¼‰
   â†“
2. æƒ³å‡çº§åˆ°"ä¸“ä¸šç‰ˆ"
   â†“
3. ç‚¹å‡»"å‡çº§å¥—é¤"
   â†“
4. å‰ç«¯è°ƒç”¨ï¼š
   POST /api/orders
   {
     "plan_id": 2,  // ä¸“ä¸šç‰ˆ
     "order_type": "upgrade"
   }
   â†“
5. åç«¯å¤„ç†ï¼š
   a. æ£€æŸ¥å½“å‰è®¢é˜…çŠ¶æ€
   b. è®¡ç®—å·®ä»·ï¼ˆå¦‚æœæ˜¯æœˆä¸­å‡çº§ï¼‰
   c. åˆ›å»ºå‡çº§è®¢å•
   d. ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
   â†“
6. ç”¨æˆ·æ”¯ä»˜
   â†“
7. æ”¯ä»˜æˆåŠŸåï¼š
   a. æ›´æ–°è®¢é˜…è®°å½•
   b. ç«‹å³ç”Ÿæ•ˆæ–°é…é¢ âœ…
   c. ç”¨æˆ·å¯ä»¥ä½¿ç”¨æ–°åŠŸèƒ½
```

---

## ğŸ¯ å…³é”®é—®é¢˜è§£ç­”

### Q1: ä¿®æ”¹å•†å“é…ç½®åï¼Œå‰ç«¯æ‰«ç ä¼šè‡ªåŠ¨ä½¿ç”¨æœ€æ–°é…ç½®å—ï¼Ÿ

**ç­”ï¼šæ˜¯çš„ï¼âœ…**

**åŸå› ï¼š**
1. å•†å“é…ç½®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
2. åˆ›å»ºè®¢å•æ—¶ä»æ•°æ®åº“è¯»å–æœ€æ–°é…ç½®
3. ç”ŸæˆäºŒç»´ç æ—¶ä½¿ç”¨æœ€æ–°ä»·æ ¼
4. æ”¯ä»˜æˆåŠŸåæŒ‰æœ€æ–°é…ç½®å¼€é€šè®¢é˜…

**æµç¨‹ï¼š**
```
ç®¡ç†å‘˜ä¿®æ”¹ä»·æ ¼ï¼š99 â†’ 89
     â†“
ä¿å­˜åˆ°æ•°æ®åº“
     â†“
æ¸…é™¤ç¼“å­˜
     â†“
ç”¨æˆ·åˆ›å»ºè®¢å•ï¼ˆè¯»å–æ•°æ®åº“ï¼‰
     â†“
ç”ŸæˆäºŒç»´ç ï¼ˆé‡‘é¢ï¼š89ï¼‰
     â†“
ç”¨æˆ·æ‰«ç æ”¯ä»˜ï¼ˆæ”¯ä»˜ï¼š89ï¼‰
     â†“
æ”¯ä»˜æˆåŠŸï¼ˆå¼€é€šä¸“ä¸šç‰ˆï¼‰
     â†“
ç”¨æˆ·è·å¾—ä¸“ä¸šç‰ˆé…é¢ âœ…
```

### Q2: ä¿®æ”¹é…é¢åï¼Œæ–°ç”¨æˆ·ä¼šè‡ªåŠ¨è·å¾—æ–°é…é¢å—ï¼Ÿ

**ç­”ï¼šæ˜¯çš„ï¼âœ…**

**åŸå› ï¼š**
1. é…é¢å­˜å‚¨åœ¨ plan_features è¡¨
2. å¼€é€šè®¢é˜…æ—¶ä»æ•°æ®åº“è¯»å–æœ€æ–°é…é¢
3. é…é¢æ£€æŸ¥æ—¶ä½¿ç”¨æœ€æ–°é…ç½®

**ç¤ºä¾‹ï¼š**
```
ç®¡ç†å‘˜ä¿®æ”¹é…é¢ï¼š
  æ¯æœˆæ–‡ç« æ•° 100 â†’ 150
     â†“
ä¿å­˜åˆ°æ•°æ®åº“
     â†“
æ–°ç”¨æˆ·è´­ä¹°ä¸“ä¸šç‰ˆ
     â†“
ç³»ç»Ÿè¯»å–æœ€æ–°é…é¢ï¼ˆ150ï¼‰
     â†“
ç”¨æˆ·å¯ä»¥ç”Ÿæˆ150ç¯‡æ–‡ç«  âœ…
```

### Q3: å·²æœ‰ç”¨æˆ·ä¼šå—å½±å“å—ï¼Ÿ

**ç­”ï¼šä¸ä¼šï¼âŒ**

**åŸå› ï¼š**
1. å·²æœ‰ç”¨æˆ·çš„è®¢é˜…è®°å½•å·²ç»åˆ›å»º
2. é…é¢æ˜¯åœ¨è®¢é˜…åˆ›å»ºæ—¶ç¡®å®šçš„
3. é™¤éç”¨æˆ·å‡çº§æˆ–ç»­è´¹ï¼Œå¦åˆ™ä¸å—å½±å“

**å¦‚æœæƒ³è®©å·²æœ‰ç”¨æˆ·ä¹Ÿäº«å—æ–°é…é¢ï¼š**
```typescript
// å¯ä»¥æ·»åŠ ä¸€ä¸ª"é…é¢è°ƒæ•´"åŠŸèƒ½
async adjustExistingSubscriptions(planId: number) {
  // è·å–æ‰€æœ‰è¯¥å¥—é¤çš„æ´»è·ƒè®¢é˜…
  const subscriptions = await pool.query(
    `SELECT * FROM user_subscriptions 
     WHERE plan_id = $1 AND status = 'active'`,
    [planId]
  );
  
  // é€šçŸ¥ç”¨æˆ·é…é¢å·²è°ƒæ•´
  for (const sub of subscriptions.rows) {
    await notifyUser(sub.user_id, 'æ‚¨çš„å¥—é¤é…é¢å·²å‡çº§ï¼');
  }
}
```

### Q4: å¦‚ä½•ç¡®ä¿ä»·æ ¼ä¿®æ”¹çš„å®‰å…¨æ€§ï¼Ÿ

**ç­”ï¼šå¤šé‡ä¿æŠ¤æœºåˆ¶ ğŸ›¡ï¸**

1. **æƒé™æ§åˆ¶**
   - åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹
   - éœ€è¦é€šè¿‡èº«ä»½éªŒè¯

2. **æ“ä½œå®¡è®¡**
   - è®°å½•æ‰€æœ‰ä¿®æ”¹å†å²
   - è®°å½•ä¿®æ”¹äººã€æ—¶é—´ã€IP

3. **é…ç½®å†å²**
   - ä¿å­˜æœ€è¿‘50æ¬¡ä¿®æ”¹
   - æ”¯æŒå›æ»šåˆ°å†å²ç‰ˆæœ¬

4. **é€šçŸ¥æœºåˆ¶**
   - ä¿®æ”¹åé€šçŸ¥æ‰€æœ‰ç®¡ç†å‘˜
   - é‡è¦ä¿®æ”¹éœ€è¦äºŒæ¬¡ç¡®è®¤

### Q5: ç¼“å­˜å¦‚ä½•å¤„ç†ï¼Ÿ

**ç­”ï¼šæ™ºèƒ½ç¼“å­˜ç­–ç•¥ âš¡**

```typescript
// è¯»å–å¥—é¤é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰
async getPlanConfig(planCode: string) {
  // 1. å…ˆä» Redis ç¼“å­˜è¯»å–
  const cached = await redis.get(`plan:${planCode}`);
  if (cached) {
    return JSON.parse(cached);
  }
  
  // 2. ä»æ•°æ®åº“è¯»å–
  const plan = await pool.query('SELECT ...');
  
  // 3. ç¼“å­˜5åˆ†é’Ÿ
  await redis.setex(`plan:${planCode}`, 300, JSON.stringify(plan));
  
  return plan;
}

// ä¿®æ”¹é…ç½®æ—¶æ¸…é™¤ç¼“å­˜
async updatePlan(planId: number, data: any) {
  // æ›´æ–°æ•°æ®åº“
  await pool.query('UPDATE ...');
  
  // æ¸…é™¤ç¼“å­˜ âœ…
  await redis.del(`plan:${planCode}`);
  
  // ä¸‹æ¬¡è¯»å–æ—¶ä¼šä»æ•°æ®åº“è·å–æœ€æ–°é…ç½®
}
```

---

## ğŸ“Š ç®¡ç†åå°åŠŸèƒ½

### å•†å“ç®¡ç†é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†å“ç®¡ç†                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”â”‚
â”‚  â”‚ ä½“éªŒç‰ˆ   â”‚  â”‚ ä¸“ä¸šç‰ˆ   â”‚  â”‚ä¼ä¸šâ”‚â”‚
â”‚  â”‚ Â¥0/æœˆ    â”‚  â”‚ Â¥89/æœˆ   â”‚  â”‚Â¥299â”‚â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚    â”‚â”‚
â”‚  â”‚ æ–‡ç« :10  â”‚  â”‚ æ–‡ç« :150 â”‚  â”‚ä¸é™â”‚â”‚
â”‚  â”‚ å‘å¸ƒ:20  â”‚  â”‚ å‘å¸ƒ:200 â”‚  â”‚ä¸é™â”‚â”‚
â”‚  â”‚ è´¦å·:1   â”‚  â”‚ è´¦å·:3   â”‚  â”‚10ä¸ªâ”‚â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚    â”‚â”‚
â”‚  â”‚ [ç¼–è¾‘]   â”‚  â”‚ [ç¼–è¾‘]   â”‚  â”‚[ç¼–]â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  é…ç½®å†å²ï¼š                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 2025-12-25 19:30 adminä¿®æ”¹ä¸“ä¸šç‰ˆâ”‚â”‚
â”‚  â”‚ ä»·æ ¼ï¼š99 â†’ 89                   â”‚â”‚
â”‚  â”‚ [å›æ»š]                          â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 2025-12-25 18:00 adminä¿®æ”¹ä¸“ä¸šç‰ˆâ”‚â”‚
â”‚  â”‚ æ–‡ç« é…é¢ï¼š100 â†’ 150             â”‚â”‚
â”‚  â”‚ [å›æ»š]                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è¾‘å¥—é¤å¯¹è¯æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼–è¾‘å¥—é¤ - ä¸“ä¸šç‰ˆ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å¥—é¤åç§°ï¼š[ä¸“ä¸šç‰ˆ            ]     â”‚
â”‚  ä»·æ ¼ï¼š    [89.00            ] å…ƒ   â”‚
â”‚                                     â”‚
â”‚  åŠŸèƒ½é…é¢ï¼š                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æ¯æœˆç”Ÿæˆæ–‡ç« æ•°ï¼š[150    ] ç¯‡    â”‚â”‚
â”‚  â”‚ æ¯æœˆå‘å¸ƒæ–‡ç« æ•°ï¼š[200    ] ç¯‡    â”‚â”‚
â”‚  â”‚ å¹³å°è´¦å·æ•°ï¼š    [3      ] ä¸ª    â”‚â”‚
â”‚  â”‚ å…³é”®è¯è’¸é¦æ•°ï¼š  [500    ] ä¸ª    â”‚â”‚
â”‚  â”‚ çŸ¥è¯†åº“å®¹é‡ï¼š    [1024   ] MB    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  çŠ¶æ€ï¼š[âœ“] å¯ç”¨                     â”‚
â”‚                                     â”‚
â”‚  [å–æ¶ˆ]              [ä¿å­˜]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. é…é¢æ£€æŸ¥ä¸­é—´ä»¶

```typescript
// server/src/middleware/checkQuota.ts
export function checkQuota(featureCode: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const userId = req.user.userId;
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œæ“ä½œ
    const canPerform = await subscriptionService.canUserPerformAction(
      userId,
      featureCode
    );
    
    if (!canPerform) {
      return res.status(403).json({
        success: false,
        message: 'é…é¢å·²ç”¨å®Œï¼Œè¯·å‡çº§å¥—é¤',
        code: 'QUOTA_EXCEEDED'
      });
    }
    
    next();
  };
}

// ä½¿ç”¨ç¤ºä¾‹
router.post('/api/articles/generate', 
  authenticate, 
  checkQuota('articles_per_month'),  // æ£€æŸ¥é…é¢
  async (req, res) => {
    // ç”Ÿæˆæ–‡ç« 
    const article = await articleService.generate(req.body);
    
    // è®°å½•ä½¿ç”¨é‡
    await subscriptionService.recordUsage(
      req.user.userId, 
      'articles_per_month', 
      1
    );
    
    res.json({ success: true, data: article });
  }
);
```

### 2. æ”¯ä»˜å›è°ƒå¤„ç†

```typescript
// server/src/routes/payment.ts
router.post('/wechat/notify', async (req, res) => {
  try {
    // å¤„ç†æ”¯ä»˜å›è°ƒ
    await paymentService.handleWeChatPayNotify(req.body);
    
    // è¿”å›æˆåŠŸå“åº”ï¼ˆå¾®ä¿¡è¦æ±‚çš„æ ¼å¼ï¼‰
    res.json({
      code: 'SUCCESS',
      message: 'æˆåŠŸ'
    });
  } catch (error) {
    res.status(500).json({
      code: 'FAIL',
      message: error.message
    });
  }
});

// PaymentService.handleWeChatPayNotify()
async handleWeChatPayNotify(notifyData: any): Promise<void> {
  // 1. éªŒè¯ç­¾å
  const isValid = this.wechatpay.verifySign(notifyData);
  if (!isValid) {
    throw new Error('ç­¾åéªŒè¯å¤±è´¥');
  }
  
  // 2. è§£å¯†æ•°æ®
  const decryptedData = this.wechatpay.decipher(
    notifyData.resource.ciphertext,
    notifyData.resource.associated_data,
    notifyData.resource.nonce
  );
  
  // 3. æ›´æ–°è®¢å•çŠ¶æ€
  await orderService.updateOrderStatus(
    decryptedData.out_trade_no,
    'paid',
    decryptedData.transaction_id
  );
  
  // 4. æ¿€æ´»è®¢é˜…
  const order = await orderService.getOrderByNo(decryptedData.out_trade_no);
  await subscriptionService.activateSubscription(
    order.user_id,
    order.plan_id,
    order.order_type
  );
  
  // 5. é€šè¿‡ WebSocket æ¨é€é€šçŸ¥
  await webSocketService.sendToUser(order.user_id, {
    type: 'payment_success',
    data: { orderNo: order.order_no }
  });
}
```

### 3. é…é¢ä½¿ç”¨ç»Ÿè®¡

```typescript
// è·å–ç”¨æˆ·é…é¢ä½¿ç”¨æƒ…å†µ
GET /api/user/quota-status

// è¿”å›
{
  "success": true,
  "data": {
    "plan": {
      "code": "professional",
      "name": "ä¸“ä¸šç‰ˆ",
      "price": 89
    },
    "features": [
      {
        "code": "articles_per_month",
        "name": "æ¯æœˆç”Ÿæˆæ–‡ç« æ•°",
        "limit": 150,
        "used": 45,
        "remaining": 105,
        "percentage": 30
      },
      {
        "code": "publish_per_month",
        "name": "æ¯æœˆå‘å¸ƒæ–‡ç« æ•°",
        "limit": 200,
        "used": 80,
        "remaining": 120,
        "percentage": 40
      }
    ]
  }
}
```

---

## ğŸ“ æ€»ç»“

### ç³»ç»Ÿè®¾è®¡ç‰¹ç‚¹

âœ… **çµæ´»å¯é…ç½®** - ç®¡ç†å‘˜å¯ä»¥éšæ—¶ä¿®æ”¹ä»·æ ¼å’Œé…é¢
âœ… **è‡ªåŠ¨ç”Ÿæ•ˆ** - ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
âœ… **å®‰å…¨å¯é ** - å®Œæ•´çš„å®¡è®¡æ—¥å¿—å’Œå›æ»šæœºåˆ¶
âœ… **æ€§èƒ½ä¼˜ç§€** - Redis ç¼“å­˜ï¼Œå“åº”å¿«é€Ÿ
âœ… **ç”¨æˆ·å‹å¥½** - æ¸…æ™°çš„é…é¢æç¤ºå’Œå‡çº§å¼•å¯¼

### æ ¸å¿ƒæµç¨‹

1. **ç®¡ç†å‘˜ä¿®æ”¹é…ç½®** â†’ ä¿å­˜åˆ°æ•°æ®åº“ â†’ æ¸…é™¤ç¼“å­˜
2. **ç”¨æˆ·è´­ä¹°å¥—é¤** â†’ è¯»å–æœ€æ–°é…ç½® â†’ ç”ŸæˆäºŒç»´ç  â†’ æ”¯ä»˜ â†’ å¼€é€šè®¢é˜…
3. **ç”¨æˆ·ä½¿ç”¨åŠŸèƒ½** â†’ æ£€æŸ¥é…é¢ â†’ è®°å½•ä½¿ç”¨é‡ â†’ è¿”å›ç»“æœ
4. **å¥—é¤å‡çº§** â†’ è®¡ç®—å·®ä»· â†’ æ”¯ä»˜ â†’ ç«‹å³ç”Ÿæ•ˆ

### å…³é”®ä¼˜åŠ¿

- ğŸ¯ **è¿è¥çµæ´»** - å¯ä»¥å¿«é€Ÿå“åº”å¸‚åœºå˜åŒ–
- ğŸ”’ **å®‰å…¨å¯æ§** - å®Œæ•´çš„æƒé™å’Œå®¡è®¡æœºåˆ¶
- âš¡ **æ€§èƒ½ä¼˜ç§€** - ç¼“å­˜ç­–ç•¥ä¿è¯å“åº”é€Ÿåº¦
- ğŸ˜Š **ç”¨æˆ·ä½“éªŒ** - è‡ªåŠ¨åŒ–å¤„ç†ï¼Œæ— éœ€äººå·¥å¹²é¢„

---

**ä½ çš„ç³»ç»Ÿè®¾è®¡éå¸¸å®Œå–„ï¼ç®¡ç†å‘˜ä¿®æ”¹å•†å“é…ç½®åï¼Œå‰ç«¯æ‰«ç æ”¯ä»˜ä¼šè‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„å¥—é¤é…ç½®å’Œä»·æ ¼ã€‚** ğŸ‰
