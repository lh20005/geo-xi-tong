# å•†å“ç®¡ç†ç³»ç»Ÿå®æ–½æŒ‡å—

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
cd server
npm run build
node dist/db/run-migration-014.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ”„ å¼€å§‹æ‰§è¡Œè¿ç§» 014: å®Œå–„ä½¿ç”¨é‡è¿½è¸ªå’Œé…é¢é¢„è­¦ç³»ç»Ÿ...

âœ… è¿ç§» 014 æˆåŠŸå®Œæˆï¼

ğŸ” éªŒè¯è¿ç§»ç»“æœ...

âœ“ usage_records è¡¨å·²åˆ›å»º
  å­—æ®µåˆ—è¡¨:
    - id (integer)
    - user_id (integer)
    - feature_code (character varying)
    - resource_type (character varying)
    - resource_id (integer)
    - amount (integer)
    - metadata (jsonb)
    - created_at (timestamp without time zone)

âœ“ quota_alerts è¡¨å·²åˆ›å»º
  ...

âœ“ æ•°æ®åº“å‡½æ•°å·²åˆ›å»º:
    - check_user_quota (FUNCTION)
    - record_feature_usage (FUNCTION)
    - trigger_quota_alert (FUNCTION)

âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼è¿ç§»æˆåŠŸå®Œæˆã€‚
```

### ç¬¬äºŒæ­¥ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰æœåŠ¡
# Ctrl+C

# é‡æ–°å¯åŠ¨
npm run server:dev
```

**éªŒè¯æœåŠ¡å¯åŠ¨ï¼š**
```bash
curl http://localhost:3000/api/health
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•APIæ¥å£

#### 1. æµ‹è¯•é…é¢æ£€æŸ¥

```bash
# è·å–ç”¨æˆ·é…é¢æ¦‚è§ˆ
curl -X GET http://localhost:3000/api/usage/quota-overview \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "featureCode": "articles_per_day",
      "featureName": "æ¯æ—¥ç”Ÿæˆæ–‡ç« æ•°",
      "quotaLimit": 50,
      "currentUsage": 35,
      "remaining": 15,
      "usagePercentage": 70,
      "periodStart": "2026-01-04T00:00:00.000Z",
      "periodEnd": "2026-01-05T00:00:00.000Z",
      "planName": "ä¸“ä¸šç‰ˆ",
      "planCode": "professional"
    }
  ]
}
```

#### 2. æµ‹è¯•å•†å“ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰

```bash
# è·å–æ‰€æœ‰å¥—é¤
curl -X GET http://localhost:3000/api/admin/products/plans \
  -H "Authorization: Bearer ADMIN_TOKEN"

# æ›´æ–°å¥—é¤ä»·æ ¼
curl -X PUT http://localhost:3000/api/admin/products/plans/2 \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "price": 129.00,
    "planName": "ä¸“ä¸šç‰ˆPlus"
  }'
```

### ç¬¬å››æ­¥ï¼šé›†æˆåˆ°ç°æœ‰åŠŸèƒ½

#### 1. æ–‡ç« ç”Ÿæˆé›†æˆ

æ‰¾åˆ°æ–‡ç« ç”Ÿæˆçš„è·¯ç”±æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ `server/src/routes/article.ts` æˆ– `articleGeneration.ts`ï¼‰ï¼Œæ·»åŠ é…é¢æ£€æŸ¥ï¼š

```typescript
import { usageTrackingService } from '../services/UsageTrackingService';

// åœ¨æ–‡ç« ç”Ÿæˆå‰æ£€æŸ¥é…é¢
router.post('/generate', authenticate, async (req, res) => {
  try {
    const userId = (req as any).user.userId;
    
    // æ£€æŸ¥é…é¢
    const quota = await usageTrackingService.checkQuota(userId, 'articles_per_day');
    
    if (!quota.hasQuota) {
      return res.status(403).json({
        success: false,
        message: 'ä»Šæ—¥æ–‡ç« ç”Ÿæˆé…é¢å·²ç”¨å®Œ',
        data: {
          currentUsage: quota.currentUsage,
          quotaLimit: quota.quotaLimit,
          resetTime: 'æ˜å¤© 00:00'
        }
      });
    }
    
    // æ‰§è¡Œæ–‡ç« ç”Ÿæˆé€»è¾‘
    const article = await generateArticle(req.body);
    
    // è®°å½•ä½¿ç”¨é‡
    await usageTrackingService.recordUsage(
      userId,
      'articles_per_day',
      'article',
      article.id,
      1,
      { title: article.title }
    );
    
    res.json({
      success: true,
      data: article,
      quota: {
        remaining: quota.remaining - 1,
        total: quota.quotaLimit
      }
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

#### 2. æ–‡ç« å‘å¸ƒé›†æˆ

æ‰¾åˆ°å‘å¸ƒç›¸å…³çš„è·¯ç”±æ–‡ä»¶ï¼Œæ·»åŠ é…é¢æ£€æŸ¥ï¼š

```typescript
import { usageTrackingService } from '../services/UsageTrackingService';

router.post('/publish', authenticate, async (req, res) => {
  try {
    const userId = (req as any).user.userId;
    const { articleIds, platformIds } = req.body;
    
    // è®¡ç®—éœ€è¦çš„é…é¢ï¼ˆæ–‡ç« æ•° Ã— å¹³å°æ•°ï¼‰
    const requiredQuota = articleIds.length * platformIds.length;
    
    // æ£€æŸ¥é…é¢
    const quota = await usageTrackingService.checkQuota(userId, 'publish_per_day');
    
    if (!quota.hasQuota || quota.remaining < requiredQuota) {
      return res.status(403).json({
        success: false,
        message: `å‘å¸ƒé…é¢ä¸è¶³ï¼Œéœ€è¦ ${requiredQuota} æ¬¡ï¼Œå‰©ä½™ ${quota.remaining} æ¬¡`,
        data: {
          required: requiredQuota,
          remaining: quota.remaining
        }
      });
    }
    
    // æ‰§è¡Œå‘å¸ƒé€»è¾‘
    const results = await publishArticles(articleIds, platformIds);
    
    // è®°å½•ä½¿ç”¨é‡
    await usageTrackingService.recordUsage(
      userId,
      'publish_per_day',
      'publish',
      null,
      requiredQuota,
      { articleCount: articleIds.length, platformCount: platformIds.length }
    );
    
    res.json({
      success: true,
      data: results,
      quota: {
        remaining: quota.remaining - requiredQuota,
        total: quota.quotaLimit
      }
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

#### 3. å…³é”®è¯è’¸é¦é›†æˆ

```typescript
import { usageTrackingService } from '../services/UsageTrackingService';

router.post('/distill', authenticate, async (req, res) => {
  try {
    const userId = (req as any).user.userId;
    
    // æ£€æŸ¥é…é¢
    const quota = await usageTrackingService.checkQuota(userId, 'keyword_distillation');
    
    if (!quota.hasQuota) {
      return res.status(403).json({
        success: false,
        message: 'æœ¬æœˆå…³é”®è¯è’¸é¦é…é¢å·²ç”¨å®Œ',
        data: {
          currentUsage: quota.currentUsage,
          quotaLimit: quota.quotaLimit,
          resetTime: 'ä¸‹æœˆ 1 æ—¥'
        }
      });
    }
    
    // æ‰§è¡Œè’¸é¦é€»è¾‘
    const result = await distillKeyword(req.body);
    
    // è®°å½•ä½¿ç”¨é‡
    await usageTrackingService.recordUsage(
      userId,
      'keyword_distillation',
      'distillation',
      result.id,
      1,
      { keyword: req.body.keyword }
    );
    
    res.json({
      success: true,
      data: result,
      quota: {
        remaining: quota.remaining - 1,
        total: quota.quotaLimit
      }
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

### ç¬¬äº”æ­¥ï¼šå‰ç«¯ç•Œé¢å¼€å‘

#### 1. åˆ›å»ºå•†å“ç®¡ç†é¡µé¢ï¼ˆç®¡ç†åå°ï¼‰

æ–‡ä»¶ä½ç½®ï¼š`client/src/pages/ProductManagementPage.tsx`

**åŠŸèƒ½è¦æ±‚ï¼š**
- å¥—é¤åˆ—è¡¨å±•ç¤ºï¼ˆå¡ç‰‡æˆ–è¡¨æ ¼ï¼‰
- ç¼–è¾‘å¥—é¤ä¿¡æ¯ï¼ˆåç§°ã€ä»·æ ¼ã€è®¡è´¹å‘¨æœŸï¼‰
- é…ç½®åŠŸèƒ½é…é¢ï¼ˆæ¯ä¸ªåŠŸèƒ½çš„é™åˆ¶å€¼ï¼‰
- æŸ¥çœ‹å˜æ›´å†å²
- å¯ç”¨/åœç”¨å¥—é¤

**å…³é”®ç»„ä»¶ï¼š**
```typescript
import { useState, useEffect } from 'react';
import { Table, Button, Modal, Form, Input, InputNumber, Switch, message } from 'antd';
import axios from 'axios';

export default function ProductManagementPage() {
  const [plans, setPlans] = useState([]);
  const [loading, setLoading] = useState(false);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [currentPlan, setCurrentPlan] = useState(null);
  
  // åŠ è½½å¥—é¤åˆ—è¡¨
  const loadPlans = async () => {
    setLoading(true);
    try {
      const response = await axios.get('/api/admin/products/plans?include_inactive=true');
      setPlans(response.data.data);
    } catch (error) {
      message.error('åŠ è½½å¥—é¤å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };
  
  // æ›´æ–°å¥—é¤
  const handleUpdate = async (values) => {
    try {
      await axios.put(`/api/admin/products/plans/${currentPlan.id}`, values);
      message.success('æ›´æ–°æˆåŠŸ');
      setEditModalVisible(false);
      loadPlans();
    } catch (error) {
      message.error('æ›´æ–°å¤±è´¥');
    }
  };
  
  useEffect(() => {
    loadPlans();
  }, []);
  
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">å•†å“ç®¡ç†</h1>
      {/* å¥—é¤åˆ—è¡¨ */}
      {/* ç¼–è¾‘æ¨¡æ€æ¡† */}
    </div>
  );
}
```

#### 2. ä¼˜åŒ–ç”¨æˆ·ä¸­å¿ƒé…é¢å±•ç¤º

æ–‡ä»¶ä½ç½®ï¼š`client/src/pages/UserCenterPage.tsx`

**åŠŸèƒ½è¦æ±‚ï¼š**
- å®æ—¶æ˜¾ç¤ºé…é¢ä½¿ç”¨æƒ…å†µ
- è¿›åº¦æ¡å¯è§†åŒ–
- é…é¢é¢„è­¦æç¤º
- ä½¿ç”¨æ˜ç»†æŸ¥è¯¢
- ç»­è´¹å¼•å¯¼

**å…³é”®ä»£ç ï¼š**
```typescript
import { useEffect, useState } from 'react';
import { Progress, Alert, Button } from 'antd';
import axios from 'axios';

export default function UserCenterPage() {
  const [quotaOverview, setQuotaOverview] = useState([]);
  const [alerts, setAlerts] = useState([]);
  
  // åŠ è½½é…é¢æ¦‚è§ˆ
  const loadQuotaOverview = async () => {
    try {
      const response = await axios.get('/api/usage/quota-overview');
      setQuotaOverview(response.data.data);
    } catch (error) {
      console.error('åŠ è½½é…é¢å¤±è´¥', error);
    }
  };
  
  // åŠ è½½é¢„è­¦
  const loadAlerts = async () => {
    try {
      const response = await axios.get('/api/usage/alerts/unsent');
      setAlerts(response.data.data);
    } catch (error) {
      console.error('åŠ è½½é¢„è­¦å¤±è´¥', error);
    }
  };
  
  useEffect(() => {
    loadQuotaOverview();
    loadAlerts();
    
    // WebSocket ç›‘å¬é…é¢æ›´æ–°
    const ws = new WebSocket('ws://localhost:3000/ws');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'quota_updated') {
        loadQuotaOverview();
      }
      if (data.type === 'quota_alert') {
        loadAlerts();
      }
    };
    
    return () => ws.close();
  }, []);
  
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">æˆ‘çš„å¥—é¤</h1>
      
      {/* é¢„è­¦æç¤º */}
      {alerts.map(alert => (
        <Alert
          key={alert.id}
          type={alert.alert_type === 'depleted' ? 'error' : 'warning'}
          message={alert.message}
          closable
          className="mb-4"
        />
      ))}
      
      {/* é…é¢åˆ—è¡¨ */}
      {quotaOverview.map(quota => (
        <div key={quota.featureCode} className="mb-6 p-4 border rounded">
          <div className="flex justify-between mb-2">
            <span className="font-semibold">{quota.featureName}</span>
            <span>{quota.currentUsage} / {quota.quotaLimit === -1 ? 'æ— é™åˆ¶' : quota.quotaLimit}</span>
          </div>
          <Progress
            percent={quota.usagePercentage}
            status={quota.usagePercentage >= 95 ? 'exception' : 'normal'}
          />
          <div className="text-sm text-gray-500 mt-2">
            å‰©ä½™ï¼š{quota.remaining === -1 ? 'æ— é™åˆ¶' : `${quota.remaining} ${quota.unit}`}
          </div>
        </div>
      ))}
      
      <Button type="primary" size="large" block>
        å‡çº§å¥—é¤
      </Button>
    </div>
  );
}
```

#### 3. è½åœ°é¡µå¥—é¤å±•ç¤ºä¼˜åŒ–

æ–‡ä»¶ä½ç½®ï¼š`landing/src/pages/HomePage.tsx`

**åŠŸèƒ½è¦æ±‚ï¼š**
- ä»APIå®æ—¶è·å–å¥—é¤ä¿¡æ¯
- æ˜¾ç¤ºæœ€æ–°ä»·æ ¼å’Œé…é¢
- æ”¯ä»˜æµç¨‹é›†æˆ

**å…³é”®ä»£ç ï¼š**
```typescript
import { useEffect, useState } from 'react';
import axios from 'axios';
import PaymentModal from '../components/PaymentModal';

export default function HomePage() {
  const [plans, setPlans] = useState([]);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [paymentModalVisible, setPaymentModalVisible] = useState(false);
  
  // åŠ è½½å¥—é¤åˆ—è¡¨
  const loadPlans = async () => {
    try {
      const response = await axios.get('http://localhost:3000/api/subscription/plans');
      setPlans(response.data.data);
    } catch (error) {
      console.error('åŠ è½½å¥—é¤å¤±è´¥', error);
    }
  };
  
  useEffect(() => {
    loadPlans();
  }, []);
  
  return (
    <div>
      {/* å¥—é¤å¡ç‰‡ */}
      <div className="grid grid-cols-3 gap-6">
        {plans.map(plan => (
          <div key={plan.id} className="border rounded-lg p-6">
            <h3 className="text-xl font-bold">{plan.plan_name}</h3>
            <div className="text-3xl font-bold my-4">
              Â¥{plan.price}
              <span className="text-sm text-gray-500">/{plan.billing_cycle === 'monthly' ? 'æœˆ' : 'å¹´'}</span>
            </div>
            
            {/* åŠŸèƒ½åˆ—è¡¨ */}
            <ul className="space-y-2 mb-6">
              {plan.features?.map(feature => (
                <li key={feature.feature_code}>
                  {feature.feature_name}: {feature.feature_value === -1 ? 'æ— é™åˆ¶' : `${feature.feature_value} ${feature.feature_unit}`}
                </li>
              ))}
            </ul>
            
            <button
              onClick={() => {
                setSelectedPlan(plan);
                setPaymentModalVisible(true);
              }}
              className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              ç«‹å³è´­ä¹°
            </button>
          </div>
        ))}
      </div>
      
      {/* æ”¯ä»˜æ¨¡æ€æ¡† */}
      {selectedPlan && (
        <PaymentModal
          isOpen={paymentModalVisible}
          onClose={() => setPaymentModalVisible(false)}
          planId={selectedPlan.id}
          planName={selectedPlan.plan_name}
          price={selectedPlan.price}
        />
      )}
    </div>
  );
}
```

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•å®Œæ•´æµç¨‹

#### æµ‹è¯•åœºæ™¯ 1ï¼šç”¨æˆ·è´­ä¹°å¥—é¤

1. è®¿é—®è½åœ°é¡µ `http://localhost:8080`
2. é€‰æ‹©å¥—é¤å¹¶ç‚¹å‡»"ç«‹å³è´­ä¹°"
3. æ‰«ç æ”¯ä»˜ï¼ˆæµ‹è¯•ç¯å¢ƒä½¿ç”¨ 0.01 å…ƒï¼‰
4. æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
5. éªŒè¯é…é¢å·²æ­£ç¡®ä¸‹å‘

#### æµ‹è¯•åœºæ™¯ 2ï¼šä½¿ç”¨åŠŸèƒ½å¹¶è¿½è¸ªé…é¢

1. ç™»å½•ç³»ç»Ÿ
2. ç”Ÿæˆä¸€ç¯‡æ–‡ç« 
3. æŸ¥çœ‹ç”¨æˆ·ä¸­å¿ƒï¼Œé…é¢åº”å‡å°‘ 1
4. ç»§ç»­ç”Ÿæˆç›´åˆ°é…é¢ç”¨å®Œ
5. éªŒè¯æ˜¯å¦æ˜¾ç¤ºé…é¢ä¸è¶³æç¤º

#### æµ‹è¯•åœºæ™¯ 3ï¼šé…é¢é¢„è­¦

1. ä½¿ç”¨é…é¢åˆ° 80%
2. éªŒè¯æ˜¯å¦æ”¶åˆ°é¢„è­¦é€šçŸ¥
3. ä½¿ç”¨åˆ° 95%ï¼ŒéªŒè¯ä¸¥é‡é¢„è­¦
4. ä½¿ç”¨åˆ° 100%ï¼ŒéªŒè¯è€—å°½æç¤º

#### æµ‹è¯•åœºæ™¯ 4ï¼šç®¡ç†å‘˜ä¿®æ”¹å¥—é¤

1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
2. è®¿é—®å•†å“ç®¡ç†é¡µé¢
3. ä¿®æ”¹å¥—é¤ä»·æ ¼æˆ–é…é¢
4. éªŒè¯è½åœ°é¡µæ˜¯å¦å®æ—¶æ›´æ–°
5. éªŒè¯ç°æœ‰ç”¨æˆ·é…é¢æ˜¯å¦å—å½±å“

### ç¬¬ä¸ƒæ­¥ï¼šç›‘æ§å’Œä¼˜åŒ–

#### 1. æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„é…é¢ä½¿ç”¨æƒ…å†µ
SELECT * FROM v_user_quota_overview;

-- æŸ¥çœ‹ä»Šæ—¥ä½¿ç”¨é‡æœ€é«˜çš„ç”¨æˆ·
SELECT 
  user_id,
  feature_code,
  SUM(amount) as total_usage
FROM usage_records
WHERE created_at >= CURRENT_DATE
GROUP BY user_id, feature_code
ORDER BY total_usage DESC
LIMIT 10;

-- æŸ¥çœ‹é…é¢é¢„è­¦ç»Ÿè®¡
SELECT 
  alert_type,
  COUNT(*) as count
FROM quota_alerts
WHERE created_at >= CURRENT_DATE
GROUP BY alert_type;
```

#### 2. æ€§èƒ½ä¼˜åŒ–

- ç¡®ä¿ Redis ç¼“å­˜æ­£å¸¸å·¥ä½œ
- ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- ä¼˜åŒ– WebSocket è¿æ¥æ•°

#### 3. å®šæœŸç»´æŠ¤

```bash
# æ¸…ç†è¿‡æœŸé¢„è­¦ï¼ˆå¯ä»¥æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼‰
node -e "
const { quotaAlertService } = require('./dist/services/QuotaAlertService');
quotaAlertService.cleanupOldAlerts().then(count => {
  console.log(\`æ¸…ç†äº† \${count} æ¡è¿‡æœŸé¢„è­¦\`);
  process.exit(0);
});
"
```

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹å¥—é¤ä¿¡æ¯
- [ ] ä¿®æ”¹åçš„ä¿¡æ¯å®æ—¶åŒæ­¥åˆ°è½åœ°é¡µ
- [ ] ç”¨æˆ·è´­ä¹°åé…é¢æ­£ç¡®ä¸‹å‘
- [ ] ä½¿ç”¨åŠŸèƒ½æ—¶é…é¢æ­£ç¡®æ‰£å‡
- [ ] é…é¢ç”¨å®Œæ—¶æ˜¾ç¤ºæç¤º
- [ ] ç”¨æˆ·ä¸­å¿ƒå®æ—¶æ˜¾ç¤ºé…é¢
- [ ] é…é¢é¢„è­¦æ­£å¸¸å·¥ä½œ
- [ ] é…ç½®å˜æ›´æœ‰å®Œæ•´å†å²è®°å½•

### æ€§èƒ½éªŒæ”¶

- [ ] API å“åº”æ—¶é—´ < 200ms
- [ ] WebSocket æ¨é€å»¶è¿Ÿ < 100ms
- [ ] é…é¢æ£€æŸ¥ä¸å½±å“ä¸»æµç¨‹æ€§èƒ½
- [ ] æ”¯æŒ 1000+ å¹¶å‘ç”¨æˆ·

### å®‰å…¨éªŒæ”¶

- [ ] åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹å•†å“é…ç½®
- [ ] é…é¢æ£€æŸ¥æ— æ³•è¢«ç»•è¿‡
- [ ] ä½¿ç”¨é‡è®°å½•é˜²æ­¢é‡å¤è®¡è´¹
- [ ] æ‰€æœ‰æ“ä½œæœ‰å®¡è®¡æ—¥å¿—

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šè¿ç§»æ‰§è¡Œå¤±è´¥

**ç—‡çŠ¶ï¼š** è¿è¡Œè¿ç§»è„šæœ¬æ—¶æŠ¥é”™

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
psql $DATABASE_URL -c "SELECT version();"

# æŸ¥çœ‹ç°æœ‰è¡¨
psql $DATABASE_URL -c "\dt"

# æ‰‹åŠ¨æ‰§è¡Œè¿ç§»SQL
psql $DATABASE_URL < server/src/db/migrations/014_add_usage_tracking_and_alerts.sql
```

### é—®é¢˜ 2ï¼šé…é¢ä¸æ›´æ–°

**ç—‡çŠ¶ï¼š** ä½¿ç”¨åŠŸèƒ½åé…é¢æ²¡æœ‰å˜åŒ–

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `recordUsage` å‡½æ•°
2. æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
3. éªŒè¯ WebSocket è¿æ¥çŠ¶æ€

```bash
# æŸ¥çœ‹æœ€è¿‘çš„ä½¿ç”¨è®°å½•
psql $DATABASE_URL -c "SELECT * FROM usage_records ORDER BY created_at DESC LIMIT 10;"
```

### é—®é¢˜ 3ï¼šWebSocket æ¨é€ä¸å·¥ä½œ

**ç—‡çŠ¶ï¼š** å‰ç«¯æ²¡æœ‰æ”¶åˆ°å®æ—¶æ›´æ–°

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ WebSocket æœåŠ¡æ˜¯å¦å¯åŠ¨
2. éªŒè¯å‰ç«¯ WebSocket è¿æ¥
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
const ws = new WebSocket('ws://localhost:3000/ws');
ws.onopen = () => console.log('è¿æ¥æˆåŠŸ');
ws.onerror = (e) => console.error('è¿æ¥å¤±è´¥', e);
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´å•†å“ç®¡ç†ç³»ç»Ÿè®¾è®¡](./å®Œæ•´å•†å“ç®¡ç†ç³»ç»Ÿè®¾è®¡.md)
- [è®¢é˜…ç³»ç»ŸAPIæ–‡æ¡£](../07-å¼€å‘æ–‡æ¡£/è®¢é˜…ç³»ç»ŸAPI.md)
- [é…é¢ç®¡ç†æœ€ä½³å®è·µ](../07-å¼€å‘æ–‡æ¡£/é…é¢ç®¡ç†æœ€ä½³å®è·µ.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-04  
**æœ€åæ›´æ–°**: 2026-01-04
