# æˆªå›¾å­˜å‚¨é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ“Š å½“å‰çŠ¶å†µ

### æˆªå›¾ä¿å­˜ä½ç½®
```
server/
  â”œâ”€â”€ douyin-after-publish.png      (3.1 MB)
  â”œâ”€â”€ douyin-before-publish.png     (791 KB)
  â”œâ”€â”€ douyin-declaration-sidebar.png (921 KB)
  â”œâ”€â”€ douyin-error.png              (886 KB)
  â”œâ”€â”€ douyin-home-page.png          (1.1 MB)
  â”œâ”€â”€ douyin-menu-popup.png         (1.1 MB)  â† ä½ é—®çš„è¿™ä¸ª
  â”œâ”€â”€ toutiao-after-scroll.png      (930 KB)
  â””â”€â”€ toutiao-publish-page.png      (393 KB)

æ€»è®¡ï¼š9.2 MB
```

### âš ï¸ å­˜åœ¨çš„é—®é¢˜

1. **å ç”¨ç©ºé—´** - å½“å‰å·²æœ‰ 9.2 MB
2. **ä¼šè¢«æäº¤åˆ° Git** - `.gitignore` æ²¡æœ‰æ’é™¤ `.png` æ–‡ä»¶
3. **ä¼šç´¯ç§¯å¢é•¿** - æ¯æ¬¡å‘å¸ƒéƒ½ä¼šè¦†ç›–æˆ–æ–°å¢
4. **æ²¡æœ‰è‡ªåŠ¨æ¸…ç†** - æ—§æˆªå›¾ä¼šä¸€ç›´ä¿ç•™

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ·»åŠ åˆ° .gitignoreï¼ˆæ¨èï¼‰

**ç«‹å³æ‰§è¡Œï¼š**
```bash
# 1. æ·»åŠ åˆ° .gitignore
echo "" >> .gitignore
echo "# å‘å¸ƒæˆªå›¾" >> .gitignore
echo "server/*.png" >> .gitignore
echo "screenshots/" >> .gitignore

# 2. ä» Git ä¸­åˆ é™¤å·²æäº¤çš„æˆªå›¾ï¼ˆå¦‚æœæœ‰ï¼‰
git rm --cached server/*.png 2>/dev/null || true

# 3. æäº¤æ›´æ”¹
git add .gitignore
git commit -m "chore: å¿½ç•¥å‘å¸ƒæˆªå›¾æ–‡ä»¶"
```

### æ–¹æ¡ˆ 2ï¼šåˆ›å»ºä¸“é—¨çš„æˆªå›¾ç›®å½•

**ä¿®æ”¹ä»£ç ï¼Œç»Ÿä¸€ä¿å­˜åˆ° screenshots ç›®å½•ï¼š**

```typescript
// server/src/services/adapters/DouyinAdapter.ts

import path from 'path';
import fs from 'fs';

// åœ¨ç±»çš„å¼€å¤´æ·»åŠ 
private screenshotDir = path.join(__dirname, '../../../screenshots');

// åˆå§‹åŒ–æ—¶åˆ›å»ºç›®å½•
constructor() {
  if (!fs.existsSync(this.screenshotDir)) {
    fs.mkdirSync(this.screenshotDir, { recursive: true });
  }
}

// ä¿®æ”¹æˆªå›¾ä¿å­˜è·¯å¾„
await page.screenshot({ 
  path: path.join(this.screenshotDir, 'douyin-menu-popup.png')
});
```

### æ–¹æ¡ˆ 3ï¼šæ·»åŠ æ—¶é—´æˆ³ï¼Œé¿å…è¦†ç›–

```typescript
// æ¯æ¬¡å‘å¸ƒç”Ÿæˆå”¯ä¸€çš„æˆªå›¾æ–‡ä»¶å
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const screenshotPath = path.join(
  this.screenshotDir, 
  `douyin-menu-popup-${timestamp}.png`
);

await page.screenshot({ path: screenshotPath });
```

### æ–¹æ¡ˆ 4ï¼šè‡ªåŠ¨æ¸…ç†æ—§æˆªå›¾

```typescript
// server/src/services/adapters/DouyinAdapter.ts

/**
 * æ¸…ç†è¶…è¿‡ 7 å¤©çš„æˆªå›¾
 */
private async cleanupOldScreenshots(): Promise<void> {
  const screenshotDir = path.join(__dirname, '../../../screenshots');
  
  if (!fs.existsSync(screenshotDir)) return;
  
  const files = fs.readdirSync(screenshotDir);
  const now = Date.now();
  const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 å¤©
  
  for (const file of files) {
    if (!file.endsWith('.png')) continue;
    
    const filePath = path.join(screenshotDir, file);
    const stats = fs.statSync(filePath);
    const age = now - stats.mtimeMs;
    
    if (age > maxAge) {
      fs.unlinkSync(filePath);
      console.log(`[æ¸…ç†] åˆ é™¤æ—§æˆªå›¾: ${file}`);
    }
  }
}

// åœ¨å‘å¸ƒå¼€å§‹æ—¶è°ƒç”¨
async publish(...) {
  await this.cleanupOldScreenshots();
  // ... å‘å¸ƒé€»è¾‘
}
```

## ğŸ¯ æ¨èé…ç½®ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰

### 1. æ›´æ–° .gitignore

```bash
# .gitignore æ–‡ä»¶æœ«å°¾æ·»åŠ 

# å‘å¸ƒæˆªå›¾
server/*.png
screenshots/
*.png
!client/public/**/*.png  # ä¿ç•™å‰ç«¯é™æ€èµ„æºä¸­çš„å›¾ç‰‡
```

### 2. åˆ›å»ºæˆªå›¾ç®¡ç†æœåŠ¡

```typescript
// server/src/services/ScreenshotService.ts

import fs from 'fs';
import path from 'path';

export class ScreenshotService {
  private screenshotDir: string;
  private maxAge: number; // æœ€å¤§ä¿ç•™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  private maxSize: number; // æœ€å¤§æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰

  constructor(
    screenshotDir: string = path.join(__dirname, '../../screenshots'),
    maxAgeDays: number = 7,
    maxSizeMB: number = 100
  ) {
    this.screenshotDir = screenshotDir;
    this.maxAge = maxAgeDays * 24 * 60 * 60 * 1000;
    this.maxSize = maxSizeMB * 1024 * 1024;
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    if (!fs.existsSync(this.screenshotDir)) {
      fs.mkdirSync(this.screenshotDir, { recursive: true });
    }
  }

  /**
   * ç”Ÿæˆæˆªå›¾æ–‡ä»¶è·¯å¾„
   */
  getPath(prefix: string, taskId?: number): string {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = taskId 
      ? `${prefix}-task${taskId}-${timestamp}.png`
      : `${prefix}-${timestamp}.png`;
    
    return path.join(this.screenshotDir, filename);
  }

  /**
   * æ¸…ç†æ—§æˆªå›¾
   */
  async cleanup(): Promise<{ deleted: number; freedSpace: number }> {
    const files = fs.readdirSync(this.screenshotDir);
    const now = Date.now();
    let deleted = 0;
    let freedSpace = 0;

    for (const file of files) {
      if (!file.endsWith('.png')) continue;

      const filePath = path.join(this.screenshotDir, file);
      const stats = fs.statSync(filePath);
      const age = now - stats.mtimeMs;

      if (age > this.maxAge) {
        freedSpace += stats.size;
        fs.unlinkSync(filePath);
        deleted++;
      }
    }

    console.log(`[æˆªå›¾æ¸…ç†] åˆ é™¤ ${deleted} ä¸ªæ–‡ä»¶ï¼Œé‡Šæ”¾ ${(freedSpace / 1024 / 1024).toFixed(2)} MB`);
    return { deleted, freedSpace };
  }

  /**
   * æ£€æŸ¥å¹¶æ¸…ç†è¶…å‡ºå¤§å°é™åˆ¶çš„æˆªå›¾
   */
  async cleanupBySize(): Promise<void> {
    const files = fs.readdirSync(this.screenshotDir)
      .filter(f => f.endsWith('.png'))
      .map(f => {
        const filePath = path.join(this.screenshotDir, f);
        const stats = fs.statSync(filePath);
        return { path: filePath, size: stats.size, mtime: stats.mtimeMs };
      })
      .sort((a, b) => a.mtime - b.mtime); // æŒ‰æ—¶é—´æ’åºï¼Œæ—§çš„åœ¨å‰

    let totalSize = files.reduce((sum, f) => sum + f.size, 0);

    // å¦‚æœè¶…å‡ºé™åˆ¶ï¼Œåˆ é™¤æœ€æ—§çš„æ–‡ä»¶
    while (totalSize > this.maxSize && files.length > 0) {
      const oldest = files.shift()!;
      fs.unlinkSync(oldest.path);
      totalSize -= oldest.size;
      console.log(`[æˆªå›¾æ¸…ç†] åˆ é™¤æ—§æ–‡ä»¶: ${path.basename(oldest.path)}`);
    }
  }

  /**
   * è·å–æˆªå›¾ç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): { count: number; totalSize: number; oldestDate: Date | null } {
    const files = fs.readdirSync(this.screenshotDir)
      .filter(f => f.endsWith('.png'));

    if (files.length === 0) {
      return { count: 0, totalSize: 0, oldestDate: null };
    }

    let totalSize = 0;
    let oldestTime = Date.now();

    for (const file of files) {
      const filePath = path.join(this.screenshotDir, file);
      const stats = fs.statSync(filePath);
      totalSize += stats.size;
      if (stats.mtimeMs < oldestTime) {
        oldestTime = stats.mtimeMs;
      }
    }

    return {
      count: files.length,
      totalSize,
      oldestDate: new Date(oldestTime)
    };
  }
}

// å¯¼å‡ºå•ä¾‹
export const screenshotService = new ScreenshotService();
```

### 3. åœ¨é€‚é…å™¨ä¸­ä½¿ç”¨

```typescript
// server/src/services/adapters/DouyinAdapter.ts

import { screenshotService } from '../ScreenshotService';

export class DouyinAdapter {
  async publish(article: Article, account: Account, taskId: number) {
    try {
      // å‘å¸ƒå‰æ¸…ç†æ—§æˆªå›¾
      await screenshotService.cleanup();
      
      // ä½¿ç”¨æˆªå›¾æœåŠ¡ç”Ÿæˆè·¯å¾„
      const menuScreenshot = screenshotService.getPath('douyin-menu-popup', taskId);
      await page.screenshot({ path: menuScreenshot });
      
      const afterPublishScreenshot = screenshotService.getPath('douyin-after-publish', taskId);
      await page.screenshot({ path: afterPublishScreenshot });
      
      // ... å‘å¸ƒé€»è¾‘
      
    } catch (error) {
      const errorScreenshot = screenshotService.getPath('douyin-error', taskId);
      await page.screenshot({ path: errorScreenshot });
      throw error;
    }
  }
}
```

### 4. æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡

```typescript
// server/src/index.ts

import { screenshotService } from './services/ScreenshotService';

// å¯åŠ¨æ—¶æ¸…ç†ä¸€æ¬¡
screenshotService.cleanup();

// æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ¸…ç†
setInterval(async () => {
  const now = new Date();
  if (now.getHours() === 3 && now.getMinutes() === 0) {
    await screenshotService.cleanup();
    await screenshotService.cleanupBySize();
  }
}, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

### 5. æ·»åŠ ç®¡ç† API

```typescript
// server/src/routes/screenshots.ts

import express from 'express';
import { screenshotService } from '../services/ScreenshotService';
import { authenticateToken, requireAdmin } from '../middleware/auth';

const router = express.Router();

// è·å–æˆªå›¾ç»Ÿè®¡
router.get('/stats', authenticateToken, requireAdmin, async (req, res) => {
  const stats = screenshotService.getStats();
  res.json({
    count: stats.count,
    totalSize: stats.totalSize,
    totalSizeMB: (stats.totalSize / 1024 / 1024).toFixed(2),
    oldestDate: stats.oldestDate
  });
});

// æ‰‹åŠ¨æ¸…ç†æˆªå›¾
router.post('/cleanup', authenticateToken, requireAdmin, async (req, res) => {
  const result = await screenshotService.cleanup();
  res.json({
    success: true,
    deleted: result.deleted,
    freedSpaceMB: (result.freedSpace / 1024 / 1024).toFixed(2)
  });
});

export default router;
```

## ğŸ“‹ ç«‹å³æ‰§è¡Œçš„æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ›´æ–° .gitignoreï¼ˆå¿…é¡»ï¼‰

```bash
cat >> .gitignore << 'EOF'

# å‘å¸ƒæˆªå›¾
server/*.png
screenshots/
*.png
!client/public/**/*.png
EOF
```

### æ­¥éª¤ 2ï¼šåˆ é™¤ç°æœ‰æˆªå›¾ï¼ˆå¯é€‰ï¼‰

```bash
# å¦‚æœä¸éœ€è¦ä¿ç•™å½“å‰çš„æˆªå›¾
rm server/*.png

# æˆ–è€…ç§»åŠ¨åˆ°å¤‡ä»½ç›®å½•
mkdir -p screenshots-backup
mv server/*.png screenshots-backup/
```

### æ­¥éª¤ 3ï¼šä» Git ä¸­ç§»é™¤ï¼ˆå¦‚æœå·²æäº¤ï¼‰

```bash
# ä» Git ç´¢å¼•ä¸­åˆ é™¤ï¼Œä½†ä¿ç•™æœ¬åœ°æ–‡ä»¶
git rm --cached server/*.png 2>/dev/null || true

# æäº¤æ›´æ”¹
git add .gitignore
git commit -m "chore: å¿½ç•¥å‘å¸ƒæˆªå›¾æ–‡ä»¶"
```

## ğŸ“Š ç©ºé—´å ç”¨åˆ†æ

### å½“å‰çŠ¶å†µ
- **8 ä¸ªæˆªå›¾æ–‡ä»¶**
- **æ€»å¤§å°ï¼š9.2 MB**
- **å¹³å‡æ¯ä¸ªï¼š1.15 MB**

### é¢„ä¼°å¢é•¿
å‡è®¾æ¯å¤©å‘å¸ƒ 10 æ¬¡ï¼š
- æ¯å¤©æ–°å¢ï¼š10 Ã— 8 Ã— 1.15 MB = 92 MB
- æ¯å‘¨æ–°å¢ï¼š644 MB
- æ¯æœˆæ–°å¢ï¼š2.76 GB

### å»ºè®®é…ç½®
- **ä¿ç•™æ—¶é—´ï¼š7 å¤©**
- **æœ€å¤§æ€»å¤§å°ï¼š100 MB**
- **è‡ªåŠ¨æ¸…ç†ï¼šæ¯å¤©å‡Œæ™¨ 3 ç‚¹**

## âœ… æœ€ç»ˆå»ºè®®

1. **ç«‹å³æ·»åŠ åˆ° .gitignore** - é˜²æ­¢æäº¤åˆ° Git
2. **åˆ›å»º screenshots ç›®å½•** - ç»Ÿä¸€ç®¡ç†
3. **æ·»åŠ æ—¶é—´æˆ³** - é¿å…è¦†ç›–ï¼Œä¾¿äºè¿½æº¯
4. **è‡ªåŠ¨æ¸…ç†** - ä¿ç•™ 7 å¤©ï¼Œè¶…è¿‡ 100MB è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„
5. **åªåœ¨å¤±è´¥æ—¶ä¿ç•™** - æˆåŠŸçš„ä»»åŠ¡å¯ä»¥åˆ é™¤æˆªå›¾

è¿™æ ·æ—¢èƒ½ä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼Œåˆä¸ä¼šæ— é™å¢é•¿å ç”¨ç©ºé—´ï¼
