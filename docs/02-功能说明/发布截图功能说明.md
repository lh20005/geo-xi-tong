# å‘å¸ƒæˆªå›¾åŠŸèƒ½è¯´æ˜

## ğŸ“¸ æˆªå›¾çš„ç”¨é€”

å‘å¸ƒç»“æŸåçš„æˆªå›¾ä¸»è¦ç”¨äºä»¥ä¸‹å‡ ä¸ªç›®çš„ï¼š

### 1. è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ ğŸ”

å½“è‡ªåŠ¨å‘å¸ƒå‡ºç°é—®é¢˜æ—¶ï¼Œæˆªå›¾å¯ä»¥å¸®åŠ©ä½ ï¼š
- æŸ¥çœ‹å‘å¸ƒæ˜¯å¦çœŸçš„æˆåŠŸ
- ç¡®è®¤é¡µé¢åœç•™åœ¨å“ªä¸ªçŠ¶æ€
- å‘ç°é€‰æ‹©å™¨å¤±æ•ˆæˆ–é¡µé¢å˜åŒ–
- å®šä½å…·ä½“çš„é”™è¯¯åŸå› 

**ç¤ºä¾‹åœºæ™¯ï¼š**
```
å‘å¸ƒä»»åŠ¡æ˜¾ç¤º"æˆåŠŸ"ï¼Œä½†å®é™…æ–‡ç« æ²¡å‘å‡ºå»
â†’ æŸ¥çœ‹ douyin-after-publish.png
â†’ å‘ç°é¡µé¢è¿˜åœç•™åœ¨ç¼–è¾‘é¡µé¢
â†’ è¯´æ˜"å‘å¸ƒ"æŒ‰é’®æ²¡æœ‰çœŸæ­£ç‚¹å‡»æˆåŠŸ
```

### 2. éªŒè¯å‘å¸ƒçŠ¶æ€ âœ…

ç”±äºå¹³å°çš„åé¦ˆä¸ä¸€å®šå¯é ï¼Œæˆªå›¾æä¾›äº†è§†è§‰è¯æ®ï¼š

```typescript
// ä»£ç ä¸­çš„é€»è¾‘
console.log('[æŠ–éŸ³å·] âš ï¸ ä»åœ¨ç¼–è¾‘é¡µé¢ï¼Œå‘å¸ƒå¯èƒ½æœªæˆåŠŸ');
console.log('[æŠ–éŸ³å·] ğŸ’¡ å»ºè®®ï¼šæŸ¥çœ‹ douyin-after-publish.png æˆªå›¾ç¡®è®¤çŠ¶æ€');
```

**æˆªå›¾å¯ä»¥æ˜¾ç¤ºï¼š**
- âœ… æ˜¯å¦æœ‰"å‘å¸ƒæˆåŠŸ"çš„æç¤º
- âœ… é¡µé¢æ˜¯å¦è·³è½¬åˆ°äº†å†…å®¹ç®¡ç†é¡µ
- âœ… æ˜¯å¦è¿˜åœç•™åœ¨ç¼–è¾‘å™¨é¡µé¢
- âœ… æ˜¯å¦æœ‰é”™è¯¯æç¤ºå¼¹çª—

### 3. è®°å½•å‘å¸ƒè¿‡ç¨‹ ğŸ“

æˆªå›¾åœ¨ä¸åŒé˜¶æ®µä¿å­˜ï¼Œå½¢æˆå®Œæ•´çš„å‘å¸ƒè®°å½•ï¼š

| æˆªå›¾æ–‡ä»¶ | æ—¶æœº | ç”¨é€” |
|---------|------|------|
| `douyin-home-page.png` | è¿›å…¥é¦–é¡µ | ç¡®è®¤ç™»å½•çŠ¶æ€ |
| `douyin-menu-popup.png` | æ‰“å¼€èœå• | éªŒè¯èœå•æ˜¾ç¤º |
| `douyin-declaration-sidebar.png` | åŸåˆ›å£°æ˜ | æ£€æŸ¥ä¾§è¾¹æ  |
| `douyin-before-publish.png` | ç‚¹å‡»å‘å¸ƒå‰ | ç¡®è®¤å†…å®¹å¡«å†™å®Œæ•´ |
| `douyin-after-publish.png` | å‘å¸ƒå | **éªŒè¯å‘å¸ƒç»“æœ** â­ |
| `douyin-error.png` | å‡ºé”™æ—¶ | é”™è¯¯ç°åœºä¿å­˜ |

### 4. å¼€å‘å’Œç»´æŠ¤ ğŸ› ï¸

å¯¹äºå¼€å‘è€…ï¼š
- äº†è§£å¹³å°é¡µé¢ç»“æ„å˜åŒ–
- æ›´æ–°é€‰æ‹©å™¨æ—¶çš„å‚è€ƒ
- æµ‹è¯•æ–°åŠŸèƒ½æ—¶çš„å¯¹æ¯”
- æ–‡æ¡£å’Œæ•™ç¨‹çš„ç´ æ

## ğŸ“‚ æˆªå›¾ä¿å­˜ä½ç½®

**å½“å‰é…ç½®ï¼š**
```typescript
await page.screenshot({ 
  path: 'douyin-after-publish.png',  // ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•
  fullPage: true                      // å®Œæ•´é¡µé¢æˆªå›¾
});
```

**å®é™…ä½ç½®ï¼š**
```
é¡¹ç›®æ ¹ç›®å½•/
  â”œâ”€â”€ douyin-after-publish.png      â† æŠ–éŸ³å‘å¸ƒå
  â”œâ”€â”€ douyin-before-publish.png     â† æŠ–éŸ³å‘å¸ƒå‰
  â”œâ”€â”€ douyin-error.png              â† æŠ–éŸ³é”™è¯¯
  â”œâ”€â”€ toutiao-publish-page.png      â† å¤´æ¡å‘å¸ƒé¡µ
  â””â”€â”€ ...
```

## ğŸ” å¦‚ä½•ä½¿ç”¨æˆªå›¾æ’æŸ¥é—®é¢˜

### åœºæ™¯ 1ï¼šå‘å¸ƒå¤±è´¥

**æ­¥éª¤ï¼š**
1. æŸ¥çœ‹å‘å¸ƒä»»åŠ¡æ—¥å¿—ï¼Œæ‰¾åˆ°é”™è¯¯ä¿¡æ¯
2. æ‰“å¼€å¯¹åº”çš„æˆªå›¾æ–‡ä»¶
3. æ£€æŸ¥é¡µé¢çŠ¶æ€ï¼š
   - æ˜¯å¦æœ‰é”™è¯¯æç¤ºï¼Ÿ
   - åœç•™åœ¨å“ªä¸ªé¡µé¢ï¼Ÿ
   - æŒ‰é’®æ˜¯å¦å¯è§ï¼Ÿ
4. æ ¹æ®æˆªå›¾è°ƒæ•´ä»£ç é€»è¾‘

**ç¤ºä¾‹ï¼š**
```bash
# æŸ¥çœ‹æœ€è¿‘çš„æˆªå›¾
ls -lt *.png | head -5

# æ‰“å¼€æˆªå›¾
open douyin-after-publish.png  # macOS
# æˆ–
xdg-open douyin-after-publish.png  # Linux
```

### åœºæ™¯ 2ï¼šé€‰æ‹©å™¨å¤±æ•ˆ

**é—®é¢˜ï¼š** ä»£ç æ‰¾ä¸åˆ°"å‘å¸ƒ"æŒ‰é’®

**è§£å†³ï¼š**
1. æŸ¥çœ‹ `douyin-before-publish.png`
2. æ‰‹åŠ¨åœ¨æˆªå›¾ä¸­æ‰¾åˆ°å‘å¸ƒæŒ‰é’®
3. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥æŒ‰é’®çš„æ–°é€‰æ‹©å™¨
4. æ›´æ–°ä»£ç ä¸­çš„é€‰æ‹©å™¨

### åœºæ™¯ 3ï¼šéªŒè¯å‘å¸ƒæˆåŠŸ

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æˆªå›¾ä¸­æ˜¯å¦æœ‰"å‘å¸ƒæˆåŠŸ"å­—æ ·ï¼Ÿ
- [ ] URL æ˜¯å¦ä»ç¼–è¾‘é¡µè·³è½¬åˆ°åˆ—è¡¨é¡µï¼Ÿ
- [ ] æ˜¯å¦è¿˜èƒ½çœ‹åˆ°ç¼–è¾‘å™¨ç•Œé¢ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯æç¤ºï¼Ÿ

## âš™ï¸ é…ç½®é€‰é¡¹

### ä¿®æ”¹æˆªå›¾ä¿å­˜è·¯å¾„

```typescript
// server/src/services/adapters/DouyinAdapter.ts

// å½“å‰ï¼šä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•
await page.screenshot({ path: 'douyin-after-publish.png' });

// æ”¹ä¸ºï¼šä¿å­˜åœ¨ä¸“é—¨çš„ç›®å½•
await page.screenshot({ 
  path: path.join(__dirname, '../../../screenshots/douyin-after-publish.png')
});
```

### æ·»åŠ æ—¶é—´æˆ³

```typescript
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
await page.screenshot({ 
  path: `douyin-after-publish-${timestamp}.png`
});

// ç”Ÿæˆæ–‡ä»¶åç¤ºä¾‹ï¼š
// douyin-after-publish-2025-12-25T22-30-45-123Z.png
```

### åªåœ¨å¤±è´¥æ—¶æˆªå›¾

```typescript
try {
  // å‘å¸ƒé€»è¾‘
  await clickPublishButton();
  // æˆåŠŸæ—¶ä¸æˆªå›¾
} catch (error) {
  // å¤±è´¥æ—¶æ‰æˆªå›¾
  await page.screenshot({ path: 'douyin-error.png' });
  throw error;
}
```

### ä¿å­˜åˆ°æ•°æ®åº“

```typescript
// å°†æˆªå›¾ä¿å­˜ä¸º base64 å­˜å…¥æ•°æ®åº“
const screenshot = await page.screenshot({ encoding: 'base64' });

await pool.query(
  'UPDATE publishing_tasks SET screenshot = $1 WHERE id = $2',
  [screenshot, taskId]
);
```

## ğŸ“Š æˆªå›¾çš„å­˜å‚¨è€ƒè™‘

### ä¼˜ç‚¹ï¼š
- âœ… ç›´è§‚ï¼Œæ˜“äºæŸ¥çœ‹
- âœ… ä¿ç•™å®Œæ•´çš„é¡µé¢çŠ¶æ€
- âœ… ä¾¿äºé—®é¢˜æ’æŸ¥

### ç¼ºç‚¹ï¼š
- âš ï¸ å ç”¨ç£ç›˜ç©ºé—´ï¼ˆæ¯å¼ çº¦ 100KB - 2MBï¼‰
- âš ï¸ å¤§é‡ä»»åŠ¡ä¼šäº§ç”Ÿå¾ˆå¤šæ–‡ä»¶
- âš ï¸ éœ€è¦å®šæœŸæ¸…ç†

### ä¼˜åŒ–å»ºè®®ï¼š

**1. å®šæœŸæ¸…ç†æ—§æˆªå›¾**
```bash
# åˆ é™¤ 7 å¤©å‰çš„æˆªå›¾
find . -name "*.png" -mtime +7 -delete
```

**2. åªä¿ç•™å¤±è´¥ä»»åŠ¡çš„æˆªå›¾**
```typescript
if (publishSuccess) {
  // æˆåŠŸæ—¶åˆ é™¤æˆªå›¾
  fs.unlinkSync('douyin-after-publish.png');
} else {
  // å¤±è´¥æ—¶ä¿ç•™æˆªå›¾
  console.log('æˆªå›¾å·²ä¿å­˜ï¼Œè¯·æŸ¥çœ‹: douyin-after-publish.png');
}
```

**3. å‹ç¼©æˆªå›¾**
```typescript
await page.screenshot({ 
  path: 'douyin-after-publish.png',
  quality: 50,  // JPEG è´¨é‡ (0-100)
  type: 'jpeg'  // ä½¿ç”¨ JPEG æ ¼å¼æ›´å°
});
```

**4. ä¸Šä¼ åˆ°äº‘å­˜å‚¨**
```typescript
// æˆªå›¾åä¸Šä¼ åˆ° OSS/S3
const screenshot = await page.screenshot();
await uploadToOSS(screenshot, `screenshots/${taskId}.png`);
// åˆ é™¤æœ¬åœ°æ–‡ä»¶
fs.unlinkSync('douyin-after-publish.png');
```

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘é˜¶æ®µï¼š
- âœ… ä¿ç•™æ‰€æœ‰æˆªå›¾ï¼Œä¾¿äºè°ƒè¯•
- âœ… ä½¿ç”¨æ—¶é—´æˆ³å‘½åï¼Œé¿å…è¦†ç›–
- âœ… å®šæœŸæŸ¥çœ‹æˆªå›¾ï¼Œä¼˜åŒ–å‘å¸ƒæµç¨‹

### ç”Ÿäº§ç¯å¢ƒï¼š
- âœ… åªåœ¨å¤±è´¥æ—¶æˆªå›¾
- âœ… è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘å­˜å‚¨
- âœ… è®¾ç½®è‡ªåŠ¨æ¸…ç†ç­–ç•¥
- âœ… åœ¨ç®¡ç†ç•Œé¢æ˜¾ç¤ºæˆªå›¾é“¾æ¥

### ç¤ºä¾‹ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®

```typescript
// server/src/services/adapters/DouyinAdapter.ts

async publish(article: Article, account: Account, taskId: number) {
  let screenshotPath: string | null = null;
  
  try {
    // ... å‘å¸ƒé€»è¾‘ ...
    
    // å‘å¸ƒåç­‰å¾…
    await new Promise(resolve => setTimeout(resolve, 20000));
    
    // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
    const success = await this.checkPublishSuccess(page);
    
    if (!success) {
      // åªåœ¨å¤±è´¥æ—¶æˆªå›¾
      screenshotPath = `screenshots/failed-${taskId}-${Date.now()}.png`;
      await page.screenshot({ path: screenshotPath });
      
      // ä¿å­˜æˆªå›¾è·¯å¾„åˆ°æ•°æ®åº“
      await pool.query(
        'UPDATE publishing_tasks SET screenshot_path = $1 WHERE id = $2',
        [screenshotPath, taskId]
      );
      
      throw new Error('å‘å¸ƒå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æˆªå›¾');
    }
    
  } catch (error) {
    // é”™è¯¯æ—¶ä¹Ÿæˆªå›¾
    if (!screenshotPath) {
      screenshotPath = `screenshots/error-${taskId}-${Date.now()}.png`;
      await page.screenshot({ path: screenshotPath });
    }
    throw error;
  }
}
```

## ğŸ“± å‰ç«¯æ˜¾ç¤ºæˆªå›¾

å¯ä»¥åœ¨å‘å¸ƒè®°å½•é¡µé¢æ˜¾ç¤ºæˆªå›¾ï¼š

```typescript
// client/src/pages/PublishingRecordsPage.tsx

<Table.Column
  title="æˆªå›¾"
  dataIndex="screenshotPath"
  render={(path: string) => 
    path ? (
      <Image
        width={100}
        src={`/api/screenshots/${path}`}
        alt="å‘å¸ƒæˆªå›¾"
      />
    ) : '-'
  }
/>
```

## ğŸ“ æ€»ç»“

**å‘å¸ƒæˆªå›¾çš„æ ¸å¿ƒä»·å€¼ï¼š**

1. **è°ƒè¯•å·¥å…·** - å¿«é€Ÿå®šä½é—®é¢˜
2. **éªŒè¯æ‰‹æ®µ** - ç¡®è®¤å‘å¸ƒçŠ¶æ€
3. **è®°å½•è¯æ®** - ä¿ç•™å‘å¸ƒè¿‡ç¨‹
4. **ç»´æŠ¤å‚è€ƒ** - æ›´æ–°ä»£ç ä¾æ®

**å»ºè®®ï¼š**
- å¼€å‘æ—¶ï¼šä¿ç•™æ‰€æœ‰æˆªå›¾
- ç”Ÿäº§æ—¶ï¼šåªä¿ç•™å¤±è´¥æˆªå›¾
- å®šæœŸæ¸…ç†ï¼šé¿å…å ç”¨è¿‡å¤šç©ºé—´
- äº‘ç«¯å­˜å‚¨ï¼šä¾¿äºå›¢é˜Ÿåä½œ

æˆªå›¾åŠŸèƒ½è™½ç„¶ç®€å•ï¼Œä½†åœ¨è‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿä¸­éå¸¸é‡è¦ï¼Œæ˜¯æ’æŸ¥é—®é¢˜çš„ç¬¬ä¸€æ‰‹èµ„æ–™ï¼
