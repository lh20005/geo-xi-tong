# 用户订阅管理系统

## 功能概述

用户订阅管理系统是 GEO 优化系统的核心管理功能之一，允许管理员全面管理用户的订阅套餐、配额和权益。

## 核心功能

### 1. 订阅信息查看 📊

**功能描述**：
- 查看用户当前订阅套餐详情
- 实时显示配额使用情况
- 可视化展示使用进度

**显示内容**：
- 套餐名称、价格、状态
- 开始日期、到期日期、剩余天数
- 各功能配额和使用量
- 使用率进度条（颜色区分：绿色<80%，黄色80-100%，红色>100%）

### 2. 套餐升级 ⬆️

**功能描述**：
- 将用户套餐升级到更高级别
- 立即生效，保留剩余时间

**操作流程**：
1. 选择新套餐
2. 查看套餐对比
3. 输入升级原因
4. 确认升级

**业务逻辑**：
- 保留原套餐剩余天数
- 累加新套餐时长
- 清空自定义配额，使用新套餐默认配额
- 记录操作历史

### 3. 订阅延期 ⏰

**功能描述**：
- 延长用户订阅有效期
- 不改变套餐配置

**操作流程**：
1. 输入延长天数（1-3650天）
2. 预览新到期日期
3. 输入延期原因
4. 确认延期

**业务逻辑**：
- 在当前到期日期基础上增加天数
- 套餐配置保持不变
- 记录操作历史

### 4. 配额调整 🎯

**功能描述**：
- 临时或永久调整用户功能配额
- 重置当前周期使用量

**调整类型**：

#### 临时调整
- 仅对当前订阅周期有效
- 写入 custom_quotas 字段
- 订阅续费后恢复默认配额

#### 永久调整
- 对当前和未来订阅周期有效
- 写入 custom_quotas 字段并标记
- 需要手动清除才能恢复

#### 重置使用量
- 清空当前周期的使用记录
- 配额限制不变
- 用于误操作或测试场景

**操作流程**：
1. 选择功能类型
2. 查看当前配额信息
3. 输入新配额值（-1表示无限制）
4. 选择是否永久生效
5. 输入调整原因
6. 确认调整

### 5. 订阅控制 🎛️

#### 暂停订阅
**功能描述**：
- 临时停用用户订阅
- 保留所有数据和配置

**使用场景**：
- 用户申请暂停
- 违规处理
- 系统维护

**操作流程**：
1. 输入暂停原因
2. 确认暂停
3. 用户立即无法使用功能

#### 恢复订阅
**功能描述**：
- 恢复已暂停的订阅
- 立即生效

**操作流程**：
1. 输入恢复原因
2. 确认恢复
3. 用户立即可以使用功能

#### 取消订阅
**功能描述**：
- 取消用户订阅
- 支持立即或到期后取消

**取消方式**：

**立即取消**：
- 将到期日期设为当前时间
- 用户立即失去所有权益
- 适用于违规处理

**到期后取消**：
- 标记状态为已取消
- 用户可使用到当前订阅到期
- 适用于正常取消

### 6. 套餐赠送 🎁

**功能描述**：
- 免费赠送指定套餐和时长
- 立即生效

**操作流程**：
1. 选择套餐
2. 输入赠送时长（1-3650天）
3. 预览赠送信息
4. 输入赠送原因
5. 确认赠送

**使用场景**：
- 活动奖励
- 补偿赠送
- 测试账号
- VIP 特权

**业务逻辑**：
- 创建新的订阅记录
- 标记为赠送（is_gift = true）
- 记录赠送原因

### 7. 调整历史 📝

**功能描述**：
- 查看所有订阅调整记录
- 支持分页查询

**显示内容**：
- 操作时间
- 操作类型（标签化显示）
- 操作详情（前后对比）
- 操作原因
- 操作人

**操作类型**：
- 🔵 升级套餐
- 🟢 延期订阅
- 🟠 暂停订阅
- 🔵 恢复订阅
- 🔴 取消订阅
- 🟣 配额调整
- 🟡 赠送套餐

## 界面设计

### 主界面 - 订阅详情抽屉

**布局结构**：
```
┌─────────────────────────────────────┐
│  用户名 - 订阅管理              [X] │
├─────────────────────────────────────┤
│  [订阅概览] [调整历史]              │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐  │
│  │ 当前套餐 [活跃]               │  │
│  │ 套餐名称: 专业版              │  │
│  │ 套餐价格: ¥99.00              │  │
│  │ 剩余天数: 30天                │  │
│  │ 开始日期: 2026-01-01          │  │
│  │ 到期日期: 2026-01-31          │  │
│  └───────────────────────────────┘  │
│                                      │
│  ┌───────────────────────────────┐  │
│  │ 配额使用情况                  │  │
│  │ 每月文章生成数                │  │
│  │ ████████░░ 80/100 (80%)       │  │
│  │ 每月发布次数                  │  │
│  │ ██████░░░░ 60/100 (60%)       │  │
│  └───────────────────────────────┘  │
│                                      │
│  ┌───────────────────────────────┐  │
│  │ 快捷操作                      │  │
│  │ [升级套餐] [延期订阅]         │  │
│  │ [调整配额] [赠送套餐]         │  │
│  │ [暂停订阅] [取消订阅]         │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 操作模态框设计

**统一设计原则**：
- 清晰的标题和图标
- 信息提示框（说明操作影响）
- 简洁的表单
- 实时预览效果
- 明确的确认按钮

## 技术实现

### 数据库设计

**subscription_adjustments 表**：
```sql
CREATE TABLE subscription_adjustments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  subscription_id INTEGER,
  adjustment_type VARCHAR(50) NOT NULL,
  old_plan_id INTEGER,
  new_plan_id INTEGER,
  old_end_date TIMESTAMP,
  new_end_date TIMESTAMP,
  days_added INTEGER,
  quota_adjustments JSONB,
  reason TEXT,
  admin_id INTEGER NOT NULL,
  admin_note TEXT,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**user_subscriptions 扩展字段**：
- `paused_at` - 暂停时间
- `pause_reason` - 暂停原因
- `custom_quotas` - 自定义配额
- `is_gift` - 是否赠送
- `gift_reason` - 赠送原因

### API 设计

**RESTful API**：
- GET `/api/admin/user-subscriptions/:userId` - 获取详情
- POST `/api/admin/user-subscriptions/:userId/upgrade` - 升级
- POST `/api/admin/user-subscriptions/:userId/extend` - 延期
- POST `/api/admin/user-subscriptions/:userId/adjust-quota` - 调整配额
- POST `/api/admin/user-subscriptions/:userId/reset-quota` - 重置配额
- POST `/api/admin/user-subscriptions/:userId/pause` - 暂停
- POST `/api/admin/user-subscriptions/:userId/resume` - 恢复
- POST `/api/admin/user-subscriptions/:userId/cancel` - 取消
- POST `/api/admin/user-subscriptions/:userId/gift` - 赠送
- GET `/api/admin/user-subscriptions/:userId/history` - 历史

### 前端组件

**组件树**：
```
SubscriptionDetailDrawer (主抽屉)
├── UpgradePlanModal (升级套餐)
├── ExtendSubscriptionModal (延期订阅)
├── AdjustQuotaModal (配额调整)
├── ControlSubscriptionModal (订阅控制)
├── GiftSubscriptionModal (赠送套餐)
└── AdjustmentHistoryTable (历史记录)
```

## 权限与安全

### 权限要求
- 需要管理员权限
- 使用 JWT 认证
- 中间件验证

### 审计日志
- 记录所有操作
- 包含操作人、时间、IP
- 记录操作前后状态
- 支持历史追溯

### 数据安全
- 使用数据库事务
- 防止并发冲突
- 参数验证严格
- SQL 注入防护

## 使用场景

### 场景 1：用户申请升级
1. 用户联系客服申请升级
2. 管理员登录系统
3. 找到用户，点击"订阅管理"
4. 点击"升级套餐"
5. 选择新套餐，输入"用户申请升级"
6. 确认升级
7. 通知用户升级成功

### 场景 2：活动赠送
1. 活动结束，需要给获奖用户赠送套餐
2. 管理员进入用户订阅管理
3. 点击"赠送套餐"
4. 选择套餐和时长
5. 输入"活动奖励"
6. 确认赠送
7. 用户收到通知

### 场景 3：违规处理
1. 发现用户违规使用
2. 管理员进入用户订阅管理
3. 点击"暂停订阅"
4. 输入"违规处理"
5. 确认暂停
6. 用户无法使用功能
7. 问题解决后恢复订阅

### 场景 4：配额不足
1. 用户反馈配额不够用
2. 管理员查看使用情况
3. 点击"调整配额"
4. 选择功能，输入新配额
5. 选择临时或永久
6. 输入"用户申请"
7. 确认调整

## 最佳实践

### 操作建议

1. **升级套餐**：
   - 确认用户需求
   - 选择合适的套餐
   - 说明清楚原因

2. **延期订阅**：
   - 确认延期时长
   - 记录延期原因
   - 通知用户新到期日期

3. **配额调整**：
   - 了解用户实际需求
   - 优先使用临时调整
   - 定期审查永久调整

4. **暂停/取消**：
   - 谨慎操作
   - 详细记录原因
   - 及时通知用户

5. **赠送套餐**：
   - 确认赠送理由
   - 记录活动信息
   - 控制赠送频率

### 注意事项

1. 所有操作都会记录日志，请谨慎操作
2. 升级套餐会清空自定义配额
3. 暂停订阅会立即生效，用户无法使用功能
4. 取消订阅不可撤销，请确认后操作
5. 配额调整建议优先使用临时调整

## 常见问题

### Q1: 升级套餐后配额会怎样？
A: 升级后会使用新套餐的默认配额，之前的自定义配额会被清空。

### Q2: 延期和升级有什么区别？
A: 延期只延长时间，不改变套餐；升级会更换套餐并延长时间。

### Q3: 临时配额和永久配额的区别？
A: 临时配额仅对当前订阅周期有效，永久配额会一直保留。

### Q4: 暂停和取消有什么区别？
A: 暂停可以恢复，取消不可撤销。

### Q5: 赠送的套餐会覆盖原有订阅吗？
A: 不会，赠送会创建新的订阅记录，与原有订阅并存。

## 相关文档

- [用户订阅管理功能实施指南](../../用户订阅管理功能实施指南.md)
- [测试用户订阅管理功能](../../测试用户订阅管理功能.md)
- [商品管理系统实施指南](./商品管理系统实施指南.md)
- [配额系统说明](../../配额系统修复总结_最终版.md)

---

**文档版本**: v1.0.0  
**最后更新**: 2026-01-05  
**维护者**: GEO 开发团队
