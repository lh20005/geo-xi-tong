# 订阅套餐状态优化

## 概述

优化了用户中心的订阅套餐显示，为已购买套餐的用户提供更智能的状态提示和操作引导。

## 优化内容

### 1. 套餐卡片状态显示

根据用户当前订阅状态，套餐卡片会显示不同的标签和样式：

#### 未购买任何套餐
- **标签**：紫色"推荐"标签
- **按钮**：蓝色"立即购买"按钮
- **样式**：标准边框

#### 当前套餐
- **标签**：蓝色"当前套餐"标签
- **按钮**：灰色"已购买"按钮（禁用状态）
- **样式**：蓝色高亮边框 + 阴影效果

#### 可升级套餐（价格更高）
- **标签**：绿色"可升级"标签
- **按钮**：蓝色"立即升级"按钮
- **提示**：显示"升级后立即生效，按剩余天数计算差价"
- **样式**：标准边框，悬停效果

#### 较低套餐（价格更低）
- **标签**：蓝色"已购买"标签
- **按钮**：灰色"已购买"按钮（禁用状态）
- **说明**：因为用户已购买更高级套餐，所以较低套餐的功能已包含在内
- **样式**：标准边框

### 2. 订阅信息卡片优化

#### 有订阅时
- 显示当前套餐名称（带皇冠图标）
- 显示到期时间（临近到期时显示警告）
- 显示订阅状态和自动续费状态
- 提供"升级套餐"和"自动续费"操作按钮

#### 无订阅时
- 显示大号皇冠图标
- 友好的引导文案
- 提供"立即订阅"和"查看套餐详情"两个操作按钮

### 3. 套餐对话框优化

- **宽度增加**：从 800px 增加到 900px，提供更好的视觉体验
- **卡片布局**：优化了卡片内部布局，信息更清晰
- **悬停效果**：可操作的卡片有悬停效果
- **视觉层次**：通过颜色、边框、阴影区分不同状态

## 技术实现

### 状态判断逻辑

```typescript
const isCurrentPlan = subscription?.plan_code === plan.plan_code;
const currentPlanPrice = parseFloat(String(plans.find(p => p.plan_code === subscription?.plan_code)?.price || 0));
const planPrice = parseFloat(String(plan.price));
const isUpgrade = planPrice > currentPlanPrice;
const isDowngrade = planPrice < currentPlanPrice;
const hasPurchased = subscription !== null;
```

### 按钮状态映射

| 条件 | 按钮文本 | 按钮类型 | 是否禁用 | 标签颜色 | 标签文本 |
|------|---------|---------|---------|---------|---------|
| 当前套餐 | 已购买 | default | 是 | blue | 当前套餐 |
| 可升级（价格更高） | 立即升级 | primary | 否 | green | 可升级 |
| 较低套餐（价格更低） | 已购买 | default | 是 | blue | 已购买 |
| 未购买 | 立即购买 | primary | 否 | purple | 推荐 |

## 用户体验改进

1. **清晰的视觉反馈**：用户一眼就能看出哪个是当前套餐，哪些可以升级
2. **智能操作引导**：根据用户状态显示合适的操作按钮
3. **友好的提示信息**：为升级操作提供额外的说明文字
4. **一致的交互体验**：所有状态下的交互逻辑保持一致

## 测试建议

### 测试场景

1. **未购买用户**
   - 访问用户中心
   - 点击"立即订阅"或"查看套餐详情"
   - 验证所有套餐显示"推荐"标签和"立即购买"按钮

2. **已购买体验版用户**
   - 验证体验版显示"当前套餐"标签和"已购买"按钮
   - 验证专业版和企业版显示"可升级"标签和"立即升级"按钮
   - 点击升级按钮，验证跳转到支付页面

3. **已购买专业版用户**
   - 验证专业版显示"当前套餐"标签
   - 验证企业版显示"可升级"标签
   - 验证体验版显示"较低套餐"标签和"不支持降级"按钮

4. **已购买企业版用户**
   - 验证企业版显示"当前套餐"标签
   - 验证其他套餐显示"较低套餐"标签和禁用状态

## 相关文件

- `client/src/pages/UserCenterPage.tsx` - 用户中心页面主文件
- `server/src/routes/subscription.ts` - 订阅相关API路由
- `server/src/services/SubscriptionService.ts` - 订阅服务逻辑

## 后续优化建议

1. **套餐对比功能**：添加套餐功能对比表格
2. **优惠活动**：支持显示限时优惠信息
3. **推荐算法**：根据用户使用情况智能推荐合适的套餐
4. **降级支持**：考虑是否支持降级操作（需要业务决策）
