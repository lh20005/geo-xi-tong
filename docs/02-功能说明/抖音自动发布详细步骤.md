# 抖音自动发布详细步骤和对应动作及值

## 概述
抖音号自动发布流程共分为 **7个步骤**，通过浏览器自动化技术实现图文内容的自动发布。

---

## 步骤详解

### 步骤1：悬停在"高清发布"按钮上，点击"发布图文"

**目标页面：** `https://creator.douyin.com/creator-micro/home`

**操作流程：**
1. 等待高清发布按钮出现（15秒超时）
2. 鼠标悬停在按钮上
3. 保持悬停5秒，等待二级菜单完全弹出
4. 点击二级菜单中的"发布图文"按钮

**选择器和值：**
```javascript
// 高清发布按钮
selector: '#douyin-creator-master-side-upload-wrap > button'
action: hover() // 悬停
delay: 5000ms // 保持悬停5秒

// 发布图文按钮（使用XPath文字匹配）
xpath: "//*[contains(text(), '发布图文')]"
action: click()
```

**等待时间：**
- 等待按钮出现：15秒
- 悬停保持：5秒
- 点击后等待页面跳转：3秒

---

### 步骤2：上传图片

**操作流程：**
1. 从文章内容中提取图片路径（Markdown格式）
2. 查找文件上传input元素
3. 使用DOM方式上传所有图片（不弹出系统对话框）
4. 等待图片上传完成

**选择器和值：**
```javascript
// 文件上传input
selector: 'input[type="file"]'
action: uploadFile(...imagePaths) // DOM方式上传

// 图片提取正则
imageRegex: /!\[([^\]]*)\]\(([^)]+)\)/g
```

**处理逻辑：**
- 支持相对路径：`/uploads/image.jpg`
- 支持绝对路径：`/path/to/image.jpg`
- 自动验证文件是否存在
- 批量上传所有图片

**等待时间：**
- 页面加载：2秒
- 图片上传完成：8秒

---

### 步骤3：填写标题

**操作流程：**
1. 等待标题输入框出现
2. 点击输入框，让光标进入
3. 输入标题文本（带延迟模拟真人输入）

**选择器和值：**
```javascript
// 标题输入框
selector: '#DCPF .content-left-F3wKrk .content-child-V0CB7w input'
action: click() // 点击获取焦点
action: type(title, { delay: 50 }) // 输入标题，每个字符延迟50ms

// 标题来源
value: config.title || article.title
```

**等待时间：**
- 等待输入框出现：10秒
- 点击后等待光标进入：1秒
- 输入完成后等待：1秒

---

### 步骤4：填写描述（正文）

**操作流程：**
1. 清理文章内容（移除标题、Markdown语法、图片标记）
2. 等待描述编辑器出现
3. 点击编辑器，让光标进入
4. 输入纯文字内容

**选择器和值：**
```javascript
// 描述编辑器
selector: '#DCPF .content-left-F3wKrk .editor-kit-editor-container.old > div > div > div'
action: click() // 点击获取焦点
action: type(textOnly, { delay: 30 }) // 输入内容，每个字符延迟30ms

// 内容清理规则
- 移除文章标题（如果content第一行包含标题）
- 移除Markdown标题格式（# 开头）
- 移除图片标记：![alt](url)
- 移除Markdown链接：[text](url)
- 移除代码块：```code```
- 移除HTML标签：<tag>content</tag>
- 保留纯文字内容
```

**等待时间：**
- 等待编辑器出现：10秒
- 点击后等待光标进入：1秒
- 输入完成后等待：2秒

---

### 步骤5：添加话题

**操作流程：**
1. 点击"添加话题"按钮
2. 输入关键词（使用文章标题）
3. 等待推荐话题出现
4. 点击推荐的第一个话题

**选择器和值：**
```javascript
// 添加话题按钮
selector: '#DCPF .editor-kit-root-container .toolbar > div:first-child > div > div > div:first-child'
action: click()

// 输入关键词
keyword: config.title || article.title
action: keyboard.type(keyword, { delay: 50 })

// 推荐话题
selector: '.mention-suggest-mount-dom span.tag-hash-view-name-DwMEe8'
action: click() // 点击第一个推荐话题
```

**等待时间：**
- 等待按钮出现：5秒
- 点击后等待输入框：1秒
- 输入后等待推荐话题：2秒
- 点击话题后等待：1秒

**错误处理：**
- 如果添加话题失败，记录警告但继续执行后续步骤

---

### 步骤6：添加自主声明（内容由AI生成）

**操作流程：**
1. 点击"添加自主声明"按钮
2. 等待侧滑页容器出现
3. 使用waitForFunction等待动画真正完成（检测transform属性）
4. 打印调试信息（所有可见的label和button）
5. 使用JavaScript直接点击"内容由AI生成"选项（多种点击方式）
6. 使用JavaScript直接点击确定按钮（多种点击方式）

**关键技术改进：**

```javascript
// 1. 使用waitForFunction等待动画真正完成
await page.waitForFunction(() => {
  const sidesheet = document.querySelector('.semi-sidesheet-inner');
  if (!sidesheet) return false;
  
  const style = window.getComputedStyle(sidesheet);
  const transform = style.transform;
  
  // 检查transform是否完成（无动画）
  return transform === 'none' || 
         transform.includes('matrix(1, 0, 0, 1, 0, 0)') ||
         !transform.includes('translate');
}, { timeout: 10000 });

// 2. 调试：打印所有可见元素
const debugLabels = await page.evaluate(() => {
  return Array.from(document.querySelectorAll('label'))
    .filter(label => {
      const style = window.getComputedStyle(label);
      const rect = label.getBoundingClientRect();
      return style.display !== 'none' && 
             style.visibility !== 'hidden' && 
             rect.width > 0 && rect.height > 0;
    })
    .map(label => ({
      text: label.textContent?.trim(),
      className: label.className
    }));
});

// 3. 使用JavaScript直接点击（绕过Puppeteer的点击限制）
const clicked = await page.evaluate(() => {
  const labels = Array.from(document.querySelectorAll('label'));
  
  for (const label of labels) {
    if (label.textContent?.includes('内容由AI生成')) {
      // 方式1：直接点击label
      label.click();
      
      // 方式2：点击内部input并设置checked
      const input = label.querySelector('input');
      if (input) {
        input.click();
        input.checked = true;
      }
      
      // 方式3：触发change事件
      if (input) {
        input.dispatchEvent(new Event('change', { bubbles: true }));
      }
      
      // 方式4：触发click事件
      label.dispatchEvent(new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
      }));
      
      return true;
    }
  }
  return false;
});

// 4. 点击确定按钮（移除pointer-events限制）
const confirmClicked = await page.evaluate(() => {
  const footer = document.querySelector('.semi-sidesheet-body > footer');
  const buttons = Array.from(footer.querySelectorAll('button'));
  
  for (const button of buttons) {
    if (button.textContent?.includes('确定') && 
        button.className.includes('semi-button-primary')) {
      
      // 移除可能的pointer-events限制
      button.style.pointerEvents = 'auto';
      
      // 多种点击方式
      button.click();
      button.dispatchEvent(new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
      }));
      
      // 触发mousedown和mouseup
      button.dispatchEvent(new MouseEvent('mousedown', {
        view: window,
        bubbles: true,
        cancelable: true
      }));
      button.dispatchEvent(new MouseEvent('mouseup', {
        view: window,
        bubbles: true,
        cancelable: true
      }));
      
      return true;
    }
  }
  return false;
});
```

**为什么使用JavaScript直接点击：**

1. **绕过Puppeteer的点击限制**：Puppeteer的click()方法会检查元素是否真正可点击，但有时元素虽然可见但有CSS限制
2. **绕过pointer-events限制**：某些元素可能有`pointer-events: none`，JavaScript可以直接移除
3. **触发多种事件**：同时触发click、change、mousedown、mouseup，确保框架能捕获
4. **直接操作DOM**：不依赖坐标计算，不受动画影响

**调试输出：**
- 打印所有可见的label元素（文本和className）
- 打印所有可见的button元素（文本和className）
- 在浏览器控制台输出详细的查找和点击过程

**等待时间：**
- 等待按钮出现：5秒
- 等待侧滑页容器：5秒
- 等待动画完成（waitForFunction）：最多10秒
- 额外稳定时间：1秒
- 点击后等待：1秒
- 侧边栏关闭：2秒

**错误处理：**
- 如果添加声明失败，记录警告但继续执行后续步骤
- 详细的调试日志帮助定位问题

---

### 步骤7：点击发布按钮

**操作流程：**
1. 等待发布按钮出现
2. 验证按钮可见性和可点击性
3. 点击发布按钮
4. 检查是否有二次确认对话框
5. 等待发布完成
6. 验证发布结果

**选择器和值：**
```javascript
// 主发布按钮（CSS选择器）
selector: '#DCPF button.primary-cECiOJ.fixed-J9O8Yw'
action: click()

// 备用方案1：XPath精确路径
xpath: '//*[@id="DCPF"]/div/div[1]/div/div[5]/div/div/div/div/div/button[1]'

// 备用方案2：XPath文字匹配
xpath: "//button[contains(text(), '发布')]"
filter: 文字为"发布" 且 class包含"primary" 且 可见

// 二次确认按钮（如果存在）
searchText: ['确定', '确认', '发布', '立即发布']
method: 遍历所有可见按钮，查找确认按钮
action: click()
```

**验证逻辑：**
```javascript
// 检查按钮可见性
buttonInfo = {
  text: element.textContent.trim(),
  visible: display !== 'none' && 
           visibility !== 'hidden' && 
           opacity !== '0' &&
           width > 0 && 
           height > 0,
  className: element.className
}

// 发布成功检查
1. 检查URL是否变化
2. 查找成功提示文字：'发布成功'、'已发布'
3. 检查是否还在编辑页面（#DCPF元素）
```

**等待时间：**
- 等待发布按钮出现：20秒
- 点击后等待确认对话框：3秒
- 等待发布完成：20秒

**截图保存：**
- 发布前：`douyin-before-publish.png`
- 发布后：`douyin-after-publish.png`
- 错误时：`douyin-error.png`

---

## 登录方式

### Cookie登录（推荐）

**登录URL：** `https://creator.douyin.com/`

**验证URL：** `https://creator.douyin.com/creator-micro/home`

**成功标志：**
```javascript
// 登录成功后检查高清发布按钮
successIndicator: '#douyin-creator-master-side-upload-wrap'
timeout: 10000ms
```

**Cookie设置流程：**
1. 访问登录页面
2. 设置Cookie
3. 跳转到创作者中心首页
4. 等待3秒
5. 检查高清发布按钮是否存在

---

## 关键配置参数

### 超时时间
```javascript
waitForSelector: 10000ms - 20000ms // 根据元素重要性
pageLoad: 5000ms
hover: 5000ms
imageUpload: 8000ms
publishComplete: 20000ms
```

### 输入延迟
```javascript
titleInput: 50ms/字符 // 模拟真人输入
contentInput: 30ms/字符
keywordInput: 50ms/字符
```

### 重试策略
```javascript
// 多种选择器备用方案
1. CSS选择器（主方案）
2. XPath精确路径（备用方案1）
3. XPath文字匹配（备用方案2）
4. 遍历所有元素查找（最后方案）
```

---

## 错误处理

### 非致命错误（记录警告，继续执行）
- 步骤5：添加话题失败
- 步骤6：添加自主声明失败
- 截图保存失败

### 致命错误（中止流程）
- 步骤1：找不到高清发布按钮
- 步骤1：找不到发布图文按钮
- 步骤3：找不到标题输入框
- 步骤4：找不到描述编辑器
- 步骤7：找不到发布按钮

### 错误恢复
```javascript
// 保存错误截图
errorScreenshot: 'douyin-error.png'

// 等待10秒后关闭浏览器
errorDelay: 10000ms
```

---

## 调试截图

系统会在关键步骤自动保存截图：

1. **首页截图：** `douyin-home-page.png`
2. **菜单弹出：** `douyin-menu-popup.png`
3. **声明侧边栏：** `douyin-declaration-sidebar.png`
4. **发布前状态：** `douyin-before-publish.png`
5. **发布后状态：** `douyin-after-publish.png`
6. **错误状态：** `douyin-error.png`

---

## 完整流程时间估算

```
步骤1：悬停+点击发布图文    ≈ 23秒
步骤2：上传图片              ≈ 10秒
步骤3：填写标题              ≈ 12秒
步骤4：填写描述              ≈ 13秒
步骤5：添加话题              ≈ 9秒
步骤6：添加自主声明          ≈ 15秒
步骤7：点击发布              ≈ 43秒
-----------------------------------
总计：                       ≈ 125秒（约2分钟）
```

---

## 注意事项

1. **Cookie有效性：** 抖音平台需要Cookie登录，Cookie失效会导致登录失败
2. **图片格式：** 支持Markdown格式的图片标记 `![alt](url)`
3. **内容清理：** 自动移除标题重复、Markdown语法、HTML标签
4. **话题推荐：** 使用文章标题作为关键词获取推荐话题
5. **AI声明：** 自动添加"内容由AI生成"声明
6. **发布验证：** 通过URL变化、成功提示、页面状态多重验证

---

## 代码位置

**文件路径：** `server/src/services/adapters/DouyinAdapter.ts`

**主要方法：**
- `performLogin()` - 执行登录
- `performPublish()` - 执行发布（7步流程）
- `verifyPublishSuccess()` - 验证发布成功
