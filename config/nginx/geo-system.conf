# GEOä¼˜åŒ–ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒ Nginx é…ç½®
# 
# ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š
# 1. å¤åˆ¶åˆ°æœåŠ¡å™¨: sudo cp geo-system.conf /etc/nginx/sites-available/
# 2. åˆ›å»ºè½¯é“¾æ¥: sudo ln -s /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/
# 3. ä¿®æ”¹é…ç½®ä¸­çš„åŸŸå/IP
# 4. æµ‹è¯•é…ç½®: sudo nginx -t
# 5. é‡å¯Nginx: sudo systemctl restart nginx
#
# ğŸ“ éƒ¨ç½²ç›®å½•ç»“æ„ï¼š
# /var/www/geo-system/
# â”œâ”€â”€ client/dist/          # å‰ç«¯åº”ç”¨æ„å»ºäº§ç‰©
# â”œâ”€â”€ landing/dist/         # è¥é”€ç½‘ç«™æ„å»ºäº§ç‰©
# â”œâ”€â”€ server/               # åç«¯åº”ç”¨
# â””â”€â”€ server/uploads/       # ä¸Šä¼ æ–‡ä»¶ç›®å½•

# ==================== HTTP é…ç½® ====================
# å¦‚æœä½¿ç”¨HTTPSï¼Œæ­¤éƒ¨åˆ†ä¼šé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name 43.143.163.6;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸåæˆ–IP
    
    # å¦‚æœæœ‰SSLè¯ä¹¦ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œ
    # return 301 https://$server_name$request_uri;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # æ—¥å¿—
    access_log /var/log/nginx/geo-system-access.log;
    error_log /var/log/nginx/geo-system-error.log;
    
    # ==================== åç«¯API ====================
    # ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»æ”¾åœ¨æœ€å‰é¢
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ==================== WebSocket ====================
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketè¶…æ—¶ï¼ˆ24å°æ—¶ï¼‰
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
    
    # ==================== ä¸Šä¼ æ–‡ä»¶ ====================
    location /uploads {
        alias /var/www/geo-system/server/uploads;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # ==================== å‰ç«¯åº”ç”¨ (/appè·¯å¾„) ====================
    location /app {
        alias /var/www/geo-system/client/dist;
        try_files $uri $uri/ /app/index.html;
        
        # å¤„ç†å‰ç«¯è·¯ç”±
        location ~ ^/app/(.*)$ {
            alias /var/www/geo-system/client/dist;
            try_files /$1 /$1/ /app/index.html;
        }
    }
    
    # å‰ç«¯åº”ç”¨é™æ€èµ„æº
    location ~* ^/app/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        alias /var/www/geo-system/client/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ==================== è¥é”€ç½‘ç«™ (æ ¹è·¯å¾„) ====================
    location / {
        root /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /index.html;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ==================== å…¶ä»–é…ç½® ====================
    
    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50M;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/json application/javascript 
               application/xml image/svg+xml;
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        return 404;
    }
}

# ==================== HTTPS é…ç½®ï¼ˆå¯é€‰ï¼‰ ====================
# å¦‚æœæœ‰SSLè¯ä¹¦ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢çš„é…ç½®

# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#     
#     # SSLè¯ä¹¦é…ç½®
#     ssl_certificate /etc/nginx/ssl/your-domain.crt;
#     ssl_certificate_key /etc/nginx/ssl/your-domain.key;
#     
#     # SSLä¼˜åŒ–
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # å…¶ä»–é…ç½®ä¸HTTPç›¸åŒ...
# }
