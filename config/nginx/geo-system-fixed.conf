# GEOä¼˜åŒ–ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒ Nginx é…ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰
# 
# ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š
# 1. å¤åˆ¶åˆ°æœåŠ¡å™¨: sudo cp geo-system.conf /etc/nginx/sites-available/
# 2. åˆ›å»ºè½¯é“¾æ¥: sudo ln -s /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/
# 3. ä¿®æ”¹é…ç½®ä¸­çš„åŸŸå/IP
# 4. æµ‹è¯•é…ç½®: sudo nginx -t
# 5. é‡å¯Nginx: sudo systemctl restart nginx
#
# ğŸ“ éƒ¨ç½²ç›®å½•ç»“æ„ï¼š
# /var/www/geo-system/
# â”œâ”€â”€ client/dist/          # å‰ç«¯åº”ç”¨æ„å»ºäº§ç‰©
# â”œâ”€â”€ landing/dist/         # è¥é”€ç½‘ç«™æ„å»ºäº§ç‰©
# â”œâ”€â”€ server/               # åç«¯åº”ç”¨
# â””â”€â”€ server/uploads/       # ä¸Šä¼ æ–‡ä»¶ç›®å½•

# ==================== HTTP é…ç½® ====================
server {
    listen 80;
    server_name 43.143.163.6;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # æ—¥å¿—
    access_log /var/log/nginx/geo-system-access.log;
    error_log /var/log/nginx/geo-system-error.log;
    
    # ==================== åç«¯API ====================
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ==================== WebSocket ====================
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketè¶…æ—¶ï¼ˆ24å°æ—¶ï¼‰
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
    
    # ==================== ä¸Šä¼ æ–‡ä»¶ ====================
    location /uploads {
        alias /var/www/geo-system/server/uploads;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # ==================== å‰ç«¯åº”ç”¨ (/appè·¯å¾„) ====================
    # ä¿®å¤ï¼šä½¿ç”¨ root è€Œä¸æ˜¯ aliasï¼Œé¿å… 403 é”™è¯¯
    location /app/ {
        alias /var/www/geo-system/client/dist/;
        index index.html;
        try_files $uri $uri/ /app/index.html;
    }
    
    # å‰ç«¯åº”ç”¨çš„ index.htmlï¼ˆå¤„ç† /app å’Œ /app/ çš„æƒ…å†µï¼‰
    location = /app {
        return 301 /app/;
    }
    
    # ==================== è¥é”€ç½‘ç«™ (æ ¹è·¯å¾„) ====================
    location / {
        root /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /index.html;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ==================== å…¶ä»–é…ç½® ====================
    
    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50M;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/json application/javascript 
               application/xml image/svg+xml;
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        return 404;
    }
}
