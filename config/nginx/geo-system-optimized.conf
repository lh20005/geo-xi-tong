# GEOä¼˜åŒ–ç³»ç»Ÿ - é«˜æ€§èƒ½ Nginx é…ç½®
# 
# ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š
# 1. å¤åˆ¶åˆ°æœåŠ¡å™¨: sudo cp geo-system-optimized.conf /etc/nginx/sites-available/geo-system.conf
# 2. åˆ›å»ºè½¯é“¾æ¥: sudo ln -s /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/
# 3. ä¿®æ”¹é…ç½®ä¸­çš„åŸŸå/IP
# 4. æµ‹è¯•é…ç½®: sudo nginx -t
# 5. é‡å¯Nginx: sudo systemctl restart nginx

# ==================== ç¼“å­˜é…ç½® ====================
# é™æ€æ–‡ä»¶ç¼“å­˜è·¯å¾„
proxy_cache_path /var/cache/nginx/geo-system levels=1:2 keys_zone=geo_cache:10m max_size=1g inactive=60m use_temp_path=off;

# ==================== HTTP é…ç½® ====================
server {
    listen 80;
    server_name 43.143.163.6;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # æ—¥å¿—
    access_log /var/log/nginx/geo-system-access.log;
    error_log /var/log/nginx/geo-system-error.log;
    
    # ==================== åç«¯API ====================
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šè¶…æ—¶è®¾ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å†²åŒº
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # ==================== WebSocket ====================
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketè¶…æ—¶ï¼ˆ24å°æ—¶ï¼‰
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
    
    # ==================== ä¸Šä¼ æ–‡ä»¶ ====================
    location /uploads {
        alias /var/www/geo-system/server/uploads;
        
        # âš¡ é•¿æœŸç¼“å­˜
        expires 365d;
        add_header Cache-Control "public, immutable";
        
        # âš¡ å¯ç”¨ sendfileï¼ˆé›¶æ‹·è´ï¼‰
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # âš¡ å¼€å¯ç›®å½•ç´¢å¼•ï¼ˆå¯é€‰ï¼‰
        autoindex off;
    }
    
    # ==================== å‰ç«¯åº”ç”¨ (/appè·¯å¾„) ====================
    location /app/ {
        alias /var/www/geo-system/client/dist/;
        index index.html;
        try_files $uri $uri/ /app/index.html;
        
        # âš¡ å¯ç”¨ sendfile
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # HTML æ–‡ä»¶ä¸ç¼“å­˜
        location ~ \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
        
        # JS/CSS æ–‡ä»¶é•¿æœŸç¼“å­˜
        location ~* \.(js|css)$ {
            expires 365d;
            add_header Cache-Control "public, immutable";
        }
        
        # å›¾ç‰‡å’Œå­—ä½“æ–‡ä»¶
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
            expires 365d;
            add_header Cache-Control "public, immutable";
        }
    }
    
    location = /app {
        return 301 /app/;
    }
    
    # ==================== è¥é”€ç½‘ç«™ (æ ¹è·¯å¾„) ====================
    location / {
        root /var/www/geo-system/landing/dist;
        try_files $uri $uri/ /index.html;
        
        # âš¡ å¯ç”¨ sendfile
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
            expires 365d;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ==================== æ€§èƒ½ä¼˜åŒ–é…ç½® ====================
    
    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 50M;
    
    # âš¡ å®¢æˆ·ç«¯ç¼“å†²åŒºä¼˜åŒ–
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    # âš¡ Gzipå‹ç¼©ï¼ˆé«˜æ€§èƒ½é…ç½®ï¼‰
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 5;  # 5-6 æ˜¯æ€§èƒ½å’Œå‹ç¼©ç‡çš„æœ€ä½³å¹³è¡¡
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/x-javascript 
        application/xml+rss 
        application/json 
        application/javascript 
        application/xml 
        image/svg+xml;
    gzip_disable "msie6";
    
    # âš¡ Brotliå‹ç¼©ï¼ˆå¦‚æœnginxæ”¯æŒï¼‰
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript application/xml image/svg+xml;
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # âš¡ å¼€å¯æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
