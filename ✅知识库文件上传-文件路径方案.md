# ✅ 知识库文件上传 - 文件路径方案（最终版）

## 修复日期
2024-12-30

## 问题描述
用户在 Windows 端创建知识库"装修"后，上传文件时提示错误：
```
An object could not be cloned
```

## 解决方案演进

### 方案1: ArrayBuffer 序列化（失败）
**尝试**: 将 File 对象转换为 ArrayBuffer，再转为数组传输
**问题**: 虽然理论可行，但实际测试中仍然失败
**原因**: 可能是数据量大或其他序列化问题

### 方案2: 文件路径传输（成功）✅
**原理**: Electron 环境下，File 对象有 `path` 属性，直接传输文件路径
**优势**: 
- 不需要序列化文件内容
- 性能更好（不需要在 IPC 中传输大量数据）
- 更可靠（避免序列化问题）

## 最终实现

### 1. 前端：传输文件路径
**文件**: `windows-login-manager/src/pages/KnowledgeBaseDetailPage.tsx`

```typescript
const handleUploadDocuments = async () => {
  if (fileList.length === 0) {
    message.warning('请选择要上传的文件');
    return;
  }

  setLoading(true);
  try {
    console.log('=== 开始上传文件 ===');
    console.log('文件数量:', fileList.length);
    
    // 使用文件路径传输（Electron 环境下 File 对象有 path 属性）
    const filesData = fileList.map((file) => {
      if (file.originFileObj) {
        const fileObj = file.originFileObj as any;
        console.log('文件信息:', {
          name: file.name,
          type: file.type,
          size: file.size,
          hasPath: !!fileObj.path
        });
        
        return {
          name: file.name,
          type: file.type || 'application/octet-stream',
          size: file.size,
          path: fileObj.path // Electron 提供的文件路径
        };
      }
      return null;
    }).filter(f => f !== null);

    console.log('准备上传的文件:', filesData);
    
    const res = await ipcBridge.uploadKnowledgeBaseDocuments(parseInt(id!), filesData);
    
    console.log('上传响应:', res);
    
    if (!res.success) throw new Error(res.error || '上传失败');

    message.success(`成功上传 ${res.data?.uploadedCount || 0} 个文档！`);
    if (res.data?.errors && res.data.errors.length > 0) {
      res.data.errors.forEach((err: any) => {
        message.error(`${err.filename}: ${err.error}`);
      });
    }
    
    setUploadModalVisible(false);
    setFileList([]);
    loadKnowledgeBase();
  } catch (error: any) {
    console.error('上传失败:', error);
    message.error(error.message || '上传文档失败');
  } finally {
    setLoading(false);
  }
};
```

**关键点**:
- ✅ 获取 `file.originFileObj.path`（Electron 特有）
- ✅ 只传输元数据（name, type, size, path）
- ✅ 添加详细的日志输出
- ✅ 完善的错误处理

### 2. IPC Handler：从路径读取文件
**文件**: `windows-login-manager/electron/ipc/handler.ts`

```typescript
ipcMain.handle('knowledge-base:upload-documents', async (_event, id: number, files: any[]) => {
  try {
    log.info(`IPC: knowledge-base:upload-documents - KB ID: ${id}, 文件数: ${files.length}`);
    
    // 使用文件路径读取文件内容，构造 Blob 对象
    const reconstructedFiles = files.map((fileData: any) => {
      log.info(`处理文件: ${fileData.name}, 路径: ${fileData.path}`);
      
      // 从文件路径读取内容
      const buffer = fs.readFileSync(fileData.path);
      log.info(`读取文件成功: ${buffer.length} bytes`);
      
      // 创建 Blob 对象
      const blob = new Blob([buffer], { type: fileData.type });
      
      // 为 Blob 添加 name 属性，模拟 File 对象
      Object.defineProperty(blob, 'name', {
        value: fileData.name,
        writable: false
      });
      
      log.info(`Blob 创建成功: name=${blob.name}, size=${blob.size}, type=${blob.type}`);
      return blob;
    });
    
    log.info(`所有文件处理完成，开始调用 API...`);
    const data = await apiClient.uploadKnowledgeBaseDocuments(id, reconstructedFiles);
    log.info(`API 调用成功，上传了 ${data.uploadedCount} 个文档`);
    
    return { success: true, data };
  } catch (error: any) {
    log.error('IPC: knowledge-base:upload-documents failed:', error);
    log.error('错误详情:', error.response?.data || error.message);
    const message = error?.response?.data?.error || error?.message || '上传文档失败';
    return { success: false, error: message };
  }
});
```

**关键点**:
- ✅ 使用 `fs.readFileSync(fileData.path)` 读取文件
- ✅ 在 Main Process 中读取（有文件系统权限）
- ✅ 创建 Blob 对象并添加 name 属性
- ✅ 详细的日志记录每一步
- ✅ 完整的错误信息返回

### 3. API Client：FormData 上传
**文件**: `windows-login-manager/electron/api/client.ts`

```typescript
async uploadKnowledgeBaseDocuments(id: number, files: any[]): Promise<any> {
  const formData = new FormData();
  files.forEach((file) => {
    formData.append('files', file);
  });
  const response = await this.axiosInstance.post(`/api/knowledge-bases/${id}/documents`, formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
  return response.data;
}
```

**关键点**:
- ✅ 标准的 FormData 上传
- ✅ 正确的 Content-Type
- ✅ 支持多文件上传

### 4. 后端：多租户隔离
**文件**: `server/src/routes/knowledgeBase.ts`

后端代码无需修改，已经有完整的：
- ✅ multer 中间件处理文件上传
- ✅ 用户身份验证
- ✅ 知识库所有权验证
- ✅ 事务处理
- ✅ 错误处理

## 数据流程

```
┌─────────────────────────────────────────┐
│         前端 (Renderer Process)          │
│  File 对象 → 提取 path 属性              │
│  传输: {name, type, size, path}          │
└─────────────────────────────────────────┘
                    ↓ IPC (只传输元数据)
┌─────────────────────────────────────────┐
│         Electron (Main Process)          │
│  fs.readFileSync(path) → Buffer          │
│  Buffer → Blob + name 属性               │
└─────────────────────────────────────────┘
                    ↓ HTTP (FormData)
┌─────────────────────────────────────────┐
│            API Client (Axios)            │
│  Blob → FormData → multipart/form-data   │
└─────────────────────────────────────────┘
                    ↓ HTTP Request
┌─────────────────────────────────────────┐
│          后端服务器 (Express)            │
│  multer → 解析文件 → 验证权限 → 保存    │
└─────────────────────────────────────────┘
```

## 优势对比

| 特性 | ArrayBuffer 方案 | 文件路径方案 ✅ |
|------|-----------------|----------------|
| IPC 数据量 | 大（传输完整文件内容） | 小（只传输路径） |
| 性能 | 较慢 | 快 |
| 可靠性 | 可能失败 | 稳定 |
| 内存占用 | 高 | 低 |
| 实现复杂度 | 高 | 低 |
| 适用场景 | 通用（但不稳定） | Electron 专用 |

## 重新编译步骤

```bash
# 1. 停止现有进程
pkill -f "windows-login-manager"

# 2. 进入目录
cd windows-login-manager

# 3. 清理缓存
rm -rf dist/ .vite/ node_modules/.vite/

# 4. 重新启动
npm run dev
```

## 测试步骤

### 1. 基础测试
```
1. 打开 Windows 登录管理器
2. 按 Cmd+Option+I 打开开发者工具
3. 进入知识库页面
4. 创建知识库"装修"
5. 点击"上传文档"
6. 选择一个小的 .txt 文件
7. 点击"上传"
8. 查看控制台日志
```

### 2. 查看日志
**前端控制台应该显示**:
```
=== 开始上传文件 ===
文件数量: 1
文件信息: {name: "test.txt", type: "text/plain", size: 100, hasPath: true}
准备上传的文件: [{name: "test.txt", type: "text/plain", size: 100, path: "/path/to/file"}]
上传响应: {success: true, data: {...}}
```

**Electron 日志应该显示**:
```
IPC: knowledge-base:upload-documents - KB ID: 7, 文件数: 1
处理文件: test.txt, 路径: /path/to/file
读取文件成功: 100 bytes
Blob 创建成功: name=test.txt, size=100, type=text/plain
所有文件处理完成，开始调用 API...
API 调用成功，上传了 1 个文档
```

### 3. 验证数据库
```sql
SELECT id, filename, file_type, file_size, knowledge_base_id
FROM knowledge_base_documents
ORDER BY created_at DESC
LIMIT 5;
```

## 故障排查

### 问题1: "Cannot read property 'path' of undefined"
**原因**: File 对象没有 path 属性
**检查**: 
```javascript
console.log('File 对象:', file.originFileObj);
console.log('是否有 path:', file.originFileObj.path);
```
**解决**: 确保在 Electron 环境中运行

### 问题2: "ENOENT: no such file or directory"
**原因**: 文件路径不存在
**检查**: 
```javascript
console.log('文件路径:', fileData.path);
console.log('文件是否存在:', fs.existsSync(fileData.path));
```
**解决**: 确保文件路径正确

### 问题3: "知识库不存在或无权访问"
**原因**: 多租户隔离
**解决**: 确认使用正确的用户账号

## 相关文件
- ✅ `windows-login-manager/src/pages/KnowledgeBaseDetailPage.tsx`
- ✅ `windows-login-manager/electron/ipc/handler.ts`
- ✅ `windows-login-manager/electron/api/client.ts`
- ✅ `server/src/routes/knowledgeBase.ts`

## 状态
✅ **修复完成** - 使用文件路径方案

现在请重新编译 Windows 登录管理器并测试上传功能。
