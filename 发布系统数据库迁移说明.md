# 发布系统数据库迁移说明

## 问题描述

创建发布任务时出现 400 错误，原因是数据库中缺少发布系统相关的表。

## 解决方案

需要运行数据库迁移，创建以下表：

1. **platform_accounts** - 平台账号表
2. **publishing_tasks** - 发布任务表
3. **publishing_logs** - 发布日志表
4. **platforms_config** - 平台配置表

## 运行迁移

### 方法1：使用脚本（推荐）

```bash
./run-publishing-migration.sh
```

### 方法2：手动运行

```bash
# 确保已配置 DATABASE_URL 环境变量
source .env

# 运行迁移SQL
psql "$DATABASE_URL" -f server/src/db/migrations/006_add_publishing_system.sql
```

## 迁移内容

### 1. platform_accounts 表

存储平台账号信息和加密的登录凭证。

```sql
CREATE TABLE platform_accounts (
  id SERIAL PRIMARY KEY,
  platform VARCHAR(50) NOT NULL,
  platform_id VARCHAR(50) NOT NULL,
  account_name VARCHAR(100) NOT NULL,
  credentials TEXT NOT NULL,  -- 加密存储
  status VARCHAR(20) DEFAULT 'active',
  is_default BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_used_at TIMESTAMP
);
```

### 2. publishing_tasks 表

存储发布任务信息。

```sql
CREATE TABLE publishing_tasks (
  id SERIAL PRIMARY KEY,
  article_id INTEGER NOT NULL,
  account_id INTEGER NOT NULL,
  platform_id VARCHAR(50) NOT NULL,
  status VARCHAR(20) DEFAULT 'pending',
  config TEXT NOT NULL,
  scheduled_at TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. publishing_logs 表

存储发布任务的执行日志。

```sql
CREATE TABLE publishing_logs (
  id SERIAL PRIMARY KEY,
  task_id INTEGER NOT NULL,
  level VARCHAR(20) NOT NULL,
  message TEXT NOT NULL,
  details TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4. platforms_config 表

存储平台配置信息。

```sql
CREATE TABLE platforms_config (
  id SERIAL PRIMARY KEY,
  platform_id VARCHAR(50) UNIQUE NOT NULL,
  platform_name VARCHAR(100) NOT NULL,
  icon_url VARCHAR(255) NOT NULL,
  is_enabled BOOLEAN DEFAULT TRUE,
  adapter_class VARCHAR(100) NOT NULL,
  required_fields TEXT NOT NULL,
  config_schema TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 初始数据

迁移会自动插入12个平台的配置数据：

- 网易号 (wangyi)
- 搜狐号 (souhu)
- 百家号 (baijiahao)
- 头条号 (toutiao)
- 企鹅号 (qie)
- 微信公众号 (wechat)
- 小红书 (xiaohongshu)
- 抖音号 (douyin)
- 哔哩哔哩 (bilibili)
- 知乎 (zhihu)
- 简书 (jianshu)
- CSDN (csdn)

## 验证迁移

运行迁移后，可以通过以下SQL验证：

```sql
-- 检查表是否创建成功
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('platform_accounts', 'publishing_tasks', 'publishing_logs', 'platforms_config');

-- 检查平台配置数据
SELECT platform_id, platform_name FROM platforms_config;
```

应该看到4个表和12条平台配置记录。

## 故障排查

### 问题1：psql 命令未找到

**解决方案**：
```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# CentOS/RHEL
sudo yum install postgresql
```

### 问题2：数据库连接失败

**检查**：
1. DATABASE_URL 是否正确配置
2. 数据库服务是否运行
3. 网络连接是否正常

### 问题3：权限不足

**解决方案**：
确保数据库用户有 CREATE TABLE 权限：

```sql
GRANT CREATE ON SCHEMA public TO your_user;
```

### 问题4：表已存在

如果表已存在，迁移会跳过创建（使用 IF NOT EXISTS）。

如果需要重新创建，先删除表：

```sql
DROP TABLE IF EXISTS publishing_logs CASCADE;
DROP TABLE IF EXISTS publishing_tasks CASCADE;
DROP TABLE IF EXISTS platform_accounts CASCADE;
DROP TABLE IF EXISTS platforms_config CASCADE;
```

然后重新运行迁移。

## 下一步

迁移完成后：

1. 重启服务器：`npm run dev`
2. 测试创建发布任务功能
3. 在"平台登录"页面绑定账号
4. 在"文章管理"页面发布文章

## 相关文件

- 迁移文件：`server/src/db/migrations/006_add_publishing_system.sql`
- 运行脚本：`run-publishing-migration.sh`
- 后端路由：`server/src/routes/publishingTasks.ts`
- 服务类：`server/src/services/PublishingService.ts`

---

**注意**：运行迁移前请备份数据库！
