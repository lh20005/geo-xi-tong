# 存储空间配额修复完成

## 问题描述

用户反馈：给 testuser2 设置存储空间为 30MB，但用户中心仍显示 1GB。

## 根本原因

1. **数据库单位变更**：存储空间配额从 bytes 改为 MB 单位（迁移 020）
2. **函数未更新**：`get_user_storage_quota` 函数直接返回 `feature_value`，没有处理单位转换
3. **配额不同步**：`user_storage_usage` 表中的 `storage_quota_bytes` 字段未同步更新

### 具体问题

- `plan_features` 表中 `storage_space` 的 `feature_value` = 30，`feature_unit` = 'MB'
- `get_user_storage_quota` 函数返回 30 bytes（错误！）
- `user_storage_usage` 表中保存着旧的 1024 MB 值

## 修复方案

### 1. 更新 `get_user_storage_quota` 函数

修改函数以正确处理 MB/GB/bytes 单位：

```sql
CREATE OR REPLACE FUNCTION get_user_storage_quota(p_user_id INTEGER)
RETURNS BIGINT AS $$
DECLARE
  v_plan_id INTEGER;
  v_quota_value BIGINT;
  v_quota_unit VARCHAR(20);
  v_quota_bytes BIGINT;
  v_user_role VARCHAR(50);
BEGIN
  -- 检查用户角色
  SELECT role INTO v_user_role FROM users WHERE id = p_user_id;
  
  -- 管理员获得 1GB 存储
  IF v_user_role = 'admin' THEN
    RETURN 1073741824; -- 1GB in bytes
  END IF;
  
  -- 获取用户当前订阅的套餐
  SELECT us.plan_id INTO v_plan_id
  FROM user_subscriptions us
  WHERE us.user_id = p_user_id 
    AND us.status = 'active'
    AND us.end_date > CURRENT_TIMESTAMP
  ORDER BY us.end_date DESC
  LIMIT 1;
  
  -- 如果没有订阅，返回默认 10MB
  IF v_plan_id IS NULL THEN
    RETURN 10485760; -- 10MB in bytes
  END IF;
  
  -- 获取套餐的存储配额（值和单位）
  SELECT pf.feature_value, pf.feature_unit 
  INTO v_quota_value, v_quota_unit
  FROM plan_features pf
  WHERE pf.plan_id = v_plan_id AND pf.feature_code = 'storage_space';
  
  -- 如果套餐没有定义存储配额，返回默认 10MB
  IF v_quota_value IS NULL THEN
    RETURN 10485760;
  END IF;
  
  -- 无限制配额
  IF v_quota_value = -1 THEN
    RETURN -1;
  END IF;
  
  -- 根据单位转换为字节
  IF v_quota_unit = 'MB' THEN
    v_quota_bytes := v_quota_value * 1024 * 1024;
  ELSIF v_quota_unit = 'GB' THEN
    v_quota_bytes := v_quota_value * 1024 * 1024 * 1024;
  ELSIF v_quota_unit = 'bytes' THEN
    v_quota_bytes := v_quota_value;
  ELSE
    -- 默认假设是 MB
    v_quota_bytes := v_quota_value * 1024 * 1024;
  END IF;
  
  RETURN v_quota_bytes;
END;
$$ LANGUAGE plpgsql;
```

### 2. 同步所有用户的存储配额

```sql
UPDATE user_storage_usage
SET storage_quota_bytes = get_user_storage_quota(user_id),
    last_updated_at = CURRENT_TIMESTAMP
WHERE user_id IN (SELECT id FROM users);
```

## 修复结果

### testuser2 验证

```
✅ testuser2 配额信息:
   套餐: 专业版
   套餐配置: 30 MB
   实际配额: 30.00 MB
   函数计算: 30.00 MB
   已使用: 1.31 MB
   状态: ✅ 同步正常
```

### 配额检查测试

```
上传 1MB 文件的配额检查:
   是否允许: ✅ 是
   当前使用: 1.31 MB
   配额限制: 30.00 MB
   可用空间: 28.69 MB
   使用率: 4.37%
```

## 特殊说明

### 管理员用户

- **lzc2005** 是管理员用户（role = 'admin'）
- 管理员配额固定为 **1GB**，不受套餐限制
- 这是设计行为，确保管理员有足够空间进行测试和管理

### 无订阅用户

- 没有激活订阅的用户默认获得 **10MB** 存储空间

## 执行的脚本

1. **诊断脚本**：`server/src/scripts/diagnose-storage-quota-adjustment.ts`
2. **修复脚本**：`server/src/scripts/fix-storage-quota-sync.ts`
3. **验证脚本**：`server/src/scripts/verify-storage-quota-fix.ts`
4. **同步脚本**：`server/src/scripts/sync-all-storage-quotas.ts`

## 影响范围

- ✅ 所有用户的存储配额已同步
- ✅ testuser2 配额正确显示为 30 MB
- ✅ 配额检查函数工作正常
- ✅ 上传功能配额验证正常

## 后续建议

1. **清除前端缓存**：建议用户刷新浏览器缓存（Ctrl+Shift+R 或 Cmd+Shift+R）
2. **清除 Redis 缓存**：如果问题仍存在，清除相关 Redis 缓存键
3. **监控配额同步**：确保后续套餐变更时配额能正确同步

## 测试命令

```bash
# 验证修复
npx ts-node server/src/scripts/verify-storage-quota-fix.ts

# 同步所有用户配额
npx ts-node server/src/scripts/sync-all-storage-quotas.ts
```

---

**修复时间**：2026-01-05  
**修复状态**：✅ 完成  
**影响用户**：所有用户  
**核心问题**：单位转换逻辑缺失  
**解决方案**：更新数据库函数 + 同步配额数据
