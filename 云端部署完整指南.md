# 云端自动发布部署完整指南

## 需求确认

**目标**: 用户只需浏览器访问，创建任务后自动在云端执行发布，无需用户在线。

**架构**: 服务器端自动化（Puppeteer在云端运行）

---

## 云端服务器配置要求

### 最低配置（单用户/测试）

```
CPU: 2核
内存: 4GB
硬盘: 40GB SSD
带宽: 5Mbps
系统: Ubuntu 20.04/22.04 LTS
```

**月费用**: 约 $10-20（阿里云、腾讯云轻量服务器）

### 推荐配置（多用户/生产）

```
CPU: 4核
内存: 8GB
硬盘: 80GB SSD
带宽: 10Mbps
系统: Ubuntu 22.04 LTS
```

**月费用**: 约 $30-50

### 为什么需要这些配置？

1. **内存 4GB+**: 
   - Chrome浏览器每个实例占用 300-500MB
   - 同时运行3-5个任务需要 2-3GB
   - 系统和Node.js需要 1-2GB

2. **CPU 2核+**:
   - 浏览器渲染需要CPU
   - 多任务并发执行

3. **硬盘 40GB+**:
   - 系统: 10GB
   - Chrome和依赖: 5GB
   - Node.js和项目: 5GB
   - 数据库和日志: 10GB
   - 预留空间: 10GB

---

## 云端部署步骤

### 1. 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git build-essential
```

### 2. 安装Node.js

```bash
# 安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version  # 应该显示 v18.x.x
npm --version
```

### 3. 安装PostgreSQL

```bash
# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库
sudo -u postgres psql
CREATE DATABASE geo_system;
CREATE USER your_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE geo_system TO your_user;
\q
```

### 4. 安装Chrome和依赖（关键步骤）

```bash
# 安装Chrome依赖
sudo apt install -y \
  ca-certificates \
  fonts-liberation \
  libappindicator3-1 \
  libasound2 \
  libatk-bridge2.0-0 \
  libatk1.0-0 \
  libc6 \
  libcairo2 \
  libcups2 \
  libdbus-1-3 \
  libexpat1 \
  libfontconfig1 \
  libgbm1 \
  libgcc1 \
  libglib2.0-0 \
  libgtk-3-0 \
  libnspr4 \
  libnss3 \
  libpango-1.0-0 \
  libpangocairo-1.0-0 \
  libstdc++6 \
  libx11-6 \
  libx11-xcb1 \
  libxcb1 \
  libxcomposite1 \
  libxcursor1 \
  libxdamage1 \
  libxext6 \
  libxfixes3 \
  libxi6 \
  libxrandr2 \
  libxrender1 \
  libxss1 \
  libxtst6 \
  lsb-release \
  wget \
  xdg-utils

# 下载并安装Chrome
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo apt install -y ./google-chrome-stable_current_amd64.deb

# 验证安装
google-chrome --version
```

### 5. 安装中文字体（可选，支持中文显示）

```bash
sudo apt install -y fonts-wqy-zenhei fonts-wqy-microhei
```

### 6. 部署项目

```bash
# 克隆项目
cd /var/www
sudo git clone your-repo-url geo-system
cd geo-system

# 安装依赖
cd server
npm install

cd ../client
npm install
npm run build

# 配置环境变量
cd ../server
cp .env.example .env
nano .env
```

**编辑 .env 文件**:
```env
DATABASE_URL=postgresql://your_user:your_password@localhost:5432/geo_system
PORT=3000
NODE_ENV=production
JWT_SECRET=your_random_secret_key_here
DEEPSEEK_API_KEY=your_api_key
GEMINI_API_KEY=your_api_key
```

### 7. 运行数据库迁移

```bash
cd /var/www/geo-system/server
npm run db:migrate
npm run db:migrate:publishing
```

### 8. 配置Nginx（反向代理）

```bash
# 安装Nginx
sudo apt install -y nginx

# 创建配置文件
sudo nano /etc/nginx/sites-available/geo-system
```

**Nginx配置**:
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /var/www/geo-system/client/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 上传文件
    location /uploads {
        proxy_pass http://localhost:3000;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/geo-system /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 9. 配置PM2（进程管理）

```bash
# 安装PM2
sudo npm install -g pm2

# 启动应用
cd /var/www/geo-system/server
pm2 start src/index.ts --name geo-server --interpreter tsx

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status
pm2 logs geo-server
```

### 10. 配置SSL证书（可选但推荐）

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 关键修改：无头模式

由于在云端运行，需要改回无头模式：

<function_calls>
<invoke name="readFile">
<parameter name="path">server/src/services/PublishingExecutor.ts


**修改 `server/src/services/PublishingExecutor.ts`**:

```typescript
// 云端部署必须使用无头模式
await browserAutomationService.launchBrowser({ 
  headless: true  // 改回 true
});
```

或者更好的方式，使用环境变量控制：

```typescript
// 根据环境自动选择
await browserAutomationService.launchBrowser({ 
  headless: process.env.NODE_ENV === 'production'
});
```

---

## 性能优化建议

### 1. 限制并发任务数

```typescript
// server/src/services/PublishingExecutor.ts
class PublishingExecutor {
  private maxConcurrent = 3; // 最多同时3个任务
  private runningTasks = 0;

  async executeTask(taskId: number) {
    // 等待空闲
    while (this.runningTasks >= this.maxConcurrent) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    this.runningTasks++;
    try {
      // 执行任务...
    } finally {
      this.runningTasks--;
    }
  }
}
```

### 2. 浏览器实例复用

```typescript
// 不要每次都启动新浏览器
// 使用浏览器池
class BrowserPool {
  private browsers: Browser[] = [];
  private maxBrowsers = 3;

  async getBrowser(): Promise<Browser> {
    if (this.browsers.length < this.maxBrowsers) {
      const browser = await puppeteer.launch({
        headless: true,
        executablePath: '/usr/bin/google-chrome'
      });
      this.browsers.push(browser);
      return browser;
    }
    return this.browsers[0]; // 复用现有浏览器
  }
}
```

### 3. 设置超时时间

```typescript
// 防止任务卡死
page.setDefaultTimeout(60000); // 60秒超时
page.setDefaultNavigationTimeout(60000);
```

---

## 监控和维护

### 1. 日志管理

```bash
# PM2日志
pm2 logs geo-server --lines 100

# 系统日志
sudo journalctl -u nginx -f

# 清理旧日志
pm2 flush
```

### 2. 资源监控

```bash
# 安装监控工具
sudo apt install -y htop

# 查看资源使用
htop

# PM2监控
pm2 monit
```

### 3. 定期备份

```bash
# 备份数据库
pg_dump geo_system > backup_$(date +%Y%m%d).sql

# 备份上传文件
tar -czf uploads_backup.tar.gz /var/www/geo-system/server/uploads
```

---

## 成本估算

### 阿里云轻量服务器（推荐）

| 配置 | 价格 | 适用场景 |
|------|------|---------|
| 2核4GB | ¥68/月 | 个人使用，日发布<50篇 |
| 4核8GB | ¥198/月 | 小团队，日发布<200篇 |
| 8核16GB | ¥398/月 | 大团队，日发布<1000篇 |

### 其他成本

- **域名**: ¥50-100/年
- **SSL证书**: 免费（Let's Encrypt）
- **CDN**: 可选，¥0-100/月
- **备份存储**: ¥10-50/月

**总计**: 最低约 ¥80/月 起

---

## 常见问题

### Q1: Chrome启动失败

**错误**: `Error: Failed to launch chrome!`

**解决**:
```bash
# 检查Chrome是否安装
google-chrome --version

# 检查依赖
ldd /usr/bin/google-chrome | grep "not found"

# 重新安装依赖
sudo apt install -y --reinstall $(dpkg -l | grep chrome | awk '{print $2}')
```

### Q2: 内存不足

**错误**: 任务执行缓慢或失败

**解决**:
```bash
# 1. 增加swap空间
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 2. 限制并发任务数（代码中设置）
maxConcurrent = 2

# 3. 升级服务器配置
```

### Q3: 字体显示问题

**错误**: 截图中中文显示为方块

**解决**:
```bash
# 安装中文字体
sudo apt install -y fonts-wqy-zenhei fonts-wqy-microhei
fc-cache -fv
```

### Q4: 端口被占用

**错误**: `Error: listen EADDRINUSE: address already in use :::3000`

**解决**:
```bash
# 查找占用端口的进程
sudo lsof -i :3000

# 杀死进程
sudo kill -9 <PID>

# 或者修改端口
# 在.env中设置 PORT=3001
```

---

## 安全建议

### 1. 防火墙配置

```bash
# 安装UFW
sudo apt install -y ufw

# 配置规则
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# 查看状态
sudo ufw status
```

### 2. 定期更新

```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# Node.js包更新
cd /var/www/geo-system/server
npm update

# 重启服务
pm2 restart geo-server
```

### 3. 数据库安全

```bash
# 修改PostgreSQL密码
sudo -u postgres psql
ALTER USER your_user WITH PASSWORD 'new_strong_password';

# 限制远程访问
sudo nano /etc/postgresql/*/main/pg_hba.conf
# 确保只允许本地连接
```

---

## 部署检查清单

部署前检查：

- [ ] 服务器配置满足要求（2核4GB+）
- [ ] 已安装Node.js 18+
- [ ] 已安装PostgreSQL
- [ ] 已安装Chrome和所有依赖
- [ ] 已配置.env文件
- [ ] 已运行数据库迁移
- [ ] 已配置Nginx
- [ ] 已配置PM2
- [ ] 已配置SSL证书（可选）
- [ ] 已配置防火墙
- [ ] 已设置定期备份

部署后测试：

- [ ] 访问前端页面正常
- [ ] API接口响应正常
- [ ] 可以创建发布任务
- [ ] 任务可以正常执行
- [ ] 浏览器自动化正常工作
- [ ] 日志记录正常
- [ ] 定时任务正常运行

---

## 快速部署脚本

创建一键部署脚本 `deploy.sh`:

```bash
#!/bin/bash

echo "开始部署GEO系统..."

# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 3. 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 4. 安装Chrome依赖
sudo apt install -y \
  ca-certificates fonts-liberation libappindicator3-1 \
  libasound2 libatk-bridge2.0-0 libatk1.0-0 libcups2 \
  libdbus-1-3 libgbm1 libgtk-3-0 libnspr4 libnss3 \
  libxcomposite1 libxdamage1 libxrandr2 xdg-utils

# 5. 安装Chrome
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo apt install -y ./google-chrome-stable_current_amd64.deb
rm google-chrome-stable_current_amd64.deb

# 6. 安装Nginx
sudo apt install -y nginx

# 7. 安装PM2
sudo npm install -g pm2

echo "✅ 基础环境安装完成！"
echo "请继续手动配置数据库、项目和Nginx"
```

使用方法：
```bash
chmod +x deploy.sh
sudo ./deploy.sh
```

---

## 总结

### 配置要求总结

**最低配置**: 2核4GB，月费约¥68
**推荐配置**: 4核8GB，月费约¥198

### 关键点

1. ✅ 必须安装Chrome和完整依赖
2. ✅ 必须使用无头模式（headless: true）
3. ✅ 需要配置进程管理（PM2）
4. ✅ 需要配置反向代理（Nginx）
5. ✅ 建议配置SSL证书

### 优势

- ✅ 用户只需浏览器访问
- ✅ 支持定时自动发布
- ✅ 无需用户在线
- ✅ 集中管理维护

### 劣势

- ❌ 服务器配置要求较高
- ❌ 用户看不到发布过程
- ❌ 难以处理验证码
- ❌ 可能被平台识别为机器人

### 适用场景

- 完全自动化的发布流程
- 不需要人工干预
- 有一定技术能力维护服务器
- 预算充足（月费¥100+）
