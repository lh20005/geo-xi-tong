# 抖音登录问题修复说明

## 问题描述
Cookie登录验证失败，原因是登录验证选择器不正确。

## 已修复内容

### 1. 更新登录验证选择器
**旧选择器**：`.user-info`（不存在）
**新选择器**：`#douyin-creator-master-side-upload-wrap`（高清发布按钮）

这是抖音创作者中心的标志性元素，登录成功后一定会出现。

### 2. 优化登录流程
```typescript
async performLogin(page, credentials) {
  // 1. 访问登录页面
  await page.goto('https://creator.douyin.com/');
  
  // 2. 设置Cookie
  await this.loginWithCookies(page, credentials.cookies);
  
  // 3. 跳转到创作者中心首页
  await page.goto('https://creator.douyin.com/creator-micro/home');
  
  // 4. 验证登录：检查高清发布按钮
  await page.waitForSelector('#douyin-creator-master-side-upload-wrap');
  
  // 5. 登录成功
  return true;
}
```

### 3. 移除表单登录
抖音平台通常需要扫码或验证码，表单登录不可靠，因此只保留Cookie登录方式。

## 如何使用

### 步骤1：获取Cookie
1. 打开前端页面
2. 进入"平台登录"页面
3. 选择"抖音号"
4. 在弹出的浏览器窗口中完成登录（扫码或其他方式）
5. 系统会自动保存Cookie

### 步骤2：创建发布任务
1. 进入"发布任务"页面
2. 选择要发布的文章
3. 选择"抖音号"平台
4. 点击"创建任务"

### 步骤3：执行任务
1. 任务会自动使用保存的Cookie登录
2. 验证登录成功后，开始7步发布流程
3. 等待发布完成

## 验证方法

### 检查Cookie是否有效
```bash
# 查看数据库中的Cookie
sqlite3 server/database.sqlite "SELECT platform_id, username, LENGTH(cookies) as cookie_length FROM platform_credentials WHERE platform_id='douyin';"
```

### 查看登录日志
```bash
# 查看服务器日志
tail -f server/logs/app.log | grep "抖音号"
```

应该看到：
```
[抖音号] 使用Cookie登录
[Cookie登录] 开始设置 XX 个Cookie
[Cookie登录] Cookie设置成功
[抖音号] Cookie设置成功，验证登录状态...
✅ 抖音号Cookie登录成功
```

## 常见问题

### Q1: Cookie登录失败怎么办？
**A**: Cookie可能已过期，需要重新登录：
1. 进入"平台登录"页面
2. 重新登录抖音号
3. 系统会更新Cookie

### Q2: 找不到高清发布按钮？
**A**: 可能的原因：
1. Cookie已失效 → 重新登录
2. 页面加载太慢 → 增加等待时间
3. 抖音页面结构变化 → 需要更新选择器

### Q3: 如何确认登录成功？
**A**: 登录成功的标志：
1. 日志显示"✅ 抖音号Cookie登录成功"
2. 能找到高清发布按钮
3. 可以开始发布流程

## 技术细节

### 登录验证逻辑
```typescript
// 检查高清发布按钮是否存在
const uploadButton = await page.$('#douyin-creator-master-side-upload-wrap');
if (uploadButton) {
  console.log('✅ 登录成功');
  return true;
} else {
  console.log('❌ 登录失败');
  return false;
}
```

### Cookie有效期
- 抖音Cookie通常有效期为7-30天
- 建议每周重新登录一次
- 如果长时间不使用，Cookie可能失效

### 安全性
- Cookie存储在数据库中，已加密
- 只在服务器端使用，不会暴露给前端
- 每次登录都会更新Cookie

## 更新日期
2024-12-17

## 相关文件
- `server/src/services/adapters/DouyinAdapter.ts` - 抖音适配器
- `server/src/services/adapters/PlatformAdapter.ts` - 基础适配器
- `抖音自动发布全流程说明.md` - 发布流程说明
