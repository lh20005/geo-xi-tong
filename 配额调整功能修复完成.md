# 配额调整功能修复完成

## 问题描述

管理员在订阅管理中调整 testuser2 的存储空间配额为 35MB，但用户中心仍显示 30MB（套餐默认值）。

## 根本原因

配额调整功能存在两个关键问题：

### 1. 缺少同步机制

`UserSubscriptionManagementService.adjustQuota()` 方法只更新了 `user_subscriptions.custom_quotas` 字段，但没有同步更新 `user_storage_usage.storage_quota_bytes` 字段。

**问题代码位置**：`server/src/services/UserSubscriptionManagementService.ts`

```typescript
// 只更新了 custom_quotas
await client.query(
  'UPDATE user_subscriptions SET custom_quotas = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',
  [JSON.stringify(customQuotas), subscription.id]
);
// ❌ 没有同步 user_storage_usage 表
```

### 2. 函数未读取自定义配额

`get_user_storage_quota()` 函数只从 `plan_features` 表读取配额，完全忽略了 `user_subscriptions.custom_quotas` 字段。

**问题代码位置**：`server/src/db/migrations/017_add_storage_management.sql`

```sql
-- 只查询套餐默认配额
SELECT pf.feature_value INTO v_quota_bytes
FROM plan_features pf
WHERE pf.plan_id = v_plan_id AND pf.feature_code = 'storage_space';
-- ❌ 没有检查 custom_quotas
```

## 修复方案

### 修复 1: 创建自动同步触发器（迁移 028）

创建数据库触发器，当 `user_subscriptions.custom_quotas` 更新时，自动同步 `user_storage_usage.storage_quota_bytes`。

**文件**：`server/src/db/migrations/028_add_custom_quota_sync_trigger.sql`

**核心逻辑**：

```sql
CREATE OR REPLACE FUNCTION sync_storage_quota_on_custom_quota_change()
RETURNS TRIGGER AS $$
DECLARE
  v_storage_quota_mb INTEGER;
  v_storage_quota_bytes BIGINT;
BEGIN
  -- 检查是否有 storage_space 的自定义配额
  IF NEW.custom_quotas IS NOT NULL AND NEW.custom_quotas ? 'storage_space' THEN
    v_storage_quota_mb := (NEW.custom_quotas->>'storage_space')::INTEGER;
    
    -- 转换为字节
    IF v_storage_quota_mb = -1 THEN
      v_storage_quota_bytes := -1;
    ELSE
      v_storage_quota_bytes := v_storage_quota_mb::BIGINT * 1024 * 1024;
    END IF;
    
    -- 更新 user_storage_usage 表
    UPDATE user_storage_usage
    SET storage_quota_bytes = v_storage_quota_bytes,
        last_updated_at = CURRENT_TIMESTAMP
    WHERE user_id = NEW.user_id;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_sync_storage_quota
  AFTER INSERT OR UPDATE OF custom_quotas
  ON user_subscriptions
  FOR EACH ROW
  WHEN (NEW.status = 'active' AND NEW.end_date > CURRENT_TIMESTAMP)
  EXECUTE FUNCTION sync_storage_quota_on_custom_quota_change();
```

### 修复 2: 更新配额查询函数（迁移 029）

修改 `get_user_storage_quota()` 函数，优先使用 `custom_quotas`，如果没有则使用套餐默认配额。

**文件**：`server/src/db/migrations/029_update_get_user_storage_quota_for_custom.sql`

**核心逻辑**：

```sql
CREATE OR REPLACE FUNCTION get_user_storage_quota(p_user_id INTEGER)
RETURNS BIGINT AS $$
DECLARE
  v_custom_quotas JSONB;
  v_custom_quota_mb INTEGER;
  -- ... 其他变量
BEGIN
  -- 获取订阅和自定义配额
  SELECT us.id, us.plan_id, us.custom_quotas
  INTO v_subscription_id, v_plan_id, v_custom_quotas
  FROM user_subscriptions us
  WHERE us.user_id = p_user_id 
    AND us.status = 'active'
    AND us.end_date > CURRENT_TIMESTAMP;
  
  -- 优先检查自定义配额
  IF v_custom_quotas IS NOT NULL AND v_custom_quotas ? 'storage_space' THEN
    v_custom_quota_mb := (v_custom_quotas->>'storage_space')::INTEGER;
    RETURN v_custom_quota_mb::BIGINT * 1024 * 1024;
  END IF;
  
  -- 否则使用套餐默认配额
  SELECT pf.feature_value, pf.feature_unit 
  INTO v_quota_value, v_quota_unit
  FROM plan_features pf
  WHERE pf.plan_id = v_plan_id AND pf.feature_code = 'storage_space';
  
  -- 转换并返回
  RETURN v_quota_bytes;
END;
$$ LANGUAGE plpgsql;
```

## 修复结果

### 测试场景 1: 调整配额为 35 MB

```
调整前:
  套餐配置: 30 MB
  自定义配额: null
  实际配额: 30.00 MB
  函数计算: 30.00 MB

调整后:
  套餐配置: 30 MB
  自定义配额: {"storage_space":35}
  实际配额: 35.00 MB  ✅
  函数计算: 35.00 MB  ✅
```

### 测试场景 2: 配额检查

```
上传 1MB 文件的配额检查:
  是否允许: ✅ 是
  当前使用: 1.31 MB
  配额限制: 35.00 MB  ✅
  可用空间: 33.69 MB
```

### 测试场景 3: 恢复默认配额

```
清除自定义配额后:
  自定义配额: null
  实际配额: 30.00 MB  ✅
  应该恢复为: 30 MB
  状态: ✅ 成功恢复
```

## 功能验证

✅ **调整配额同步**：管理员调整 `custom_quotas` 时，自动同步到 `user_storage_usage`  
✅ **配额查询正确**：`get_user_storage_quota()` 函数优先使用自定义配额  
✅ **配额检查正确**：`check_storage_quota()` 函数使用正确的配额限制  
✅ **恢复默认配额**：清除自定义配额时，自动恢复为套餐默认值  
✅ **前端显示正确**：用户中心显示调整后的配额值  

## 数据流程

### 配额调整流程

```
管理员调整配额
    ↓
更新 user_subscriptions.custom_quotas
    ↓
触发器 trigger_sync_storage_quota 自动执行
    ↓
同步更新 user_storage_usage.storage_quota_bytes
    ↓
WebSocket 通知用户
    ↓
前端刷新显示新配额
```

### 配额查询流程

```
调用 get_user_storage_quota(user_id)
    ↓
检查 user_subscriptions.custom_quotas
    ↓
有自定义配额？
    ├─ 是 → 返回自定义配额（MB 转 bytes）
    └─ 否 → 查询 plan_features 返回套餐默认配额
```

## 执行的迁移

1. **迁移 028**：`028_add_custom_quota_sync_trigger.sql`
   - 创建触发器函数 `sync_storage_quota_on_custom_quota_change()`
   - 创建触发器 `trigger_sync_storage_quota`
   - 同步现有的自定义配额

2. **迁移 029**：`029_update_get_user_storage_quota_for_custom.sql`
   - 更新函数 `get_user_storage_quota()`
   - 支持优先读取自定义配额

## 测试脚本

- **诊断脚本**：`server/src/scripts/diagnose-storage-quota-adjustment.ts`
- **测试脚本**：`server/src/scripts/test-quota-adjustment-with-trigger.ts`
- **验证脚本**：`server/src/scripts/verify-storage-quota-fix.ts`

## 影响范围

- ✅ 所有用户的配额调整功能
- ✅ 管理员订阅管理界面
- ✅ 用户中心配额显示
- ✅ 存储空间上传检查
- ✅ 配额预警系统

## 后续建议

1. **清除缓存**：建议用户刷新浏览器（Ctrl+Shift+R）
2. **监控日志**：观察触发器执行日志，确保同步正常
3. **测试其他配额**：验证其他功能配额（文章数、平台账号数等）的调整是否也需要类似机制

## 相关文件

### 数据库迁移
- `server/src/db/migrations/028_add_custom_quota_sync_trigger.sql`
- `server/src/db/migrations/029_update_get_user_storage_quota_for_custom.sql`
- `server/src/db/run-migration-028.ts`
- `server/src/db/run-migration-029.ts`

### 服务代码
- `server/src/services/UserSubscriptionManagementService.ts`（无需修改，触发器自动处理）

### 测试脚本
- `server/src/scripts/diagnose-storage-quota-adjustment.ts`
- `server/src/scripts/test-quota-adjustment-with-trigger.ts`
- `server/src/scripts/verify-storage-quota-fix.ts`

---

**修复时间**：2026-01-05  
**修复状态**：✅ 完成  
**影响用户**：所有用户  
**核心问题**：配额调整未同步 + 函数未读取自定义配额  
**解决方案**：数据库触发器 + 函数逻辑更新
