# 问题修复指南

## 问题总结

您遇到了两个问题：
1. **关键词蒸馏页面显示空白**
2. **文章生成只使用一个蒸馏结果，无法均衡使用**

## 重要说明

**代码逻辑是正确的！** 均衡选择算法已经实现并且正常工作。问题可能是：

1. 数据库中只有一个蒸馏结果
2. 服务器未启动或API无法访问
3. 浏览器缓存问题

---

## 立即修复步骤

### 步骤1: 启动服务器

```bash
# 1. 启动后端服务器
cd server
npm run dev

# 2. 在新终端启动前端
cd client
npm run dev
```

### 步骤2: 检查API是否正常

打开浏览器访问：
- http://localhost:3000/api/distillation/history
- 应该看到JSON数据（可能是空数组`{"data": []}`，这是正常的）

如果看到错误，检查：
1. 数据库是否运行
2. .env文件中的DATABASE_URL是否正确

### 步骤3: 创建多个蒸馏结果

**这是关键步骤！** 均衡选择需要多个蒸馏结果。

1. 访问 http://localhost:5173/distillation
2. 输入关键词，例如：
   - "Python编程"
   - "Java开发"
   - "React前端"
   - "数据库设计"
   - "机器学习"
3. 每个关键词点击"开始蒸馏"
4. 创建至少3-5个蒸馏结果

### 步骤4: 验证均衡选择

1. 访问 http://localhost:5173/article-generation
2. 创建一个任务，生成3篇文章
3. 等待任务完成
4. 检查生成的文章是否使用了不同的蒸馏结果

---

## 验证均衡选择是否工作

### 方法1: 通过UI验证

1. 访问"文章列表"页面
2. 查看最近生成的文章
3. 检查"关键词"列，应该看到不同的关键词

### 方法2: 通过数据库验证

```sql
-- 查看最近生成的文章使用的蒸馏结果
SELECT 
  a.id,
  a.title,
  d.keyword,
  d.usage_count,
  a.created_at
FROM articles a
JOIN distillations d ON a.distillation_id = d.id
ORDER BY a.created_at DESC
LIMIT 10;

-- 应该看到不同的keyword
```

### 方法3: 通过API验证

```bash
# 查看推荐的蒸馏结果（按usage_count升序）
curl http://localhost:3000/api/distillation/recommended?limit=5 | jq '.'

# 应该看到usage_count最小的蒸馏结果排在前面
```

---

## 均衡选择算法说明

### 算法逻辑

```
1. 查询所有有话题的蒸馏结果
2. 按 usage_count ASC, created_at ASC 排序
3. 选择前N个（N = 请求的文章数量）
4. 每篇文章使用不同的蒸馏结果
5. 生成后，更新每个蒸馏结果的usage_count
```

### 示例

假设有5个蒸馏结果：

| ID | 关键词 | usage_count |
|----|--------|-------------|
| 1  | Python | 0           |
| 2  | Java   | 0           |
| 3  | React  | 1           |
| 4  | Vue    | 2           |
| 5  | Node   | 3           |

**生成3篇文章时**：
- 选择ID: [1, 2, 3]（usage_count最小的3个）
- 文章1使用Python
- 文章2使用Java
- 文章3使用React

**生成后**：

| ID | 关键词 | usage_count |
|----|--------|-------------|
| 1  | Python | 1           |
| 2  | Java   | 1           |
| 3  | React  | 2           |
| 4  | Vue    | 2           |
| 5  | Node   | 3           |

**再次生成3篇文章时**：
- 选择ID: [1, 2, 3]或[1, 2, 4]（usage_count最小的3个）
- 继续均衡使用

---

## 常见问题解答

### Q1: 为什么页面显示空白？

**A**: 可能原因：
1. **服务器未启动** - 运行`npm run dev`启动服务器
2. **API返回错误** - 检查浏览器控制台（F12）
3. **数据库未连接** - 检查.env文件中的DATABASE_URL

**解决方案**：
1. 打开浏览器开发者工具（F12）
2. 查看Console标签页的错误信息
3. 查看Network标签页，检查API请求状态

### Q2: 为什么只使用一个蒸馏结果？

**A**: 最可能的原因是**数据库中只有一个蒸馏结果**。

**解决方案**：
1. 创建更多蒸馏结果（至少3-5个）
2. 确保每个蒸馏结果都有话题
3. 重新创建任务

### Q3: 如何确认算法正常工作？

**A**: 运行以下SQL查询：

```sql
-- 1. 检查蒸馏结果数量
SELECT COUNT(*) FROM distillations d
INNER JOIN topics t ON d.id = t.distillation_id;

-- 2. 检查usage_count分布
SELECT id, keyword, usage_count 
FROM distillations 
ORDER BY usage_count ASC;

-- 3. 检查最近任务的selected_distillation_ids
SELECT id, selected_distillation_ids, requested_count
FROM generation_tasks
ORDER BY created_at DESC
LIMIT 1;
```

如果`selected_distillation_ids`包含多个ID（例如`[1,2,3]`），说明算法正常工作。

### Q4: 旧任务会影响吗？

**A**: 不会。旧任务使用旧逻辑（单个蒸馏结果），新任务使用新逻辑（均衡选择）。它们互不影响。

---

## API端点说明

### 1. 获取推荐的蒸馏结果

```bash
GET /api/distillation/recommended?limit=5
```

返回usage_count最小的蒸馏结果，用于均衡选择。

### 2. 获取带使用统计的列表

```bash
GET /api/distillation/stats?page=1&pageSize=10&sortBy=usage_count&sortOrder=asc
```

返回所有蒸馏结果及其使用统计。

### 3. 获取使用历史

```bash
GET /api/distillation/:id/usage?page=1&pageSize=10
```

返回某个蒸馏结果的使用历史。

---

## 前端调用示例

```typescript
import { getRecommendedDistillations } from '../api/distillationApi';

// 获取推荐的蒸馏结果
const recommended = await getRecommendedDistillations(5);
console.log('推荐的蒸馏结果:', recommended);

// 显示在UI中
recommended.forEach(item => {
  console.log(`${item.keyword} - 使用${item.usageCount}次`);
});
```

---

## 测试脚本

运行测试脚本验证API：

```bash
./test-distillation-api.sh
```

或手动测试：

```bash
# 测试推荐API
curl http://localhost:3000/api/distillation/recommended?limit=5 | jq '.'

# 测试统计API
curl http://localhost:3000/api/distillation/stats | jq '.'
```

---

## 如果问题仍然存在

请提供以下信息：

1. **浏览器控制台错误**（F12 -> Console）
2. **Network请求状态**（F12 -> Network）
3. **数据库查询结果**：
   ```sql
   SELECT COUNT(*) FROM distillations;
   SELECT COUNT(*) FROM topics;
   SELECT id, keyword, usage_count FROM distillations;
   ```
4. **最近任务的信息**：
   ```sql
   SELECT id, selected_distillation_ids, requested_count, status
   FROM generation_tasks
   ORDER BY created_at DESC
   LIMIT 3;
   ```

---

## 总结

✅ **代码已经实现了均衡选择算法**
✅ **API端点已经创建**
✅ **前端API调用已经封装**

**关键步骤**：
1. 启动服务器
2. 创建多个蒸馏结果（至少3-5个）
3. 创建新任务测试

**预期结果**：
- 每篇文章使用不同的蒸馏结果
- usage_count均衡增长
- 推荐API返回usage_count最小的结果

