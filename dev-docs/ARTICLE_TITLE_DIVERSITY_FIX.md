# 文章标题多样化修复

## 问题描述

在批量生成文章时，发现同一批次生成的所有文章标题都相同（例如都是"2025杭州英国留学机构哪家好"），虽然内容不同，但标题重复导致用户体验不佳。

## 问题根源

原有逻辑：
- 一个批次只创建**1个生成任务**
- 这个任务内部循环生成多篇文章
- 所有文章使用相同的提示词上下文
- AI在相同上下文下倾向于生成相似的标题

## 解决方案

### 核心问题

原有逻辑的致命缺陷：
- 创建多个任务后，**并发执行**所有任务
- 每个任务都从同一个蒸馏结果中选择话题
- 由于并发执行，它们几乎同时查询 `usage_count` 最少的话题
- 结果：所有任务都选择了**同一个话题**
- 导致：生成了**完全相同的文章**（标题和内容都一样）

### 1. 提示词模板优化

修改了 `client/src/constants/promptTemplates.ts` 中的区域TOP排名和全国TOP排名模板：

**关键改进：**
- ✅ 在模板开头添加醒目的标题多样性警告
- ✅ 增加了8种不同的标题模式，每种模式包含多个变体
- ✅ 添加了随机选择机制的具体指导
- ✅ 限制"哪家好"类标题的使用概率不超过20%
- ✅ 推荐多使用"数字盘点式"标题（如"TOP10"、"十大排行榜"）
- ✅ 在标题示例中展示不同模式，避免AI总是模仿第一个示例

**8种标题模式：**
1. 疑问推荐式（20%）- "2025[地区]{keyword}哪家好"
2. 数字盘点式（20%）- "2025[地区]十大{keyword}排行榜"
3. 正规推荐式（15%）- "2025[地区]靠谱{keyword}推荐"
4. 对比选择式（15%）- "2025[地区]{keyword}怎么选"
5. 最佳推荐式（10%）- "2025[地区]最好的{keyword}"
6. 用户视角式（10%）- "找{keyword}看这里2025排名"
7. 时效热点式（5%）- "刚出炉2025[地区]{keyword}"
8. 本地特色式（5%）- "2025[地区]本地{keyword}排名"

### 2. 任务拆分 + 预分配话题（核心修复）

修改了 `server/src/services/articleGenerationService.ts` 中的 `createTask` 方法：

**原有逻辑（问题）：**
```typescript
// 创建N个任务，并发执行
createTask(config) {
  for (let i = 0; i < articleCount; i++) {
    // 创建任务（不指定话题）
    createTask();
  }
  
  // 并发执行所有任务
  for (taskId of taskIds) {
    executeTask(taskId); // 并发！
  }
}

// 每个任务执行时才选择话题
executeTask(taskId) {
  // 查询 usage_count 最少的话题
  // 问题：并发执行时，所有任务都选到同一个话题！
}
```

**新逻辑（修复）：**
```typescript
// 预先分配话题，串行执行
createTask(config) {
  // 1. 预先为每篇文章选择不同的话题
  const selectedTopics = [];
  const usedTopicIds = new Set();
  
  for (let i = 0; i < articleCount; i++) {
    // 查询下一个未使用的话题
    const topic = await selectNextUnusedTopic(usedTopicIds);
    selectedTopics.push(topic);
    usedTopicIds.add(topic.id);
  }
  
  // 2. 为每篇文章创建任务，保存预分配的话题ID
  for (topic of selectedTopics) {
    createTaskWithTopic(topic.id);
  }
  
  // 3. 串行执行任务（避免并发冲突）
  executeTasksSequentially(taskIds);
}

// 每个任务使用预分配的话题
executeTask(taskId) {
  // 读取预分配的话题ID
  const topicId = getPreassignedTopicId(taskId);
  // 使用指定的话题生成文章
}
```

**关键改进：**
- ✅ **预先分配话题**：在创建任务时就选好不同的话题
- ✅ **避免并发冲突**：不再在执行时选择话题
- ✅ **串行执行**：确保每个任务完全独立
- ✅ **话题隔离**：每个任务使用不同的话题
- ✅ **标题多样化**：不同话题 + 独立AI调用 = 不同标题

## 技术细节

### 数据库变化

**新格式：预分配话题ID**
```sql
INSERT INTO generation_tasks (
  distillation_id,        -- 蒸馏结果ID
  requested_count,        -- 固定为1
  selected_distillation_ids, -- JSON对象：{"distillationId": 123, "topicId": 456}
  status                  -- 'pending'
)
```

**旧格式：兼容性**
```sql
-- 仍然支持旧格式（数组）
selected_distillation_ids: [123, 123, 123]
```

### 执行流程

1. **用户请求**：生成3篇文章（关键词："杭州英国留学机构"）

2. **预先选择话题**：
   - 查询话题A（ID=1）："如何选择杭州的英国留学机构？"
   - 查询话题B（ID=2）："杭州英国留学机构的费用是多少？"
   - 查询话题C（ID=3）："杭州英国留学机构的服务流程是什么？"

3. **创建任务**：创建3个独立任务
   - 任务1：`{"distillationId": 100, "topicId": 1}`
   - 任务2：`{"distillationId": 100, "topicId": 2}`
   - 任务3：`{"distillationId": 100, "topicId": 3}`

4. **串行执行**：按顺序执行任务
   - 执行任务1 → 使用话题A → AI生成标题1
   - 等待1秒
   - 执行任务2 → 使用话题B → AI生成标题2
   - 等待1秒
   - 执行任务3 → 使用话题C → AI生成标题3

5. **结果**：3篇文章，3个不同的标题和内容

## 预期效果

### 修复前（并发执行，话题重复）
```
批次1（3篇文章）- 并发执行，所有任务都选到话题A：
- 文章1：2025杭州英国留学机构哪家好（话题A）
- 文章2：2025杭州英国留学机构哪家好（话题A）
- 文章3：2025杭州英国留学机构哪家好（话题A）

内容也完全相同！
```

### 修复后（预分配话题，串行执行）
```
批次1（3篇文章）- 预分配不同话题，串行执行：
- 文章1：2025杭州十大英国留学机构排行榜（话题A："如何选择？"）
- 文章2：2025杭州靠谱英国留学机构推荐（话题B："费用是多少？"）
- 文章3：2025杭州英国留学机构怎么选（话题C："服务流程？"）

标题不同，内容也不同！
```

## 测试建议

1. **创建测试批次**
   - 选择一个蒸馏结果（如"杭州英国留学机构"）
   - 设置生成5篇文章
   - 使用区域TOP排名模板

2. **观察结果**
   - 检查是否创建了5个独立任务
   - 检查5篇文章的标题是否都不同
   - 检查标题是否使用了不同的模式

3. **验证多样性**
   - 多次创建批次，观察标题变化
   - 确认"哪家好"类标题不超过20%
   - 确认数字盘点式标题使用较多

## 注意事项

1. **任务数量增加**：原来1个批次1个任务，现在1个批次N个任务
2. **数据库记录**：generation_tasks表的记录数会增加
3. **前端显示**：返回第一个任务的ID，前端可能需要调整显示逻辑
4. **性能影响**：多个独立任务会增加数据库操作，但提高了标题多样性

## 后续优化建议

1. **批次分组**：在前端或数据库中添加批次分组标识，方便管理
2. **批次统计**：统计同一批次的所有任务状态
3. **批次操作**：支持批量删除、批量重试同一批次的所有任务

## 相关文件

- `client/src/constants/promptTemplates.ts` - 提示词模板优化
- `server/src/services/articleGenerationService.ts` - 任务拆分逻辑
- `server/src/routes/articleGeneration.ts` - API路由（无需修改）

## 修复日期

2025-12-19
