# 文章图片嵌入功能指南

## 概述

文章图片嵌入功能允许图片自然地嵌入到文章内容中，而不是作为独立元素显示。这使得生成的文章更接近互联网上的标准高质量图文文章。

## 功能特性

### 1. 自动图片嵌入
- 文章生成时，系统会自动将图片以Markdown格式嵌入到文章内容中
- 图片会被智能地插入到适当的位置（通常在第一段或第二段之后）
- AI可以通过返回 `[IMAGE_PLACEHOLDER]` 占位符来指定图片位置

### 2. Markdown渲染
- 使用React Markdown库渲染文章内容
- 支持图片、标题、列表等基本Markdown语法
- 图片自动应用统一的样式（圆角、边框、最大尺寸等）

### 3. 向后兼容
- 自动检测旧格式文章（只有image_url字段，内容中没有图片标记）
- 旧格式文章会自动在开头插入图片
- 新格式文章优先使用内容中的图片标记

### 4. 编辑支持
- 支持在编辑模式下修改Markdown图片标记
- 提供Markdown语法提示
- 可以添加、删除或更换图片

## 使用方法

### 生成文章

1. 在文章生成模块创建新任务
2. 选择蒸馏历史、图库、知识库和文章设置
3. 系统会自动生成包含图片的文章
4. 图片会以Markdown格式嵌入到文章内容中

### 查看文章

1. 在文章管理页面点击"查看"按钮
2. 文章内容会以Markdown格式渲染
3. 图片会显示在内容的相应位置
4. 图片加载失败时会显示占位图

### 编辑文章

1. 在文章详情页面点击"编辑"按钮
2. 可以直接编辑包含Markdown标记的内容
3. 使用 `![图片描述](图片URL)` 语法插入或修改图片
4. 保存后图片会正确渲染

## Markdown语法

### 插入图片

```markdown
![图片描述](图片URL)
```

示例：
```markdown
![文章配图](https://example.com/image.jpg)
```

### 多张图片

可以在文章中插入多张图片：

```markdown
这是第一段文字。

![第一张图片](https://example.com/image1.jpg)

这是第二段文字。

![第二张图片](https://example.com/image2.jpg)

这是第三段文字。
```

### 其他支持的Markdown语法

- **标题**: `# 一级标题`, `## 二级标题`
- **加粗**: `**加粗文本**`
- **斜体**: `*斜体文本*`
- **列表**: `- 列表项` 或 `1. 有序列表`
- **链接**: `[链接文本](URL)`

## 技术实现

### 前端组件

#### ArticleContent组件
- 位置: `client/src/components/ArticleContent.tsx`
- 功能: 统一的Markdown渲染组件
- 特性:
  - 使用react-markdown库
  - 自定义图片样式
  - 向后兼容旧格式
  - 图片加载失败处理

### 后端服务

#### 图片插入逻辑
- 位置: `server/src/services/articleGenerationService.ts`
- 方法: `insertImageIntoContent()`
- 功能:
  - 检测并替换AI返回的占位符
  - 智能插入图片到适当位置
  - 处理单段落和多段落内容

#### AI提示词优化
- 方法: `buildPromptWithImageInstruction()`
- 功能:
  - 指示AI在适当位置插入占位符
  - 提供清晰的输出格式要求

### 数据存储

- 文章内容以Markdown格式存储在 `articles.content` 字段
- `articles.image_url` 字段保留用于向后兼容
- 新格式文章优先使用content中的图片标记

## 最佳实践

### 1. 图片选择
- 选择高质量、相关的图片
- 确保图片URL可访问
- 使用合适的图片尺寸（建议宽度800-1200px）

### 2. 图片位置
- 让AI自动决定图片位置（推荐）
- 或在编辑时手动调整图片位置
- 避免在文章开头或结尾放置图片

### 3. 图片描述
- 为图片添加有意义的描述文本
- 描述应该简洁明了
- 有助于SEO和可访问性

### 4. 多图片文章
- 合理分布图片位置
- 避免连续放置多张图片
- 保持文字和图片的平衡

## 故障排除

### 图片不显示
1. 检查图片URL是否正确
2. 确认图片文件存在
3. 检查网络连接
4. 查看浏览器控制台错误信息

### Markdown不渲染
1. 检查Markdown语法是否正确
2. 确认使用了正确的图片语法 `![alt](url)`
3. 检查是否有特殊字符需要转义

### 旧文章显示问题
1. 系统会自动兼容旧格式
2. 如果有问题，可以手动编辑添加图片标记
3. 保存后会使用新格式

## 更新日志

### v1.0.0 (2024-12-13)
- ✅ 实现图片自动嵌入功能
- ✅ 添加Markdown渲染支持
- ✅ 实现向后兼容逻辑
- ✅ 添加编辑模式Markdown支持
- ✅ 优化AI提示词
- ✅ 添加图片加载失败处理

## 相关文档

- [需求文档](.kiro/specs/article-image-embedding/requirements.md)
- [设计文档](.kiro/specs/article-image-embedding/design.md)
- [任务列表](.kiro/specs/article-image-embedding/tasks.md)
