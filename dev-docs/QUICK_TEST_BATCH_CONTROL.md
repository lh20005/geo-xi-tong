# 批次执行控制快速测试指南

## 🚀 快速测试步骤

### 测试 1: 批次停止响应（2分钟）

1. **创建测试批次**
   - 打开发布任务页面
   - 创建一个批次，包含3个任务
   - 设置间隔时间：5分钟

2. **启动并停止**
   - 点击"开始执行"
   - 等待第一个任务完成（观察日志显示 ✅）
   - 立即点击"停止批次"按钮

3. **验证结果**
   - 打开后台日志（终端）
   - 查找日志：`🛑 批次 xxx 在任务 2 开始前被停止`
   - 确认第二个任务没有开始执行
   - 确认响应时间在1-2秒内

**预期日志**:
```
✅ 批次任务 #123 执行成功
🛑 批次 xxx 在任务 2 开始前被停止
✅ 批次 xxx 已从执行队列中移除
```

---

### 测试 2: 等待期间停止（3分钟）

1. **创建测试批次**
   - 创建一个批次，包含2个任务
   - 设置间隔时间：30分钟

2. **启动并在等待期间停止**
   - 点击"开始执行"
   - 等待第一个任务完成
   - 观察日志显示"等待30分钟..."
   - 等待约1分钟后，点击"停止批次"

3. **验证结果**
   - 查找日志：`🛑 批次 xxx 在等待期间被停止`
   - 确认显示已等待时间和剩余时间
   - 确认第二个任务没有开始执行

**预期日志**:
```
⏳ 等待 30 分钟后执行下一个任务...
🛑 批次 xxx 在等待期间被停止
   已等待: 60秒
   剩余等待: 29分钟
```

---

### 测试 3: 间隔时间准确性（5分钟）

1. **创建测试批次**
   - 创建一个批次，包含2个任务
   - 设置间隔时间：2分钟

2. **执行并观察**
   - 点击"开始执行"
   - 记录第一个任务完成时间（查看日志时间戳）
   - 等待间隔时间
   - 记录第二个任务开始时间

3. **验证结果**
   - 查找日志中的等待信息
   - 确认显示"预期等待: 2分钟"
   - 确认显示"实际等待: 2分钟 (约120000ms)"
   - 计算实际间隔应该约为2分钟（允许5秒误差）

**预期日志**:
```
⏳ 等待 2 分钟后执行下一个任务...
   当前时间: 2024-01-01 10:00:00
   预计下次执行时间: 2024-01-01 10:02:00
   等待时长: 120000ms (2分钟)
✅ 等待完成
   预期等待: 2分钟
   实际等待: 2分钟 (120123ms)
📝 执行批次 xxx 中的第 2/2 个任务 #124
```

---

## 🔍 关键日志位置

### 查看后台日志
```bash
# 如果使用 npm
npm run dev

# 或者查看服务器日志
# 日志会显示在启动服务器的终端窗口
```

### 关键日志标识

**停止信号检测**:
- `🛑 批次 xxx 在任务 N 开始前被停止`
- `🛑 批次 xxx 在任务 N 完成后被停止`
- `🛑 批次 xxx 在等待期间被停止`

**间隔等待**:
- `⏳ 等待 N 分钟后执行下一个任务...`
- `✅ 等待完成`
- `预期等待: N分钟`
- `实际等待: N分钟 (Xms)`

**批次完成**:
- `🎉 批次 xxx 执行完成！耗时: N秒`
- `📊 批次 xxx 统计:`

---

## ✅ 成功标准

### 测试 1 通过条件
- [ ] 点击停止后1-2秒内检测到停止信号
- [ ] 日志显示在任务开始前被停止
- [ ] 下一个任务没有执行

### 测试 2 通过条件
- [ ] 等待期间点击停止后1-2秒内检测到
- [ ] 日志显示已等待时间和剩余时间
- [ ] 等待立即终止，下一个任务没有执行

### 测试 3 通过条件
- [ ] 日志显示预期等待时间
- [ ] 日志显示实际等待时间
- [ ] 实际等待时间与预期相差不超过5秒
- [ ] 第二个任务在预期时间开始执行

---

## 🐛 常见问题

### 问题 1: 停止后任务仍在执行
**可能原因**: 
- 任务正在执行中（必须等待任务完成）
- 浏览器缓存问题

**解决方案**:
- 等待当前任务完成
- 刷新浏览器页面
- 检查后台日志确认停止信号

### 问题 2: 间隔时间不准确
**可能原因**:
- 系统负载高
- 任务执行时间过长

**解决方案**:
- 查看日志中的实际等待时间
- 允许5秒误差范围
- 检查任务执行时间

### 问题 3: 日志没有显示
**可能原因**:
- 服务器没有重启
- 日志级别设置问题

**解决方案**:
- 重启服务器
- 检查终端窗口
- 确认代码已更新

---

## 📝 测试报告模板

```
测试日期: ___________
测试人员: ___________

测试 1: 批次停止响应
- 停止响应时间: ___ 秒
- 是否成功停止: [ ] 是 [ ] 否
- 备注: ___________

测试 2: 等待期间停止
- 停止响应时间: ___ 秒
- 已等待时间: ___ 秒
- 是否成功停止: [ ] 是 [ ] 否
- 备注: ___________

测试 3: 间隔时间准确性
- 预期间隔: ___ 分钟
- 实际间隔: ___ 分钟
- 误差: ___ 秒
- 是否在允许范围内: [ ] 是 [ ] 否
- 备注: ___________

总体评价: [ ] 通过 [ ] 失败
```

---

## 🎯 下一步

测试通过后：
1. 在生产环境中测试
2. 监控批次执行性能
3. 收集用户反馈
4. 考虑添加UI进度显示

测试失败时：
1. 记录详细的错误日志
2. 截图保存问题现象
3. 联系开发人员
4. 提供测试报告
