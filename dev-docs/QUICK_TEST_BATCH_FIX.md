# 批次任务修复 - 快速测试指南

## 修复内容

✅ **问题1**：批次任务第二条总是头条号Cookie登录失败  
✅ **问题2**：任务状态需要手动刷新页面才能看到更新

## 快速测试步骤

### 准备工作

1. **启动服务**
```bash
# 启动后端
cd server
npm run dev

# 启动前端（新终端）
cd client
npm run dev
```

2. **确保有测试数据**
   - 至少3篇草稿文章
   - 至少1个已绑定的头条号账号
   - 账号Cookie有效

### 测试1：批次任务Cookie登录（核心测试）

**目标**：验证第二条任务不再Cookie登录失败

**步骤**：

1. 打开发布任务页面：`http://localhost:5173/publishing-tasks`

2. 选择3篇文章（勾选复选框）

3. 选择头条号平台

4. 设置发布间隔：**1分钟**（测试用，正式使用5分钟）

5. 点击"创建发布任务"

6. 观察任务执行：
   ```
   第1个任务：
   - 状态应该变为"执行中"
   - 日志显示"浏览器启动成功"
   - 日志显示"头条号 Cookie登录成功"
   - 任务完成后状态变为"成功"
   - 日志显示"浏览器已关闭"
   
   等待1分钟...
   
   第2个任务：
   - 状态应该变为"执行中"
   - 日志显示"浏览器启动成功"（新的浏览器实例）
   - 日志显示"头条号 Cookie登录成功"（不再失败！）
   - 任务完成后状态变为"成功"
   - 日志显示"浏览器已关闭"
   
   等待1分钟...
   
   第3个任务：
   - 同样应该成功
   ```

**预期结果**：
- ✅ 所有3个任务都应该成功
- ✅ 第二个任务不再Cookie登录失败
- ✅ 每个任务都有独立的浏览器实例

**失败标志**：
- ❌ 第二个任务显示"头条号 Cookie登录失败"
- ❌ 第二个任务状态变为"失败"

### 测试2：自动刷新状态（次要测试）

**目标**：验证任务状态自动更新，无需手动刷新

**步骤**：

1. 创建一个单独的发布任务

2. **不要点击刷新按钮**

3. **不要刷新浏览器页面**

4. 观察任务状态变化：
   ```
   0秒：状态显示"等待中"
   5秒：状态自动变为"执行中"（无需手动刷新）
   30秒：状态自动变为"成功"或"失败"（无需手动刷新）
   ```

5. 打开浏览器控制台（F12），应该看到：
   ```
   🔄 自动刷新任务列表...
   🔄 自动刷新任务列表...
   🔄 自动刷新任务列表...
   ```

**预期结果**：
- ✅ 任务状态每5秒自动更新
- ✅ 无需手动刷新页面
- ✅ 控制台显示自动刷新日志

**失败标志**：
- ❌ 任务状态不变化，需要手动刷新
- ❌ 控制台没有自动刷新日志

## 常见问题排查

### 问题1：第二个任务仍然Cookie登录失败

**可能原因**：
1. Cookie已过期 → 重新获取Cookie
2. 代码未更新 → 确认修改已保存并重启服务
3. 浏览器缓存 → 清除浏览器缓存

**排查步骤**：
```bash
# 1. 确认代码修改
cd server/src/services
grep -A 5 "立即关闭浏览器" PublishingExecutor.ts

# 应该看到：
# console.log(`🔄 [任务 #${taskId}] 立即关闭浏览器...`);
# await browserAutomationService.closeBrowser();

# 2. 重启后端服务
cd server
npm run dev

# 3. 查看日志
# 应该看到每个任务都有"浏览器已关闭"
```

### 问题2：状态不自动刷新

**可能原因**：
1. 前端代码未更新 → 确认修改已保存并重启
2. 浏览器缓存 → 强制刷新（Ctrl+Shift+R）

**排查步骤**：
```bash
# 1. 确认代码修改
cd client/src/pages
grep -A 10 "自动刷新任务列表" PublishingTasksPage.tsx

# 应该看到：
# const intervalId = setInterval(() => {
#   if (tasks.length > 0) {
#     const hasRunningTasks = tasks.some(t => t.status === 'running' || t.status === 'pending');
#     if (hasRunningTasks) {
#       console.log('🔄 自动刷新任务列表...');

# 2. 重启前端服务
cd client
npm run dev

# 3. 强制刷新浏览器
# 按 Ctrl+Shift+R (Windows/Linux) 或 Cmd+Shift+R (Mac)
```

### 问题3：浏览器启动失败

**可能原因**：
1. 内存不足 → 关闭其他程序
2. Puppeteer未安装 → 重新安装依赖

**排查步骤**：
```bash
# 检查内存
free -h  # Linux
# 或
top  # Mac

# 重新安装Puppeteer
cd server
npm install puppeteer
```

## 性能监控

### 观察指标

1. **浏览器启动时间**
   - 正常：2-3秒
   - 异常：>10秒

2. **任务执行时间**
   - 正常：30-60秒
   - 异常：>120秒

3. **内存使用**
   - 正常：每个浏览器实例约200-300MB
   - 异常：>500MB

### 日志关键字

```bash
# 成功的日志应该包含：
✅ 浏览器启动成功
✅ 头条号 Cookie登录成功
✅ 任务执行成功
✅ 浏览器已关闭

# 失败的日志可能包含：
❌ Cookie登录失败
❌ 浏览器启动失败
❌ 任务执行失败
```

## 测试通过标准

### 必须通过（P0）
- ✅ 批次任务的第二条不再Cookie登录失败
- ✅ 批次任务的第三条也能成功
- ✅ 任务状态自动刷新

### 建议通过（P1）
- ✅ 浏览器启动时间<5秒
- ✅ 任务执行时间<90秒
- ✅ 无内存泄漏

### 可选通过（P2）
- ✅ 控制台无错误日志
- ✅ 网络请求正常
- ✅ UI响应流畅

## 回滚方案

如果测试失败，立即回滚：

```bash
# 回滚后端
cd server/src/services
git checkout HEAD~1 PublishingExecutor.ts

# 回滚前端
cd client/src/pages
git checkout HEAD~1 PublishingTasksPage.tsx

# 重启服务
cd server && npm run dev
cd client && npm run dev
```

## 联系支持

如果测试遇到问题，请提供：
1. 错误日志（后端和前端）
2. 任务ID
3. 浏览器控制台截图
4. 系统信息（操作系统、内存、Node版本）
