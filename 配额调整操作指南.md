# 配额调整操作指南

## 问题现象

调整用户配额后，用户在生成文章页面仍然看到"配额不足"的错误提示。

## 解决方案

已通过数据库函数修复和配额同步服务彻底解决此问题。

## 部署修复

### 步骤 1: 运行数据库迁移

```bash
cd server
npx ts-node src/db/run-migration-032.ts
```

**预期输出**:
```
========================================
运行迁移 032: 修复 check_user_quota 函数
========================================

执行迁移...

✅ 迁移 032 执行成功！

配额一致性检查:
  ✅ lzc2005: custom_quotas=6, check_user_quota=6
  ✅ testuser: custom_quotas=20, check_user_quota=20
```

### 步骤 2: 验证修复

```bash
./验证配额同步修复.sh
```

或手动运行：

```bash
cd server
npx ts-node src/scripts/test-quota-check-after-adjustment.ts
```

**预期输出**:
```
4. 配额一致性检查:
   custom_quotas 中的值: 6
   check_user_quota 返回的值: 6
   ✅ 一致
```

### 步骤 3: 重启服务

```bash
# 停止当前服务
# 然后重新启动
npm run server:dev
```

## 调整配额的正确流程

### 方式 1: 通过管理后台（推荐）

1. 登录管理后台
2. 进入"用户管理"页面
3. 找到目标用户，点击"订阅详情"
4. 点击"调整配额"按钮
5. 选择功能类型，输入新配额值
6. 填写调整原因
7. 点击"确认调整"

**系统会自动**:
- ✅ 更新 `user_subscriptions.custom_quotas`
- ✅ 清除 Redis 缓存
- ✅ 同步存储配额（如果是 storage_space）
- ✅ 推送 WebSocket 通知给用户
- ✅ 刷新配额概览

### 方式 2: 通过 API

```bash
curl -X POST http://localhost:3000/api/admin/user-subscriptions/1/adjust-quota \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "featureCode": "articles_per_month",
    "newValue": 10,
    "isPermanent": false,
    "reason": "用户反馈配额不足"
  }'
```

### 方式 3: 直接修改数据库（不推荐）

如果必须直接修改数据库，请按以下步骤操作：

```sql
-- 1. 更新配额
UPDATE user_subscriptions
SET custom_quotas = jsonb_set(
  COALESCE(custom_quotas, '{}'::jsonb),
  '{articles_per_month}',
  '10'
),
updated_at = CURRENT_TIMESTAMP
WHERE user_id = 1
  AND status = 'active'
  AND end_date > CURRENT_TIMESTAMP;

-- 2. 手动触发同步（在应用代码中）
-- 或者清除 Redis 缓存
```

然后在应用中调用：

```typescript
import { QuotaSyncService } from './services/QuotaSyncService';

await QuotaSyncService.syncUserQuota(userId, '手动调整配额');
```

## 配额类型说明

### 功能配额

| 功能代码 | 说明 | 单位 | 默认值 |
|---------|------|------|--------|
| `articles_per_month` | 每月生成文章数 | 篇 | 100 |
| `publish_per_month` | 每月发布文章数 | 篇 | 200 |
| `platform_accounts` | 平台账号数 | 个 | 1 |
| `keyword_distillation` | 关键词蒸馏数 | 次 | 50 |
| `gallery_albums` | 企业图库相册数 | 个 | 10 |
| `knowledge_bases` | 知识库数 | 个 | 5 |

### 存储配额

| 功能代码 | 说明 | 单位 | 默认值 |
|---------|------|------|--------|
| `storage_space` | 存储空间 | MB | 100 |

**特殊值**:
- `-1`: 表示无限制
- `0`: 表示禁用该功能

## 验证配额是否生效

### 方法 1: 通过测试脚本

```bash
cd server
npx ts-node src/scripts/test-quota-check-after-adjustment.ts
```

### 方法 2: 通过 API 查询

```bash
# 查询用户配额
curl http://localhost:3000/api/usage-tracking/quota/articles_per_month \
  -H "Authorization: Bearer USER_TOKEN"
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "hasQuota": true,
    "currentUsage": 2,
    "quotaLimit": 10,
    "remaining": 8,
    "percentage": 20.00
  }
}
```

### 方法 3: 让用户测试

1. 用户登录系统
2. 进入"生成文章"页面
3. 查看页面顶部的配额显示
4. 尝试创建生成任务

**预期结果**: 
- 配额显示正确的新值
- 如果配额充足，可以成功创建任务
- 如果配额不足，显示准确的剩余配额

## 常见问题

### Q1: 调整配额后，用户仍然看到旧的配额？

**原因**: Redis 缓存未清除

**解决**:
```bash
# 方式 1: 重新调整一次配额（系统会自动清除缓存）

# 方式 2: 手动清除缓存
redis-cli
> DEL user:1:subscription
> DEL user:1:quotas
> DEL user:1:storage
> DEL storage:usage:1
```

### Q2: 存储配额调整后不生效？

**原因**: `user_storage_usage` 表未同步

**解决**:
```sql
-- 手动同步存储配额
UPDATE user_storage_usage
SET storage_quota_bytes = (
  SELECT (custom_quotas->>'storage_space')::INTEGER * 1024 * 1024
  FROM user_subscriptions
  WHERE user_id = user_storage_usage.user_id
    AND status = 'active'
    AND end_date > CURRENT_TIMESTAMP
    AND custom_quotas ? 'storage_space'
  LIMIT 1
),
last_updated_at = CURRENT_TIMESTAMP
WHERE user_id = 1;
```

或使用同步服务：
```typescript
await QuotaSyncService.syncUserQuota(userId, '手动同步存储配额');
```

### Q3: 如何批量调整多个用户的配额？

```typescript
import { QuotaSyncService } from './services/QuotaSyncService';

const userIds = [1, 2, 3, 4, 5];

// 批量更新数据库
for (const userId of userIds) {
  await pool.query(`
    UPDATE user_subscriptions
    SET custom_quotas = jsonb_set(
      COALESCE(custom_quotas, '{}'::jsonb),
      '{articles_per_month}',
      '20'
    )
    WHERE user_id = $1
      AND status = 'active'
      AND end_date > CURRENT_TIMESTAMP
  `, [userId]);
}

// 批量同步
await QuotaSyncService.syncMultipleUsers(userIds, '批量配额调整');
```

### Q4: 如何查看配额调整历史？

```sql
SELECT 
  sa.id,
  sa.user_id,
  u.username,
  sa.adjustment_type,
  sa.quota_adjustments,
  sa.reason,
  sa.created_at,
  admin.username as admin_username
FROM subscription_adjustments sa
JOIN users u ON sa.user_id = u.id
LEFT JOIN users admin ON sa.admin_id = admin.id
WHERE sa.adjustment_type = 'quota_adjust'
ORDER BY sa.created_at DESC
LIMIT 20;
```

## 监控和日志

### 查看配额同步日志

```bash
# 查看服务器日志
tail -f server/logs/app.log | grep QuotaSync
```

**正常日志示例**:
```
[QuotaSync] 开始同步用户 1 的配额...
[QuotaSync] 清除 Redis 缓存...
[QuotaSync]   删除缓存: user:1:subscription
[QuotaSync]   删除缓存: user:1:quotas
[QuotaSync] 同步存储配额...
[QuotaSync]   存储配额已更新: 600 MB
[QuotaSync] 推送 WebSocket 通知...
[QuotaSync]   WebSocket 通知已发送
[QuotaSync] 刷新配额概览...
[QuotaSync]   配额概览已刷新
[QuotaSync] ✅ 用户 1 的配额同步完成
```

### 监控配额使用情况

```sql
-- 查看用户当前配额使用情况
SELECT 
  u.id,
  u.username,
  us.custom_quotas,
  (SELECT quota_limit FROM check_user_quota(u.id, 'articles_per_month')) as articles_limit,
  (SELECT current_usage FROM check_user_quota(u.id, 'articles_per_month')) as articles_used,
  (SELECT remaining FROM check_user_quota(u.id, 'articles_per_month')) as articles_remaining
FROM users u
JOIN user_subscriptions us ON u.id = us.user_id
WHERE us.status = 'active'
  AND us.end_date > CURRENT_TIMESTAMP
ORDER BY u.id;
```

## 技术支持

如果遇到问题，请提供以下信息：

1. 用户 ID 和用户名
2. 调整的配额类型和值
3. 错误截图或日志
4. 运行诊断脚本的输出：
   ```bash
   cd server
   npx ts-node src/scripts/simple-quota-sync-check.ts > quota-diagnostic.log 2>&1
   ```

## 相关文档

- [配额同步问题完整修复报告.md](./配额同步问题完整修复报告.md)
- [用户订阅管理功能.md](./docs/02-功能说明/用户订阅管理功能.md)
- [商品管理系统使用说明.md](./商品管理系统使用说明.md)
