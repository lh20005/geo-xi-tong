# 用户管理订阅套餐列显示功能完成

## 修改内容

### 1. 后端修改 (server/src/services/UserService.ts)

修改了 `getUsers()` 方法，添加订阅套餐信息查询：

```typescript
// 修改前：只查询用户基本信息和邀请数量
// 修改后：增加 LEFT JOIN 查询用户的活跃订阅套餐

SELECT 
  u.id, u.username, u.invitation_code, u.invited_by_code, u.role, 
  u.is_temp_password, u.created_at, u.updated_at, u.last_login_at,
  COUNT(DISTINCT invited.id) as invited_count,
  MAX(p.plan_name) as subscription_plan_name  -- 新增：订阅套餐名称
FROM users u
LEFT JOIN users invited ON invited.invited_by_code = u.invitation_code
LEFT JOIN user_subscriptions us ON us.user_id = u.id AND us.status = 'active'
LEFT JOIN subscription_plans p ON p.id = us.plan_id
GROUP BY u.id
ORDER BY u.created_at DESC
```

**关键点：**
- 使用 `MAX(p.plan_name)` 而不是直接 `p.plan_name`，避免 GROUP BY 问题
- 使用 `COUNT(DISTINCT invited.id)` 确保邀请数量统计准确
- 只查询 `status = 'active'` 的订阅
- 默认值为 "无订阅"（当用户没有活跃订阅时）

### 2. 前端修改 (client/src/pages/UserManagementPage.tsx)

#### 2.1 更新 User 接口
```typescript
interface User {
  id: number;
  username: string;
  role: 'admin' | 'user';
  invitationCode: string;
  invitedCount: number;
  createdAt: string;
  lastLoginAt?: string;
  isTempPassword?: boolean;
  subscriptionPlanName?: string;  // 新增字段
}
```

#### 2.2 添加订阅套餐列
在"用户名"列后新增"订阅套餐"列：

```typescript
{
  title: '订阅套餐',
  dataIndex: 'subscriptionPlanName',
  key: 'subscriptionPlanName',
  width: 120,
  render: (planName: string) => (
    <Tag color={planName === '无订阅' ? 'default' : 'green'}>
      {planName || '无订阅'}
    </Tag>
  ),
}
```

**显示效果：**
- 有订阅：绿色标签显示套餐名称（如"免费版"、"专业版"、"企业版"）
- 无订阅：灰色标签显示"无订阅"

### 3. Windows 登录管理器修改 (windows-login-manager/src/pages/UserManagementPage.tsx)

与主前端保持一致，同样添加了：
- User 接口的 `subscriptionPlanName` 字段
- "订阅套餐"列显示

## 测试结果

已通过 SQL 查询测试，成功返回用户订阅套餐信息：

```json
{
  "username": "testuser2",
  "subscription_plan_name": "专业版"
},
{
  "username": "testuser",
  "subscription_plan_name": "免费版"
}
```

## 使用说明

### 重启服务器
修改已完成，需要重启后端服务器以应用更改：

```bash
# 停止当前服务器（如果正在运行）
# 然后重新启动
npm run server:dev
```

### 查看效果
1. 重启服务器后，访问用户管理页面
2. 在用户列表中，"用户名"列后会显示"订阅套餐"列
3. 每个用户会显示其当前活跃的订阅套餐名称
4. 没有订阅的用户显示"无订阅"

## 技术细节

### SQL 优化
- 使用 `MAX()` 聚合函数处理可能为 NULL 的套餐名称
- 使用 `COUNT(DISTINCT)` 确保邀请数量统计准确
- 只查询活跃状态的订阅（`status = 'active'`）

### 数据库表关系
```
users (用户表)
  ↓ (1:N)
user_subscriptions (用户订阅表, status='active')
  ↓ (N:1)
subscription_plans (订阅套餐表)
```

### 列宽和样式
- 列宽：120px
- 有订阅：绿色 Tag
- 无订阅：默认灰色 Tag

## 完成时间
2026-01-05
