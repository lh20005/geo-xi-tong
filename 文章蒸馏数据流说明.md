# 文章蒸馏数据流说明

## 问题描述

你遇到的问题是：**文章生成模块中，蒸馏结果列的数据不对**

## 数据流程图

```
用户操作流程：
1. 关键词蒸馏模块
   ↓ 输入关键词
   ↓ AI生成话题
   ↓ 保存到数据库
   
2. 蒸馏结果
   - distillations表：保存关键词
   - topics表：保存生成的话题
   
3. 文章生成模块
   ↓ 选择蒸馏历史
   ↓ 选择图库、知识库等
   ↓ 创建生成任务
   
4. 文章生成
   - 从蒸馏结果中提取关键词和话题
   - 调用AI生成文章
   - 保存到articles表
   - 记录distillation_id（关联）
   
5. 文章列表显示
   - 通过distillation_id关联查询
   - 显示蒸馏结果的关键词
```

## 现有API清单

### ✅ 所有需要的API都已经存在！

#### 1. 蒸馏模块API

| API | 说明 | 返回数据 |
|-----|------|---------|
| `GET /api/distillation/history` | 获取蒸馏历史列表 | 包含id, keyword, topic_count, usage_count |
| `GET /api/distillation/:id` | 获取单个蒸馏详情 | 包含keyword和questions数组 |
| `GET /api/distillation/results` | 获取蒸馏结果表格 | 包含所有话题和引用次数 |
| `GET /api/distillation/keywords` | 获取所有关键词列表 | 返回唯一关键词数组 |

#### 2. 文章生成API

| API | 说明 | 返回数据 |
|-----|------|---------|
| `POST /api/article-generation/tasks` | 创建生成任务 | 返回taskId |
| `GET /api/article-generation/tasks` | 获取任务列表 | 包含任务状态和进度 |
| `GET /api/article-generation/tasks/:id` | 获取任务详情 | 包含生成的文章列表 |

#### 3. 文章管理API

| API | 说明 | 返回数据 |
|-----|------|---------|
| `GET /api/articles` | 获取文章列表 | 支持按distillationId筛选 |
| `GET /api/articles/:id` | 获取文章详情 | 包含完整文章信息 |
| `PUT /api/articles/:id` | 更新文章 | 更新标题、内容等 |
| `DELETE /api/articles/:id` | 删除文章 | 同时更新usage_count |

## 数据库表结构

### distillations（蒸馏表）
```sql
- id: 主键
- keyword: 关键词（这是你要显示的）
- provider: AI提供商
- usage_count: 使用次数
- created_at: 创建时间
```

### topics（话题表）
```sql
- id: 主键
- distillation_id: 关联蒸馏ID
- question: 话题内容
- created_at: 创建时间
```

### articles（文章表）
```sql
- id: 主键
- title: 文章标题
- keyword: 文章关键词
- distillation_id: 关联的蒸馏ID（重要！）
- task_id: 关联的任务ID
- content: 文章内容
- image_url: 图片URL
- is_published: 是否发布
- created_at: 创建时间
```

### distillation_usage（使用记录表）
```sql
- id: 主键
- distillation_id: 蒸馏ID
- task_id: 任务ID
- article_id: 文章ID
- used_at: 使用时间
```

## 数据关联逻辑

### 文章生成时的数据保存

在 `articleGenerationService.ts` 的 `saveArticleWithUsageTracking` 方法中：

```typescript
// 1. 保存文章（包含distillation_id）
INSERT INTO articles 
  (title, keyword, distillation_id, task_id, content, image_url, provider) 
VALUES ($1, $2, $3, $4, $5, $6, $7)

// 2. 记录使用（在distillation_usage表）
INSERT INTO distillation_usage 
  (distillation_id, task_id, article_id, used_at) 
VALUES ($1, $2, $3, CURRENT_TIMESTAMP)

// 3. 更新使用次数
UPDATE distillations 
SET usage_count = usage_count + 1 
WHERE id = $1
```

### 文章列表查询时的数据关联

在 `article.ts` 路由的 `GET /api/articles` 中：

```sql
SELECT 
  a.id,
  a.title,
  a.keyword,
  a.distillation_id,
  d.keyword as distillation_keyword,  -- 通过JOIN获取蒸馏关键词
  a.task_id,
  ...
FROM articles a
LEFT JOIN distillations d ON a.distillation_id = d.id
```

## 可能的问题原因

### 1. 数据库关联问题
- `articles.distillation_id` 字段为空或错误
- `distillations` 表中的记录被删除

### 2. 前端显示问题
- 前端没有正确使用 `distillationKeyword` 字段
- 使用了错误的字段名

### 3. 数据迁移问题
- 旧数据没有 `distillation_id`
- 数据库schema更新不完整

## 如何修复

### 步骤1：运行测试脚本

```bash
./test-article-distillation-flow.sh
```

这个脚本会：
1. 获取蒸馏历史
2. 查看蒸馏详情
3. 查询相关文章
4. 验证数据一致性

### 步骤2：检查数据库

```sql
-- 检查文章的distillation_id是否正确
SELECT 
  a.id,
  a.keyword as article_keyword,
  a.distillation_id,
  d.keyword as distillation_keyword
FROM articles a
LEFT JOIN distillations d ON a.distillation_id = d.id
LIMIT 10;

-- 检查是否有文章的distillation_id为空
SELECT COUNT(*) 
FROM articles 
WHERE distillation_id IS NULL;
```

### 步骤3：检查前端代码

查看前端文章列表组件，确保使用了正确的字段：

```typescript
// 正确的做法
article.distillationKeyword  // 显示蒸馏结果的关键词

// 错误的做法
article.keyword  // 这是文章自己的关键词
```

## 总结

**好消息：所有需要的API都已经存在！**

你不需要创建新的API。问题可能出在：
1. 数据库中的关联数据不正确
2. 前端显示逻辑有误
3. 旧数据需要修复

运行测试脚本可以帮你快速定位问题所在。如果发现数据不一致，我可以帮你写一个数据修复脚本。
