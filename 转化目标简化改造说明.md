# 转化目标简化改造说明

## 📌 改造目标

解决文章生成时编造地址的问题，简化转化目标字段结构。

---

## 🎯 核心问题

**问题描述**: 
生成的文章会自己编造地址，即使知识库中有真实地址也不使用。

**根本原因**:
1. 转化目标表没有地址字段
2. 知识库内容没有包含转化目标信息
3. 提示词没有强制要求使用知识库中的地址

---

## ✅ 解决方案

### 方案概述
通过"数据库字段 + 知识库传递 + 提示词强制"的三重保障，彻底解决地址编造问题。

### 具体实施

#### 1. 数据库层面
- 新增 `address` 字段（varchar(500)，可选）
- 删除不必要的字段（company_size, features, contact_info, target_audience, core_products）
- 保留核心字段：company_name（必填）, industry, website, address（可选）

#### 2. 后端API层面
- 完全重写 `conversionTarget.ts` 路由
- 简化Zod验证schema，只保留4个字段
- 修复SQL参数占位符问题

#### 3. 文章生成服务层面
- 修改 `ArticleGenerationService.ts`
- 加载转化目标的4个字段（company_name, industry, website, address）
- 在知识库内容中包含转化目标信息：
  ```
  【转化目标信息】
  公司名称：xxx
  行业类型：xxx（如果有）
  官方网站：xxx（如果有）
  公司地址：xxx（如果有）
  ```

#### 4. 提示词模板层面
- 优化所有5个模板（BALANCED, PROFESSIONAL, MARKETING, NATIONAL_RANKING, REGIONAL_RANKING）
- 添加强制规则：
  - 如果知识库中包含地址，必须使用，不能编造
  - 如果字段为空，不要提及，不要编造
  - 绝对不能使用"xxx"占位符

#### 5. 前端页面层面
- 完全重写 `ConversionTargetPage.tsx`
- 简化表单，只有公司名称必填
- 新增地址字段（TextArea，可选）

---

## 📊 字段对比

### 之前（9个字段）
```
- company_name (必填)
- industry (必填)
- company_size (必填)
- features (必填)
- contact_info (必填)
- target_audience (必填)
- core_products (必填)
- website (可选)
- created_at, updated_at
```

### 现在（4个业务字段）
```
- company_name (必填)
- industry (可选)
- website (可选)
- address (可选)
- created_at, updated_at
```

---

## 🔄 数据流

### 文章生成时的数据流

```
1. 用户创建转化目标
   ↓
   保存到数据库（company_name, industry, website, address）

2. 用户生成文章
   ↓
   加载转化目标数据

3. 构建知识库内容
   ↓
   原始知识库内容 + 【转化目标信息】

4. 构建AI提示词
   ↓
   提示词模板 + 增强的知识库内容

5. AI生成文章
   ↓
   根据提示词要求，使用知识库中的地址（如果有）
   或不提及地址（如果没有）
```

---

## 🎨 使用场景

### 场景1: 有完整信息的转化目标
```
公司名称: 杭州鸥飞留学机构
行业类型: 教育
官方网站: https://www.oufei.com
公司地址: 杭州市西湖区教工路123号

→ 生成的文章会使用真实地址
```

### 场景2: 无地址的转化目标
```
公司名称: 某某科技公司
行业类型: 互联网
官方网站: https://www.example.com
公司地址: （空）

→ 生成的文章不会提及地址，不会编造
```

### 场景3: 最简转化目标
```
公司名称: ABC公司
行业类型: （空）
官方网站: （空）
公司地址: （空）

→ 生成的文章只提及公司名称
```

---

## 🛡️ 三重保障机制

### 保障1: 数据库字段
- 新增 `address` 字段存储真实地址
- 可选字段，用户可以不填

### 保障2: 知识库传递
- 在知识库内容中包含转化目标信息
- 只包含有值的字段
- 格式化为结构化信息

### 保障3: 提示词强制
- 明确要求使用知识库中的地址
- 明确要求不要编造信息
- 明确要求不要使用占位符

---

## 📝 提示词规则（所有模板）

```
【强制要求 - 使用转化目标信息】
知识库中包含转化目标的信息：
{knowledgeBase}

重要规则：
1. 如果知识库中包含"公司地址"，必须使用知识库中的准确地址，绝对不能编造
2. 如果知识库中包含"官方网站"、"行业类型"等信息，也必须使用知识库中的信息
3. 【关键】如果知识库中某个字段为空或不存在，就不要提及该信息，不要编造
4. 绝对不能使用"xxx"、"某某地址"等占位符
5. 如果没有某项信息，可以省略相关内容
```

---

## 🔧 技术实现细节

### 1. 数据库迁移
```sql
-- 添加地址字段
ALTER TABLE conversion_targets ADD COLUMN address VARCHAR(500);

-- 删除不需要的字段
ALTER TABLE conversion_targets DROP COLUMN company_size;
ALTER TABLE conversion_targets DROP COLUMN features;
ALTER TABLE conversion_targets DROP COLUMN contact_info;
ALTER TABLE conversion_targets DROP COLUMN target_audience;
ALTER TABLE conversion_targets DROP COLUMN core_products;

-- 修改字段约束
ALTER TABLE conversion_targets ALTER COLUMN industry DROP NOT NULL;
```

### 2. 后端API
```typescript
// Zod验证schema
const createSchema = z.object({
  companyName: z.string().min(2).max(255),
  industry: z.string().max(100).optional(),
  website: z.string().url().optional(),
  address: z.string().max(500).optional(),
});
```

### 3. 文章生成服务
```typescript
// 加载转化目标
const targetResult = await pool.query(
  'SELECT company_name, industry, website, address FROM conversion_targets WHERE id = $1',
  [task.conversionTargetId]
);

// 构建增强的知识库内容
if (companyName) {
  enhancedKnowledgeBase += `\n\n【转化目标信息】\n`;
  enhancedKnowledgeBase += `公司名称：${companyName}\n`;
  if (companyIndustry) enhancedKnowledgeBase += `行业类型：${companyIndustry}\n`;
  if (companyWebsite) enhancedKnowledgeBase += `官方网站：${companyWebsite}\n`;
  if (companyAddress) enhancedKnowledgeBase += `公司地址：${companyAddress}\n`;
}
```

---

## ✨ 改造亮点

1. **彻底解决地址编造问题**: 三重保障机制
2. **简化用户操作**: 只有公司名称必填
3. **向后兼容**: 保留旧数据和旧逻辑
4. **职责分离**: 格式在模板，数据在代码
5. **灵活性**: 用户可选择填写字段

---

## 📚 相关文档

- `转化目标简化改造-执行完成.md` - 完整的执行报告
- `转化目标简化改造-快速启动指南.md` - 快速测试指南
- `转化目标简化改造-当前进度.md` - 进度跟踪文档

---

## 🎉 总结

通过这次改造，我们：
- ✅ 彻底解决了地址编造问题
- ✅ 简化了转化目标字段结构
- ✅ 提升了用户体验（只需填写必要信息）
- ✅ 保持了系统的灵活性和可扩展性

**改造已全部完成，系统已准备就绪！** 🚀
