# 图片配置约束说明

## 🎯 问题

用户提问：图片的要求不在提示词中体现？你在哪里做约束控制的？

## 📋 回答

图片配置有**两层控制**：

### 1. 提示词层面（AI约束）

在提示词中明确告诉AI：
- ✅ 本文会配一张相关图片
- ✅ 图片会自动放在文章末尾
- ✅ 正文中不要写"如图所示"、"见下图"等内容
- ✅ 文章内容要完整，不依赖图片也能独立理解

**目的**：防止AI在文章中写"如下图所示"等内容，因为图片是后端自动添加的。

### 2. 代码层面（系统约束）

在后端代码中自动处理：
```typescript
// server/src/services/ArticleGenerationService.ts

// 1. 选择图片（均衡选择）
const imageData = await this.selectBalancedImage(task.albumId);

// 2. AI生成文章内容（不包含图片）
const result = await this.generateSingleArticle(...);

// 3. 系统自动在文章末尾插入图片
const contentWithImage = this.insertImageIntoContent(
  parsed.content,
  imageUrl
);
```

**目的**：确保每篇文章都有图片，且图片统一在末尾。

## 🔄 完整流程

```
1. 用户创建生成任务
   ↓
2. 系统从图库选择一张图片（使用次数最少的）
   ↓
3. 构建提示词（包含配图说明）
   ↓
4. AI生成文章内容（不包含图片，也不提及图片）
   ↓
5. 系统在文章末尾自动插入图片标记
   ↓
6. 保存文章，更新图片的usage_count
```

## 📝 提示词中的配图说明

### 三个模板都包含

```
【配图说明】
- 本文会配一张相关图片，图片会自动放在文章末尾
- 正文中不要写"如图所示"、"见下图"等提及图片的内容
- 文章内容要完整，不依赖图片也能独立理解
```

### 位置
- **平衡型模板**：在"写作要求"之后
- **重专业模板**：在"内容要求"之后
- **重营销模板**：在"内容要求"之后

## 💻 代码层面的约束

### 1. 图片选择（均衡算法）

```typescript
async selectBalancedImage(albumId: number): Promise<{ imageId: number; imageUrl: string } | null> {
  const imageService = new ImageSelectionService();
  const imageData = await imageService.selectLeastUsedImage(albumId);
  
  if (!imageData) {
    console.log(`[图片选择] 相册 ${albumId} 为空，返回null`);
    return null;
  }
  
  return {
    imageId: imageData.imageId,
    imageUrl: `/uploads/gallery/${imageData.filepath}`
  };
}
```

**特点**：
- 选择使用次数最少的图片
- 如果图库为空，使用默认占位图
- 返回图片ID和URL

### 2. 图片插入（固定位置）

```typescript
private insertImageIntoContent(
  content: string,
  imageUrl: string
): string {
  // 图片统一放在文章末尾
  return `${content}\n\n![文章配图](${imageUrl})`;
}
```

**特点**：
- 图片统一在文章末尾
- 使用Markdown格式
- 不会插入到文章中间

### 3. 使用记录（自动更新）

```typescript
// 保存文章时自动更新图片的usage_count
if (imageId) {
  await client.query(
    `UPDATE images 
     SET usage_count = COALESCE(usage_count, 0) + 1 
     WHERE id = $1`,
    [imageId]
  );
  
  await client.query(
    `INSERT INTO image_usage (image_id, article_id)
     VALUES ($1, $2)
     ON CONFLICT (image_id, article_id) DO NOTHING`,
    [imageId, articleId]
  );
}
```

**特点**：
- 自动更新usage_count
- 记录图片使用历史
- 支持并发安全

## 🎯 为什么需要两层控制？

### 提示词层面（必需）
如果不在提示词中说明，AI可能会：
- ❌ 写"如下图所示"，但实际没有图
- ❌ 写"见图1"，但图片在末尾
- ❌ 内容依赖图片，导致文章不完整

### 代码层面（必需）
如果不在代码中控制，会导致：
- ❌ 图片位置不统一
- ❌ 图片选择不均衡
- ❌ 使用次数不更新

## ✅ 修改后的效果

### 提示词告诉AI
```
【配图说明】
- 本文会配一张相关图片，图片会自动放在文章末尾
- 正文中不要写"如图所示"、"见下图"等提及图片的内容
- 文章内容要完整，不依赖图片也能独立理解
```

### AI生成的文章
```
标题：如何选择靠谱的英国留学机构

选择留学机构是一个重要决定...（正文内容）

总之，选择留学机构要综合考虑多方面因素...（结尾）
```

### 系统自动添加图片
```
标题：如何选择靠谱的英国留学机构

选择留学机构是一个重要决定...（正文内容）

总之，选择留学机构要综合考虑多方面因素...（结尾）

![文章配图](/uploads/gallery/image123.jpg)  ← 系统自动添加
```

## 📊 对比

### 之前（没有提示词约束）
```
AI可能生成：
"如下图所示，这些机构都很靠谱..."
↓
系统添加图片在末尾
↓
结果：文章中提到"如下图"，但图在最后，不匹配 ❌
```

### 现在（有提示词约束）
```
AI生成：
"这些机构都很靠谱，包括..."（不提及图片）
↓
系统添加图片在末尾
↓
结果：文章完整，图片作为补充，逻辑清晰 ✅
```

## 🔍 技术细节

### 执行顺序
1. **选择图片**（在生成文章之前）
2. **构建提示词**（包含配图说明）
3. **AI生成内容**（遵循配图说明）
4. **插入图片**（在内容末尾）
5. **保存文章**（更新使用次数）

### 关键代码位置
- 提示词模板：`client/src/constants/promptTemplates.ts`
- 默认拼接逻辑：`server/src/services/ArticleGenerationService.ts` - `buildPromptWithImageInstruction()`
- 图片选择：`server/src/services/ArticleGenerationService.ts` - `selectBalancedImage()`
- 图片插入：`server/src/services/ArticleGenerationService.ts` - `insertImageIntoContent()`
- 使用记录：`server/src/services/ArticleGenerationService.ts` - `saveArticleWithTopicTracking()`

## 🎉 总结

图片配置通过**两层约束**实现：

1. **提示词约束**（AI层面）
   - 告诉AI会配图
   - 告诉AI不要提及图片
   - 确保文章内容完整

2. **代码约束**（系统层面）
   - 自动选择图片（均衡算法）
   - 自动插入图片（固定位置）
   - 自动记录使用（更新次数）

这样确保：
- ✅ 每篇文章都有图片
- ✅ 图片位置统一（末尾）
- ✅ 图片选择均衡（使用次数）
- ✅ 文章内容完整（不依赖图片）

---

**修改时间**：2024年12月18日  
**修改文件**：
- `client/src/constants/promptTemplates.ts`
- `server/src/services/ArticleGenerationService.ts`
