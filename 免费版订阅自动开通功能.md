# 免费版订阅自动开通功能

## 功能概述

实现了两个核心功能：

1. **新用户注册自动开通**：用户注册成功后，自动为其开通免费版订阅
2. **现有用户批量重置**：为所有没有订阅的现有用户批量开通免费版订阅

## 功能特性

### 1. 新用户自动开通

- ✅ 注册成功后自动触发
- ✅ 开通免费版套餐（plan_code: 'free'）
- ✅ 有效期 1 年
- ✅ 自动初始化所有配额
- ✅ 自动初始化存储空间（100MB）
- ✅ 防止重复订阅
- ✅ 失败不影响注册流程

### 2. 批量重置现有用户

- ✅ 自动识别无订阅用户
- ✅ 批量开通免费版
- ✅ 清除旧配额记录
- ✅ 重新初始化配额
- ✅ 更新存储空间配额
- ✅ 详细的处理日志
- ✅ 统计成功/失败数量

## 免费版配额说明

根据当前系统配置，免费版包含以下配额：

| 功能 | 配额 | 周期 |
|------|------|------|
| 每月生成文章数 | 1 篇 | 每月重置 |
| 每月发布文章数 | 1 篇 | 每月重置 |
| 平台账号数 | 1 个 | 永久 |
| 关键词蒸馏数 | 1 个 | 每月重置 |
| 存储空间 | 10 MB | 永久 |

## 使用方法

### 方法 1: 新用户自动开通（已集成）

新用户注册时会自动触发，无需手动操作。

```bash
# 注册新用户时会自动执行
POST /api/auth/register
{
  "username": "newuser",
  "password": "password123"
}
```

### 方法 2: 批量重置现有用户

为所有没有订阅的现有用户开通免费版：

```bash
cd server
npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

输出示例：
```
========================================
为现有无订阅用户重置免费版配额
========================================

[FreeSubscription] 开始为现有无订阅用户重置免费版配额...
[FreeSubscription] 找到免费版套餐: 体验版 (ID: 1)
[FreeSubscription] 找到 5 个无订阅用户
[FreeSubscription] 处理用户: testuser1 (ID: 10)
[FreeSubscription] ✅ 用户 testuser1 处理成功 (订阅ID: 15)
...
[FreeSubscription] ✅ 批量处理完成: 总计 5, 成功 5, 失败 0

========================================
批量重置完成
========================================
总用户数: 5
成功: 5
失败: 0
========================================

✅ 所有用户处理成功
```

## 测试

运行完整的测试套件：

```bash
cd server
npx ts-node src/scripts/test-free-subscription.ts
```

测试内容：
1. ✅ 为新用户开通免费版订阅
2. ✅ 为现有无订阅用户批量重置
3. ✅ 防止重复订阅
4. ✅ 验证配额初始化
5. ✅ 验证存储空间初始化

## 技术实现

### 核心服务

**FreeSubscriptionService** (`server/src/services/FreeSubscriptionService.ts`)

主要方法：
- `activateFreeSubscriptionForNewUser(userId)` - 为新用户开通
- `resetExistingUsersToFree()` - 批量重置现有用户
- `initializeFreeQuotas()` - 初始化配额
- `initializeStorage()` - 初始化存储空间

### 集成点

**AuthService** (`server/src/services/AuthService.ts`)

在 `registerUser()` 方法中，用户注册成功后自动调用：

```typescript
// 为新用户自动开通免费版订阅
try {
  const { freeSubscriptionService } = await import('./FreeSubscriptionService');
  await freeSubscriptionService.activateFreeSubscriptionForNewUser(user.id);
} catch (error) {
  console.error(`[Auth] 为新用户开通免费版失败:`, error);
  // 不抛出错误，允许注册继续
}
```

### 数据库操作

1. **创建订阅记录**
   ```sql
   INSERT INTO user_subscriptions (user_id, plan_id, status, start_date, end_date, is_gift, gift_reason)
   VALUES (?, ?, 'active', NOW(), NOW() + INTERVAL '1 year', true, '新用户注册赠送')
   ```

2. **初始化配额**
   ```sql
   INSERT INTO user_usage (user_id, feature_code, usage_count, period_start, period_end)
   VALUES (?, ?, 0, ?, ?)
   ON CONFLICT (user_id, feature_code, period_start) DO UPDATE SET usage_count = 0
   ```

3. **初始化存储**
   ```sql
   INSERT INTO user_storage_usage (user_id, storage_quota_bytes, ...)
   VALUES (?, 104857600, ...)
   ON CONFLICT DO UPDATE SET storage_quota_bytes = 104857600
   ```

## 安全特性

1. **防止重复订阅**：检查用户是否已有活跃订阅
2. **事务保护**：使用数据库事务确保数据一致性
3. **错误隔离**：新用户开通失败不影响注册流程
4. **详细日志**：记录所有操作便于追踪和调试

## 监控和日志

所有操作都会输出详细日志：

```
[FreeSubscription] 开始为新用户 123 开通免费版订阅...
[FreeSubscription] 找到免费版套餐: 体验版 (ID: 1)
[FreeSubscription] ✅ 订阅创建成功 (ID: 456)
[FreeSubscription] 初始化用户 123 的配额...
[FreeSubscription] ✅ 成功初始化 5 项配额记录
[FreeSubscription] 初始化用户 123 的存储空间...
[FreeSubscription] ✅ 创建存储记录，配额 104857600 bytes
[FreeSubscription] ✅ 用户 123 免费版订阅开通完成
```

## 常见问题

### Q1: 如果免费版套餐不存在怎么办？

A: 系统会抛出错误 "免费版套餐不存在或未激活"。请确保数据库中存在 `plan_code = 'free'` 且 `is_active = true` 的套餐。

### Q2: 用户已有订阅会怎样？

A: 系统会检测到并跳过，不会创建重复订阅。

### Q3: 批量重置会影响已有订阅的用户吗？

A: 不会。批量重置只处理没有活跃订阅的用户。

### Q4: 如果开通失败会影响注册吗？

A: 不会。新用户开通失败只会记录日志，不会影响注册流程。

### Q5: 如何修改免费版配额？

A: 修改 `plan_features` 表中 `plan_code = 'free'` 的记录即可。

## 后续优化建议

1. **通知功能**：开通成功后发送欢迎邮件或站内通知
2. **统计分析**：记录开通成功率、失败原因等
3. **配额提醒**：接近配额上限时提醒用户升级
4. **自动续期**：免费版到期前自动续期
5. **A/B 测试**：测试不同的免费版配额对转化率的影响

## 相关文件

- `server/src/services/FreeSubscriptionService.ts` - 核心服务
- `server/src/services/AuthService.ts` - 注册集成
- `server/src/scripts/reset-users-to-free-subscription.ts` - 批量重置脚本
- `server/src/scripts/test-free-subscription.ts` - 测试脚本
- `server/src/db/migrations/archive/001_create_subscription_tables.sql` - 套餐初始化

## 更新日志

### 2026-01-05
- ✅ 实现新用户注册自动开通免费版
- ✅ 实现现有用户批量重置功能
- ✅ 添加完整的测试套件
- ✅ 集成到注册流程
- ✅ 添加详细文档
