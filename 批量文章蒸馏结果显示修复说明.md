# 批量文章蒸馏结果显示修复说明

## 问题描述

在生成文章模块中，当一次性生成大于1篇的文章时，任务列表的"蒸馏结果"列不能显示每篇文章对应的话题。之前的实现使用了 `STRING_AGG(DISTINCT ...)` 进行去重，导致多篇文章使用不同话题时，只显示去重后的话题列表，无法区分每篇文章对应哪个话题。

## 解决方案

### 1. 后端修改（`server/src/services/articleGenerationService.ts`）

**修改位置：** `getTasks()` 方法中的SQL查询

**修改前：**
```sql
SELECT STRING_AGG(DISTINCT t.question, ', ' ORDER BY t.question)
FROM articles a
INNER JOIN topics t ON a.topic_id = t.id
WHERE a.task_id = gt.id
```

**修改后：**
```sql
SELECT STRING_AGG(t.question, '|||' ORDER BY a.id)
FROM articles a
INNER JOIN topics t ON a.topic_id = t.id
WHERE a.task_id = gt.id
```

**关键变化：**
- 移除了 `DISTINCT` 关键字，保留每篇文章的话题（即使话题相同）
- 将分隔符从 `, ` 改为 `|||`，避免与话题内容中的逗号冲突
- 按 `a.id` 排序，确保话题按文章创建顺序显示

### 2. 前端修改（`client/src/pages/ArticleGenerationPage.tsx`）

**修改位置：** 任务列表表格的"蒸馏结果"列渲染逻辑

**修改前：**
```typescript
// 按逗号分隔话题
const topics = text.split(',').map(t => t.trim()).filter(t => t.length > 0);
```

**修改后：**
```typescript
// 使用新的分隔符|||来分割每篇文章的话题
const topics = text.split('|||').map(t => t.trim()).filter(t => t.length > 0);

// 多个话题：每行一个，显示文章序号
return (
  <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
    {topics.map((topic, index) => (
      <div key={index} style={{ display: 'flex', alignItems: 'flex-start', gap: 4 }}>
        <span style={{ fontSize: 12, color: '#999', minWidth: 20 }}>
          {index + 1}.
        </span>
        <Tag color="cyan" style={{ ... }}>
          {topic}
        </Tag>
      </div>
    ))}
  </div>
);
```

**关键变化：**
- 使用 `|||` 作为分隔符来分割话题
- 为每个话题添加序号（1. 2. 3. ...），清晰标识每篇文章
- 每个话题独占一行，便于阅读

## 显示效果

### 单篇文章
```
蒸馏结果
┌─────────────────────────┐
│ 如何提高工作效率？      │
└─────────────────────────┘
```

### 多篇文章（3篇）
```
蒸馏结果
┌─────────────────────────┐
│ 1. 如何提高工作效率？   │
│ 2. 时间管理的重要性     │
│ 3. 高效工作的5个技巧    │
└─────────────────────────┘
```

每一行对应一篇文章使用的话题，序号表示文章的生成顺序。

## 测试方法

### 1. 运行测试脚本
```bash
./test-multi-article-distillation-display.sh
```

### 2. 手动测试步骤

1. **创建生成任务**
   - 进入"文章生成"页面
   - 点击"新建任务"
   - 选择一个蒸馏结果（有多个话题）
   - 设置生成数量为 3 篇或更多
   - 提交任务

2. **查看任务列表**
   - 等待任务完成
   - 在任务列表中查看"蒸馏结果"列
   - 应该看到每篇文章的话题独占一行
   - 每行前面有序号（1. 2. 3. ...）

3. **验证数据正确性**
   - 点击"查看文章"按钮
   - 在文章列表中查看每篇文章的话题
   - 确认话题与任务列表中显示的顺序一致

## 技术细节

### 为什么使用 `|||` 作为分隔符？

1. **避免冲突**：话题内容可能包含逗号、分号等常见标点符号
2. **易于识别**：`|||` 在正常文本中很少出现
3. **易于分割**：JavaScript 的 `split()` 方法可以直接处理

### SQL 排序说明

使用 `ORDER BY a.id` 而不是 `ORDER BY a.created_at` 的原因：
- `id` 是自增主键，保证了严格的顺序
- `created_at` 可能存在毫秒级的时间戳相同的情况
- `id` 的排序性能更好

### 前端显示优化

1. **序号显示**：使用 `minWidth: 20` 确保序号对齐
2. **自动换行**：使用 `wordBreak: 'break-word'` 和 `whiteSpace: 'normal'` 处理长话题
3. **间距控制**：使用 `gap: 4` 在话题之间添加适当间距

## 兼容性说明

### 向后兼容

- 旧任务（使用逗号分隔的）仍然可以正常显示
- 新任务使用新的分隔符 `|||`
- 前端代码只需要修改分隔符即可兼容

### 数据库影响

- 不需要修改数据库结构
- 不需要迁移历史数据
- 只是改变了查询逻辑

## 相关文件

- `server/src/services/articleGenerationService.ts` - 后端服务
- `client/src/pages/ArticleGenerationPage.tsx` - 前端页面
- `test-multi-article-distillation-display.sh` - 测试脚本

## 完成时间

2024年12月15日
