# 图片均衡选择功能实现说明

## 功能概述

在生成文章页面生成文章时，系统会从用户选择的相册中**均衡调用**图片，避免同一张图片被反复使用。

## 实现原理

### 1. 选择策略

类似于话题轮换机制，图片选择采用以下策略：

- **优先选择使用次数最少的图片**
- 如果有多张图片使用次数相同，按**创建时间升序**选择（先上传的先用）
- 每次使用后自动更新图片的 `usage_count`

### 2. 数据库设计

#### images表新增字段

```sql
ALTER TABLE images 
ADD COLUMN usage_count INTEGER DEFAULT 0;
```

- `usage_count`: 记录图片被用于生成文章的次数

#### 新增image_usage表

```sql
CREATE TABLE image_usage (
  id SERIAL PRIMARY KEY,
  image_id INTEGER NOT NULL REFERENCES images(id) ON DELETE CASCADE,
  article_id INTEGER NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
  used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(image_id, article_id)
);
```

- 记录每张图片被哪些文章使用
- 防止重复记录（通过UNIQUE约束）

#### 索引优化

```sql
-- 优化图片选择查询
CREATE INDEX idx_images_usage_count 
ON images(album_id, usage_count ASC, created_at ASC);

-- 优化使用记录查询
CREATE INDEX idx_image_usage_image_id ON image_usage(image_id);
CREATE INDEX idx_image_usage_article_id ON image_usage(article_id);
```

## 核心服务

### ImageSelectionService

新增的图片选择服务，提供以下功能：

#### 1. selectLeastUsedImage(albumId)

从指定相册中选择使用次数最少的图片。

```typescript
const imageData = await imageService.selectLeastUsedImage(albumId);
// 返回: { imageId, filepath, usageCount }
```

#### 2. recordImageUsage(imageId, articleId)

记录图片使用并更新使用次数。

```typescript
await imageService.recordImageUsage(imageId, articleId);
```

#### 3. getImageUsageStats(albumId)

获取相册中所有图片的使用统计。

```typescript
const stats = await imageService.getImageUsageStats(albumId);
// 返回每张图片的使用次数和最后使用时间
```

#### 4. resetAlbumUsageCount(albumId)

重置相册中所有图片的使用计数。

```typescript
await imageService.resetAlbumUsageCount(albumId);
```

## 文章生成流程更新

### ArticleGenerationService

#### 1. 新增方法：selectBalancedImage()

替代原来的 `selectRandomImage()` 方法：

```typescript
// 旧方法（随机选择）
const imageUrl = await this.selectRandomImage(albumId);

// 新方法（均衡选择）
const imageData = await this.selectBalancedImage(albumId);
// 返回: { imageId, imageUrl } 或 null
```

#### 2. 更新保存文章方法

`saveArticleWithTopicTracking()` 和 `saveArticleWithUsageTracking()` 方法新增 `imageId` 参数：

```typescript
await this.saveArticleWithTopicTracking(
  taskId,
  distillationId,
  topicId,
  keyword,
  title,
  content,
  imageUrl,
  provider,
  imageId  // 新增参数
);
```

在事务中同时更新：
- 话题使用次数
- 蒸馏结果使用次数
- **图片使用次数**（新增）

## 使用示例

### 生成文章时的完整流程

```typescript
// 1. 选择使用次数最少的图片
const imageData = await this.selectBalancedImage(task.albumId);

let imageUrl: string;
let imageId: number | undefined;

if (imageData) {
  imageUrl = imageData.imageUrl;
  imageId = imageData.imageId;
  console.log(`选择图片: ID=${imageId}, URL=${imageUrl}`);
} else {
  // 图库为空，使用默认占位图片
  imageUrl = '/uploads/gallery/placeholder.png';
}

// 2. 生成文章
const result = await this.generateSingleArticle(...);

// 3. 保存文章并记录图片使用
const articleId = await this.saveArticleWithTopicTracking(
  ...,
  imageUrl,
  provider,
  imageId  // 传入图片ID
);
```

## 部署步骤

### 1. 运行数据库迁移

```bash
cd server
npm run migrate:image-usage
```

或手动运行：

```bash
npx ts-node src/db/migrate-image-usage-tracking.ts
```

### 2. 验证迁移结果

```bash
./test-image-balanced-selection.sh
```

### 3. 重启服务

```bash
npm run dev
```

## 测试验证

### 1. 查看图片使用统计

```sql
SELECT 
  i.id,
  i.filename,
  i.album_id,
  i.usage_count,
  (SELECT COUNT(*) FROM image_usage WHERE image_id = i.id) as usage_records
FROM images i
ORDER BY i.album_id, i.usage_count ASC;
```

### 2. 生成多篇文章测试

1. 创建一个包含多张图片的相册
2. 创建生成任务，生成多篇文章
3. 观察图片使用统计，验证是否均衡

### 3. 预期结果

- 每张图片的 `usage_count` 应该大致相同
- 使用次数最少的图片会被优先选择
- 不会出现某张图片被反复使用的情况

## 向后兼容

- 保留了 `selectRandomImage()` 方法，标记为 `@deprecated`
- 旧的文章生成逻辑仍然可以正常工作
- 新功能不影响现有数据

## 性能优化

### 索引优化

```sql
CREATE INDEX idx_images_usage_count 
ON images(album_id, usage_count ASC, created_at ASC);
```

这个复合索引确保图片选择查询的高效执行：

```sql
SELECT id, filepath, usage_count
FROM images
WHERE album_id = $1
ORDER BY usage_count ASC, created_at ASC
LIMIT 1;
```

### 事务处理

图片使用记录和文章保存在同一个事务中，确保数据一致性：

```typescript
await client.query('BEGIN');
// 1. 保存文章
// 2. 记录蒸馏使用
// 3. 记录话题使用
// 4. 记录图片使用 ← 新增
await client.query('COMMIT');
```

## 监控和维护

### 查看相册图片使用分布

```sql
SELECT 
  a.name as album_name,
  i.filename,
  i.usage_count,
  ROUND(i.usage_count * 100.0 / NULLIF(SUM(i.usage_count) OVER (PARTITION BY a.id), 0), 2) as usage_percentage
FROM images i
JOIN albums a ON i.album_id = a.id
ORDER BY a.id, i.usage_count DESC;
```

### 重置使用计数

如果需要重置某个相册的图片使用计数：

```typescript
const imageService = new ImageSelectionService();
await imageService.resetAlbumUsageCount(albumId);
```

## 总结

通过实现图片均衡选择功能，系统能够：

✅ 避免同一张图片被反复使用  
✅ 确保相册中所有图片都有机会被使用  
✅ 提供使用统计和监控能力  
✅ 保持与话题轮换机制的一致性  
✅ 保证数据一致性和性能

这个功能与现有的话题轮换机制完美配合，共同提升了文章生成的质量和多样性。
