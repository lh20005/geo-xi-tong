# 立即测试发布功能

## 刚才的修复

### 问题1: Cookie登录验证失败
- **原因**: 使用 `.user-avatar` 选择器验证，但元素可能不存在或加载慢
- **修复**: 改用URL检查（更可靠）

### 问题2: 没有看到自动发布操作
- **原因**: 发布流程中选择器可能不正确
- **修复**: 
  - 添加多个备用选择器
  - 增加详细日志输出
  - 如果找不到按钮，等待10秒供手动操作

### 问题3: 浏览器刷新两次
- **原因**: `loginWithCookies` 方法中调用了 `page.reload()`
- **说明**: 这是正常的，第一次设置Cookie，第二次刷新应用Cookie

## 现在的流程

```
1. 启动浏览器 ✅
2. 导航到 https://mp.toutiao.com ✅
3. 设置30个Cookie ✅
4. 刷新页面应用Cookie ✅
5. 检查URL验证登录（不再依赖元素选择器）✅
6. 导航到发布页面 ✅
7. 查找标题输入框（多个备用选择器）✅
8. 输入标题 ✅
9. 查找内容编辑器（多个备用选择器）✅
10. 输入内容 ✅
11. 查找并点击发布按钮 ✅
12. 等待发布完成 ✅
```

## 立即测试

### 1. 服务器会自动重载

使用 `tsx watch`，代码已自动重载。

### 2. 创建新任务并执行

```bash
# 方法1: 通过界面
# 访问 http://localhost:5173/publishing-tasks
# 创建新任务并点击"执行"

# 方法2: 通过API（快速测试）
curl -X POST http://localhost:3000/api/publishing/tasks/4/execute
```

### 3. 观察浏览器

现在应该看到：

1. ✅ 浏览器弹出
2. ✅ 导航到头条号主页
3. ✅ 页面刷新（应用Cookie）
4. ✅ 显示已登录状态
5. ✅ 导航到发布页面
6. ✅ **自动输入标题**
7. ✅ **自动输入内容**
8. ✅ **自动点击发布按钮**（或等待10秒供手动点击）

### 4. 查看控制台日志

服务器终端应该显示：

```
[头条号] 使用Cookie登录
[Cookie登录] 开始设置 30 个Cookie
[Cookie登录] Cookie设置成功
[Cookie登录] 页面刷新完成
[头条号] Cookie已设置，等待3秒让页面加载...
[头条号] 当前URL: https://mp.toutiao.com/...
✅ 头条号Cookie登录成功
[头条号] 开始发布文章
[头条号] 当前URL: https://mp.toutiao.com/profile_v4/graphic/publish
[头条号] 等待标题输入框: input[placeholder="填写标题"]
[头条号] 找到标题输入框
[头条号] 输入标题: xxx
[头条号] 等待内容编辑器: .ql-editor
[头条号] 找到内容编辑器
[头条号] 输入文章内容
[头条号] 查找发布按钮
[头条号] 找到发布按钮: button.publish
[头条号] 已点击发布按钮，等待5秒
✅ 头条号文章发布流程完成
```

### 5. 查看任务日志

```bash
# 获取最新任务ID
TASK_ID=$(curl -s http://localhost:3000/api/publishing/tasks | jq -r '.data.tasks[0].id')

# 查看日志
curl -s http://localhost:3000/api/publishing/tasks/$TASK_ID/logs | jq -r '.data[] | "\(.created_at) [\(.level)] \(.message)"'
```

## 如果还有问题

### 问题A: 仍然看不到自动输入

**可能原因**: 选择器不匹配

**解决**: 
1. 浏览器会等待10秒
2. 在这10秒内，查看浏览器控制台
3. 手动检查页面元素
4. 告诉我实际的选择器

### 问题B: Cookie登录失败

**可能原因**: Cookie已过期

**解决**:
1. 访问 http://localhost:5173/platform-login
2. 重新登录头条号
3. 保存新的Cookie
4. 重试发布任务

### 问题C: 找不到发布按钮

**说明**: 代码会等待10秒供手动操作

**操作**:
1. 在10秒内手动点击发布按钮
2. 观察按钮的class或id
3. 告诉我，我会更新选择器

## 调试技巧

### 1. 增加等待时间

如果操作太快，可以临时增加等待时间：

```typescript
// 在 ToutiaoAdapter.ts 的 performPublish 方法中
await this.waitForPageLoad(page, 10000); // 改为10秒
```

### 2. 截图调试

在关键步骤添加截图：

```typescript
await page.screenshot({ path: `debug-step-1.png`, fullPage: true });
```

### 3. 查看页面HTML

```typescript
const html = await page.content();
console.log(html);
```

## 重要提示

### 浏览器不会立即关闭

修改后的代码会：
1. 输入标题和内容
2. 点击发布按钮
3. 等待5秒
4. 如果找不到按钮，等待10秒供手动操作

### 如果需要更长时间

可以在代码中增加等待时间，或者在finally块中添加延迟：

```typescript
// PublishingExecutor.ts 的 finally 块
finally {
  // 等待30秒再关闭，方便观察
  await new Promise(resolve => setTimeout(resolve, 30000));
  
  if (page) {
    await browserAutomationService.closePage(page);
  }
  await browserAutomationService.closeBrowser();
}
```

## 下一步

1. 立即测试新任务
2. 观察浏览器操作
3. 查看服务器日志
4. 如果有问题，告诉我具体现象
5. 我会根据实际情况调整选择器

## 快速测试命令

```bash
# 1. 查看最新任务
curl -s http://localhost:3000/api/publishing/tasks | jq '.data.tasks[0]'

# 2. 执行任务
curl -X POST http://localhost:3000/api/publishing/tasks/4/execute

# 3. 实时查看日志（每2秒刷新）
watch -n 2 'curl -s http://localhost:3000/api/publishing/tasks/4/logs | jq -r ".data[] | \"\(.created_at) [\(.level)] \(.message)\"" | tail -20'
```
