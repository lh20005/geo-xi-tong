# ğŸ“ å°çº¢ä¹¦å½•åˆ¶è„šæœ¬åˆ†æå’Œä¼˜åŒ–

## åŸå§‹å½•åˆ¶è„šæœ¬

```typescript
import { test, expect } from '@playwright/test';

test('test', async ({ page }) => {
  await page.getByText('å‘å¸ƒç¬”è®°').click();
  await page.getByText('ä¸Šä¼ å›¾æ–‡').nth(1).click();
  await page.getByRole('button', { name: 'Choose File' }).click();
  await page.getByRole('button', { name: 'Choose File' }).setInputFiles('ç”Ÿæˆè£…ä¿®å…¬å¸ç°åœºç…§ç‰‡ (2)å¤§.png');
  await page.getByRole('textbox', { name: 'å¡«å†™æ ‡é¢˜ä¼šæœ‰æ›´å¤šèµå“¦ï½' }).click();
  await page.getByRole('textbox', { name: 'å¡«å†™æ ‡é¢˜ä¼šæœ‰æ›´å¤šèµå“¦ï½' }).fill('æ²™å‘æ˜¯æ”¾æ¾æ”¾æ¾æ”¾æ¾æ”¾æ¾å‘æ’’');
  await page.getByRole('paragraph').filter({ hasText: /^$/ }).click();
  await page.getByRole('textbox').nth(1).fill('æ²™å‘æ˜¯åˆ†ç®—æ³•ç®—æ³•æ˜¯å‘é€');
  await page.getByRole('button', { name: 'å‘å¸ƒ' }).click();
  await page.goto('https://creator.xiaohongshu.com/publish/publish?source=&published=true');
});
```

---

## âœ… è„šæœ¬åˆ†æ

### ä¼˜ç‚¹
- âœ… å®Œæ•´è®°å½•äº†å‘å¸ƒæµç¨‹
- âœ… ä½¿ç”¨äº†ç¨³å®šçš„é€‰æ‹©å™¨ï¼ˆroleã€textï¼‰
- âœ… åŒ…å«äº†å›¾ç‰‡ä¸Šä¼ 
- âœ… åŒ…å«äº†æ ‡é¢˜å’Œå†…å®¹å¡«å†™

### éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹

1. **é‡å¤çš„ç‚¹å‡»æ“ä½œ**
   ```typescript
   await page.getByRole('button', { name: 'Choose File' }).click();
   await page.getByRole('button', { name: 'Choose File' }).setInputFiles('...');
   ```
   â†’ å¯ä»¥åˆå¹¶ï¼Œä¸éœ€è¦å…ˆç‚¹å‡»

2. **ç¡¬ç¼–ç çš„æ–‡ä»¶å**
   ```typescript
   .setInputFiles('ç”Ÿæˆè£…ä¿®å…¬å¸ç°åœºç…§ç‰‡ (2)å¤§.png');
   ```
   â†’ éœ€è¦æ”¹ä¸ºåŠ¨æ€çš„æ–‡ç« å›¾ç‰‡

3. **ç¡¬ç¼–ç çš„æ–‡æœ¬å†…å®¹**
   ```typescript
   .fill('æ²™å‘æ˜¯æ”¾æ¾æ”¾æ¾æ”¾æ¾æ”¾æ¾å‘æ’’');
   ```
   â†’ éœ€è¦æ”¹ä¸ºåŠ¨æ€çš„æ–‡ç« æ ‡é¢˜å’Œå†…å®¹

4. **ä¸ç¨³å®šçš„é€‰æ‹©å™¨**
   ```typescript
   await page.getByRole('textbox').nth(1).fill('...');
   ```
   â†’ ä½¿ç”¨ç´¢å¼•ä¸å¤Ÿç¨³å®š

5. **æµ‹è¯•æ¡†æ¶ä»£ç **
   ```typescript
   import { test, expect } from '@playwright/test';
   test('test', async ({ page }) => {
   ```
   â†’ éœ€è¦æ”¹ä¸ºé€‚é…å™¨æ ¼å¼

---

## ğŸ”§ ä¼˜åŒ–åçš„é€‚é…å™¨ä»£ç 

```typescript
// server/src/services/adapters/XiaohongshuAdapter.ts
import { Page } from 'playwright';
import { PlatformAdapter } from './PlatformAdapter';
import { Article, PublishingConfig } from '../../types';
import path from 'path';

export class XiaohongshuAdapter extends PlatformAdapter {
  platformId = 'xiaohongshu';
  platformName = 'å°çº¢ä¹¦';

  getLoginUrl(): string {
    return 'https://creator.xiaohongshu.com/login';
  }

  getPublishUrl(): string {
    return 'https://creator.xiaohongshu.com/publish/publish';
  }

  async performLogin(page: Page, credentials: any): Promise<boolean> {
    try {
      // Cookie ç™»å½•
      if (credentials.cookies && credentials.cookies.length > 0) {
        await page.goto(this.getPublishUrl());
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        const isLoggedIn = await page.getByText('å‘å¸ƒç¬”è®°').isVisible({ timeout: 5000 }).catch(() => false);
        if (isLoggedIn) {
          await this.log('info', 'Cookie ç™»å½•æˆåŠŸ');
          return true;
        }
      }

      // å¦‚æœ Cookie ç™»å½•å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨ç™»å½•
      await this.log('warning', 'éœ€è¦æ‰‹åŠ¨ç™»å½•');
      return false;
    } catch (error: any) {
      await this.log('error', 'ç™»å½•å¤±è´¥', { error: error.message });
      return false;
    }
  }

  async performPublish(page: Page, article: Article, config: PublishingConfig): Promise<boolean> {
    try {
      await this.log('info', 'å¼€å§‹å‘å¸ƒå°çº¢ä¹¦ç¬”è®°');

      // 1. å¯¼èˆªåˆ°å‘å¸ƒé¡µé¢
      await page.goto(this.getPublishUrl());
      await page.waitForTimeout(2000);

      // 2. ç‚¹å‡»"å‘å¸ƒç¬”è®°"
      await this.log('info', 'ç‚¹å‡»å‘å¸ƒç¬”è®°');
      await page.getByText('å‘å¸ƒç¬”è®°').click();
      await page.waitForTimeout(1000);

      // 3. é€‰æ‹©"ä¸Šä¼ å›¾æ–‡"
      await this.log('info', 'é€‰æ‹©ä¸Šä¼ å›¾æ–‡');
      await page.getByText('ä¸Šä¼ å›¾æ–‡').nth(1).click();
      await page.waitForTimeout(1000);

      // 4. ä¸Šä¼ å›¾ç‰‡
      if (article.coverImage) {
        await this.log('info', 'ä¸Šä¼ å°é¢å›¾ç‰‡', { image: article.coverImage });
        
        // ç›´æ¥è®¾ç½®æ–‡ä»¶ï¼Œä¸éœ€è¦å…ˆç‚¹å‡»
        const imagePath = this.resolveImagePath(article.coverImage);
        await page.getByRole('button', { name: 'Choose File' }).setInputFiles(imagePath);
        await page.waitForTimeout(2000);
      } else {
        await this.log('warning', 'æ²¡æœ‰å°é¢å›¾ç‰‡');
      }

      // 5. å¡«å†™æ ‡é¢˜
      await this.log('info', 'å¡«å†™æ ‡é¢˜', { title: article.title });
      const titleInput = page.getByRole('textbox', { name: 'å¡«å†™æ ‡é¢˜ä¼šæœ‰æ›´å¤šèµå“¦ï½' });
      await titleInput.click();
      await titleInput.fill(article.title);
      await page.waitForTimeout(500);

      // 6. å¡«å†™å†…å®¹
      await this.log('info', 'å¡«å†™å†…å®¹');
      const cleanContent = this.cleanArticleContent(article.content);
      
      // ç‚¹å‡»å†…å®¹åŒºåŸŸ
      await page.getByRole('paragraph').filter({ hasText: /^$/ }).click();
      await page.waitForTimeout(500);
      
      // å¡«å†™å†…å®¹ï¼ˆä½¿ç”¨æ›´ç¨³å®šçš„é€‰æ‹©å™¨ï¼‰
      const contentInput = page.getByRole('textbox').nth(1);
      await contentInput.fill(cleanContent);
      await page.waitForTimeout(1000);

      // 7. ç‚¹å‡»å‘å¸ƒ
      await this.log('info', 'ç‚¹å‡»å‘å¸ƒæŒ‰é’®');
      await page.getByRole('button', { name: 'å‘å¸ƒ' }).click();
      
      // 8. ç­‰å¾…å‘å¸ƒå®Œæˆ
      await page.waitForTimeout(3000);
      
      // æ£€æŸ¥æ˜¯å¦è·³è½¬åˆ°æˆåŠŸé¡µé¢
      const currentUrl = page.url();
      if (currentUrl.includes('published=true')) {
        await this.log('success', 'å‘å¸ƒæˆåŠŸ');
        return true;
      }

      await this.log('warning', 'å‘å¸ƒå¯èƒ½æœªæˆåŠŸï¼Œè¯·æ£€æŸ¥');
      return false;

    } catch (error: any) {
      await this.log('error', 'å‘å¸ƒå¤±è´¥', { error: error.message });
      
      // æˆªå›¾ä¿å­˜é”™è¯¯çŠ¶æ€
      try {
        await page.screenshot({ 
          path: `error-xiaohongshu-${Date.now()}.png` 
        });
      } catch (e) {
        // å¿½ç•¥æˆªå›¾é”™è¯¯
      }
      
      return false;
    }
  }

  /**
   * è§£æå›¾ç‰‡è·¯å¾„
   */
  private resolveImagePath(imagePath: string): string {
    // å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥è¿”å›
    if (path.isAbsolute(imagePath)) {
      return imagePath;
    }
    
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥ä¸ºç»å¯¹è·¯å¾„
    return path.resolve(process.cwd(), imagePath);
  }

  /**
   * æ¸…ç†æ–‡ç« å†…å®¹
   */
  private cleanArticleContent(content: string): string {
    // ç§»é™¤ HTML æ ‡ç­¾
    let cleaned = content.replace(/<[^>]*>/g, '');
    
    // ç§»é™¤å¤šä½™çš„ç©ºç™½
    cleaned = cleaned.replace(/\s+/g, ' ').trim();
    
    // å°çº¢ä¹¦å†…å®¹é•¿åº¦é™åˆ¶ï¼ˆ1000å­—ï¼‰
    if (cleaned.length > 1000) {
      cleaned = cleaned.substring(0, 997) + '...';
    }
    
    return cleaned;
  }
}
```

---

## ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹

### 1. ç§»é™¤é‡å¤æ“ä½œ

**åŸå§‹ä»£ç ï¼š**
```typescript
await page.getByRole('button', { name: 'Choose File' }).click();
await page.getByRole('button', { name: 'Choose File' }).setInputFiles('...');
```

**ä¼˜åŒ–åï¼š**
```typescript
await page.getByRole('button', { name: 'Choose File' }).setInputFiles(imagePath);
```

### 2. åŠ¨æ€å†…å®¹æ›¿æ¢

**åŸå§‹ä»£ç ï¼š**
```typescript
.fill('æ²™å‘æ˜¯æ”¾æ¾æ”¾æ¾æ”¾æ¾æ”¾æ¾å‘æ’’');
```

**ä¼˜åŒ–åï¼š**
```typescript
.fill(article.title);
```

### 3. æ·»åŠ æ—¥å¿—å’Œé”™è¯¯å¤„ç†

```typescript
try {
  await this.log('info', 'å¼€å§‹å‘å¸ƒ');
  // ... å‘å¸ƒé€»è¾‘
  await this.log('success', 'å‘å¸ƒæˆåŠŸ');
  return true;
} catch (error: any) {
  await this.log('error', 'å‘å¸ƒå¤±è´¥', { error: error.message });
  await page.screenshot({ path: `error-${Date.now()}.png` });
  return false;
}
```

### 4. æ·»åŠ ç­‰å¾…æ—¶é—´

```typescript
// ç­‰å¾…é¡µé¢åŠ è½½
await page.waitForTimeout(2000);

// ç­‰å¾…ä¸Šä¼ å®Œæˆ
await page.waitForTimeout(2000);
```

### 5. éªŒè¯å‘å¸ƒç»“æœ

```typescript
// æ£€æŸ¥ URL æ˜¯å¦åŒ…å«æˆåŠŸæ ‡å¿—
const currentUrl = page.url();
if (currentUrl.includes('published=true')) {
  await this.log('success', 'å‘å¸ƒæˆåŠŸ');
  return true;
}
```

---

## ğŸ“‹ ä½¿ç”¨æ­¥éª¤

### 1. åˆ›å»ºé€‚é…å™¨æ–‡ä»¶

```bash
# åˆ›å»ºæ–‡ä»¶
touch server/src/services/adapters/XiaohongshuAdapter.ts
```

### 2. å¤åˆ¶ä¼˜åŒ–åçš„ä»£ç 

å°†ä¸Šé¢çš„ä¼˜åŒ–ä»£ç å¤åˆ¶åˆ° `XiaohongshuAdapter.ts`

### 3. æ³¨å†Œé€‚é…å™¨

```typescript
// server/src/services/adapters/AdapterRegistry.ts
import { XiaohongshuAdapter } from './XiaohongshuAdapter';

private registerDefaultAdapters(): void {
  this.register(new XiaohongshuAdapter());
  // ... å…¶ä»–é€‚é…å™¨
}
```

### 4. æµ‹è¯•é€‚é…å™¨

```bash
# é‡å¯æœåŠ¡å™¨
npm run dev
```

---

## ğŸ” éœ€è¦æ³¨æ„çš„é—®é¢˜

### 1. å›¾ç‰‡ä¸Šä¼ è·¯å¾„

```typescript
// ç¡®ä¿å›¾ç‰‡è·¯å¾„æ­£ç¡®
const imagePath = this.resolveImagePath(article.coverImage);
```

### 2. å†…å®¹é•¿åº¦é™åˆ¶

```typescript
// å°çº¢ä¹¦é™åˆ¶ 1000 å­—
if (cleaned.length > 1000) {
  cleaned = cleaned.substring(0, 997) + '...';
}
```

### 3. é€‰æ‹©å™¨ç¨³å®šæ€§

```typescript
// ä¸ç¨³å®šï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
await page.getByRole('textbox').nth(1).fill('...');

// æ›´ç¨³å®šï¼ˆä½¿ç”¨ placeholderï¼‰
await page.getByRole('textbox', { name: 'å¡«å†™æ ‡é¢˜ä¼šæœ‰æ›´å¤šèµå“¦ï½' }).fill('...');
```

### 4. Cookie ç™»å½•

```typescript
// ä¼˜å…ˆä½¿ç”¨ Cookie ç™»å½•
if (credentials.cookies && credentials.cookies.length > 0) {
  await page.goto(this.getPublishUrl());
  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
}
```

---

## âœ… æ€»ç»“

### åŸå§‹è„šæœ¬çš„é—®é¢˜
- âŒ åŒ…å«æµ‹è¯•æ¡†æ¶ä»£ç 
- âŒ ç¡¬ç¼–ç çš„å†…å®¹
- âŒ é‡å¤çš„æ“ä½œ
- âŒ ç¼ºå°‘é”™è¯¯å¤„ç†
- âŒ ç¼ºå°‘æ—¥å¿—

### ä¼˜åŒ–åçš„ä¼˜ç‚¹
- âœ… é€‚é…å™¨æ ¼å¼
- âœ… åŠ¨æ€å†…å®¹
- âœ… ç®€åŒ–æ“ä½œ
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—
- âœ… æˆªå›¾è°ƒè¯•
- âœ… ç»“æœéªŒè¯

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **åˆ›å»ºé€‚é…å™¨æ–‡ä»¶**
2. **å¤åˆ¶ä¼˜åŒ–åçš„ä»£ç **
3. **æ³¨å†Œé€‚é…å™¨**
4. **æµ‹è¯•å‘å¸ƒåŠŸèƒ½**

ä½ çš„å½•åˆ¶è„šæœ¬å¾ˆå¥½ï¼Œåªéœ€è¦æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼ä¼˜åŒ–ä¸€ä¸‹å°±å¯ä»¥ç”¨äº†ï¼ğŸ‰
