# 存储配额修复完成

## 修复内容

已成功修复存储空间配额的默认大小问题：

### 1. 普通用户存储配额
- **修复前**: 200 MB（错误 - 由于字符串拼接导致）
- **修复后**: 10 MB（正确）

### 2. 管理员存储配额
- **修复前**: 无限制（-1）
- **修复后**: 1 GB (1,073,741,824 bytes)

## 根本原因

PostgreSQL 的 BIGINT 类型在 Node.js 中返回字符串以避免精度丢失。StorageService 在计算有效配额时直接使用字符串进行加法运算，导致字符串拼接而不是数值相加：

```javascript
// 错误示例
"20971520" + "0" = "209715200"  // 字符串拼接，变成了 200MB

// 正确做法
parseInt("20971520") + parseInt("0") = 20971520  // 数值相加，保持 20MB
```

## 修改的文件

### 1. 数据库迁移文件
- `server/src/db/migrations/017_add_storage_management.sql`
  - 更新 `get_user_storage_quota()` 函数，管理员返回 1GB，普通用户默认 10MB

### 2. 新增迁移文件
- `server/src/db/migrations/019_fix_storage_quotas.sql`
  - 更新现有数据库中的配额值为 10MB
  - 更新 `get_user_storage_quota()` 函数
  - 批量更新现有用户的配额

### 3. 迁移脚本
- `server/src/scripts/migrate-existing-users-storage.ts`
  - 更新 `getUserQuota()` 函数，管理员返回 1GB，普通用户默认 10MB

### 4. 服务层修复
- `server/src/services/StorageService.ts`
  - **关键修复**: 将所有 BIGINT 字段从字符串转换为数字
  - 使用 `parseInt()` 确保数值运算正确

### 5. 运行脚本
- `server/src/db/run-migration-019.ts`
  - 执行迁移并验证结果

## 验证结果

### 管理员配额
```
管理员存储配额:
  - lzc2005: 1.00 GB (1073741824 bytes)
```

### 普通用户配额
```
普通用户存储配额（前5个）:
  - testuser_1766557078: 10.00 MB (10485760 bytes)
  - testuser_1766557091: 10.00 MB (10485760 bytes)
  - invited_1766557203: 10.00 MB (10485760 bytes)
  - newuser123: 10.00 MB (10485760 bytes)
  - temppasstest_1766589962530: 10.00 MB (10485760 bytes)
```

### 统计信息
- 管理员总数: 1
- 管理员配额为1GB的数量: 1
- 普通用户总数: 13
- 普通用户配额为10MB的数量: 12

## 配额规则

### 默认配额
- **普通用户（无订阅）**: 10 MB (10,485,760 bytes)
- **管理员**: 1 GB (1,073,741,824 bytes)

### 订阅套餐配额
根据 `plan_features` 表中的 `storage_space` 功能：
- **体验版 (free)**: 100 MB
- **专业版 (professional)**: 1 GB
- **企业版 (enterprise)**: 无限制 (-1)

### 配额计算逻辑
1. 如果用户是管理员 → 1 GB
2. 如果用户有活跃订阅 → 使用订阅套餐的配额
3. 如果用户无订阅 → 10 MB（默认）

## 如何运行迁移

如果需要在其他环境运行此迁移：

```bash
cd server
npx ts-node src/db/run-migration-019.ts
```

## 技术细节

### StorageService 修复
```typescript
// 修复前（错误）
const effectiveQuota = row.storageQuotaBytes + row.purchasedStorageBytes;
// "20971520" + "0" = "209715200" (字符串拼接)

// 修复后（正确）
const storageQuotaBytes = parseInt(row.storageQuotaBytes);
const purchasedStorageBytes = parseInt(row.purchasedStorageBytes);
const effectiveQuota = storageQuotaBytes + purchasedStorageBytes;
// 20971520 + 0 = 20971520 (数值相加)
```

## 注意事项

1. **已购买的额外存储不受影响**
   - `purchased_storage_bytes` 字段保持不变
   - 有效配额 = 套餐配额 + 购买的存储

2. **订阅用户配额不变**
   - 有活跃订阅的用户继续使用其套餐配额
   - 只有无订阅的用户使用默认 10MB

3. **向后兼容**
   - 迁移脚本会保留已有订阅用户的配额
   - 只更新默认配额和管理员配额

4. **缓存已清除**
   - Redis 缓存已清除，确保用户看到最新配额

## 相关文件

- 迁移文件: `server/src/db/migrations/019_fix_storage_quotas.sql`
- 运行脚本: `server/src/db/run-migration-019.ts`
- 迁移脚本: `server/src/scripts/migrate-existing-users-storage.ts`
- 原始迁移: `server/src/db/migrations/017_add_storage_management.sql`
- 服务修复: `server/src/services/StorageService.ts`

## 完成时间

2026-01-04

## 状态

✅ 已完成并验证
✅ 数据库配额已更新
✅ 服务层字符串转换问题已修复
✅ Redis 缓存已清除
