# å‡è¡¡é€‰æ‹©ç®—æ³•è¯¦ç»†è¯´æ˜

## ğŸ“Š ç®—æ³•æ¦‚è¿°

å‡è¡¡é€‰æ‹©ç®—æ³•ç¡®ä¿æ¯ä¸ªè’¸é¦ç»“æœè¢«**å…¬å¹³ä½¿ç”¨**ï¼Œé¿å…æŸäº›è’¸é¦ç»“æœè¢«è¿‡åº¦ä½¿ç”¨ï¼Œè€Œå…¶ä»–è’¸é¦ç»“æœè¢«å¿½ç•¥ã€‚

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­¥éª¤1: æŸ¥è¯¢æ‰€æœ‰å¯ç”¨è’¸é¦ç»“æœ

```sql
SELECT d.id, d.keyword, d.usage_count, d.created_at
FROM distillations d
INNER JOIN topics t ON d.id = t.distillation_id
GROUP BY d.id
HAVING COUNT(t.id) > 0
ORDER BY d.usage_count ASC, d.created_at ASC
```

**æ’åºè§„åˆ™**ï¼š
1. é¦–å…ˆæŒ‰ `usage_count` å‡åºï¼ˆä½¿ç”¨æ¬¡æ•°å°‘çš„ä¼˜å…ˆï¼‰
2. å¦‚æœ `usage_count` ç›¸åŒï¼ŒæŒ‰ `created_at` å‡åºï¼ˆåˆ›å»ºæ—¶é—´æ—©çš„ä¼˜å…ˆï¼‰

### æ­¥éª¤2: é€‰æ‹©å‰Nä¸ª

ä½¿ç”¨ `LIMIT N` é€‰æ‹©å‰Nä¸ªè’¸é¦ç»“æœï¼Œå…¶ä¸­Næ˜¯è¯·æ±‚ç”Ÿæˆçš„æ–‡ç« æ•°é‡ã€‚

### æ­¥éª¤3: ä¿å­˜é€‰æ‹©ç»“æœ

å°†é€‰æ‹©çš„è’¸é¦ç»“æœIDæ•°ç»„ä¿å­˜åˆ° `generation_tasks.selected_distillation_ids` å­—æ®µï¼š

```json
[1, 2, 3, 4, 5]
```

### æ­¥éª¤4: ä¸ºæ¯ç¯‡æ–‡ç« åˆ†é…è’¸é¦ç»“æœ

```
æ–‡ç« 1 â†’ selected_distillation_ids[0]
æ–‡ç« 2 â†’ selected_distillation_ids[1]
æ–‡ç« 3 â†’ selected_distillation_ids[2]
...
```

### æ­¥éª¤5: ç”Ÿæˆåæ›´æ–°usage_count

æ¯ç¯‡æ–‡ç« ç”ŸæˆæˆåŠŸåï¼Œå¯¹åº”çš„è’¸é¦ç»“æœçš„ `usage_count` è‡ªåŠ¨ +1ã€‚

---

## ğŸ“ˆ ç¤ºä¾‹æ¼”ç¤º

### åˆå§‹çŠ¶æ€

| ID | å…³é”®è¯ | usage_count | created_at |
|----|--------|-------------|------------|
| 1  | Pythonç¼–ç¨‹ | 0 | 2024-01-01 |
| 2  | Javaå¼€å‘ | 0 | 2024-01-02 |
| 3  | Reactå‰ç«¯ | 1 | 2024-01-03 |
| 4  | Vueæ¡†æ¶ | 2 | 2024-01-04 |
| 5  | Nodeåç«¯ | 3 | 2024-01-05 |

### åœºæ™¯1: ç”Ÿæˆ3ç¯‡æ–‡ç« 

**é€‰æ‹©é€»è¾‘**ï¼š
```
æ’åºå: [1(0), 2(0), 3(1), 4(2), 5(3)]
é€‰æ‹©å‰3ä¸ª: [1, 2, 3]
```

**æ–‡ç« åˆ†é…**ï¼š
- æ–‡ç« 1 â†’ Pythonç¼–ç¨‹ (ID=1)
- æ–‡ç« 2 â†’ Javaå¼€å‘ (ID=2)
- æ–‡ç« 3 â†’ Reactå‰ç«¯ (ID=3)

**ç”ŸæˆåçŠ¶æ€**ï¼š

| ID | å…³é”®è¯ | usage_count | å˜åŒ– |
|----|--------|-------------|------|
| 1  | Pythonç¼–ç¨‹ | 1 | â¬†ï¸ +1 |
| 2  | Javaå¼€å‘ | 1 | â¬†ï¸ +1 |
| 3  | Reactå‰ç«¯ | 2 | â¬†ï¸ +1 |
| 4  | Vueæ¡†æ¶ | 2 | - |
| 5  | Nodeåç«¯ | 3 | - |

### åœºæ™¯2: å†æ¬¡ç”Ÿæˆ3ç¯‡æ–‡ç« 

**é€‰æ‹©é€»è¾‘**ï¼š
```
æ’åºå: [1(1), 2(1), 3(2), 4(2), 5(3)]
é€‰æ‹©å‰3ä¸ª: [1, 2, 3] æˆ– [1, 2, 4]ï¼ˆå–å†³äºcreated_atï¼‰
```

å‡è®¾é€‰æ‹© `[1, 2, 4]`ï¼š

**æ–‡ç« åˆ†é…**ï¼š
- æ–‡ç« 4 â†’ Pythonç¼–ç¨‹ (ID=1)
- æ–‡ç« 5 â†’ Javaå¼€å‘ (ID=2)
- æ–‡ç« 6 â†’ Vueæ¡†æ¶ (ID=4)

**ç”ŸæˆåçŠ¶æ€**ï¼š

| ID | å…³é”®è¯ | usage_count | å˜åŒ– |
|----|--------|-------------|------|
| 1  | Pythonç¼–ç¨‹ | 2 | â¬†ï¸ +1 |
| 2  | Javaå¼€å‘ | 2 | â¬†ï¸ +1 |
| 3  | Reactå‰ç«¯ | 2 | - |
| 4  | Vueæ¡†æ¶ | 3 | â¬†ï¸ +1 |
| 5  | Nodeåç«¯ | 3 | - |

### åœºæ™¯3: ç»§ç»­ç”Ÿæˆ5ç¯‡æ–‡ç« 

**é€‰æ‹©é€»è¾‘**ï¼š
```
æ’åºå: [1(2), 2(2), 3(2), 4(3), 5(3)]
é€‰æ‹©å‰5ä¸ª: [1, 2, 3, 4, 5]ï¼ˆå…¨éƒ¨ï¼‰
```

**æ–‡ç« åˆ†é…**ï¼š
- æ–‡ç« 7 â†’ Pythonç¼–ç¨‹ (ID=1)
- æ–‡ç« 8 â†’ Javaå¼€å‘ (ID=2)
- æ–‡ç« 9 â†’ Reactå‰ç«¯ (ID=3)
- æ–‡ç« 10 â†’ Vueæ¡†æ¶ (ID=4)
- æ–‡ç« 11 â†’ Nodeåç«¯ (ID=5)

**ç”ŸæˆåçŠ¶æ€**ï¼š

| ID | å…³é”®è¯ | usage_count | å˜åŒ– |
|----|--------|-------------|------|
| 1  | Pythonç¼–ç¨‹ | 3 | â¬†ï¸ +1 |
| 2  | Javaå¼€å‘ | 3 | â¬†ï¸ +1 |
| 3  | Reactå‰ç«¯ | 3 | â¬†ï¸ +1 |
| 4  | Vueæ¡†æ¶ | 4 | â¬†ï¸ +1 |
| 5  | Nodeåç«¯ | 4 | â¬†ï¸ +1 |

**è§‚å¯Ÿ**ï¼šæ‰€æœ‰è’¸é¦ç»“æœçš„ä½¿ç”¨æ¬¡æ•°è¶‹äºå‡è¡¡ï¼

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. å…¬å¹³æ€§

æ¯ä¸ªè’¸é¦ç»“æœéƒ½æœ‰å¹³ç­‰çš„æœºä¼šè¢«ä½¿ç”¨ï¼Œä¸ä¼šå‡ºç°æŸäº›è’¸é¦ç»“æœè¢«"å†·è½"çš„æƒ…å†µã€‚

### 2. å¯é¢„æµ‹æ€§

é€‰æ‹©é€»è¾‘å®Œå…¨é€æ˜ï¼Œå¯ä»¥é€šè¿‡æŸ¥è¯¢æ•°æ®åº“é¢„æµ‹ä¸‹æ¬¡ä¼šé€‰æ‹©å“ªäº›è’¸é¦ç»“æœã€‚

### 3. å®¹é”™æ€§

å¦‚æœæŸä¸ªè’¸é¦ç»“æœç”Ÿæˆå¤±è´¥ï¼Œä¸ä¼šå½±å“å…¶ä»–è’¸é¦ç»“æœçš„ä½¿ç”¨ã€‚

### 4. å¹¶å‘å®‰å…¨

ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å’ŒåŸå­æ“ä½œï¼ˆ`usage_count = usage_count + 1`ï¼‰ï¼Œç¡®ä¿å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚

---

## ğŸ” å¦‚ä½•éªŒè¯ç®—æ³•æ­£å¸¸å·¥ä½œ

### æ–¹æ³•1: æŸ¥çœ‹ä»»åŠ¡è®°å½•

```sql
SELECT 
  id,
  selected_distillation_ids,
  requested_count,
  generated_count,
  status
FROM generation_tasks
ORDER BY created_at DESC
LIMIT 5;
```

**é¢„æœŸç»“æœ**ï¼š
- `selected_distillation_ids` æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå¦‚ `[1,2,3]`
- æ•°ç»„é•¿åº¦ç­‰äº `requested_count`
- æ•°ç»„ä¸­çš„IDéƒ½æ˜¯ä¸åŒçš„

### æ–¹æ³•2: æŸ¥çœ‹æ–‡ç« ä½¿ç”¨çš„è’¸é¦ç»“æœ

```sql
SELECT 
  a.id,
  a.title,
  a.distillation_id,
  d.keyword,
  d.usage_count,
  a.created_at
FROM articles a
JOIN distillations d ON a.distillation_id = d.id
ORDER BY a.created_at DESC
LIMIT 10;
```

**é¢„æœŸç»“æœ**ï¼š
- æœ€è¿‘ç”Ÿæˆçš„æ–‡ç« ä½¿ç”¨äº†ä¸åŒçš„ `distillation_id`
- ä¸åŒçš„ `keyword`

### æ–¹æ³•3: æŸ¥çœ‹usage_countåˆ†å¸ƒ

```sql
SELECT 
  id,
  keyword,
  usage_count,
  (SELECT COUNT(*) FROM distillation_usage WHERE distillation_id = d.id) as actual_usage
FROM distillations d
ORDER BY usage_count ASC;
```

**é¢„æœŸç»“æœ**ï¼š
- `usage_count` å’Œ `actual_usage` åº”è¯¥ç›¸ç­‰
- æ‰€æœ‰è’¸é¦ç»“æœçš„ `usage_count` åº”è¯¥æ¯”è¾ƒæ¥è¿‘ï¼ˆå·®è·ä¸è¶…è¿‡1-2ï¼‰

---

## âš ï¸ å¸¸è§è¯¯è§£

### è¯¯è§£1: "æ¯æ¬¡éƒ½é€‰æ‹©ä¸åŒçš„è’¸é¦ç»“æœ"

**é”™è¯¯**ï¼šç®—æ³•ä¸æ˜¯éšæœºé€‰æ‹©ï¼Œè€Œæ˜¯æŒ‰ `usage_count` å‡åºé€‰æ‹©ã€‚

**æ­£ç¡®**ï¼šå¦‚æœæŸä¸ªè’¸é¦ç»“æœçš„ `usage_count` æœ€å°ï¼Œå®ƒä¼šè¢«ä¼˜å…ˆé€‰æ‹©ï¼Œç›´åˆ°å®ƒçš„ `usage_count` å¢åŠ åˆ°ä¸å…¶ä»–è’¸é¦ç»“æœç›¸åŒã€‚

### è¯¯è§£2: "æ—§ä»»åŠ¡ä¼šå½±å“æ–°ä»»åŠ¡"

**é”™è¯¯**ï¼šæ—§ä»»åŠ¡ï¼ˆæ²¡æœ‰ `selected_distillation_ids`ï¼‰ä¼šå½±å“æ–°ä»»åŠ¡çš„é€‰æ‹©ã€‚

**æ­£ç¡®**ï¼šæ—§ä»»åŠ¡ä½¿ç”¨æ—§é€»è¾‘ï¼ˆå•ä¸ªè’¸é¦ç»“æœï¼‰ï¼Œæ–°ä»»åŠ¡ä½¿ç”¨æ–°é€»è¾‘ï¼ˆå‡è¡¡é€‰æ‹©ï¼‰ï¼Œäº’ä¸å½±å“ã€‚

### è¯¯è§£3: "åªæœ‰ä¸€ä¸ªè’¸é¦ç»“æœæ—¶ç®—æ³•ä¼šå¤±è´¥"

**é”™è¯¯**ï¼šç®—æ³•ä¼šæŠ¥é”™æˆ–å´©æºƒã€‚

**æ­£ç¡®**ï¼šç®—æ³•ä¼šæ­£å¸¸å·¥ä½œï¼Œåªæ˜¯æ‰€æœ‰æ–‡ç« éƒ½ä½¿ç”¨åŒä¸€ä¸ªè’¸é¦ç»“æœï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ªå¯ç”¨ï¼‰ã€‚

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. åˆ›å»ºè¶³å¤Ÿçš„è’¸é¦ç»“æœ

å»ºè®®è‡³å°‘åˆ›å»º **5-10ä¸ª** è’¸é¦ç»“æœï¼Œä»¥å……åˆ†ä½“ç°å‡è¡¡é€‰æ‹©çš„æ•ˆæœã€‚

### 2. å®šæœŸæ£€æŸ¥usage_countåˆ†å¸ƒ

ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢æ£€æŸ¥åˆ†å¸ƒæ˜¯å¦å‡è¡¡ï¼š

```sql
SELECT 
  MIN(usage_count) as min_usage,
  MAX(usage_count) as max_usage,
  AVG(usage_count) as avg_usage,
  MAX(usage_count) - MIN(usage_count) as usage_diff
FROM distillations;
```

**å¥åº·æŒ‡æ ‡**ï¼š`usage_diff` åº”è¯¥å°äºç­‰äºè’¸é¦ç»“æœæ•°é‡ã€‚

### 3. ä½¿ç”¨ä¿®å¤å·¥å…·

å¦‚æœå‘ç° `usage_count` ä¸å‡†ç¡®ï¼Œä½¿ç”¨ä¿®å¤å·¥å…·ï¼š

```bash
curl -X POST http://localhost:3000/api/distillation/fix-usage-count
```

---

## ğŸ“š ç›¸å…³APIç«¯ç‚¹

### 1. è·å–æ¨èçš„è’¸é¦ç»“æœ

```bash
GET /api/distillation/recommended?limit=5
```

è¿”å› `usage_count` æœ€å°çš„5ä¸ªè’¸é¦ç»“æœã€‚

### 2. è·å–ä½¿ç”¨ç»Ÿè®¡

```bash
GET /api/distillation/stats?sortBy=usage_count&sortOrder=asc
```

è¿”å›æ‰€æœ‰è’¸é¦ç»“æœåŠå…¶ä½¿ç”¨ç»Ÿè®¡ã€‚

### 3. ä¿®å¤ä½¿ç”¨è®¡æ•°

```bash
POST /api/distillation/fix-usage-count
```

é‡æ–°è®¡ç®—æ‰€æœ‰è’¸é¦ç»“æœçš„ `usage_count`ã€‚

---

## ğŸ“ æ€»ç»“

å‡è¡¡é€‰æ‹©ç®—æ³•é€šè¿‡ä»¥ä¸‹æœºåˆ¶ç¡®ä¿å…¬å¹³ä½¿ç”¨ï¼š

1. âœ… æŒ‰ `usage_count` å‡åºæ’åº
2. âœ… é€‰æ‹©ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„Nä¸ª
3. âœ… æ¯ç¯‡æ–‡ç« ä½¿ç”¨ä¸åŒçš„è’¸é¦ç»“æœ
4. âœ… ç”Ÿæˆåè‡ªåŠ¨æ›´æ–° `usage_count`
5. âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

**ç»“æœ**ï¼šæ‰€æœ‰è’¸é¦ç»“æœçš„ä½¿ç”¨æ¬¡æ•°è¶‹äºå‡è¡¡ï¼Œé¿å…èµ„æºæµªè´¹ï¼
