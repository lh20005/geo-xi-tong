# æ–‡ç« æ ¼å¼ä¿ç•™ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°

åœ¨å‘å¸ƒä»»åŠ¡é¡µé¢çš„æ–‡ç« é¢„è§ˆå’Œå¤åˆ¶æ–‡ç« å†…å®¹åˆ°å‘å¸ƒå¹³å°æ—¶ï¼Œæ–‡ç« æ ¼å¼ä¸¢å¤±ï¼Œæ‰€æœ‰å†…å®¹æ··åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰æ®µè½åˆ†éš”ã€‚

### é—®é¢˜è¡¨ç°

**åŸå§‹æ–‡ç« å†…å®¹**:
```html
<p>è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—</p>
<p>è¿™æ˜¯ç¬¬äºŒæ®µæ–‡å­—</p>
<p>è¿™æ˜¯ç¬¬ä¸‰æ®µæ–‡å­—</p>
```

**é—®é¢˜æ˜¾ç¤º**:
```
è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—è¿™æ˜¯ç¬¬äºŒæ®µæ–‡å­—è¿™æ˜¯ç¬¬ä¸‰æ®µæ–‡å­—
```

**æœŸæœ›æ˜¾ç¤º**:
```
è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡å­—

è¿™æ˜¯ç¬¬äºŒæ®µæ–‡å­—

è¿™æ˜¯ç¬¬ä¸‰æ®µæ–‡å­—
```

## æ ¹æœ¬åŸå› 

### 1. å‰ç«¯é¢„è§ˆé—®é¢˜
`client/src/pages/PublishingTasksPage.tsx` ä¸­çš„ `processArticleContent` å‡½æ•°ï¼š
- åªç§»é™¤äº†Markdownå›¾ç‰‡è¯­æ³•
- æ²¡æœ‰å¤„ç†HTMLæ ‡ç­¾
- HTMLæ ‡ç­¾è¢«å½“ä½œçº¯æ–‡æœ¬æ˜¾ç¤ºï¼Œå¯¼è‡´æ ¼å¼æ··ä¹±

### 2. åç«¯å‘å¸ƒé—®é¢˜
`server/src/services/adapters/DouyinAdapter.ts` ä¸­çš„å†…å®¹å¤„ç†ï¼š
- ç›´æ¥ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾
- æ²¡æœ‰å…ˆå°† `<p>` å’Œ `<br>` è½¬æ¢ä¸ºæ¢è¡Œç¬¦
- å¯¼è‡´æ®µè½æ ¼å¼ä¸¢å¤±

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
åœ¨ç§»é™¤HTMLæ ‡ç­¾ä¹‹å‰ï¼Œå…ˆå°†è¡¨ç¤ºæ®µè½å’Œæ¢è¡Œçš„æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦ï¼Œä¿ç•™æ–‡ç« çš„æ®µè½ç»“æ„ã€‚

### å¤„ç†æ­¥éª¤
1. âœ… ç§»é™¤Markdownå›¾ç‰‡è¯­æ³•
2. âœ… å°† `</p>` è½¬æ¢ä¸ºæ¢è¡Œç¬¦
3. âœ… ç§»é™¤ `<p>` å¼€å§‹æ ‡ç­¾
4. âœ… å°† `<br>` å’Œ `<br/>` è½¬æ¢ä¸ºæ¢è¡Œç¬¦
5. âœ… ç§»é™¤å…¶ä»–æ‰€æœ‰HTMLæ ‡ç­¾
6. âœ… è½¬æ¢HTMLå®ä½“å­—ç¬¦
7. âœ… ç§»é™¤å›¾ç‰‡URL
8. âœ… æ¸…ç†å¤šä½™ç©ºè¡Œ
9. âœ… ç§»é™¤é¦–å°¾ç©ºç™½

## ä¿®å¤å†…å®¹

### 1. å‰ç«¯é¢„è§ˆä¿®å¤

**æ–‡ä»¶**: `client/src/pages/PublishingTasksPage.tsx`

**ä¿®æ”¹ä½ç½®**: `processArticleContent` å‡½æ•°ï¼ˆç¬¬228è¡Œï¼‰

**æ–°å¢å¤„ç†é€»è¾‘**:
```typescript
// 3. å¤„ç†HTMLæ ‡ç­¾ï¼Œä¿ç•™æ®µè½ç»“æ„
// å°† <p>ã€</p>ã€<br>ã€<br/> è½¬æ¢ä¸ºæ¢è¡Œç¬¦
processedContent = processedContent.replace(/<\/p>/gi, '\n');
processedContent = processedContent.replace(/<p[^>]*>/gi, '');
processedContent = processedContent.replace(/<br\s*\/?>/gi, '\n');

// 4. ç§»é™¤å…¶ä»–æ‰€æœ‰HTMLæ ‡ç­¾ï¼ˆä¿ç•™æ–‡æœ¬å†…å®¹ï¼‰
processedContent = processedContent.replace(/<[^>]+>/g, '');

// 5. ç§»é™¤HTMLå®ä½“å­—ç¬¦
processedContent = processedContent.replace(/&nbsp;/g, ' ');
processedContent = processedContent.replace(/&lt;/g, '<');
processedContent = processedContent.replace(/&gt;/g, '>');
processedContent = processedContent.replace(/&amp;/g, '&');
processedContent = processedContent.replace(/&quot;/g, '"');

// 6. æ¸…ç†å¤šä½™çš„ç©ºè¡Œï¼ˆè¶…è¿‡2ä¸ªè¿ç»­æ¢è¡Œç¬¦çš„åˆå¹¶ä¸º2ä¸ªï¼‰
processedContent = processedContent.replace(/\n{3,}/g, '\n\n');
```

### 2. åç«¯é€šç”¨æ–¹æ³•

**æ–‡ä»¶**: `server/src/services/adapters/PlatformAdapter.ts`

**æ–°å¢æ–¹æ³•**: `cleanArticleContent`ï¼ˆç¬¬115è¡Œï¼‰

è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å†…å®¹æ¸…ç†æ–¹æ³•ï¼Œæ‰€æœ‰å¹³å°é€‚é…å™¨éƒ½å¯ä»¥ä½¿ç”¨ï¼š

```typescript
/**
 * æ¸…ç†æ–‡ç« å†…å®¹ï¼Œç§»é™¤HTMLæ ‡ç­¾å’ŒMarkdownå›¾ç‰‡è¯­æ³•ï¼Œä¿ç•™æ®µè½æ ¼å¼
 * è¿™æ˜¯ä¸€ä¸ªé€šç”¨æ–¹æ³•ï¼Œæ‰€æœ‰å¹³å°é€‚é…å™¨éƒ½å¯ä»¥ä½¿ç”¨
 */
protected cleanArticleContent(content: string): string {
  if (!content) return '';
  
  let cleanedContent = content;
  
  // 1. ç§»é™¤Markdownå›¾ç‰‡è¯­æ³• ![alt](url)
  cleanedContent = cleanedContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '');
  
  // 2. å¤„ç†HTMLæ ‡ç­¾ï¼Œä¿ç•™æ®µè½ç»“æ„
  cleanedContent = cleanedContent.replace(/<\/p>/gi, '\n');
  cleanedContent = cleanedContent.replace(/<p[^>]*>/gi, '');
  cleanedContent = cleanedContent.replace(/<br\s*\/?>/gi, '\n');
  
  // 3. ç§»é™¤å…¶ä»–æ‰€æœ‰HTMLæ ‡ç­¾
  cleanedContent = cleanedContent.replace(/<[^>]+>/g, '');
  
  // 4. ç§»é™¤HTMLå®ä½“å­—ç¬¦
  cleanedContent = cleanedContent.replace(/&nbsp;/g, ' ');
  cleanedContent = cleanedContent.replace(/&lt;/g, '<');
  cleanedContent = cleanedContent.replace(/&gt;/g, '>');
  cleanedContent = cleanedContent.replace(/&amp;/g, '&');
  cleanedContent = cleanedContent.replace(/&quot;/g, '"');
  
  // 5. ç§»é™¤å›¾ç‰‡URL
  cleanedContent = cleanedContent.replace(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/gi, '');
  
  // 6. æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
  cleanedContent = cleanedContent.replace(/\n{3,}/g, '\n\n');
  
  // 7. ç§»é™¤é¦–å°¾ç©ºç™½
  cleanedContent = cleanedContent.trim();
  
  return cleanedContent;
}
```

### 3. æŠ–éŸ³é€‚é…å™¨æ›´æ–°

**æ–‡ä»¶**: `server/src/services/adapters/DouyinAdapter.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬355è¡Œ

**ç®€åŒ–ä»£ç **:
```typescript
// ä¹‹å‰ï¼š30è¡Œé‡å¤çš„æ¸…ç†ä»£ç 
// ç°åœ¨ï¼š1è¡Œè°ƒç”¨é€šç”¨æ–¹æ³•
const textOnly = this.cleanArticleContent(cleanContent);
```

## å¤„ç†ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºæœ¬æ®µè½

**è¾“å…¥**:
```html
<p>ç¬¬ä¸€æ®µ</p>
<p>ç¬¬äºŒæ®µ</p>
<p>ç¬¬ä¸‰æ®µ</p>
```

**è¾“å‡º**:
```
ç¬¬ä¸€æ®µ
ç¬¬äºŒæ®µ
ç¬¬ä¸‰æ®µ
```

### ç¤ºä¾‹2: åŒ…å«æ¢è¡Œç¬¦

**è¾“å…¥**:
```html
<p>ç¬¬ä¸€è¡Œ<br>ç¬¬äºŒè¡Œ</p>
<p>ç¬¬ä¸‰è¡Œ</p>
```

**è¾“å‡º**:
```
ç¬¬ä¸€è¡Œ
ç¬¬äºŒè¡Œ
ç¬¬ä¸‰è¡Œ
```

### ç¤ºä¾‹3: å¤æ‚HTMLç»“æ„

**è¾“å…¥**:
```html
<div class="article">
  <p>æ®µè½1</p>
  <img src="image.jpg" />
  <p>æ®µè½2<br/>æ¢è¡Œ</p>
  <p>æ®µè½3</p>
</div>
```

**è¾“å‡º**:
```
æ®µè½1
æ®µè½2
æ¢è¡Œ
æ®µè½3
```

### ç¤ºä¾‹4: HTMLå®ä½“å­—ç¬¦

**è¾“å…¥**:
```html
<p>è¿™æ˜¯&nbsp;ç©ºæ ¼</p>
<p>&lt;æ ‡ç­¾&gt;</p>
<p>&quot;å¼•å·&quot;</p>
```

**è¾“å‡º**:
```
è¿™æ˜¯ ç©ºæ ¼
<æ ‡ç­¾>
"å¼•å·"
```

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆè¦æŒ‰è¿™ä¸ªé¡ºåºå¤„ç†ï¼Ÿ

1. **å…ˆç§»é™¤Markdownå›¾ç‰‡**: é¿å…å›¾ç‰‡è¯­æ³•ä¸­çš„æ–‡å­—è¢«ä¿ç•™
2. **å†è½¬æ¢æ®µè½æ ‡ç­¾**: ä¿ç•™æ®µè½ç»“æ„
3. **ç„¶åç§»é™¤å…¶ä»–HTMLæ ‡ç­¾**: æå–çº¯æ–‡æœ¬
4. **æ¥ç€è½¬æ¢å®ä½“å­—ç¬¦**: æ¢å¤ç‰¹æ®Šå­—ç¬¦
5. **ç§»é™¤å›¾ç‰‡URL**: æ¸…ç†æ®‹ç•™é“¾æ¥
6. **æœ€åæ¸…ç†ç©ºè¡Œ**: æ•´ç†æ ¼å¼

### æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜

| æ­£åˆ™è¡¨è¾¾å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|-----------|------|------|
| `/<\/p>/gi` | åŒ¹é…ç»“æŸæ®µè½æ ‡ç­¾ | `</p>` â†’ `\n` |
| `/<p[^>]*>/gi` | åŒ¹é…å¼€å§‹æ®µè½æ ‡ç­¾ï¼ˆåŒ…æ‹¬å±æ€§ï¼‰ | `<p class="text">` â†’ `` |
| `/<br\s*\/?>/gi` | åŒ¹é…æ¢è¡Œæ ‡ç­¾ | `<br>`, `<br/>` â†’ `\n` |
| `/<[^>]+>/g` | åŒ¹é…æ‰€æœ‰HTMLæ ‡ç­¾ | `<div>`, `<span>` â†’ `` |
| `/&nbsp;/g` | åŒ¹é…ç©ºæ ¼å®ä½“ | `&nbsp;` â†’ ` ` |
| `/\n{3,}/g` | åŒ¹é…3ä¸ªæˆ–æ›´å¤šæ¢è¡Œç¬¦ | `\n\n\n` â†’ `\n\n` |

### CSSæ ·å¼ä¿ç•™

å‰ç«¯é¢„è§ˆä½¿ç”¨ `whiteSpace: 'pre-wrap'` æ ·å¼ï¼Œç¡®ä¿ï¼š
- âœ… ä¿ç•™æ¢è¡Œç¬¦
- âœ… ä¿ç•™ç©ºæ ¼
- âœ… è‡ªåŠ¨æ¢è¡Œï¼ˆä¸ä¼šè¶…å‡ºå®¹å™¨ï¼‰
- âœ… ä¿æŒè‰¯å¥½çš„å¯è¯»æ€§

## æµ‹è¯•éªŒè¯

### å‰ç«¯æµ‹è¯•

1. æ‰“å¼€å‘å¸ƒä»»åŠ¡é¡µé¢
2. ç‚¹å‡»æ–‡ç« çš„"é¢„è§ˆ"æŒ‰é’®
3. æŸ¥çœ‹æ–‡ç« å†…å®¹æ˜¯å¦æœ‰æ­£ç¡®çš„æ®µè½åˆ†éš”

**é¢„æœŸç»“æœ**:
- âœ… æ®µè½ä¹‹é—´æœ‰æ˜æ˜¾çš„ç©ºè¡Œ
- âœ… æ²¡æœ‰HTMLæ ‡ç­¾æ˜¾ç¤º
- âœ… æ ¼å¼æ¸…æ™°æ˜“è¯»

### åç«¯æµ‹è¯•

1. åˆ›å»ºä¸€ä¸ªæŠ–éŸ³å‘å¸ƒä»»åŠ¡
2. é€‰æ‹©åŒ…å«å¤šä¸ªæ®µè½çš„æ–‡ç« 
3. æ‰§è¡Œå‘å¸ƒ
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„"æ–‡å­—é¢„è§ˆ"

**é¢„æœŸç»“æœ**:
```
[æŠ–éŸ³å·] ğŸ“ æ–‡å­—é¢„è§ˆ: "ç¬¬ä¸€æ®µ

ç¬¬äºŒæ®µ

ç¬¬ä¸‰æ®µ..."
```

### å®é™…å‘å¸ƒæµ‹è¯•

1. å®Œæˆå‘å¸ƒæµç¨‹
2. åœ¨æŠ–éŸ³å¹³å°æŸ¥çœ‹å‘å¸ƒçš„å†…å®¹
3. éªŒè¯æ®µè½æ ¼å¼æ˜¯å¦æ­£ç¡®

**é¢„æœŸç»“æœ**:
- âœ… æ®µè½åˆ†éš”æ¸…æ™°
- âœ… æ²¡æœ‰HTMLæ ‡ç­¾
- âœ… é˜…è¯»ä½“éªŒè‰¯å¥½

## é€‚ç”¨èŒƒå›´

### å·²ä¿®å¤çš„åŠŸèƒ½
- âœ… å‘å¸ƒä»»åŠ¡é¡µé¢çš„æ–‡ç« é¢„è§ˆ
- âœ… æŠ–éŸ³å¹³å°çš„å†…å®¹å‘å¸ƒ
- âœ… æ‰€æœ‰ä½¿ç”¨ `cleanArticleContent` æ–¹æ³•çš„å¹³å°

### å…¶ä»–å¹³å°é€‚é…å™¨

æ‰€æœ‰å¹³å°é€‚é…å™¨éƒ½å¯ä»¥ä½¿ç”¨ `this.cleanArticleContent(content)` æ–¹æ³•æ¥æ¸…ç†æ–‡ç« å†…å®¹ã€‚

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// åœ¨ä»»ä½•å¹³å°é€‚é…å™¨ä¸­
const cleanedContent = this.cleanArticleContent(article.content);
```

**å»ºè®®æ›´æ–°çš„é€‚é…å™¨**:
- å¤´æ¡å· (ToutiaoAdapter)
- ç™¾å®¶å· (BaijiahaoAdapter)
- çŸ¥ä¹ (ZhihuAdapter)
- ç®€ä¹¦ (JianshuAdapter)
- å°çº¢ä¹¦ (XiaohongshuAdapter)
- ç­‰ç­‰...

## ç›¸å…³æ–‡ä»¶

- `client/src/pages/PublishingTasksPage.tsx` - å‰ç«¯æ–‡ç« é¢„è§ˆï¼ˆå·²ä¿®æ”¹ï¼‰
- `server/src/services/adapters/PlatformAdapter.ts` - é€šç”¨æ¸…ç†æ–¹æ³•ï¼ˆå·²æ·»åŠ ï¼‰
- `server/src/services/adapters/DouyinAdapter.ts` - æŠ–éŸ³é€‚é…å™¨ï¼ˆå·²æ›´æ–°ï¼‰
- `æŠ–éŸ³å†…å®¹æ¸…ç†ä¼˜åŒ–å®Œæˆ.md` - ä¹‹å‰çš„ä¿®å¤æ–‡æ¡£

## æ€»ç»“

### ä¿®å¤å†…å®¹
- âœ… å‰ç«¯æ–‡ç« é¢„è§ˆæ ¼å¼ä¿ç•™
- âœ… åç«¯é€šç”¨å†…å®¹æ¸…ç†æ–¹æ³•
- âœ… æŠ–éŸ³é€‚é…å™¨ä»£ç ç®€åŒ–
- âœ… æ®µè½ç»“æ„å®Œæ•´ä¿ç•™
- âœ… HTMLæ ‡ç­¾æ­£ç¡®å¤„ç†
- âœ… å®ä½“å­—ç¬¦æ­£ç¡®è½¬æ¢

### æ•ˆæœ
- æ–‡ç« é¢„è§ˆæ ¼å¼æ¸…æ™°
- å‘å¸ƒå†…å®¹æ®µè½åˆ†æ˜
- ä»£ç æ›´åŠ ç®€æ´
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### ä¸‹ä¸€æ­¥
å»ºè®®å°†å…¶ä»–å¹³å°é€‚é…å™¨ä¹Ÿæ›´æ–°ä¸ºä½¿ç”¨ `cleanArticleContent` æ–¹æ³•ï¼Œç»Ÿä¸€å†…å®¹å¤„ç†é€»è¾‘ã€‚
