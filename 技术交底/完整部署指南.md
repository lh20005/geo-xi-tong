# GEO ä¼˜åŒ–ç³»ç»Ÿ - å®Œæ•´éƒ¨ç½²æŒ‡å—

> æœ¬æ–‡æ¡£æä¾›ä» GitHub æ‹‰å–ä»£ç åçš„å®Œæ•´éƒ¨ç½²æ­¥éª¤ï¼Œç¡®ä¿ç³»ç»Ÿå¯ä»¥ç«‹å³ä½¿ç”¨ã€‚

---

## ç›®å½•

1. [ç³»ç»Ÿè¦æ±‚](#1-ç³»ç»Ÿè¦æ±‚)
2. [ä¾èµ–ç‰ˆæœ¬æ¸…å•](#2-ä¾èµ–ç‰ˆæœ¬æ¸…å•)
3. [ç¯å¢ƒå‡†å¤‡](#3-ç¯å¢ƒå‡†å¤‡)
4. [æ•°æ®åº“é…ç½®](#4-æ•°æ®åº“é…ç½®)
5. [ç¯å¢ƒå˜é‡é…ç½®](#5-ç¯å¢ƒå˜é‡é…ç½®)
6. [å®‰è£…ä¾èµ–](#6-å®‰è£…ä¾èµ–)
7. [æ•°æ®åº“è¿ç§»](#7-æ•°æ®åº“è¿ç§»)
8. [æ„å»ºé¡¹ç›®](#8-æ„å»ºé¡¹ç›®)
9. [å¯åŠ¨ç³»ç»Ÿ](#9-å¯åŠ¨ç³»ç»Ÿ)
10. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#10-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
11. [éªŒè¯éƒ¨ç½²](#11-éªŒè¯éƒ¨ç½²)
12. [å¸¸è§é—®é¢˜](#12-å¸¸è§é—®é¢˜)

---

## 1. ç³»ç»Ÿè¦æ±‚

### 1.1 æ“ä½œç³»ç»Ÿ
- **å¼€å‘ç¯å¢ƒ**: macOS / Windows / Linux
- **ç”Ÿäº§ç¯å¢ƒ**: Ubuntu 20.04+ (æ¨è)

### 1.2 å¿…éœ€è½¯ä»¶

#### å¼€å‘ç¯å¢ƒï¼ˆæœ¬åœ° macOSï¼‰

| è½¯ä»¶ | å½“å‰ç‰ˆæœ¬ | ç”¨é€” |
|------|----------|------|
| Node.js | v22.17.0 | è¿è¡Œæ—¶ç¯å¢ƒ |
| npm | 10.9.2 | åŒ…ç®¡ç†å™¨ |
| PostgreSQL | 14.18 (Homebrew) | ä¸»æ•°æ®åº“ |
| Redis | 8.0.2 | ç¼“å­˜å’Œä¼šè¯ |

#### ç”Ÿäº§ç¯å¢ƒï¼ˆUbuntu æœåŠ¡å™¨ 124.221.247.107ï¼‰

| è½¯ä»¶ | å½“å‰ç‰ˆæœ¬ | ç”¨é€” |
|------|----------|------|
| Node.js | v22.22.0 | è¿è¡Œæ—¶ç¯å¢ƒ |
| npm | 10.9.4 | åŒ…ç®¡ç†å™¨ |
| PostgreSQL | 16.11 (Ubuntu 16.11-0ubuntu0.24.04.1) | ä¸»æ•°æ®åº“ |
| Redis | 7.0.15 | ç¼“å­˜å’Œä¼šè¯ |
| Nginx | 1.24.0 (Ubuntu) | åå‘ä»£ç† |
| PM2 | 6.0.14 | è¿›ç¨‹ç®¡ç† |

### 1.3 ç«¯å£åˆ†é…

| ç«¯å£ | æœåŠ¡ | è¯´æ˜ |
|------|------|------|
| 3000 | åç«¯ API | Express æœåŠ¡å™¨ |
| 5173 | å‰ç«¯å¼€å‘æœåŠ¡å™¨ | Vite (client) |
| 5174 | Electron å¼€å‘æœåŠ¡å™¨ | Vite (windows-login-manager) |
| 8080 | è½åœ°é¡µå¼€å‘æœåŠ¡å™¨ | Vite (landing) |
| 5432 | PostgreSQL | æ•°æ®åº“ |
| 6379 | Redis | ç¼“å­˜ |
| 80/443 | Nginx | ç”Ÿäº§ç¯å¢ƒ Web æœåŠ¡ |

---

## 2. ä¾èµ–ç‰ˆæœ¬æ¸…å•

### 2.1 æ ¹é¡¹ç›®ä¾èµ– (package.json)

```json
{
  "name": "geo-optimization-system",
  "version": "1.0.0",
  "devDependencies": {
    "concurrently": "^8.2.2"
  }
}
```

### 2.2 åç«¯ä¾èµ– (server/package.json)

#### ç”Ÿäº§ä¾èµ–
```json
{
  "dependencies": {
    "@types/bcrypt": "^6.0.0",
    "@types/ioredis": "^4.28.10",
    "@types/node-cron": "^3.0.11",
    "ajv": "^8.17.1",
    "ajv-formats": "^3.0.1",
    "axios": "^1.6.2",
    "bcrypt": "^6.0.0",
    "cookie-parser": "^1.4.7",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "express-rate-limit": "^8.2.1",
    "helmet": "^8.1.0",
    "ioredis": "^5.8.2",
    "jsonwebtoken": "^9.0.3",
    "mammoth": "^1.6.0",
    "multer": "^2.0.2",
    "netmask": "^2.0.2",
    "node-cron": "^4.2.1",
    "nodemailer": "^7.0.12",
    "pdf-parse": "^1.1.1",
    "pg": "^8.11.3",
    "playwright": "^1.57.0",
    "redis": "^5.10.0",
    "validator": "^13.15.26",
    "wechatpay-axios-plugin": "^0.9.5",
    "ws": "^8.18.3",
    "zod": "^3.22.4"
  }
}
```

#### å¼€å‘ä¾èµ–
```json
{
  "devDependencies": {
    "@types/cookie-parser": "^1.4.10",
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/jest": "^30.0.0",
    "@types/jsonwebtoken": "^9.0.10",
    "@types/multer": "^2.0.0",
    "@types/netmask": "^2.0.6",
    "@types/node": "^20.10.5",
    "@types/nodemailer": "^7.0.5",
    "@types/pdf-parse": "^1.1.5",
    "@types/pg": "^8.10.9",
    "@types/supertest": "^6.0.3",
    "@types/validator": "^13.15.10",
    "@types/ws": "^8.18.1",
    "fast-check": "^4.5.2",
    "jest": "^30.2.0",
    "supertest": "^7.1.4",
    "ts-jest": "^29.4.6",
    "tsx": "^4.7.0",
    "typescript": "^5.3.3"
  }
}
```

### 2.3 å‰ç«¯ä¾èµ– (client/package.json)

#### ç”Ÿäº§ä¾èµ–
```json
{
  "dependencies": {
    "@ant-design/icons": "^5.2.6",
    "@types/react-resizable": "^3.0.8",
    "antd": "^5.12.2",
    "axios": "^1.6.2",
    "dayjs": "^1.11.19",
    "dompurify": "^3.3.1",
    "echarts": "^6.0.0",
    "echarts-for-react": "^3.0.5",
    "qrcode.react": "^4.2.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-markdown": "^10.1.0",
    "react-quill": "^2.0.0",
    "react-resizable": "^3.0.5",
    "react-router-dom": "^6.20.1",
    "remark-gfm": "^4.0.1",
    "zustand": "^4.4.7"
  }
}
```

#### å¼€å‘ä¾èµ–
```json
{
  "devDependencies": {
    "@types/dompurify": "^3.0.5",
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.3.6",
    "terser": "^5.44.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.8"
  }
}
```

### 2.4 è½åœ°é¡µä¾èµ– (landing/package.json)

#### ç”Ÿäº§ä¾èµ–
```json
{
  "dependencies": {
    "axios": "^1.6.2",
    "cssesc": "^3.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-helmet-async": "^2.0.5",
    "react-router-dom": "^6.20.1"
  }
}
```

#### å¼€å‘ä¾èµ–
```json
{
  "devDependencies": {
    "@types/react": "^18.3.27",
    "@types/react-dom": "^18.3.7",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.3.6",
    "terser": "^5.44.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.8"
  }
}
```

### 2.5 Electron æ¡Œé¢åº”ç”¨ä¾èµ– (windows-login-manager/package.json)

#### ç”Ÿäº§ä¾èµ–
```json
{
  "dependencies": {
    "@ant-design/icons": "^5.3.7",
    "@types/ws": "^8.18.1",
    "antd": "^5.12.8",
    "axios": "^1.6.2",
    "dayjs": "^1.11.10",
    "dompurify": "^3.0.8",
    "echarts": "^5.4.3",
    "echarts-for-react": "^3.0.0",
    "electron-log": "^5.0.1",
    "electron-store": "^8.1.0",
    "electron-updater": "^6.1.7",
    "form-data": "^4.0.5",
    "playwright": "^1.57.0",
    "qrcode.react": "^3.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-markdown": "^9.0.1",
    "react-quill": "^2.0.0",
    "react-resizable": "^3.0.5",
    "react-router-dom": "^6.20.0",
    "remark-gfm": "^4.0.0",
    "ws": "^8.18.3",
    "zustand": "^4.4.7"
  }
}
```

#### å¼€å‘ä¾èµ–
```json
{
  "devDependencies": {
    "@types/node": "^20.10.4",
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@types/react-resizable": "^3.0.8",
    "@typescript-eslint/eslint-plugin": "^6.13.2",
    "@typescript-eslint/parser": "^6.13.2",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "concurrently": "^8.2.2",
    "cross-env": "^7.0.3",
    "electron": "^28.0.0",
    "electron-builder": "^24.9.1",
    "eslint": "^8.55.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-react": "^7.33.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "postcss": "^8.4.32",
    "prettier": "^3.1.0",
    "tailwindcss": "^3.3.6",
    "terser": "^5.46.0",
    "typescript": "^5.3.3",
    "vite": "^5.0.7",
    "vite-plugin-electron": "^0.28.0",
    "wait-on": "^7.2.0"
  }
}
```

---

## 3. ç¯å¢ƒå‡†å¤‡

### 3.1 å®‰è£… Node.js

```bash
# ä½¿ç”¨ nvm å®‰è£…ï¼ˆæ¨èï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
source ~/.bashrc
nvm install 22
nvm use 22

# éªŒè¯å®‰è£…
node -v  # åº”æ˜¾ç¤º v22.17.0 æˆ–æ›´é«˜
npm -v   # åº”æ˜¾ç¤º 10.9.2 æˆ–æ›´é«˜
```

### 3.2 å®‰è£… PostgreSQL

#### macOS
```bash
# å®‰è£… PostgreSQL 14ï¼ˆä¸å¼€å‘ç¯å¢ƒä¸€è‡´ï¼‰
brew install postgresql@14
brew services start postgresql@14

# éªŒè¯å®‰è£…
psql --version  # åº”æ˜¾ç¤º psql (PostgreSQL) 14.18
```

#### Ubuntuï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ PostgreSQL 16ï¼‰
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

# éªŒè¯å®‰è£…
psql --version  # åº”æ˜¾ç¤º psql (PostgreSQL) 16.11
```

### 3.3 å®‰è£… Redis

#### macOS
```bash
brew install redis
brew services start redis

# éªŒè¯å®‰è£…
redis-server --version  # åº”æ˜¾ç¤º Redis server v=8.0.2
```

#### Ubuntuï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Redis 7.0.15ï¼‰
```bash
sudo apt install redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server

# éªŒè¯å®‰è£…
redis-server --version  # åº”æ˜¾ç¤º Redis server v=7.0.15
```

### 3.4 å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/your-repo/geo-optimization-system.git
cd geo-optimization-system
```

---

## 4. æ•°æ®åº“é…ç½®

### 4.1 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```bash
# è¿›å…¥ PostgreSQL
sudo -u postgres psql

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å¼ºå¯†ç ï¼‰
CREATE USER geo_user WITH PASSWORD 'your_secure_password';

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE geo_system OWNER geo_user;

# æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE geo_system TO geo_user;

# è¿æ¥åˆ°æ•°æ®åº“å¹¶æˆäºˆ schema æƒé™
\c geo_system
GRANT ALL ON SCHEMA public TO geo_user;

# é€€å‡º
\q
```

### 4.2 éªŒè¯è¿æ¥

```bash
psql -h localhost -U geo_user -d geo_system
# è¾“å…¥å¯†ç ååº”èƒ½æˆåŠŸè¿æ¥
```

---

## 5. ç¯å¢ƒå˜é‡é…ç½®

### 5.1 åç«¯ç¯å¢ƒå˜é‡ (server/.env)

å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶å¹¶ä¿®æ”¹ï¼š

```bash
cp .env.example server/.env
```

ç¼–è¾‘ `server/.env`ï¼š

```bash
# åŸºç¡€é…ç½®
NODE_ENV=development
PORT=3000

# æ•°æ®åº“é…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
DATABASE_URL=postgresql://geo_user:your_secure_password@localhost:5432/geo_system
DB_HOST=localhost
DB_PORT=5432
DB_NAME=geo_system
DB_USER=geo_user
DB_PASSWORD=your_secure_password

# JWT é…ç½®ï¼ˆå¿…é¡»ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²ï¼‰
# ç”Ÿæˆæ–¹æ³•: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=your_jwt_secret_here
JWT_REFRESH_SECRET=your_jwt_refresh_secret_here
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

# ç®¡ç†å‘˜è´¦å·ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_admin_password

# AI API é…ç½®ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯åœ¨ç®¡ç†åå°é…ç½®ï¼‰
DEEPSEEK_API_KEY=sk-your-deepseek-api-key
GEMINI_API_KEY=AIzaSy-your-gemini-api-key
OLLAMA_BASE_URL=http://localhost:11434

# WebSocket é…ç½®
WEBSOCKET_PORT=8080

# CORS é…ç½®ï¼ˆæ ¹æ®å®é™…åŸŸåä¿®æ”¹ï¼‰
ALLOWED_ORIGINS=http://localhost,http://localhost:5173,http://localhost:5174,http://localhost:8080

# é™æµé…ç½®
LOGIN_RATE_LIMIT=5
LOGIN_RATE_WINDOW_MINUTES=15
REGISTRATION_RATE_LIMIT=3
REGISTRATION_RATE_WINDOW_HOURS=1

# API å¯†é’¥åŠ å¯†å¯†é’¥ï¼ˆå¿…é¡»é…ç½®ï¼‰
# ç”Ÿæˆæ–¹æ³•: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
API_KEY_ENCRYPTION_KEY=your_encryption_key_here

# Redis é…ç½®
REDIS_URL=redis://localhost:6379

# ==================== å¾®ä¿¡æ”¯ä»˜é…ç½®ï¼ˆå¯é€‰ï¼‰ ====================
WECHAT_PAY_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret
WECHAT_PAY_MCH_ID=your_mch_id
WECHAT_PAY_API_V3_KEY=your_api_v3_key
WECHAT_PAY_SERIAL_NO=your_serial_no
WECHAT_PAY_PRIVATE_KEY_PATH=/path/to/apiclient_key.pem
WECHAT_PAY_PUBLIC_KEY_PATH=/path/to/wechat_pay_public_key.pem
WECHAT_PAY_PUBLIC_KEY_ID=your_public_key_id
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/payment/wechat/notify

# ==================== é‚®ä»¶æœåŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰ ====================
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=your-email@163.com
SMTP_PASS=your_smtp_password
SMTP_FROM_NAME=GEOä¼˜åŒ–ç³»ç»Ÿ
```

### 5.2 å‰ç«¯ç¯å¢ƒå˜é‡ (client/.env)

```bash
cp client/.env.example client/.env
```

ç¼–è¾‘ `client/.env`ï¼š

```bash
# å¼€å‘ç¯å¢ƒé€šå¸¸ä¸éœ€è¦é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼å³å¯
# ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹ï¼š
# VITE_API_URL=https://your-domain.com
# VITE_WS_URL=wss://your-domain.com/ws
# VITE_LANDING_URL=https://your-domain.com
```

### 5.3 è½åœ°é¡µç¯å¢ƒå˜é‡ (landing/.env)

```bash
cp landing/.env.example landing/.env
```

ç¼–è¾‘ `landing/.env`ï¼š

```bash
# å¼€å‘ç¯å¢ƒ
VITE_API_URL=http://localhost:3000
VITE_APP_URL=http://localhost:5173
```

### 5.4 Electron åº”ç”¨ç¯å¢ƒå˜é‡ (windows-login-manager/.env)

```bash
cp windows-login-manager/.env.example windows-login-manager/.env
```

ç¼–è¾‘ `windows-login-manager/.env`ï¼š

```bash
# æœåŠ¡å™¨åœ°å€
VITE_API_URL=http://localhost:3000

# æµè§ˆå™¨é…ç½®
BROWSER_HEADLESS=false
```

---

## 6. å®‰è£…ä¾èµ–

### 6.1 ä¸€é”®å®‰è£…æ‰€æœ‰ä¾èµ–

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
npm run install:all
```

### 6.2 åˆ†æ­¥å®‰è£…ï¼ˆå¦‚æœä¸€é”®å®‰è£…å¤±è´¥ï¼‰

```bash
# æ ¹ç›®å½•
npm install

# åç«¯
cd server && npm install && cd ..

# å‰ç«¯
cd client && npm install && cd ..

# è½åœ°é¡µ
cd landing && npm install && cd ..

# Electron åº”ç”¨ï¼ˆå¯é€‰ï¼‰
cd windows-login-manager && npm install && cd ..
```

---

## 7. æ•°æ®åº“è¿ç§»

### 7.1 æ‰§è¡Œè¿ç§»

```bash
cd server
npm run db:migrate
```

æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸš€ å¼€å§‹æ•°æ®åº“è¿ç§»...
==================================================
âœ“ è¿ç§»å†å²è¡¨å·²å°±ç»ª
âœ“ å·²æ‰§è¡Œ 0 ä¸ªè¿ç§»
âœ“ å‘ç° 62 ä¸ªè¿ç§»æ–‡ä»¶

ğŸ“‹ å¾…æ‰§è¡Œ 62 ä¸ªè¿ç§»:
   001 - initial schema
   002 - add missing columns
   ...

å¼€å§‹æ‰§è¡Œè¿ç§»...
â†’ æ‰§è¡Œè¿ç§» 001: initial schema
âœ“ è¿ç§» 001 æ‰§è¡ŒæˆåŠŸ
...

==================================================
âœ“ æ‰€æœ‰è¿ç§»æ‰§è¡ŒæˆåŠŸï¼
âœ“ æ•°æ®åº“ç‰ˆæœ¬: 062
```

### 7.2 æŸ¥çœ‹è¿ç§»çŠ¶æ€

```bash
npm run db:status
```

### 7.3 å›æ»šè¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰

```bash
npm run db:rollback
```

---

## 8. æ„å»ºé¡¹ç›®

### 8.1 å¼€å‘ç¯å¢ƒï¼ˆæ— éœ€æ„å»ºï¼‰

å¼€å‘ç¯å¢ƒç›´æ¥å¯åŠ¨å¼€å‘æœåŠ¡å™¨å³å¯ï¼Œæ— éœ€æ„å»ºã€‚

### 8.2 ç”Ÿäº§ç¯å¢ƒæ„å»º

```bash
# æ„å»ºæ‰€æœ‰é¡¹ç›®
npm run build

# æˆ–åˆ†åˆ«æ„å»º
npm run client:build   # å‰ç«¯
npm run server:build   # åç«¯
npm run landing:build  # è½åœ°é¡µ
```

æ„å»ºäº§ç‰©ä½ç½®ï¼š
- å‰ç«¯: `client/dist/`
- åç«¯: `server/dist/`
- è½åœ°é¡µ: `landing/dist/`

---

## 9. å¯åŠ¨ç³»ç»Ÿ

### 9.1 å¼€å‘ç¯å¢ƒå¯åŠ¨

#### æ–¹å¼ä¸€ï¼šä¸€é”®å¯åŠ¨å‰ç«¯å’Œåç«¯
```bash
npm run dev
```

#### æ–¹å¼äºŒï¼šä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
```bash
npm run dev:all
```

#### æ–¹å¼ä¸‰ï¼šåˆ†åˆ«å¯åŠ¨
```bash
# ç»ˆç«¯1 - åç«¯
npm run server:dev

# ç»ˆç«¯2 - å‰ç«¯
npm run client:dev

# ç»ˆç«¯3 - è½åœ°é¡µï¼ˆå¯é€‰ï¼‰
npm run landing:dev

# ç»ˆç«¯4 - Electron åº”ç”¨ï¼ˆå¯é€‰ï¼‰
npm run windows:dev
```

### 9.2 è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ |
|------|------|
| å‰ç«¯åº”ç”¨ | http://localhost:5173 |
| åç«¯ API | http://localhost:3000 |
| è½åœ°é¡µ | http://localhost:8080 |
| API å¥åº·æ£€æŸ¥ | http://localhost:3000/api/health |

### 9.3 é»˜è®¤ç®¡ç†å‘˜è´¦å·

é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼š
- ç”¨æˆ·å: ç¯å¢ƒå˜é‡ `ADMIN_USERNAME` çš„å€¼
- å¯†ç : ç¯å¢ƒå˜é‡ `ADMIN_PASSWORD` çš„å€¼

---

## 10. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 10.1 æœåŠ¡å™¨ç›®å½•ç»“æ„

```
/var/www/geo-system/
â”œâ”€â”€ client/              # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ landing/             # è½åœ°é¡µé™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ assets/
â”œâ”€â”€ server/              # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ .env
â””â”€â”€ uploads/             # ä¸Šä¼ æ–‡ä»¶ç›®å½•
```

### 10.2 éƒ¨ç½²æ­¥éª¤

#### 1. ä¸Šä¼ æ„å»ºäº§ç‰©

```bash
# ä¸Šä¼ åç«¯
scp -r server/dist/* user@server:/var/www/geo-system/server/
scp server/.env user@server:/var/www/geo-system/server/

# ä¸Šä¼ å‰ç«¯
scp -r client/dist/* user@server:/var/www/geo-system/client/

# ä¸Šä¼ è½åœ°é¡µ
scp -r landing/dist/* user@server:/var/www/geo-system/landing/
```

#### 2. å®‰è£…ç”Ÿäº§ä¾èµ–

```bash
cd /var/www/geo-system/server
npm install --production
```

#### 3. é…ç½® PM2

```bash
# å®‰è£… PM2ï¼ˆå½“å‰ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ 6.0.14ï¼‰
npm install -g pm2@6.0.14

# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
pm2 start config/server-deploy/pm2.config.js

# ä¿å­˜è¿›ç¨‹åˆ—è¡¨
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup

# éªŒè¯å®‰è£…
pm2 -v  # åº”æ˜¾ç¤º 6.0.14
```

#### 4. é…ç½® Nginx

```bash
# Ubuntu å®‰è£… Nginxï¼ˆå½“å‰ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ 1.24.0ï¼‰
sudo apt install nginx

# éªŒè¯å®‰è£…
nginx -v  # åº”æ˜¾ç¤º nginx version: nginx/1.24.0 (Ubuntu)

# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp config/nginx/geo-system.conf /etc/nginx/sites-available/

# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/geo-system.conf /etc/nginx/sites-enabled/

# ä¿®æ”¹é…ç½®ä¸­çš„åŸŸå/IP
sudo nano /etc/nginx/sites-available/geo-system.conf

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 10.3 PM2 å¸¸ç”¨å‘½ä»¤

```bash
pm2 status              # æŸ¥çœ‹çŠ¶æ€
pm2 logs geo-server     # æŸ¥çœ‹æ—¥å¿—
pm2 restart geo-server  # é‡å¯æœåŠ¡
pm2 stop geo-server     # åœæ­¢æœåŠ¡
pm2 monit               # ç›‘æ§é¢æ¿
```

---

## 11. éªŒè¯éƒ¨ç½²

### 11.1 å¥åº·æ£€æŸ¥

```bash
# API å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/health

# é¢„æœŸå“åº”
{"status":"ok","timestamp":"2026-01-23T..."}
```

### 11.2 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥ PM2 è¿›ç¨‹
pm2 status

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i:3000
lsof -i:5432
lsof -i:6379

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
psql -h localhost -U geo_user -d geo_system -c "SELECT 1;"

# æ£€æŸ¥ Redis è¿æ¥
redis-cli ping
```

### 11.3 åŠŸèƒ½éªŒè¯

1. è®¿é—®å‰ç«¯åº”ç”¨ï¼Œç¡®è®¤é¡µé¢æ­£å¸¸åŠ è½½
2. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
3. æµ‹è¯• API æ¥å£å“åº”
4. æ£€æŸ¥ WebSocket è¿æ¥

---

## 12. å¸¸è§é—®é¢˜

### 12.1 æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜**: `FATAL: password authentication failed for user "geo_user"`

**è§£å†³**:
```bash
# macOS (PostgreSQL 14.18)
# æ£€æŸ¥ pg_hba.conf é…ç½®
nano /opt/homebrew/var/postgresql@14/pg_hba.conf

# Ubuntu (PostgreSQL 16.11)
sudo nano /etc/postgresql/16/main/pg_hba.conf

# ç¡®ä¿æœ‰ä»¥ä¸‹è¡Œ
local   all   geo_user   md5
host    all   geo_user   127.0.0.1/32   md5

# é‡å¯ PostgreSQL
# macOS
brew services restart postgresql@14

# Ubuntu
sudo systemctl restart postgresql
```

### 12.2 Redis è¿æ¥å¤±è´¥

**é—®é¢˜**: `Error: connect ECONNREFUSED 127.0.0.1:6379`

**è§£å†³**:
```bash
# æ£€æŸ¥ Redis çŠ¶æ€
sudo systemctl status redis-server

# å¯åŠ¨ Redis
sudo systemctl start redis-server
```

### 12.3 ç«¯å£è¢«å ç”¨

**é—®é¢˜**: `Error: listen EADDRINUSE: address already in use :::3000`

**è§£å†³**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i:3000

# ç»ˆæ­¢è¿›ç¨‹
kill -9 <PID>
```

### 12.4 è¿ç§»å¤±è´¥

**é—®é¢˜**: è¿ç§»æ‰§è¡ŒæŠ¥é”™

**è§£å†³**:
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npm run db:status

# æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“
psql -h localhost -U geo_user -d geo_system

# æŸ¥çœ‹å·²æ‰§è¡Œçš„è¿ç§»
SELECT * FROM schema_migrations ORDER BY version;
```

### 12.5 å‰ç«¯ API è¯·æ±‚å¤±è´¥

**é—®é¢˜**: å‰ç«¯æ— æ³•è¿æ¥åç«¯ API

**è§£å†³**:
1. æ£€æŸ¥ CORS é…ç½®ä¸­æ˜¯å¦åŒ…å«å‰ç«¯åœ°å€
2. æ£€æŸ¥ç¯å¢ƒå˜é‡ `ALLOWED_ORIGINS`
3. ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ

### 12.6 WebSocket è¿æ¥å¤±è´¥

**é—®é¢˜**: WebSocket è¿æ¥æ–­å¼€

**è§£å†³**:
1. æ£€æŸ¥ Nginx WebSocket ä»£ç†é…ç½®
2. ç¡®è®¤ `/ws` è·¯å¾„æ­£ç¡®ä»£ç†åˆ°åç«¯
3. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å…è®¸ WebSocket è¿æ¥

---

## é™„å½•

### A. å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å¼€å‘
npm run dev              # å¯åŠ¨å‰ç«¯ + åç«¯
npm run dev:all          # å¯åŠ¨æ‰€æœ‰æœåŠ¡

# æ„å»º
npm run build            # æ„å»ºå…¨éƒ¨

# æ•°æ®åº“
cd server
npm run db:status        # æŸ¥çœ‹è¿ç§»çŠ¶æ€
npm run db:migrate       # æ‰§è¡Œè¿ç§»
npm run db:rollback      # å›æ»šè¿ç§»

# æµ‹è¯•
cd server && npm test    # è¿è¡Œæµ‹è¯•

# çŠ¶æ€æ£€æŸ¥
npm run status           # æ£€æŸ¥æœåŠ¡çŠ¶æ€
```

### B. ç›®å½•ç»“æ„è¯´æ˜

```
geo-optimization-system/
â”œâ”€â”€ client/              # ä¸»å‰ç«¯åº”ç”¨ï¼ˆReact + Viteï¼‰
â”œâ”€â”€ server/              # åç«¯ APIï¼ˆNode.js + Expressï¼‰
â”œâ”€â”€ landing/             # è¥é”€è½åœ°é¡µ
â”œâ”€â”€ windows-login-manager/  # Electron æ¡Œé¢åº”ç”¨
â”œâ”€â”€ docs/                # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ nginx/           # Nginx é…ç½®
â”‚   â””â”€â”€ server-deploy/   # éƒ¨ç½²é…ç½®
â”œâ”€â”€ scripts/             # å·¥å…·è„šæœ¬
â””â”€â”€ æŠ€æœ¯äº¤åº•/            # æŠ€æœ¯æ–‡æ¡£
```

### C. è”ç³»æ”¯æŒ

å¦‚é‡åˆ°æœ¬æ–‡æ¡£æœªæ¶µç›–çš„é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ `docs/` ç›®å½•ä¸‹çš„è¯¦ç»†æ–‡æ¡£
2. æ£€æŸ¥ `dev-docs/TROUBLESHOOTING.md`
3. æŸ¥çœ‹é¡¹ç›® Issues

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0.0*
*æœ€åæ›´æ–°: 2026-01-23*


---

## 13. TypeScript é…ç½®è¯´æ˜

### 13.1 ç¼–è¯‘ç›®æ ‡

æ‰€æœ‰é¡¹ç›®ç»Ÿä¸€ä½¿ç”¨ ES2020 ä½œä¸ºç¼–è¯‘ç›®æ ‡ï¼š

| é¡¹ç›® | TypeScript ç‰ˆæœ¬ | ç›®æ ‡ | æ¨¡å—ç³»ç»Ÿ | æ¨¡å—è§£æ |
|------|----------------|------|----------|----------|
| server | 5.3.3 | ES2020 | CommonJS | node |
| client | 5.3.3 | ES2020 | ESNext | bundler |
| landing | 5.3.3 | ES2020 | ESNext | bundler |
| windows-login-manager | 5.3.3 | ES2020 | ESNext | bundler |

### 13.2 ä¸¥æ ¼æ¨¡å¼

æ‰€æœ‰é¡¹ç›®å‡å¯ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼ (`strict: true`)ã€‚

---

## 14. ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®

### 14.1 å‰ç«¯æ„å»ºå®‰å…¨

ç”Ÿäº§ç¯å¢ƒæ„å»ºå·²é…ç½®ä»¥ä¸‹å®‰å…¨æªæ–½ï¼ˆä½¿ç”¨ Vite 5.0.8 + Terser 5.44.1ï¼‰ï¼š

- **ç¦ç”¨ Source Map**: é˜²æ­¢æºä»£ç æ³„éœ²
- **ä»£ç æ··æ·†**: ä½¿ç”¨ Terser è¿›è¡Œä»£ç å‹ç¼©å’Œæ··æ·†
- **ç§»é™¤è°ƒè¯•ä»£ç **: è‡ªåŠ¨ç§»é™¤ `console.log`ã€`console.debug` ç­‰

### 14.2 åç«¯å®‰å…¨é…ç½®

ä½¿ç”¨ä»¥ä¸‹å®‰å…¨ä¸­é—´ä»¶ï¼ˆç‰ˆæœ¬ä¸ server/package.json ä¸€è‡´ï¼‰ï¼š

- **Helmet 8.1.0**: è®¾ç½®å®‰å…¨ HTTP Headers
- **express-rate-limit 8.2.1**: é€Ÿç‡é™åˆ¶ï¼Œé˜²æ­¢æš´åŠ›æ”»å‡»
- **cors 2.8.5**: ä¸¥æ ¼æ§åˆ¶è·¨åŸŸè¯·æ±‚
- **jsonwebtoken 9.0.3**: JWT èº«ä»½éªŒè¯
- **bcrypt 6.0.0**: å¯†ç å“ˆå¸Œ

### 14.3 å¯†é’¥ç”Ÿæˆ

ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼š

```bash
# ç”Ÿæˆ JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# ç”Ÿæˆ API_KEY_ENCRYPTION_KEY
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## 15. Electron æ¡Œé¢åº”ç”¨è¯´æ˜

### 15.1 åŠŸèƒ½è¯´æ˜

Electron æ¡Œé¢åº”ç”¨ (`windows-login-manager/`) æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

- **å½“å‰ç‰ˆæœ¬**: 1.2.7
- **Electron ç‰ˆæœ¬**: 28.0.0
- **Playwright ç‰ˆæœ¬**: 1.57.0

åŠŸèƒ½åˆ—è¡¨ï¼š
1. **å¹³å°è´¦å·ç™»å½•ç®¡ç†**: ç®¡ç†å„å¹³å°çš„ç™»å½•çŠ¶æ€
2. **æœ¬åœ°å‘å¸ƒæ‰§è¡Œ**: ä½¿ç”¨ Playwright è¿›è¡Œæµè§ˆå™¨è‡ªåŠ¨åŒ–å‘å¸ƒ

### 15.2 æµè§ˆå™¨è‡ªåŠ¨åŒ–

åº”ç”¨å†…ç½® Playwright 1.57.0 ç”¨äºæµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼Œæ”¯æŒä»¥ä¸‹ 12 ä¸ªå¹³å°ï¼š
- å°çº¢ä¹¦ (xiaohongshu)
- æŠ–éŸ³ (douyin)
- å¤´æ¡å· (toutiao)
- çŸ¥ä¹ (zhihu)
- ç™¾å®¶å· (baijiahao)
- ç½‘æ˜“å· (wangyi)
- æœç‹å· (souhu)
- CSDN (csdn)
- ç®€ä¹¦ (jianshu)
- å¾®ä¿¡å…¬ä¼—å· (wechat)
- ä¼é¹…å· (qie)
- Bç«™ (bilibili)

### 15.3 æ‰“åŒ…å‘å¸ƒ

è¯¦ç»†çš„æ‰“åŒ…å‘å¸ƒæµç¨‹è¯·å‚è€ƒ `.kiro/steering/electron-release.md`ã€‚

---

## 16. æ•°æ®åº“è¿ç§»æ–‡ä»¶è¯´æ˜

### 16.1 è¿ç§»æ–‡ä»¶åˆ—è¡¨

å½“å‰å…±æœ‰ 62 ä¸ªè¿ç§»æ–‡ä»¶ï¼Œä½äº `server/src/db/migrations/`ï¼š

| ç¼–å·èŒƒå›´ | æ–‡ä»¶åæ¨¡å¼ | è¯´æ˜ |
|----------|-----------|------|
| 001-002 | initial_schema, add_missing_columns | åˆå§‹æ•°æ®åº“ç»“æ„ |
| 011-013 | publishing_* | å‘å¸ƒç³»ç»Ÿç›¸å…³ |
| 014-026 | quota_*, storage_* | é…é¢å’Œå­˜å‚¨ç³»ç»Ÿ |
| 027-033 | subscription_* | è®¢é˜…ç³»ç»Ÿç›¸å…³ |
| 034-042 | preserve_*_snapshot | å¿«ç…§åŠŸèƒ½ç›¸å…³ |
| 043-047 | agent_*, booster_* | ä»£ç†å•†å’ŒåŠ é‡åŒ…ç³»ç»Ÿ |
| 048-062 | fix_*, add_* | ä¿®å¤å’Œæ–°å¢åŠŸèƒ½ |

å®Œæ•´è¿ç§»æ–‡ä»¶åˆ—è¡¨ï¼š
```
001_initial_schema.sql
002_add_missing_columns.sql
011_add_user_id_to_publishing_records.sql
012_add_publishing_status_column.sql
013_make_conversion_targets_fields_nullable.sql
014_add_usage_tracking_and_alerts.sql
015_add_duration_days_to_plans.sql
016_change_daily_to_monthly_quotas.sql
017_add_storage_management.sql
018_add_storage_purchases.sql
019_fix_storage_quotas.sql
020_update_storage_unit_to_mb.sql
021_fix_quota_period.sql
022_fix_quota_system.sql
023_add_missing_quota_checks.sql
024_add_gallery_knowledge_quotas.sql
025_update_quota_functions_for_gallery_knowledge.sql
026_update_check_user_quota_for_gallery_knowledge.sql
027_add_subscription_management.sql
028_add_custom_quota_sync_trigger.sql
029_update_get_user_storage_quota_for_custom.sql
030_fix_quota_expiration.sql
031_subscription_cycle_quota_reset.sql
032_fix_check_user_quota_to_use_custom_quotas.sql
033_fix_usage_stats_sync.sql
034_preserve_conversion_target_snapshot.sql
035_preserve_distillation_snapshot.sql
036_preserve_album_knowledge_base_snapshot.sql
037_preserve_article_images.sql
038_complete_storage_management.sql
039_refactor_storage_reference_counting.sql
040_fix_orphan_image_storage.sql
041_preserve_article_setting_snapshot.sql
042_publishing_records_article_snapshot.sql
043_agent_commission_system.sql
044_agent_discount_system.sql
045_fix_subscription_adjustments_admin_id.sql
046_add_plan_quota_cycle_type.sql
047_add_booster_pack_system.sql
048_fix_user_delete_foreign_keys.sql
049_preserve_article_distillation_snapshot.sql
050_fix_multi_account_constraint.sql
051_fix_consume_quota_function.sql
052_add_email_verification.sql
053_add_missing_tables.sql
054_add_missing_column_and_functions.sql
055_add_product_config_history_columns.sql
056_add_missing_tables_and_columns.sql
057_add_missing_trigger.sql
058_add_article_snapshot_to_publishing_tasks.sql
059_performance_optimization_indexes.sql
060_preserve_platform_account_snapshot.sql
061_snapshot_existing_subscriptions_quotas.sql
062_add_service_events_table.sql
```

### 16.2 è¿ç§»æ–‡ä»¶æ ¼å¼

æ¯ä¸ªè¿ç§»æ–‡ä»¶å¿…é¡»åŒ…å« UP å’Œ DOWN ä¸¤éƒ¨åˆ†ï¼š

```sql
-- ==================== UP ====================
-- å‡çº§ SQL

-- ==================== DOWN ====================
-- å›æ»š SQL
```

---

## 17. ç›‘æ§å’Œæ—¥å¿—

### 17.1 PM2 æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs geo-server

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
pm2 logs geo-server --lines 100

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

### 17.2 æ—¥å¿—æ–‡ä»¶ä½ç½®

- PM2 é”™è¯¯æ—¥å¿—: `/var/www/geo-system/server/logs/pm2-error.log`
- PM2 è¾“å‡ºæ—¥å¿—: `/var/www/geo-system/server/logs/pm2-out.log`
- Nginx è®¿é—®æ—¥å¿—: `/var/log/nginx/geo-system-access.log`
- Nginx é”™è¯¯æ—¥å¿—: `/var/log/nginx/geo-system-error.log`

### 17.3 å¥åº·æ£€æŸ¥ç«¯ç‚¹

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| `/api/health` | åŸºç¡€å¥åº·æ£€æŸ¥ |
| `/api/monitoring/status` | è¯¦ç»†ç›‘æ§çŠ¶æ€ |

---

## 18. å¤‡ä»½å’Œæ¢å¤

### 18.1 æ•°æ®åº“å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump -h localhost -U geo_user -d geo_system > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
psql -h localhost -U geo_user -d geo_system < backup_20260123.sql
```

### 18.2 ä¸Šä¼ æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½ä¸Šä¼ ç›®å½•
tar -czvf uploads_backup_$(date +%Y%m%d).tar.gz /var/www/geo-system/uploads/
```

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0.2*
*æœ€åæ›´æ–°: 2026-01-23*
*é€‚ç”¨ç¯å¢ƒç‰ˆæœ¬:*
- *å¼€å‘ç¯å¢ƒ: Node.js v22.17.0, PostgreSQL 14.18, Redis 8.0.2*
- *ç”Ÿäº§ç¯å¢ƒ: Node.js v22.22.0, PostgreSQL 16.11, Redis 7.0.15, Nginx 1.24.0, PM2 6.0.14*
