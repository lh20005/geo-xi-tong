# 话题使用计数同步修复说明

## 问题描述

用户反馈：话题被引用后，引用计数没有立刻同步到蒸馏结果模块中对应的话题中。

## 根本原因

前端调用的API路径不正确，导致无法获取到话题的 `usage_count` 数据：
- **错误的API**: `/api/topics/${distillationId}` （此端点不存在）
- **正确的API**: `/api/topics/distillation/${distillationId}/stats`

## 修复内容

### 1. 前端修复 (client/src/pages/TopicsPage.tsx)

#### 修改API调用
```typescript
// 修改前
const response = await axios.get(`/api/topics/${distillationId}`);
setTopics(response.data);

// 修改后
const response = await axios.get(`/api/topics/distillation/${distillationId}/stats`);
setTopics(response.data.topics);
```

#### 显示使用计数
在话题列表中添加使用统计信息的显示：
- 显示 `已使用 X 次` 标签
- 显示最后使用时间
- 未使用的话题显示灰色标签，已使用的显示蓝色标签

#### 修复字段名称
API返回的字段名是 `topicId` 而不是 `id`，需要更新所有引用：
- `topic.id` → `topic.topicId`
- `topic.usageCount` - 新增字段
- `topic.lastUsedAt` - 新增字段

### 2. 后端增强 (server/src/routes/topic.ts)

添加了缺失的话题编辑和删除API：

#### 更新话题
```
PUT /api/topics/:id
Body: { question: "新的话题内容" }
```

#### 删除话题
```
DELETE /api/topics/:id
```

## API说明

### 获取蒸馏结果的所有话题统计
```
GET /api/topics/distillation/:distillationId/stats
```

**响应示例**:
```json
{
  "distillationId": 2,
  "topics": [
    {
      "topicId": 26,
      "question": "英国留学机构哪家申请成功率最高",
      "usageCount": 0,
      "lastUsedAt": null
    },
    {
      "topicId": 16,
      "question": "英国留学机构哪家好",
      "usageCount": 1,
      "lastUsedAt": "2025-12-15T12:36:53.999Z"
    }
  ],
  "total": 15
}
```

**排序规则**:
- 按 `usageCount` 从小到大排序
- 相同 `usageCount` 时，按 `topicId` 从小到大排序
- 这样确保未使用的话题排在前面，且按ID顺序显示

## 测试验证

### 运行测试脚本
```bash
./test-topic-usage-sync.sh
```

### 测试步骤

1. **查看当前话题使用情况**
   - 打开蒸馏结果模块
   - 点击某个关键词查看话题列表
   - 应该能看到每个话题的使用次数和最后使用时间

2. **生成一篇文章**
   - 在文章生成模块创建新任务
   - 选择关键词和生成1篇文章
   - 等待文章生成完成

3. **验证计数同步**
   - 返回蒸馏结果模块
   - 刷新或重新打开话题列表
   - 应该能看到被使用的话题的计数已经更新
   - 使用次数 +1
   - 最后使用时间已更新

### 预期结果

✅ 话题列表显示实时的使用统计
✅ 生成文章后，话题的 `usage_count` 立即更新
✅ 未使用的话题（usage_count=0）排在最前面
✅ 显示最后使用时间
✅ 可以编辑和删除话题

## 话题轮换算法

系统使用智能轮换算法确保所有话题均衡使用：

1. **选择规则**: 
   - 选择 `usage_count` 最小的话题
   - 如果有多个话题的 `usage_count` 相同，选择 `id` 最小的

2. **轮换效果**:
   ```
   第1次: 选择 topic_id=26 (usage_count=0)
   第2次: 选择 topic_id=27 (usage_count=0)
   第3次: 选择 topic_id=28 (usage_count=0)
   ...
   当所有话题都用过一轮后:
   第N次: 选择 topic_id=26 (usage_count=1)
   ```

3. **实时更新**:
   - 每次生成文章后，立即更新话题的 `usage_count`
   - 使用数据库事务确保数据一致性
   - 前端调用API可以获取最新的统计数据

## 相关文件

### 前端
- `client/src/pages/TopicsPage.tsx` - 话题列表页面

### 后端
- `server/src/routes/topic.ts` - 话题API路由
- `server/src/services/topicSelectionService.ts` - 话题选择服务
- `server/src/services/articleGenerationService.ts` - 文章生成服务

### 测试
- `test-topic-usage-sync.sh` - 话题使用计数同步测试脚本
- `test-topic-rotation-verification.sh` - 话题轮换算法验证脚本

## 数据库表结构

### topics 表
```sql
CREATE TABLE topics (
  id SERIAL PRIMARY KEY,
  distillation_id INTEGER REFERENCES distillations(id),
  question TEXT NOT NULL,
  usage_count INTEGER DEFAULT 0,  -- 使用次数
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### topic_usage 表
```sql
CREATE TABLE topic_usage (
  id SERIAL PRIMARY KEY,
  topic_id INTEGER REFERENCES topics(id),
  distillation_id INTEGER REFERENCES distillations(id),
  article_id INTEGER REFERENCES articles(id),
  task_id INTEGER REFERENCES generation_tasks(id),
  used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 注意事项

1. **实时性**: 前端每次打开话题列表时都会重新请求API，确保显示最新数据
2. **事务安全**: 使用数据库事务确保 `usage_count` 更新的原子性
3. **向后兼容**: 保留了旧的API端点，不影响其他模块
4. **性能优化**: API使用JOIN查询，一次性获取所有统计数据

## 总结

修复完成后，用户可以在蒸馏结果模块中实时看到每个话题的使用情况：
- ✅ 显示使用次数
- ✅ 显示最后使用时间
- ✅ 按使用次数排序
- ✅ 生成文章后立即同步更新
- ✅ 支持话题编辑和删除
