# 标题输入问题修复

## 问题描述
用户反馈：不能将文章的标题复制到头条号中的标题框中

## 问题诊断

### 1. 数据获取正常
检查 `PublishingExecutor.ts` 第60-66行：
```typescript
const articleResult = await pool.query(
  'SELECT id, title, content FROM articles WHERE id = $1',
  [task.article_id]
);
const article = articleResult.rows[0];  // ✅ 包含 id, title, content
```
**结论**：文章数据（包括标题）从数据库获取正常。

### 2. 数据传递正常
检查 `PublishingExecutor.ts` 第132行：
```typescript
() => adapter.performPublish(page!, article, task.config)
```
**结论**：article对象（包含title）正确传递给adapter。

### 3. 代码BUG发现
在 `ToutiaoAdapter.ts` 中发现**3个严重的Puppeteer API使用错误**：

#### Bug 1: 标题输入框查找（第140行）
```typescript
// ❌ 错误代码
const allInputs = await page.$('input[type="text"]');
if (allInputs.length > 0) {  // 错误：page.$() 返回单个元素，没有.length属性
  titleInput = allInputs[0];
}

// ✅ 修复后
const allInputs = await page.$$('input[type="text"]');  // 使用$$返回数组
if (allInputs.length > 0) {
  titleInput = allInputs[0];
}
```

#### Bug 2: 内容编辑器查找（第175行）
```typescript
// ❌ 错误代码
const elements = await page.$(selector);
if (elements.length > 0) {  // 错误：page.$() 返回单个元素

// ✅ 修复后
const elements = await page.$$(selector);  // 使用$$返回数组
if (elements.length > 0) {
```

#### Bug 3: 发布按钮查找（第340行）
```typescript
// ❌ 错误代码
const buttons = await page.$(selector);
if (buttons.length > 0) {  // 错误：page.$() 返回单个元素

// ✅ 修复后
const buttons = await page.$$(selector);  // 使用$$返回数组
if (buttons.length > 0) {
```

## Puppeteer API 说明

### page.$() vs page.$$()
```typescript
// page.$() - 返回单个元素或null
const element = await page.$('selector');
if (element) {  // ✅ 正确
  await element.click();
}

// page.$$() - 返回元素数组
const elements = await page.$$('selector');
if (elements.length > 0) {  // ✅ 正确
  await elements[0].click();
}
```

## 修复内容

### 1. 修复所有API调用
- 将所有 `page.$()` 改为 `page.$$()` 当需要检查数量时
- 保持 `page.$()` 当只需要单个元素时

### 2. 增强标题输入逻辑
```typescript
if (titleInput) {
  const title = config.title || article.title;
  console.log(`[头条号] 准备输入标题: "${title}"`);
  console.log(`[头条号] 标题长度: ${title.length} 个字符`);
  
  // 点击输入框获得焦点
  await titleInput.click();
  await new Promise(resolve => setTimeout(resolve, 500));
  
  // 清空输入框（使用Ctrl+A全选后删除）
  await page.keyboard.down('Control');
  await page.keyboard.press('KeyA');
  await page.keyboard.up('Control');
  await page.keyboard.press('Backspace');
  await new Promise(resolve => setTimeout(resolve, 300));
  
  // 输入标题
  await titleInput.type(title, { delay: 50 });
  console.log('[头条号] ✅ 标题输入完成');
  
  // 验证标题是否输入成功
  const inputValue = await page.evaluate(el => (el as HTMLInputElement).value, titleInput);
  console.log(`[头条号] 验证标题输入: "${inputValue}"`);
  
  if (inputValue !== title) {
    console.log('[头条号] ⚠️ 标题输入不完整，尝试重新输入');
    // 重新输入逻辑...
  }
}
```

### 3. 增强日志输出
```typescript
console.log('[头条号] 开始发布文章');
console.log(`[头条号] 文章ID: ${article.id}`);
console.log(`[头条号] 文章标题: "${article.title}"`);
console.log(`[头条号] 标题长度: ${article.title.length} 个字符`);
```

## 测试方法

1. 启动服务器并查看控制台日志：
```bash
cd server && npm run dev
```

2. 点击"执行"按钮后，观察控制台输出：
```
[头条号] 开始发布文章
[头条号] 文章ID: 123
[头条号] 文章标题: "测试文章标题"
[头条号] 标题长度: 6 个字符
[头条号] 第1步：查找标题输入框
[头条号] ✅ 找到标题输入框: input[placeholder*="请输入文章标题"]
[头条号] 准备输入标题: "测试文章标题"
[头条号] 开始输入标题...
[头条号] ✅ 标题输入完成
[头条号] 验证标题输入: "测试文章标题"
```

3. 观察浏览器：
   - ✅ 标题输入框应该显示文章标题
   - ✅ 如果标题没有显示，检查控制台是否有错误日志

## 可能的其他原因

如果修复后标题仍然无法输入，可能是：

### 1. 输入框被禁用
```typescript
// 检查输入框是否可用
const isDisabled = await page.evaluate(el => (el as HTMLInputElement).disabled, titleInput);
console.log(`[头条号] 输入框是否禁用: ${isDisabled}`);
```

### 2. 输入框被覆盖
```typescript
// 检查输入框是否可见
const isVisible = await page.evaluate(el => {
  const style = window.getComputedStyle(el);
  return style.display !== 'none' && style.visibility !== 'hidden';
}, titleInput);
console.log(`[头条号] 输入框是否可见: ${isVisible}`);
```

### 3. 页面未完全加载
```typescript
// 增加等待时间
await new Promise(resolve => setTimeout(resolve, 5000));  // 等待5秒
```

## 文件修改

- `server/src/services/adapters/ToutiaoAdapter.ts` - 修复所有Puppeteer API错误，增强日志

## 预期效果

修复后，执行发布任务时应该看到：
1. 控制台输出文章标题和长度
2. 浏览器中标题输入框自动填写标题
3. 控制台输出验证信息确认标题已输入
4. 如果标题输入失败，会自动重试并输出警告信息
