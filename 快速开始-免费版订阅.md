# 快速开始 - 免费版订阅功能

## 🎯 功能说明

系统现在会自动为新注册用户开通免费版订阅，并提供工具为现有无订阅用户批量开通。

## 🚀 快速使用

### 1. 新用户自动开通（已启用）

新用户注册时会自动获得：
- ✅ 免费版订阅（有效期 1 年）
- ✅ 每月 1 篇文章生成配额
- ✅ 每月 1 篇文章发布配额
- ✅ 1 个平台账号
- ✅ 每月 1 次关键词蒸馏
- ✅ 10 MB 存储空间

**无需任何操作，自动生效！**

### 2. 为现有用户批量开通

如果你有现有用户还没有订阅，运行以下命令：

```bash
cd server
npx ts-node src/scripts/reset-users-to-free-subscription.ts
```

## 📊 验证功能

### 方法 1: 注册新用户测试

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser123",
    "password": "Test123456!"
  }'
```

### 方法 2: 查看数据库

```sql
-- 查看最新注册用户的订阅
SELECT 
  u.username,
  sp.plan_name,
  us.status,
  us.end_date,
  us.is_gift
FROM users u
JOIN user_subscriptions us ON us.user_id = u.id
JOIN subscription_plans sp ON sp.id = us.plan_id
WHERE u.created_at > NOW() - INTERVAL '1 hour'
ORDER BY u.created_at DESC;
```

### 方法 3: 运行测试套件

```bash
cd server
npx ts-node src/scripts/test-free-subscription.ts
```

## 📝 查看日志

```bash
# 查看服务器日志中的订阅开通记录
tail -f server/logs/app.log | grep FreeSubscription

# 或者查看控制台输出
# 成功的日志示例：
# [FreeSubscription] 开始为新用户 123 开通免费版订阅...
# [FreeSubscription] ✅ 用户 123 免费版订阅开通完成
```

## ⚠️ 注意事项

1. **确保免费版套餐存在**
   ```sql
   SELECT * FROM subscription_plans WHERE plan_code = 'free';
   ```

2. **确保套餐已激活**
   ```sql
   UPDATE subscription_plans SET is_active = true WHERE plan_code = 'free';
   ```

3. **确保配额已配置**
   ```sql
   SELECT * FROM plan_features WHERE plan_id = (
     SELECT id FROM subscription_plans WHERE plan_code = 'free'
   );
   ```

## 🔧 故障排查

### 问题：注册成功但没有订阅

**检查步骤：**
1. 查看服务器日志是否有错误
2. 确认免费版套餐存在
3. 确认数据库连接正常

**解决方法：**
```bash
# 手动为用户开通
cd server
npx ts-node -e "
const { freeSubscriptionService } = require('./src/services/FreeSubscriptionService');
const { pool } = require('./src/db/database');
(async () => {
  const userId = 123; // 替换为实际用户ID
  await freeSubscriptionService.activateFreeSubscriptionForNewUser(userId);
  await pool.end();
})();
"
```

### 问题：批量重置部分用户失败

**原因：** 老用户可能有数据不一致问题

**解决方法：** 查看日志中的具体错误信息，针对性修复

## 📚 更多文档

- 详细功能说明：`免费版订阅自动开通功能.md`
- 测试指南：`测试免费版订阅功能.md`
- 实现总结：`免费版订阅功能实现总结.md`

## ✅ 完成清单

部署后请确认：

- [ ] 新用户注册自动获得订阅
- [ ] 订阅有效期为 1 年
- [ ] 配额正确初始化
- [ ] 存储空间正确初始化
- [ ] 日志记录正常
- [ ] 现有用户已批量开通（如需要）

---

**就这么简单！功能已经自动启用。** 🎉
