# 文章生成模块逻辑说明

## 概述

文章生成模块是一个智能的内容生成系统，它通过组合多个用户选择的条件，利用AI生成高质量的文章内容。

## 核心流程

### 1. 用户选择条件

用户在创建生成任务时需要选择以下条件：

```typescript
interface TaskConfig {
  distillationId: number;        // 蒸馏结果ID（关键词+话题）
  albumId: number;               // 图库ID（文章配图来源）
  knowledgeBaseId: number;       // 知识库ID（企业专业知识）
  articleSettingId: number;      // 文章设置ID（写作风格和提示词）
  conversionTargetId?: number;   // 转化目标ID（必选，企业信息）
  articleCount: number;          // 要生成的文章数量
}
```

#### 1.1 蒸馏结果（Distillation）
- **作用**：提供文章的核心关键词和相关话题
- **内容**：
  - 一个关键词（如"英国留学"）
  - 多个用户真实提问（如"靠谱的英国留学机构哪家好"）
- **生成方式**：通过AI对关键词进行"蒸馏"，生成12个真实用户可能搜索的问题

#### 1.2 图库（Album）
- **作用**：为文章提供配图
- **选择策略**：均衡选择（使用次数最少的图片优先）
- **插入位置**：
  - 图片放在末尾


#### 1.3 知识库（Knowledge Base）
- **作用**：提供企业专业知识和背景信息
- **内容**：企业相关的专业文档、产品信息、服务介绍等
- **使用方式**：作为AI生成文章的参考资料，确保内容专业性和准确性

#### 1.4 文章设置（Article Setting）
- **作用**：定义文章的写作风格和要求
- **内容**：包含提示词模板，指导AI如何撰写文章
- **新功能**：支持使用占位符变量，完全自定义文章生成逻辑

**支持的占位符**：
- `{keyword}` - 核心关键词
- `{topics}` - 话题列表（带编号）
- `{topicsList}` - 话题列表（逗号分隔）
- `{companyName}` - 公司名称
- `{knowledgeBase}` - 知识库内容

**示例1：使用占位符（推荐）**：
  ```
  你是一个专业的{keyword}领域专家。
  
  请根据以下用户关心的问题撰写文章：
  {topics}
  
  要求：
  - 围绕"{keyword}"展开
  - 适度提及{companyName}（1-2次）
  - 参考知识库：{knowledgeBase}
  - 字数1500-2500字
  
  输出格式：
  标题：[文章标题]
  [文章正文内容]
  ```

**示例2：不使用占位符（向后兼容）**：
  ```
  你是一个专业的内容创作专家，擅长撰写高质量的SEO优化文章。
  要求：
  1. 文章要围绕核心关键词展开
  2. 自然融入相关话题中的问题和答案
  3. 内容要有价值、有深度
  4. 语言流畅、专业
  5. 字数在1500-2500字之间
  ```

#### 1.5 转化目标（Conversion Target）
- **作用**：标记文章的营销目标，**适度融入文章内容**
- **内容**：企业名称、行业、规模、联系方式等
- **用途**：
  - 在生成文章时，AI会将公司名称自然地融入文章内容
  - 起到宣传推广公司的作用
  - 公司名称会在文章中出现1-2次，方式自然不生硬
  - **避免过度营销**，保持文章的专业性和可读性
- **示例**：
  ```
  公司名称：优学留学咨询
  行业：教育
  规模：51-200人
  联系方式：contact@youxue.com
  ```

### 2. 任务创建流程

```
用户提交配置
    ↓
验证所有资源是否存在
    ↓
创建任务记录（状态：pending）
    ↓
选择话题（单关键词多话题模式）
    ↓
保存任务到数据库
    ↓
异步执行任务
```

#### 2.1 单关键词多话题模式

这是核心创新点：

```typescript
// 如果用户要生成5篇文章，使用同一个关键词的不同话题
selectedDistillationIds = [123, 123, 123, 123, 123]
// 每篇文章会使用不同的话题（question）
```

**优势**：
- 同一关键词可以生成多篇不同角度的文章
- 充分利用蒸馏结果中的所有话题
- 避免内容重复

### 3. 文章生成执行流程

```
任务开始执行（状态：running）
    ↓
批量加载蒸馏结果数据
    ↓
对每篇文章：
    ├─ 选择一个未使用的话题
    ├─ 从图库均衡选择图片
    ├─ 构建AI提示词
    ├─ 调用AI生成内容
    ├─ 解析标题和正文
    ├─ 插入图片标记
    ├─ 保存文章
    └─ 更新使用计数
    ↓
任务完成（状态：completed）
```

#### 3.1 话题选择策略

```typescript
// 为每篇文章选择使用次数最少的话题
// 如果有多个话题使用次数相同，按创建时间升序选择
// 避免在同一任务中重复使用相同话题
```

#### 3.2 图片选择策略

```typescript
// 均衡选择：使用次数最少的图片优先
// 如果图库为空，使用默认占位图片
// 记录图片使用次数，供下次选择参考
```

### 4. AI提示词构建

最终发送给AI的提示词结构：

```
【重要输出要求】
1. 直接输出文章内容，不要包含任何思考过程
2. 使用纯文本格式，不要使用Markdown符号
3. 按照"标题：[标题内容]"格式开始，然后是正文
4. 文章内容要自然流畅，段落之间用空行分隔
5. 【重要】在文章中适度提及公司名称"优学留学咨询"，起到宣传推广作用
   - 只在1-2个合适的地方提及，不要每段都出现
   - 可以在介绍解决方案或给出建议时自然提及
   - 提及方式要自然、不生硬、不重复
   - 避免过度营销，保持文章的专业性和可读性

[文章设置中的提示词模板]

核心关键词：英国留学

相关话题：
1. 靠谱的英国留学机构哪家好
2. 专业的英国留学服务商哪家专业
3. 口碑好的英国留学企业哪家好

企业知识库参考资料：
[知识库内容]

请基于以上企业知识库的内容，确保文章的专业性和准确性。

【转化目标提示】
本文需要适度提及：优学留学咨询
注意：只在1-2个自然的位置提及即可，不要过度重复。
重点是文章质量，而不是频繁提及公司名称。

请撰写一篇专业、高质量的文章。严格按照以下格式输出：

标题：[文章标题]

[文章正文内容]
```

**重要说明**：
- 转化目标（公司名称）需要适度融入文章
- AI会被明确指示在文章中自然提及公司名称
- **只在1-2个位置提及，避免每段都出现**
- 融入方式要自然，不能生硬植入或过度重复
- 通常在介绍服务、产品或给出建议时提及
- 保持文章的专业性，避免过度营销

### 5. 文章内容处理

#### 5.1 AI响应解析

```typescript
// 1. 清理AI响应中的思考过程和Markdown符号
const cleanedResponse = ContentCleaner.cleanArticleContent(response);

// 2. 提取标题（匹配"标题：xxx"格式）
const titleMatch = cleanedResponse.match(/标题[：:]\s*(.+?)(?:\n|$)/);

// 3. 提取正文（移除标题部分后的内容）
const content = cleanedResponse.replace(/标题[：:]\s*.+?(?:\n|$)/, '').trim();
```

#### 5.2 图片插入逻辑

```typescript
// 图片统一放在文章末尾
return `${content}\n\n![文章配图](${imageUrl})`;
```

**说明**：所有文章的配图都统一放在文章末尾，不再根据段落数量调整位置。

### 6. 数据库记录和追踪

#### 6.1 文章保存（事务操作）

```sql
BEGIN;

-- 1. 保存文章
INSERT INTO articles (title, keyword, distillation_id, topic_id, task_id, content, image_url, provider)
VALUES (...);

-- 2. 创建蒸馏使用记录
INSERT INTO distillation_usage (distillation_id, task_id, article_id, used_at)
VALUES (...);

-- 3. 创建话题使用记录
INSERT INTO topic_usage (topic_id, distillation_id, article_id, task_id, used_at)
VALUES (...);

-- 4. 更新蒸馏结果使用次数
UPDATE distillations SET usage_count = usage_count + 1 WHERE id = ?;

-- 5. 更新话题使用次数
UPDATE topics SET usage_count = usage_count + 1 WHERE id = ?;

-- 6. 更新图片使用次数（如果有）
UPDATE images SET usage_count = usage_count + 1 WHERE id = ?;

COMMIT;
```

#### 6.2 使用计数的作用

- **蒸馏结果使用计数**：统计每个关键词被使用的次数
- **话题使用计数**：实现话题轮换，确保均衡使用
- **图片使用计数**：实现图片均衡选择，避免某些图片过度使用

### 7. 容错处理

#### 7.1 任务级别容错

```typescript
// 即使部分文章生成失败，任务仍会继续
// 只要有一篇文章成功，任务状态就是completed
if (generatedCount > 0) {
  await updateTaskStatus(taskId, 'completed', generatedCount);
} else {
  await updateTaskStatus(taskId, 'failed', 0, errorMessage);
}
```

#### 7.2 图片选择容错

```typescript
// 如果图库为空或选择失败，使用默认占位图片
try {
  imageData = await selectBalancedImage(albumId);
} catch (error) {
  imageUrl = '/uploads/gallery/placeholder.png';
  console.log('使用默认占位图片继续执行');
}
```

#### 7.3 AI调用重试机制

```typescript
// 最多重试2次，每次失败后等待5s、10s
for (let attempt = 0; attempt <= maxRetries; attempt++) {
  try {
    return await callAI(prompt);
  } catch (error) {
    if (attempt < maxRetries) {
      await sleep(5000 * (attempt + 1));
    }
  }
}
```

### 8. 生成的文章特点

#### 8.1 内容结构

```
标题：[AI生成的吸引人的标题]

[第一段：导语，概括全文要点]

[第二段：展开论述，可能提及公司名称]

[第三段：深入分析]

[第四段：总结或建议，可能再次提及公司名称]

![文章配图](图片URL)
```

**注意**：图片统一放在文章末尾

#### 8.2 内容质量保证

1. **关键词优化**：围绕核心关键词展开
2. **话题融合**：自然融入用户真实提问
3. **专业性**：基于知识库内容，确保准确性
4. **可读性**：段落清晰，逻辑连贯
5. **SEO友好**：符合搜索引擎优化标准
6. **营销植入**：自然融入转化目标公司名称，起到宣传作用

### 9. 任务状态管理

```typescript
type TaskStatus = 'pending' | 'running' | 'completed' | 'failed';

// pending: 任务已创建，等待执行
// running: 任务正在执行中
// completed: 任务执行完成（至少生成了一篇文章）
// failed: 任务执行失败（所有文章都生成失败）
```

### 10. 实际应用示例

#### 示例配置

```typescript
{
  distillationId: 123,           // 关键词"英国留学"，包含12个话题
  albumId: 456,                  // 包含50张教育相关图片的图库
  knowledgeBaseId: 789,          // 包含留学机构介绍的知识库
  articleSettingId: 101,         // SEO优化文章写作模板
  conversionTargetId: 202,       // 某留学机构
  articleCount: 5                // 生成5篇文章
}
```

#### 生成结果

```
文章1：
- 关键词：英国留学
- 话题：靠谱的英国留学机构哪家好
- 转化目标：优学留学咨询（在文章中出现2次）
- 图片：education_01.jpg（使用次数：1，位置：文章末尾）
- 内容：1800字，包含机构选择建议，自然提及优学留学咨询

文章2：
- 关键词：英国留学
- 话题：专业的英国留学服务商哪家专业
- 转化目标：优学留学咨询（在文章中出现2次）
- 图片：education_15.jpg（使用次数：1，位置：文章末尾）
- 内容：2100字，包含服务商评估标准，展示优学留学咨询的专业性

文章3：
- 关键词：英国留学
- 话题：口碑好的英国留学企业哪家好
- 转化目标：优学留学咨询（在文章中出现1次）
- 图片：education_23.jpg（使用次数：1，位置：文章末尾）
- 内容：1950字，包含口碑评价分析，推荐优学留学咨询

...
```

## 技术亮点

### 1. 占位符变量系统（新功能）⭐
- **完全自定义**：用户可以在文章设置中使用占位符，完全控制文章生成逻辑
- **无需改代码**：调整文章生成策略只需修改文章设置，不需要修改程序
- **灵活组合**：5个占位符可以任意组合使用
- **向后兼容**：不使用占位符也能正常工作

### 2. 单关键词多话题模式
- 同一关键词生成多篇不同角度的文章
- 充分利用蒸馏结果，提高内容多样性

### 3. 智能资源选择
- 话题轮换：使用次数最少的优先
- 图片均衡：避免某些图片过度使用
- 避免重复：同一任务中不重复使用相同话题

### 4. 适度营销植入
- 转化目标（公司名称）适度融入文章内容
- AI被明确指示在1-2个位置自然提及公司
- 避免过度营销，保持文章专业性
- 确保每篇文章都起到宣传推广作用

### 5. 事务保证
- 文章保存和使用计数更新在同一事务中
- 确保数据一致性，避免计数不准确

### 6. 容错机制
- 任务级别容错：部分失败不影响整体
- 资源级别容错：图片缺失使用默认图
- AI调用重试：网络问题自动重试

### 7. 内容质量控制
- AI响应清理：移除思考过程和格式符号
- 智能解析：提取标题和正文
- 图片统一插入：所有图片放在文章末尾

## 总结

文章生成模块通过精心设计的流程，将用户选择的多个条件（关键词、话题、图片、知识库、写作风格）智能组合，利用AI生成高质量、多样化的文章内容。系统具有良好的容错性、可扩展性和数据追踪能力，能够满足批量内容生成的需求。
