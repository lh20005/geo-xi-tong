# 手动批量输入蒸馏结果功能说明

## 功能概述

在蒸馏结果页面新增"新建"按钮，允许用户手动批量输入关键词和对应的蒸馏结果，无需通过AI蒸馏即可直接添加数据。

## 实现内容

### 1. 数据库层修改

#### 迁移文件
- **文件**: `server/src/db/migrations/004_add_manual_distillation_support.sql`
- **内容**: 修改`distillations`表的`provider`字段约束，允许接受`'manual'`值

#### 迁移脚本
- **文件**: `server/src/db/migrate-manual-distillation.ts`
- **命令**: `npm run db:migrate:manual-distillation`
- **功能**: 
  - 删除旧的provider CHECK约束
  - 添加新的约束，支持 'deepseek', 'gemini', 'ollama', 'manual'
  - 为provider字段创建索引

### 2. 后端API实现

#### 新增路由
- **路径**: `POST /api/distillation/manual`
- **文件**: `server/src/routes/distillation.ts`
- **请求参数**:
  ```typescript
  {
    keyword: string,      // 关键词（必填，只能一个）
    questions: string[]   // 蒸馏结果数组（必填，至少一个）
  }
  ```
- **响应数据**:
  ```typescript
  {
    success: boolean,
    distillationId: number,
    keyword: string,
    questions: string[],
    count: number
  }
  ```

#### 功能特点
- 参数验证：确保关键词和蒸馏结果都有效
- 自动过滤空行和空白字符
- 使用事务保证数据一致性
- provider字段自动标记为'manual'

### 3. 前端实现

#### API客户端
- **文件**: `client/src/api/distillationResultsApi.ts`
- **新增方法**: `createManualDistillation(keyword, questions)`

#### 页面组件
- **文件**: `client/src/pages/DistillationResultsPage.tsx`
- **新增功能**:
  - "新建"按钮（带PlusOutlined图标）
  - 手动输入对话框（Modal）
  - 表单验证
  - 提交处理

#### 对话框设计
- **标题**: "手动批量输入蒸馏结果"
- **字段1 - 关键词**:
  - 类型: 单行输入框
  - 验证: 必填，最大255字符
  - 提示: "只能输入一个关键词"
  
- **字段2 - 蒸馏结果**:
  - 类型: 多行文本框（10行）
  - 验证: 必填
  - 提示: "可以输入若干个蒸馏结果，每行一个"
  - 示例:
    ```
    如何提高工作效率？
    团队协作的最佳实践是什么？
    如何管理时间？
    ```

## 使用方法

### 步骤1: 打开蒸馏结果页面
访问系统的"蒸馏结果"页面

### 步骤2: 点击"新建"按钮
在页面右上角找到"新建"按钮并点击

### 步骤3: 填写表单
1. **输入关键词**: 在"关键词"输入框中输入一个关键词
   - 例如: "工作效率"
   
2. **输入蒸馏结果**: 在"蒸馏结果"文本框中输入多个问题，每行一个
   - 例如:
     ```
     如何提高工作效率？
     有哪些时间管理技巧？
     如何避免拖延症？
     团队协作的最佳实践是什么？
     ```

### 步骤4: 保存
点击"保存"按钮，系统会：
- 验证输入数据
- 保存到数据库
- 显示成功消息
- 自动刷新列表

## 数据存储

### distillations表
```sql
INSERT INTO distillations (keyword, provider) 
VALUES ('工作效率', 'manual')
```

### topics表
```sql
INSERT INTO topics (distillation_id, question) VALUES
(distillation_id, '如何提高工作效率？'),
(distillation_id, '有哪些时间管理技巧？'),
(distillation_id, '如何避免拖延症？'),
(distillation_id, '团队协作的最佳实践是什么？')
```

## 与AI蒸馏的区别

| 特性 | AI蒸馏 | 手动输入 |
|------|--------|----------|
| provider值 | deepseek/gemini/ollama | manual |
| 数据来源 | AI生成 | 用户输入 |
| 使用方式 | 相同 | 相同 |
| 后续调用 | 相同 | 相同 |

手动输入的蒸馏结果与AI生成的结果在使用上完全一致，都可以：
- 在文章生成时被选择使用
- 被引用计数追踪
- 在蒸馏结果列表中查看和管理
- 被删除或编辑

## 验证测试

### 测试场景1: 正常输入
```
关键词: "产品设计"
蒸馏结果:
用户体验设计的核心原则是什么？
如何进行用户研究？
产品迭代的最佳实践？
```
**预期**: 成功保存3个蒸馏结果

### 测试场景2: 空行处理
```
关键词: "市场营销"
蒸馏结果:
如何制定营销策略？

什么是内容营销？

社交媒体营销技巧？
```
**预期**: 自动过滤空行，保存3个有效结果

### 测试场景3: 验证失败
```
关键词: (空)
蒸馏结果: "如何学习编程？"
```
**预期**: 显示错误提示"请输入关键词"

### 测试场景4: 查看结果
- 在蒸馏结果列表中应该能看到新添加的数据
- provider列显示为"manual"（如果有显示）
- 可以正常筛选、搜索、删除

## 技术细节

### 事务处理
使用PostgreSQL事务确保数据一致性：
```typescript
await client.query('BEGIN');
// 插入distillation记录
// 批量插入topics记录
await client.query('COMMIT');
```

### 错误处理
- 前端：表单验证 + API错误提示
- 后端：参数验证 + 事务回滚 + 详细错误信息

### 性能优化
- 批量插入topics记录
- 使用索引加速查询
- 前端防抖处理

## 文件清单

### 新增文件
1. `server/src/db/migrations/004_add_manual_distillation_support.sql` - 数据库迁移SQL
2. `server/src/db/migrate-manual-distillation.ts` - 迁移执行脚本
3. `手动批量输入蒸馏结果功能说明.md` - 本文档

### 修改文件
1. `server/src/routes/distillation.ts` - 添加POST /manual路由
2. `server/package.json` - 添加迁移命令
3. `client/src/api/distillationResultsApi.ts` - 添加createManualDistillation方法
4. `client/src/pages/DistillationResultsPage.tsx` - 添加新建按钮和对话框

## 部署步骤

1. **拉取代码**: 获取最新代码
2. **执行迁移**: 
   ```bash
   cd server
   npm run db:migrate:manual-distillation
   ```
3. **重启服务**: 重启后端服务
4. **测试功能**: 访问蒸馏结果页面测试新建功能

## 注意事项

1. **关键词唯一性**: 系统不会自动检查关键词是否重复，允许同一关键词有多条蒸馏记录
2. **数据清理**: 手动输入的数据会自动过滤空行和首尾空格
3. **字符限制**: 关键词最大255字符，蒸馏结果无长度限制（TEXT类型）
4. **provider标识**: 手动输入的记录provider字段为'manual'，便于区分数据来源
5. **使用统计**: 手动输入的蒸馏结果同样会被usage_count追踪

## 后续优化建议

1. **批量导入**: 支持CSV/Excel文件批量导入
2. **模板功能**: 提供常用蒸馏结果模板
3. **编辑功能**: 支持编辑已有的蒸馏结果
4. **重复检测**: 添加关键词重复提醒
5. **数据验证**: 增强蒸馏结果内容的格式验证
