# 配额系统全面审计修复计划

## 问题清单

1. ❌ 蒸馏关键词后，配额中没有减少
2. ❌ 文章生成后，配额显示没有了，但是仍然能生成文章
3. ❌ 存储空间有，但是无法上传图片和文件，提示空间不足

## 配额项目清单

根据系统设计，有以下配额项目：

### 1. 功能配额（plan_features）
- `articles_per_month` - 每月生成文章数
- `publish_per_month` - 每月发布文章数
- `platform_accounts` - 平台账号数（永久）
- `keyword_distillation` - 关键词蒸馏数（每月）

### 2. 存储配额（独立系统）
- `storage_quota_mb` - 存储空间（MB）
- 通过 `user_storage_usage` 表管理

## 审计计划

### 阶段 1: 映射配额使用点（30分钟）

#### 1.1 articles_per_month（文章生成配额）
- **检查点**: POST /api/article-generation/tasks
- **应该做的**:
  - ✅ 检查配额（checkQuota）
  - ❌ 记录使用（recordUsage）- 需要确认
  - ✅ 扣减配额
- **验证**: 生成文章后，配额应该减少

#### 1.2 publish_per_month（发布配额）
- **检查点**: POST /api/publishing/tasks
- **应该做的**:
  - ✅ 检查配额
  - ❌ 记录使用 - 需要确认
  - ✅ 扣减配额
- **验证**: 发布文章后，配额应该减少

#### 1.3 keyword_distillation（蒸馏配额）
- **检查点**: POST /api/distillation/distill
- **应该做的**:
  - ✅ 检查配额
  - ❌ 记录使用 - 需要确认
  - ✅ 扣减配额
- **验证**: 蒸馏后，配额应该减少

#### 1.4 platform_accounts（平台账号数）
- **检查点**: POST /api/platform-accounts
- **应该做的**:
  - ✅ 检查配额
  - ❌ 记录使用 - 需要确认
  - ✅ 扣减配额
- **验证**: 添加账号后，配额应该减少

#### 1.5 storage_quota_mb（存储空间）
- **检查点**: 
  - POST /api/gallery/albums (上传图片)
  - POST /api/knowledge-bases/:id/documents (上传文档)
- **应该做的**:
  - ✅ 检查存储配额（storageQuotaService.checkQuota）
  - ✅ 记录使用（storageService.recordUsage）
  - ✅ 扣减配额
- **验证**: 上传后，存储使用量应该增加

### 阶段 2: 代码审计（1小时）

#### 2.1 检查每个 API 路由
- [ ] `server/src/routes/articleGeneration.ts`
- [ ] `server/src/routes/publishing.ts`
- [ ] `server/src/routes/distillation.ts`
- [ ] `server/src/routes/platformAccounts.ts`
- [ ] `server/src/routes/gallery.ts`
- [ ] `server/src/routes/knowledgeBases.ts`

#### 2.2 验证配额检查逻辑
对每个路由检查：
1. 是否调用 `usageTrackingService.checkQuota()`？
2. 检查位置是否正确（在操作前）？
3. 检查失败是否正确返回 403？

#### 2.3 验证配额记录逻辑
对每个路由检查：
1. 是否调用 `usageTrackingService.recordUsage()`？
2. 记录位置是否正确（在操作成功后）？
3. 是否在事务中正确处理？

#### 2.4 验证存储配额逻辑
对存储相关路由检查：
1. 是否调用 `storageQuotaService.checkQuota()`？
2. 是否调用 `storageService.recordUsage()`？
3. 是否正确计算文件大小？

### 阶段 3: 数据库函数审计（30分钟）

#### 3.1 check_user_quota 函数
- [ ] 验证逻辑正确性
- [ ] 验证返回值准确性
- [ ] 测试边界情况

#### 3.2 record_feature_usage 函数
- [ ] 验证周期计算正确性
- [ ] 验证 usage_count 更新逻辑
- [ ] 验证并发安全性

#### 3.3 存储配额函数
- [ ] check_storage_quota
- [ ] record_storage_usage
- [ ] 验证单位转换（MB）

### 阶段 4: 创建诊断脚本（30分钟）

创建全面的诊断脚本：
- `diagnose-quota-system.ts` - 诊断所有配额项目
- 检查每个配额的：
  - 检查点是否存在
  - 记录点是否存在
  - 数据一致性

### 阶段 5: 修复问题（1-2小时）

根据审计结果，修复发现的问题：
1. 添加缺失的配额检查
2. 添加缺失的配额记录
3. 修复配额计算错误
4. 修复存储配额问题

### 阶段 6: 集成测试（30分钟）

创建端到端测试：
1. 测试文章生成配额
2. 测试发布配额
3. 测试蒸馏配额
4. 测试存储配额
5. 验证配额显示正确

### 阶段 7: 文档更新（15分钟）

更新文档：
- 配额系统架构图
- 配额使用流程
- 故障排查指南

## 执行顺序

```
1. 创建诊断脚本 (立即)
2. 运行诊断，收集问题 (立即)
3. 代码审计 (系统性)
4. 修复问题 (针对性)
5. 集成测试 (验证)
6. 文档更新 (总结)
```

## 预期产出

1. **诊断报告**: 列出所有配额问题
2. **修复迁移**: 数据库层面的修复
3. **代码修复**: 应用层面的修复
4. **测试脚本**: 自动化验证
5. **文档**: 配额系统完整文档

## 时间估算

- 总计: 3.5-4.5 小时
- 可以分阶段执行
- 优先修复高优先级问题

## 下一步

立即开始阶段 1 和 4：创建全面的诊断脚本，识别所有问题。
