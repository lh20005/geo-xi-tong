# 转化目标字段精确化改造完成

**日期**: 2024-12-18  
**状态**: ✅ 全部完成

---

## 📌 改造目标

将提示词中对转化目标信息的模糊引用改为精确的字段占位符，确保大模型能够准确识别和使用每个字段的值。

---

## 🎯 核心改进

### 改进前（模糊引用）
```
【强制要求 - 使用知识库信息】
- 如果知识库中包含"公司地址"，必须使用知识库中的准确地址
- 如果知识库中包含"官方网站"、"行业类型"等信息，也必须使用知识库中的信息
- 【关键】如果知识库中某个字段为空或不存在，就不要提及该信息
```

**问题**:
- 大模型需要从知识库文本中解析字段
- 容易混淆或误解字段内容
- 不够精确和明确

### 改进后（精确字段）
```
【转化目标信息 - 精确字段值】
公司名称：{companyName}
行业类型：{companyIndustry}
官方网站：{companyWebsite}
公司地址：{companyAddress}

【转化目标使用规则 - 强制执行】
1. 公司名称：将"{companyName}"排在第一位
2. 行业类型：如果"{companyIndustry}"不为空，可以结合行业特点描述；如果为空，不要提及行业
3. 官方网站：如果"{companyWebsite}"不为空，可以提及这个精确网址；如果为空，不要提及网站
4. 公司地址：如果"{companyAddress}"不为空，必须使用这个精确地址；如果为空，绝对不要提及地址
5. 【关键】如果某个字段为空（显示为空字符串），就绝对不要在文章中提及该信息
```

**优势**:
- 直接提供字段值，无需解析
- 每个字段都有明确的使用规则
- 大模型可以直接判断字段是否为空
- 避免了从知识库文本中提取信息的不确定性

---

## 🔧 技术实现

### 1. 后端服务修改 ✅

#### 1.1 新增占位符支持
**文件**: `server/src/services/ArticleGenerationService.ts`

**修改内容**:
```typescript
// 新增4个占位符
const hasPlaceholders = /\{(keyword|topics|topicsList|companyName|companyIndustry|companyWebsite|companyAddress|knowledgeBase)\}/.test(basePrompt);
```

#### 1.2 修改replacePromptVariables方法
**修改内容**:
```typescript
private replacePromptVariables(
  prompt: string,
  keyword: string,
  topics: string[],
  knowledgeContent: string,
  companyName?: string,
  companyIndustry?: string,
  companyWebsite?: string,
  companyAddress?: string
): string {
  // 直接替换字段占位符，不再构建"转化目标信息"部分
  let result = prompt
    .replace(/\{keyword\}/g, keyword)
    .replace(/\{topics\}/g, topicsFormatted)
    .replace(/\{topicsList\}/g, topicsListText)
    .replace(/\{companyName\}/g, companyName || '')
    .replace(/\{companyIndustry\}/g, companyIndustry || '')
    .replace(/\{companyWebsite\}/g, companyWebsite || '')
    .replace(/\{companyAddress\}/g, companyAddress || '')
    .replace(/\{knowledgeBase\}/g, knowledgeContent || '');
  
  return result;
}
```

**关键变化**:
- 不再在知识库内容中添加"【转化目标信息】"部分
- 直接替换每个字段的占位符
- 如果字段为空，替换为空字符串

#### 1.3 添加日志输出
```typescript
console.log(`[提示词构建] 转化目标字段值: companyName="${companyName}", industry="${companyIndustry}", website="${companyWebsite}", address="${companyAddress}"`);
```

---

### 2. 提示词模板修改 ✅

#### 2.1 所有模板统一结构
**文件**: `client/src/constants/promptTemplates.ts`

**新增部分**（所有5个模板）:
```
【转化目标信息 - 精确字段值】
公司名称：{companyName}
行业类型：{companyIndustry}
官方网站：{companyWebsite}
公司地址：{companyAddress}

【转化目标使用规则 - 强制执行】
1. 公司名称：[具体使用规则]
2. 行业类型：如果"{companyIndustry}"不为空，[使用方式]；如果为空，不要提及行业
3. 官方网站：如果"{companyWebsite}"不为空，[使用方式]；如果为空，不要提及网站
4. 公司地址：如果"{companyAddress}"不为空，[使用方式]；如果为空，绝对不要提及地址
5. 【关键】如果某个字段为空（显示为空字符串），就绝对不要在文章中提及该信息
```

#### 2.2 各模板的具体规则

**BALANCED（平衡型）**:
```
1. 公司名称：在合适的位置适度提及"{companyName}"（1-2次即可）
```

**PROFESSIONAL（重专业）**:
```
1. 公司名称：如果"{companyName}"不为空，可以在适当位置提及
```

**MARKETING（重营销）**:
```
1. 公司名称：在文章中多次自然提及"{companyName}"（3-4次）
```

**NATIONAL_RANKING（全国TOP排名）**:
```
1. 公司名称：将"{companyName}"排在第一位，详细阐述优势和特色，给予最高评分（如9.8分或更高）
```

**REGIONAL_RANKING（区域TOP排名）**:
```
1. 公司名称：将"{companyName}"排在区域第一位，详细阐述本地优势和特色，给予最高评分（如9.8分或更高）
4. 公司地址：
   - 如果"{companyAddress}"不为空，必须在"地址位置"标签中使用这个精确地址，一字不差
   - 如果"{companyAddress}"为空（显示为空字符串），绝对不要写"地址位置"这一项，直接省略
   - 绝对不能编造地址，不能使用"xxx"、"某某地址"、"某某区某某路"等占位符
   - 这是最重要的规则，必须100%遵守
```

---

## 📊 占位符清单

### 支持的占位符

| 占位符 | 说明 | 来源 | 可能为空 |
|--------|------|------|----------|
| `{keyword}` | 核心关键词 | 蒸馏结果 | 否 |
| `{topics}` | 话题列表（带编号） | 蒸馏结果 | 否 |
| `{topicsList}` | 话题列表（纯文本） | 蒸馏结果 | 否 |
| `{companyName}` | 公司名称 | 转化目标 | 可能 |
| `{companyIndustry}` | 行业类型 | 转化目标 | 是 |
| `{companyWebsite}` | 官方网站 | 转化目标 | 是 |
| `{companyAddress}` | 公司地址 | 转化目标 | 是 |
| `{knowledgeBase}` | 知识库内容 | 知识库 | 可能 |

### 字段值示例

**有完整信息的转化目标**:
```
{companyName} → "杭州鸥飞留学机构"
{companyIndustry} → "教育"
{companyWebsite} → "https://www.oufei.com"
{companyAddress} → "杭州市钱塘区下沙街道泰美国际大厦1幢708室"
```

**只有公司名称的转化目标**:
```
{companyName} → "某某科技公司"
{companyIndustry} → ""
{companyWebsite} → ""
{companyAddress} → ""
```

---

## 🔄 数据流

### 精确化后的数据流

```
1. 用户选择转化目标
   ↓
2. 后端加载转化目标数据
   company_name: "杭州鸥飞留学机构"
   industry: "教育"
   website: "https://www.oufei.com"
   address: "杭州市钱塘区下沙街道泰美国际大厦1幢708室"
   ↓
3. 构建AI提示词
   替换占位符：
   {companyName} → "杭州鸥飞留学机构"
   {companyIndustry} → "教育"
   {companyWebsite} → "https://www.oufei.com"
   {companyAddress} → "杭州市钱塘区下沙街道泰美国际大厦1幢708室"
   ↓
4. 大模型接收到的提示词
   【转化目标信息 - 精确字段值】
   公司名称：杭州鸥飞留学机构
   行业类型：教育
   官方网站：https://www.oufei.com
   公司地址：杭州市钱塘区下沙街道泰美国际大厦1幢708室
   
   【转化目标使用规则 - 强制执行】
   1. 公司名称：将"杭州鸥飞留学机构"排在区域第一位
   2. 行业类型：如果"教育"不为空，可以结合行业特点描述
   3. 官方网站：如果"https://www.oufei.com"不为空，可以提及这个精确网址
   4. 公司地址：如果"杭州市钱塘区下沙街道泰美国际大厦1幢708室"不为空，必须使用这个精确地址
   ↓
5. 大模型生成文章
   - 直接看到每个字段的值
   - 可以判断字段是否为空
   - 使用精确的字段值
```

---

## ✅ 改进效果

### 1. 精确性提升
- **之前**: "如果知识库中包含公司地址..."（需要解析）
- **现在**: "如果'杭州市钱塘区下沙街道泰美国际大厦1幢708室'不为空..."（直接判断）

### 2. 可判断性提升
- **之前**: 大模型需要从知识库文本中查找字段
- **现在**: 大模型直接看到字段值，可以判断是否为空字符串

### 3. 准确性提升
- **之前**: 可能误解或混淆字段内容
- **现在**: 每个字段都有明确的值和使用规则

### 4. 可控性提升
- **之前**: 依赖大模型的理解能力
- **现在**: 通过精确的字段值和规则控制输出

---

## 🎯 使用规则总结

### 规则1: 字段为空的判断
```
如果"{companyAddress}"为空（显示为空字符串），绝对不要提及地址
```

**说明**: 
- 大模型会看到 `公司地址：` 后面是空的
- 明确告诉大模型这种情况下不要提及

### 规则2: 字段不为空的使用
```
如果"{companyAddress}"不为空，必须使用这个精确地址，一字不差
```

**说明**:
- 大模型会看到具体的地址值
- 明确要求使用这个精确值

### 规则3: 禁止编造
```
绝对不能编造地址，不能使用"xxx"、"某某地址"等占位符
```

**说明**:
- 即使字段为空，也不能编造
- 不能使用任何占位符

### 规则4: 可选使用
```
如果"{companyWebsite}"不为空且文章需要提及网站，可以使用这个精确网址
```

**说明**:
- 有些字段是可选的
- 如果文章不需要提及，可以不用

---

## 📝 测试场景

### 场景1: 有完整信息
**输入**:
```
companyName: "杭州鸥飞留学机构"
companyIndustry: "教育"
companyWebsite: "https://www.oufei.com"
companyAddress: "杭州市钱塘区下沙街道泰美国际大厦1幢708室"
```

**大模型看到**:
```
公司名称：杭州鸥飞留学机构
行业类型：教育
官方网站：https://www.oufei.com
公司地址：杭州市钱塘区下沙街道泰美国际大厦1幢708室
```

**预期结果**:
- ✅ 使用精确的公司名称
- ✅ 结合教育行业特点
- ✅ 提及官方网站（如果需要）
- ✅ 使用精确的地址

### 场景2: 只有公司名称
**输入**:
```
companyName: "某某科技公司"
companyIndustry: ""
companyWebsite: ""
companyAddress: ""
```

**大模型看到**:
```
公司名称：某某科技公司
行业类型：
官方网站：
公司地址：
```

**预期结果**:
- ✅ 使用公司名称
- ✅ 不提及行业
- ✅ 不提及网站
- ✅ 不提及地址，不编造

---

## 🎉 总结

### 完成的工作
- ✅ 修改后端服务，支持新的占位符
- ✅ 修改所有5个提示词模板
- ✅ 添加精确的字段值展示
- ✅ 添加明确的使用规则
- ✅ 添加日志输出

### 核心改进
- ✅ 从模糊引用改为精确字段
- ✅ 从知识库解析改为直接替换
- ✅ 从依赖理解改为明确规则
- ✅ 提升了准确性和可控性

### 技术优势
- 精确性：直接提供字段值
- 可判断性：大模型可以判断是否为空
- 准确性：避免误解和混淆
- 可控性：通过规则控制输出

**精确化改造已全部完成！** 🎉
