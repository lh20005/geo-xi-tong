# 测试浏览器窗口修复

## ✅ 已完成的修复

### 1. 浏览器窗口大小
- ✅ 添加 `--window-size=1920,1080` 参数
- ✅ 添加 `--start-maximized` 参数
- ✅ 浏览器将以最大化窗口启动

### 2. 滚动策略优化
- ✅ 使用3种滚动方式确保到达底部
- ✅ 使用 `scrollIntoView()` 滚动到按钮位置
- ✅ 增加滚动后的等待时间

### 3. 按钮查找优化
- ✅ 精确选择器 + 多个fallback选择器
- ✅ 文本查找作为最后备选
- ✅ 滚动到按钮后再点击

## 🧪 测试步骤

### 1. 确认服务运行
```bash
# 服务器应该已经自动重启
# 查看日志确认头条号适配器已注册
✅ 注册平台适配器: 头条号
```

### 2. 访问前端
打开浏览器访问：http://localhost:5173/

### 3. 创建发布任务
1. 选择一篇文章（确保包含图片）
2. 选择"头条号"平台
3. 点击"执行发布"

### 4. 观察浏览器行为

**应该看到**：
- ✅ 浏览器以**最大化窗口**启动（不是小窗口）
- ✅ 窗口大小接近你的屏幕大小
- ✅ 页面显示完整，和手动Chrome一样
- ✅ 能够滚动到页面最底部
- ✅ 能够看到"预览并发布"按钮

**执行流程**：
1. 自动登录（使用Cookie）
2. 填写标题（可见光标点击）
3. 填写内容（可见内容输入）
4. 选择单图
5. 上传封面图片
6. 点击确定
7. 点击必需选项
8. **滚动到底部**（应该能看到完整滚动）
9. **点击"预览并发布"**（按钮应该可见）
10. 点击"确认发布"
11. 等待完成

### 5. 检查日志

在服务器终端查看日志：
```
[头条号] 🔄 方式1：滚动到document.body底部
[头条号] 🔄 方式2：滚动到document.documentElement底部
[头条号] 🔄 方式3：使用scrollBy多次滚动
[头条号] ✅ 已完成多种滚动尝试
[头条号] ✅ 找到"预览并发布"按钮
[头条号] 🔄 滚动到按钮位置
[头条号] 🖱️  点击"预览并发布"按钮
[头条号] ✅ 已点击"预览并发布"按钮
```

## 🔍 如何验证窗口大小

### 方法1：观察浏览器窗口
- 浏览器启动时应该是**最大化**的
- 窗口应该占满整个屏幕（或接近）
- 不应该是小窗口

### 方法2：在浏览器控制台检查
打开浏览器DevTools（F12），在Console中执行：
```javascript
console.log('窗口大小:', window.outerWidth, 'x', window.outerHeight);
console.log('视口大小:', window.innerWidth, 'x', window.innerHeight);
```

**期望结果**：
- 窗口大小：接近1920x1080或更大
- 视口大小：1920x1080

### 方法3：检查滚动
在Console中执行：
```javascript
window.scrollTo(0, document.body.scrollHeight);
console.log('滚动位置:', window.scrollY);
console.log('页面高度:', document.body.scrollHeight);
```

**期望结果**：
- 能够滚动到底部
- 滚动位置 > 0
- 能看到底部的发布按钮

## 🐛 如果还有问题

### 问题1：窗口还是很小
**可能原因**：
- 参数未生效
- 系统限制

**解决方案**：
检查 `BrowserAutomationService.ts` 中的args数组是否包含：
```typescript
'--window-size=1920,1080',
'--start-maximized'
```

### 问题2：还是看不到按钮
**可能原因**：
- 页面结构变化
- 选择器失效

**解决方案**：
1. 查看截图：`toutiao-publish-page.png`
2. 手动在Chrome中找到按钮
3. 复制新的选择器
4. 更新代码

### 问题3：滚动不生效
**可能原因**：
- 页面使用了特殊滚动容器
- 不是window滚动

**解决方案**：
在Console中检查：
```javascript
// 查找所有可滚动元素
const scrollables = Array.from(document.querySelectorAll('*')).filter(el => {
  return el.scrollHeight > el.clientHeight;
});
console.log('可滚动元素:', scrollables);
```

## 📊 对比测试

### 修复前的问题
- ❌ 浏览器窗口小（约800x600）
- ❌ 无法滚动到底部
- ❌ 看不到发布按钮
- ❌ 页面显示不完整

### 修复后的效果
- ✅ 浏览器窗口最大化
- ✅ 能够滚动到底部
- ✅ 能看到发布按钮
- ✅ 页面显示完整

## 🎯 成功标志

如果看到以下情况，说明修复成功：
1. ✅ 浏览器以最大化窗口启动
2. ✅ 页面显示和手动Chrome一样
3. ✅ 能够滚动到页面最底部
4. ✅ 能够看到并点击"预览并发布"按钮
5. ✅ 整个发布流程顺利完成

## 📝 相关文件

- `server/src/services/BrowserAutomationService.ts` - 窗口大小配置
- `server/src/services/adapters/ToutiaoAdapter.ts` - 滚动和点击逻辑
- `浏览器窗口大小问题修复.md` - 详细技术说明

## 🚀 开始测试

服务器已经重启，新配置已生效，现在可以测试了！
