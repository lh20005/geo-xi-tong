# 🚀 立即开始测试支付功能

## ✅ 准备工作已完成

- ✅ 后端服务已启动
- ✅ Landing 页面已重新构建
- ✅ 微信支付已配置
- ✅ ngrok 隧道运行中

## 📋 测试步骤

### 步骤 1: 清除浏览器缓存 ⚠️ 重要！

**为什么要清除缓存？**  
前端代码已更新，但浏览器可能缓存了旧的 JavaScript 文件。

**如何清除：**

**Mac (Chrome/Edge/Firefox):**
```
Cmd + Shift + R
```

**Windows/Linux (Chrome/Edge/Firefox):**
```
Ctrl + Shift + R
```

或者使用无痕模式：
- Chrome/Edge: `Cmd/Ctrl + Shift + N`
- Firefox: `Cmd/Ctrl + Shift + P`

### 步骤 2: 访问测试页面（验证配置）

```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/test.html
```

**预期结果：**
- ✅ 显示"是否 ngrok: ✅ 是"
- ✅ API URL 显示 ngrok 地址（不是 localhost）
- ✅ 点击"测试 API 连接"显示成功
- ✅ 点击"测试创建订单"显示成功

**如果测试页面显示正确，继续下一步。**

### 步骤 3: 访问主页面

```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev
```

**首次访问提示：**
- ngrok 免费版会显示警告页面
- 点击 **"Visit Site"** 按钮继续

### 步骤 4: 登录系统

- 用户名：`lzc2005`
- 密码：`Woshixiaogou2005`

### 步骤 5: 测试支付流程

1. **滚动到价格方案部分**
2. **点击任意套餐的"立即购买"按钮**
3. **支付弹窗应该显示：**
   - 套餐名称
   - 支付金额（¥0.01）
   - 二维码
4. **打开浏览器控制台 (F12)**
5. **检查 Network 标签**
6. **确认所有 API 请求都发送到 ngrok 地址**

### 步骤 6: 扫码支付（可选）

1. 使用微信扫描二维码
2. 完成支付（测试金额 ¥0.01）
3. 观察页面是否自动检测到支付成功
4. 检查是否自动跳转

## 🔍 验证要点

### 1. 控制台日志

打开浏览器控制台 (F12)，应该看到：

```javascript
[Landing Config] 环境: {
  hostname: "granolithic-pseudoprosperous-rebeca.ngrok-free.dev",
  isNgrok: true,
  apiUrl: "https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api"
}
```

**❌ 如果看到 `localhost:3000`，说明缓存没有清除，请重新清除缓存。**

### 2. Network 请求

在 Network 标签中，所有 API 请求应该是：

```
✅ https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/orders
✅ https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/orders/ORD.../status
```

**❌ 不应该是：**
```
❌ http://localhost:3000/api/orders
```

### 3. 创建订单

点击购买按钮后，应该：
- ✅ 显示支付弹窗
- ✅ 显示二维码
- ✅ 不显示错误信息
- ✅ 控制台没有 ERR_CONNECTION_REFUSED 错误

### 4. 查询订单状态

支付弹窗打开后，应该：
- ✅ 每2秒查询一次订单状态
- ✅ 请求发送到 ngrok 地址
- ✅ 不显示 Network Error
- ✅ 不显示 ERR_CONNECTION_REFUSED

## ❌ 常见问题

### 问题 1: 还是显示 localhost:3000

**原因：** 浏览器缓存没有清除

**解决：**
1. 使用无痕模式测试
2. 或者手动清除所有缓存
3. 参考 `清除浏览器缓存指南.md`

### 问题 2: 测试页面无法访问

**原因：** 服务器可能还在启动

**解决：**
```bash
# 检查服务器状态
ps aux | grep "tsx.*src/index.ts"

# 如果没有运行，启动服务器
cd server
npm run dev
```

### 问题 3: API 返回 404

**原因：** 后端路由配置问题

**解决：**
1. 检查后端日志
2. 确认服务器已启动
3. 访问 `https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api/health`

### 问题 4: 创建订单失败

**原因：** 微信支付配置问题

**解决：**
1. 检查后端日志
2. 确认微信支付初始化成功
3. 运行 `./test-create-order.sh` 测试

## 📊 测试检查清单

- [ ] 已清除浏览器缓存
- [ ] 测试页面显示正确的 ngrok 配置
- [ ] 测试页面 API 连接成功
- [ ] 测试页面创建订单成功
- [ ] 主页面可以访问
- [ ] 可以成功登录
- [ ] 控制台显示正确的 API URL
- [ ] 点击购买显示支付弹窗
- [ ] 支付弹窗显示二维码
- [ ] Network 请求发送到 ngrok 地址
- [ ] 订单状态查询成功（不显示 ERR_CONNECTION_REFUSED）

## 🎯 成功标志

当你看到以下所有内容时，说明测试成功：

1. ✅ 控制台显示：`isNgrok: true`
2. ✅ 控制台显示：`apiUrl: "https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/api"`
3. ✅ 支付弹窗显示二维码
4. ✅ Network 标签显示请求发送到 ngrok 地址
5. ✅ 没有 ERR_CONNECTION_REFUSED 错误
6. ✅ 订单状态查询成功

## 📞 需要帮助？

如果遇到问题：

1. **查看测试页面：** `https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/test.html`
2. **查看后端日志：** 检查服务器终端输出
3. **查看浏览器控制台：** 检查错误信息
4. **参考文档：**
   - `清除浏览器缓存指南.md`
   - `✅支付功能测试成功.md`
   - `✅完整支付测试指南.md`

## 🚀 开始测试！

现在就访问：
```
https://granolithic-pseudoprosperous-rebeca.ngrok-free.dev/test.html
```

验证配置后，访问主页面开始测试支付功能！

---

**创建时间：** 2024年12月29日 13:20  
**状态：** ✅ 准备就绪  
**下一步：** 清除缓存并开始测试
