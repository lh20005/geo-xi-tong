# 头条号完整发布流程实现

## 📋 实现总结

已完成头条号11步完整自动发布流程，包括封面图片上传。

## 🎯 完整流程（11步）

### 步骤0：导航到发布页面
- 如果不在发布页面，自动点击"发布文章"菜单
- 选择器：`#masterRoot > div > div.pgc-content > section > aside > div > div > div > div.byte-menu-inline.base_creation_tab > div.byte-menu-inline-content > div:nth-child(1) > span > a`

### 步骤1：填写文章标题 📝
- 选择器：`#root > div > div.left-column > div > div.publish-editor > div.publish-editor-title-wrapper > div > div > div.title-wrapper > div > div > div > textarea`
- 操作：
  1. 点击标题输入框（让光标进入）
  2. 三次点击全选文本
  3. 删除旧内容
  4. 输入新标题（80ms延迟）
  5. 验证输入结果
- 等待时间：2秒

### 步骤2：填写正文内容 📄
- 选择器：`#root > div > div.left-column > div > div.publish-editor > div.syl-editor-wrap > div > div.ProseMirror > p`
- 操作：
  1. 点击内容编辑器（让光标进入）
  2. 检测并移除content中的标题（如果存在）
  3. 转换Markdown图片为HTML格式
  4. 设置innerHTML到ProseMirror编辑器
  5. 触发input和change事件
- 等待时间：3秒

### 步骤3：选择封面类型（单图）🖼️
- 选择器：`#root > div > div.left-column > div > div.form-wrap > div.form-container > div:nth-child(1) > div > div.edit-input > div > div.byte-radio-group.byte-radio-size-default.byte-radio-mode-outline.pgc-radio.article-cover-radio-group > label:nth-child(1) > span > span`
- 操作：点击"单图"单选按钮
- 等待时间：2秒

### 步骤4：点击上传封面按钮 📤
- 选择器：`#root > div > div.left-column > div > div.form-wrap > div.form-container > div:nth-child(1) > div > div.edit-input > div > div.article-cover-images-wrap > div.article-cover-images > div > div > div > div`
- 操作：点击上传区域，打开上传对话框
- 等待时间：3秒

### 步骤5：选择本地文件上传 📁
- 选择器：`body > div:nth-child(42) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.btn-upload-scand.is-empty > div > button:nth-child(1) > div > input[type=file]`
- 操作：
  1. 从文章内容中提取第一张图片
  2. 转换为绝对路径（使用process.cwd()）
  3. 使用uploadFile()上传
- 等待时间：**15秒**（预留网络上传时间）

### 步骤6：点击确定按钮 ✅
- 选择器：`body > div:nth-child(42) > div.byte-drawer.primary-drawer.mp-ic-img-drawer.is-first.slideRight-enter-done > div > div > div.byte-drawer-content.byte-drawer-content-nofooter > div > div.byte-tabs-content.byte-tabs-content-horizontal > div > div.byte-tabs-content-item.byte-tabs-content-item-active > div > div > div > div.footer > div.confirm-btns > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square > span`
- 操作：关闭上传对话框
- 等待时间：3秒

### 步骤7：点击必需选项1 ☑️
- 选择器：`#root > div > div.left-column > div > div.form-wrap > div.form-container > div.source-wrap > div > div.edit-input > div > div > span > label:nth-child(3) > span > div`
- 操作：点击第一个必需选项
- 等待时间：2秒

### 步骤8：点击必需选项2 ☑️
- 选择器：`#root > div > div.left-column > div > div.form-wrap > div.form-container > div.source-wrap > div > div.edit-input > div > div > span > span:nth-child(4) > label > span > div`
- 操作：点击第二个必需选项
- 等待时间：2秒

### 步骤9：点击"预览并发布"按钮 🚀
- 选择器：`#root > div > div.left-column > div > div.publish-footer.inline-editor > div > button.byte-btn.byte-btn-primary.byte-btn-size-large.byte-btn-shape-square.publish-btn.publish-btn-last > span`
- 操作：
  1. 滚动到页面底部
  2. 点击"预览并发布"按钮
- 等待时间：4秒（等待确认对话框）

### 步骤10：点击"确认发布"按钮 ✅
- 操作：在弹出的确认对话框中查找并点击"确认发布"按钮
- 查找方式：遍历所有button元素，匹配文本"确认发布"、"发布"或"确定"
- 等待时间：5秒

### 步骤11：等待发布完成 🎉
- 等待时间：10秒（观察发布结果）

## ⏱️ 总等待时间

- 页面加载：5秒
- 步骤间隔：约50秒
- **总计：约55秒**

## 🔧 关键技术点

### 1. 精确选择器
- 使用用户提供的完整CSS选择器路径
- 每个选择器都有fallback备选方案
- 超时处理：5-8秒

### 2. 图片处理
- 从Markdown内容中提取图片：`![alt](url)`
- 路径转换：
  - `/uploads/xxx.png` → `process.cwd() + /uploads/xxx.png`
  - 相对路径 → 绝对路径
- 使用Puppeteer的`uploadFile()`方法

### 3. 等待策略
- 每步操作后都有等待时间
- 图片上传预留15秒（考虑网络延迟）
- 对话框出现预留3-4秒
- 使用`waitForSelector()`确保元素存在

### 4. 错误处理
- 每个步骤都有try-catch包裹
- 失败不中断流程，继续执行
- 详细日志输出（带emoji标记）

### 5. 内容分离
- 标题和内容严格分离
- 自动检测content中是否包含标题
- 如果包含，自动移除第一行

## 📸 调试功能

- 页面截图：`toutiao-publish-page.png`
- 详细日志：每步都有emoji标记
- 验证输出：标题输入后验证value

## 🧪 测试方法

1. 启动服务：
   ```bash
   # 终端1：启动后端
   cd server && npm run dev
   
   # 终端2：启动前端
   cd client && npm run dev
   ```

2. 访问前端：http://localhost:5173/

3. 创建发布任务：
   - 选择文章
   - 选择头条号平台
   - 点击"执行发布"

4. 观察浏览器：
   - 浏览器会自动打开（非headless模式）
   - 可以看到每一步的自动操作
   - 浏览器会保持打开30秒供观察

## ⚠️ 注意事项

1. **图片要求**：
   - 文章必须包含至少一张图片作为封面
   - 图片格式：Markdown `![]()`
   - 图片路径：相对路径或绝对路径

2. **网络要求**：
   - 图片上传需要稳定网络
   - 预留15秒上传时间
   - 如果网络慢，可能需要增加等待时间

3. **Cookie登录**：
   - 首次需要手动登录保存Cookie
   - 后续自动使用Cookie登录
   - Cookie有效期约30天

4. **选择器稳定性**：
   - 头条号页面更新可能导致选择器失效
   - 需要重新获取选择器
   - 每个选择器都有fallback方案

## 📝 文件位置

- 实现文件：`server/src/services/adapters/ToutiaoAdapter.ts`
- 执行器：`server/src/services/PublishingExecutor.ts`
- 浏览器服务：`server/src/services/BrowserAutomationService.ts`

## 🎯 下一步

测试完整流程，观察每一步的执行情况，如有问题及时反馈调整。
