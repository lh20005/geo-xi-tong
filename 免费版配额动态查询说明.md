# 免费版配额动态查询说明

## ✅ 确认：使用动态查询，不是固定值

系统在为新用户开通免费版订阅时，**完全从数据库动态读取最新配额**，不使用任何硬编码的固定值。

## 📊 数据流程

### 1. 查询免费版套餐

```typescript
// 从数据库查询免费版套餐
const planResult = await client.query(
  `SELECT id, plan_code, plan_name 
   FROM subscription_plans 
   WHERE plan_code = 'free' AND is_active = true`
);

const freePlan = planResult.rows[0];
// 获得: { id: 1, plan_code: 'free', plan_name: '免费版' }
```

### 2. 动态读取所有功能配额

```typescript
// 从 plan_features 表读取该套餐的所有配额
const featuresResult = await client.query(
  `SELECT feature_code, feature_name, feature_value, feature_unit
   FROM plan_features
   WHERE plan_id = $1`,
  [planId]  // 使用步骤1获取的套餐ID
);

// 返回所有配置的功能，例如：
// [
//   { feature_code: 'articles_per_month', feature_name: '每月生成文章数', feature_value: 1, feature_unit: '篇' },
//   { feature_code: 'publish_per_month', feature_name: '每月发布文章数', feature_value: 1, feature_unit: '篇' },
//   { feature_code: 'platform_accounts', feature_name: '可管理平台账号数', feature_value: 1, feature_unit: '个' },
//   { feature_code: 'keyword_distillation', feature_name: '关键词蒸馏数', feature_value: 1, feature_unit: '个' },
//   { feature_code: 'storage_space', feature_name: '存储空间', feature_value: 10, feature_unit: 'MB' }
// ]
```

### 3. 遍历并初始化每个配额

```typescript
for (const feature of featuresResult.rows) {
  // 根据 feature_code 确定重置周期
  // 插入到 user_usage 表
  await client.query(
    `INSERT INTO user_usage (
      user_id, feature_code, usage_count, period_start, period_end, last_reset_at
    ) VALUES ($1, $2, 0, $3, $4, $5)`,
    [userId, feature.feature_code, periodStart, periodEnd, periodStart]
  );
}
```

### 4. 动态读取存储空间配额

```typescript
// 从 plan_features 表读取存储空间配额
const storageFeatureResult = await client.query(
  `SELECT feature_value FROM plan_features 
   WHERE plan_id = $1 AND feature_code = 'storage_space'`,
  [planId]
);

if (storageFeatureResult.rows.length > 0) {
  // 配额单位是 MB，转换为字节
  const storageMB = storageFeatureResult.rows[0].feature_value;  // 从数据库读取：10
  storageQuotaBytes = storageMB * 1024 * 1024;  // 10 * 1024 * 1024 = 10485760 bytes
  console.log(`从数据库读取存储配额: ${storageMB} MB`);
} else {
  // 只有在数据库没有配置时才使用默认值
  storageQuotaBytes = 10 * 1024 * 1024;
  console.log(`⚠️ 未找到存储配额配置，使用默认值: 10 MB`);
}
```

## 🔄 配额更新流程

当你在数据库中修改免费版配额时：

### 方法 1: 直接修改数据库

```sql
-- 修改每月生成文章数配额
UPDATE plan_features 
SET feature_value = 5  -- 从 1 改为 5
WHERE plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free')
  AND feature_code = 'articles_per_month';

-- 修改存储空间配额
UPDATE plan_features 
SET feature_value = 50  -- 从 10MB 改为 50MB
WHERE plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free')
  AND feature_code = 'storage_space';
```

### 方法 2: 通过商品管理界面

在系统的商品管理页面修改免费版套餐的配额。

## ✅ 立即生效

修改后，**新注册的用户会立即使用新的配额值**，因为系统每次都从数据库实时查询。

### 验证新配额

```bash
# 1. 修改数据库配额
# 2. 注册新用户
# 3. 检查新用户的配额

cd server
npx ts-node -e "
const { pool } = require('./src/db/database');
(async () => {
  const result = await pool.query(\`
    SELECT 
      u.username,
      pf.feature_name,
      pf.feature_value,
      pf.feature_unit
    FROM users u
    JOIN user_subscriptions us ON us.user_id = u.id
    JOIN plan_features pf ON pf.plan_id = us.plan_id
    WHERE u.username = 'your_new_user'
    ORDER BY pf.id
  \`);
  console.table(result.rows);
  await pool.end();
})();
"
```

## 📍 配额数据存储位置

### 数据库表

1. **subscription_plans** - 套餐基本信息
   ```sql
   SELECT * FROM subscription_plans WHERE plan_code = 'free';
   ```

2. **plan_features** - 套餐功能配额（这是配额的来源）
   ```sql
   SELECT * FROM plan_features 
   WHERE plan_id = (SELECT id FROM subscription_plans WHERE plan_code = 'free');
   ```

3. **user_subscriptions** - 用户订阅记录
   ```sql
   SELECT * FROM user_subscriptions WHERE user_id = 123;
   ```

4. **user_usage** - 用户配额使用记录
   ```sql
   SELECT * FROM user_usage WHERE user_id = 123;
   ```

5. **user_storage_usage** - 用户存储使用记录
   ```sql
   SELECT * FROM user_storage_usage WHERE user_id = 123;
   ```

## 🎯 当前免费版配额

根据数据库查询结果（2026-01-05）：

| 功能 | 配额 | 单位 | 周期 |
|------|------|------|------|
| 每月生成文章数 | 1 | 篇 | 每月重置 |
| 每月发布文章数 | 1 | 篇 | 每月重置 |
| 平台账号数 | 1 | 个 | 永久 |
| 关键词蒸馏数 | 1 | 个 | 每月重置 |
| 存储空间 | 10 | MB | 永久 |

## 🔍 查看当前配额的脚本

```bash
cd server
npx ts-node src/scripts/check-free-plan-quotas.ts
```

输出示例：
```
========================================
检查免费版套餐配额配置
========================================

免费版套餐信息:
  ID: 1
  代码: free
  名称: 免费版
  价格: 0.00

配额配置:
----------------------------------------
每月生成文章数:
  代码: articles_per_month
  配额: 1 篇

关键词蒸馏数:
  代码: keyword_distillation
  配额: 1 个

可管理平台账号数:
  代码: platform_accounts
  配额: 1 个

每月发布文章数:
  代码: publish_per_month
  配额: 1 篇

存储空间:
  代码: storage_space
  配额: 10 MB

========================================
```

## 💡 优势

### 1. 灵活性
- 可以随时调整配额，无需修改代码
- 不同套餐可以有不同的配额组合

### 2. 可维护性
- 配额集中在数据库管理
- 通过商品管理界面可视化修改

### 3. 一致性
- 所有用户使用相同的配额来源
- 避免代码和数据库不一致

### 4. 可扩展性
- 添加新功能只需在数据库添加记录
- 不需要修改代码逻辑

## ⚠️ 注意事项

### 1. 现有用户不受影响

修改配额只影响**新注册的用户**。现有用户的配额已经初始化，不会自动更新。

如果要更新现有用户的配额，需要：
- 使用管理员界面的"配额调整"功能
- 或运行批量更新脚本

### 2. 缓存问题

`SubscriptionService` 中有 Redis 缓存套餐信息（1小时）。如果修改了套餐配置，可能需要：
- 等待缓存过期（1小时）
- 或手动清除缓存
- 或重启服务

### 3. 存储空间单位

存储空间配额在数据库中以 **MB** 为单位存储，但在 `user_storage_usage` 表中以 **字节** 存储。

转换公式：
```typescript
storageQuotaBytes = storageMB * 1024 * 1024
```

## 📝 总结

✅ **完全动态查询**：每次开通订阅都从数据库读取最新配额  
✅ **无硬编码值**：除了默认值（仅在数据库无配置时使用）  
✅ **立即生效**：修改数据库后，新用户立即使用新配额  
✅ **灵活可配置**：通过数据库或管理界面修改配额  

---

**数据来源**：`plan_features` 表  
**查询时机**：每次用户注册时  
**生效范围**：新注册用户  
**更新方式**：修改数据库或使用商品管理界面
