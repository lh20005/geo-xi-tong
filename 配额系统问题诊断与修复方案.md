# 配额系统问题诊断与修复方案

## 问题描述

用户反馈：
1. **存储空间问题**：第一次上传成功，第二次提示空间不足（实际有空间）
2. **文章生成问题**：提示配额不足，无法生成文章

## 根本原因分析

### 1. 缓存问题
- `StorageQuotaService.checkQuota()` 使用 5 分钟缓存
- 上传文件后，缓存未及时更新
- 第二次检查时使用旧的缓存数据，导致误判

### 2. 配额检查时机问题
- **Multer 先上传文件到磁盘**
- **然后才检查配额**
- 如果配额不足，文件已经在磁盘上，但数据库未记录
- 导致实际使用量与记录不一致

### 3. 数据库函数问题
- `record_feature_usage()` 函数中的周期判断有问题
- 迁移 016 将配额从每日改为每月，但函数未更新
- `articles_per_day` 和 `publish_per_day` 应改为 `articles_per_month` 和 `publish_per_month`

## 修复方案

### 修复 1: StorageQuotaService 强制刷新缓存

**文件**: `server/src/services/StorageQuotaService.ts`

**问题**: 配额检查使用缓存数据，导致第二次上传时数据不准确

**修复**: 在 `checkQuota` 方法中强制跳过缓存

```typescript
async checkQuota(
  userId: number,
  fileSizeBytes: number
): Promise<QuotaCheckResult> {
  try {
    // ✅ 修复：跳过缓存，直接从数据库读取最新数据
    const usage = await storageService.getUserStorageUsage(userId, true);
    
    // ... 其余代码保持不变
  }
}
```

### 修复 2: 更新数据库函数的周期判断

**文件**: `server/src/db/migrations/014_add_usage_tracking_and_alerts.sql`

**问题**: 函数中仍使用 `articles_per_day` 和 `publish_per_day`

**修复**: 创建新的迁移文件更新函数

```sql
-- 021_fix_quota_period.sql
CREATE OR REPLACE FUNCTION record_feature_usage(
  p_user_id INTEGER,
  p_feature_code VARCHAR(50),
  p_resource_type VARCHAR(50) DEFAULT NULL,
  p_resource_id INTEGER DEFAULT NULL,
  p_amount INTEGER DEFAULT 1,
  p_metadata JSONB DEFAULT NULL
) RETURNS BOOLEAN AS $$
DECLARE
  v_period_start TIMESTAMP;
  v_period_end TIMESTAMP;
  v_reset_period VARCHAR(20);
BEGIN
  -- ✅ 修复：更新周期判断逻辑
  CASE p_feature_code
    WHEN 'articles_per_month', 'publish_per_month', 'keyword_distillation' THEN
      v_reset_period := 'monthly';
      v_period_start := DATE_TRUNC('month', CURRENT_TIMESTAMP);
      v_period_end := v_period_start + INTERVAL '1 month';
    ELSE
      -- 平台账号等不重置的配额
      v_reset_period := 'never';
      v_period_start := '2000-01-01'::TIMESTAMP;
      v_period_end := '2099-12-31'::TIMESTAMP;
  END CASE;
  
  -- 插入使用记录
  INSERT INTO usage_records (user_id, feature_code, resource_type, resource_id, amount, metadata)
  VALUES (p_user_id, p_feature_code, p_resource_type, p_resource_id, p_amount, p_metadata);
  
  -- 更新统计
  INSERT INTO user_usage (user_id, feature_code, usage_count, period_start, period_end, last_reset_at)
  VALUES (p_user_id, p_feature_code, p_amount, v_period_start, v_period_end, v_period_start)
  ON CONFLICT (user_id, feature_code, period_start)
  DO UPDATE SET 
    usage_count = user_usage.usage_count + p_amount,
    updated_at = CURRENT_TIMESTAMP;
  
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

### 修复 3: 清理过期的 user_usage 记录

**问题**: 可能存在过期的使用记录影响配额检查

**修复**: 创建清理脚本

```sql
-- 删除过期的使用记录
DELETE FROM user_usage 
WHERE period_end < CURRENT_TIMESTAMP;

-- 重新初始化当前月份的使用记录
INSERT INTO user_usage (user_id, feature_code, usage_count, period_start, period_end, last_reset_at)
SELECT 
  u.id,
  'articles_per_month',
  0,
  DATE_TRUNC('month', CURRENT_TIMESTAMP),
  DATE_TRUNC('month', CURRENT_TIMESTAMP) + INTERVAL '1 month',
  DATE_TRUNC('month', CURRENT_TIMESTAMP)
FROM users u
WHERE NOT EXISTS (
  SELECT 1 FROM user_usage uu 
  WHERE uu.user_id = u.id 
    AND uu.feature_code = 'articles_per_month'
    AND uu.period_end > CURRENT_TIMESTAMP
)
ON CONFLICT (user_id, feature_code, period_start) DO NOTHING;
```

### 修复 4: 修复存储使用记录不一致

**问题**: 图片上传成功但存储使用未记录

**修复**: 已通过 `fix-storage-sync-issue.ts` 脚本修复

## 实施步骤

### 步骤 1: 修改 StorageQuotaService
```bash
# 已在代码中标注修复点
```

### 步骤 2: 创建并执行数据库迁移
```bash
cd server
npm run db:create -- fix_quota_period
# 编辑生成的迁移文件
npm run db:migrate
```

### 步骤 3: 清理过期数据
```bash
npx ts-node server/src/scripts/cleanup-expired-usage.ts
```

### 步骤 4: 验证修复
```bash
# 测试存储上传
curl -X POST http://localhost:3000/api/storage/check-quota \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"fileSizeBytes": 1048576, "resourceType": "image"}'

# 测试文章生成配额
curl -X GET http://localhost:3000/api/usage-tracking/quota/articles_per_month \
  -H "Authorization: Bearer <token>"
```

## 预期结果

修复后：
1. ✅ 存储配额检查使用实时数据，不受缓存影响
2. ✅ 文章生成配额正确按月计算
3. ✅ 所有配额检查准确反映当前使用情况
4. ✅ 用户可以正常上传文件和生成文章

## 监控建议

1. 添加配额检查日志
2. 定期清理过期的 user_usage 记录
3. 监控缓存命中率和准确性
4. 添加配额异常告警
