# 商品管理新增套餐功能修复

## 修复时间
2026-01-04

## 问题描述

1. **"新增套餐"按钮是灰色的**：商品管理页面的"新增套餐"按钮被硬编码为 `disabled` 状态，无法点击
2. **需要实现新增套餐后8080落地页同步显示**：新增的套餐需要在落地页的定价区域自动显示

## 问题分析

### 前端问题
- `ProductManagementPage.tsx` 中"新增套餐"按钮有 `disabled` 属性
- 缺少 `handleCreate` 函数来处理新增操作
- 模态框标题和表单逻辑只支持编辑，不支持新增

### 后端问题
- `ProductManagementService.ts` 的 `createPlan` 方法缺少 `duration_days` 字段支持
- 所有查询套餐的 SQL 都缺少 `duration_days` 字段

### 数据同步
- 落地页通过 `/api/subscription/plans` 接口获取套餐
- 该接口调用 `subscriptionService.getAllActivePlans()` 只返回 `is_active = true` 的套餐
- 新增套餐时只要设置 `isActive: true`，就会自动在落地页显示

## 修复方案

### 1. 前端修复 (client/src/pages/ProductManagementPage.tsx)

#### 1.1 启用"新增套餐"按钮
```typescript
// 移除 disabled 属性，添加 onClick 事件
<Button 
  type="primary" 
  icon={<PlusOutlined />}
  onClick={() => handleCreate()}
>
  新增套餐
</Button>
```

#### 1.2 添加 handleCreate 函数
```typescript
const handleCreate = () => {
  setCurrentPlan(null);
  form.resetFields();
  form.setFieldsValue({
    planName: '',
    planCode: '',
    price: 0,
    billingCycle: 'monthly',
    durationDays: 30,
    description: '',
    displayOrder: plans.length + 1,
    isActive: true,
    features: []
  });
  setEditModalVisible(true);
};
```

#### 1.3 更新 handleSave 函数支持新增和编辑
```typescript
const handleSave = async () => {
  try {
    const values = await form.validateFields();
    const token = localStorage.getItem('auth_token');
    
    if (currentPlan) {
      // 更新现有套餐
      await axios.put(`/api/admin/products/plans/${currentPlan.id}`, values, {
        headers: { Authorization: `Bearer ${token}` }
      });
      message.success('套餐更新成功');
    } else {
      // 新增套餐
      await axios.post('/api/admin/products/plans', values, {
        headers: { Authorization: `Bearer ${token}` }
      });
      message.success('套餐新增成功');
    }
    
    setEditModalVisible(false);
    loadPlans();
  } catch (error: any) {
    message.error(error.response?.data?.message || '操作失败');
  }
};
```

#### 1.4 更新模态框支持新增和编辑
```typescript
<Modal
  title={currentPlan ? `编辑套餐 - ${currentPlan.planName}` : '新增套餐'}
  open={editModalVisible}
  onOk={handleSave}
  onCancel={() => setEditModalVisible(false)}
  width={800}
>
  <Form form={form} layout="vertical">
    {/* 新增时显示套餐代码输入框 */}
    {!currentPlan && (
      <Form.Item
        label="套餐代码"
        name="planCode"
        rules={[
          { required: true, message: '请输入套餐代码' },
          { pattern: /^[a-z_]+$/, message: '只能使用小写字母和下划线' }
        ]}
        tooltip="套餐的唯一标识，如：free, professional, enterprise"
      >
        <Input placeholder="例如：professional" />
      </Form.Item>
    )}
    
    {/* 新增时显示有效天数输入框 */}
    {!currentPlan && (
      <Form.Item
        label="有效天数"
        name="durationDays"
        rules={[{ required: true, message: '请输入有效天数' }]}
        tooltip="套餐购买后的有效期，单位：天"
      >
        <InputNumber min={1} style={{ width: '100%' }} placeholder="例如：30" />
      </Form.Item>
    )}
    
    {/* 其他表单项... */}
  </Form>
</Modal>
```

### 2. 后端修复 (server/src/services/ProductManagementService.ts)

#### 2.1 更新接口类型定义
```typescript
export interface SubscriptionPlan {
  id?: number;
  planCode: string;
  planName: string;
  price: number;
  billingCycle: 'monthly' | 'yearly';
  durationDays: number;  // 添加此字段
  isActive: boolean;
  description?: string;
  displayOrder: number;
  features?: PlanFeature[];
  createdAt?: Date;
  updatedAt?: Date;
}
```

#### 2.2 更新所有查询 SQL 包含 duration_days
```sql
SELECT 
  sp.id,
  sp.plan_code as "planCode",
  sp.plan_name as "planName",
  sp.price,
  sp.billing_cycle as "billingCycle",
  sp.duration_days as "durationDays",  -- 添加此字段
  sp.is_active as "isActive",
  sp.description,
  sp.display_order as "displayOrder",
  -- ...
FROM subscription_plans sp
```

#### 2.3 更新 createPlan 方法
```typescript
async createPlan(plan: SubscriptionPlan, adminId: number): Promise<SubscriptionPlan> {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    // 插入套餐（包含 duration_days）
    const planResult = await client.query(
      `INSERT INTO subscription_plans (
        plan_code, plan_name, price, billing_cycle, duration_days,
        is_active, description, display_order
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      RETURNING *`,
      [
        plan.planCode,
        plan.planName,
        plan.price,
        plan.billingCycle,
        plan.durationDays,  // 添加此参数
        plan.isActive,
        plan.description || null,
        plan.displayOrder
      ]
    );
    
    // 插入功能配额...
    // 记录变更历史...
    
    await client.query('COMMIT');
    
    // 清除缓存
    await this.clearPlanCache(plan.planCode);
    
    // 广播更新
    await this.broadcastPlanUpdate('created', createdPlan.id);
    
    return await this.getPlanById(createdPlan.id) as SubscriptionPlan;
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

### 3. 落地页自动同步机制

落地页通过以下机制自动显示新套餐：

1. **API 接口**：`GET /api/subscription/plans`
   - 调用 `subscriptionService.getAllActivePlans()`
   - 只返回 `is_active = true` 的套餐

2. **前端轮询**：`landing/src/pages/HomePage.tsx`
   ```typescript
   useEffect(() => {
     const fetchPlans = async () => {
       const response = await axios.get(`${config.apiUrl}/subscription/plans`);
       if (response.data.success) {
         setPlans(response.data.data || []);
       }
     };
     fetchPlans();
   }, []);
   ```

3. **自动显示**：
   - 新增套餐时设置 `isActive: true`
   - 套餐会立即出现在 `/api/subscription/plans` 的返回结果中
   - 用户刷新落地页即可看到新套餐

## 测试步骤

### 1. 测试新增套餐功能

1. 登录管理员账号
2. 进入"商品管理"页面
3. 点击"新增套餐"按钮（应该可以点击）
4. 填写套餐信息：
   - 套餐代码：`test_plan`
   - 套餐名称：测试套餐
   - 价格：99.00
   - 计费周期：月付
   - 有效天数：30
   - 描述：这是一个测试套餐
   - 显示顺序：4
   - 启用状态：开启
5. 添加功能配额（可选）
6. 点击"保存"
7. 验证：
   - 应该显示"套餐新增成功"
   - 套餐列表中应该出现新套餐
   - 数据库中应该有新记录

### 2. 测试落地页同步显示

1. 打开浏览器访问 `http://localhost:8080`
2. 滚动到"价格方案"区域
3. 验证：
   - 应该看到新增的套餐卡片
   - 卡片显示正确的价格、名称、功能配额
   - 点击"点击购买"按钮应该正常工作

### 3. 测试编辑功能

1. 在商品管理页面点击某个套餐的"编辑"按钮
2. 修改套餐信息
3. 点击"保存"
4. 验证：
   - 应该显示"套餐更新成功"
   - 套餐列表中应该显示更新后的信息
   - 落地页刷新后应该显示更新后的信息

## 数据库验证

```sql
-- 查看所有套餐
SELECT 
  id, plan_code, plan_name, price, 
  billing_cycle, duration_days, is_active, 
  display_order
FROM subscription_plans
ORDER BY display_order;

-- 查看套餐功能配额
SELECT 
  pf.id, sp.plan_name, pf.feature_code, 
  pf.feature_name, pf.feature_value, pf.feature_unit
FROM plan_features pf
JOIN subscription_plans sp ON sp.id = pf.plan_id
ORDER BY sp.display_order, pf.feature_code;

-- 查看配置变更历史
SELECT 
  pch.id, sp.plan_name, u.username, 
  pch.change_type, pch.created_at
FROM product_config_history pch
JOIN subscription_plans sp ON sp.id = pch.plan_id
JOIN users u ON u.id = pch.changed_by
ORDER BY pch.created_at DESC
LIMIT 10;
```

## 注意事项

1. **套餐代码唯一性**：
   - 套餐代码必须唯一
   - 建议使用小写字母和下划线
   - 例如：`free`, `professional`, `enterprise`

2. **有效天数**：
   - 必须大于 0
   - 通常设置为 30（月付）或 365（年付）

3. **显示顺序**：
   - 数字越小越靠前
   - 建议按价格从低到高排序

4. **启用状态**：
   - 只有启用的套餐才会在落地页显示
   - 可以先创建为停用状态，测试后再启用

5. **功能配额**：
   - 配额值 -1 表示无限制
   - 确保功能代码不重复

## 相关文件

### 前端
- `client/src/pages/ProductManagementPage.tsx` - 商品管理页面

### 后端
- `server/src/routes/admin/productManagement.ts` - 商品管理路由
- `server/src/services/ProductManagementService.ts` - 商品管理服务
- `server/src/routes/subscription.ts` - 订阅路由

### 落地页
- `landing/src/pages/HomePage.tsx` - 落地页首页（包含定价区域）

### 数据库
- `subscription_plans` - 套餐表
- `plan_features` - 套餐功能配额表
- `product_config_history` - 配置变更历史表

## 修复完成

✅ "新增套餐"按钮已启用
✅ 新增套餐功能已实现
✅ 支持设置套餐代码、有效天数等完整信息
✅ 支持添加功能配额
✅ 新增套餐后自动在落地页显示（需要启用状态）
✅ 记录配置变更历史
✅ 清除缓存并广播更新
