# 测试配额系统修复

## 已完成的修复

### ✅ 修复 1: StorageQuotaService 强制刷新缓存
- 文件: `server/src/services/StorageQuotaService.ts`
- 修改: `checkQuota()` 方法现在总是跳过缓存，使用最新数据
- 效果: 解决"第一次上传成功，第二次提示空间不足"的问题

### ✅ 修复 2: 更新配额周期判断函数
- 文件: `server/src/db/migrations/021_fix_quota_period.sql`
- 修改: `record_feature_usage()` 函数支持月度配额
- 效果: 文章生成和发布配额按月计算

### ✅ 修复 3: 清理过期数据
- 删除了所有过期的 `user_usage` 记录
- 为所有用户初始化了当前月份的使用记录

### ✅ 修复 4: 同步存储使用记录
- 已通过 `fix-storage-sync-issue.ts` 修复了 testuser2 的存储记录

## 测试步骤

### 测试 1: 存储空间上传（解决第二次上传失败问题）

1. **第一次上传图片**
   ```bash
   # 在前端上传一张图片到相册
   # 或使用 API 测试
   ```

2. **立即第二次上传**
   ```bash
   # 再次上传图片
   # 预期：✅ 成功上传，不会提示空间不足
   ```

3. **验证存储使用**
   ```bash
   # 检查个人中心的存储使用情况
   # 预期：显示正确的已用空间和可用空间
   ```

### 测试 2: 文章生成配额

1. **检查当前配额**
   ```bash
   # 访问个人中心 -> 配额管理
   # 查看"每月生成文章数"
   ```

2. **生成一篇文章**
   ```bash
   # 使用文章生成功能
   # 预期：✅ 成功生成，配额减 1
   ```

3. **再次检查配额**
   ```bash
   # 刷新配额显示
   # 预期：使用量增加 1，剩余量减少 1
   ```

### 测试 3: 发布配额

1. **检查发布配额**
   ```bash
   # 查看"每月发布文章数"配额
   ```

2. **发布一篇文章**
   ```bash
   # 选择文章发布到平台
   # 预期：✅ 成功发布，配额减 1
   ```

3. **验证配额更新**
   ```bash
   # 配额应该实时更新
   ```

## 预期结果

### 存储空间
- ✅ 第一次上传：成功
- ✅ 第二次上传：成功（不再提示空间不足）
- ✅ 第N次上传：只要有空间就能成功
- ✅ 存储使用量实时准确

### 文章生成
- ✅ 有配额时：可以生成
- ✅ 配额用完时：提示配额不足
- ✅ 配额按月重置
- ✅ 使用量实时更新

### 发布功能
- ✅ 有配额时：可以发布
- ✅ 配额用完时：提示配额不足
- ✅ 配额按月重置

## 如何验证修复成功

### 方法 1: 通过前端测试
1. 登录系统
2. 上传多张图片到相册（测试存储）
3. 生成多篇文章（测试文章配额）
4. 发布文章到平台（测试发布配额）
5. 检查个人中心的配额显示是否准确

### 方法 2: 通过 API 测试
```bash
# 1. 获取 token
TOKEN="your_jwt_token"

# 2. 测试存储配额检查
curl -X POST http://localhost:3000/api/storage/check-quota \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"fileSizeBytes": 1048576, "resourceType": "image"}'

# 3. 测试文章生成配额
curl -X GET http://localhost:3000/api/usage-tracking/quota/articles_per_month \
  -H "Authorization: Bearer $TOKEN"

# 4. 测试发布配额
curl -X GET http://localhost:3000/api/usage-tracking/quota/publish_per_month \
  -H "Authorization: Bearer $TOKEN"
```

## 常见问题

### Q: 如果还是提示空间不足怎么办？
A: 
1. 检查实际存储使用：访问个人中心查看存储详情
2. 清除 Redis 缓存：`redis-cli FLUSHDB`
3. 运行同步脚本：`npx ts-node server/src/scripts/fix-storage-sync-issue.ts`

### Q: 配额显示不准确怎么办？
A: 
1. 检查订阅状态：确保有激活的订阅
2. 检查 user_usage 表：`SELECT * FROM user_usage WHERE user_id = <your_id>`
3. 重新初始化配额：重新执行迁移 021

### Q: 如何重置测试用户的配额？
A:
```sql
-- 重置存储使用
UPDATE user_storage_usage 
SET image_storage_bytes = 0, 
    document_storage_bytes = 0, 
    article_storage_bytes = 0,
    image_count = 0,
    document_count = 0,
    article_count = 0
WHERE user_id = <test_user_id>;

-- 重置功能配额
DELETE FROM user_usage WHERE user_id = <test_user_id>;
DELETE FROM usage_records WHERE user_id = <test_user_id>;
```

## 监控建议

1. **添加日志监控**
   - 记录每次配额检查的结果
   - 记录缓存命中/未命中情况

2. **定期清理**
   - 每月初自动清理过期的 user_usage 记录
   - 定期同步存储使用记录

3. **告警设置**
   - 配额使用超过 80% 时告警
   - 配额检查失败时告警
   - 存储使用不一致时告警
