# 📊 GEO系统服务器部署方案对比

## 🤔 你的问题分析

### 当前情况
- 2核4G 服务器访问前端和后端很慢
- 考虑是否需要分离部署

### 慢的原因分析

#### 1. **Puppeteer/Chrome 占用资源过大** 🔴 主要原因
```
Chrome 浏览器进程：
- 内存占用：500MB - 1.5GB（每个实例）
- CPU 占用：高（渲染页面时）
- 文章生成时会启动多个 Chrome 实例
```

#### 2. **Node.js 后端资源占用**
```
正常运行：
- 内存：200-300MB
- CPU：低（空闲时 < 5%）

高负载时（AI 生成、数据库查询）：
- 内存：300-500MB
- CPU：中等（20-40%）
```

#### 3. **PostgreSQL 数据库**
```
正常运行：
- 内存：100-200MB
- CPU：低
```

#### 4. **Redis 缓存**
```
正常运行：
- 内存：50-100MB
- CPU：极低
```

#### 5. **前端静态文件**
```
Nginx 服务：
- 内存：10-20MB
- CPU：极低
- 几乎不占用资源
```

### 2核4G 服务器资源分配

```
总资源：2核 4GB

实际可用：
- CPU：约 1.8核（系统占用 0.2核）
- 内存：约 3.5GB（系统占用 0.5GB）

资源分配：
┌─────────────────────────────────────┐
│ 系统 + Nginx: 0.5GB (14%)          │
├─────────────────────────────────────┤
│ PostgreSQL: 0.2GB (6%)              │
├─────────────────────────────────────┤
│ Redis: 0.1GB (3%)                   │
├─────────────────────────────────────┤
│ Node.js 后端: 0.3GB (9%)            │
├─────────────────────────────────────┤
│ Chrome (1个实例): 1.0GB (29%)       │ ← 主要瓶颈
├─────────────────────────────────────┤
│ 剩余可用: 1.4GB (39%)               │
└─────────────────────────────────────┘

⚠️ 问题：
- 如果同时生成多篇文章（多个 Chrome 实例）
- 内存会迅速耗尽
- 导致系统卡顿、响应慢
```

---

## 🎯 推荐部署方案

### 方案一：单服务器优化部署 ⭐ 推荐（性价比最高）

**适用场景：**
- 预算有限
- 用户量不大（< 50 并发）
- 不频繁生成文章

**服务器配置：**
- **轻量应用服务器 4核8G**（约 ¥80-100/月）
- 或 **云服务器 CVM 4核8G**（约 ¥150-200/月）

**部署架构：**
```
┌─────────────────────────────────────────────┐
│         轻量服务器 4核8G                     │
│  ┌───────────────────────────────────────┐  │
│  │  Nginx (反向代理 + 静态文件)          │  │
│  │  - 前端应用 (client)                  │  │
│  │  - 营销网站 (landing)                 │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Node.js 后端 (PM2)                   │  │
│  │  - API 服务                           │  │
│  │  - WebSocket                          │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  PostgreSQL 数据库                    │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Redis 缓存                           │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Chrome (Puppeteer)                   │  │
│  │  - 限制最多 2 个并发实例              │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘

优点：
✅ 成本最低（单台服务器）
✅ 配置简单
✅ 维护方便
✅ 4核8G 足够应对中等负载

缺点：
⚠️ 单点故障
⚠️ 扩展性有限
```

**优化配置：**

```bash
# 1. 限制 Puppeteer 并发数
# server/src/config/puppeteer.ts
export const PUPPETEER_CONFIG = {
  maxConcurrent: 2,  // 最多同时 2 个 Chrome 实例
  timeout: 60000,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',  // 减少内存使用
    '--disable-gpu',
    '--single-process',  // 单进程模式（减少内存）
  ]
};

# 2. 配置 PostgreSQL 内存限制
# /etc/postgresql/14/main/postgresql.conf
shared_buffers = 512MB
effective_cache_size = 2GB
maintenance_work_mem = 128MB
work_mem = 16MB

# 3. 配置 Redis 内存限制
# /etc/redis/redis.conf
maxmemory 256mb
maxmemory-policy allkeys-lru

# 4. 配置 PM2 内存限制
pm2 start dist/index.js --name geo-backend --max-memory-restart 800M

# 5. 启用 Swap（紧急情况使用）
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

**成本：** ¥80-200/月

---

### 方案二：分离部署（数据库服务器 + 轻量服务器）

**适用场景：**
- 需要更好的性能
- 数据库负载较高
- 预算充足

**服务器配置：**
- **数据库服务器 2核4G**（约 ¥60-80/月）
- **应用服务器 4核8G**（约 ¥80-100/月）

**部署架构：**
```
┌─────────────────────────────────────────────┐
│      应用服务器 4核8G (主服务器)             │
│  ┌───────────────────────────────────────┐  │
│  │  Nginx                                │  │
│  │  - 前端应用                           │  │
│  │  - 营销网站                           │  │
│  │  - API 反向代理                       │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Node.js 后端                         │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Redis 缓存                           │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  Chrome (Puppeteer)                   │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
              ↓ 内网连接
┌─────────────────────────────────────────────┐
│      数据库服务器 2核4G (专用)               │
│  ┌───────────────────────────────────────┐  │
│  │  PostgreSQL 数据库                    │  │
│  │  - 优化配置                           │  │
│  │  - 定期备份                           │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘

优点：
✅ 数据库独立，性能更好
✅ 数据安全性更高
✅ 可以独立扩展
✅ 应用服务器资源更充足

缺点：
⚠️ 成本较高
⚠️ 配置复杂
⚠️ 需要配置内网连接
```

**配置要点：**

```bash
# 1. 数据库服务器配置
# 只开放内网访问
sudo ufw allow from 10.0.0.0/8 to any port 5432

# PostgreSQL 监听内网
# /etc/postgresql/14/main/postgresql.conf
listen_addresses = '0.0.0.0'

# /etc/postgresql/14/main/pg_hba.conf
host    all    all    10.0.0.0/8    md5

# 2. 应用服务器环境变量
# server/.env
DATABASE_URL=postgresql://geo_user:password@内网IP:5432/geo_system
```

**成本：** ¥140-180/月

---

### 方案三：营销网站分离部署 ❌ 不推荐

**为什么不推荐：**

```
┌─────────────────────────────────────────────┐
│      主服务器 2核4G                          │
│  - 前端应用                                  │
│  - 后端 API                                  │
│  - 数据库                                    │
│  - Chrome                                    │
└─────────────────────────────────────────────┘
              +
┌─────────────────────────────────────────────┐
│      轻量服务器 1核2G                        │
│  - 营销网站 (landing)                        │
└─────────────────────────────────────────────┘

问题：
❌ 主服务器资源不足（2核4G 太小）
❌ 营销网站资源占用极少（浪费一台服务器）
❌ 增加维护成本
❌ 跨服务器通信复杂
❌ 性价比极低
```

---

## 🎯 最终推荐

### 根据你的情况，我推荐：

#### **方案 A：预算有限（¥80-100/月）**
```
单台轻量服务器 4核8G
- 部署所有服务
- 优化配置
- 限制 Chrome 并发
```

#### **方案 B：追求性能（¥140-180/月）**
```
应用服务器 4核8G + 数据库服务器 2核4G
- 数据库独立
- 性能更好
- 更安全
```

---

## 🔧 2核4G 服务器优化方案

如果你暂时只能用 2核4G，可以这样优化：

### 1. 禁用 Puppeteer（临时方案）

```typescript
// server/src/config/features.ts
export const FEATURES = {
  enableArticleGeneration: false,  // 禁用文章生成
  enablePuppeteer: false,
};
```

### 2. 使用外部 AI API（不用本地 Chrome）

```env
# 只使用 API，不用 Puppeteer
DEEPSEEK_API_KEY=your_key
GEMINI_API_KEY=your_key
ENABLE_PUPPETEER=false
```

### 3. 限制并发和内存

```bash
# PM2 配置
pm2 start dist/index.js \
  --name geo-backend \
  --max-memory-restart 500M \
  --instances 1

# PostgreSQL 限制
shared_buffers = 256MB
effective_cache_size = 1GB

# Redis 限制
maxmemory 128mb
```

### 4. 使用 CDN 加速静态资源

```nginx
# 前端资源使用 CDN
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

---

## 📊 性能对比

| 配置 | 并发用户 | 文章生成 | 响应时间 | 成本/月 |
|------|---------|---------|---------|---------|
| 2核4G | 10-20 | ❌ 不建议 | 慢 | ¥40-60 |
| 4核8G | 50-100 | ✅ 2篇同时 | 快 | ¥80-100 |
| 4核8G + 2核4G | 100-200 | ✅ 3篇同时 | 很快 | ¥140-180 |
| 8核16G | 200-500 | ✅ 5篇同时 | 极快 | ¥300-400 |

---

## 🎯 我的建议

**立即行动：**
1. ✅ 升级到 **4核8G 轻量服务器**（性价比最高）
2. ✅ 应用优化配置（限制 Chrome 并发）
3. ✅ 启用 Swap 作为缓冲

**长期规划：**
- 用户量增长后，考虑分离数据库
- 使用 CDN 加速静态资源
- 考虑使用云函数处理文章生成

**不要做：**
- ❌ 不要将营销网站单独部署（浪费资源）
- ❌ 不要在 2核4G 上运行 Puppeteer（会很卡）
- ❌ 不要过度优化（先升级硬件）

---

## 📞 需要帮助？

我可以帮你：
1. 生成优化配置文件
2. 编写自动部署脚本
3. 配置监控和告警
4. 性能调优建议

---

**总结：升级到 4核8G，比分离部署更划算！** 🎯
