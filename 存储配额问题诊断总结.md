# 存储配额问题诊断总结

## 问题描述

用户报告：图片和知识库无法上传，提示"额度不足"

## 诊断结果

### ✅ 存储空间充足

通过 `diagnose-storage-quota.ts` 诊断 lzc2005 用户：

```
配额限制: 1024.00 MB
已用空间: 19.14 MB
  - 图片: 19.07 MB (9 个)
  - 文档: 0.02 MB (1 个)
  - 文章: 0.06 MB (52 个)
剩余空间: 1004.86 MB
```

**结论**: 存储空间充足，不是问题所在。

### 🔍 问题分析

系统有**两个独立的配额系统**：

1. **功能配额**（个数限制）
   - 相册数量限制：10 个
   - 知识库数量限制：5 个
   - 由 `usageTrackingService` 管理

2. **存储配额**（空间限制）
   - 文件大小限制：1024 MB
   - 由 `storageQuotaService` 管理

### ⚠️ 可能的问题

根据代码分析，上传图片/文档时会进行以下检查：

1. ✅ 检查相册/知识库是否存在
2. ✅ 检查文件大小限制（单个文件）
3. ✅ 检查存储空间配额
4. ✅ 记录存储使用

**所有检查都已实现**，但用户仍然提示"额度不足"。

## 需要进一步调查

### 方法 1: 查看浏览器控制台错误

请用户：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 尝试上传图片/文档
4. 查看具体的错误信息

### 方法 2: 查看服务器日志

服务器端的 `StorageQuotaService` 有详细的日志输出：

```typescript
console.log('[StorageQuotaService] 配额检查:', {...});
console.log('[StorageQuotaService] 检查结果:', {...});
```

查看这些日志可以确定：
- 当前使用量是多少
- 配额限制是多少
- 为什么被拒绝

### 方法 3: 检查前端显示

用户提到"lzc2005的存储空间剩余0 / 20"，这个显示明显不对。

可能的原因：
1. 前端显示的数据来源错误
2. 前端使用了错误的单位（个数 vs MB）
3. 前端缓存了旧数据

## 建议的修复步骤

### 步骤 1: 确认前端显示问题

检查前端代码中存储空间的显示逻辑：
- 是否正确调用了 `/api/storage/usage` 接口
- 是否正确解析了返回的数据
- 单位是否正确（MB vs 个数）

### 步骤 2: 检查 API 返回数据

直接调用 API 查看返回值：
```bash
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/storage/usage
```

### 步骤 3: 同步存储数据

如果数据不一致，运行同步脚本：
```bash
cd server
npx ts-node src/scripts/fix-all-users-storage-sync.ts
```

## 临时解决方案

如果问题紧急，可以临时：

1. **增加用户配额**
   ```sql
   UPDATE user_storage_usage 
   SET storage_quota_bytes = 10737418240  -- 10 GB
   WHERE user_id = 1;
   ```

2. **清理缓存**
   - 重启服务器
   - 清除浏览器缓存
   - 重新登录

## 下一步行动

1. ✅ 已完成功能配额修复（相册数、知识库数）
2. ⏳ 需要用户提供具体的错误信息
3. ⏳ 需要检查前端显示逻辑
4. ⏳ 需要查看服务器日志

---

**更新时间**: 2026-01-04  
**状态**: 等待用户反馈具体错误信息
