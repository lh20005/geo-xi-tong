# 🎯 测试支付功能

## 当前状态

✅ **微信支付配置已完成**
- 所有必需的配置参数已设置
- 私钥文件已正确放置
- 服务器已成功启动

⚠️ **回调地址使用HTTP**
- 当前使用 localhost，仅用于测试订单创建
- 实际支付需要配置 ngrok（HTTPS）

---

## 快速测试步骤

### 1. 确保所有服务运行

打开4个终端窗口：

**终端1 - 后端服务器**：
```bash
cd server
npm run dev
```
应该看到：`🚀 服务器运行在 http://localhost:3000`

**终端2 - 营销网站**：
```bash
cd landing
npm run dev
```
应该看到：`Local: http://localhost:8080`

**终端3 - 客户端**：
```bash
cd client
npm run dev
```
应该看到：`Local: http://localhost:5173`

**终端4 - ngrok（可选，用于实际支付）**：
```bash
# 如果已安装ngrok
ngrok http 3000

# 如果未安装，跳过此步骤
# 可以测试订单创建，但无法完成实际支付
```

### 2. 测试订单创建

1. 打开浏览器访问：http://localhost:8080

2. 登录账号：
   - 用户名：`lzc2005`
   - 密码：（你的密码）

3. 滚动到"价格方案"部分

4. 点击任意套餐的"点击购买"按钮

5. **预期结果**：
   - ✅ 弹出支付弹窗
   - ✅ 显示订单信息
   - ✅ 显示二维码
   - ✅ 显示订单号

6. **如果失败**：
   - 查看浏览器控制台错误
   - 查看服务器终端日志
   - 参考下面的"故障排除"部分

### 3. 查看订单（后台管理）

1. 打开浏览器访问：http://localhost:5173

2. 登录后台管理系统

3. 点击左侧菜单"订单管理"

4. **预期结果**：
   - ✅ 能看到刚才创建的订单
   - ✅ 订单状态为"待支付"
   - ✅ 显示订单金额和套餐信息

---

## 完整支付测试（需要ngrok）

如果你想测试完整的支付流程（包括微信扫码支付），需要：

### 1. 安装ngrok

```bash
brew install ngrok
```

### 2. 注册ngrok

访问 https://ngrok.com 注册免费账号

### 3. 配置ngrok

```bash
# 在ngrok网站获取你的authtoken
ngrok config add-authtoken 你的token
```

### 4. 启动ngrok

```bash
ngrok http 3000
```

记下显示的 HTTPS 地址，例如：`https://abc123.ngrok.io`

### 5. 更新回调地址

编辑根目录的 `.env` 文件：

```env
WECHAT_PAY_NOTIFY_URL=https://abc123.ngrok.io/api/payment/wechat/notify
```

### 6. 重启服务器

在服务器终端按 `Ctrl+C`，然后：

```bash
cd server
npm run dev
```

### 7. 测试支付

1. 重复上面的"测试订单创建"步骤
2. 用微信扫描二维码
3. 完成支付（测试金额0.01元）
4. **预期结果**：
   - ✅ 支付成功
   - ✅ 页面自动跳转
   - ✅ 订单状态更新为"已支付"
   - ✅ 订阅自动开通
   - ✅ 配额自动分配

---

## 故障排除

### 问题1：点击购买后显示"创建订单失败"

**检查步骤**：

1. 查看服务器日志：
   ```bash
   # 在服务器终端查看错误信息
   ```

2. 检查环境变量：
   ```bash
   cat .env | grep WECHAT_PAY
   ```
   
   应该看到所有6个配置项

3. 检查私钥文件：
   ```bash
   ls -la ~/.wechat-pay/apiclient_key.pem
   cat ~/.wechat-pay/apiclient_key.pem | head -2
   ```
   
   应该看到：`-----BEGIN PRIVATE KEY-----`

### 问题2：二维码不显示

**可能原因**：
- 微信支付API调用失败
- 配置参数不正确

**解决方案**：
1. 查看浏览器控制台错误
2. 查看服务器日志
3. 验证配置参数是否正确

### 问题3：扫码后无法支付

**原因**：回调地址是 localhost

**解决方案**：配置 ngrok（见上面的步骤）

### 问题4：支付成功但订单状态没有更新

**检查步骤**：

1. 确认ngrok在运行：
   ```bash
   # 在ngrok终端查看是否有回调请求
   ```

2. 查看服务器日志：
   ```bash
   # 应该看到"收到微信支付回调"
   ```

3. 检查回调地址：
   ```bash
   cat .env | grep WECHAT_PAY_NOTIFY_URL
   ```
   
   应该是 ngrok 的 HTTPS 地址

---

## 测试检查清单

### 基础测试（不需要ngrok）

- [ ] 后端服务器启动成功
- [ ] 营销网站启动成功
- [ ] 客户端启动成功
- [ ] 能访问营销网站
- [ ] 能登录账号
- [ ] 点击购买按钮
- [ ] 支付弹窗显示
- [ ] 二维码显示
- [ ] 能在后台查看订单

### 完整测试（需要ngrok）

- [ ] ngrok已安装
- [ ] ngrok已配置authtoken
- [ ] ngrok启动成功
- [ ] 已更新回调地址
- [ ] 已重启服务器
- [ ] 能创建订单
- [ ] 能扫码支付
- [ ] 支付成功
- [ ] 订单状态更新
- [ ] 订阅自动开通
- [ ] 配额自动分配

---

## 下一步

### 如果基础测试成功

恭喜！微信支付配置正确，订单创建功能正常。

**可以做的事情**：
1. 在后台管理商品信息
2. 查看订单列表
3. 管理用户订阅

**如果需要实际支付**：
- 配置 ngrok（见上面的步骤）

### 如果测试失败

1. 查看错误信息
2. 参考"故障排除"部分
3. 查看详细文档：
   - `WECHAT_PAY_TROUBLESHOOTING.md`
   - `QUICK_SETUP_WECHAT_PAY.md`

---

## 重要提示

### 关于测试支付

- 微信支付测试环境需要真实支付
- 建议使用最小金额测试（0.01元）
- 测试完成后可以申请退款

### 关于ngrok

- 免费版每次重启地址会变化
- 需要更新 `.env` 中的回调地址
- 付费版可以固定域名

### 关于生产环境

- 生产环境需要真实的服务器
- 需要配置真实的域名和HTTPS
- 需要在微信支付商户平台配置回调域名

---

**创建时间**: 2024年12月29日  
**适用场景**: 本地开发测试

