# 标题内容分离修复完成

## 问题描述
用户反馈：文章标题与文章内容一并都复制到了头条号的文章内容中，而不是分别输入到标题框和内容框。

## 问题原因

### 1. 元素选择器混淆
代码在查找内容编辑器时，没有正确区分：
- **标题输入框**：`<input>` 元素
- **内容编辑器**：`<div contenteditable="true">` 元素

导致可能把标题输入框也当成了内容编辑器。

### 2. API使用错误
```typescript
// ❌ 错误：page.$() 返回单个元素，没有.length
const elements = await page.$(selector);
if (elements.length > 0) {
```

### 3. 没有过滤元素类型
代码使用 `[contenteditable="true"]` 选择器时，可能同时选中了：
- 标题输入框（如果它也是contenteditable）
- 内容编辑器

## 修复方案

### 1. 严格区分标题和内容

```typescript
// 第1步：只输入标题到input元素
const title = config.title || article.title;
await titleInput.type(title, { delay: 50 });  // ✅ 只输入标题

// 第2步：只输入内容到div元素
let htmlContent = article.content  // ✅ 只使用article.content，不包含title
  .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, ...);
```

### 2. 过滤元素类型

```typescript
// 查找所有可编辑元素
const elements = await page.$$(selector);

// 过滤出div元素，排除input元素
const divEditors = [];
for (const el of elements) {
  const tagName = await page.evaluate(e => e.tagName.toLowerCase(), el);
  const placeholder = await page.evaluate(e => e.getAttribute('placeholder') || '', el);
  
  // 只选择div元素，且不包含"标题"字样
  if (tagName === 'div' && !placeholder.includes('标题')) {
    divEditors.push(el);
  }
}

// 使用最后一个div编辑器
contentEditor = divEditors[divEditors.length - 1];
```

### 3. 在page.evaluate中也过滤

```typescript
const setResult = await page.evaluate((html: string) => {
  const selectors = ['.ql-editor', '[contenteditable="true"]', 'div[role="textbox"]'];
  
  for (const selector of selectors) {
    const editors = document.querySelectorAll(selector);
    
    // 过滤出div元素
    const divEditors = Array.from(editors).filter(e => e.tagName.toLowerCase() === 'div');
    
    if (divEditors.length > 0) {
      // 使用最后一个div编辑器
      const editor = divEditors[divEditors.length - 1] as HTMLElement;
      editor.innerHTML = html;  // ✅ 只设置内容，不包含标题
      break;
    }
  }
}, htmlContent);
```

## 修复后的流程

### 步骤1：输入标题
```
1. 查找标题输入框（input元素）
2. 点击输入框
3. 清空输入框
4. 输入 article.title（只输入标题）
5. 验证标题是否输入成功
```

### 步骤2：输入内容
```
1. 查找内容编辑器（div元素，不是input）
2. 过滤：只选择tagName === 'div'的元素
3. 过滤：排除包含"标题"字样的元素
4. 使用最后一个div元素作为内容编辑器
5. 构建HTML内容（只使用article.content，不包含title）
6. 设置editor.innerHTML = htmlContent
```

### 步骤3：点击发布按钮
```
1. 滚动到页面底部
2. 查找"预览并发布"按钮
3. 点击按钮
```

## 关键改进

### 1. 明确的元素类型检查
```typescript
const tagName = await page.evaluate(e => e.tagName.toLowerCase(), el);
console.log(`[头条号] 检查元素: 标签=${tagName}`);

if (tagName === 'div' && !placeholder.includes('标题')) {
  divEditors.push(el);
  console.log(`[头条号] ✓ 这是一个有效的内容编辑器候选`);
} else {
  console.log(`[头条号] ✗ 跳过此元素`);
}
```

### 2. 详细的日志输出
```typescript
console.log('[头条号] 文章标题: "${article.title}"');
console.log('[头条号] 标题长度: ${article.title.length} 个字符');
console.log('[头条号] 内容长度: ${article.content.length} 个字符');
console.log('[头条号] 注意：内容编辑器必须是div元素，不能是input元素');
console.log('[头条号] 注意：只处理article.content，不包含article.title');
```

### 3. 双重过滤机制
- **Puppeteer层面**：过滤出div元素
- **page.evaluate层面**：再次过滤出div元素

## 测试验证

执行发布任务后，观察控制台日志：

```
[头条号] 文章标题: "测试文章"
[头条号] 标题长度: 4 个字符
[头条号] 内容长度: 200 个字符
[头条号] 第1步：查找标题输入框
[头条号] ✅ 找到标题输入框: input[placeholder*="请输入文章标题"]
[头条号] 准备输入标题: "测试文章"
[头条号] ✅ 标题输入完成
[头条号] 验证标题输入: "测试文章"
[头条号] 第2步：查找内容编辑器
[头条号] 找到 2 个可编辑元素
[头条号] 检查元素: 标签=input, placeholder="请输入文章标题"
[头条号] ✗ 跳过此元素（不是div元素）
[头条号] 检查元素: 标签=div, placeholder="请输入正文"
[头条号] ✓ 这是一个有效的内容编辑器候选
[头条号] ✅ 找到内容编辑器（共1个div候选）
[头条号] 注意：只处理article.content，不包含article.title
[头条号] ✅ 内容已设置到编辑器
```

## 预期效果

修复后，在头条号发布页面应该看到：
1. ✅ **标题框**：只显示文章标题（例如："测试文章"）
2. ✅ **内容框**：只显示文章内容（不包含标题）
3. ✅ 标题和内容完全分离，各自在正确的位置

## 文件修改

- `server/src/services/adapters/ToutiaoAdapter.ts` - 完全重写，严格区分标题和内容

## 注意事项

1. **标题只输入一次**：在标题输入框（input元素）
2. **内容不包含标题**：只使用 `article.content`，不包含 `article.title`
3. **元素类型检查**：标题是input，内容是div
4. **过滤机制**：排除包含"标题"字样的元素
5. **日志验证**：通过日志确认元素类型和内容
