# 用户中心架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户中心整合架构                          │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────┐              ┌──────────────────────┐
│   Landing 页面       │              │    主应用 (Client)    │
│  (localhost:8080)    │              │  (localhost:5173)    │
│                      │              │                      │
│  ┌────────────────┐  │              │  ┌────────────────┐  │
│  │  用户菜单      │  │   跳转+Token  │  │  用户中心      │  │
│  │  - 个人中心 ───┼──┼──────────────┼──┤  /user-center  │  │
│  │  - 用户管理    │  │              │  │                │  │
│  │  - 退出登录    │  │              │  │  ┌──────────┐  │  │
│  └────────────────┘  │              │  │  │订阅管理  │  │  │
│                      │              │  │  ├──────────┤  │  │
│  ┌────────────────┐  │              │  │  │订单记录  │  │  │
│  │  支付成功      │  │   跳转+Token  │  │  ├──────────┤  │  │
│  │  PaymentModal ─┼──┼──────────────┼──┤  │个人信息  │  │  │
│  └────────────────┘  │              │  │  ├──────────┤  │  │
│                      │              │  │  │邀请系统  │  │  │
│  ┌────────────────┐  │              │  │  └──────────┘  │  │
│  │  /profile      │  │   重定向      │  │                │  │
│  │  路由重定向 ────┼──┼──────────────┼──┤                │  │
│  └────────────────┘  │              │  └────────────────┘  │
└──────────────────────┘              └──────────────────────┘
           │                                      │
           │                                      │
           └──────────────┬───────────────────────┘
                          │
                          ▼
                ┌──────────────────┐
                │   后端 API       │
                │  (localhost:3000)│
                │                  │
                │  /api/users      │
                │  /api/invitations│
                │  /api/subscription│
                │  /api/orders     │
                └──────────────────┘
                          │
                          ▼
                ┌──────────────────┐
                │   PostgreSQL     │
                │   数据库         │
                └──────────────────┘
```

---

## 数据流图

### 1. 从 Landing 跳转到用户中心

```
用户点击"个人中心"
        │
        ▼
获取 localStorage 中的认证信息
  - auth_token
  - refresh_token
  - user_info
        │
        ▼
构建 URL 参数
  ?token=xxx&refresh_token=xxx&user_info=xxx
        │
        ▼
跳转到主应用
  window.location.href = clientUrl/user-center?params
        │
        ▼
主应用接收参数
  - 保存到 localStorage
  - 清除 URL 参数
  - 跳转到 /user-center
        │
        ▼
加载用户中心数据
  - 订阅信息
  - 使用统计
  - 订单记录
  - 个人信息
  - 邀请统计
```

---

### 2. 支付成功流程

```
用户完成支付
        │
        ▼
PaymentModal 检测支付状态
  - 轮询订单状态
  - 2秒/次（前30秒）
  - 5秒/次（之后）
        │
        ▼
支付成功
        │
        ▼
显示成功提示
  - 绿色对勾动画
  - "支付成功！"
  - 订单号
        │
        ▼
1.5秒后自动跳转
        │
        ▼
跳转到主应用用户中心
  - 携带认证信息
  - 直接显示订阅管理标签
        │
        ▼
用户查看新订阅
  - 套餐信息
  - 配额更新
```

---

## 用户中心标签页结构

```
┌─────────────────────────────────────────────────────────┐
│                    用户中心                              │
├─────────────────────────────────────────────────────────┤
│  [订阅管理] [订单记录] [个人信息] [邀请系统]              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  订阅管理标签页:                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  我的订阅                                       │     │
│  │  - 当前套餐: 专业版                             │     │
│  │  - 到期时间: 2025-02-04                        │     │
│  │  - 订阅状态: 正常                               │     │
│  │  - 自动续费: 已开启                             │     │
│  │  [关闭自动续费] [升级套餐]                      │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  使用统计                              [刷新]   │     │
│  │  ┌──────────────┐  ┌──────────────┐           │     │
│  │  │ 文章生成     │  │ 平台发布     │           │     │
│  │  │ ████░░░ 80%  │  │ ██░░░░░ 40%  │           │     │
│  │  │ 80 / 100     │  │ 40 / 100     │           │     │
│  │  └──────────────┘  └──────────────┘           │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
└──────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  订单记录标签页:                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  订单号      │ 套餐   │ 金额  │ 状态 │ 时间    │     │
│  ├────────────────────────────────────────────────┤     │
│  │  ORD001     │ 专业版 │ ¥99  │ 已支付│ 2025-01 │     │
│  │  ORD002     │ 企业版 │ ¥299 │ 待支付│ 2025-01 │     │
│  └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  个人信息标签页:                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  基本信息                                       │     │
│  │  👤 用户名: testuser                           │     │
│  │  🏷️  角色: 普通用户                            │     │
│  │  📅 注册时间: 2025-01-01                       │     │
│  │  🕐 最后登录: 2025-01-04                       │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  账户安全                                       │     │
│  │  密码: ••••••••                                │     │
│  │  定期修改密码可以提高账户安全性                  │     │
│  │  [🔑 修改密码]                                  │     │
│  └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  邀请系统标签页:                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  🎁 我的邀请码                                  │     │
│  │  ┌──────────────────────────────────────┐     │     │
│  │  │  邀请码                              │     │     │
│  │  │  ABC123XYZ                  [复制]   │     │     │
│  │  └──────────────────────────────────────┘     │     │
│  │  分享您的邀请码，邀请好友加入平台                │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  👥 邀请统计                           [刷新]   │     │
│  │  ┌──────────────────────────────────────┐     │     │
│  │  │  累计邀请                            │     │     │
│  │  │      5 人                            │     │     │
│  │  └──────────────────────────────────────┘     │     │
│  │                                                │     │
│  │  受邀用户列表:                                  │     │
│  │  👤 user1    加入时间: 2025-01-01             │     │
│  │  👤 user2    加入时间: 2025-01-02             │     │
│  │  👤 user3    加入时间: 2025-01-03             │     │
│  └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────┘
```

---

## WebSocket 实时更新

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   用户中心   │         │  WebSocket   │         │   后端服务   │
│   (Client)   │         │   服务       │         │   (Server)   │
└──────────────┘         └──────────────┘         └──────────────┘
       │                        │                        │
       │  1. 连接 WebSocket     │                        │
       ├───────────────────────>│                        │
       │                        │                        │
       │  2. 订阅事件           │                        │
       │  - quota_updated       │                        │
       │  - subscription_updated│                        │
       │  - order_status_changed│                        │
       ├───────────────────────>│                        │
       │                        │                        │
       │                        │  3. 数据变化           │
       │                        │<───────────────────────│
       │                        │  (订阅更新)            │
       │                        │                        │
       │  4. 推送更新           │                        │
       │<───────────────────────│                        │
       │  subscription_updated  │                        │
       │                        │                        │
       │  5. 刷新数据           │                        │
       │  fetchSubscription()   │                        │
       │                        │                        │
       │  6. 显示提示           │                        │
       │  "订阅信息已更新"       │                        │
       │                        │                        │
```

---

## 认证流程

```
┌─────────────────────────────────────────────────────────┐
│                    认证信息传递                          │
└─────────────────────────────────────────────────────────┘

Landing 登录
     │
     ▼
保存到 localStorage
  - auth_token: "eyJhbGc..."
  - refresh_token: "eyJhbGc..."
  - user_info: '{"id":1,"username":"test",...}'
     │
     ▼
跳转到主应用时携带参数
  ?token=xxx&refresh_token=xxx&user_info=xxx
     │
     ▼
主应用接收参数
  const params = new URLSearchParams(location.search)
  const token = params.get('token')
  const refreshToken = params.get('refresh_token')
  const userInfo = params.get('user_info')
     │
     ▼
保存到 localStorage
  localStorage.setItem('auth_token', token)
  localStorage.setItem('refresh_token', refreshToken)
  localStorage.setItem('user_info', userInfo)
     │
     ▼
清除 URL 参数
  navigate('/', { replace: true })
     │
     ▼
后续 API 请求自动携带 token
  headers: { Authorization: `Bearer ${token}` }
```

---

## 文件依赖关系

```
client/src/pages/UserCenterPage.tsx
  │
  ├─> client/src/config/env.ts (API_BASE_URL)
  ├─> client/src/services/UserWebSocketService.ts (实时更新)
  └─> axios (HTTP 请求)

landing/src/App.tsx
  │
  └─> landing/src/config/env.ts (config.clientUrl)

landing/src/components/UserMenu.tsx
  │
  └─> landing/src/config/env.ts (config.clientUrl)

landing/src/components/MobileUserMenu.tsx
  │
  └─> landing/src/config/env.ts (config.clientUrl)

landing/src/components/PaymentModal.tsx
  │
  └─> landing/src/config/env.ts (config.clientUrl, config.apiUrl)
```

---

## 总结

这个架构实现了：

1. **统一入口** - 所有用户功能集中在主应用用户中心
2. **无缝跳转** - Landing 和主应用之间通过 URL 参数传递认证信息
3. **实时同步** - WebSocket 确保数据实时更新
4. **清晰分层** - 前端、后端、数据库职责明确
5. **易于维护** - 代码结构清晰，便于后续扩展
