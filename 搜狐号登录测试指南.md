# 搜狐号登录测试指南

## ⚠️ 重要提示

**如果之前测试过搜狐号登录，请先删除旧账号！**

旧版本有bug会过早保存账号，导致Cookie无效。现在已修复，需要重新登录。

## 🐛 已修复的问题

**问题：** 搜狐号在用户还没有完成登录时就保存了账号信息

**原因：** 登录页面URL（`https://mp.sohu.com/mpfe/v4/login`）本身就包含 `/mpfe/v4/`，导致检测立即通过

**修复：** 现在必须同时满足：
- ✅ URL不包含 `login`（已离开登录页）
- ✅ URL包含 `/main/` 或 `/index/`（已到达创作者中心）
- ✅ 等待3秒确保页面稳定
- ✅ 验证用户信息元素存在

详见：[✅搜狐号登录检测修复-防止过早保存.md](✅搜狐号登录检测修复-防止过早保存.md)

## 🎯 快速测试

搜狐号登录器已参考头条号最佳实践重新制作完成，现在可以立即测试！

## 🚀 测试步骤

### 方法1：使用测试脚本

```bash
# 测试搜狐号登录
./test-platform-login.sh souhu
```

### 方法2：使用界面

1. 打开Windows登录管理器
   ```bash
   ./启动Windows管理器.command
   ```

2. 在平台管理页面找到搜狐号卡片

3. 点击"登录"按钮

4. 在打开的浏览器中完成登录：
   - 输入手机号/用户名
   - 输入密码
   - 完成验证码（如有）
   - 点击登录按钮

5. 等待系统自动检测登录成功

6. 查看账号是否保存成功

## 📊 预期结果

### 登录成功的标志

**后端日志应显示：**
```
[等待登录] 搜狐号：等待登录成功...
[等待登录] 搜狐号：初始URL: https://mp.sohu.com/mpfe/v4/login
[等待登录] 搜狐号：等待URL跳转到创作者中心（不包含login且包含main或index）...

（用户在浏览器中完成登录...）

[等待登录] 搜狐号：✅ URL已跳转到创作者中心: https://mp.sohu.com/mpfe/v3/main/index
[等待登录] 搜狐号：等待3秒确保页面稳定...
[等待登录] 搜狐号：验证是否有用户信息元素...
[等待登录] 搜狐号：✅ 确认检测到用户信息元素，登录成功！
[等待登录] souhu 登录成功，当前URL: https://mp.sohu.com/mpfe/v3/main/index
[浏览器登录] 成功获取 XX 个Cookie
```

**关键点：**
- ✅ 初始URL包含 `login`
- ✅ 最终URL不包含 `login`，包含 `main` 或 `index`
- ✅ Cookie数量应该>5个
- ✅ 检测到用户信息元素

### 账号保存成功

**后端日志应显示：**
```
[浏览器登录] 账号保存成功 ID: XX
[浏览器登录] 平台: souhu
[浏览器登录] 名称: 搜狐号_XXXXX
[浏览器登录] 真实用户名: XXX
```

## 🔍 验证账号

### 查看账号列表

```bash
# 使用API查看
curl http://localhost:3000/api/platform-accounts \
  -H "Authorization: Bearer $TOKEN" | \
  jq '.accounts[] | select(.platform_id=="souhu")'
```

### 测试账号登录

```bash
# 获取账号ID后测试
./test-account-login.sh <account_id>

# 浏览器会自动打开，查看是否已登录
# 应该能看到用户信息，不需要重新登录
```

## 🎯 关键改进点

### 1. 登录URL更新

- ✅ 使用最新的v4登录页面
- ✅ URL: `https://mp.sohu.com/mpfe/v4/login`

### 2. Cookie验证增强

- ✅ 多重URL检查
- ✅ 检查是否包含 `/mpfe/` 或 `/main/`
- ✅ 确保不包含 `login`

### 3. 选择器优化

- ✅ 支持多种按钮类型
- ✅ 支持多种成功指示器
- ✅ 提供备用选择器

### 4. 日志输出改进

- ✅ 详细的步骤说明
- ✅ 清晰的状态提示
- ✅ 便于调试和排查

## 🐛 常见问题

### 问题1：Cookie登录失败

**现象：**
```
[搜狐号] Cookie登录验证失败，尝试表单登录
```

**原因：**
- Cookie已过期
- URL验证失败
- 页面结构变化

**解决：**
- 重新登录获取新Cookie
- 检查URL是否正确
- 查看页面是否正常加载

### 问题2：用户名未提取

**现象：**
```
[提取用户信息] ⚠️ 所有选择器都未能提取到用户名
```

**原因：**
- 页面未完全加载
- 选择器不匹配
- 用户信息元素变化

**解决：**
- 查看HTML快照（debug目录）
- 更新选择器配置
- 增加等待时间

### 问题3：登录超时

**现象：**
```
❌ 搜狐号登录失败: Timeout
```

**原因：**
- 网络连接问题
- 页面加载慢
- 验证码需要处理

**解决：**
- 检查网络连接
- 增加超时时间
- 手动完成验证码

## 💡 测试建议

### 1. 首次测试

- ✅ 使用可视化模式（非静默）
- ✅ 观察浏览器操作过程
- ✅ 查看详细日志输出
- ✅ 验证每个步骤

### 2. 网络环境

- ✅ 确保网络稳定
- ✅ 避免使用VPN（可能影响）
- ✅ 检查防火墙设置

### 3. 账号准备

- ✅ 准备好手机号/用户名
- ✅ 准备好密码
- ✅ 确保账号状态正常

### 4. 验证步骤

- ✅ 完成所有验证（验证码等）
- ✅ 等待页面完全加载
- ✅ 不要过早关闭浏览器

## 📝 测试检查清单

### 登录测试

- [ ] 浏览器正常打开
- [ ] 登录页面正常加载
- [ ] 能够输入用户名密码
- [ ] 能够点击登录按钮
- [ ] 系统检测到登录成功
- [ ] Cookie正确保存
- [ ] 用户名正确提取
- [ ] 账号信息保存成功

### 账号验证

- [ ] 账号列表中能看到搜狐号
- [ ] 账号名称正确
- [ ] 真实用户名正确
- [ ] Cookie数量合理（>0）
- [ ] 登录测试功能正常
- [ ] 打开浏览器后已登录
- [ ] 能看到用户信息

## 🎉 成功标准

### 登录成功

- ✅ 浏览器自动打开搜狐号登录页
- ✅ 用户完成登录操作
- ✅ 系统检测到URL变化
- ✅ Cookie成功保存（数量>0）
- ✅ 用户名成功提取
- ✅ 账号信息保存到数据库
- ✅ 显示成功消息

### 账号可用

- ✅ 账号列表中显示
- ✅ 真实用户名正确
- ✅ 登录测试通过
- ✅ 浏览器打开后已登录
- ✅ 可以用于发布任务

## 🚀 下一步

### 1. 测试登录功能

```bash
./test-platform-login.sh souhu
```

### 2. 验证账号状态

```bash
./test-account-login.sh <account_id>
```

### 3. 测试发布功能

- 创建发布任务
- 选择搜狐号平台
- 执行发布
- 查看发布结果

### 4. 反馈问题

如果遇到问题：
- 查看后端日志
- 检查HTML快照
- 记录错误信息
- 提供详细描述

## 📚 参考文档

- [✅搜狐号登录器重新制作完成.md](✅搜狐号登录器重新制作完成.md) - 详细改进说明
- [✅搜狐号登录检测优化.md](✅搜狐号登录检测优化.md) - 之前的优化记录
- [✅搜狐号登录保存问题修复.md](✅搜狐号登录保存问题修复.md) - 问题修复记录
- [平台登录器使用指南.md](平台登录器使用指南.md) - 通用使用指南

---

**测试准备完成！** 🎉

现在可以立即开始测试搜狐号登录功能。参考头条号的成功经验，搜狐号登录器应该能够稳定工作。

**建议测试顺序：**
1. 先测试登录功能
2. 验证账号保存
3. 测试账号登录
4. 最后测试发布功能

祝测试顺利！ 🚀
