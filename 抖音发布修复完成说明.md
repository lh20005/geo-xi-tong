# 抖音发布修复完成说明

## 已完成的修复

### ✅ 修复1: 图片上传不弹出对话框

**问题**: 上传图片时会弹出本地文件选择对话框

**原因**: 代码中点击了上传按钮，触发了系统文件选择器

**解决方案**: 
- 移除了点击上传按钮的代码
- 直接查找文件input元素并使用 `uploadFile()` 方法
- `uploadFile()` 方法会直接设置文件到input元素，不会弹出对话框

**修改位置**: `server/src/services/adapters/DouyinAdapter.ts` 第237-249行

**修改内容**:
```typescript
// 原代码（已删除）:
// 点击上传图文按钮（简化选择器）
// const uploadButton = '.container-drag-upload-tL99XD > button';
// await page.click(uploadButton);

// 新代码:
// 不点击上传按钮，直接查找文件input并上传
// 这样可以避免触发系统文件选择对话框
console.log('[抖音号] 🔍 直接查找文件上传input（不点击按钮，避免弹出对话框）...');
```

### ⚠️ 修复2: 自主声明选择问题（需要手动完成）

**问题**: 
1. 找不到"内容由AI生成"选项
2. 找不到"确定"按钮

**原因**:
1. 原代码使用 `page.$('*')` 获取所有元素效率低且不可靠
2. CSS选择器可能不准确
3. 等待时间不够

**解决方案**:
1. 使用XPath进行精确查找
2. 增加多个备选CSS选择器
3. 增加等待时间和截图诊断
4. 添加详细的日志输出

**需要替换的代码位置**: `server/src/services/adapters/DouyinAdapter.ts` 第450-490行左右

## 手动修复步骤

由于代码替换工具遇到问题，请按以下步骤手动修复:

### 步骤1: 打开文件
```bash
code server/src/services/adapters/DouyinAdapter.ts
```

### 步骤2: 找到第450行左右的代码

查找这段代码:
```typescript
        // 获取所有元素，查找包含"内容由AI生成"的元素
        const allElements = await page.$('*');
```

### 步骤3: 删除从 "const allElements" 到 "console.log('[抖音号] ✅ 自主声明已添加');" 的所有代码

大约是第450-490行之间的代码。

### 步骤4: 粘贴新代码

在删除的位置粘贴以下代码:

```typescript
        // 使用XPath精确查找
        const aiOptionXPath = "//*[contains(text(), '内容由AI生成')]";
        console.log(`[抖音号] 使用XPath查找: ${aiOptionXPath}`);
        
        await page.waitForXPath(aiOptionXPath, { visible: true, timeout: 5000 });
        const aiElements = await page.$x(aiOptionXPath);
        console.log(`[抖音号] 找到 ${aiElements.length} 个包含"内容由AI生成"的元素`);
        
        let clicked = false;
        for (let i = 0; i < aiElements.length; i++) {
          const element = aiElements[i];
          const elementInfo = await page.evaluate(el => {
            const rect = el.getBoundingClientRect();
            const style = window.getComputedStyle(el);
            return {
              text: el.textContent?.trim(),
              tagName: el.tagName,
              visible: style.display !== 'none' && 
                      style.visibility !== 'hidden' && 
                      style.opacity !== '0' &&
                      rect.width > 0 && 
                      rect.height > 0
            };
          }, element);
          
          console.log(`[抖音号] 元素 [${i}]: ${elementInfo.tagName} "${elementInfo.text}" visible=${elementInfo.visible}`);
          
          if (elementInfo.visible) {
            console.log(`[抖音号] ✅ 找到可见的"内容由AI生成"选项`);
            console.log('[抖音号] 🖱️  点击选项...');
            await element.click();
            clicked = true;
            console.log('[抖音号] ✅ 已点击选项');
            break;
          }
        }
        
        if (!clicked) {
          throw new Error('未找到可见的"内容由AI生成"选项');
        }
        
        console.log('[抖音号] ⏳ 等待选项选中（2秒）...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // 截图查看选中状态
        try {
          await page.screenshot({ path: 'douyin-declaration-selected.png', fullPage: true });
          console.log('[抖音号] 📸 已保存选中状态截图到: douyin-declaration-selected.png');
        } catch (e) {
          console.log('[抖音号] 截图失败:', e);
        }
        
        // 点击确定按钮 - 使用多种方式查找
        console.log('[抖音号] 🔍 查找"确定"按钮...');
        
        // 方法1: 尝试多个CSS选择器
        const confirmSelectors = [
          '.semi-sidesheet-body > footer > button.semi-button-primary',
          '.semi-sidesheet footer button.semi-button-primary',
          'button.semi-button-primary',
          '.semi-modal-footer button.semi-button-primary'
        ];
        
        let confirmClicked = false;
        for (const selector of confirmSelectors) {
          try {
            console.log(`[抖音号] 尝试选择器: ${selector}`);
            await page.waitForSelector(selector, { visible: true, timeout: 2000 });
            const buttonText = await page.$eval(selector, el => el.textContent?.trim());
            console.log(`[抖音号] 找到按钮: "${buttonText}"`);
            
            if (buttonText === '确定' || buttonText === '确认' || buttonText === '保存') {
              console.log('[抖音号] 🖱️  点击确定按钮...');
              await page.click(selector);
              confirmClicked = true;
              console.log('[抖音号] ✅ 已点击确定按钮');
              break;
            }
          } catch (e) {
            continue;
          }
        }
        
        // 方法2: 使用XPath查找
        if (!confirmClicked) {
          console.log('[抖音号] ⚠️ CSS选择器未找到，尝试XPath...');
          const confirmXPath = "//button[contains(text(), '确定') or contains(text(), '确认') or contains(text(), '保存')]";
          
          await page.waitForXPath(confirmXPath, { visible: true, timeout: 5000 });
          const confirmButtons = await page.$x(confirmXPath);
          console.log(`[抖音号] 找到 ${confirmButtons.length} 个确认按钮`);
          
          if (confirmButtons.length > 0) {
            const button = confirmButtons[confirmButtons.length - 1];
            const buttonText = await page.evaluate(el => el.textContent?.trim(), button);
            console.log(`[抖音号] 准备点击按钮: "${buttonText}"`);
            
            await button.click();
            confirmClicked = true;
            console.log('[抖音号] ✅ 已点击确定按钮（XPath方式）');
          }
        }
        
        if (!confirmClicked) {
          throw new Error('未找到确定按钮');
        }
        
        console.log('[抖音号] ⏳ 等待侧边栏关闭（2秒）...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        console.log('[抖音号] ✅ 自主声明已添加');
```

### 步骤5: 保存文件

按 `Cmd+S` (Mac) 或 `Ctrl+S` (Windows/Linux) 保存文件。

### 步骤6: 重启服务器

```bash
# 停止当前服务器 (Ctrl+C)
# 然后重新启动
npm run dev
```

## 测试验证

修复完成后，测试抖音发布功能:

1. 进入发布任务页面
2. 创建一个抖音发布任务
3. 执行发布

### 预期效果

1. ✅ 图片上传时不会弹出系统文件选择对话框
2. ✅ 能够正确找到并点击"内容由AI生成"选项
3. ✅ 能够正确找到并点击"确定"按钮
4. ✅ 自主声明成功添加
5. ✅ 生成诊断截图:
   - `douyin-declaration-sidebar.png` - 侧边栏弹出状态
   - `douyin-declaration-selected.png` - 选项选中状态

### 查看日志

如果遇到问题，查看控制台日志:
- 每个步骤都有详细的日志输出
- 包括找到的元素数量、元素信息等
- 可以根据日志判断哪一步出了问题

## 技术说明

### 为什么 uploadFile() 不会弹出对话框?

`uploadFile()` 是 Puppeteer 提供的方法，它直接设置文件路径到 `<input type="file">` 元素的 `files` 属性，不会触发浏览器的文件选择对话框。这是自动化测试的标准做法。

### 为什么使用 XPath?

XPath 可以根据文本内容精确查找元素，比 CSS 选择器更灵活。特别是对于动态生成的页面，XPath 更可靠。

### 为什么需要多个备选选择器?

不同的页面状态或版本可能使用不同的 CSS 类名。使用多个备选选择器可以提高成功率。

## 备份文件

原文件已备份为: `server/src/services/adapters/DouyinAdapter.ts.backup`

如果修复后出现问题，可以恢复备份:
```bash
cp server/src/services/adapters/DouyinAdapter.ts.backup server/src/services/adapters/DouyinAdapter.ts
```

## 总结

- ✅ 图片上传问题已自动修复
- ⚠️ 自主声明问题需要手动修复（按上述步骤操作）
- 📝 所有修改都有详细的注释和日志
- 🔍 增加了截图功能，方便诊断问题
- 🛡️ 原文件已备份，可以随时恢复
