# è’¸é¦ç»“æœä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½ - æµ‹è¯•æŒ‡å—

## ğŸ“‹ å®ç°çŠ¶æ€æ€»ç»“

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆ100%ï¼‰

#### 1. åç«¯å®ç°
- **æ•°æ®åº“å±‚**
  - âœ… `usage_count` å­—æ®µï¼ˆdistillationsè¡¨ï¼‰
  - âœ… `distillation_usage` è¡¨ï¼ˆä½¿ç”¨å†å²è®°å½•ï¼‰
  - âœ… 7ä¸ªæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  - âœ… çº§è”åˆ é™¤å’Œå¤–é”®çº¦æŸ

- **APIæ¥å£**
  - âœ… `GET /api/distillation/stats` - è·å–å¸¦ä½¿ç”¨ç»Ÿè®¡çš„åˆ—è¡¨ï¼ˆæ”¯æŒæ’åºã€ç­›é€‰ã€åˆ†é¡µï¼‰
  - âœ… `GET /api/distillation/:id` - è·å–è¯¦æƒ…ï¼ˆåŒ…å«usage_countå’ŒlastUsedAtï¼‰
  - âœ… `GET /api/distillation/:id/usage` - è·å–ä½¿ç”¨å†å²ï¼ˆåˆ†é¡µï¼‰
  - âœ… `POST /api/distillation/fix-usage-count` - ä¿®å¤ä½¿ç”¨è®¡æ•°

- **æœåŠ¡å±‚æ–¹æ³•**
  - âœ… `getDistillationsWithStats()` - æ”¯æŒæ’åºã€ç­›é€‰ã€åˆ†é¡µ
  - âœ… `getDistillationDetail()` - è¿”å›ä½¿ç”¨ç»Ÿè®¡
  - âœ… `getUsageHistory()` - åˆ†é¡µæŸ¥è¯¢ä½¿ç”¨å†å²
  - âœ… `repairUsageStats()` - ä¿®å¤ä¸ä¸€è‡´æ•°æ®
  - âœ… `decrementUsageCount()` - åŸå­å‡å°‘è®¡æ•°

#### 2. å‰ç«¯å®ç°
- **ç»„ä»¶**
  - âœ… `UsageCountBadge` - ä½¿ç”¨æ¬¡æ•°å¾½ç« ç»„ä»¶
  - âœ… `UsageHistoryModal` - ä½¿ç”¨å†å²å¼¹çª—ç»„ä»¶
  - âœ… `DistillationHistoryEnhancedPage` - å¢å¼ºçš„å†å²è®°å½•é¡µé¢

- **åŠŸèƒ½**
  - âœ… æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡ï¼ˆæ€»è®°å½•ã€å·²ä½¿ç”¨ã€æœªä½¿ç”¨ã€æ€»ä½¿ç”¨æ¬¡æ•°ï¼‰
  - âœ… ç‚¹å‡»ä½¿ç”¨æ¬¡æ•°æŸ¥çœ‹ä½¿ç”¨å†å²
  - âœ… æ’åºåŠŸèƒ½ï¼ˆæŒ‰ä½¿ç”¨æ¬¡æ•°æˆ–åˆ›å»ºæ—¶é—´ï¼‰
  - âœ… ç­›é€‰åŠŸèƒ½ï¼ˆå…¨éƒ¨/å·²ä½¿ç”¨/æœªä½¿ç”¨ï¼‰
  - âœ… åˆ†é¡µå’Œç©ºçŠ¶æ€å¤„ç†

#### 3. å±æ€§æµ‹è¯•
- âœ… 11ä¸ªå±æ€§æµ‹è¯•å·²åˆ›å»ºï¼ˆä½¿ç”¨fast-checkï¼‰
  - Property 6: åˆ†é¡µé€»è¾‘æ­£ç¡®æ€§
  - Property 7: åˆ é™¤æ–‡ç« åæ•°æ®ä¸€è‡´æ€§
  - Property 8: APIå“åº”ç»“æ„ä¸€è‡´æ€§
  - Property 9: å‡è¡¡é€‰æ‹©ç®—æ³•æ­£ç¡®æ€§
  - Property 10: æ¬¡è¦æ’åºæ¡ä»¶æ­£ç¡®æ€§
  - Property 11: æ–‡ç« ç”Ÿæˆæ•°æ®å”¯ä¸€æ€§
  - Property 12: äº‹åŠ¡åŸå­æ€§
  - Property 14: ä¿®å¤å·¥å…·æ­£ç¡®æ€§
  - Property 15: å¹¶å‘å®‰å…¨æ€§
  - Property 16: ç­›é€‰é€»è¾‘æ­£ç¡®æ€§
  - Property 17: æ’åºåŠŸèƒ½æ­£ç¡®æ€§

## ğŸ§ª å¦‚ä½•è¿è¡Œæµ‹è¯•

### å‰ç½®æ¡ä»¶

1. **å¯åŠ¨æ•°æ®åº“**
   ```bash
   # ç¡®ä¿PostgreSQLæ•°æ®åº“æ­£åœ¨è¿è¡Œ
   # æ•°æ®åº“è¿æ¥ä¿¡æ¯åœ¨ .env æ–‡ä»¶ä¸­é…ç½®
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # å¤åˆ¶ .env.example åˆ° .env
   cp .env.example .env
   
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®æ­£ç¡®çš„æ•°æ®åº“è¿æ¥
   # DATABASE_URL=postgresql://user:password@localhost:5432/geo_system
   ```

3. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   cd server
   npm run migrate
   ```

### è¿è¡Œå±æ€§æµ‹è¯•

```bash
cd server

# è¿è¡Œæ‰€æœ‰å±æ€§æµ‹è¯•
npm test -- distillationService.property.test.ts
npm test -- articleGenerationService.property.test.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test -- distillationService.property.test.ts -t "Property 8"

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
npm test -- distillationService.property.test.ts --verbose
```

### æµ‹è¯•è¯´æ˜

**å½“å‰æµ‹è¯•çŠ¶æ€**: æµ‹è¯•ä»£ç å·²å®Œæˆï¼Œä½†éœ€è¦æ•°æ®åº“è¿è¡Œæ‰èƒ½æ‰§è¡Œã€‚

**æµ‹è¯•å¤±è´¥åŸå› **: 
- é”™è¯¯ä¿¡æ¯: `getaddrinfo ENOTFOUND base`
- åŸå› : æ•°æ®åº“æœªè¿è¡Œæˆ–è¿æ¥é…ç½®ä¸æ­£ç¡®
- è§£å†³æ–¹æ¡ˆ: å¯åŠ¨PostgreSQLæ•°æ®åº“å¹¶ç¡®ä¿è¿æ¥é…ç½®æ­£ç¡®

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### DistillationService æµ‹è¯•
1. **APIå“åº”ç»“æ„ä¸€è‡´æ€§** - éªŒè¯æ‰€æœ‰APIå“åº”åŒ…å«å¿…éœ€å­—æ®µ
2. **æ’åºåŠŸèƒ½** - éªŒè¯æŒ‰usage_countå’Œcreated_atæ’åºçš„æ­£ç¡®æ€§
3. **ç­›é€‰é€»è¾‘** - éªŒè¯ç­›é€‰å·²ä½¿ç”¨/æœªä½¿ç”¨çš„æ­£ç¡®æ€§
4. **åˆ†é¡µé€»è¾‘** - éªŒè¯åˆ†é¡µå‚æ•°å’Œç»“æœçš„æ­£ç¡®æ€§
5. **ä¿®å¤å·¥å…·** - éªŒè¯ä¿®å¤ä¸ä¸€è‡´usage_countçš„æ­£ç¡®æ€§
6. **åˆ é™¤ä¸€è‡´æ€§** - éªŒè¯åˆ é™¤æ–‡ç« åusage_countæ­£ç¡®å‡å°‘

### ArticleGenerationService æµ‹è¯•
1. **å‡è¡¡é€‰æ‹©ç®—æ³•** - éªŒè¯é€‰æ‹©usage_countæœ€å°çš„è’¸é¦ç»“æœ
2. **æ¬¡è¦æ’åºæ¡ä»¶** - éªŒè¯usage_countç›¸åŒæ—¶æŒ‰created_atæ’åº
3. **æ•°æ®å”¯ä¸€æ€§** - éªŒè¯æ¯ç¯‡æ–‡ç« ä½¿ç”¨ä¸åŒçš„è’¸é¦ç»“æœ
4. **äº‹åŠ¡åŸå­æ€§** - éªŒè¯ä¿å­˜å¤±è´¥æ—¶usage_countä¸æ›´æ–°
5. **å¹¶å‘å®‰å…¨æ€§** - éªŒè¯å¹¶å‘æ“ä½œä¸‹çš„æ•°æ®ä¸€è‡´æ€§

## ğŸ” æ‰‹åŠ¨æµ‹è¯•æŒ‡å—

å¦‚æœæ— æ³•è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•ï¼š

### 1. æµ‹è¯•APIç«¯ç‚¹

```bash
# 1. è·å–å¸¦ä½¿ç”¨ç»Ÿè®¡çš„è’¸é¦ç»“æœåˆ—è¡¨
curl "http://localhost:3000/api/distillation/stats?page=1&pageSize=10&sortBy=usage_count&sortOrder=asc&filterUsage=all"

# 2. è·å–å•æ¡è’¸é¦ç»“æœè¯¦æƒ…
curl "http://localhost:3000/api/distillation/1"

# 3. è·å–ä½¿ç”¨å†å²
curl "http://localhost:3000/api/distillation/1/usage?page=1&pageSize=10"

# 4. ä¿®å¤ä½¿ç”¨è®¡æ•°
curl -X POST "http://localhost:3000/api/distillation/fix-usage-count" \
  -H "Content-Type: application/json" \
  -d '{"distillationId": 1}'

# 5. ä¿®å¤æ‰€æœ‰ä½¿ç”¨è®¡æ•°
curl -X POST "http://localhost:3000/api/distillation/fix-usage-count" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 2. æµ‹è¯•å‰ç«¯é¡µé¢

1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   # å¯åŠ¨åç«¯
   cd server
   npm run dev
   
   # å¯åŠ¨å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
   cd client
   npm run dev
   ```

2. **è®¿é—®é¡µé¢**
   - æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://localhost:5173`
   - å¯¼èˆªåˆ°è’¸é¦å†å²é¡µé¢
   - æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
     - âœ… æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡å¡ç‰‡
     - âœ… ç‚¹å‡»åˆ—æ ‡é¢˜åˆ‡æ¢æ’åº
     - âœ… ä½¿ç”¨ç­›é€‰ä¸‹æ‹‰æ¡†
     - âœ… ç‚¹å‡»ä½¿ç”¨æ¬¡æ•°å¾½ç« æŸ¥çœ‹å†å²
     - âœ… åœ¨ä½¿ç”¨å†å²å¼¹çª—ä¸­ç¿»é¡µ
     - âœ… ç‚¹å‡»æ–‡ç« æ ‡é¢˜è·³è½¬

### 3. æµ‹è¯•æ•°æ®ä¸€è‡´æ€§

```sql
-- 1. æ£€æŸ¥usage_countæ˜¯å¦ä¸å®é™…ä½¿ç”¨è®°å½•ä¸€è‡´
SELECT 
  d.id,
  d.keyword,
  d.usage_count as stored_count,
  COUNT(du.id) as actual_count,
  CASE 
    WHEN d.usage_count = COUNT(du.id) THEN 'ä¸€è‡´'
    ELSE 'ä¸ä¸€è‡´'
  END as status
FROM distillations d
LEFT JOIN distillation_usage du ON d.id = du.distillation_id
GROUP BY d.id, d.keyword, d.usage_count
ORDER BY d.id;

-- 2. æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
SELECT 
  tablename, 
  indexname, 
  indexdef 
FROM pg_indexes 
WHERE tablename IN ('distillations', 'distillation_usage')
ORDER BY tablename, indexname;

-- 3. æ£€æŸ¥å¤–é”®çº¦æŸ
SELECT
  tc.constraint_name,
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name,
  rc.delete_rule
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
JOIN information_schema.referential_constraints AS rc
  ON rc.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_name = 'distillation_usage';
```

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

### åç«¯åŠŸèƒ½æµ‹è¯•
- [ ] APIè¿”å›æ­£ç¡®çš„usage_countå­—æ®µ
- [ ] æ’åºåŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ˆå‡åº/é™åºï¼‰
- [ ] ç­›é€‰åŠŸèƒ½æ­£ç¡®ï¼ˆå…¨éƒ¨/å·²ä½¿ç”¨/æœªä½¿ç”¨ï¼‰
- [ ] åˆ†é¡µåŠŸèƒ½æ­£ç¡®ï¼ˆé¡µç ã€æ¯é¡µæ•°é‡ï¼‰
- [ ] ä½¿ç”¨å†å²æŸ¥è¯¢æ­£ç¡®
- [ ] ä¿®å¤å·¥å…·èƒ½æ­£ç¡®ä¿®å¤ä¸ä¸€è‡´æ•°æ®
- [ ] åˆ é™¤æ–‡ç« åusage_countæ­£ç¡®å‡å°‘
- [ ] çº§è”åˆ é™¤æ­£å¸¸å·¥ä½œ

### å‰ç«¯åŠŸèƒ½æµ‹è¯•
- [ ] ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] ä½¿ç”¨æ¬¡æ•°å¾½ç« æ˜¾ç¤ºæ­£ç¡®
- [ ] ç‚¹å‡»å¾½ç« æ‰“å¼€ä½¿ç”¨å†å²å¼¹çª—
- [ ] ä½¿ç”¨å†å²å¼¹çª—æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ’åºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç©ºçŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
- [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

### æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
- [ ] usage_countä¸å®é™…ä½¿ç”¨è®°å½•ä¸€è‡´
- [ ] æ–‡ç« ç”Ÿæˆåusage_countå¢åŠ 
- [ ] æ–‡ç« åˆ é™¤åusage_countå‡å°‘
- [ ] è’¸é¦ç»“æœåˆ é™¤åä½¿ç”¨è®°å½•è¢«åˆ é™¤
- [ ] å¹¶å‘æ“ä½œä¸‹æ•°æ®ä¿æŒä¸€è‡´

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

æ ¹æ®tasks.mdï¼Œä»¥ä¸‹ä»»åŠ¡ä¸ºå¯é€‰æˆ–ä½ä¼˜å…ˆçº§ï¼š

### å¯é€‰ä»»åŠ¡
1. **å‰ç«¯å•å…ƒæµ‹è¯•** - ä¸ºReactç»„ä»¶ç¼–å†™å•å…ƒæµ‹è¯•
2. **æ•°æ®å¯¼å‡ºåŠŸèƒ½** - å®ç°CSVå¯¼å‡º
3. **å®æ—¶æ›´æ–°** - ä½¿ç”¨WebSocketå®ç°å®æ—¶æ›´æ–°
4. **ç®¡ç†å‘˜ä¿®å¤å·¥å…·UI** - åˆ›å»ºä¿®å¤å·¥å…·ç•Œé¢
5. **å“åº”å¼è®¾è®¡ä¼˜åŒ–** - ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
6. **è¯¦ç»†æ–‡æ¡£** - ç¼–å†™APIæ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—

### å»ºè®®ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**: ç¡®ä¿æ•°æ®åº“è¿è¡Œå¹¶é€šè¿‡æ‰€æœ‰å±æ€§æµ‹è¯•
2. **ä¸­ä¼˜å…ˆçº§**: è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•éªŒè¯æ‰€æœ‰åŠŸèƒ½
3. **ä½ä¼˜å…ˆçº§**: å®ç°å¯é€‰åŠŸèƒ½ï¼ˆå¯¼å‡ºã€å®æ—¶æ›´æ–°ç­‰ï¼‰

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æµ‹è¯•å¤±è´¥ - æ•°æ®åº“è¿æ¥é”™è¯¯
**ç—‡çŠ¶**: `getaddrinfo ENOTFOUND base`
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥PostgreSQLæ˜¯å¦è¿è¡Œ: `pg_isready`
2. æ£€æŸ¥.envæ–‡ä»¶ä¸­çš„DATABASE_URLé…ç½®
3. ç¡®ä¿æ•°æ®åº“å·²åˆ›å»º: `createdb geo_system`
4. è¿è¡Œæ•°æ®åº“è¿ç§»: `npm run migrate`

### é—®é¢˜2: APIè¿”å›404
**ç—‡çŠ¶**: è°ƒç”¨APIè¿”å›404é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ: `curl http://localhost:3000/health`
2. æ£€æŸ¥è·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

### é—®é¢˜3: usage_countä¸ä¸€è‡´
**ç—‡çŠ¶**: usage_countä¸å®é™…ä½¿ç”¨è®°å½•æ•°é‡ä¸åŒ¹é…
**è§£å†³æ–¹æ¡ˆ**:
1. è¿è¡Œä¿®å¤å·¥å…·: `POST /api/distillation/fix-usage-count`
2. æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“çš„æ“ä½œ
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

## âœ… éªŒæ”¶æ ‡å‡†

åŠŸèƒ½è¢«è®¤ä¸ºå®Œæˆéœ€è¦æ»¡è¶³ï¼š

1. âœ… æ‰€æœ‰æ ¸å¿ƒAPIç«¯ç‚¹æ­£å¸¸å·¥ä½œ
2. âœ… å‰ç«¯ç»„ä»¶æ­£ç¡®æ˜¾ç¤ºæ•°æ®
3. âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯
4. â³ æ‰€æœ‰å±æ€§æµ‹è¯•é€šè¿‡ï¼ˆéœ€è¦æ•°æ®åº“è¿è¡Œï¼‰
5. âœ… ä»£ç è´¨é‡è‰¯å¥½ï¼ˆTypeScriptç±»å‹ã€æ³¨é‡Šï¼‰
6. âœ… é”™è¯¯å¤„ç†å®Œå–„

**å½“å‰çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½100%å®Œæˆï¼Œç­‰å¾…æ•°æ®åº“ç¯å¢ƒè¿›è¡Œæµ‹è¯•éªŒè¯ã€‚

