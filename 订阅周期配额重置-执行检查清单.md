# 订阅周期配额重置 - 执行检查清单

## 执行前准备

- [ ] 备份数据库
  ```bash
  pg_dump your_database > backup_before_031_$(date +%Y%m%d_%H%M%S).sql
  ```

- [ ] 确认当前迁移状态
  ```bash
  cd server
  npm run db:status
  ```

- [ ] 检查是否有活跃用户
  ```sql
  SELECT COUNT(*) FROM user_subscriptions WHERE status = 'active';
  ```

- [ ] 通知用户系统维护（如果需要）

## 执行步骤

### 1. 执行迁移 ✅

```bash
cd server
npx ts-node src/db/run-migration-031.ts
```

**预期输出**：
```
✅ 迁移 031 成功完成
   - 已添加配额重置锚点字段
   - 已创建订阅周期计算函数
   - record_feature_usage 函数已更新
   - check_feature_quota 函数已更新
   ...
```

**检查点**：
- [ ] 迁移执行成功，无错误
- [ ] 新增字段已创建
- [ ] 新增函数已创建
- [ ] 触发器已创建
- [ ] 现有用户配额锚点已初始化

### 2. 运行测试 ✅

```bash
npx ts-node src/scripts/test-subscription-cycle-quota.ts
```

**检查点**：
- [ ] 测试用户创建成功
- [ ] 配额周期计算正确
- [ ] 配额重置描述正确
- [ ] 配额使用记录正常
- [ ] 触发器正常工作
- [ ] 所有测试通过

### 3. 验证现有用户 ✅

```sql
-- 查看所有活跃用户的配额周期
SELECT 
  u.username,
  sp.plan_name,
  sp.billing_cycle,
  us.quota_cycle_type,
  us.quota_reset_anchor,
  get_quota_reset_description(u.id) as reset_rule,
  get_next_quota_reset_time(u.id) as next_reset
FROM users u
JOIN user_subscriptions us ON us.user_id = u.id
JOIN subscription_plans sp ON sp.id = us.plan_id
WHERE us.status = 'active'
  AND us.end_date > CURRENT_TIMESTAMP
ORDER BY u.username;
```

**检查点**：
- [ ] 所有用户都有 `quota_reset_anchor`
- [ ] 所有用户都有 `quota_cycle_type`
- [ ] `quota_cycle_type` 与 `billing_cycle` 一致
- [ ] `reset_rule` 显示正确
- [ ] `next_reset` 时间合理

### 4. 验证配额功能 ✅

```sql
-- 测试配额检查
SELECT * FROM check_feature_quota(1, 'articles_per_month', 1);

-- 测试配额记录
SELECT record_feature_usage(1, 'articles_per_month', 1);

-- 查看使用记录
SELECT * FROM user_usage WHERE user_id = 1 ORDER BY period_start DESC;
```

**检查点**：
- [ ] 配额检查返回正确结果
- [ ] 配额记录成功
- [ ] 使用记录的 `period_start` 和 `period_end` 正确

### 5. 验证触发器 ✅

```sql
-- 创建测试订阅
INSERT INTO user_subscriptions (
  user_id, plan_id, status,
  start_date, end_date
) VALUES (
  999, 1, 'active',
  CURRENT_TIMESTAMP, CURRENT_TIMESTAMP + INTERVAL '1 month'
);

-- 检查触发器是否自动设置
SELECT 
  quota_cycle_type,
  quota_reset_anchor,
  sp.billing_cycle
FROM user_subscriptions us
JOIN subscription_plans sp ON sp.id = us.plan_id
WHERE us.user_id = 999;

-- 清理测试数据
DELETE FROM user_subscriptions WHERE user_id = 999;
```

**检查点**：
- [ ] `quota_cycle_type` 自动设置为 `billing_cycle`
- [ ] `quota_reset_anchor` 自动设置为 `start_date`

### 6. 性能检查 ✅

```sql
-- 检查索引是否创建
SELECT 
  tablename, 
  indexname, 
  indexdef
FROM pg_indexes
WHERE indexname IN (
  'idx_user_subscriptions_quota_anchor',
  'idx_user_usage_period'
);

-- 检查查询性能
EXPLAIN ANALYZE
SELECT * FROM get_user_quota_period(1, 'articles_per_month');
```

**检查点**：
- [ ] 索引已创建
- [ ] 查询性能良好（< 10ms）

## 执行后验证

### 功能验证

- [ ] 用户可以正常使用配额
- [ ] 配额检查正常工作
- [ ] 配额记录正常保存
- [ ] 配额统计正确显示

### 数据验证

- [ ] 所有活跃用户都有配额周期信息
- [ ] 配额周期类型与套餐一致
- [ ] 配额重置时间计算正确
- [ ] 旧配额记录已清理（超过3个周期）

### 系统验证

- [ ] 服务器正常运行
- [ ] 无错误日志
- [ ] API 响应正常
- [ ] 前端显示正常（如果已集成）

## 回滚准备

如果出现问题，准备回滚：

```bash
# 恢复数据库备份
psql your_database < backup_before_031_YYYYMMDD_HHMMSS.sql

# 或者执行回滚迁移
cd server
npm run db:rollback
```

**回滚检查点**：
- [ ] 备份文件存在且完整
- [ ] 回滚脚本已测试
- [ ] 回滚流程已文档化

## 监控设置

### 短期监控（1周）

- [ ] 监控配额计算错误
- [ ] 监控配额记录失败
- [ ] 监控用户反馈
- [ ] 监控系统性能

### 长期监控

- [ ] 配额重置分布统计
- [ ] 配额使用率趋势
- [ ] 系统性能指标
- [ ] 用户满意度

## 用户通知

### 通知内容

```
【系统升级通知】

尊敬的用户：

我们已升级配额重置系统，现在您的配额将基于您的订阅日期重置，而不是统一在月初重置。

主要改进：
✅ 每个用户都有完整的使用周期
✅ 配额重置时间更加公平合理
✅ 您可以在个人中心查看配额重置规则

感谢您的支持！
```

### 通知渠道

- [ ] 系统内通知
- [ ] 邮件通知（可选）
- [ ] WebSocket 推送（可选）

## 文档更新

- [ ] 更新用户手册
- [ ] 更新 API 文档
- [ ] 更新开发文档
- [ ] 更新运维文档

## 团队沟通

- [ ] 通知开发团队
- [ ] 通知运维团队
- [ ] 通知客服团队
- [ ] 通知产品团队

## 完成确认

### 技术确认

- [ ] 迁移执行成功
- [ ] 测试全部通过
- [ ] 验证全部完成
- [ ] 监控已设置

### 业务确认

- [ ] 用户可以正常使用
- [ ] 配额显示正确
- [ ] 无用户投诉
- [ ] 系统稳定运行

### 文档确认

- [ ] 实施文档已完成
- [ ] API 文档已更新
- [ ] 用户文档已更新
- [ ] 运维文档已更新

## 签字确认

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 开发负责人 | | | |
| 测试负责人 | | | |
| 运维负责人 | | | |
| 产品负责人 | | | |

---

**执行日期**: ___________  
**执行人**: ___________  
**审核人**: ___________  
**状态**: [ ] 待执行 [ ] 执行中 [ ] 已完成 [ ] 已回滚
