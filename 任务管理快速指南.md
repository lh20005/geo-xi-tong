# 任务管理快速指南

## 问题：任务卡住无法停止或删除

### 症状
- 任务状态显示"运行中"
- 长时间没有进度更新
- 无法停止或删除任务

### 快速解决方案

#### 方法1：使用命令行工具（推荐）

```bash
# 1. 检查卡住的任务
cd server
npm run check-stuck-tasks

# 2. 自动修复卡住的任务
npm run fix-stuck-tasks

# 3. 重启服务
npm run dev
```

#### 方法2：使用前端界面

1. 刷新页面
2. 找到卡住的任务
3. 点击"终止"按钮
4. 如果终止失败，点击"删除"按钮

## 新增功能

### 1. 终止任务按钮

**位置**：任务列表 > 操作列  
**显示条件**：任务状态为"运行中"或"待处理"  
**功能**：立即终止任务执行

### 2. 删除任务按钮（增强版）

**位置**：任务列表 > 操作列  
**显示条件**：所有任务  
**功能**：
- 删除已完成/失败的任务
- 删除运行中的任务（会先终止再删除）

### 3. 批量删除（增强版）

**位置**：任务列表 > 批量操作  
**功能**：
- 支持删除运行中的任务
- 会提示有多少个任务正在运行
- 确认后批量终止并删除

## 使用场景

### 场景1：任务卡住了

**问题**：任务显示"运行中"但长时间没有进度

**解决**：
1. 点击"终止"按钮
2. 任务状态变为"失败"
3. 可以重新创建任务

### 场景2：想删除运行中的任务

**问题**：之前无法删除运行中的任务

**解决**：
1. 直接点击"删除"按钮
2. 系统会先终止任务
3. 然后删除任务和关联的文章

### 场景3：批量清理任务

**问题**：有很多任务需要清理

**解决**：
1. 勾选要删除的任务
2. 点击"批量删除"
3. 确认后一次性删除

### 场景4：服务器端修复

**问题**：前端无法操作，或者需要批量修复

**解决**：
```bash
cd server
npm run fix-stuck-tasks
```

## 命令行工具

### check-stuck-tasks
检查卡住的任务

```bash
cd server
npm run check-stuck-tasks
```

**输出**：
- 所有运行中的任务
- 所有待处理的任务
- 卡住的任务（超过5分钟没有更新）
- 最近失败的任务

### fix-stuck-tasks
自动修复卡住的任务

```bash
cd server
npm run fix-stuck-tasks
```

**功能**：
- 查找超过5分钟没有更新的运行中任务
- 将它们标记为失败
- 设置错误信息："任务超时（超过5分钟没有响应）"

## API接口

### 终止任务
```
POST /api/article-generation/tasks/:id/cancel
```

**响应**：
```json
{
  "success": true,
  "message": "任务已终止",
  "taskId": 42
}
```

### 删除任务
```
DELETE /api/article-generation/tasks/:id
```

**响应**：
```json
{
  "success": true,
  "message": "任务已删除",
  "taskId": 42
}
```

## 预防措施

### 1. 定期检查
建议每天运行一次检查：

```bash
cd server
npm run check-stuck-tasks
```

### 2. 监控任务状态
在前端页面设置自动刷新：

```javascript
// 每30秒刷新一次任务列表
useEffect(() => {
  const interval = setInterval(() => {
    loadTasks();
  }, 30000);
  return () => clearInterval(interval);
}, []);
```

### 3. 及时处理失败任务
- 查看失败原因
- 修复问题后重新创建任务
- 删除不需要的失败任务

## 故障排查

### 问题1：终止按钮不起作用

**可能原因**：
- 网络问题
- 服务器未响应

**解决方案**：
1. 刷新页面重试
2. 使用命令行工具：`npm run fix-stuck-tasks`
3. 重启服务

### 问题2：删除后任务还在

**可能原因**：
- 缓存问题
- 数据库连接问题

**解决方案**：
1. 刷新页面
2. 清除浏览器缓存
3. 检查数据库连接

### 问题3：任务经常卡住

**可能原因**：
- AI服务超时
- 数据库性能问题
- 图片选择错误

**解决方案**：
1. 检查AI服务配置
2. 优化数据库查询
3. 查看服务器日志
4. 联系技术支持

## 总结

现在你可以：

✅ 终止正在运行的任务  
✅ 删除任何状态的任务  
✅ 批量删除任务（包括运行中的）  
✅ 使用命令行工具诊断和修复  
✅ 更好地管理任务生命周期  

如果遇到问题，请先尝试：
1. 刷新页面
2. 使用终止/删除按钮
3. 运行 `npm run fix-stuck-tasks`
4. 重启服务
