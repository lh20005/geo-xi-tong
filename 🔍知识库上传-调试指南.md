# ğŸ” çŸ¥è¯†åº“ä¸Šä¼  - è°ƒè¯•æŒ‡å—

## å½“å‰çŠ¶æ€
âœ… æ‰€æœ‰ä»£ç æ£€æŸ¥é€šè¿‡ï¼ˆå‰ç«¯ã€IPCã€åç«¯ï¼‰
âŒ æ–‡ä»¶ä¸Šä¼ ä»ç„¶å¤±è´¥

## å¯èƒ½çš„åŸå› 

### 1. ä»£ç æœªé‡æ–°ç¼–è¯‘
**ç—‡çŠ¶**: ä¿®æ”¹äº†ä»£ç ä½†æ²¡æœ‰ç”Ÿæ•ˆ
**è§£å†³**: é‡æ–°ç¼–è¯‘å¹¶é‡å¯åº”ç”¨

```bash
# åœæ­¢åº”ç”¨
pkill -f "windows-login-manager"

# æ¸…ç†ç¼“å­˜
cd windows-login-manager
rm -rf dist/ .vite/ node_modules/.vite/

# é‡æ–°å¯åŠ¨
npm run dev
```

### 2. æµè§ˆå™¨ç¼“å­˜
**ç—‡çŠ¶**: ä½¿ç”¨æ—§ç‰ˆæœ¬çš„å‰ç«¯ä»£ç 
**è§£å†³**: å¼ºåˆ¶åˆ·æ–°

```
åœ¨åº”ç”¨ä¸­æŒ‰: Cmd+Shift+R (Mac) æˆ– Ctrl+Shift+R (Windows)
```

### 3. Electron ç‰ˆæœ¬é—®é¢˜
**ç—‡çŠ¶**: Blob API ä¸å¯ç”¨
**è§£å†³**: æ£€æŸ¥ Electron ç‰ˆæœ¬

```bash
cd windows-login-manager
grep "electron" package.json
```

éœ€è¦ Electron 18+ æ‰æ”¯æŒ Blob API

## è¯¦ç»†è°ƒè¯•æ­¥éª¤

### æ­¥éª¤1: æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯
```
1. æ‰“å¼€ Windows ç™»å½•ç®¡ç†å™¨
2. æŒ‰ Cmd+Option+I (Mac) æˆ– F12 (Windows) æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° Console æ ‡ç­¾
4. å°è¯•ä¸Šä¼ æ–‡ä»¶
5. è®°å½•å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

#### é”™è¯¯1: "An object could not be cloned"
```
åŸå› : File å¯¹è±¡æœªåºåˆ—åŒ–
æ£€æŸ¥: KnowledgeBaseDetailPage.tsx ä¸­çš„ handleUploadDocuments å‡½æ•°
ç¡®è®¤: æ˜¯å¦ä½¿ç”¨äº† arrayBuffer() å’Œ Array.from()
```

#### é”™è¯¯2: "Blob is not defined"
```
åŸå› : Electron ç‰ˆæœ¬å¤ªä½
è§£å†³: å‡çº§ Electron åˆ° 18+
```

#### é”™è¯¯3: "Cannot read property 'name' of undefined"
```
åŸå› : Blob å¯¹è±¡æ²¡æœ‰ name å±æ€§
æ£€æŸ¥: handler.ts ä¸­æ˜¯å¦ä½¿ç”¨äº† Object.defineProperty
```

#### é”™è¯¯4: "çŸ¥è¯†åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
```
åŸå› : å¤šç§Ÿæˆ·éš”ç¦»ï¼ŒçŸ¥è¯†åº“ä¸å±äºå½“å‰ç”¨æˆ·
è§£å†³: ç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·è´¦å·
```

### æ­¥éª¤2: æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
```
1. åœ¨å¼€å‘è€…å·¥å…·ä¸­åˆ‡æ¢åˆ° Network æ ‡ç­¾
2. å°è¯•ä¸Šä¼ æ–‡ä»¶
3. æŸ¥æ‰¾ POST /api/knowledge-bases/{id}/documents è¯·æ±‚
4. æ£€æŸ¥è¯·æ±‚è¯¦æƒ…:
   - Request Headers (æ˜¯å¦æœ‰ Authorization)
   - Request Payload (æ˜¯å¦æ˜¯ multipart/form-data)
   - Response (é”™è¯¯ä¿¡æ¯)
```

### æ­¥éª¤3: æŸ¥çœ‹ Electron æ—¥å¿—
```bash
# Mac
tail -f ~/Library/Logs/windows-login-manager/main.log

# æˆ–è€…åœ¨åº”ç”¨ä¸­
è®¾ç½® â†’ æ—¥å¿—ç®¡ç† â†’ æŸ¥çœ‹æ—¥å¿—
```

### æ­¥éª¤4: æµ‹è¯•ç®€åŒ–ç‰ˆæœ¬
åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `test-simple.txt`:
```
Hello World
```

ç‰¹ç‚¹:
- çº¯è‹±æ–‡ï¼ˆæ’é™¤ç¼–ç é—®é¢˜ï¼‰
- å¾ˆå°ï¼ˆæ’é™¤å¤§å°é—®é¢˜ï¼‰
- .txt æ ¼å¼ï¼ˆæœ€ç®€å•çš„æ ¼å¼ï¼‰

### æ­¥éª¤5: é€æ­¥æµ‹è¯•

#### æµ‹è¯•A: å‰ç«¯åºåˆ—åŒ–
åœ¨ `KnowledgeBaseDetailPage.tsx` çš„ `handleUploadDocuments` å‡½æ•°ä¸­æ·»åŠ æ—¥å¿—:

```typescript
const handleUploadDocuments = async () => {
  console.log('=== å¼€å§‹ä¸Šä¼  ===');
  console.log('æ–‡ä»¶åˆ—è¡¨:', fileList);
  
  const filesData = await Promise.all(
    fileList.map(async (file) => {
      if (file.originFileObj) {
        const buffer = await file.originFileObj.arrayBuffer();
        const result = {
          name: file.name,
          type: file.type || 'application/octet-stream',
          buffer: Array.from(new Uint8Array(buffer))
        };
        console.log('åºåˆ—åŒ–æ–‡ä»¶:', {
          name: result.name,
          type: result.type,
          bufferLength: result.buffer.length
        });
        return result;
      }
      return null;
    })
  );
  
  console.log('åºåˆ—åŒ–å®Œæˆï¼Œæ–‡ä»¶æ•°:', filesData.filter(f => f).length);
  // ... ç»§ç»­
};
```

#### æµ‹è¯•B: IPC ä¼ è¾“
åœ¨ `handler.ts` ä¸­æ·»åŠ æ—¥å¿—:

```typescript
ipcMain.handle('knowledge-base:upload-documents', async (_event, id: number, files: any[]) => {
  try {
    log.info(`æ”¶åˆ°ä¸Šä¼ è¯·æ±‚: KB=${id}, æ–‡ä»¶æ•°=${files.length}`);
    
    files.forEach((f, i) => {
      log.info(`æ–‡ä»¶${i}: name=${f.name}, type=${f.type}, bufferLength=${f.buffer?.length}`);
    });
    
    const reconstructedFiles = files.map((fileData: any) => {
      const buffer = Buffer.from(fileData.buffer);
      log.info(`é‡æ„ Buffer: ${buffer.length} bytes`);
      
      const blob = new Blob([buffer], { type: fileData.type });
      log.info(`åˆ›å»º Blob: size=${blob.size}, type=${blob.type}`);
      
      Object.defineProperty(blob, 'name', {
        value: fileData.name,
        writable: false
      });
      log.info(`æ·»åŠ  name å±æ€§: ${blob.name}`);
      
      return blob;
    });
    
    log.info(`å¼€å§‹è°ƒç”¨ API...`);
    const data = await apiClient.uploadKnowledgeBaseDocuments(id, reconstructedFiles);
    log.info(`API è°ƒç”¨æˆåŠŸ:`, data);
    
    return { success: true, data };
  } catch (error: any) {
    log.error('ä¸Šä¼ å¤±è´¥:', error);
    log.error('é”™è¯¯è¯¦æƒ…:', error.response?.data);
    return { success: false, error: error.message };
  }
});
```

#### æµ‹è¯•C: API è¯·æ±‚
åœ¨ `client.ts` ä¸­æ·»åŠ æ—¥å¿—:

```typescript
async uploadKnowledgeBaseDocuments(id: number, files: any[]): Promise<any> {
  console.log('API: å‡†å¤‡ä¸Šä¼ ', files.length, 'ä¸ªæ–‡ä»¶');
  
  const formData = new FormData();
  files.forEach((file, i) => {
    console.log(`æ·»åŠ æ–‡ä»¶${i}:`, file.name, file.size, file.type);
    formData.append('files', file);
  });
  
  console.log('FormData å‡†å¤‡å®Œæˆ');
  
  const response = await this.axiosInstance.post(
    `/api/knowledge-bases/${id}/documents`, 
    formData, 
    {
      headers: { 'Content-Type': 'multipart/form-data' }
    }
  );
  
  console.log('ä¸Šä¼ å“åº”:', response.data);
  return response.data;
}
```

## å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

å¦‚æœä¸Šè¿°è°ƒè¯•ä»ç„¶å¤±è´¥ï¼Œå°è¯•ä»¥ä¸‹æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆ1: ä½¿ç”¨ File è·¯å¾„ä¼ è¾“
ä¿®æ”¹ä¸ºä¼ è¾“æ–‡ä»¶è·¯å¾„è€Œä¸æ˜¯å†…å®¹ï¼š

```typescript
// å‰ç«¯
const filesData = fileList.map(file => ({
  path: file.originFileObj.path, // Electron æä¾›çš„æ–‡ä»¶è·¯å¾„
  name: file.name,
  type: file.type
}));

// IPC Handler
const reconstructedFiles = files.map(fileData => {
  const buffer = fs.readFileSync(fileData.path);
  const blob = new Blob([buffer], { type: fileData.type });
  Object.defineProperty(blob, 'name', { value: fileData.name });
  return blob;
});
```

### æ–¹æ¡ˆ2: ä½¿ç”¨ Base64 ç¼–ç 
```typescript
// å‰ç«¯
const buffer = await file.originFileObj.arrayBuffer();
const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
return { name: file.name, type: file.type, base64 };

// IPC Handler
const buffer = Buffer.from(fileData.base64, 'base64');
```

### æ–¹æ¡ˆ3: ç›´æ¥åœ¨ Main Process å¤„ç†
è·³è¿‡ Renderer Processï¼Œç›´æ¥åœ¨ Main Process ä¸­é€‰æ‹©å’Œä¸Šä¼ æ–‡ä»¶ã€‚

## è”ç³»æˆ‘

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸è¡Œï¼Œè¯·æä¾›ï¼š
1. å®Œæ•´çš„æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
2. Network æ ‡ç­¾ä¸­çš„è¯·æ±‚è¯¦æƒ…
3. Electron æ—¥å¿—æ–‡ä»¶å†…å®¹
4. package.json ä¸­çš„ electron ç‰ˆæœ¬

æˆ‘ä¼šæ ¹æ®å…·ä½“é”™è¯¯æä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆã€‚
