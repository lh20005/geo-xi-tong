# 头条号图片上传调试指南

## 🔍 问题描述

用户反馈：代码打开了上传对话框，但没有自动选择文件上传，仍需要手动操作。

## 📋 已添加的调试功能

### 1. 图片路径验证
```typescript
// 原始URL
console.log(`[头条号] 🔍 原始图片URL: ${imageUrl}`);

// 转换后的绝对路径
console.log(`[头条号] 📁 转换为绝对路径: ${imagePath}`);

// 文件存在性检查
if (fs.existsSync(imagePath)) {
  console.log(`[头条号] ✅ 图片文件存在`);
} else {
  console.log(`[头条号] ❌ 图片文件不存在: ${imagePath}`);
}
```

### 2. 上传按钮查找
```typescript
// 主选择器
console.log('[头条号] 🔍 查找上传图片按钮...');
console.log(`[头条号] 选择器: ${uploadButtonSelector}`);

// 备用选择器
const alternativeSelectors = [
  'button[aria-label*="图片"]',
  'button[title*="图片"]',
  '.syl-toolbar-tool.image button',
  'div.image button'
];
```

### 3. 文件输入框查找
```typescript
// 尝试多个选择器
const fileInputSelectors = [
  fileInputSelector,  // 精确选择器
  'input[type=file]',  // 简化选择器
  '.byte-drawer input[type=file]',
  '.mp-ic-img-drawer input[type=file]'
];

// 如果都失败，列出所有文件输入框
const allFileInputs = await page.$$('input[type=file]');
console.log(`[头条号] 📊 页面上共有 ${allFileInputs.length} 个文件输入框`);
```

### 4. 文件上传验证
```typescript
// 上传前验证
console.log(`[头条号] 📁 图片路径: ${part.content}`);
console.log(`[头条号] 📁 图片文件名: ${path.basename(part.content)}`);

// 再次验证文件存在
if (!fs.existsSync(part.content)) {
  console.log(`[头条号] ❌❌❌ 严重错误：图片文件不存在！`);
  throw new Error(`图片文件不存在: ${part.content}`);
}

// 调用uploadFile
try {
  await fileInput.uploadFile(part.content);
  console.log('[头条号] ✅✅✅ uploadFile方法调用成功！');
} catch (uploadError: any) {
  console.log(`[头条号] ❌❌❌ uploadFile方法调用失败: ${uploadError.message}`);
  throw uploadError;
}
```

### 5. 截图调试
```typescript
// 如果找不到文件输入框，保存截图
try {
  await page.screenshot({ path: 'toutiao-upload-dialog.png', fullPage: true });
  console.log('[头条号] 📸 已保存对话框截图: toutiao-upload-dialog.png');
} catch (e) {
  // ignore
}
```

## 🔧 调试步骤

### 步骤1：检查日志输出

运行发布任务后，查看控制台日志，重点关注以下信息：

```
[头条号] 📷 插入图片 X/Y: image.jpg
[头条号] 🔍 查找上传图片按钮...
[头条号] ✅✅✅ 找到上传图片按钮，正在点击...
[头条号] ✅ 已点击上传按钮
[头条号] ⏳ 等待上传对话框打开（5秒）...
[头条号] ✅ 对话框应该已打开
[头条号] 🔍 查找文件上传输入框...
[头条号] 💡 尝试多个选择器...
[头条号] 🔍 尝试选择器 1/4: ...
[头条号] ✅✅✅ 成功找到文件输入框！
[头条号] ✅✅✅ 找到文件输入框，准备上传图片
[头条号] 📁 图片路径: /path/to/image.jpg
[头条号] 📁 图片文件名: image.jpg
[头条号] ⏳ 正在调用uploadFile方法...
[头条号] ✅✅✅ uploadFile方法调用成功！图片已提交上传
[头条号] ⏳ 等待图片上传完成（15秒）...
```

### 步骤2：识别失败点

根据日志输出，确定在哪一步失败：

#### 情况A：找不到上传按钮
```
[头条号] ❌❌❌ 查找上传按钮失败: Timeout
```
**解决方案**：
1. 检查页面是否正确加载
2. 查看截图文件确认按钮位置
3. 使用浏览器开发者工具找到正确的选择器
4. 更新代码中的选择器

#### 情况B：找不到文件输入框
```
[头条号] ❌❌❌ 所有选择器都失败了！
[头条号] 📊 页面上共有 0 个文件输入框
```
**解决方案**：
1. 对话框可能没有正确打开
2. 增加等待时间（从5秒增加到8秒）
3. 检查对话框截图：`toutiao-upload-dialog.png`
4. 手动查找正确的选择器

#### 情况C：文件路径不存在
```
[头条号] ❌ 图片文件不存在: /path/to/image.jpg
```
**解决方案**：
1. 检查文章内容中的图片路径格式
2. 确认图片文件确实存在于服务器上
3. 检查路径转换逻辑是否正确

#### 情况D：uploadFile调用失败
```
[头条号] ❌❌❌ uploadFile方法调用失败: Error message
```
**解决方案**：
1. 检查Puppeteer版本
2. 确认文件输入框元素是否正确
3. 尝试使用不同的上传方法

### 步骤3：查看截图

如果上传失败，会自动保存截图：
- `toutiao-publish-page.png` - 发布页面初始状态
- `toutiao-upload-dialog.png` - 上传对话框状态

打开截图文件，检查：
1. 对话框是否正确打开
2. 文件输入框是否可见
3. 页面结构是否与预期一致

### 步骤4：手动测试

在浏览器中手动执行以下步骤：
1. 打开头条号发布页面
2. 点击上传图片按钮
3. 打开浏览器开发者工具（F12）
4. 在Console中执行：
```javascript
document.querySelectorAll('input[type=file]')
```
5. 查看返回的元素列表
6. 找到正确的选择器

### 步骤5：更新选择器

如果发现选择器已过时，更新代码中的选择器：

```typescript
// 在 ToutiaoAdapter.ts 中找到这部分代码
const fileInputSelectors = [
  '你的新选择器',  // 添加新的选择器
  fileInputSelector,
  'input[type=file]',
  '.byte-drawer input[type=file]',
  '.mp-ic-img-drawer input[type=file]'
];
```

## 🎯 常见问题

### Q1: 为什么对话框打开了但没有上传？

**可能原因**：
1. 文件输入框选择器不正确
2. 等待时间不够，对话框还没完全加载
3. 文件路径不正确

**解决方案**：
1. 查看日志，确认是否找到了文件输入框
2. 增加等待时间：`await new Promise(resolve => setTimeout(resolve, 8000));`
3. 检查文件路径是否正确

### Q2: uploadFile方法调用了但文件没有上传？

**可能原因**：
1. 文件路径格式不正确（Windows vs Linux）
2. 文件权限问题
3. Puppeteer版本问题

**解决方案**：
1. 使用绝对路径
2. 检查文件权限：`ls -la /path/to/image.jpg`
3. 更新Puppeteer：`npm update puppeteer`

### Q3: 页面上有多个文件输入框，如何选择正确的？

**解决方案**：
代码已经处理了这种情况：
```typescript
const allFileInputs = await page.$$('input[type=file]');
console.log(`[头条号] 📊 页面上共有 ${allFileInputs.length} 个文件输入框`);

if (allFileInputs.length > 0) {
  console.log('[头条号] 💡 使用第一个文件输入框');
  fileInput = allFileInputs[0];
}
```

如果第一个不是正确的，可以修改索引：
```typescript
fileInput = allFileInputs[1];  // 使用第二个
```

### Q4: 如何验证文件是否真的上传了？

**验证方法**：
1. 查看日志中的"uploadFile方法调用成功"
2. 等待15秒后，检查页面上是否出现了图片预览
3. 使用浏览器开发者工具查看Network标签，看是否有上传请求

## 📊 完整的日志示例

### 成功的日志
```
[头条号] 📷 插入图片 2/5: example.jpg
[头条号] 🔍 查找上传图片按钮...
[头条号] 选择器: #root > div > div.left-column > div > div.publish-editor...
[头条号] ✅✅✅ 找到上传图片按钮，正在点击...
[头条号] ✅ 已点击上传按钮
[头条号] ⏳ 等待上传对话框打开（5秒）...
[头条号] ✅ 对话框应该已打开
[头条号] 🔍 查找文件上传输入框...
[头条号] 💡 尝试多个选择器...
[头条号] 🔍 尝试选择器 1/4: body > div:nth-child(46)...
[头条号] ✅✅✅ 成功找到文件输入框！使用选择器: body > div:nth-child(46)...
[头条号] ✅✅✅ 找到文件输入框，准备上传图片
[头条号] 📁 图片路径: /Users/xxx/project/uploads/example.jpg
[头条号] 📁 图片文件名: example.jpg
[头条号] ⏳ 正在调用uploadFile方法...
[头条号] ✅✅✅ uploadFile方法调用成功！图片已提交上传
[头条号] ⏳ 等待图片上传完成（15秒）...
[头条号] ✅ 上传等待完成
[头条号] 🔍 查找确定按钮关闭对话框...
[头条号] ✅ 找到确定按钮，正在点击...
[头条号] ✅ 已点击确定按钮
[头条号] ⏳ 等待对话框关闭（3秒）...
[头条号] ✅ 对话框已关闭，光标应回到正文图片后
```

### 失败的日志（找不到文件输入框）
```
[头条号] 📷 插入图片 2/5: example.jpg
[头条号] 🔍 查找上传图片按钮...
[头条号] ✅✅✅ 找到上传图片按钮，正在点击...
[头条号] ✅ 已点击上传按钮
[头条号] ⏳ 等待上传对话框打开（5秒）...
[头条号] ✅ 对话框应该已打开
[头条号] 🔍 查找文件上传输入框...
[头条号] 💡 尝试多个选择器...
[头条号] 🔍 尝试选择器 1/4: body > div:nth-child(46)...
[头条号] ⚠️ 选择器超时或失败: Timeout
[头条号] 🔍 尝试选择器 2/4: input[type=file]
[头条号] ⚠️ 选择器超时或失败: Timeout
[头条号] 🔍 尝试选择器 3/4: .byte-drawer input[type=file]
[头条号] ⚠️ 选择器超时或失败: Timeout
[头条号] 🔍 尝试选择器 4/4: .mp-ic-img-drawer input[type=file]
[头条号] ⚠️ 选择器超时或失败: Timeout
[头条号] ❌❌❌ 所有选择器都失败了！
[头条号] 💡 尝试列出页面上所有的input[type=file]元素...
[头条号] 📊 页面上共有 0 个文件输入框
[头条号] ❌❌❌ 严重错误：未找到文件上传输入框！
[头条号] 💡 可能原因：
[头条号]    1. 对话框没有正确打开
[头条号]    2. 选择器已过时
[头条号]    3. 页面结构发生变化
[头条号] 💡 建议：检查页面截图，手动查找正确的选择器
[头条号] 📸 已保存对话框截图: toutiao-upload-dialog.png
```

## 🎉 总结

通过添加详细的日志和调试功能，现在可以：
1. ✅ 清楚地看到每一步的执行情况
2. ✅ 快速定位失败的具体位置
3. ✅ 自动保存截图用于调试
4. ✅ 尝试多个备用选择器
5. ✅ 验证文件路径和上传状态

如果仍然无法自动上传，请：
1. 运行发布任务
2. 查看完整的控制台日志
3. 检查保存的截图文件
4. 根据日志信息确定失败原因
5. 按照本指南的解决方案进行修复
