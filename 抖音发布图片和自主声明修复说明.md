# æŠ–éŸ³å‘å¸ƒå›¾ç‰‡å’Œè‡ªä¸»å£°æ˜ä¿®å¤è¯´æ˜

## é—®é¢˜è¯Šæ–­

### é—®é¢˜1: å›¾ç‰‡ä¸Šä¼ å¼¹å‡ºæœ¬åœ°å¯¹è¯æ¡†
**åŸå› **: ä»£ç ä½¿ç”¨äº† `uploadFile()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ¬èº«ä¸ä¼šå¼¹å‡ºå¯¹è¯æ¡†ã€‚å¼¹å‡ºå¯¹è¯æ¡†çš„åŸå› å¯èƒ½æ˜¯ï¼š
1. ç‚¹å‡»äº†ä¸Šä¼ æŒ‰é’®è§¦å‘äº†ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
2. éœ€è¦å…ˆç‚¹å‡»æŒ‰é’®ï¼Œç„¶ååœ¨ä¸è§¦å‘å¯¹è¯æ¡†çš„æƒ…å†µä¸‹ç›´æ¥è®¾ç½®æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**: 
- `uploadFile()` æ–¹æ³•æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼Œå®ƒä¼šç›´æ¥è®¾ç½®æ–‡ä»¶åˆ° input å…ƒç´ ï¼Œä¸ä¼šå¼¹å‡ºå¯¹è¯æ¡†
- é—®é¢˜å¯èƒ½åœ¨äºç‚¹å‡»ä¸Šä¼ æŒ‰é’®çš„æ­¥éª¤ï¼Œåº”è¯¥è·³è¿‡ç‚¹å‡»æŒ‰é’®ï¼Œç›´æ¥è®¾ç½®æ–‡ä»¶

### é—®é¢˜2: è‡ªä¸»å£°æ˜é€‰æ‹©é—®é¢˜
**åŸå› **: 
1. æŸ¥æ‰¾"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹çš„é€»è¾‘ä¸å¤Ÿå¥å£®
2. æŸ¥æ‰¾"ç¡®å®š"æŒ‰é’®çš„é€‰æ‹©å™¨å¯èƒ½ä¸å‡†ç¡®
3. ä¾§è¾¹æ å¼¹å‡ºåéœ€è¦æ›´å¤šæ—¶é—´åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨XPathè¿›è¡Œæ›´ç²¾ç¡®çš„å…ƒç´ æŸ¥æ‰¾
- å¢åŠ å¤šä¸ªå¤‡é€‰é€‰æ‹©å™¨
- å¢åŠ ç­‰å¾…æ—¶é—´å’Œæˆªå›¾è¯Šæ–­

## ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: ä¿®å¤å›¾ç‰‡ä¸Šä¼ é€»è¾‘

å°†ä»¥ä¸‹ä»£ç æ®µæ›¿æ¢ï¼š

**ä½ç½®**: `server/src/services/adapters/DouyinAdapter.ts` ç¬¬ 220-240 è¡Œå·¦å³

**åŸä»£ç **:
```typescript
// ç‚¹å‡»ä¸Šä¼ å›¾æ–‡æŒ‰é’®ï¼ˆç®€åŒ–é€‰æ‹©å™¨ï¼‰
const uploadButton = '.container-drag-upload-tL99XD > button';
console.log(`[æŠ–éŸ³å·] ä¸Šä¼ å›¾æ–‡æŒ‰é’®é€‰æ‹©å™¨ï¼ˆç®€åŒ–ï¼‰: ${uploadButton}`);
console.log('[æŠ–éŸ³å·] â³ ç­‰å¾…ä¸Šä¼ å›¾æ–‡æŒ‰é’®å‡ºç°ï¼ˆ10ç§’ï¼‰...');
await page.waitForSelector(uploadButton, { timeout: 10000 });
console.log('[æŠ–éŸ³å·] âœ… æ‰¾åˆ°ä¸Šä¼ å›¾æ–‡æŒ‰é’®');

console.log('[æŠ–éŸ³å·] ğŸ–±ï¸  ç‚¹å‡»ä¸Šä¼ å›¾æ–‡æŒ‰é’®...');
await page.click(uploadButton);
console.log('[æŠ–éŸ³å·] âœ… å·²ç‚¹å‡»ä¸Šä¼ å›¾æ–‡æŒ‰é’®');
console.log('[æŠ–éŸ³å·] â³ ç­‰å¾…æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ï¼ˆ2ç§’ï¼‰...');
await new Promise(resolve => setTimeout(resolve, 2000));
```

**æ–°ä»£ç **:
```typescript
// ä¸ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ï¼Œç›´æ¥æŸ¥æ‰¾æ–‡ä»¶inputå¹¶ä¸Šä¼ 
// è¿™æ ·å¯ä»¥é¿å…è§¦å‘ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
console.log('[æŠ–éŸ³å·] ğŸ” ç›´æ¥æŸ¥æ‰¾æ–‡ä»¶ä¸Šä¼ inputï¼ˆä¸ç‚¹å‡»æŒ‰é’®ï¼Œé¿å…å¼¹å‡ºå¯¹è¯æ¡†ï¼‰...');
```

### æ­¥éª¤2: ä¿®å¤è‡ªä¸»å£°æ˜é€‰æ‹©é€»è¾‘

å°†ä»¥ä¸‹ä»£ç æ®µæ›¿æ¢ï¼š

**ä½ç½®**: `server/src/services/adapters/DouyinAdapter.ts` ç¬¬ 430-490 è¡Œå·¦å³

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
// ç‚¹å‡»"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹ - ä½¿ç”¨æ–‡å­—åŒ¹é…
console.log('[æŠ–éŸ³å·] ğŸ” ä½¿ç”¨æ–‡å­—åŒ¹é…æŸ¥æ‰¾"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹...');

// è·å–æ‰€æœ‰å…ƒç´ ï¼ŒæŸ¥æ‰¾åŒ…å«"å†…å®¹ç”±AIç”Ÿæˆ"çš„å…ƒç´ 
const allElements = await page.$('*');
```

**æ›¿æ¢ä¸º**:
```typescript
// æˆªå›¾æŸ¥çœ‹ä¾§è¾¹æ çŠ¶æ€
try {
  await page.screenshot({ path: 'douyin-declaration-sidebar.png', fullPage: true });
  console.log('[æŠ–éŸ³å·] ğŸ“¸ å·²ä¿å­˜ä¾§è¾¹æ æˆªå›¾åˆ°: douyin-declaration-sidebar.png');
} catch (e) {
  console.log('[æŠ–éŸ³å·] æˆªå›¾å¤±è´¥:', e);
}

// ç‚¹å‡»"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹ - æ”¹è¿›çš„æŸ¥æ‰¾æ–¹å¼
console.log('[æŠ–éŸ³å·] ğŸ” æŸ¥æ‰¾"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹...');

// ä½¿ç”¨XPathç²¾ç¡®æŸ¥æ‰¾
const aiOptionXPath = "//*[contains(text(), 'å†…å®¹ç”±AIç”Ÿæˆ')]";
console.log(`[æŠ–éŸ³å·] ä½¿ç”¨XPathæŸ¥æ‰¾: ${aiOptionXPath}`);

try {
  await page.waitForXPath(aiOptionXPath, { visible: true, timeout: 5000 });
  const aiElements = await page.$x(aiOptionXPath);
  console.log(`[æŠ–éŸ³å·] æ‰¾åˆ° ${aiElements.length} ä¸ªåŒ…å«"å†…å®¹ç”±AIç”Ÿæˆ"çš„å…ƒç´ `);
  
  let clicked = false;
  for (let i = 0; i < aiElements.length; i++) {
    const element = aiElements[i];
    const elementInfo = await page.evaluate(el => {
      const rect = el.getBoundingClientRect();
      const style = window.getComputedStyle(el);
      return {
        text: el.textContent?.trim(),
        tagName: el.tagName,
        className: el.className,
        visible: style.display !== 'none' && 
                style.visibility !== 'hidden' && 
                style.opacity !== '0' &&
                rect.width > 0 && 
                rect.height > 0,
        clickable: el.tagName === 'BUTTON' || 
                  el.tagName === 'DIV' || 
                  el.onclick !== null ||
                  el.className.includes('option') ||
                  el.className.includes('item')
      };
    }, element);
    
    console.log(`[æŠ–éŸ³å·] å…ƒç´  [${i}]:`, elementInfo);
    
    // æŸ¥æ‰¾å¯ç‚¹å‡»çš„å…ƒç´ 
    if (elementInfo.visible && elementInfo.clickable) {
      console.log(`[æŠ–éŸ³å·] âœ… æ‰¾åˆ°å¯ç‚¹å‡»çš„"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹`);
      console.log('[æŠ–éŸ³å·] ğŸ–±ï¸  ç‚¹å‡»é€‰é¡¹...');
      await element.click();
      clicked = true;
      console.log('[æŠ–éŸ³å·] âœ… å·²ç‚¹å‡»é€‰é¡¹');
      break;
    }
  }
  
  if (!clicked && aiElements.length > 0) {
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®å¯ç‚¹å‡»çš„ï¼Œç‚¹å‡»ç¬¬ä¸€ä¸ªå¯è§çš„
    console.log('[æŠ–éŸ³å·] âš ï¸ æœªæ‰¾åˆ°æ˜ç¡®å¯ç‚¹å‡»çš„å…ƒç´ ï¼Œå°è¯•ç‚¹å‡»ç¬¬ä¸€ä¸ªå¯è§å…ƒç´ ...');
    await aiElements[0].click();
    console.log('[æŠ–éŸ³å·] âœ… å·²ç‚¹å‡»ç¬¬ä¸€ä¸ªå…ƒç´ ');
  }
} catch (e: any) {
  console.log('[æŠ–éŸ³å·] âš ï¸ XPathæŸ¥æ‰¾å¤±è´¥:', e.message);
  throw new Error('æœªæ‰¾åˆ°"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹');
}

console.log('[æŠ–éŸ³å·] â³ ç­‰å¾…é€‰é¡¹é€‰ä¸­ï¼ˆ2ç§’ï¼‰...');
await new Promise(resolve => setTimeout(resolve, 2000));

// æˆªå›¾æŸ¥çœ‹é€‰ä¸­çŠ¶æ€
try {
  await page.screenshot({ path: 'douyin-declaration-selected.png', fullPage: true });
  console.log('[æŠ–éŸ³å·] ğŸ“¸ å·²ä¿å­˜é€‰ä¸­çŠ¶æ€æˆªå›¾åˆ°: douyin-declaration-selected.png');
} catch (e) {
  console.log('[æŠ–éŸ³å·] æˆªå›¾å¤±è´¥:', e);
}
```

### æ­¥éª¤3: ä¿®å¤ç¡®å®šæŒ‰é’®æŸ¥æ‰¾é€»è¾‘

**æŸ¥æ‰¾è¿™æ®µä»£ç **:
```typescript
// ç‚¹å‡»ç¡®å®šæŒ‰é’®
const confirmButton = '.semi-sidesheet-body > footer > button.semi-button-primary';
console.log(`[æŠ–éŸ³å·] ç¡®å®šæŒ‰é’®é€‰æ‹©å™¨ï¼ˆç®€åŒ–ï¼‰: ${confirmButton}`);
console.log('[æŠ–éŸ³å·] â³ ç­‰å¾…"ç¡®å®š"æŒ‰é’®å‡ºç°ï¼ˆ5ç§’ï¼‰...');
await page.waitForSelector(confirmButton, { timeout: 5000 });
console.log('[æŠ–éŸ³å·] âœ… æ‰¾åˆ°"ç¡®å®š"æŒ‰é’®');

console.log('[æŠ–éŸ³å·] ğŸ–±ï¸  ç‚¹å‡»"ç¡®å®š"æŒ‰é’®...');
await page.click(confirmButton);
```

**æ›¿æ¢ä¸º**:
```typescript
// ç‚¹å‡»ç¡®å®šæŒ‰é’® - æ”¹è¿›çš„æŸ¥æ‰¾æ–¹å¼
console.log('[æŠ–éŸ³å·] ğŸ” æŸ¥æ‰¾"ç¡®å®š"æŒ‰é’®...');

// æ–¹æ³•1: ä½¿ç”¨å¤šä¸ªå¯èƒ½çš„é€‰æ‹©å™¨
const confirmSelectors = [
  '.semi-sidesheet-body > footer > button.semi-button-primary',
  '.semi-sidesheet footer button.semi-button-primary',
  'button.semi-button-primary',
  '.semi-modal-footer button.semi-button-primary'
];

let confirmClicked = false;
for (const selector of confirmSelectors) {
  try {
    console.log(`[æŠ–éŸ³å·] å°è¯•é€‰æ‹©å™¨: ${selector}`);
    await page.waitForSelector(selector, { visible: true, timeout: 3000 });
    console.log(`[æŠ–éŸ³å·] âœ… æ‰¾åˆ°ç¡®å®šæŒ‰é’®: ${selector}`);
    
    const buttonText = await page.$eval(selector, el => el.textContent?.trim());
    console.log(`[æŠ–éŸ³å·] æŒ‰é’®æ–‡å­—: "${buttonText}"`);
    
    if (buttonText === 'ç¡®å®š' || buttonText === 'ç¡®è®¤' || buttonText === 'ä¿å­˜') {
      console.log('[æŠ–éŸ³å·] ğŸ–±ï¸  ç‚¹å‡»ç¡®å®šæŒ‰é’®...');
      await page.click(selector);
      confirmClicked = true;
      console.log('[æŠ–éŸ³å·] âœ… å·²ç‚¹å‡»ç¡®å®šæŒ‰é’®');
      break;
    }
  } catch (e) {
    continue;
  }
}

// æ–¹æ³•2: ä½¿ç”¨XPathæŸ¥æ‰¾
if (!confirmClicked) {
  console.log('[æŠ–éŸ³å·] âš ï¸ CSSé€‰æ‹©å™¨æœªæ‰¾åˆ°ï¼Œå°è¯•XPath...');
  const confirmXPath = "//button[contains(text(), 'ç¡®å®š') or contains(text(), 'ç¡®è®¤') or contains(text(), 'ä¿å­˜')]";
  
  try {
    await page.waitForXPath(confirmXPath, { visible: true, timeout: 5000 });
    const confirmButtons = await page.$x(confirmXPath);
    console.log(`[æŠ–éŸ³å·] æ‰¾åˆ° ${confirmButtons.length} ä¸ªç¡®è®¤æŒ‰é’®`);
    
    if (confirmButtons.length > 0) {
      // æ‰¾åˆ°ä¾§è¾¹æ å†…çš„ç¡®è®¤æŒ‰é’®ï¼ˆé€šå¸¸æ˜¯æœ€åä¸€ä¸ªæˆ–åœ¨footerä¸­ï¼‰
      const button = confirmButtons[confirmButtons.length - 1];
      const buttonText = await page.evaluate(el => el.textContent?.trim(), button);
      console.log(`[æŠ–éŸ³å·] å‡†å¤‡ç‚¹å‡»æŒ‰é’®: "${buttonText}"`);
      
      await button.click();
      confirmClicked = true;
      console.log('[æŠ–éŸ³å·] âœ… å·²ç‚¹å‡»ç¡®å®šæŒ‰é’®ï¼ˆXPathæ–¹å¼ï¼‰');
    }
  } catch (e: any) {
    console.log('[æŠ–éŸ³å·] âš ï¸ XPathæŸ¥æ‰¾ç¡®å®šæŒ‰é’®å¤±è´¥:', e.message);
  }
}

if (!confirmClicked) {
  throw new Error('æœªæ‰¾åˆ°ç¡®å®šæŒ‰é’®');
}
```

## å®Œæ•´ä¿®å¤ä»£ç 

ç”±äºä»£ç è¾ƒé•¿ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ä¿®å¤ç‰ˆæœ¬æ–‡ä»¶ã€‚

## æµ‹è¯•å»ºè®®

1. é‡å¯æœåŠ¡å™¨åæµ‹è¯•
2. æŸ¥çœ‹ç”Ÿæˆçš„æˆªå›¾æ–‡ä»¶ï¼š
   - `douyin-declaration-sidebar.png` - ä¾§è¾¹æ å¼¹å‡ºçŠ¶æ€
   - `douyin-declaration-selected.png` - é€‰é¡¹é€‰ä¸­çŠ¶æ€
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ

## é¢„æœŸæ•ˆæœ

1. âœ… å›¾ç‰‡ä¸Šä¼ ä¸ä¼šå¼¹å‡ºç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
2. âœ… èƒ½å¤Ÿæ­£ç¡®æ‰¾åˆ°å¹¶ç‚¹å‡»"å†…å®¹ç”±AIç”Ÿæˆ"é€‰é¡¹
3. âœ… èƒ½å¤Ÿæ­£ç¡®æ‰¾åˆ°å¹¶ç‚¹å‡»"ç¡®å®š"æŒ‰é’®
4. âœ… è‡ªä¸»å£°æ˜æˆåŠŸæ·»åŠ 
